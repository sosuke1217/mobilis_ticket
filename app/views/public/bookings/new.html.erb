<!-- app/views/public/bookings/new.html.erb -->
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-lg">
        <div class="card-header bg-primary text-white text-center">
          <h2 class="mb-0">
            <i class="fas fa-calendar-plus me-2"></i>
            å‡ºå¼µã‚¹ãƒˆãƒ¬ãƒƒãƒäºˆç´„ãƒ•ã‚©ãƒ¼ãƒ 
          </h2>
          <p class="mb-0 mt-2">åºƒå°¾ã‚¨ãƒªã‚¢å°‚é–€</p>
        </div>
        
        <div class="card-body p-4">
          <%= form_with model: @reservation, url: public_bookings_path, 
                        local: true, html: { id: 'booking-form' } do |f| %>
            
            <!-- Step 1: ã‚³ãƒ¼ã‚¹é¸æŠ -->
            <div class="step-section mb-4">
              <h4 class="step-title">
                <span class="step-number">1</span>ã‚³ãƒ¼ã‚¹é¸æŠ
              </h4>
              
              <div class="row">
                <% @courses.each_with_index do |course, index| %>
                  <div class="col-md-4 mb-3">
                    <div class="course-card" data-course="<%= course[:name] %>" data-duration="<%= course[:duration] %>">
                      <input type="radio" name="booking[course]" 
                             value="<%= course[:name] %>" 
                             id="course_<%= index %>"
                             data-duration="<%= course[:duration] %>"
                             <%= 'checked' if index == 1 %> hidden>
                      <div class="card h-100">
                        <div class="card-body text-center">
                          <h5 class="card-title"><%= course[:name] %></h5>
                          <p class="price-display">
                            Â¥<%= number_with_delimiter(course[:price]) %>
                          </p>
                          <small class="text-muted"><%= course[:duration] %>åˆ†</small>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
            
            <!-- Step 2: å¸Œæœ›æ—¥æ™‚é¸æŠ -->
            <div class="step-section mb-4">
              <h4 class="step-title">
                <span class="step-number">2</span>å¸Œæœ›æ—¥æ™‚é¸æŠ
              </h4>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= label_tag 'preferred_date', 'å¸Œæœ›æ—¥', class: 'form-label required' %>
                  <%= date_field_tag 'preferred_date', '', 
                        { class: 'form-control', required: true, id: 'preferred-date',
                          min: Date.current + 1.day, max: Date.current + 30.days } %>
                </div>
                
                <div class="col-md-6 mb-3">
                  <%= label_tag 'booking[selected_datetime]', 'ç©ºãæ™‚é–“', class: 'form-label required' %>
                  <select name="booking[selected_datetime]" id="available-times-select" class="form-select" required>
                    <option value="">ã¾ãšæ—¥ä»˜ã¨ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                  </select>
                  <div id="loading-times" class="form-text text-primary" style="display: none;">
                    <i class="fas fa-spinner fa-spin me-1"></i>ç©ºãæ™‚é–“ã‚’æ¤œç´¢ä¸­...
                  </div>
                </div>
              </div>
              
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç©ºãæ™‚é–“è¡¨ç¤º</strong><br>
                é¸æŠã—ãŸæ—¥ä»˜ã¨ã‚³ãƒ¼ã‚¹ã«å¿œã˜ã¦ã€å®Ÿéš›ã«äºˆç´„å¯èƒ½ãªæ™‚é–“ã®ã¿ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </div>
            </div>
            
            <!-- Step 3: ãŠå®¢æ§˜æƒ…å ± -->
            <div class="step-section mb-4">
              <h4 class="step-title">
                <span class="step-number">3</span>ãŠå®¢æ§˜æƒ…å ±
              </h4>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <%= label_tag 'booking[name]', 'ãŠåå‰', class: 'form-label required' %>
                  <%= text_field_tag 'booking[name]', '', 
                        { class: 'form-control', required: true, placeholder: 'å±±ç”°å¤ªéƒ' } %>
                </div>
                
                <div class="col-md-6 mb-3">
                  <%= label_tag 'booking[phone_number]', 'ãŠé›»è©±ç•ªå·', class: 'form-label required' %>
                  <%= telephone_field_tag 'booking[phone_number]', '', 
                        { class: 'form-control', required: true, placeholder: '090-1234-5678' } %>
                </div>
              </div>
              
              <div class="mb-3">
                <%= label_tag 'booking[email]', 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', class: 'form-label' %>
                <%= email_field_tag 'booking[email]', '', 
                      { class: 'form-control', placeholder: 'example@email.com' } %>
                <div class="form-text">ã”é€£çµ¡ç”¨ï¼ˆä»»æ„ï¼‰</div>
              </div>
              
              <div class="mb-3">
                <%= label_tag 'booking[address]', 'ã”ä½æ‰€', class: 'form-label required' %>
                <%= text_area_tag 'booking[address]', '', 
                      { class: 'form-control', rows: 2, required: true,
                        placeholder: 'æ¸¯åŒºå—éº»å¸ƒâ—‹-â—‹-â—‹ã€€â—‹â—‹ãƒãƒ³ã‚·ãƒ§ãƒ³â—‹â—‹å·å®¤' } %>
              </div>
              
              <div class="mb-3">
                <%= label_tag 'booking[access_notes]', 'ã‚¢ã‚¯ã‚»ã‚¹ãƒ»å…¥é¤¨æ–¹æ³•', class: 'form-label' %>
                <%= text_area_tag 'booking[access_notes]', '', 
                      { class: 'form-control', rows: 2,
                        placeholder: 'ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯ç•ªå·ã€æœ€å¯„ã‚Šé§…ã€ç›®å°ã¨ãªã‚‹å»ºç‰©ãªã©' } %>
              </div>
            </div>
            
            <!-- Step 4: ã”è¦æœ›ãƒ»ãã®ä»– -->
            <div class="step-section mb-4">
              <h4 class="step-title">
                <span class="step-number">4</span>ã”è¦æœ›ãƒ»ãã®ä»–
              </h4>
              
              <div class="mb-3">
                <%= label_tag 'booking[notes]', 'ã”è¦æœ›ãƒ»æ°—ã«ãªã‚‹ç®‡æ‰€ãªã©', class: 'form-label' %>
                <%= text_area_tag 'booking[notes]', '', 
                      { class: 'form-control', rows: 3,
                        placeholder: 'è‚©ã“ã‚ŠãŒã²ã©ã„ã€è…°ç—›ãŒæ°—ã«ãªã‚‹ã€åˆå›ã§ä¸å®‰ãªã©' } %>
              </div>
            </div>
            
            <!-- ç¢ºèªäº‹é … -->
            <div class="alert alert-warning">
              <h6><i class="fas fa-exclamation-triangle me-2"></i>ã”ç¢ºèªãã ã•ã„</h6>
              <ul class="mb-0">
                <li>é¸æŠã•ã‚ŒãŸæ™‚é–“ã§<strong>ä»®äºˆç´„</strong>ã„ãŸã—ã¾ã™</li>
                <li>ç¢ºèªã®ã”é€£çµ¡å¾Œã€æ­£å¼ãªäºˆç´„ç¢ºå®šã¨ãªã‚Šã¾ã™</li>
                <li>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¯å‰æ—¥ã¾ã§ã«ã”é€£çµ¡ãã ã•ã„</li>
                <li>å‡ºå¼µè²»ã¯æ–™é‡‘ã«å«ã¾ã‚Œã¦ã„ã¾ã™</li>
              </ul>
            </div>
            
            <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-primary btn-lg px-5" id="submit-btn" disabled>
                <i class="fas fa-paper-plane me-2"></i>
                äºˆç´„ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ğŸ†• JavaScript for ç©ºãæ™‚é–“å–å¾— -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const courseCards = document.querySelectorAll('.course-card');
  const dateInput = document.getElementById('preferred-date');
  const timesSelect = document.getElementById('available-times-select');
  const loadingIndicator = document.getElementById('loading-times');
  const submitBtn = document.getElementById('submit-btn');
  
  // ã‚³ãƒ¼ã‚¹é¸æŠå‡¦ç†
  courseCards.forEach(card => {
    card.addEventListener('click', function() {
      // ä»–ã®ã‚«ãƒ¼ãƒ‰ã®é¸æŠè§£é™¤
      courseCards.forEach(c => {
        c.querySelector('input').checked = false;
        c.querySelector('.card').classList.remove('selected');
      });
      
      // ã“ã®ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ
      const radio = this.querySelector('input');
      radio.checked = true;
      this.querySelector('.card').classList.add('selected');
      
      // ç©ºãæ™‚é–“ã‚’æ›´æ–°
      updateAvailableTimes();
    });
  });
  
  // æ—¥ä»˜å¤‰æ›´æ™‚ã®å‡¦ç†
  dateInput.addEventListener('change', updateAvailableTimes);
  
  // æ™‚é–“é¸æŠæ™‚ã®å‡¦ç†
  timesSelect.addEventListener('change', validateForm);
  
  // åˆæœŸé¸æŠçŠ¶æ…‹ã®è¨­å®š
  const checkedCourse = document.querySelector('input[name="booking[course]"]:checked');
  if (checkedCourse) {
    checkedCourse.closest('.course-card').querySelector('.card').classList.add('selected');
  }
  
  // ğŸ†• ç©ºãæ™‚é–“ã‚’å–å¾—ã™ã‚‹é–¢æ•°
  function updateAvailableTimes() {
    const selectedCourse = document.querySelector('input[name="booking[course]"]:checked');
    const selectedDate = dateInput.value;
    
    if (!selectedCourse || !selectedDate) {
      timesSelect.innerHTML = '<option value="">ã‚³ãƒ¼ã‚¹ã¨æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      timesSelect.disabled = true;
      return;
    }
    
    const duration = selectedCourse.dataset.duration;
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    timesSelect.disabled = true;
    timesSelect.innerHTML = '<option value="">æ¤œç´¢ä¸­...</option>';
    loadingIndicator.style.display = 'block';
    
    // ç©ºãæ™‚é–“ã‚’APIã‹ã‚‰å–å¾—
    fetch(`/public/bookings/available_times?date=${selectedDate}&duration=${duration}`)
      .then(response => response.json())
      .then(data => {
        loadingIndicator.style.display = 'none';
        
        if (data.success) {
          timesSelect.innerHTML = '<option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
          
          if (data.slots.length === 0) {
            timesSelect.innerHTML = '<option value="" disabled>ã“ã®æ—¥ã¯ç©ºããŒã‚ã‚Šã¾ã›ã‚“</option>';
            timesSelect.disabled = true;
          } else {
            data.slots.forEach(slot => {
              const option = document.createElement('option');
              option.value = slot.start_datetime;
              option.textContent = slot.display;
              timesSelect.appendChild(option);
            });
            timesSelect.disabled = false;
          }
        } else {
          timesSelect.innerHTML = '<option value="" disabled>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</option>';
          console.error('API Error:', data.error);
        }
        
        validateForm();
      })
      .catch(error => {
        loadingIndicator.style.display = 'none';
        timesSelect.innerHTML = '<option value="" disabled>é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</option>';
        console.error('Fetch Error:', error);
        validateForm();
      });
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  function validateForm() {
    const requiredFields = document.querySelectorAll('[required]');
    let allValid = true;
    
    requiredFields.forEach(field => {
      if (!field.value.trim()) {
        allValid = false;
      }
    });
    
    submitBtn.disabled = !allValid;
  }
  
  // å…¥åŠ›é …ç›®ã®å¤‰æ›´ç›£è¦–
  document.getElementById('booking-form').addEventListener('input', validateForm);
  document.getElementById('booking-form').addEventListener('change', validateForm);
});
</script>

<style>
.step-section {
  border-left: 4px solid #e3f2fd;
  padding-left: 20px;
  margin-bottom: 2rem;
}

.step-title {
  color: #1976d2;
  margin-bottom: 1rem;
}

.step-number {
  display: inline-block;
  width: 30px;
  height: 30px;
  background: #1976d2;
  color: white;
  border-radius: 50%;
  text-align: center;
  line-height: 30px;
  margin-right: 10px;
  font-weight: bold;
}

.course-card {
  cursor: pointer;
  transition: all 0.3s ease;
}

.course-card .card {
  border: 2px solid #e0e0e0;
  transition: all 0.3s ease;
}

.course-card:hover .card,
.course-card input:checked + .card,
.course-card .card.selected {
  border-color: #1976d2;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2);
}

.price-display {
  font-size: 1.5rem;
  color: #1976d2;
  font-weight: bold;
  margin: 0;
}

.required::after {
  content: " *";
  color: #d32f2f;
}

.form-control:focus {
  border-color: #1976d2;
  box-shadow: 0 0 0 0.2rem rgba(25, 118, 210, 0.25);
}

#available-times-select:disabled {
  background-color: #f5f5f5;
  cursor: not-allowed;
}

#loading-times {
  font-size: 0.875rem;
}
</style>