<!-- app/views/admin/settings/index.html.erb -->
<div class="container-lg my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">âš™ï¸ ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</h1>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><%= link_to "ç®¡ç†ç”»é¢", admin_root_path %></li>
        <li class="breadcrumb-item active">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</li>
      </ol>
    </nav>
  </div>

  <div class="row">
    <!-- äºˆç´„è¨­å®š -->
    <div class="col-md-6">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">ğŸ• äºˆç´„æ™‚é–“è¨­å®š</h5>
        </div>
        <div class="card-body">
          <%= form_with model: @settings, url: admin_settings_path, local: true, class: "needs-validation business-hours-form", novalidate: true do |f| %>
            
            <div class="mb-3">
              <label for="application_setting_reservation_interval_minutes" class="form-label">
                ğŸ“ äºˆç´„é–“ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«
                <i class="fas fa-info-circle" data-bs-toggle="tooltip" title="å‰ã®äºˆç´„çµ‚äº†ã‹ã‚‰æ¬¡ã®äºˆç´„é–‹å§‹ã¾ã§ã®æº–å‚™ãƒ»ç§»å‹•æ™‚é–“"></i>
              </label>
              <div class="input-group">
                <%= f.number_field :reservation_interval_minutes, 
                    class: "form-control", 
                    min: 0, 
                    max: 60, 
                    step: 5,
                    required: true %>
                <span class="input-group-text">åˆ†</span>
              </div>
              <div class="form-text">
                <strong>æ¨å¥¨ï¼š20åˆ†</strong> - å‡ºå¼µã‚µãƒ¼ãƒ“ã‚¹ã®ç§»å‹•æ™‚é–“ã‚’è€ƒæ…®<br>
                ä¾‹ï¼š20åˆ†è¨­å®šã®å ´åˆã€13:00-14:00ã®äºˆç´„ã®æ¬¡ã¯14:20ä»¥é™ã‹ã‚‰äºˆç´„å¯èƒ½
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-6">
                <label for="application_setting_business_hours_start" class="form-label">ğŸŒ… å–¶æ¥­é–‹å§‹æ™‚é–“</label>
                <div class="input-group">
                  <%= f.number_field :business_hours_start, 
                      class: "form-control business-hours-input", 
                      min: 0, 
                      max: 23,
                      required: true %>
                  <span class="input-group-text">æ™‚</span>
                </div>
              </div>
              <div class="col-6">
                <label for="application_setting_business_hours_end" class="form-label">ğŸŒ† å–¶æ¥­çµ‚äº†æ™‚é–“</label>
                <div class="input-group">
                  <%= f.number_field :business_hours_end, 
                      class: "form-control business-hours-input", 
                      min: 1, 
                      max: 24,
                      required: true %>
                  <span class="input-group-text">æ™‚</span>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="application_setting_slot_interval_minutes" class="form-label">
                â±ï¸ äºˆç´„ã‚¹ãƒ­ãƒƒãƒˆé–“éš”
              </label>
              <div class="input-group">
                <%= f.select :slot_interval_minutes, 
                    options_for_select([
                      ['10åˆ†', 10],
                      ['15åˆ†', 15],
                      ['30åˆ†', 30],
                      ['60åˆ†', 60]
                    ], @settings.slot_interval_minutes),
                    {}, 
                    { class: "form-select", required: true } %>
              </div>
              <div class="form-text">äºˆç´„å¯èƒ½æ™‚é–“ã®åˆ»ã¿å¹…</div>
            </div>

            <div class="border-top pt-3">
              <button type="submit" class="btn btn-success">
                <i class="fas fa-save me-1"></i>è¨­å®šã‚’ä¿å­˜
              </button>

            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- äºˆç´„åˆ¶é™è¨­å®š -->
    <div class="col-md-6">
      <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0">âš ï¸ äºˆç´„åˆ¶é™è¨­å®š</h5>
        </div>
        <div class="card-body">
          <%= form_with model: @settings, url: admin_settings_path, local: true, class: "needs-validation", novalidate: true do |f| %>
            
            <div class="mb-3">
              <label for="application_setting_max_advance_booking_days" class="form-label">
                ğŸ“… æœ€å¤§äºˆç´„å¯èƒ½æ—¥æ•°
              </label>
              <div class="input-group">
                <%= f.number_field :max_advance_booking_days, 
                    class: "form-control", 
                    min: 1, 
                    max: 365,
                    required: true %>
                <span class="input-group-text">æ—¥å…ˆã¾ã§</span>
              </div>
            </div>

            <div class="mb-3">
              <label for="application_setting_min_advance_booking_hours" class="form-label">
                â° æœ€ä½äºˆç´„æ™‚é–“
              </label>
              <div class="input-group">
                <%= f.number_field :min_advance_booking_hours, 
                    class: "form-control", 
                    min: 0, 
                    max: 168,
                    required: true %>
                <span class="input-group-text">æ™‚é–“å‰ã¾ã§</span>
              </div>
              <div class="form-text">
                <small class="text-muted">â€»ç®¡ç†è€…ã«ã‚ˆã‚‹äºˆç´„ä½œæˆæ™‚ã¯åˆ¶é™ãªã—</small>
              </div>
            </div>

            <div class="mb-3">
              <div class="form-check">
                <%= f.check_box :sunday_closed, class: "form-check-input" %>
                <label class="form-check-label" for="application_setting_sunday_closed">
                  ğŸ”’ æ—¥æ›œæ—¥ã‚’ä¼‘æ¥­æ—¥ã¨ã™ã‚‹
                </label>
              </div>
            </div>

            <div class="border-top pt-3">
              <button type="submit" class="btn btn-warning">
                <i class="fas fa-save me-1"></i>åˆ¶é™è¨­å®šã‚’ä¿å­˜
              </button>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ç¾åœ¨ã®è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
  <div class="card shadow-sm">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">ğŸ“Š ç¾åœ¨ã®è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6>â° å–¶æ¥­æ™‚é–“ãƒ»äºˆç´„è¨­å®š</h6>
          <ul class="list-unstyled">
            <li><strong>å–¶æ¥­æ™‚é–“:</strong> <%= @settings.business_hours_range %></li>
            <li><strong>äºˆç´„é–“éš”:</strong> <%= @settings.slot_interval_minutes %>åˆ†åˆ»ã¿</li>
            <li><strong>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«:</strong> 
              <span class="badge bg-primary"><%= @settings.reservation_interval_minutes %>åˆ†</span>
            </li>
            <li><strong>ä¼‘æ¥­æ—¥:</strong> <%= @settings.sunday_closed? ? "æ—¥æ›œæ—¥" : "ãªã—" %></li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6>ğŸš« äºˆç´„åˆ¶é™</h6>
          <ul class="list-unstyled">
            <li><strong>æœ€å¤§äºˆç´„æœŸé–“:</strong> <%= @settings.max_advance_booking_days %>æ—¥å…ˆã¾ã§</li>
            <li><strong>æœ€ä½äºˆç´„æ™‚é–“:</strong> <%= @settings.min_advance_booking_hours %>æ™‚é–“å‰ã¾ã§</li>
          </ul>
          
          <h6 class="mt-3">ğŸ“ è¨­å®šä¾‹</h6>
          <div class="alert alert-light">
            <small>
              <strong>ä»Šæ—¥ãŒ15:00ã®å ´åˆ:</strong><br>
              â€¢ æ˜æ—¥ã®16:00ä»¥é™ã‹ã‚‰äºˆç´„å¯èƒ½<br>
              â€¢ 60åˆ†ã‚³ãƒ¼ã‚¹äºˆç´„å¾Œã€<%= @settings.reservation_interval_minutes %>åˆ†ã®æº–å‚™ãƒ»ç§»å‹•æ™‚é–“<br>
              â€¢ 13:00-14:00ã®æ¬¡ã¯14:<%= @settings.reservation_interval_minutes.to_s.rjust(2, '0') %>ä»¥é™ã‹ã‚‰äºˆç´„å¯èƒ½
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });

  // å–¶æ¥­æ™‚é–“ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ã¨ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  const startTime = document.getElementById('application_setting_business_hours_start');
  const endTime = document.getElementById('application_setting_business_hours_end');
  
  function validateBusinessHours() {
    const start = parseInt(startTime.value);
    const end = parseInt(endTime.value);
    
    if (start >= end) {
      endTime.setCustomValidity('å–¶æ¥­çµ‚äº†æ™‚é–“ã¯é–‹å§‹æ™‚é–“ã‚ˆã‚Šå¾Œã«è¨­å®šã—ã¦ãã ã•ã„');
      return false;
    } else {
      endTime.setCustomValidity('');
      return true;
    }
  }
  
  // å–¶æ¥­æ™‚é–“ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  function updateBusinessHours() {
    const start = parseInt(startTime.value);
    const end = parseInt(endTime.value);
    
    if (start < end) {
      console.log(`ğŸ”„ å–¶æ¥­æ™‚é–“ã‚’æ›´æ–°: ${start}:00-${end}:00`);
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯æ›´æ–°
      if (window.shiftHighlighter) {
        window.shiftHighlighter.changeShift(start, end);
      }
      
      // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
      saveBusinessHoursToServer(start, end);
      
      // æˆåŠŸé€šçŸ¥ã‚’è¡¨ç¤º
      showNotification('å–¶æ¥­æ™‚é–“ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ', 'success');
    }
  }
  
  // ã‚µãƒ¼ãƒãƒ¼ã«å–¶æ¥­æ™‚é–“ã‚’ä¿å­˜
  async function saveBusinessHoursToServer(start, end) {
    try {
      const response = await fetch('/admin/settings/1/update_business_hours', {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify({
          business_hours_start: start,
          business_hours_end: end
        })
      });
      
      const data = await response.json();
      
      if (data.success) {
        console.log('âœ… Business hours saved to server:', data);
      } else {
        console.error('âŒ Failed to save business hours:', data.error);
        showNotification('å–¶æ¥­æ™‚é–“ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    } catch (error) {
      console.error('âŒ Network error:', error);
      showNotification('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
    }
  }
  
  if (startTime && endTime) {
    startTime.addEventListener('change', () => {
      validateBusinessHours();
      updateBusinessHours();
    });
    endTime.addEventListener('change', () => {
      validateBusinessHours();
      updateBusinessHours();
    });
  }
  
  // é€šçŸ¥è¡¨ç¤ºé–¢æ•°
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
      top: 20px;
      right: 20px;
      z-index: 1050;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    `;
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
  

});
</script>

<style>
.card {
  transition: box-shadow 0.15s ease-in-out;
}

.card:hover {
  box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.form-control:focus, .form-select:focus {
  border-color: #86b7fe;
  box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.alert-light {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
}

.badge {
  font-size: 0.9em;
}
</style>