<% content_for :title, "äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ - Mobilis" %>

<div class="calendar-container">
      <div class="card shadow-sm border-0 mb-4">
      <div class="card-body py-4">
        <div class="row align-items-center" style="min-height: 200px;">
        <!-- å·¦å´ï¼šã‚¿ã‚¤ãƒˆãƒ« -->
        <div class="col-lg-4 col-md-6 mb-3 mb-md-0">
          <h1 class="h2 mb-0 text-primary" style="padding-left: 60px;">
            <i class="fas fa-calendar-alt me-2"></i>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
          </h1>
        </div>
        
        <!-- ä¸­å¤®ï¼šãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
        <div class="col-lg-4 col-md-6 d-flex justify-content-center align-items-center mb-3 mb-md-0">
          <div id="monthCalendar">
            <!-- å¹´ã¨æœˆã®è¡¨ç¤ºã¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
            <div class="mini-calendar-header" style="background: #f8f9fa; border-bottom: 1px solid #dee2e6; border-radius: 4px; display: flex; align-items: center; justify-content: space-between;">
              <button id="prevMonthBtn" class="mini-calendar-nav-btn" style="background: transparent; border: none; color: #6c757d; font-size: 0.5rem; padding: 2px; cursor: pointer;">
                <i class="fas fa-chevron-left"></i>
              </button>
              <div id="currentMonthYear" class="mini-calendar-title" style="font-size: 0.6rem; font-weight: 600; color: #495057; text-align: center; flex: 1; cursor: pointer;">
                <!-- å¹´ã¨æœˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
              </div>
              <button id="nextMonthBtn" class="mini-calendar-nav-btn" style="background: transparent; border: none; color: #6c757d; font-size: 0.5rem; padding: 2px; cursor: pointer;">
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
            <div id="monthCalendarContent"></div>
          </div>
        </div>
        
        <!-- å³å´ï¼šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="col-lg-4 col-md-12">
          <div class="d-flex flex-column gap-3">
            <!-- å–¶æ¥­æ™‚é–“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
            <div class="business-status-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <h6 class="mb-1" style="margin: 0; font-weight: 600;">
                    <i class="fas fa-clock me-2"></i>å–¶æ¥­æ™‚é–“
                  </h6>
                  <div class="business-hours-display" style="font-size: 0.9rem; opacity: 0.9;">
                    <%= ApplicationSetting.current.formatted_business_hours %>
                  </div>
                </div>
                <div class="business-status-indicator" style="text-align: center;">
                  <div class="status-dot <%= ApplicationSetting.current.currently_open? ? 'open' : 'closed' %>" 
                       style="width: 12px; height: 12px; border-radius: 50%; margin: 0 auto 5px; background: <%= ApplicationSetting.current.currently_open? ? '#28a745' : '#dc3545' %>;"></div>
                  <div style="font-size: 0.8rem; font-weight: 500;">
                    <%= ApplicationSetting.current.currently_open? ? 'å–¶æ¥­ä¸­' : 'å–¶æ¥­æ™‚é–“å¤–' %>
                  </div>
                </div>
              </div>
            </div>
            
            <a href="<%= admin_reservations_path %>" class="btn btn-primary btn-lg shadow-sm">
              <i class="fas fa-list me-2"></i>ğŸ“‹ ä»Šæ—¥ã®äºˆç´„ä¸€è¦§
            </a>
            <div class="d-flex gap-3">
              <button id="newReservationBtn" class="btn btn-success btn-lg">
                <i class="fas fa-plus me-2"></i>æ–°è¦äºˆç´„
              </button>
              <button id="shiftSettingsBtn" class="btn btn-info btn-lg">
                <i class="fas fa-clock me-2"></i>ã‚·ãƒ•ãƒˆè¨­å®š
              </button>
              <button class="btn btn-outline-danger btn-lg" onclick="openCancelledHistoryModal()">
                <i class="fas fa-times-circle me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>  

  <div class="container-fluid" style="margin-top: 20px; margin-bottom: 20px;">
    <div id="calendar" class="shift-highlight-enabled"></div>
  </div>
</div>  

<!-- å¹´ã¨æœˆã®é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="monthYearModal" tabindex="-1" aria-labelledby="monthYearModalLabel" data-bs-backdrop="static" data-bs-keyboard="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="monthYearModalLabel">
          <i class="fas fa-calendar me-2"></i>å¹´ã¨æœˆã®é¸æŠ
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeMonthYearModal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-6">
            <label for="yearSelect" class="form-label">å¹´</label>
            <select class="form-select" id="yearSelect">
              <!-- å¹´ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
            </select>
          </div>
          <div class="col-6">
            <label for="monthSelect" class="form-label">æœˆ</label>
            <select class="form-select" id="monthSelect">
              <option value="1">1æœˆ</option>
              <option value="2">2æœˆ</option>
              <option value="3">3æœˆ</option>
              <option value="4">4æœˆ</option>
              <option value="5">5æœˆ</option>
              <option value="6">6æœˆ</option>
              <option value="7">7æœˆ</option>
              <option value="8">8æœˆ</option>
              <option value="9">9æœˆ</option>
              <option value="10">10æœˆ</option>
              <option value="11">11æœˆ</option>
              <option value="12">12æœˆ</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="btn btn-primary" id="applyMonthYear">é©ç”¨</button>
      </div>
    </div>
  </div>
</div>

<!-- äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reservationModalLabel">
          <i class="fas fa-calendar-plus me-2"></i>äºˆç´„ä½œæˆãƒ»ç·¨é›†
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="reservationForm">
          <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
          <input type="hidden" id="currentReservationId" value="">
          <input type="hidden" id="selectedUserId" value="">
          
          <!-- é¡§å®¢é¸æŠãƒ»æ¤œç´¢ -->
          <div class="row mb-3">
            <div class="col-12">
              <label for="customerSearch" class="form-label">é¡§å®¢æ¤œç´¢ãƒ»é¸æŠ *</label>
              <div class="position-relative">
                                 <input type="text" class="form-control" id="customerSearch" 
                        placeholder="é¡§å®¢åã€ãƒ•ãƒªã‚¬ãƒŠã€é›»è©±ç•ªå·ã§æ¤œç´¢...">
                <div id="customerSearchResults" class="position-absolute w-100 bg-white border rounded shadow-sm" 
                     style="z-index: 1050; max-height: 200px; overflow-y: auto; display: none;">
                  <!-- æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤º -->
            </div>
              </div>
          </div>
        </div>
        
          <!-- é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã®è¡¨ç¤º -->
          <div id="selectedCustomerInfo" class="row mb-3" style="display: none;">
            <div class="col-12">
              <div class="alert alert-info">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="alert-heading mb-1">
                      <i class="fas fa-user me-1"></i>
                      <span id="selectedCustomerName"></span>
                    </h6>
                    <small class="text-muted">
                      <span id="selectedCustomerDetails"></span>
                    </small>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="clearCustomerBtn">
                    <i class="fas fa-times"></i> å¤‰æ›´
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- æ–°è¦é¡§å®¢ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ—¢å­˜é¡§å®¢ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰ -->
          <div id="newCustomerForm" class="row mb-3" style="display: none;">
            <div class="col-12">
              <div class="alert alert-warning">
                <h6 class="alert-heading">
                  <i class="fas fa-user-plus me-1"></i>æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²
                </h6>
                <p class="mb-2">è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚</p>
              </div>
            </div>
            
            <div class="col-md-6">
              <label for="newCustomerName" class="form-label">é¡§å®¢å *</label>
              <input type="text" class="form-control" id="newCustomerName" required>
            </div>
            <div class="col-md-6">
              <label for="newCustomerPhone" class="form-label">é›»è©±ç•ªå·</label>
              <input type="tel" class="form-control" id="newCustomerPhone">
            </div>
            
            <div class="col-md-6 mt-2">
              <label for="newCustomerKana" class="form-label">ãƒ•ãƒªã‚¬ãƒŠ</label>
              <input type="text" class="form-control" id="newCustomerKana">
            </div>
            <div class="col-md-6 mt-2">
              <label for="newCustomerEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
              <input type="email" class="form-control" id="newCustomerEmail">
            </div>
          </div>
          
          <!-- äºˆç´„æƒ…å ±ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰ -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationDate" class="form-label">æ—¥ä»˜ *</label>
              <input type="date" class="form-control" id="reservationDate" required>
            </div>
            <div class="col-md-6">
              <label for="reservationTime" class="form-label">æ™‚é–“ *</label>
              <input type="time" class="form-control" id="reservationTime" min="10:00" max="21:00" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationCourse" class="form-label">ã‚³ãƒ¼ã‚¹ *</label>
              <select class="form-select" id="reservationCourse" required>
                <option value="">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠ</option>
                <option value="40åˆ†ã‚³ãƒ¼ã‚¹">40åˆ†ã‚³ãƒ¼ã‚¹ (Â¥8,000)</option>
                <option value="60åˆ†ã‚³ãƒ¼ã‚¹">60åˆ†ã‚³ãƒ¼ã‚¹ (Â¥12,000)</option>
                <option value="80åˆ†ã‚³ãƒ¼ã‚¹">80åˆ†ã‚³ãƒ¼ã‚¹ (Â¥16,000)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="reservationStatus" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <select class="form-select" id="reservationStatus">
                <option value="tentative">ä»®äºˆç´„</option>
                <option value="confirmed" selected>ç¢ºå®š</option>
                <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                <option value="completed">å®Œäº†</option>
                <option value="no_show">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
              </select>
            </div>
          </div>
          
          <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®š -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationInterval" class="form-label">æ•´ç†æ™‚é–“ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼‰</label>
              <select class="form-select" id="reservationInterval">
                <option value="">ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä½¿ç”¨</option>
                <option value="0">0åˆ†ï¼ˆæ•´ç†æ™‚é–“ãªã—ï¼‰</option>
                <option value="5">5åˆ†</option>
                <option value="10">10åˆ†</option>
                <option value="15">15åˆ†</option>
                <option value="20">20åˆ†</option>
                <option value="30">30åˆ†</option>
                <option value="45">45åˆ†</option>
                <option value="60">60åˆ†</option>
              </select>
              <small class="text-muted">å€‹åˆ¥ã«æ•´ç†æ™‚é–“ã‚’è¨­å®šã§ãã¾ã™</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">ç¾åœ¨ã®è¨­å®š</label>
              <div id="currentIntervalInfo" class="form-control-plaintext">
                <span class="badge bg-primary">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: 15åˆ†</span>
              </div>
            </div>
          </div>
          
          <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
          <div class="row mb-3" id="cancellationReasonRow" style="display: none;">
            <div class="col-12">
              <label for="cancellationReason" class="form-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”± <span class="text-danger">*</span></label>
              <textarea class="form-control" id="cancellationReason" rows="2" placeholder="ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>
          </div>
          
          <!-- ãƒã‚±ãƒƒãƒˆæƒ…å ± -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">ãƒã‚±ãƒƒãƒˆæƒ…å ±</label>
              <div id="ticketInfo" class="border rounded p-3 bg-light">
                <div class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
              </div>
            </div>
          </div>
          
          <!-- ãƒ¡ãƒ¢ -->
          <div class="row mb-3">
            <div class="col-12">
              <label for="reservationMemo" class="form-label">ãƒ¡ãƒ¢ãƒ»æ³¨æ„äº‹é …</label>
              <textarea class="form-control" id="reservationMemo" rows="3" placeholder="äºˆç´„ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚„æ³¨æ„äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="button" class="btn btn-danger" id="deleteReservationBtn" style="display: none;">
            <i class="fas fa-trash me-1"></i>å‰Šé™¤
          </button>
        <button type="button" class="btn btn-primary" id="saveReservationBtn">
            <i class="fas fa-save me-1"></i>ä¿å­˜
          </button>
      </div>
    </div>
  </div>
</div>

<!-- é¡§å®¢å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="customerHistoryModal" tabindex="-1" aria-labelledby="customerHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerHistoryModalLabel">
          <i class="fas fa-history me-2"></i>é¡§å®¢å±¥æ­´
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="customerHistoryContent">
          <!-- é¡§å®¢å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="cancelledHistoryModal" tabindex="-1" aria-labelledby="cancelledHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelledHistoryModalLabel">
          <i class="fas fa-times-circle text-danger me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆãƒ»å±¥æ­´
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-danger">
              <div class="card-body text-center">
                <h3 class="text-danger mb-0" id="modalCancelledCount">0</h3>
                <small class="text-muted">ä»Šæœˆã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ•°</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-warning">
              <div class="card-body text-center">
                <h3 class="text-warning mb-0" id="modalCancelledRate">0%</h3>
                <small class="text-muted">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç‡</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-info">
              <div class="card-body text-center">
                <h3 class="text-info mb-0" id="modalTotalReservations">0</h3>
                <small class="text-muted">ä»Šæœˆã®ç·äºˆç´„æ•°</small>
              </div>
            </div>
          </div>
        </div>
        <div id="modalCancelledHistory">
          <div class="text-muted text-center py-3">
            <i class="fas fa-info-circle me-1"></i>
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ã‚·ãƒ•ãƒˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="shiftSettingsModal" tabindex="-1" aria-labelledby="shiftSettingsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="shiftSettingsModalLabel">
          <i class="fas fa-clock text-info me-2"></i>ã‚·ãƒ•ãƒˆè¨­å®š
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-6">
            <label for="shiftDateSelect" class="form-label">æ—¥ä»˜é¸æŠ</label>
            <input type="date" class="form-control" id="shiftDateSelect">
          </div>
          <div class="col-md-6">
            <label for="shiftTypeSelect" class="form-label">ã‚·ãƒ•ãƒˆã‚¿ã‚¤ãƒ—</label>
            <select class="form-select" id="shiftTypeSelect">
              <option value="normal">é€šå¸¸å–¶æ¥­</option>
              <option value="extended">å–¶æ¥­æ™‚é–“å»¶é•·</option>
              <option value="shortened">å–¶æ¥­æ™‚é–“çŸ­ç¸®</option>
              <option value="closed">å–¶æ¥­ä¼‘æ­¢</option>
              <option value="custom">ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“</option>
            </select>
          </div>
        </div>
        
        <div id="shiftTimeSettings" class="row" style="display: none;">
          <div class="col-md-6">
                            <label for="shiftStartTime" class="form-label">é–‹å§‹æ™‚é–“</label>
                <input type="time" class="form-control" id="shiftStartTime" value="10:00" min="08:00" max="22:00">
                <small class="form-text text-muted">ãƒ™ãƒ¼ã‚¹å–¶æ¥­æ™‚é–“: 10:00-21:00</small>
          </div>
          <div class="col-md-6">
                            <label for="shiftEndTime" class="form-label">çµ‚äº†æ™‚é–“</label>
                <input type="time" class="form-control" id="shiftEndTime" value="21:00" min="08:00" max="22:00">
                <small class="form-text text-muted">ãƒ™ãƒ¼ã‚¹å–¶æ¥­æ™‚é–“: 10:00-21:00</small>
          </div>
        </div>
        
        <div id="shiftBreakSettings" class="row mt-3" style="display: none;">
          <div class="col-12">
            <div class="card border-info">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                  <i class="fas fa-coffee me-2"></i>ä¼‘æ†©æ™‚é–“è¨­å®š
                </h6>
              </div>
              <div class="card-body">
                <div id="breakTimeList">
                  <div class="break-time-item card mb-3">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-md-3">
                          <label class="form-label small text-muted">é–‹å§‹æ™‚é–“</label>
                          <input type="time" class="form-control" placeholder="12:00">
                        </div>
                        <div class="col-md-3">
                          <label class="form-label small text-muted">çµ‚äº†æ™‚é–“</label>
                          <input type="time" class="form-control" placeholder="13:00">
                        </div>
                        <div class="col-md-2">
                          <label class="form-label small text-muted">æ“ä½œ</label>
                          <button type="button" class="btn btn-outline-danger btn-sm remove-break w-100">
                            <i class="fas fa-trash me-1"></i>å‰Šé™¤
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="text-center">
                  <button type="button" class="btn btn-outline-primary" id="addBreakTime">
                    <i class="fas fa-plus me-2"></i>ä¼‘æ†©æ™‚é–“ã‚’è¿½åŠ 
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-12">
            <label for="shiftNotes" class="form-label">ãƒ¡ãƒ¢</label>
            <textarea class="form-control" id="shiftNotes" rows="3" placeholder="ã‚·ãƒ•ãƒˆã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."></textarea>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-12">
            <div class="card border-success">
              <div class="card-header bg-success text-white">
                <h6 class="mb-0">
                  <i class="fas fa-calendar-check me-2"></i>è¨­å®šæ¸ˆã¿ã‚·ãƒ•ãƒˆä¸€è¦§
                </h6>
              </div>
              <div class="card-body">
                <div id="shiftList">
                  <!-- ã‚·ãƒ•ãƒˆä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                  <div id="emptyShiftList" class="text-center py-5">
                    <i class="fas fa-calendar-times text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">è¨­å®šæ¸ˆã¿ã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</h5>
                    <p class="text-muted">ã‚·ãƒ•ãƒˆã‚’è¨­å®šã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="button" class="btn btn-primary" id="saveShiftSettings">
          <i class="fas fa-save me-1"></i>ä¿å­˜
        </button>
      </div>
    </div>
  </div>
</div>
<style>
/* ã‚·ãƒ³ãƒ—ãƒ«ãªã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ */
.fc-timegrid-slot[data-time$=":30:00"] {
  border-top: 2px solid #28a745 !important;
}

.fc-timegrid-slot[data-time$=":00:00"] {
  border-top: 3px solid #dc3545 !important;
}

.fc {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  border: 2px solid #e2e8f0;
  margin: 0px auto;
  max-width: 1400px;
  position: relative;
  overflow: hidden;
}

.fc::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
  pointer-events: none;
  z-index: 1;
}

.fc-view-harness {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 18px;
  position: relative;
  z-index: 2;
}

.fc-toolbar {
  padding: 8px 0;
  border-bottom: 2px solid #f1f5f9;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  position: relative;
  z-index: 2;
  width: 100%;
  max-width: 100%;
  margin: 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.fc-toolbar-chunk {
  display: flex;
  align-items: center;
  gap: 10px;
  flex: 1;
  justify-content: center;
}

.fc-toolbar::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
}

.fc-toolbar-title {
  font-size: 2rem;
  font-weight: 800;
  color: #1e293b;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.fc-button {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
  border: none !important;
  color: white !important;
  border-radius: 12px !important;
  font-weight: 600 !important;
  padding: 16px 20px !important;
  transition: all 0.3s ease !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
  position: relative !important;
  overflow: hidden !important;
  margin: 8px 0 !important;
}

.fc-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.fc-button:hover::before {
  left: 100%;
}

.fc-button:hover {
  background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
  transform: translateY(-3px) !important;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2) !important;
}

.fc-button:focus {
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

.fc-button-active {
  background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
}

/* ==============================================
   10åˆ†é–“éš”ã‚¹ãƒ­ãƒƒãƒˆã®é«˜ã•å›ºå®šã¨ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³å¼·åŒ–
   ============================================== */
/* ã‚¹ãƒ­ãƒƒãƒˆå…¨ä½“ã®èª¿æ•´ */
.fc-timegrid-slot {
  height: 20px !important; /* 10åˆ†åˆ»ã¿ãªã®ã§å°‘ã—å°ã•ã */
  border-top: 1px solid #e9ecef !important; /* åŸºæœ¬ã®ç´°ã„ç·š */
}

/* 30åˆ†åˆ»ã¿ã®å¢ƒç•Œç·šã‚’å¼·èª¿ï¼ˆå…¨ã¦ã®æ™‚é–“ã§é©ç”¨ï¼‰ */
.fc-timegrid-slot[data-time$=":30:00"] {
  border-top: 2px solid #dee2e6 !important; /* 30åˆ†ã”ã¨ã®ç·š */
}

/* 1æ™‚é–“åˆ»ã¿ã®å¢ƒç•Œç·šã‚’ã•ã‚‰ã«å¼·èª¿ï¼ˆå…¨ã¦ã®æ™‚é–“ã§é©ç”¨ï¼‰ */
.fc-timegrid-slot[data-time$=":00:00"] {
  border-top: 3px solid #adb5bd !important; /* 1æ™‚é–“ã”ã¨ã®å¤ªã„ç·š */
}

/* å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚’è¡¨ç¤º */
.fc-timegrid-slot[data-time^="08:"] {
  border-top: 1px solid #e9ecef !important;
}

.fc-timegrid-slot[data-time^="08:"][data-time$=":30:00"] {
  border-top: 2px solid #dee2e6 !important;
}

.fc-timegrid-slot[data-time^="08:"][data-time$=":00:00"] {
  border-top: 3px solid #adb5bd !important;
}

.fc-timegrid-slot[data-time^="09:"] {
  border-top: 1px solid #e9ecef !important;
}

.fc-timegrid-slot[data-time^="09:"][data-time$=":30:00"] {
  border-top: 2px solid #dee2e6 !important;
}

.fc-timegrid-slot[data-time^="09:"][data-time$=":00:00"] {
  border-top: 3px solid #adb5bd !important;
}

.fc-timegrid-slot[data-time^="21:"] {
  border-top: 1px solid #e9ecef !important;
}

.fc-timegrid-slot[data-time^="21:"][data-time$=":30:00"] {
  border-top: 2px solid #dee2e6 !important;
}

.fc-timegrid-slot[data-time^="21:"][data-time$=":00:00"] {
  border-top: 3px solid #adb5bd !important;
}

.fc-timegrid-slot[data-time^="22:"] {
  border-top: 1px solid #e9ecef !important;
}

.fc-timegrid-slot[data-time^="22:"][data-time$=":30:00"] {
  border-top: 2px solid #dee2e6 !important;
}

.fc-timegrid-slot[data-time^="22:"][data-time$=":00:00"] {
  border-top: 3px solid #adb5bd !important;
}

.fc-timegrid-slots table {
  height: 100% !important;
}

/* 30åˆ†ã”ã¨ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒ©ã‚¤ãƒ³ */
.fc-timegrid-slot[data-time$=":00"] {
  border-top: 2px solid #cbd5e0 !important; /* ãƒ©ã‚¤ãƒ³ã‚’ä¸Šã«è¡¨ç¤º */
}

.fc-timegrid-slot[data-time$=":30"] {
  border-top: 1.5px solid #e2e8f0 !important; /* ãƒ©ã‚¤ãƒ³ã‚’ä¸Šã«è¡¨ç¤º */
}

/* æ™‚é–“è»¸ã®èª¿æ•´ */
.fc-timegrid-axis-frame {
  height: 30px !important;
  min-height: 30px !important;
}
      
.fc-timegrid-slot-label {
  font-size: 0.75rem !important;
  padding: 2px 4px !important;
  color: #4a5568 !important;
}

.fc-timegrid-slot[data-time^="08:"],
.fc-timegrid-slot[data-time^="09:"],
.fc-timegrid-slot[data-time^="22:"] {
  background-color: #f8f9fa !important;
  opacity: 0.7;
  position: relative;
}

/* å–¶æ¥­æ™‚é–“å¤–ã®æ™‚é–“è»¸ãƒ©ãƒ™ãƒ«ã‚’è–„ã */
.fc-timegrid-axis[data-time^="08:"],
.fc-timegrid-axis[data-time^="09:"],
.fc-timegrid-axis[data-time^="22:"] {
  background-color: #f8f9fa !important;
  color: #6c757d !important;
  font-style: italic;
  font-weight: normal;
}

/* é€šå¸¸å–¶æ¥­æ™‚é–“ã®ãƒ©ãƒ™ãƒ«ã‚’å¼·èª¿ */
.fc-timegrid-axis[data-time^="10:"],
.fc-timegrid-axis[data-time^="11:"],
.fc-timegrid-axis[data-time^="12:"],
.fc-timegrid-axis[data-time^="13:"],
.fc-timegrid-axis[data-time^="14:"],
.fc-timegrid-axis[data-time^="15:"],
.fc-timegrid-axis[data-time^="16:"],
.fc-timegrid-axis[data-time^="17:"],
.fc-timegrid-axis[data-time^="18:"],
.fc-timegrid-axis[data-time^="19:"],
.fc-timegrid-axis[data-time^="20:"] {
  background-color: #fff !important;
  color: #212529 !important;
  font-weight: 600;
}

/* å–¶æ¥­é–‹å§‹æ™‚é–“ï¼ˆ10:00ï¼‰ã®å¢ƒç•Œç·šã¨ãƒ©ãƒ™ãƒ« */
.fc-timegrid-slot[data-time="10:00:00"] {
  border-top: 3px solid #28a745 !important;
  position: relative;
}

.fc-timegrid-slot[data-time="10:00:00"]::before {
  content: "å–¶æ¥­é–‹å§‹";
  position: absolute;
  left: 5px;
  top: -15px;
  background: #28a745;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: bold;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* å–¶æ¥­çµ‚äº†æ™‚é–“ï¼ˆ21:00ï¼‰ã®å¢ƒç•Œç·šã¨ãƒ©ãƒ™ãƒ« */
.fc-timegrid-slot[data-time="21:00:00"] {
  border-top: 3px solid #dc3545 !important;
  position: relative;
}

.fc-timegrid-slot[data-time="21:00:00"]::before {
  content: "å–¶æ¥­çµ‚äº†";
  position: absolute;
  left: 5px;
  top: -15px;
  background: #dc3545;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: bold;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* ã‚·ãƒ•ãƒˆå»¶é•·æ™‚é–“ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆä»Šå¾Œã®æ©Ÿèƒ½ç”¨ï¼‰ */
.shift-extended-early {
  background: linear-gradient(90deg, #e8f5e8 0%, #fff 30%) !important;
  border-left: 3px solid #28a745 !important;
}

.shift-extended-late {
  background: linear-gradient(90deg, #fff 70%, #e8f5e8 100%) !important;
  border-left: 3px solid #28a745 !important;
}

/* ãƒ›ãƒãƒ¼åŠ¹æœã®æ”¹å–„ */
.fc-timegrid-slot:hover {
  background-color: #e3f2fd !important;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

/* å–¶æ¥­æ™‚é–“å¤–ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
.fc-timegrid-slot[data-time^="08:"]:hover,
.fc-timegrid-slot[data-time^="09:"]:hover,
.fc-timegrid-slot[data-time^="21:"]:hover {
  background-color: #fff3cd !important;
}

/* æ™‚é–“è»¸å…¨ä½“ã®èª¿æ•´ */
.fc-timegrid-axis {
  font-size: 12px;
  border-right: 2px solid #dee2e6 !important;
  min-width: 80px;
}


/* ==============================================
   äºˆç´„ã‚¤ãƒ™ãƒ³ãƒˆã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event {
  border-radius: 8px !important;
  font-size: 0.8rem !important;
  font-weight: 600 !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
  transition: all 0.3s ease !important;
  border: 2px solid transparent !important;
  margin: 1px !important;
  overflow: hidden !important;
  position: relative !important;
  height: auto !important;
}

.fc-timegrid-event::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
  pointer-events: none;
  z-index: 1;
}

.fc-timegrid-event:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.25) !important;
  transform: translateX(2px) !important;
  z-index: 1000 !important;
}

/* ==============================================
   å…¨ã‚³ãƒ¼ã‚¹å¯¾å¿œã®é«˜ã•è¨­å®šï¼ˆ30px baseï¼‰
   ============================================== */

/* 40åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="40"] {
  min-height: 120px !important;
  height: 120px !important;
}

.fc-timegrid-event[data-duration="45"] {
  min-height: 135px !important;
  height: 135px !important;
}

.fc-timegrid-event[data-duration="50"] {
  min-height: 150px !important;
  height: 150px !important;
}

.fc-timegrid-event[data-duration="55"] {
  min-height: 165px !important;
  height: 165px !important;
}

/* 60åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="60"] {
  min-height: 180px !important;
  height: 180px !important;
}

.fc-timegrid-event[data-duration="65"] {
  min-height: 195px !important;
  height: 195px !important;
}

.fc-timegrid-event[data-duration="70"] {
  min-height: 210px !important;
  height: 210px !important;
}

.fc-timegrid-event[data-duration="75"] {
  min-height: 225px !important;
  height: 225px !important;
}

.fc-timegrid-event[data-duration="80"] {
  min-height: 240px !important;
  height: 240px !important;
}

/* 80åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="85"] {
  min-height: 340px !important;
  height: 340px !important;
}

.fc-timegrid-event[data-duration="90"] {
  min-height: 360px !important;
  height: 360px !important;
}

.fc-timegrid-event[data-duration="95"] {
  min-height: 380px !important;
  height: 380px !important;
}

.fc-timegrid-event[data-duration="100"] {
  min-height: 400px !important;
  height: 400px !important;
}

/* ãã®ä»–ã®ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“ */
.fc-timegrid-event[data-duration="105"] {
  min-height: 420px !important;
  height: 420px !important;
}

.fc-timegrid-event[data-duration="110"] {
  min-height: 440px !important;
  height: 440px !important;
}

.fc-timegrid-event[data-duration="120"] {
  min-height: 480px !important;
  height: 480px !important;
}

/* ==============================================
   ã‚¿ãƒ–å½¢å¼ã®ã‚¤ãƒ™ãƒ³ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event .event-tab-container {
  height: 100% !important;
  display: flex !important;
  flex-direction: column !important;
  width: 100% !important;
}

.fc-timegrid-event .event-tab {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 600 !important;
  text-align: center !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  transition: all 0.2s ease !important;
  border: none !important;
}

.fc-timegrid-event .event-tab.course {
  background: inherit !important;
  color: inherit !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
}

.fc-timegrid-event .event-tab.interval {
        color: white !important;
        font-weight: 500 !important;
}

.fc-timegrid-event .event-tab.interval.individual {
  background-color: #fd7e14 !important;
  font-weight: 600 !important;
}

.fc-timegrid-event .event-tab.interval.system {
  background-color: #6c757d !important;
}

/* ==============================================
   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®è‰²åˆ†ã‘
   ============================================== */
.fc-timegrid-event.confirmed {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
  border: 2px solid #28a745 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3) !important;
}

.fc-timegrid-event.tentative {
  background: linear-gradient(135deg, #ffc107 0%, #ffb84d 100%) !important;
        border: 2px solid #ffc107 !important;
        color: #212529 !important;
  box-shadow: 0 4px 16px rgba(255, 193, 7, 0.3) !important;
}

.fc-timegrid-event.cancelled {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
  border: 2px solid #dc3545 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3) !important;
}

.fc-timegrid-event.completed {
  background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%) !important;
  border: 2px solid #6f42c1 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(111, 66, 193, 0.3) !important;
}

.fc-timegrid-event.no_show {
  background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
  border: 2px solid #6c757d !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(108, 117, 125, 0.3) !important;
}

.fc-timegrid-event.break {
  background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
  border: 2px solid #17a2b8 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(23, 162, 184, 0.3) !important;
}

/* ==============================================
   ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒ—åˆ¥ã®è¦–è¦šçš„åŒºåˆ¥
   ============================================== */
.fc-timegrid-event.has-interval .event-tab.interval.individual::before {
  content: "âš™ï¸ ";
  font-size: 0.6em;
  margin-right: 2px;
}

.fc-timegrid-event.has-interval .event-tab.interval.system::before {
  content: "ğŸ”§ ";
  font-size: 0.6em;
  margin-right: 2px;
}

/* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±è¡¨ç¤º */
.fc-timegrid-event.has-interval:hover::after {
  content: attr(data-interval-info);
  position: absolute;
  top: -30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  white-space: nowrap;
  z-index: 10000;
  pointer-events: none;
}

/* ==============================================
   ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
   ============================================== */
@media (max-width: 1024px) {
  .calendar-toolbar {
    gap: 20px;
    padding: 0 20px;
  }
  
  .calendar-title {
    font-size: 1.8rem;
  }
  
  .fc {
    margin: 0px auto;
    border-radius: 16px;
  }
  
  .fc-toolbar {
    padding: 8px 0;
    width: 100%;
    max-width: 100%;
  }
  
  .fc-toolbar-title {
    font-size: 1.6rem;
  }
}

@media (max-width: 768px) {
  .calendar-toolbar {
    flex-direction: column;
    gap: 12px;
    padding: 0 20px;
  }
  
  .calendar-nav {
    order: 1;
    margin: 0;
  }
  
  .calendar-title {
    order: 2;
    font-size: 1.6rem;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }
  
  .calendar-actions {
    order: 3;
    flex-direction: row;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 8px 12px;
    font-size: 0.85rem;
    min-width: 100px;
    flex: 1;
  }

  /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¹ãƒ­ãƒƒãƒˆé«˜ã• (35px base) */
  .fc-timegrid-slot {
    height: 35px !important;
    min-height: 35px !important;
    max-height: 35px !important;
  }
  
  .fc-timegrid-axis-frame {
    height: 35px !important;
    min-height: 35px !important;
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®é«˜ã•èª¿æ•´ */
  .fc-timegrid-event[data-duration="40"] { height: 140px !important; min-height: 140px !important; }
  .fc-timegrid-event[data-duration="45"] { height: 157px !important; min-height: 157px !important; }
  .fc-timegrid-event[data-duration="50"] { height: 175px !important; min-height: 175px !important; }
  .fc-timegrid-event[data-duration="55"] { height: 192px !important; min-height: 192px !important; }
  .fc-timegrid-event[data-duration="60"] { height: 210px !important; min-height: 210px !important; }
  .fc-timegrid-event[data-duration="65"] { height: 227px !important; min-height: 227px !important; }
  .fc-timegrid-event[data-duration="70"] { height: 245px !important; min-height: 245px !important; }
  .fc-timegrid-event[data-duration="75"] { height: 262px !important; min-height: 262px !important; }
  .fc-timegrid-event[data-duration="80"] { height: 280px !important; min-height: 280px !important; }
  .fc-timegrid-event[data-duration="85"] { height: 297px !important; min-height: 297px !important; }
  .fc-timegrid-event[data-duration="90"] { height: 315px !important; min-height: 315px !important; }
  .fc-timegrid-event[data-duration="95"] { height: 332px !important; min-height: 332px !important; }
  .fc-timegrid-event[data-duration="100"] { height: 350px !important; min-height: 350px !important; }
  
  .fc-timegrid-event .event-tab {
    font-size: 0.7rem !important;
    padding: 1px 2px !important;
  }
  
  .fc {
    margin: 15px auto;
    border-radius: 12px;
  }
  
  .fc-toolbar {
    padding: 8px 0;
    width: 100%;
    max-width: 100%;
  }
  
  .fc-toolbar-title {
    font-size: 1.4rem;
  }


}

@media (max-width: 480px) {
  .calendar-toolbar {
    gap: 8px;
    padding: 0 15px;
  }
  
  .calendar-title {
    font-size: 1.4rem;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }
  
  .calendar-actions {
    flex-direction: column;
    gap: 6px;
  }
  
  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 6px 10px;
    font-size: 0.8rem;
    min-width: 80px;
  }
  
  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 8px 12px;
    font-size: 0.8rem;
  }
  
  /* å°ç”»é¢ç”¨ã®ã‚¹ãƒ­ãƒƒãƒˆé«˜ã• (30px base) */
  .fc-timegrid-slot {
    height: 30px !important;
    min-height: 30px !important;
    max-height: 30px !important;
  }
  
  .fc-timegrid-axis-frame {
    height: 30px !important;
    min-height: 30px !important;
  }
  
  /* å°ç”»é¢ç”¨ã®é«˜ã•èª¿æ•´ */
  .fc-timegrid-event[data-duration="40"] { height: 120px !important; min-height: 120px !important; }
  .fc-timegrid-event[data-duration="45"] { height: 135px !important; min-height: 135px !important; }
  .fc-timegrid-event[data-duration="50"] { height: 150px !important; min-height: 150px !important; }
  .fc-timegrid-event[data-duration="55"] { height: 165px !important; min-height: 165px !important; }
  .fc-timegrid-event[data-duration="60"] { height: 180px !important; min-height: 180px !important; }
  .fc-timegrid-event[data-duration="65"] { height: 195px !important; min-height: 195px !important; }
  .fc-timegrid-event[data-duration="70"] { height: 210px !important; min-height: 210px !important; }
  .fc-timegrid-event[data-duration="75"] { height: 225px !important; min-height: 225px !important; }
  .fc-timegrid-event[data-duration="80"] { height: 240px !important; min-height: 240px !important; }
  .fc-timegrid-event[data-duration="85"] { height: 255px !important; min-height: 255px !important; }
  .fc-timegrid-event[data-duration="90"] { height: 270px !important; min-height: 270px !important; }
  .fc-timegrid-event[data-duration="95"] { height: 285px !important; min-height: 285px !important; }
  .fc-timegrid-event[data-duration="100"] { height: 300px !important; min-height: 300px !important; }
  
  .fc-timegrid-event .event-tab {
    font-size: 0.65rem !important;
    padding: 1px !important;
  }

  .fc {
    margin: 10px auto;
    border-radius: 10px;
  }
  
  .fc-toolbar {
    padding: 12px 15px;
  }
  
  .fc-toolbar-title {
    font-size: 1.2rem;
  }


}

/* ==============================================
   å‹•çš„é«˜ã•è¨­å®šã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
   ============================================== */
.height-calculated {
  transition: height 0.3s ease !important;
}

/* ==============================================
   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¨ä½“ã®ã‚°ãƒªãƒƒãƒ‰å¼·åŒ–
   ============================================== */
.fc-timegrid-col-frame {
  border-right: 1px solid #e2e8f0 !important;
}

/* ==============================================
   å–¶æ¥­æ™‚é–“å¤–ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-slot[data-time^="08:"]:before,
.fc-timegrid-slot[data-time^="09:"]:before,
.fc-timegrid-slot[data-time^="21:"]:before,
.fc-timegrid-slot[data-time^="22:"]:before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, 
    transparent 30%, 
    rgba(108, 117, 125, 0.3) 35%, 
    rgba(108, 117, 125, 0.3) 40%, 
    transparent 45%
  );
  pointer-events: none;
}

/* å–¶æ¥­æ™‚é–“å¤–ã®ã‚¹ãƒ­ãƒƒãƒˆèƒŒæ™¯è‰² */
.fc-timegrid-slot[data-time^="08:"],
.fc-timegrid-slot[data-time^="09:"],
.fc-timegrid-slot[data-time^="21:"],
.fc-timegrid-slot[data-time^="22:"] {
  background-color: #6c757d !important;
  opacity: 0.3;
  position: relative;
}

/* å–¶æ¥­æ™‚é–“å†…ã®ã‚¹ãƒ­ãƒƒãƒˆèƒŒæ™¯è‰²ï¼ˆæ˜ã‚‹ãï¼‰ */
.fc-timegrid-slot[data-time^="10:"],
.fc-timegrid-slot[data-time^="11:"],
.fc-timegrid-slot[data-time^="12:"],
.fc-timegrid-slot[data-time^="13:"],
.fc-timegrid-slot[data-time^="14:"],
.fc-timegrid-slot[data-time^="15:"],
.fc-timegrid-slot[data-time^="16:"],
.fc-timegrid-slot[data-time^="17:"],
.fc-timegrid-slot[data-time^="18:"],
.fc-timegrid-slot[data-time^="19:"],
.fc-timegrid-slot[data-time^="20:"] {
  background-color: #f8f9fa !important;
  position: relative;
}

/* å–¶æ¥­æ™‚é–“å¤–ã®æ™‚é–“è»¸ãƒ©ãƒ™ãƒ«ã‚’è–„ã */
.fc-timegrid-axis[data-time^="08:"],
.fc-timegrid-axis[data-time^="09:"],
.fc-timegrid-axis[data-time^="21:"],
.fc-timegrid-axis[data-time^="22:"] {
  background-color: #6c757d !important;
  color: #ffffff !important;
  font-style: italic;
  font-weight: normal;
  opacity: 0.7;
}

/* é€šå¸¸å–¶æ¥­æ™‚é–“ã®ãƒ©ãƒ™ãƒ«ã‚’å¼·èª¿ */
.fc-timegrid-axis[data-time^="10:"],
.fc-timegrid-axis[data-time^="11:"],
.fc-timegrid-axis[data-time^="12:"],
.fc-timegrid-axis[data-time^="13:"],
.fc-timegrid-axis[data-time^="14:"],
.fc-timegrid-axis[data-time^="15:"],
.fc-timegrid-axis[data-time^="16:"],
.fc-timegrid-axis[data-time^="17:"],
.fc-timegrid-axis[data-time^="18:"],
.fc-timegrid-axis[data-time^="19:"],
.fc-timegrid-axis[data-time^="20:"] {
  background-color: #fff !important;
  color: #212529 !important;
  font-weight: 600;
}

/* å–¶æ¥­é–‹å§‹æ™‚é–“ï¼ˆ10:00ï¼‰ã®å¢ƒç•Œç·šã¨ãƒ©ãƒ™ãƒ« */
.fc-timegrid-slot[data-time="10:00:00"] {
  border-top: 3px solid #28a745 !important;
  position: relative;
}

.fc-timegrid-slot[data-time="10:00:00"]::before {
  content: "å–¶æ¥­é–‹å§‹";
  position: absolute;
  left: 5px;
  top: -15px;
  background: #28a745;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: bold;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* å–¶æ¥­çµ‚äº†æ™‚é–“ï¼ˆ21:00ï¼‰ã®å¢ƒç•Œç·šã¨ãƒ©ãƒ™ãƒ« */
.fc-timegrid-slot[data-time="21:00:00"] {
  border-top: 3px solid #dc3545 !important;
  position: relative;
}

.fc-timegrid-slot[data-time="21:00:00"]::before {
  content: "å–¶æ¥­çµ‚äº†";
  position: absolute;
  left: 5px;
  top: -15px;
  background: #dc3545;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: bold;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* ã‚·ãƒ•ãƒˆå»¶é•·æ™‚é–“ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆä»Šå¾Œã®æ©Ÿèƒ½ç”¨ï¼‰ */
.shift-extended-early {
  background: linear-gradient(90deg, #e8f5e8 0%, #fff 30%) !important;
  border-left: 3px solid #28a745 !important;
}

.shift-extended-late {
  background: linear-gradient(90deg, #fff 70%, #e8f5e8 100%) !important;
  border-left: 3px solid #28a745 !important;
}

/* ãƒ›ãƒãƒ¼åŠ¹æœã®æ”¹å–„ */
.fc-timegrid-slot:hover {
  background-color: #e3f2fd !important;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

/* å–¶æ¥­æ™‚é–“å¤–ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
.fc-timegrid-slot[data-time^="08:"]:hover,
.fc-timegrid-slot[data-time^="09:"]:hover,
.fc-timegrid-slot[data-time^="21:"]:hover {
  background-color: #fff3cd !important;
}

/* æ™‚é–“è»¸å…¨ä½“ã®èª¿æ•´ */
.fc-timegrid-axis {
  font-size: 12px;
  border-right: 2px solid #dee2e6 !important;
  min-width: 80px;
}


/* ==============================================
   äºˆç´„ã‚¤ãƒ™ãƒ³ãƒˆã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event {
  border-radius: 8px !important;
  font-size: 0.8rem !important;
  font-weight: 600 !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
  transition: all 0.3s ease !important;
  border: 2px solid transparent !important;
  margin: 1px !important;
  overflow: hidden !important;
  position: relative !important;
  height: auto !important;
}

.fc-timegrid-event::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
  pointer-events: none;
  z-index: 1;
}

.fc-timegrid-event:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.25) !important;
  transform: translateX(2px) !important;
  z-index: 1000 !important;
}

/* ==============================================
   å…¨ã‚³ãƒ¼ã‚¹å¯¾å¿œã®é«˜ã•è¨­å®šï¼ˆ30px baseï¼‰
   ============================================== */

/* 40åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="40"] {
  min-height: 120px !important;
  height: 120px !important;
}

.fc-timegrid-event[data-duration="45"] {
  min-height: 135px !important;
  height: 135px !important;
}

.fc-timegrid-event[data-duration="50"] {
  min-height: 150px !important;
  height: 150px !important;
}

.fc-timegrid-event[data-duration="55"] {
  min-height: 165px !important;
  height: 165px !important;
}

/* 60åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="60"] {
  min-height: 180px !important;
  height: 180px !important;
}

.fc-timegrid-event[data-duration="65"] {
  min-height: 195px !important;
  height: 195px !important;
}

.fc-timegrid-event[data-duration="70"] {
  min-height: 210px !important;
  height: 210px !important;
}

.fc-timegrid-event[data-duration="75"] {
  min-height: 225px !important;
  height: 225px !important;
}

.fc-timegrid-event[data-duration="80"] {
  min-height: 240px !important;
  height: 240px !important;
}

/* 80åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="85"] {
  min-height: 340px !important;
  height: 340px !important;
}

.fc-timegrid-event[data-duration="90"] {
  min-height: 360px !important;
  height: 360px !important;
}

.fc-timegrid-event[data-duration="95"] {
  min-height: 380px !important;
  height: 380px !important;
}

.fc-timegrid-event[data-duration="100"] {
  min-height: 400px !important;
  height: 400px !important;
}

/* ãã®ä»–ã®ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“ */
.fc-timegrid-event[data-duration="105"] {
  min-height: 420px !important;
  height: 420px !important;
}

.fc-timegrid-event[data-duration="110"] {
  min-height: 440px !important;
  height: 440px !important;
}

.fc-timegrid-event[data-duration="120"] {
  min-height: 480px !important;
  height: 480px !important;
}

/* ==============================================
   ã‚¿ãƒ–å½¢å¼ã®ã‚¤ãƒ™ãƒ³ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event .event-tab-container {
  height: 100% !important;
  display: flex !important;
  flex-direction: column !important;
  width: 100% !important;
}

.fc-timegrid-event .event-tab {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 600 !important;
  text-align: center !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  transition: all 0.2s ease !important;
  border: none !important;
}

.fc-timegrid-event .event-tab.course {
  background: inherit !important;
  color: inherit !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
}

.fc-timegrid-event .event-tab.interval {
        color: white !important;
        font-weight: 500 !important;
}

.fc-timegrid-event .event-tab.interval.individual {
  background-color: #fd7e14 !important;
  font-weight: 600 !important;
}

.fc-timegrid-event .event-tab.interval.system {
  background-color: #6c757d !important;
}

/* ==============================================
   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®è‰²åˆ†ã‘
   ============================================== */
.fc-timegrid-event.confirmed {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
  border: 2px solid #28a745 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3) !important;
}

.fc-timegrid-event.tentative {
  background: linear-gradient(135deg, #ffc107 0%, #ffb84d 100%) !important;
        border: 2px solid #ffc107 !important;
        color: #212529 !important;
  box-shadow: 0 4px 16px rgba(255, 193, 7, 0.3) !important;
}

.fc-timegrid-event.cancelled {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
  border: 2px solid #dc3545 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3) !important;
}

.fc-timegrid-event.completed {
  background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%) !important;
  border: 2px solid #6f42c1 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(111, 66, 193, 0.3) !important;
}

.fc-timegrid-event.no_show {
  background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
  border: 2px solid #6c757d !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(108, 117, 125, 0.3) !important;
}

.fc-timegrid-event.break {
  background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
  border: 2px solid #17a2b8 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(23, 162, 184, 0.3) !important;
}

/* ==============================================
   ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒ—åˆ¥ã®è¦–è¦šçš„åŒºåˆ¥
   ============================================== */
.fc-timegrid-event.has-interval .event-tab.interval.individual::before {
  content: "âš™ï¸ ";
  font-size: 0.6em;
  margin-right: 2px;
}

.fc-timegrid-event.has-interval .event-tab.interval.system::before {
  content: "ğŸ”§ ";
  font-size: 0.6em;
  margin-right: 2px;
}

/* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±è¡¨ç¤º */
.fc-timegrid-event.has-interval:hover::after {
  content: attr(data-interval-info);
  position: absolute;
  top: -30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  white-space: nowrap;
  z-index: 10000;
  pointer-events: none;
}

/* ==============================================
   ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
   ============================================== */
@media (max-width: 1024px) {
  .calendar-toolbar {
    gap: 20px;
    padding: 0 20px;
  }
  
  .calendar-title {
    font-size: 1.8rem;
  }
  
  .fc {
    margin: 0px auto;
    border-radius: 16px;
  }
  
  .fc-toolbar {
    padding: 8px 0;
    width: 100%;
    max-width: 100%;
  }
  
  .fc-toolbar-title {
    font-size: 1.6rem;
  }
}

@media (max-width: 768px) {
  .calendar-toolbar {
    flex-direction: column;
    gap: 12px;
    padding: 0 20px;
  }
  
  .calendar-nav {
    order: 1;
    margin: 0;
  }
  
  .calendar-title {
    order: 2;
    font-size: 1.6rem;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }
  
  .calendar-actions {
    order: 3;
    flex-direction: row;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 8px 12px;
    font-size: 0.85rem;
    min-width: 100px;
    flex: 1;
  }

  /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¹ãƒ­ãƒƒãƒˆé«˜ã• (35px base) */
  .fc-timegrid-slot {
    height: 35px !important;
    min-height: 35px !important;
    max-height: 35px !important;
  }
  
  .fc-timegrid-axis-frame {
    height: 35px !important;
    min-height: 35px !important;
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®é«˜ã•èª¿æ•´ */
  .fc-timegrid-event[data-duration="40"] { height: 140px !important; min-height: 140px !important; }
  .fc-timegrid-event[data-duration="45"] { height: 157px !important; min-height: 157px !important; }
  .fc-timegrid-event[data-duration="50"] { height: 175px !important; min-height: 175px !important; }
  .fc-timegrid-event[data-duration="55"] { height: 192px !important; min-height: 192px !important; }
  .fc-timegrid-event[data-duration="60"] { height: 210px !important; min-height: 210px !important; }
  .fc-timegrid-event[data-duration="65"] { height: 227px !important; min-height: 227px !important; }
  .fc-timegrid-event[data-duration="70"] { height: 245px !important; min-height: 245px !important; }
  .fc-timegrid-event[data-duration="75"] { height: 262px !important; min-height: 262px !important; }
  .fc-timegrid-event[data-duration="80"] { height: 280px !important; min-height: 280px !important; }
  .fc-timegrid-event[data-duration="85"] { height: 297px !important; min-height: 297px !important; }
  .fc-timegrid-event[data-duration="90"] { height: 315px !important; min-height: 315px !important; }
  .fc-timegrid-event[data-duration="95"] { height: 332px !important; min-height: 332px !important; }
  .fc-timegrid-event[data-duration="100"] { height: 350px !important; min-height: 350px !important; }
  
  .fc-timegrid-event .event-tab {
    font-size: 0.7rem !important;
    padding: 1px 2px !important;
  }
  
  .fc {
    margin: 15px auto;
    border-radius: 12px;
  }
  
  .fc-toolbar {
    padding: 8px 0;
    width: 100%;
    max-width: 100%;
  }
  
  .fc-toolbar-title {
    font-size: 1.4rem;
  }


}

@media (max-width: 480px) {
  .calendar-toolbar {
    gap: 8px;
    padding: 0 15px;
  }
  
  .calendar-title {
    font-size: 1.4rem;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }
  
  .calendar-actions {
    flex-direction: column;
    gap: 6px;
  }
  
  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 6px 10px;
    font-size: 0.8rem;
    min-width: 80px;
  }
  
  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 8px 12px;
    font-size: 0.8rem;
  }
  
  /* å°ç”»é¢ç”¨ã®ã‚¹ãƒ­ãƒƒãƒˆé«˜ã• (30px base) */
  .fc-timegrid-slot {
    height: 30px !important;
    min-height: 30px !important;
    max-height: 30px !important;
  }
  
  .fc-timegrid-axis-frame {
    height: 30px !important;
    min-height: 30px !important;
  }
  
  /* å°ç”»é¢ç”¨ã®é«˜ã•èª¿æ•´ */
  .fc-timegrid-event[data-duration="40"] { height: 120px !important; min-height: 120px !important; }
  .fc-timegrid-event[data-duration="45"] { height: 135px !important; min-height: 135px !important; }
  .fc-timegrid-event[data-duration="50"] { height: 150px !important; min-height: 150px !important; }
  .fc-timegrid-event[data-duration="55"] { height: 165px !important; min-height: 165px !important; }
  .fc-timegrid-event[data-duration="60"] { height: 180px !important; min-height: 180px !important; }
  .fc-timegrid-event[data-duration="65"] { height: 195px !important; min-height: 195px !important; }
  .fc-timegrid-event[data-duration="70"] { height: 210px !important; min-height: 210px !important; }
  .fc-timegrid-event[data-duration="75"] { height: 225px !important; min-height: 225px !important; }
  .fc-timegrid-event[data-duration="80"] { height: 240px !important; min-height: 240px !important; }
  .fc-timegrid-event[data-duration="85"] { height: 255px !important; min-height: 255px !important; }
  .fc-timegrid-event[data-duration="90"] { height: 270px !important; min-height: 270px !important; }
  .fc-timegrid-event[data-duration="95"] { height: 285px !important; min-height: 285px !important; }
  .fc-timegrid-event[data-duration="100"] { height: 300px !important; min-height: 300px !important; }
  
  .fc-timegrid-event .event-tab {
    font-size: 0.65rem !important;
    padding: 1px !important;
  }

  .fc {
    margin: 10px auto;
    border-radius: 10px;
  }
  
  .fc-toolbar {
    padding: 12px 15px;
  }
  
  .fc-toolbar-title {
    font-size: 1.2rem;
  }


}

/* ==============================================
   å‹•çš„é«˜ã•è¨­å®šã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
   ============================================== */
.height-calculated {
  transition: height 0.3s ease !important;
}

/* ==============================================
   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¨ä½“ã®ã‚°ãƒªãƒƒãƒ‰å¼·åŒ–
   ============================================== */
.fc-timegrid-col-frame {
  border-right: 1px solid #e2e8f0 !important;
}

/* ==============================================
   å–¶æ¥­æ™‚é–“å¤–ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-slot[data-time^="08:"]:before,
.fc-timegrid-slot[data-time^="09:"]:before,
.fc-timegrid-slot[data-time^="21:"]:before,
.fc-timegrid-slot[data-time^="22:"]:before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, 
    transparent 30%, 
    rgba(108, 117, 125, 0.3) 35%, 
    rgba(108, 117, 125, 0.3) 40%, 
    transparent 45%
  );
  pointer-events: none;
}

/* å–¶æ¥­æ™‚é–“å¤–ã®ã‚¹ãƒ­ãƒƒãƒˆèƒŒæ™¯è‰² */
.fc-timegrid-slot[data-time^="08:"],
.fc-timegrid-slot[data-time^="09:"],
.fc-timegrid-slot[data-time^="21:"],
.fc-timegrid-slot[data-time^="22:"] {
  background-color: #6c757d !important;
  opacity: 0.3;
  position: relative;
}

/* å–¶æ¥­æ™‚é–“å†…ã®ã‚¹ãƒ­ãƒƒãƒˆèƒŒæ™¯è‰²ï¼ˆæ˜ã‚‹ãï¼‰ */
.fc-timegrid-slot[data-time^="10:"],
.fc-timegrid-slot[data-time^="11:"],
.fc-timegrid-slot[data-time^="12:"],
.fc-timegrid-slot[data-time^="13:"],
.fc-timegrid-slot[data-time^="14:"],
.fc-timegrid-slot[data-time^="15:"],
.fc-timegrid-slot[data-time^="16:"],
.fc-timegrid-slot[data-time^="17:"],
.fc-timegrid-slot[data-time^="18:"],
.fc-timegrid-slot[data-time^="19:"],
.fc-timegrid-slot[data-time^="20:"] {
  background-color: #f8f9fa !important;
  position: relative;
}

/* å–¶æ¥­æ™‚é–“å¤–ã®æ™‚é–“è»¸ãƒ©ãƒ™ãƒ«ã‚’è–„ã */
.fc-timegrid-axis[data-time^="08:"],
.fc-timegrid-axis[data-time^="09:"],
.fc-timegrid-axis[data-time^="21:"],
.fc-timegrid-axis[data-time^="22:"] {
  background-color: #6c757d !important;
  color: #ffffff !important;
  font-style: italic;
  font-weight: normal;
  opacity: 0.7;
}

/* é€šå¸¸å–¶æ¥­æ™‚é–“ã®ãƒ©ãƒ™ãƒ«ã‚’å¼·èª¿ */
.fc-timegrid-axis[data-time^="10:"],
.fc-timegrid-axis[data-time^="11:"],
.fc-timegrid-axis[data-time^="12:"],
.fc-timegrid-axis[data-time^="13:"],
.fc-timegrid-axis[data-time^="14:"],
.fc-timegrid-axis[data-time^="15:"],
.fc-timegrid-axis[data-time^="16:"],
.fc-timegrid-axis[data-time^="17:"],
.fc-timegrid-axis[data-time^="18:"],
.fc-timegrid-axis[data-time^="19:"],
.fc-timegrid-axis[data-time^="20:"] {
  background-color: #fff !important;
  color: #212529 !important;
  font-weight: 600;
}

/* å–¶æ¥­é–‹å§‹æ™‚é–“ï¼ˆ10:00ï¼‰ã®å¢ƒç•Œç·šã¨ãƒ©ãƒ™ãƒ« */
.fc-timegrid-slot[data-time="10:00:00"] {
  border-top: 3px solid #28a745 !important;
  position: relative;
}

.fc-timegrid-slot[data-time="10:00:00"]::before {
  content: "å–¶æ¥­é–‹å§‹";
  position: absolute;
  left: 5px;
  top: -15px;
  background: #28a745;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: bold;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* å–¶æ¥­çµ‚äº†æ™‚é–“ï¼ˆ21:00ï¼‰ã®å¢ƒç•Œç·šã¨ãƒ©ãƒ™ãƒ« */
.fc-timegrid-slot[data-time="21:00:00"] {
  border-top: 3px solid #dc3545 !important;
  position: relative;
}

.fc-timegrid-slot[data-time="21:00:00"]::before {
  content: "å–¶æ¥­çµ‚äº†";
  position: absolute;
  left: 5px;
  top: -15px;
  background: #dc3545;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 11px;
  font-weight: bold;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

/* ã‚·ãƒ•ãƒˆå»¶é•·æ™‚é–“ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆä»Šå¾Œã®æ©Ÿèƒ½ç”¨ï¼‰ */
.shift-extended-early {
  background: linear-gradient(90deg, #e8f5e8 0%, #fff 30%) !important;
  border-left: 3px solid #28a745 !important;
}

.shift-extended-late {
  background: linear-gradient(90deg, #fff 70%, #e8f5e8 100%) !important;
  border-left: 3px solid #28a745 !important;
}

/* ãƒ›ãƒãƒ¼åŠ¹æœã®æ”¹å–„ */
.fc-timegrid-slot:hover {
  background-color: #e3f2fd !important;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

/* å–¶æ¥­æ™‚é–“å¤–ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
.fc-timegrid-slot[data-time^="08:"]:hover,
.fc-timegrid-slot[data-time^="09:"]:hover,
.fc-timegrid-slot[data-time^="21:"]:hover {
  background-color: #fff3cd !important;
}

/* æ™‚é–“è»¸å…¨ä½“ã®èª¿æ•´ */
.fc-timegrid-axis {
  font-size: 12px;
  border-right: 2px solid #dee2e6 !important;
  min-width: 80px;
}


/* ==============================================
   äºˆç´„ã‚¤ãƒ™ãƒ³ãƒˆã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event {
  border-radius: 8px !important;
  font-size: 0.8rem !important;
  font-weight: 600 !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
  transition: all 0.3s ease !important;
  border: 2px solid transparent !important;
  margin: 1px !important;
  overflow: hidden !important;
  position: relative !important;
  height: auto !important;
}

.fc-timegrid-event::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
  pointer-events: none;
  z-index: 1;
}

.fc-timegrid-event:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.25) !important;
  transform: translateX(2px) !important;
  z-index: 1000 !important;
}

/* ==============================================
   å…¨ã‚³ãƒ¼ã‚¹å¯¾å¿œã®é«˜ã•è¨­å®šï¼ˆ30px baseï¼‰
   ============================================== */

/* 40åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="40"] {
  min-height: 120px !important;
  height: 120px !important;
}

.fc-timegrid-event[data-duration="45"] {
  min-height: 135px !important;
  height: 135px !important;
}

.fc-timegrid-event[data-duration="50"] {
  min-height: 150px !important;
  height: 150px !important;
}

.fc-timegrid-event[data-duration="55"] {
  min-height: 165px !important;
  height: 165px !important;
}

/* 60åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="60"] {
  min-height: 180px !important;
  height: 180px !important;
}

.fc-timegrid-event[data-duration="65"] {
  min-height: 195px !important;
  height: 195px !important;
}

.fc-timegrid-event[data-duration="70"] {
  min-height: 210px !important;
  height: 210px !important;
}

.fc-timegrid-event[data-duration="75"] {
  min-height: 225px !important;
  height: 225px !important;
}

.fc-timegrid-event[data-duration="80"] {
  min-height: 240px !important;
  height: 240px !important;
}

/* 80åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="85"] {
  min-height: 340px !important;
  height: 340px !important;
}

.fc-timegrid-event[data-duration="90"] {
  min-height: 360px !important;
  height: 360px !important;
}

.fc-timegrid-event[data-duration="95"] {
  min-height: 380px !important;
  height: 380px !important;
}

.fc-timegrid-event[data-duration="100"] {
  min-height: 400px !important;
  height: 400px !important;
}

/* ãã®ä»–ã®ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“ */
.fc-timegrid-event[data-duration="105"] {
  min-height: 420px !important;
  height: 420px !important;
}

.fc-timegrid-event[data-duration="110"] {
  min-height: 440px !important;
  height: 440px !important;
}

.fc-timegrid-event[data-duration="120"] {
  min-height: 480px !important;
  height: 480px !important;
}

/* ==============================================
   ã‚¿ãƒ–å½¢å¼ã®ã‚¤ãƒ™ãƒ³ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event .event-tab-container {
  height: 100% !important;
  display: flex !important;
  flex-direction: column !important;
  width: 100% !important;
}

.fc-timegrid-event .event-tab {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 600 !important;
  text-align: center !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  transition: all 0.2s ease !important;
  border: none !important;
}

.fc-timegrid-event .event-tab.course {
  background: inherit !important;
  color: inherit !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
}

.fc-timegrid-event .event-tab.interval {
        color: white !important;
        font-weight: 500 !important;
}

.fc-timegrid-event .event-tab.interval.individual {
  background-color: #fd7e14 !important;
  font-weight: 600 !important;
}

.fc-timegrid-event .event-tab.interval.system {
  background-color: #6c757d !important;
}

/* ==============================================
   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®è‰²åˆ†ã‘
   ============================================== */
.fc-timegrid-event.confirmed {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
  border: 2px solid #28a745 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3) !important;
}

.fc-timegrid-event.tentative {
  background: linear-gradient(135deg, #ffc107 0%, #ffb84d 100%) !important;
        border: 2px solid #ffc107 !important;
        color: #212529 !important;
  box-shadow: 0 4px 16px rgba(255, 193, 7, 0.3) !important;
}

.fc-timegrid-event.cancelled {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
  border: 2px solid #dc3545 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3) !important;
}

.fc-timegrid-event.completed {
  background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%) !important;
  border: 2px solid #6f42c1 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(111, 66, 193, 0.3) !important;
}

.fc-timegrid-event.no_show {
  background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
  border: 2px solid #6c757d !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(108, 117, 125, 0.3) !important;
}

.fc-timegrid-event.break {
  background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
  border: 2px solid #17a2b8 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(23, 162, 184, 0.3) !important;
}

/* ==============================================
   ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒ—åˆ¥ã®è¦–è¦šçš„åŒºåˆ¥
   ============================================== */
.fc-timegrid-event.has-interval .event-tab.interval.individual::before {
  content: "âš™ï¸ ";
  font-size: 0.6em;
  margin-right: 2px;
}

.fc-timegrid-event.has-interval .event-tab.interval.system::before {
  content: "ğŸ”§ ";
  font-size: 0.6em;
  margin-right: 2px;
}

/* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±è¡¨ç¤º */
.fc-timegrid-event.has-interval:hover::after {
  content: attr(data-interval-info);
  position: absolute;
  top: -30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  white-space: nowrap;
  z-index: 10000;
  pointer-events: none;
}

/* ==============================================
   ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
   ============================================== */
@media (max-width: 1024px) {
  .calendar-toolbar {
    gap: 20px;
    padding: 0 20px;
  }
  
  .calendar-title {
    font-size: 1.8rem;
  }
  
  .fc {
    margin: 0px auto;
    border-radius: 16px;
  }
  
  .fc-toolbar {
    padding: 8px 0;
    width: 100%;
    max-width: 100%;
  }
  
  .fc-toolbar-title {
    font-size: 1.6rem;
  }
}

@media (max-width: 768px) {
  .calendar-toolbar {
    flex-direction: column;
    gap: 12px;
    padding: 0 20px;
  }
  
  .calendar-nav {
    order: 1;
    margin: 0;
  }
  
  .calendar-title {
    order: 2;
    font-size: 1.6rem;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }
  
  .calendar-actions {
    order: 3;
    flex-direction: row;
    gap: 8px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 8px 12px;
    font-size: 0.85rem;
    min-width: 100px;
    flex: 1;
  }

  /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¹ãƒ­ãƒƒãƒˆé«˜ã• (35px base) */
  .fc-timegrid-slot {
    height: 35px !important;
    min-height: 35px !important;
    max-height: 35px !important;
  }
  
  .fc-timegrid-axis-frame {
    height: 35px !important;
    min-height: 35px !important;
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®é«˜ã•èª¿æ•´ */
  .fc-timegrid-event[data-duration="40"] { height: 140px !important; min-height: 140px !important; }
  .fc-timegrid-event[data-duration="45"] { height: 157px !important; min-height: 157px !important; }
  .fc-timegrid-event[data-duration="50"] { height: 175px !important; min-height: 175px !important; }
  .fc-timegrid-event[data-duration="55"] { height: 192px !important; min-height: 192px !important; }
  .fc-timegrid-event[data-duration="60"] { height: 210px !important; min-height: 210px !important; }
  .fc-timegrid-event[data-duration="65"] { height: 227px !important; min-height: 227px !important; }
  .fc-timegrid-event[data-duration="70"] { height: 245px !important; min-height: 245px !important; }
  .fc-timegrid-event[data-duration="75"] { height: 262px !important; min-height: 262px !important; }
  .fc-timegrid-event[data-duration="80"] { height: 280px !important; min-height: 280px !important; }
  .fc-timegrid-event[data-duration="85"] { height: 297px !important; min-height: 297px !important; }
  .fc-timegrid-event[data-duration="90"] { height: 315px !important; min-height: 315px !important; }
  .fc-timegrid-event[data-duration="95"] { height: 332px !important; min-height: 332px !important; }
  .fc-timegrid-event[data-duration="100"] { height: 350px !important; min-height: 350px !important; }
  
  .fc-timegrid-event .event-tab {
    font-size: 0.7rem !important;
    padding: 1px 2px !important;
  }
  
  .fc {
    margin: 15px auto;
    border-radius: 12px;
  }
  
  .fc-toolbar {
    padding: 8px 0;
    width: 100%;
    max-width: 100%;
  }
  
  .fc-toolbar-title {
    font-size: 1.4rem;
  }


}

@media (max-width: 480px) {
  .calendar-toolbar {
    gap: 8px;
    padding: 0 15px;
  }
  
  .calendar-title {
    font-size: 1.4rem;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
  }
  
  .calendar-actions {
    flex-direction: column;
    gap: 6px;
  }
  
  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 6px 10px;
    font-size: 0.8rem;
    min-width: 80px;
  }
  
  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 8px 12px;
    font-size: 0.8rem;
  }
  
  /* å°ç”»é¢ç”¨ã®ã‚¹ãƒ­ãƒƒãƒˆé«˜ã• (30px base) */
  .fc-timegrid-slot {
    height: 30px !important;
    min-height: 30px !important;
    max-height: 30px !important;
  }
  
  .fc-timegrid-axis-frame {
    height: 30px !important;
    min-height: 30px !important;
  }
  
  /* å°ç”»é¢ç”¨ã®é«˜ã•èª¿æ•´ */
  .fc-timegrid-event[data-duration="40"] { height: 120px !important; min-height: 120px !important; }
  .fc-timegrid-event[data-duration="45"] { height: 135px !important; min-height: 135px !important; }
  .fc-timegrid-event[data-duration="50"] { height: 150px !important; min-height: 150px !important; }
  .fc-timegrid-event[data-duration="55"] { height: 165px !important; min-height: 165px !important; }
  .fc-timegrid-event[data-duration="60"] { height: 180px !important; min-height: 180px !important; }
  .fc-timegrid-event[data-duration="65"] { height: 195px !important; min-height: 195px !important; }
  .fc-timegrid-event[data-duration="70"] { height: 210px !important; min-height: 210px !important; }
  .fc-timegrid-event[data-duration="75"] { height: 225px !important; min-height: 225px !important; }
  .fc-timegrid-event[data-duration="80"] { height: 240px !important; min-height: 240px !important; }
  .fc-timegrid-event[data-duration="85"] { height: 255px !important; min-height: 255px !important; }
  .fc-timegrid-event[data-duration="90"] { height: 270px !important; min-height: 270px !important; }
  .fc-timegrid-event[data-duration="95"] { height: 285px !important; min-height: 285px !important; }
  .fc-timegrid-event[data-duration="100"] { height: 300px !important; min-height: 300px !important; }
  
  .fc-timegrid-event .event-tab {
    font-size: 0.65rem !important;
    padding: 1px !important;
  }

  .fc {
    margin: 10px auto;
    border-radius: 10px;
  }
  
  .fc-toolbar {
    padding: 12px 15px;
  }
  
  .fc-toolbar-title {
    font-size: 1.2rem;
  }


}

/* ==============================================
   å‹•çš„é«˜ã•è¨­å®šã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
   ============================================== */
.height-calculated {
  transition: height 0.3s ease !important;
}

/* ==============================================
   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¨ä½“ã®ã‚°ãƒªãƒƒãƒ‰å¼·åŒ–
   ============================================== */
.fc-timegrid-col-frame {
  border-right: 1px solid #e2e8f0 !important;
}

/* ==============================================
   ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
   ============================================== */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.calendar-container {
  animation: fadeInUp 0.6s ease-out;
}

.fc {
  animation: slideInUp 0.8s ease-out;
}

/* ==============================================
   ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦å‰Šé™¤ï¼‰
   ============================================== */
.debug-events .fc-timegrid-event {
  border: 2px dashed red !important;
}

.debug-events .fc-timegrid-event .event-tab.course {
  border: 1px solid blue !important;
  background-color: rgba(0, 0, 255, 0.1) !important;
}

.debug-events .fc-timegrid-event .event-tab.interval {
  border: 1px solid green !important;
}

/* ==============================================
   ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£
   ============================================== */
@media (prefers-contrast: high) {
  .fc-timegrid-event {
    border-width: 3px !important;
  }
  
  .fc-button {
    border: 2px solid currentColor !important;
  }
}

@media (prefers-color-scheme: dark) {
  .fc {
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%) !important;
    border-color: #4a5568 !important;
  }
  
  .fc-toolbar {
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%) !important;
    border-bottom-color: #4a5568 !important;
  }
  
  .fc-toolbar-title {
    color: #e2e8f0 !important;
  }
}

/* ==============================================
   ç‰¹æ®Šãªã‚³ãƒ¼ã‚¹æ™‚é–“å¯¾å¿œï¼ˆè¿½åŠ ã®çµ„ã¿åˆã‚ã›ï¼‰
   ============================================== */

/* 25åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="25"] {
  min-height: 100px !important;
  height: 100px !important;
}

.fc-timegrid-event[data-duration="30"] {
  min-height: 120px !important;
  height: 120px !important;
}

.fc-timegrid-event[data-duration="35"] {
  min-height: 140px !important;
  height: 140px !important;
}

/* 115åˆ†ä»¥ä¸Šã®é•·æ™‚é–“ã‚³ãƒ¼ã‚¹ */
.fc-timegrid-event[data-duration="115"] {
  min-height: 460px !important;
  height: 460px !important;
}

.fc-timegrid-event[data-duration="125"] {
  min-height: 500px !important;
  height: 500px !important;
}

.fc-timegrid-event[data-duration="130"] {
  min-height: 520px !important;
  height: 520px !important;
}

.fc-timegrid-event[data-duration="135"] {
  min-height: 540px !important;
  height: 540px !important;
}

.fc-timegrid-event[data-duration="140"] {
  min-height: 560px !important;
  height: 560px !important;
}

.fc-timegrid-event[data-duration="150"] {
  min-height: 600px !important;
  height: 600px !important;
}

/* ==============================================
   ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event:focus {
  outline: 3px solid #007bff;
  outline-offset: 2px;
  z-index: 1001;
}

.fc-timegrid-event:focus-visible {
  outline: 3px solid #007bff;
  outline-offset: 2px;
}

/* ==============================================
   å°åˆ·æ™‚ã®æœ€é©åŒ–
   ============================================== */
@media print {
  .fc {
    box-shadow: none !important;
    border: 1px solid #000 !important;
  }
  
  .fc-timegrid-event {
    box-shadow: none !important;
    border: 1px solid #000 !important;
  }
  
  .fc-button {
    display: none !important;
  }
  
  .calendar-nav,
  .calendar-actions {
    display: none !important;
  }
}

/* ==============================================
   ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
   ============================================== */
.fc-timegrid-event {
  will-change: transform, opacity;
}

.fc-timegrid-event:hover {
  will-change: transform, box-shadow;
}

/* GPUåŠ é€Ÿã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
.fc-timegrid-event,
.fc-button {
  transform: translateZ(0);
  backface-visibility: hidden;
}

/* ==============================================
   ã‚³ãƒ¼ã‚¹åˆ¥ã®è­˜åˆ¥ç”¨ã‚«ãƒ©ãƒ¼ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   ============================================== */

/* 40åˆ†ã‚³ãƒ¼ã‚¹ç³»ã®ã‚µãƒ–ãƒˆãƒ«èƒŒæ™¯èª¿æ•´ */
.fc-timegrid-event[data-duration="40"],
.fc-timegrid-event[data-duration="45"],
.fc-timegrid-event[data-duration="50"],
.fc-timegrid-event[data-duration="55"] {
  position: relative;
}

.fc-timegrid-event[data-duration="40"]::after,
.fc-timegrid-event[data-duration="45"]::after,
.fc-timegrid-event[data-duration="50"]::after,
.fc-timegrid-event[data-duration="55"]::after {
  content: '40';
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(0, 0, 0, 0.1);
  color: rgba(255, 255, 255, 0.7);
  border-radius: 50%;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  font-weight: bold;
  pointer-events: none;
}

/* 60åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="60"]::after,
.fc-timegrid-event[data-duration="65"]::after,
.fc-timegrid-event[data-duration="70"]::after,
.fc-timegrid-event[data-duration="75"]::after,
.fc-timegrid-event[data-duration="80"]::after {
  content: '60';
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(0, 0, 0, 0.1);
  color: rgba(255, 255, 255, 0.7);
  border-radius: 50%;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  font-weight: bold;
  pointer-events: none;
}

/* 80åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="85"]::after,
.fc-timegrid-event[data-duration="90"]::after,
.fc-timegrid-event[data-duration="95"]::after,
.fc-timegrid-event[data-duration="100"]::after {
  content: '80';
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(0, 0, 0, 0.1);
  color: rgba(255, 255, 255, 0.7);
  border-radius: 50%;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  font-weight: bold;
  pointer-events: none;
}

/* ==============================================
   ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
   ============================================== */
.fc-timegrid::-webkit-scrollbar {
  width: 8px;
}

.fc-timegrid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.fc-timegrid::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  border-radius: 4px;
}

.fc-timegrid::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
}

/* ==============================================
   èª­ã¿è¾¼ã¿çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.calendar-loading {
  position: relative;
}

.calendar-loading::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(2px);
  z-index: 9999;
}

.calendar-loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 40px;
  height: 40px;
  margin: -20px 0 0 -20px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  z-index: 10000;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ==============================================
   ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.calendar-error {
  padding: 20px;
  text-align: center;
  color: #dc3545;
  background: #fff5f5;
  border: 1px solid #fecaca;
  border-radius: 8px;
  margin: 20px;
}

.calendar-error::before {
  content: 'âš ï¸';
  display: block;
  font-size: 2rem;
  margin-bottom: 10px;
}

/* ==============================================
   ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ«å¼·åŒ–
   ============================================== */
.fc-timegrid-event[data-interval-info]:hover::after {
  animation: tooltipFadeIn 0.3s ease-out;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

@keyframes tooltipFadeIn {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(5px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

/* ==============================================
   ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event.fc-event-selected {
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3) !important;
  z-index: 1002 !important;
}

/* ==============================================
   ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event.fc-event-dragging {
  opacity: 0.7 !important;
  transform: rotate(3deg) !important;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
  z-index: 1003 !important;
}

.fc-timegrid-event.fc-event-resizing {
  opacity: 0.8 !important;
  box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4) !important;
}

/* ==============================================
   æœ€çµ‚èª¿æ•´ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
   ============================================== */

/* é‡è¤‡ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã®çµ±åˆ */
.fc-timegrid-event.reservation-with-tabs,
.fc-timegrid-event.reservation-with-tabs .fc-event-main,
.fc-timegrid-event.reservation-with-tabs .event-tabs,
.fc-timegrid-event.reservation-with-tabs .event-tab {
  /* æ—¢å­˜ã®ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ«ã¨çµ±åˆæ¸ˆã¿ */
}

/* ä¸è¦ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã®å‰Šé™¤ */
.fc-timegrid-event {
  /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ—¢ã«å®šç¾©æ¸ˆã¿ */
}

/* ==============================================
   1æ™‚é–“ã®ç·šã®ã¿ã‚’å¤ªãã™ã‚‹è¨­å®šï¼ˆ10åˆ†ãšã‚‰ã—ä¿®æ­£ç‰ˆï¼‰
   ============================================== */

/* ã¾ãšå…¨ã¦ã®ç·šã‚’ç´°ããƒªã‚»ãƒƒãƒˆ */
.fc-timegrid-slot {
  border-bottom: 3px solid #e2e8f0 !important; /* åŸºæœ¬ã¯ç´°ã„ç·š */
}

/* ã‚¤ãƒ™ãƒ³ãƒˆã®é«˜ã•ã‚’æ­£ç¢ºã«è¨­å®š */
.fc-timegrid-event {
  height: auto !important;
  min-height: auto !important;
}

.fc-timegrid-event[data-duration] {
  height: calc(var(--duration) * 3px) !important;
  min-height: calc(var(--duration) * 3px) !important;
  max-height: calc(var(--duration) * 3px) !important;
}

/* ç‰¹å®šã®æ™‚é–“ã®ã‚¤ãƒ™ãƒ³ãƒˆé«˜ã•ã‚’ç›´æ¥æŒ‡å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰ */
.fc-timegrid-event[data-duration="75"] {
  height: 225px !important;
  min-height: 225px !important;
  max-height: 225px !important;
}

.fc-timegrid-event[data-duration="80"] {
  height: 240px !important;
  min-height: 240px !important;
  max-height: 240px !important;
}

.fc-timegrid-event[data-duration="90"] {
  height: 270px !important;
  min-height: 270px !important;
  max-height: 270px !important;
}

/* ã‚¹ãƒ­ãƒƒãƒˆã®é«˜ã•ã‚’å¼·åˆ¶çš„ã«30pxã«è¨­å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰ */
.fc-timegrid-slot {
  height: 30px !important;
  min-height: 30px !important;
  max-height: 30px !important;
}

/* æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¹ã‚¿ã‚¤ãƒ« */
.fc-col-header-cell {
  cursor: pointer !important;
  transition: background-color 0.2s ease;
}

.fc-col-header-cell:hover {
  background-color: #f8f9fa !important;
}

.fc-col-header-cell:active {
  background-color: #e9ecef !important;
}

.fc-day-header {
  cursor: pointer !important;
  transition: background-color 0.2s ease;
  user-select: none !important;
}

.fc-day-header:hover {
  background-color: #f8f9fa !important;
}

.fc-day-header:active {
  background-color: #e9ecef !important;
}



/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®èª¿æ•´ */
.calendar-header {
  background-color: #ffffff !important;
  border-bottom: 1px solid #e9ecef !important;
  padding: 20px 0 !important;
  margin-bottom: 20px !important;
}

.calendar-toolbar {
  margin-bottom: 20px;
}

.calendar-header-content {
  display: flex !important;
  justify-content: space-between !important;
  align-items: center !important;
  gap: 20px !important;
  flex-wrap: wrap !important;
  padding: 20px 0 !important;
  width: 100% !important;
}

.calendar-title-section {
  flex: 0 0 auto !important;
  min-width: 200px !important;
  text-align: left !important;
}

.calendar-title {
  font-size: 1.8rem !important;
  font-weight: 700 !important;
  color: #2c3e50 !important;
  margin: 0 !important;
  padding: 0 !important;
  white-space: nowrap !important;
  text-align: left !important;
  display: block !important;
  width: auto !important;
  float: none !important;
  position: static !important;
}

/* h1ã‚¿ã‚°ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ */
.calendar-title h1 {
  margin: 0 !important;
  padding: 0 !important;
  text-align: left !important;
  display: block !important;
  width: auto !important;
  float: none !important;
  position: static !important;
}





/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
@media (max-width: 768px) {
  .calendar-header-content {
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding: 15px 0;
  }
  
  .calendar-title-section {
    min-width: auto;
    text-align: center;
    padding-left: 0 !important;
  }
  
  .calendar-title {
    text-align: center;
    font-size: 1.5rem;
    white-space: normal;
  }
  
  .calendar-actions {
    min-width: auto;
    justify-content: center;
  }
  
  .calendar-mini-calendar {
    padding: 10px;
    margin: 0;
  }
  
}

</style>
<script>
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
  function showMessage(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‰Šé™¤
    const existingAlerts = document.querySelectorAll('.alert.position-fixed');
    existingAlerts.forEach(alert => alert.remove());
    
    // ãƒšãƒ¼ã‚¸ã«è¿½åŠ 
    document.body.appendChild(alertDiv);
    
    // 3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 3000);
  }

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOM Content Loaded');
    
    // äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    const calendarEl = document.getElementById('calendar');
    console.log('ğŸ“… Calendar element:', calendarEl);
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–ã‚’è©¦è¡Œ
    function initializeCalendarWithRetry() {
      console.log('ğŸ”§ Attempting to initialize calendar...');
      
      // FullCalendarãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
      if (typeof FullCalendar === 'undefined' && typeof window.FullCalendar === 'undefined') {
        console.log('â³ FullCalendar not ready, retrying in 500ms...');
        setTimeout(initializeCalendarWithRetry, 500);
        return;
      }
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
      if (typeof initializeCalendar === 'function') {
        console.log('âœ… initializeCalendar function found, calling...');
        initializeCalendar();
        
        // åˆæœŸåŒ–å¾Œã«ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚’å¼·åˆ¶é©ç”¨
        setTimeout(() => {
          if (window.applyGridLines) {
            window.applyGridLines();
          }
        }, 1000);
        
        // ã•ã‚‰ã«ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ã«ã€è¤‡æ•°å›ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚’é©ç”¨
        setTimeout(() => {
          if (window.applyGridLines) {
            window.applyGridLines();
          }
        }, 2000);
        
        setTimeout(() => {
          if (window.applyGridLines) {
            window.applyGridLines();
          }
        }, 3000);
      } else {
        // ä»£æ›¿æ‰‹æ®µï¼šç›´æ¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
        console.log('ğŸ”„ initializeCalendar function not found, trying direct initialization...');
        
        const calendarEl = document.getElementById('calendar');
        if (calendarEl && typeof FullCalendar !== 'undefined') {
          console.log('âœ… Direct calendar initialization...');
          
          try {
            // åŸºæœ¬çš„ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®š
            const calendar = new FullCalendar.Calendar(calendarEl, {
              initialView: 'timeGridWeek',
              headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
              },
              locale: 'ja',
              height: 'auto',
              editable: true,
              selectable: true,
              selectMirror: true,
              dayMaxEvents: true,
              weekends: true,
              businessHours: {
                daysOfWeek: [1, 2, 3, 4, 5, 6],
                startTime: '10:00',
                endTime: '21:00'
              },
              slotMinTime: '08:00:00',
              slotMaxTime: '22:00:00',
              slotDuration: '00:10:00',
              nowIndicator: true,
              events: {
                url: '/admin/reservations.json',
                failure: function(error) {
                  console.error('âŒ Error loading events:', error);
                }
              }
            });
            
            calendar.render();
            window.pageCalendar = calendar;
            console.log('âœ… Direct calendar initialization successful');
            
            // åˆæœŸåŒ–å¾Œã«ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚’å¼·åˆ¶é©ç”¨
            setTimeout(() => {
              if (window.applyGridLines) {
                window.applyGridLines();
              }
            }, 1000);
            
          } catch (error) {
            console.error('âŒ Direct calendar initialization failed:', error);
            setTimeout(initializeCalendarWithRetry, 500);
          }
        } else {
          console.log('â³ Calendar element or FullCalendar not ready, retrying in 500ms...');
          setTimeout(initializeCalendarWithRetry, 500);
        }
      }
    }
    
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–ã‚’é–‹å§‹
    initializeCalendarWithRetry();
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã¨å±¥æ­´ã‚’å–å¾—ãƒ»è¡¨ç¤º
    function loadCancellationStats() {
      console.log('ğŸ“Š Loading cancellation stats...');
      
      fetch('/admin/reservations/cancellation_stats')
        .then(response => {
          console.log('ğŸ“Š Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
      return response.json();
    })
    .then(data => {
          console.log('ğŸ“Š Received data:', data);
          
          // è¦ç´ ã®å­˜åœ¨ç¢ºèªã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          const cancelledCount = document.getElementById('cancelledCount');
          const cancelledRate = document.getElementById('cancelledRate');
          const historyContainer = document.getElementById('cancelledHistory');
          
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ•°ã‚’æ›´æ–°ï¼ˆè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          if (cancelledCount) {
            cancelledCount.textContent = data.cancelled_count;
          }
          if (cancelledRate) {
            cancelledRate.textContent = data.cancelled_rate + '%';
          }
          
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ã‚’æ›´æ–°ï¼ˆè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          if (historyContainer) {
            if (data.cancelled_history && data.cancelled_history.length > 0) {
              console.log('ğŸ“Š Rendering history:', data.cancelled_history.length, 'items');
              const historyHtml = data.cancelled_history.map(item => `
                <div class="border-bottom pb-2 mb-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-bold text-dark">${item.customer_name}</div>
                      <div class="small text-muted">
                        <i class="fas fa-calendar me-1"></i>${item.cancelled_at}
                        <span class="mx-2">|</span>
                        <i class="fas fa-clock me-1"></i>${item.course}
                      </div>
                    </div>
                  </div>
                  <div class="mt-1">
                    <small class="text-danger">
                      <i class="fas fa-times-circle me-1"></i>
                      ${item.reason || 'ç†ç”±æœªå…¥åŠ›'}
                    </small>
                  </div>
                </div>
              `).join('');
              historyContainer.innerHTML = historyHtml;
      } else {
              console.log('ğŸ“Š No cancellation history found');
              historyContainer.innerHTML = `
                <div class="text-muted text-center py-3">
                  <i class="fas fa-info-circle me-1"></i>
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
        </div>
      `;
    }
          } else {
            console.log('ğŸ“Š Cancellation history container not found, skipping update');
      }
    })
    .catch(error => {
          console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã®å–å¾—ã«å¤±æ•—:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
          const cancelledCount = document.getElementById('cancelledCount');
          const cancelledRate = document.getElementById('cancelledRate');
          const cancelledHistory = document.getElementById('cancelledHistory');
          
          if (cancelledCount) cancelledCount.textContent = '0';
          if (cancelledRate) cancelledRate.textContent = '0%';
          if (cancelledHistory) {
            cancelledHistory.innerHTML = `
              <div class="text-muted text-center">
                <i class="fas fa-exclamation-triangle me-1"></i>
                çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
              </div>
            `;
          }
        });
    }

    const monthCalendarEl = document.getElementById('monthCalendarContent');
    if (!monthCalendarEl || !calendarEl) {
      console.error('âŒ Calendar elements not found');
      return;
    }
    
    // å¹´ã¨æœˆã®è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateMonthYearDisplay() {
      const currentDate = monthCalendar.getDate();
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth() + 1;
      const monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', 
                         '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
      
      const monthYearElement = document.getElementById('currentMonthYear');
      if (monthYearElement) {
        monthYearElement.textContent = `${year}å¹´ ${monthNames[month - 1]}`;
      }
    }

    // å¹´ã¨æœˆã®é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
    function openMonthYearModal() {
      const currentDate = monthCalendar.getDate();
      const yearSelect = document.getElementById('yearSelect');
      const monthSelect = document.getElementById('monthSelect');
      
      // å¹´ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆï¼ˆç¾åœ¨ã®å¹´ã®å‰å¾Œ5å¹´ï¼‰
      const currentYear = currentDate.getFullYear();
      yearSelect.innerHTML = '';
      for (let year = currentYear - 5; year <= currentYear + 5; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = `${year}å¹´`;
        if (year === currentYear) {
          option.selected = true;
        }
        yearSelect.appendChild(option);
      }
      
      // æœˆã‚’è¨­å®š
      monthSelect.value = currentDate.getMonth() + 1;
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      const modalElement = document.getElementById('monthYearModal');
      const modal = new bootstrap.Modal(modalElement, {
        backdrop: 'static',
        keyboard: true,
        focus: true
      });
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ä¿å­˜
      const previousFocus = document.activeElement;
      
      modal.show();
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¹´é¸æŠã«è¨­å®š
      setTimeout(() => {
        if (yearSelect) {
          yearSelect.focus();
        }
      }, 200);
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸæ™‚ã®å‡¦ç†
      modalElement.addEventListener('hidden.bs.modal', function() {
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å…ƒã®è¦ç´ ã«æˆ»ã™
        if (previousFocus && previousFocus.focus) {
          setTimeout(() => {
            previousFocus.focus();
          }, 100);
        }
      }, { once: true });
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚Œã‚‹å‰ã®å‡¦ç†
      modalElement.addEventListener('hide.bs.modal', function() {
        // ã™ã¹ã¦ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯èƒ½ãªè¦ç´ ã‹ã‚‰ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã™
        const focusableElements = modalElement.querySelectorAll('button, select, input, textarea, [tabindex]:not([tabindex="-1"])');
        focusableElements.forEach(element => {
          element.blur();
        });
      });
    }

    // ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    const monthCalendar = new FullCalendar.Calendar(monthCalendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        height: 'auto',
        headerToolbar: false,
        dayHeaderFormat: { weekday: 'short' },
        fixedWeekCount: false,
        showNonCurrentDates: true,
        dayMaxEvents: false,
        eventDisplay: 'none',
        dayCellContent: function(arg) {
            return arg.dayNumberText.replace(/[^\d]/g, '');
        },
        dayCellDidMount: function(info) {
            info.el.style.cursor = 'pointer';
            info.el.addEventListener('click', function() {
                calendar.gotoDate(info.date);
            });
        }
    });
    
    // ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    monthCalendar.render();
    
    // åˆæœŸã®å¹´ã¨æœˆã‚’è¡¨ç¤º
    updateMonthYearDisplay();
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    const currentMonthYear = document.getElementById('currentMonthYear');
    
    if (prevMonthBtn) {
      prevMonthBtn.addEventListener('click', function() {
        monthCalendar.prev();
        updateMonthYearDisplay();
      });
    }
    
    if (nextMonthBtn) {
      nextMonthBtn.addEventListener('click', function() {
        monthCalendar.next();
        updateMonthYearDisplay();
      });
    }
    
    // å¹´ã¨æœˆã®è¡¨ç¤ºéƒ¨åˆ†ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    if (currentMonthYear) {
      currentMonthYear.addEventListener('click', function() {
        openMonthYearModal();
      });
    }
    
    // é©ç”¨ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const applyMonthYearBtn = document.getElementById('applyMonthYear');
    if (applyMonthYearBtn) {
      applyMonthYearBtn.addEventListener('click', function() {
        const yearSelect = document.getElementById('yearSelect');
        const monthSelect = document.getElementById('monthSelect');
        
        if (yearSelect && monthSelect) {
          const selectedYear = parseInt(yearSelect.value);
          const selectedMonth = parseInt(monthSelect.value);
          
          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æŒ‡å®šã—ãŸå¹´ã¨æœˆã«ç§»å‹•
          monthCalendar.gotoDate(new Date(selectedYear, selectedMonth - 1, 1));
          updateMonthYearDisplay();
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          const modalElement = document.getElementById('monthYearModal');
          const modal = bootstrap.Modal.getInstance(modalElement);
          if (modal) {
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            applyMonthYearBtn.blur();
            modal.hide();
          }
        }
      });
    }
    
    // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    const closeMonthYearModalBtn = document.getElementById('closeMonthYearModal');
    if (closeMonthYearModalBtn) {
      closeMonthYearModalBtn.addEventListener('click', function() {
        // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦ã‹ã‚‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closeMonthYearModalBtn.blur();
      });
    }
    
    // äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      locale: 'ja',
      height: 'auto',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      dayHeaderFormat: { weekday: 'short', day: 'numeric', month: 'short' },
      buttonText: {
        today: 'ä»Šæ—¥',
        month: 'æœˆ',
        week: 'é€±',  
        day: 'æ—¥'
      },
                slotMinTime: '08:00:00',
          slotMaxTime: '22:00:00',
          slotDuration: '00:10:00', // 10åˆ†é–“éš”
                  // ãƒ™ãƒ¼ã‚¹å–¶æ¥­æ™‚é–“ã®èƒŒæ™¯è‰²ã‚’è¨­å®š
        dayCellDidMount: function(arg) {
          const date = arg.date;
          const hour = date.getHours();
          const minute = date.getMinutes();
          
          // 10:00-21:00ã®ç¯„å›²ã‚’ãƒ™ãƒ¼ã‚¹å–¶æ¥­æ™‚é–“ã¨ã—ã¦è¨­å®š
          if (hour >= 10 && hour < 21) {
            arg.el.style.backgroundColor = '#f8f9fa';
            arg.el.style.borderLeft = '2px solid #28a745';
          }
        },
      slotLabelInterval: '00:30:00', // ãƒ©ãƒ™ãƒ«ã¯30åˆ†é–“éš”
      snapDuration: '00:10:00', // ã‚¹ãƒŠãƒƒãƒ—ã‚‚10åˆ†é–“éš”
      slotMinWidth: 60,
      allDaySlot: false,
      selectable: true,
      editable: true,
      nowIndicator: true,
      eventDisplay: 'block',
      eventMinHeight: 15,
      eventMinWidth: 0,
      slotEventOverlap: false,
      slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
      
      eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
        timeZone: 'Asia/Tokyo'
      },
      
      // ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰
      eventDrop: function(info) {
        console.log('ğŸ”„ Event dropped:', info.event);
        updateReservationTime(info.event);
      },
      
      eventResize: function(info) {
        console.log('ğŸ“ Event resized:', info.event);
        updateReservationTime(info.event);
      },
      
      eventClick: function(info) {
        openReservationModal(info.event);
      },
      
      datesSet: function(info) {
        // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æ—¥ä»˜ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚‚åŒæœŸ
        const currentDate = info.start;
        monthCalendar.gotoDate(currentDate);
        updateMonthYearDisplay();
      },
      

      
      select: function(info) {
        // æ—¢å­˜ã®selectå‡¦ç†ã‚’ãã®ã¾ã¾ä½¿ç”¨
        console.log('ğŸ” Raw select info:', info);
        
        const startTime = info.start;
        const endTime = info.end;
        
        const startHour = startTime.getHours ? startTime.getHours() : startTime.hour;
        const startMinute = startTime.getMinutes ? startTime.getMinutes() : startTime.min;
        const endHour = endTime.getHours ? endTime.getHours() : endTime.hour;
        const endMinute = endTime.getMinutes ? endTime.getMinutes() : endTime.min;
        
        if (startHour < 8 || startHour >= 22) {
          console.log('âŒ Selected time outside available hours:', startHour);
          showMessage('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºæ™‚é–“å¤–ã§ã™ã€‚8:00ã‹ã‚‰21:59ã®é–“ã§é¸æŠã—ã¦ãã ã•ã„', 'warning');
          return;
        }
    
        const selectionDuration = (endTime - startTime) / (1000 * 60);
        
        if (endHour > 22 || (endHour === 22 && endMinute > 0)) {
          console.log('âŒ Selection extends beyond available hours');
          showMessage(`ã“ã®æ™‚é–“å¸¯ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºç¯„å›²å¤–ã«ãªã‚Šã¾ã™ã€‚çµ‚äº†æ™‚åˆ»: ${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`, 'warning');
          return;
        }
    
        openNewReservationModal(info.start, info.end);
      },
      
      // ğŸ”§ å®Œå…¨ä¿®æ­£ï¼ševentContentã§å…¨ã‚³ãƒ¼ã‚¹ã«å¯¾å¿œ
      eventContent: function(arg) {
        const event = arg.event;
        const extendedProps = event.extendedProps;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆã®å®Ÿéš›ã®æ™‚é–“å¹…ã‚’è¨ˆç®—
        const eventStart = new Date(event.start);
        const eventEnd = new Date(event.end);
        const actualDurationMinutes = Math.round((eventEnd - eventStart) / (1000 * 60));
        
        // è©³ç´°ãƒ­ã‚°
        const courseDuration = extendedProps.course_duration || 60;
        const intervalDuration = extendedProps.interval_duration || 0;
        const totalExpected = courseDuration + intervalDuration;
        
        console.log(`ğŸ¨ Rendering event ${event.id}:`);
        console.log(`  Title: ${event.title}`);
        console.log(`  Course: ${courseDuration}åˆ†, Interval: ${intervalDuration}åˆ†`);
        console.log(`  Total expected: ${totalExpected}åˆ†`);
        console.log(`  Actual duration: ${actualDurationMinutes}åˆ†`);
        console.log(`  Slots needed: ${actualDurationMinutes / 10}`);
        console.log(`  Has interval: ${extendedProps.has_interval}`);
        console.log(`  Interval type: ${extendedProps.is_individual_interval ? 'Individual' : 'System'}`);
        
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒã‚ã‚‹å ´åˆã¯ã‚¿ãƒ–å½¢å¼ã§è¡¨ç¤º
        if (extendedProps.has_interval && intervalDuration > 0) {
          const intervalType = extendedProps.is_individual_interval ? 'individual' : 'system';
          
          // flexãƒ™ãƒ¼ã‚¹ã§ã®æ¯”ç‡è¨ˆç®—
          const courseRatio = courseDuration;
          const intervalRatio = intervalDuration;
          
          console.log(`ğŸ“Š Tab ratios for event ${event.id}:`);
          console.log(`  Course flex: ${courseRatio} (${courseDuration}åˆ†)`);
          console.log(`  Interval flex: ${intervalRatio} (${intervalDuration}åˆ†)`);
          console.log(`  Ratio: ${courseRatio}:${intervalRatio}`);
          
          return {
            html: `
              <div class="event-tab-container" style="
                height: 100%; 
                display: flex; 
                flex-direction: column;
                width: 100%;
              ">
                <div class="event-tab course" style="
                  flex: ${courseRatio}; 
                  display: flex; 
                  align-items: center; 
                  justify-content: center;
                  padding: 2px 4px;
                  font-size: 0.8rem;
                  font-weight: 600;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
                  background: inherit;
                  color: inherit;
                ">
                  ${event.title}
                </div>
                <div class="event-tab interval ${intervalType}" style="
                  flex: ${intervalRatio}; 
                  display: flex; 
                  align-items: center; 
                  justify-content: center;
                  padding: 2px 4px;
                  font-size: 0.75rem;
                  font-weight: 500;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                  background-color: ${intervalType === 'individual' ? '#fd7e14' : '#6c757d'};
                  color: white;
                ">
                  æ•´ç†${intervalDuration}åˆ†
                </div>
              </div>
            `
          };
        } else {
          // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãªã—ã®å ´åˆã¯é€šå¸¸è¡¨ç¤º
          return {
            html: `
              <div style="
                height: 100%; 
                display: flex; 
                align-items: center; 
                justify-content: center;
                padding: 4px;
                font-size: 0.85rem;
                font-weight: 600;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
              ">
                ${event.title}
              </div>
            `
          };
        }
      },
      
      // ğŸ”§ æ”¹å–„ã•ã‚ŒãŸã‚¤ãƒ™ãƒ³ãƒˆé«˜ã•è¨­å®š
      eventDidMount: function(info) {
        const event = info.event;
        const element = info.el;
        const extendedProps = event.extendedProps;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆã®å®Ÿéš›ã®æ™‚é–“å¹…ã‚’è¨ˆç®—
        const eventStart = new Date(event.start);
        const eventEnd = new Date(event.end);
        const actualDurationMinutes = Math.round((eventEnd - eventStart) / (1000 * 60));
        
        // dataå±æ€§ã‚’è¨­å®š
        element.setAttribute('data-duration', actualDurationMinutes);
        
        // é«˜ã•è¨ˆç®—ï¼ˆ30pxãƒ™ãƒ¼ã‚¹ï¼‰
        const expectedHeight = (actualDurationMinutes / 10) * 30;
        
        // å³åº§ã«é«˜ã•ã‚’è¨­å®š
        element.style.setProperty('height', `${expectedHeight}px`, 'important');
        element.style.setProperty('min-height', `${expectedHeight}px`, 'important');
        element.style.setProperty('max-height', `${expectedHeight}px`, 'important');
        element.style.setProperty('display', 'block', 'important');
        element.style.setProperty('visibility', 'visible', 'important');
        
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’dataå±æ€§ã¨ã—ã¦è¿½åŠ 
        const courseDuration = extendedProps.course_duration || 60;
        const intervalDuration = extendedProps.interval_duration || 0;
        const intervalType = extendedProps.is_individual_interval ? 'å€‹åˆ¥' : 'ã‚·ã‚¹ãƒ†ãƒ ';
        
        if (intervalDuration > 0) {
          element.setAttribute('data-interval-info', 
            `${courseDuration}åˆ† + ${intervalType}${intervalDuration}åˆ† = ${actualDurationMinutes}åˆ†`);
        }
        
        // é…å»¶ã—ã¦æœ€çµ‚ç¢ºèª
        setTimeout(() => {
          const finalHeight = element.offsetHeight;
          if (finalHeight === 0 || finalHeight < expectedHeight * 0.8) {
            // å¼·åˆ¶çš„ã«å†è¨­å®š
            element.style.setProperty('height', `${expectedHeight}px`, 'important');
            element.style.setProperty('min-height', `${expectedHeight}px`, 'important');
            element.style.setProperty('max-height', `${expectedHeight}px`, 'important');
            element.style.setProperty('display', 'block', 'important');
            element.style.setProperty('visibility', 'visible', 'important');
            element.style.setProperty('position', 'relative', 'important');
            
            console.log(`ğŸ”§ Event ${event.id} height adjusted: ${actualDurationMinutes}åˆ† = ${expectedHeight}px`);
          } else {
            console.log(`âœ… Event ${event.id} height: ${finalHeight}px (${actualDurationMinutes}åˆ†)`);
          }
        }, 100);
      },
      
      // ğŸ”§ ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®è©³ç´°æ¤œè¨¼
      events: function(info, successCallback, failureCallback) {
        console.log('ğŸ” Fetching events for:', info.startStr, 'to', info.endStr);
        
        fetch('/admin/reservations.json', {
      headers: {
        'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
    })
    .then(response => {
      if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
        .then(events => {
          console.log('âœ… Events loaded:', events.length);
          
          // ğŸ¯ å…¨ã‚³ãƒ¼ã‚¹çµ„ã¿åˆã‚ã›ã®æ¤œè¨¼
          console.log('ğŸ“Š Event duration analysis:');
          
          const durationStats = {};
          events.forEach((event, index) => {
            const startTime = new Date(event.start);
            const endTime = new Date(event.end);
            const actualDuration = Math.round((endTime - startTime) / (1000 * 60));
            
            const courseDuration = event.extendedProps?.course_duration || 0;
            const intervalDuration = event.extendedProps?.interval_duration || 0;
            const expectedDuration = courseDuration + intervalDuration;
            
            // çµ±è¨ˆã‚’é›†è¨ˆ
            if (!durationStats[actualDuration]) {
              durationStats[actualDuration] = {
                count: 0,
                examples: [],
                slots: actualDuration / 10
              };
            }
            durationStats[actualDuration].count++;
            durationStats[actualDuration].examples.push({
              id: event.id,
              course: courseDuration,
              interval: intervalDuration,
              title: event.title
            });
            
            console.log(`ğŸ¯ Event ${event.id}: ${courseDuration}åˆ†+${intervalDuration}åˆ†=${actualDuration}åˆ† (${actualDuration/10}ã‚¹ãƒ­ãƒƒãƒˆ)`);
          });
          
          // çµ±è¨ˆã‚µãƒãƒªãƒ¼
          console.log('ğŸ“ˆ Duration statistics:');
          Object.entries(durationStats).sort(([a], [b]) => Number(a) - Number(b)).forEach(([duration, stats]) => {
            console.log(`  ${duration}åˆ† (${stats.slots}ã‚¹ãƒ­ãƒƒãƒˆ): ${stats.count}ä»¶`);
            if (stats.examples.length <= 3) {
              stats.examples.forEach(ex => {
                console.log(`    - ${ex.title} (${ex.course}åˆ†+${ex.interval}åˆ†)`);
              });
            }
          });
          
          successCallback(events);
    })
    .catch(error => {
          console.error('âŒ Error loading events:', error);
          failureCallback(error);
        });
      }
    });
  
    console.log('ğŸ¨ Rendering calendars...');
    
    // ä¸¡æ–¹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
          monthCalendar.render();
      calendar.render();
      
      // åˆæœŸè¡¨ç¤ºã®å¹´ã¨æœˆã‚’è¨­å®š
      updateMonthYearDisplay();
      
      // ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å¼·åˆ¶ã‚µã‚¤ã‚ºèª¿æ•´
      setTimeout(() => {
        const calendarEl = document.getElementById('monthCalendar');
        if (calendarEl) {
          // å¼·åˆ¶çš„ã«ã‚µã‚¤ã‚ºã‚’è¨­å®š
          calendarEl.style.width = '300px';
          calendarEl.style.height = '100px';
          calendarEl.style.minWidth = '300px';
          calendarEl.style.minHeight = '100px';
          calendarEl.style.maxWidth = '300px';
          calendarEl.style.maxHeight = '100px';
          calendarEl.style.overflow = 'hidden';
          calendarEl.style.display = 'block';
          
                   // FullCalendar ã®ã‚µã‚¤ã‚ºæ›´æ–°
         monthCalendar.updateSize();
         
         // å¼·åˆ¶çš„ã«å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
         setTimeout(() => {
           monthCalendar.render();
           monthCalendar.updateSize();
           
           // ã•ã‚‰ã«é…å»¶ã—ã¦ç¢ºå®Ÿã«è¡¨ç¤º
           setTimeout(() => {
             monthCalendar.updateSize();
           }, 200);
         }, 100);
          
          // å†…éƒ¨è¦ç´ ã‚‚å¼·åˆ¶çš„ã«èª¿æ•´
          const fcEl = calendarEl.querySelector('.fc');
          if (fcEl) {
            fcEl.style.width = '120px';
            fcEl.style.height = '100px';
            fcEl.style.minWidth = '120px';
            fcEl.style.minHeight = '100px';
            fcEl.style.maxWidth = '120px';
            fcEl.style.maxHeight = '100px';
          }
        }
      }, 100);
    

    
    console.log('âœ… Calendars rendered successfully');
    


    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†å¾Œã«ã‚¹ãƒ­ãƒƒãƒˆé«˜ã•ã‚’ç¢ºèª
    setTimeout(() => {
      console.log('ğŸ” Final height validation for all events:');
      
      const allEvents = document.querySelectorAll('.fc-timegrid-event[data-duration]');
      const heightStats = {};
      
      allEvents.forEach((element, index) => {
        const duration = parseInt(element.getAttribute('data-duration'));
        const actualHeight = element.offsetHeight;
        const expectedSlots = duration / 10;
        const slotHeight = 30; // ãƒ™ãƒ¼ã‚¹ã¯30pxï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰
        const expectedHeight = expectedSlots * slotHeight;
        
        if (!heightStats[duration]) {
          heightStats[duration] = {
            count: 0,
            heights: [],
            expectedHeight,
            slots: expectedSlots
          };
        }
        
        heightStats[duration].count++;
        heightStats[duration].heights.push(actualHeight);
      });
      
      console.log('ğŸ“Š Height validation summary:');
      Object.entries(heightStats)
        .sort(([a], [b]) => Number(a) - Number(b))
        .forEach(([duration, stats]) => {
          const avgHeight = Math.round(stats.heights.reduce((a, b) => a + b, 0) / stats.heights.length);
          const isCorrect = Math.abs(avgHeight - stats.expectedHeight) <= 5;
          const status = isCorrect ? 'âœ…' : 'âŒ';
          
          console.log(`  ${status} ${duration}åˆ† (${stats.slots}ã‚¹ãƒ­ãƒƒãƒˆ): ${stats.count}ä»¶`);
          console.log(`    Expected: ${stats.expectedHeight}px, Average: ${avgHeight}px`);
          
          if (!isCorrect) {
            console.warn(`    Height mismatch detected for ${duration}åˆ† events!`);
          }
        });
    }, 2000);
  // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’æ›´æ–°
    function updateIntervalInfo(extendedProps) {
      const intervalInfo = document.getElementById('currentIntervalInfo');
      const individualInterval = extendedProps?.individual_interval_minutes;
      const effectiveInterval = extendedProps?.effective_interval_minutes || 15;
      
      if (individualInterval !== null && individualInterval !== undefined) {
        intervalInfo.innerHTML = `<span class="badge bg-success">å€‹åˆ¥è¨­å®š: ${individualInterval}åˆ†</span>`;
    } else {
        intervalInfo.innerHTML = `<span class="badge bg-primary">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: ${effectiveInterval}åˆ†</span>`;
      }
    }

  // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
  try {
    loadCancellationStats();
    } catch (error) {
      console.log('ğŸ“Š Initial cancellation stats loading skipped:', error.message);
    }
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
    const urlParams = new URLSearchParams(window.location.search);
    const editReservationId = urlParams.get('edit');
    
    if (editReservationId) {
      console.log('ğŸ”§ Edit mode detected for reservation:', editReservationId);
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      setTimeout(() => {
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰è©²å½“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
        const event = calendar.getEventById(editReservationId);
        if (event) {
          console.log('âœ… Found event for editing:', event);
          openReservationModal(event);
        } else {
          console.log('âŒ Event not found for editing:', editReservationId);
          showMessage('ç·¨é›†ã™ã‚‹äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
        }
      }, 1000); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
    }
    
    // æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯æ™‚ã®äºˆç´„è¡¨ç¤ºé–¢æ•°
    function showDayReservations(date, reservations) {
      const dateStr = date.toLocaleDateString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        weekday: 'long'
      });
      
      let html = `
        <div class="modal fade" id="dayReservationsModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="fas fa-calendar-day me-2"></i>${dateStr}ã®äºˆç´„ä¸€è¦§
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>æ™‚é–“</th>
                        <th>é¡§å®¢å</th>
                        <th>ã‚³ãƒ¼ã‚¹</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>
      `;
      
      reservations.forEach(reservation => {
        const startTime = new Date(reservation.start).toLocaleTimeString('ja-JP', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        const endTime = new Date(reservation.end).toLocaleTimeString('ja-JP', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        const statusBadge = getStatusBadge(reservation.status);
        
        html += `
          <tr>
            <td><strong>${startTime} - ${endTime}</strong></td>
            <td>${reservation.customer_name || 'æœªè¨­å®š'}</td>
            <td>${reservation.course || 'æœªè¨­å®š'}</td>
            <td>${statusBadge}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editReservation(${reservation.id})">
                <i class="fas fa-edit"></i>
              </button>
            </td>
          </tr>
        `;
      });
      
      html += `
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                <button type="button" class="btn btn-primary" onclick="openNewReservationModal()">
                  <i class="fas fa-plus me-1"></i>æ–°è¦äºˆç´„
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
      const existingModal = document.getElementById('dayReservationsModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      document.body.insertAdjacentHTML('beforeend', html);
      
      const modal = new bootstrap.Modal(document.getElementById('dayReservationsModal'));
      modal.show();
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ç”Ÿæˆé–¢æ•°
    function getStatusBadge(status) {
      const badges = {
        'tentative': '<span class="badge bg-warning">ä»®äºˆç´„</span>',
        'confirmed': '<span class="badge bg-success">ç¢ºå®š</span>',
        'cancelled': '<span class="badge bg-danger">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>',
        'completed': '<span class="badge bg-info">å®Œäº†</span>',
        'no_show': '<span class="badge bg-secondary">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>'
      };
      return badges[status] || '<span class="badge bg-secondary">æœªè¨­å®š</span>';
    }
    
    // äºˆç´„ç·¨é›†é–¢æ•°
    function editReservation(reservationId) {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      const modal = bootstrap.Modal.getInstance(document.getElementById('dayReservationsModal'));
      if (modal) {
        modal.hide();
      }
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è©²å½“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–‹ã
      setTimeout(() => {
        const event = calendar.getEventById(reservationId.toString());
        if (event) {
          openReservationModal(event);
        } else {
          showMessage('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
        }
      }, 300);
    }
    
    // æ–°è¦äºˆç´„ãƒœã‚¿ãƒ³
    const newReservationBtn = document.getElementById('newReservationBtn');
          if (newReservationBtn) {
        newReservationBtn.addEventListener('click', () => {
          openNewReservationModal();
        });
      }
      
      // ã‚·ãƒ•ãƒˆè¨­å®šãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      const shiftSettingsBtn = document.getElementById('shiftSettingsBtn');
      if (shiftSettingsBtn) {
        shiftSettingsBtn.addEventListener('click', () => {
          openShiftSettingsModal();
        });
      }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    const reservationModal = new bootstrap.Modal(document.getElementById('reservationModal'));
    const customerHistoryModal = new bootstrap.Modal(document.getElementById('customerHistoryModal'));
    
    // é¡§å®¢æ¤œç´¢ãƒ»é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ 
    // é¡§å®¢æ¤œç´¢æ©Ÿèƒ½
    let searchTimeout;
    const customerSearch = document.getElementById('customerSearch');
    const searchResults = document.getElementById('customerSearchResults');
    const selectedCustomerInfo = document.getElementById('selectedCustomerInfo');
    const newCustomerForm = document.getElementById('newCustomerForm');

    if (customerSearch) {
      customerSearch.addEventListener('input', function() {
      const query = this.value.trim();
      
      clearTimeout(searchTimeout);
      
      if (query.length < 2) {
        hideSearchResults();
      return;
    }
    
      searchTimeout = setTimeout(() => {
        searchCustomers(query);
      }, 300);
    });
    }

    // æ¤œç´¢çµæœä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰çµæœã‚’éš ã™
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#customerSearch') && !e.target.closest('#customerSearchResults')) {
        hideSearchResults();
      }
    });

    // æ¤œç´¢çµæœã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
    document.addEventListener('click', function(e) {
      const searchResultItem = e.target.closest('.search-result-item');
      if (searchResultItem) {
        const userId = searchResultItem.dataset.userId;
        const userName = searchResultItem.dataset.userName;
        const userPhone = searchResultItem.dataset.userPhone;
        const userEmail = searchResultItem.dataset.userEmail;
        
        console.log('Search result clicked:', { userId, userName, userPhone, userEmail });
        selectCustomer(userId, userName, userPhone, userEmail);
      }
    });

    function searchCustomers(query) {
      fetch(`/admin/users/search?query=${encodeURIComponent(query)}`, {
      headers: {
        'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
    })
    .then(response => {
      if (!response.ok) {
          if (response.status === 401) {
            // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            window.location.href = '/admin_users/sign_in';
            throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
      }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
      return response.json();
    })
    .then(data => {
        displaySearchResults(data.users, query);
      })
      .catch(error => {
        console.error('é¡§å®¢æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
        hideSearchResults();
      });
    }

    function displaySearchResults(users, query) {
      if (users.length === 0) {
        // æ¤œç´¢çµæœãŒãªã„å ´åˆã¯æ–°è¦é¡§å®¢ç™»éŒ²ã‚’ææ¡ˆ
        searchResults.innerHTML = `
          <div class="p-3 text-center">
            <div class="text-muted mb-2">
              <i class="fas fa-search me-1"></i>
              ã€Œ${query}ã€ã«è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
            </div>
            <button type="button" class="btn btn-sm btn-primary" onclick="showNewCustomerForm('${query}')">
              <i class="fas fa-user-plus me-1"></i>æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²
            </button>
          </div>
        `;
    } else {
        let html = '';
        users.forEach(user => {
          html += `
            <div class="search-result-item p-3 border-bottom" 
                 style="cursor: pointer; transition: background-color 0.2s;"
                 onmouseover="this.style.backgroundColor='#f8f9fa'"
                 onmouseout="this.style.backgroundColor='white'"
                 data-user-id="${user.id}"
                 data-user-name="${user.name || ''}"
                 data-user-phone="${user.phone_number || ''}"
                 data-user-email="${user.email || ''}">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">${user.name || 'åå‰æœªè¨­å®š'}</div>
                  <small class="text-muted">
                    ${user.phone_number || 'é›»è©±ç•ªå·æœªç™»éŒ²'}
                    ${user.email ? ` | ${user.email}` : ''}
                  </small>
                  ${user.last_visit ? `<br><small class="text-success">æœ€çµ‚æ¥åº—: ${user.last_visit}</small>` : ''}
                </div>
                <div class="text-end">
                  <small class="badge bg-info">${user.active_tickets}æš</small>
                </div>
              </div>
            </div>
          `;
        });
        searchResults.innerHTML = html;
      }
      
      searchResults.style.display = 'block';
    }

    function hideSearchResults() {
      searchResults.style.display = 'none';
    }

    function selectCustomer(userId, name, phone, email) {
      console.log('selectCustomer called with:', { userId, name, phone, email });
      
      // é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã‚’ä¿å­˜
      document.getElementById('selectedUserId').value = userId;
      document.getElementById('customerSearch').value = name;
      
      // é¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º
      document.getElementById('selectedCustomerName').textContent = name;
      document.getElementById('selectedCustomerDetails').innerHTML = `
        ${phone || 'é›»è©±ç•ªå·æœªç™»éŒ²'} | 
        ${email || 'ãƒ¡ãƒ¼ãƒ«æœªç™»éŒ²'}
      `;
      
      // UIæ›´æ–°
      selectedCustomerInfo.style.display = 'block';
      newCustomerForm.style.display = 'none';
      hideSearchResults();
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–ï¼ˆé¸æŠæ¸ˆã¿ã‚’ç¤ºã™ï¼‰
      document.getElementById('customerSearch').disabled = true;
      document.getElementById('customerSearch').style.backgroundColor = '#e9ecef';
      
      // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
      loadCustomerTickets(userId);
      
      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      showMessage('é¡§å®¢ãŒé¸æŠã•ã‚Œã¾ã—ãŸ', 'success');
      
      console.log('é¡§å®¢ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', { userId, name, phone, email });
    }

    function showNewCustomerForm(initialName = '') {
      // æ–°è¦é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
      newCustomerForm.style.display = 'block';
      selectedCustomerInfo.style.display = 'none';
      document.getElementById('selectedUserId').value = '';
      
      // æ¤œç´¢ã—ãŸåå‰ã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
      if (initialName) {
        document.getElementById('newCustomerName').value = initialName;
      }
      
      hideSearchResults();
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«
      document.getElementById('newCustomerName').focus();
    }

    // é¡§å®¢é¸æŠã‚’ã‚¯ãƒªã‚¢
    const clearCustomerBtn = document.getElementById('clearCustomerBtn');
    if (clearCustomerBtn) {
      clearCustomerBtn.addEventListener('click', function() {
      document.getElementById('selectedUserId').value = '';
      document.getElementById('customerSearch').value = '';
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
      document.getElementById('customerSearch').disabled = false;
      document.getElementById('customerSearch').style.backgroundColor = 'white';
      
      selectedCustomerInfo.style.display = 'none';
      newCustomerForm.style.display = 'none';
      document.getElementById('ticketInfo').innerHTML = `
        <div class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      `;
      customerSearch.focus();
      
      showMessage('é¡§å®¢é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
    });
    }

    // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getCurrentReservationId() {
      const currentReservationIdField = document.getElementById('currentReservationId');
      return currentReservationIdField ? currentReservationIdField.value : null;
    }
    
    // ç¾åœ¨ã®äºˆç´„IDã‚’è¨­å®šã™ã‚‹é–¢æ•°
    function setCurrentReservationId(reservationId) {
      const currentReservationIdField = document.getElementById('currentReservationId');
      if (currentReservationIdField) {
        currentReservationIdField.value = reservationId || '';
      }
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ã‚‚åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
    window.getCurrentReservationId = getCurrentReservationId;
    window.setCurrentReservationId = setCurrentReservationId;

    function resetReservationForm() {
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('reservationForm').reset();
      setCurrentReservationId('');
      document.getElementById('selectedUserId').value = '';
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('cancellationReason').value = '';
      document.getElementById('cancellationReasonRow').style.display = 'none';
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
      document.getElementById('customerSearch').disabled = false;
      document.getElementById('customerSearch').style.backgroundColor = 'white';
      
      // UIè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
      selectedCustomerInfo.style.display = 'none';
      newCustomerForm.style.display = 'none';
      hideSearchResults();
      
      // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('ticketInfo').innerHTML = `
        <div class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      `;
    }
    
    // ã“ã®é–¢æ•°ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å…ˆé ­ï¼ˆline 530ä»˜è¿‘ï¼‰ã«è¿½åŠ 
    function getCourseDuration(course) {
      switch(course) {
        case '40åˆ†ã‚³ãƒ¼ã‚¹': return 40;
        case '60åˆ†ã‚³ãƒ¼ã‚¹': return 60;
        case '80åˆ†ã‚³ãƒ¼ã‚¹': return 80;
        default: return 60;
      }
    }
    // openReservationModal é–¢æ•°ã‚’å®Œå…¨ã«ç½®ãæ›ãˆï¼ˆ522è¡Œç›®ä»˜è¿‘ï¼‰
    function openReservationModal(event) {
      // æ—¢å­˜ã®äºˆç´„ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
      document.getElementById('reservationModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>äºˆç´„ç·¨é›†';
      document.getElementById('deleteReservationBtn').style.display = 'block';
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetReservationForm();
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
      if (event) {
        // äºˆç´„IDã‚’è¨­å®š
        setCurrentReservationId(event.id);
        
        // ğŸ”§ å®Œå…¨ãªä¿®æ­£: UTCå¤‰æ›ã‚’é¿ã‘ã¦ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã‚’ç›´æ¥å–å¾—
        const eventStart = event.start;
        
        // æ—¥ä»˜ã®å–å¾—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã¨ã—ã¦ï¼‰
        const year = eventStart.getFullYear();
        const month = String(eventStart.getMonth() + 1).padStart(2, '0');
        const day = String(eventStart.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        // æ™‚é–“ã®å–å¾—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã¨ã—ã¦ï¼‰
        const hours = String(eventStart.getHours()).padStart(2, '0');
        const minutes = String(eventStart.getMinutes()).padStart(2, '0');
        const timeString = `${hours}:${minutes}`;
        
        console.log('ğŸ• Edit reservation time:', {
          original: eventStart,
          dateString: dateString,
          timeString: timeString
        });
        
        document.getElementById('reservationDate').value = dateString;
        document.getElementById('reservationTime').value = timeString;
        document.getElementById('reservationCourse').value = event.title.split(' - ')[1] || '';
        document.getElementById('reservationStatus').value = event.extendedProps?.status || 'confirmed';
        document.getElementById('reservationMemo').value = event.extendedProps?.note || '';
        
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šã‚’è¨­å®š
        const individualInterval = event.extendedProps?.individual_interval_minutes;
        document.getElementById('reservationInterval').value = individualInterval || '';
        
        // ç¾åœ¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’æ›´æ–°
        updateIntervalInfo(event.extendedProps);
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’è¨­å®š
        const cancellationReason = event.extendedProps?.cancellation_reason || '';
        document.getElementById('cancellationReason').value = cancellationReason;
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å ´åˆã¯ç†ç”±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
        if (event.extendedProps?.status === 'cancelled') {
          document.getElementById('cancellationReasonRow').style.display = 'block';
        }
        
        // é¡§å®¢æƒ…å ±ã‚’è¨­å®šï¼ˆæ–°ã—ã„é¡§å®¢æ¤œç´¢æ©Ÿèƒ½ã«å¯¾å¿œï¼‰
        if (event.extendedProps?.customer) {
          const customer = event.extendedProps.customer;
          
          // é¡§å®¢é¸æŠçŠ¶æ…‹ã‚’è¨­å®š
          document.getElementById('selectedUserId').value = customer.id;
          document.getElementById('customerSearch').value = customer.name || '';
          
          // é¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º
          document.getElementById('selectedCustomerName').textContent = customer.name || '';
          document.getElementById('selectedCustomerDetails').innerHTML = `
            ${customer.phone || 'é›»è©±ç•ªå·æœªç™»éŒ²'} | 
            ${customer.email || 'ãƒ¡ãƒ¼ãƒ«æœªç™»éŒ²'}
          `;
          
          // UIæ›´æ–°
          document.getElementById('selectedCustomerInfo').style.display = 'block';
          document.getElementById('newCustomerForm').style.display = 'none';
          
          // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
          document.getElementById('customerSearch').disabled = true;
          document.getElementById('customerSearch').style.backgroundColor = '#e9ecef';
          
          // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
          loadCustomerTickets(customer.id);
        }
      }
      
      reservationModal.show();
    }

    // openNewReservationModal é–¢æ•°ã‚‚åŒæ§˜ã«ä¿®æ­£ï¼ˆ561è¡Œç›®ä»˜è¿‘ï¼‰
    function openNewReservationModal(start, end) {
      // æ–°è¦äºˆç´„ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
      document.getElementById('reservationModalLabel').innerHTML = '<i class="fas fa-calendar-plus me-2"></i>æ–°è¦äºˆç´„';
      document.getElementById('deleteReservationBtn').style.display = 'none';
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetReservationForm();
      
      // äºˆç´„IDã‚’ã‚¯ãƒªã‚¢
      setCurrentReservationId('');
      
      // æ—¥æ™‚ã‚’è¨­å®š
      if (start) {
        // ğŸ”§ å®Œå…¨ãªä¿®æ­£: UTCå¤‰æ›ã‚’é¿ã‘ã¦ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã‚’ç›´æ¥å–å¾—
        const eventStart = new Date(start);
        
        const year = eventStart.getFullYear();
        const month = String(eventStart.getMonth() + 1).padStart(2, '0');
        const day = String(eventStart.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        const hours = String(eventStart.getHours()).padStart(2, '0');
        const minutes = String(eventStart.getMinutes()).padStart(2, '0');
        const timeString = `${hours}:${minutes}`;
        
        console.log('ğŸ• New reservation time:', {
          original: start,
          eventStart: eventStart,
          dateString: dateString,
          timeString: timeString
        });
        
        document.getElementById('reservationDate').value = dateString;
        document.getElementById('reservationTime').value = timeString;
      }
      
      reservationModal.show();
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“æ›´æ–°æ©Ÿèƒ½
    function updateReservationTime(event) {
      const reservationId = event.id;
      const newStart = event.start;
      const newEnd = event.end;
      
      console.log('ğŸ”„ Updating reservation time:', {
        id: reservationId,
        start: newStart,
        end: newEnd,
        extendedProps: event.extendedProps
      });
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      
      // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã‚’æ—¥æœ¬æ™‚é–“ã¨ã—ã¦æ˜ç¤ºçš„ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆUTCå¤‰æ›ã‚’é¿ã‘ã‚‹ï¼‰
      function formatAsJSTDateTime(date) {
        if (!date) return null;
        
        // TimeWithZoneã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯é©åˆ‡ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
        const year = date.getFullYear ? date.getFullYear() : date.year;
        const month = date.getMonth ? String(date.getMonth() + 1).padStart(2, '0') : String(date.month).padStart(2, '0');
        const day = date.getDate ? String(date.getDate()).padStart(2, '0') : String(date.day).padStart(2, '0');
        const hours = date.getHours ? String(date.getHours()).padStart(2, '0') : String(date.hour).padStart(2, '0');
        const minutes = date.getMinutes ? String(date.getMinutes()).padStart(2, '0') : String(date.min).padStart(2, '0');
        const seconds = date.getSeconds ? String(date.getSeconds()).padStart(2, '0') : String(date.sec).padStart(2, '0');
        
        // JSTï¼ˆUTC+09:00ï¼‰ã¨ã—ã¦æ˜ç¤ºçš„ã«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æŒ‡å®š
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}+09:00`;
      }
      
      // ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã®æ™‚é–“ã‚’ãã®ã¾ã¾é€ä¿¡ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§é©åˆ‡ã«å‡¦ç†ï¼‰
      const startISO = formatAsJSTDateTime(newStart);
      const endISO = formatAsJSTDateTime(newEnd);
      
      console.log('ğŸ• Drag time conversion:', {
        start: newStart,
        end: newEnd,
        startISO: startISO,
        endISO: endISO,
        effectiveIntervalMinutes: event.extendedProps?.effective_interval_minutes || 0
      });
      
      console.log('ğŸ• Time conversion:', {
        start: newStart,
        end: newEnd,
        startISO: startISO,
        endISO: endISO,
        startLocalTime: newStart.toLocaleString('ja-JP'),
        endLocalTime: newEnd.toLocaleString('ja-JP'),
        effectiveIntervalMinutes: event.extendedProps?.effective_interval_minutes || 0
      });
      
      // æ™‚é–“æ›´æ–°APIã‚’å‘¼ã³å‡ºã—
      fetch(`/admin/reservations/${reservationId}`, {
        method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({
          reservation: {
            start_time: startISO,
            end_time: endISO
          },
          is_drag_update: true
        })
    })
    .then(response => {
        console.log('ğŸ“¡ Update response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
      return response.json();
    })
    .then(data => {
        console.log('âœ… Time update response:', data);
      
      if (data.success) {
          showMessage('äºˆç´„æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
          
          // æˆåŠŸæ™‚ã‚‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
          setTimeout(() => {
            calendar.refetchEvents();
          }, 500);
        } else {
          throw new Error(data.error || 'æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Time update error:', error);
        showMessage('æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'danger');
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿
        calendar.refetchEvents();
      });
    }
    
    function loadCustomerTickets(customerId) {
      if (!customerId) return;
      
      fetch(`/admin/users/${customerId}/tickets`)
        .then(response => response.json())
        .then(tickets => {
          const ticketInfo = document.getElementById('ticketInfo');
          if (tickets.length > 0) {
            let html = '<div class="row">';
            tickets.forEach(ticket => {
              const statusClass = ticket.status === 'expired' ? 'text-danger' : 
                                ticket.status === 'low' ? 'text-warning' : 'text-success';
              html += `
                <div class="col-md-6 mb-2">
                  <div class="card">
                    <div class="card-body p-2">
                      <h6 class="card-title mb-1">${ticket.name}</h6>
                                             <p class="card-text mb-1">
                         <small class="text-muted">
                           æ®‹ã‚Š: ${ticket.remaining}/${ticket.total}å›
                         </small>
                       </p>
                       <p class="card-text mb-1">
                         <small class="text-muted">
                           æœŸé™: ${ticket.expires_at || 'ãªã—'}
                         </small>
                       </p>
                       <p class="card-text mb-0">
                         <small class="${statusClass}">
                           ${ticket.status === 'expired' ? 'æœŸé™åˆ‡ã‚Œ' : 
                             ticket.status === 'low' ? 'æ®‹ã‚Šå°‘ãªã„' : 'åˆ©ç”¨å¯èƒ½'}
                         </small>
                       </p>
                    </div>
                  </div>
                </div>
              `;
            });
            html += '</div>';
            ticketInfo.innerHTML = html;
      } else {
            ticketInfo.innerHTML = '<div class="text-muted">ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }
    })
    .catch(error => {
          console.error('Error loading tickets:', error);
          document.getElementById('ticketInfo').innerHTML = '<div class="text-danger">ãƒã‚±ãƒƒãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã®å‡¦ç†
    const reservationStatus = document.getElementById('reservationStatus');
    if (reservationStatus) {
      reservationStatus.addEventListener('change', function() {
      const status = this.value;
      console.log('ğŸ“Š Status changed to:', status);
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
      const cancellationReasonRow = document.getElementById('cancellationReasonRow');
      if (status === 'cancelled') {
        cancellationReasonRow.style.display = 'block';
      } else {
        cancellationReasonRow.style.display = 'none';
        document.getElementById('cancellationReason').value = '';
      }
    });
    }

    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šå¤‰æ›´æ™‚ã®å‡¦ç†
    const reservationInterval = document.getElementById('reservationInterval');
    if (reservationInterval) {
      reservationInterval.addEventListener('change', function() {
      const intervalValue = this.value;
      const intervalInfo = document.getElementById('currentIntervalInfo');
      
      if (intervalValue === '') {
        intervalInfo.innerHTML = '<span class="badge bg-primary">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: 15åˆ†</span>';
      } else {
        intervalInfo.innerHTML = `<span class="badge bg-success">å€‹åˆ¥è¨­å®š: ${intervalValue}åˆ†</span>`;
      }
    });
    }

    // ä¿å­˜ãƒœã‚¿ãƒ³
    const saveReservationBtn = document.getElementById('saveReservationBtn');
    if (saveReservationBtn) {
      saveReservationBtn.addEventListener('click', function() {
      console.log('ğŸ’¾ Save button clicked');
      
      // é¡§å®¢é¸æŠã®ãƒã‚§ãƒƒã‚¯
      const selectedUserId = document.getElementById('selectedUserId').value;
      if (!selectedUserId) {
        console.log('âŒ No customer selected');
        showMessage('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    
      // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
      const reservationDate = document.getElementById('reservationDate').value;
      const reservationTime = document.getElementById('reservationTime').value;
      const reservationCourse = document.getElementById('reservationCourse').value;
      
      if (!reservationDate || !reservationTime || !reservationCourse) {
        console.log('âŒ Required fields missing:', { reservationDate, reservationTime, reservationCourse });
        showMessage('æ—¥æ™‚ã¨ã‚³ãƒ¼ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      // æ™‚é–“ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼ˆ10:00-21:00ï¼‰
      const timeParts = reservationTime.split(':');
      const hours = parseInt(timeParts[0]);
      const minutes = parseInt(timeParts[1]);
      
      if (hours < 8 || hours >= 22) {
        console.log('âŒ Time out of range:', reservationTime);
        showMessage('äºˆç´„æ™‚é–“ã¯8:00ã‹ã‚‰21:59ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      // ã‚³ãƒ¼ã‚¹æ™‚é–“ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’è€ƒæ…®ã—ãŸå–¶æ¥­æ™‚é–“ãƒã‚§ãƒƒã‚¯
      const courseDuration = getCourseDuration(reservationCourse);
      const checkIntervalValue = document.getElementById('reservationInterval').value;
      const intervalDuration = checkIntervalValue ? parseInt(checkIntervalValue) : 15; // ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      const totalDuration = courseDuration + intervalDuration;
      
      // äºˆç´„çµ‚äº†æ™‚åˆ»ã‚’è¨ˆç®—
      const startTime = new Date(`${reservationDate}T${reservationTime}:00`);
      const endTime = new Date(startTime.getTime() + totalDuration * 60 * 1000);
      const endHour = endTime.getHours();
      const endMinute = endTime.getMinutes();
      
      console.log('ğŸ• Reservation time check:', {
        startTime: reservationTime,
        courseDuration,
        intervalDuration,
        totalDuration,
        endTime: `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`,
        businessEnd: '21:00'
      });
      
      if (endHour > 22 || (endHour === 22 && endMinute > 0)) {
        console.log('âŒ Reservation extends beyond available hours');
        showMessage(`ã“ã®äºˆç´„ã¯è¡¨ç¤ºæ™‚é–“ç¯„å›²å¤–ã«ãªã‚Šã¾ã™ã€‚çµ‚äº†æ™‚åˆ»: ${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`, 'warning');
        return;
      }
            
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const saveBtn = this;
      const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';
      
      // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—
      const reservationId = getCurrentReservationId();
      const isEditMode = reservationId && reservationId !== '';
      
      // é¸æŠã•ã‚ŒãŸé¡§å®¢IDã‚’å–å¾—ï¼ˆæ—¢ã«å®£è¨€æ¸ˆã¿ï¼‰
      console.log('ğŸ‘¤ Selected user ID:', selectedUserId);
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã®ãƒã‚§ãƒƒã‚¯
      const status = document.getElementById('reservationStatus').value;
      const cancellationReason = document.getElementById('cancellationReason').value;
      
      if (status === 'cancelled' && !cancellationReason.trim()) {
        console.log('âŒ Cancellation reason required');
        showMessage('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šã‚’å–å¾—
      const intervalValue = document.getElementById('reservationInterval').value;
      let individualIntervalMinutes = null;
      
      if (intervalValue !== '' && !isNaN(parseInt(intervalValue))) {
        individualIntervalMinutes = parseInt(intervalValue);
      }
      
      console.log('ğŸ• Interval setting:', { intervalValue, individualIntervalMinutes });
      
      // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      const reservationData = {
        reservation: {
          user_id: selectedUserId,
          name: document.getElementById('customerSearch').value,
          date: document.getElementById('reservationDate').value,
          time: document.getElementById('reservationTime').value,
          course: document.getElementById('reservationCourse').value,
          status: document.getElementById('reservationStatus').value,
          cancellation_reason: cancellationReason,
          individual_interval_minutes: individualIntervalMinutes,
          note: document.getElementById('reservationMemo').value
        }
      };
      
      console.log('ğŸ’¾ Saving reservation:', reservationData);
      console.log('ğŸ• Individual interval minutes in payload:', reservationData.reservation.individual_interval_minutes);
      console.log('ğŸ“ Edit mode:', isEditMode);
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      console.log('ğŸ” CSRF Token:', csrfToken);
      
      // API URLã¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ±ºå®š
      const url = isEditMode ? `/admin/reservations/${reservationId}` : '/admin/reservations';
      const method = isEditMode ? 'PATCH' : 'POST';
      console.log('ğŸŒ API URL:', url);
      console.log('ğŸ“¡ Method:', method);
      
      // APIã‚’å‘¼ã³å‡ºã—
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify(reservationData)
      })
      .then(response => {
        console.log('ğŸ“¡ Save response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ… Save response:', data);
        
        if (data.success) {
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const message = isEditMode ? 'äºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'äºˆç´„ã‚’ä½œæˆã—ã¾ã—ãŸ';
          showMessage(message, 'success');
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          reservationModal.hide();
          
          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
          calendar.refetchEvents();
          
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã®æ›´æ–°ã¯ç„¡åŠ¹åŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ãªã‚‹ãŸã‚ï¼‰
          console.log('âœ… Reservation saved successfully, calendar updated');
  } else {
          throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Save error:', error);
        alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .finally(() => {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      });
    });
    }

    // ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    monthCalendar.render();
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openCancelledHistoryModal = function() {
      console.log('ğŸ“Š Opening cancelled history modal');
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã‚’å–å¾—ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤º
      fetch('/admin/reservations/cancellation_stats')
        .then(response => {
          console.log('ğŸ“Š Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('ğŸ“Š Received data for modal:', data);
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çµ±è¨ˆã‚’æ›´æ–°
          document.getElementById('modalCancelledCount').textContent = data.cancelled_count;
          document.getElementById('modalCancelledRate').textContent = data.cancelled_rate + '%';
          document.getElementById('modalTotalReservations').textContent = data.total_reservations || 0;
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å±¥æ­´ã‚’æ›´æ–°
          const modalHistoryContainer = document.getElementById('modalCancelledHistory');
          if (data.cancelled_history && data.cancelled_history.length > 0) {
            console.log('ğŸ“Š Rendering modal history:', data.cancelled_history.length, 'items');
            const historyHtml = data.cancelled_history.map(item => `
              <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="fw-bold text-dark fs-6">${item.customer_name}</div>
                    <div class="small text-muted mt-1">
                      <i class="fas fa-calendar me-1"></i>${item.cancelled_at}
                      <span class="mx-2">|</span>
                      <i class="fas fa-clock me-1"></i>${item.course}
                    </div>
                  </div>
                </div>
                <div class="mt-2">
                  <span class="badge bg-danger">
                    <i class="fas fa-times-circle me-1"></i>
                    ${item.reason || 'ç†ç”±æœªå…¥åŠ›'}
                  </span>
                </div>
              </div>
            `).join('');
            modalHistoryContainer.innerHTML = historyHtml;
          } else {
            console.log('ğŸ“Š No cancellation history found for modal');
            modalHistoryContainer.innerHTML = `
              <div class="text-muted text-center py-4">
                <i class="fas fa-info-circle me-1"></i>
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
              </div>
            `;
          }
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          const modal = new bootstrap.Modal(document.getElementById('cancelledHistoryModal'));
          modal.show();
        })
        .catch(error => {
          console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã®å–å¾—ã«å¤±æ•—:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
          const modalCancelledCount = document.getElementById('modalCancelledCount');
          const modalCancelledRate = document.getElementById('modalCancelledRate');
          const modalTotalReservations = document.getElementById('modalTotalReservations');
          const modalCancelledHistory = document.getElementById('modalCancelledHistory');
          
          if (modalCancelledCount) modalCancelledCount.textContent = '0';
          if (modalCancelledRate) modalCancelledRate.textContent = '0%';
          if (modalTotalReservations) modalTotalReservations.textContent = '0';
          if (modalCancelledHistory) {
            modalCancelledHistory.innerHTML = `
              <div class="text-muted text-center py-4">
                <i class="fas fa-exclamation-triangle me-1"></i>
                çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
              </div>
            `;
          }
          
          const modal = new bootstrap.Modal(document.getElementById('cancelledHistoryModal'));
          modal.show();
        });
    };

    // ã‚·ãƒ•ãƒˆè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openShiftSettingsModal = function() {
      console.log('â° Opening shift settings modal');
      
      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
      const today = new Date().toISOString().split('T')[0];
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('shiftDateSelect').value = today;
      document.getElementById('shiftTypeSelect').value = 'normal';
      document.getElementById('shiftStartTime').value = '10:00';
      document.getElementById('shiftEndTime').value = '21:00';
      document.getElementById('shiftNotes').value = '';
      
      // ä¼‘æ†©æ™‚é–“ã‚’ã‚¯ãƒªã‚¢
      const breakTimeList = document.getElementById('breakTimeList');
      if (breakTimeList) {
        breakTimeList.innerHTML = `
          <div class="break-time-item card mb-3">
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-4">
                  <label class="form-label small text-muted">é–‹å§‹æ™‚é–“</label>
                  <input type="time" class="form-control" placeholder="12:00">
                </div>
                <div class="col-md-4">
                  <label class="form-label small text-muted">çµ‚äº†æ™‚é–“</label>
                  <input type="time" class="form-control" placeholder="13:00">
                </div>
                <div class="col-md-3">
                  <label class="form-label small text-muted">æ“ä½œ</label>
                  <button type="button" class="btn btn-outline-danger btn-sm remove-break w-100">
                    <i class="fas fa-trash me-1"></i>å‰Šé™¤
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
      const saveBtn = document.getElementById('saveShiftSettings');
      if (saveBtn) {
        saveBtn.textContent = 'ä¿å­˜';
        saveBtn.onclick = function() {
          // ä¿å­˜å‡¦ç†ã¯æ—¢å­˜ã®ã¾ã¾
        };
      }
      
      // ã‚·ãƒ•ãƒˆã‚¿ã‚¤ãƒ—ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
      const shiftTypeSelect = document.getElementById('shiftTypeSelect');
      const shiftTimeSettings = document.getElementById('shiftTimeSettings');
      const shiftBreakSettings = document.getElementById('shiftBreakSettings');
      
      shiftTypeSelect.addEventListener('change', function() {
        const selectedType = this.value;
        
        switch(selectedType) {
          case 'normal':
            shiftTimeSettings.style.display = 'none';
            shiftBreakSettings.style.display = 'none';
            break;
          case 'extended':
            shiftTimeSettings.style.display = 'flex';
            shiftBreakSettings.style.display = 'block';
                    document.getElementById('shiftStartTime').value = '10:00';
        document.getElementById('shiftEndTime').value = '21:00';
            break;
          case 'shortened':
            shiftTimeSettings.style.display = 'flex';
            shiftBreakSettings.style.display = 'block';
                    document.getElementById('shiftStartTime').value = '10:00';
        document.getElementById('shiftEndTime').value = '18:00';
            break;
          case 'closed':
            shiftTimeSettings.style.display = 'none';
            shiftBreakSettings.style.display = 'none';
            break;
          case 'custom':
            shiftTimeSettings.style.display = 'flex';
            shiftBreakSettings.style.display = 'block';
            break;
        }
      });
      
      // ä¼‘æ†©æ™‚é–“ã®è¿½åŠ ãƒœã‚¿ãƒ³
      const addBreakTimeBtn = document.getElementById('addBreakTime');
      
      if (addBreakTimeBtn) {
        addBreakTimeBtn.addEventListener('click', function() {
          const breakTimeList = document.getElementById('breakTimeList');
          if (!breakTimeList) return;
          
          const breakItem = document.createElement('div');
          breakItem.className = 'break-time-item card mb-3';
          breakItem.innerHTML = `
            <div class="card-body">
              <div class="row align-items-center">
                <div class="col-md-4">
                  <label class="form-label small text-muted">é–‹å§‹æ™‚é–“</label>
                  <input type="time" class="form-control" placeholder="12:00">
                </div>
                <div class="col-md-4">
                  <label class="form-label small text-muted">çµ‚äº†æ™‚é–“</label>
                  <input type="time" class="form-control" placeholder="13:00">
                </div>
                <div class="col-md-3">
                  <label class="form-label small text-muted">æ“ä½œ</label>
                  <button type="button" class="btn btn-outline-danger btn-sm remove-break w-100">
                    <i class="fas fa-trash me-1"></i>å‰Šé™¤
                  </button>
                </div>
              </div>
            </div>
          `;
          breakTimeList.appendChild(breakItem);
          
          // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
          breakItem.querySelector('.remove-break').addEventListener('click', function() {
            breakItem.remove();
          });
        });
      }
      
      // æ—¢å­˜ã®å‰Šé™¤ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      document.querySelectorAll('.remove-break').forEach(btn => {
        btn.addEventListener('click', function() {
          this.closest('.break-time-item').remove();
        });
      });
      
              // ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        const saveShiftBtn = document.getElementById('saveShiftSettings');
        // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
        const newSaveShiftBtn = saveShiftBtn.cloneNode(true);
        saveShiftBtn.parentNode.replaceChild(newSaveShiftBtn, saveShiftBtn);
        
        newSaveShiftBtn.addEventListener('click', function() {
          const shiftData = {
            shift: {
              date: document.getElementById('shiftDateSelect').value,
              shift_type: document.getElementById('shiftTypeSelect').value,
              start_time: document.getElementById('shiftStartTime').value,
              end_time: document.getElementById('shiftEndTime').value,
              notes: document.getElementById('shiftNotes').value,
              breaks: []
            }
          };
          
          // ä¼‘æ†©æ™‚é–“ã‚’åé›†
          document.querySelectorAll('.break-time-item').forEach(item => {
            const timeInputs = item.querySelectorAll('input[type="time"]');
            if (timeInputs[0].value && timeInputs[1].value) {
              shiftData.shift.breaks.push({
                start: timeInputs[0].value,
                end: timeInputs[1].value
              });
            }
          });
          
          console.log('â° Saving shift data:', shiftData);
          
          // APIã‚’å‘¼ã³å‡ºã—ã¦ã‚·ãƒ•ãƒˆè¨­å®šã‚’ä¿å­˜
          fetch('/admin/shifts', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json',
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify(shiftData)
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            console.log('â° Save response:', data);
            if (data.success) {
                          showMessage('ã‚·ãƒ•ãƒˆè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
            updateCalendarWithShifts();
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚·ãƒ•ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            setTimeout(() => {
              loadShiftList();
            }, 100);
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const modal = bootstrap.Modal.getInstance(document.getElementById('shiftSettingsModal'));
            modal.hide();
            
            // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«ãƒªã‚»ãƒƒãƒˆ
            const resetSaveBtn = document.getElementById('saveShiftSettings');
            resetSaveBtn.textContent = 'ä¿å­˜';
            const newResetSaveBtn = resetSaveBtn.cloneNode(true);
            resetSaveBtn.parentNode.replaceChild(newResetSaveBtn, resetSaveBtn);
            newResetSaveBtn.textContent = 'ä¿å­˜';
            } else {
              showMessage('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.errors ? data.errors.join(', ') : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
            }
          })
          .catch(error => {
            console.error('âŒ Shift save error:', error);
            console.error('âŒ Error details:', error.message);
            showMessage('ä¿å­˜ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
          });
        });
      
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const modal = new bootstrap.Modal(document.getElementById('shiftSettingsModal'));
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå®Œå…¨ã«è¡¨ç¤ºã•ã‚ŒãŸå¾Œã«ã‚·ãƒ•ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
      const modalElement = document.getElementById('shiftSettingsModal');
      modalElement.addEventListener('shown.bs.modal', function() {
        console.log('â° Modal shown event triggered');
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã«å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚·ãƒ•ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
        setTimeout(() => {
          loadShiftList();
        }, 500);
      }, { once: true });
      
      modal.show();
      };
      
      // ã‚·ãƒ•ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
      window.loadShiftList = function() {
        console.log('â° Loading shift list...');
        
        // è¦ç´ ã®å­˜åœ¨ã‚’ç¢ºèª
        const modal = document.getElementById('shiftSettingsModal');
        const shiftList = document.getElementById('shiftList');
        
        console.log('â° Modal element:', modal);
        console.log('â° Shift list element:', shiftList);
        
        // shiftListãŒå­˜åœ¨ã—ãªã„å ´åˆã¯å†è©¦è¡Œï¼ˆæœ€å¤§5å›ï¼‰
        if (!shiftList) {
          console.log('â° Shift list element not found, retrying...');
          if (typeof loadShiftList.retryCount === 'undefined') {
            loadShiftList.retryCount = 0;
          }
          loadShiftList.retryCount++;
          
          if (loadShiftList.retryCount < 5) {
            setTimeout(loadShiftList, 200);
            return;
          } else {
            console.error('âŒ Failed to find shift list element after 5 retries');
            return;
          }
        }
        
        // ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
        loadShiftList.retryCount = 0;
        
        fetch('/admin/shifts.json')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(shifts => {
            console.log('â° Received shifts:', shifts);
            
            console.log('â° Found shiftList:', shiftList);

            
            if (shifts.length === 0) {
              console.log('â° No shifts found, showing empty state');
              shiftList.innerHTML = `
                <div class="text-center py-5">
                  <i class="fas fa-calendar-times text-muted" style="font-size: 3rem;"></i>
                  <h5 class="text-muted mt-3">è¨­å®šæ¸ˆã¿ã‚·ãƒ•ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</h5>
                  <p class="text-muted">ã‚·ãƒ•ãƒˆã‚’è¨­å®šã™ã‚‹ã¨ã€ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                </div>
              `;
            } else {
              console.log('â° Found shifts, displaying list:', shifts.length, 'shifts');
                              const shiftsHtml = shifts.map(shift => `
                  <div class="shift-item card mb-3 border-0 shadow-sm">
                    <div class="card-body">
                      <div class="row align-items-center">
                        <div class="col-md-2">
                          <div class="text-center">
                            <div class="fw-bold text-primary">${shift.date_display}</div>
                            <small class="text-muted">${shift.weekday}</small>
                          </div>
                        </div>
                        <div class="col-md-2">
                          <span class="badge ${shift.shift_type_badge_class}">${shift.shift_type_display}</span>
                        </div>
                        <div class="col-md-2">
                          <div class="text-center">
                            <div class="fw-bold">${shift.business_hours || 'ä¼‘æ¥­æ—¥'}</div>
                            <small class="text-muted">${shift.business_hours_duration || '-'}</small>
                          </div>
                        </div>
                        <div class="col-md-3">
                          <div class="small">
                            <div class="text-muted">ä¼‘æ†©æ™‚é–“ï¼š</div>
                            <div>${shift.breaks_display}</div>
                          </div>
                        </div>
                        <div class="col-md-2">
                          <div class="small text-muted">
                            <i class="fas fa-sticky-note me-1"></i>
                            ${shift.notes || '-'}
                          </div>
                        </div>
                        <div class="col-md-1">
                          <div class="btn-group-vertical">
                            <button class="btn btn-outline-primary btn-sm" title="ç·¨é›†" onclick="editShift(${shift.id})">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" title="å‰Šé™¤" onclick="deleteShift(${shift.id})">
                              <i class="fas fa-trash"></i>
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('');
                shiftList.innerHTML = shiftsHtml;
            }
          })
          .catch(error => {
            console.error('âŒ Load shifts error:', error);
            console.error('âŒ Error details:', error.message);
            showMessage('ã‚·ãƒ•ãƒˆä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
          });
      }
      
      // ã‚·ãƒ•ãƒˆã‚’ç·¨é›†ã™ã‚‹é–¢æ•°
      window.editShift = function(shiftId) {
        fetch(`/admin/shifts/${shiftId}.json`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(shift => {
            // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
            document.getElementById('shiftDateSelect').value = shift.date;
            document.getElementById('shiftTypeSelect').value = shift.shift_type;
            document.getElementById('shiftStartTime').value = shift.start_time || '';
            document.getElementById('shiftEndTime').value = shift.end_time || '';
            document.getElementById('shiftNotes').value = shift.notes || '';
            
            // ã‚·ãƒ•ãƒˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
            const shiftTypeSelect = document.getElementById('shiftTypeSelect');
            shiftTypeSelect.dispatchEvent(new Event('change'));
            
            // ä¼‘æ†©æ™‚é–“ã‚’è¨­å®š
            const breakTimeList = document.getElementById('breakTimeList');
            breakTimeList.innerHTML = '';
            
            if (shift.breaks && shift.breaks.length > 0) {
              shift.breaks.forEach(breakTime => {
                const breakItem = document.createElement('div');
                breakItem.className = 'break-time-item card mb-3';
                breakItem.innerHTML = `
                  <div class="card-body">
                    <div class="row align-items-center">
                      <div class="col-md-4">
                        <label class="form-label small text-muted">é–‹å§‹æ™‚é–“</label>
                        <input type="time" class="form-control" value="${breakTime.start}">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label small text-muted">çµ‚äº†æ™‚é–“</label>
                        <input type="time" class="form-control" value="${breakTime.end}">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label small text-muted">æ“ä½œ</label>
                        <button type="button" class="btn btn-outline-danger btn-sm remove-break w-100">
                          <i class="fas fa-trash me-1"></i>å‰Šé™¤
                        </button>
                      </div>
                    </div>
                  </div>
                `;
                breakTimeList.appendChild(breakItem);
                
                // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                breakItem.querySelector('.remove-break').addEventListener('click', function() {
                  breakItem.remove();
                });
              });
            }
            
            // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æ›´æ–°ãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´
            const saveBtn = document.getElementById('saveShiftSettings');
            saveBtn.textContent = 'æ›´æ–°';
            
            // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
            newSaveBtn.textContent = 'æ›´æ–°';
            newSaveBtn.onclick = function() {
              updateShift(shiftId);
            };
          })
          .catch(error => {
            console.error('âŒ Load shift error:', error);
            console.error('âŒ Error details:', error.message);
            showMessage('ã‚·ãƒ•ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
          });
      }
      
      // ã‚·ãƒ•ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
      window.updateShift = function(shiftId) {
        const shiftData = {
          shift: {
            date: document.getElementById('shiftDateSelect').value,
            shift_type: document.getElementById('shiftTypeSelect').value,
            start_time: document.getElementById('shiftStartTime').value,
            end_time: document.getElementById('shiftEndTime').value,
            notes: document.getElementById('shiftNotes').value,
            breaks: []
          }
        };
        
        // ä¼‘æ†©æ™‚é–“ã‚’åé›†
        document.querySelectorAll('.break-time-item').forEach(item => {
          const timeInputs = item.querySelectorAll('input[type="time"]');
          if (timeInputs[0].value && timeInputs[1].value) {
            shiftData.shift.breaks.push({
              start: timeInputs[0].value,
              end: timeInputs[1].value
            });
          }
        });
        
        fetch(`/admin/shifts/${shiftId}`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify(shiftData)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            showMessage('ã‚·ãƒ•ãƒˆè¨­å®šã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
            updateCalendarWithShifts();
            
            loadShiftList();
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const modal = bootstrap.Modal.getInstance(document.getElementById('shiftSettingsModal'));
            modal.hide();
            
            // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«ãƒªã‚»ãƒƒãƒˆ
            const resetSaveBtn = document.getElementById('saveShiftSettings');
            resetSaveBtn.textContent = 'ä¿å­˜';
            const newResetSaveBtn = resetSaveBtn.cloneNode(true);
            resetSaveBtn.parentNode.replaceChild(newResetSaveBtn, resetSaveBtn);
            newResetSaveBtn.textContent = 'ä¿å­˜';
          } else {
            showMessage('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.errors ? data.errors.join(', ') : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
          }
        })
        .catch(error => {
          console.error('âŒ Update shift error:', error);
          console.error('âŒ Error details:', error.message);
          showMessage('æ›´æ–°ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
        });
      }
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ã‚·ãƒ•ãƒˆã§æ›´æ–°ã™ã‚‹é–¢æ•°
      function updateCalendarWithShifts() {
        console.log('ğŸ”„ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ã‚·ãƒ•ãƒˆã§æ›´æ–°ä¸­...');
        
        // çµ±ä¸€ã•ã‚ŒãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—æ–¹æ³•ã‚’ä½¿ç”¨
        const calendarInstance = window.getCalendarInstance ? window.getCalendarInstance() : window.pageCalendar;
        
        if (!calendarInstance) {
          console.log('âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - å†åˆæœŸåŒ–ã‚’è©¦è¡Œã—ã¾ã™');
          if (typeof window.reinitializeCalendar === 'function') {
            window.reinitializeCalendar();
            return;
          }
          return;
        }
        
        // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
        fetch('/admin/shifts.json')
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(shifts => {
            console.log('ğŸ”„ ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—:', shifts);
            
            // ã‚·ãƒ•ãƒˆãƒã‚¤ãƒ©ã‚¤ã‚¿ãƒ¼ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
            if (window.shiftHighlighter) {
              console.log('ğŸ¨ Updating shift highlights...');
              
              // å„ã‚·ãƒ•ãƒˆã®å–¶æ¥­æ™‚é–“ã‚’é©ç”¨
              shifts.forEach(shift => {
                if (shift.start_time && shift.end_time) {
                  const startHour = parseInt(shift.start_time.split(':')[0]);
                  const endHour = parseInt(shift.end_time.split(':')[0]);
                  
                  console.log(`ğŸ• Applying shift: ${startHour}:00-${endHour}:00 for ${shift.date}`);
                  window.shiftHighlighter.updateTimeSlotHighlight(startHour, endHour);
                }
              });
              
              // ã‚°ãƒªãƒƒãƒ‰èƒŒæ™¯è‰²ã‚’æ›´æ–°
              if (window.shiftHighlighter.updateGridBackgroundColors) {
                window.shiftHighlighter.updateGridBackgroundColors();
              }
            } else {
              console.warn('âš ï¸ Shift highlighter not available');
            }
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            try {
              console.log('ğŸ”„ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ã‚’è©¦è¡Œä¸­...');
              
              // çµ±ä¸€ã•ã‚ŒãŸã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å–å¾—æ–¹æ³•ã‚’ä½¿ç”¨
              const calendarInstance = window.getCalendarInstance ? window.getCalendarInstance() : window.pageCalendar;
              console.log('ğŸ” Calendar instance type:', typeof calendarInstance);
              console.log('ğŸ” Calendar instance methods:', Object.getOwnPropertyNames(calendarInstance || {}));
              
              // FullCalendar v6ã®æ­£ã—ã„APIã‚’ä½¿ç”¨
              if (calendarInstance) {
                // æ–¹æ³•1: getApi()ã‚’ä½¿ç”¨ã—ã¦APIã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—
                if (typeof calendarInstance.getApi === 'function') {
                  const api = calendarInstance.getApi();
                  console.log('âœ… FullCalendar APIå–å¾—:', api);
                  
                  if (api && typeof api.refetchEvents === 'function') {
                    api.refetchEvents();
                    console.log('âœ… FullCalendar v6 APIã§æ›´æ–°ã—ã¾ã—ãŸ');
                  } else if (api && typeof api.getEvents === 'function') {
                    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†å–å¾—ã™ã‚‹ä»£æ›¿æ–¹æ³•
                    api.getEvents();
                    console.log('âœ… FullCalendar v6 getEventsã§æ›´æ–°ã—ã¾ã—ãŸ');
                  } else {
                    throw new Error('FullCalendar v6 APIã®refetchEvents/getEventsãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                  }
                }
                // æ–¹æ³•2: ç›´æ¥refetchEventsã‚’å‘¼ã³å‡ºã—
                else if (typeof calendarInstance.refetchEvents === 'function') {
                  calendarInstance.refetchEvents();
                  console.log('âœ… ç›´æ¥refetchEventsã§æ›´æ–°ã—ã¾ã—ãŸ');
                }
                // æ–¹æ³•3: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ã‹ã‚‰ç›´æ¥æ“ä½œ
                else {
                  console.log('ğŸ”„ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ã‹ã‚‰ç›´æ¥æ“ä½œ...');
                  const calendarEl = document.getElementById('calendar');
                  if (calendarEl) {
                    // FullCalendar v6ã®è¦ç´ ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¢ºèª
                    console.log('ğŸ” Calendar element properties:', Object.getOwnPropertyNames(calendarEl));
                    
                    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è¦ç´ ã‹ã‚‰å–å¾—
                    if (calendarEl._fullCalendarInstance) {
                      const fcInstance = calendarEl._fullCalendarInstance;
                      console.log('âœ… FullCalendar instance found on element');
                      
                      if (typeof fcInstance.refetchEvents === 'function') {
                        fcInstance.refetchEvents();
                        console.log('âœ… è¦ç´ ã‹ã‚‰å–å¾—ã—ãŸFullCalendar APIã§æ›´æ–°ã—ã¾ã—ãŸ');
                      } else if (typeof fcInstance.getApi === 'function') {
                        const api = fcInstance.getApi();
                        if (api && typeof api.refetchEvents === 'function') {
                          api.refetchEvents();
                          console.log('âœ… è¦ç´ ã‹ã‚‰å–å¾—ã—ãŸFullCalendar APIã§æ›´æ–°ã—ã¾ã—ãŸ');
                        }
                      }
                    } else {
                      console.warn('âš ï¸ FullCalendarã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦ç´ ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - å†åˆæœŸåŒ–ã‚’è©¦è¡Œã—ã¾ã™');
                      if (typeof window.reinitializeCalendar === 'function') {
                        window.reinitializeCalendar();
                      } else {
                        throw new Error('FullCalendarã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¦ç´ ã«è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                      }
                    }
                  } else {
                    throw new Error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                  }
                }
              } else {
                throw new Error('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
              }
            } catch (error) {
              console.error('âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
              
              // æœ€å¾Œã®æ‰‹æ®µ: ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
              console.log('ğŸ”„ æœ€å¾Œã®æ‰‹æ®µ: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼éƒ¨åˆ†ã®ã¿ã‚’ãƒªãƒ­ãƒ¼ãƒ‰...');
              const calendarContainer = document.querySelector('.calendar-container');
              if (calendarContainer) {
                // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼éƒ¨åˆ†ã®ã¿ã‚’å†èª­ã¿è¾¼ã¿
                const currentUrl = window.location.href;
                fetch(currentUrl)
                  .then(response => response.text())
                  .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const newCalendar = doc.querySelector('#calendar');
                    if (newCalendar) {
                      calendarContainer.innerHTML = newCalendar.outerHTML;
                      console.log('âœ… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼éƒ¨åˆ†ã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ');
                    }
                  })
                  .catch(err => {
                    console.error('âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                  });
              }
            }
            
            // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
            showVisualFeedback();
          })
          .catch(error => {
            console.error('âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          });
      }
      
      // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
      function showVisualFeedback() {
        const calendar = document.getElementById('calendar');
        if (calendar) {
          // ä¸€æ™‚çš„ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã‚’è¿½åŠ 
          calendar.classList.add('shift-update-animation');
          setTimeout(() => {
            calendar.classList.remove('shift-update-animation');
          }, 1000);
        }
      }
      
      // ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
      window.deleteShift = function(shiftId) {
        if (confirm('ã“ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
          fetch(`/admin/shifts/${shiftId}`, {
            method: 'DELETE',
            headers: {
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          })
          .then(data => {
            if (data.success) {
              showMessage('ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
              
              // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
              updateCalendarWithShifts();
              
              loadShiftList();
            } else {
              showMessage('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.errors ? data.errors.join(', ') : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
            }
          })
          .catch(error => {
            console.error('âŒ Delete shift error:', error);
            console.error('âŒ Error details:', error.message);
            showMessage('å‰Šé™¤ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
          });
        }
      }
  });

<!-- å–¶æ¥­æ™‚é–“ã®åˆæœŸåŒ–ç”¨JavaScript -->
  // å–¶æ¥­æ™‚é–“ã®åˆæœŸå€¤ã‚’è¨­å®š
  window.initialBusinessHours = {
    start: <%= ApplicationSetting.current.business_hours_start || 10 %>,
    end: <%= ApplicationSetting.current.business_hours_end || 21 %>,
    sundayClosed: <%= ApplicationSetting.current.sunday_closed? %>
  };
  
  // å–¶æ¥­æ™‚é–“ã®å‹•çš„æ›´æ–°
  function updateBusinessHours(start, end) {
    if (window.shiftHighlighter) {
      console.log(`ğŸ”„ å–¶æ¥­æ™‚é–“ã‚’å‹•çš„æ›´æ–°: ${start}:00-${end}:00`);
      window.shiftHighlighter.changeShift(start, end);
      
      // å–¶æ¥­æ™‚é–“è¡¨ç¤ºã‚‚æ›´æ–°
      const hoursDisplay = document.querySelector('.business-hours-display');
      if (hoursDisplay) {
        hoursDisplay.textContent = `${start}:00 - ${end}:00`;
      }
      
      // æˆåŠŸé€šçŸ¥ã‚’è¡¨ç¤º
      showNotification('å–¶æ¥­æ™‚é–“ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ', 'success');
    } else {
      console.error('âŒ Shift highlighter not available');
    }
  }
  
  // ã‚·ãƒ•ãƒˆãƒã‚¤ãƒ©ã‚¤ã‚¿ãƒ¼ã®åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«ã™ã‚‹
  function initializeShiftHighlighter() {
    console.log('ğŸ¨ Initializing shift highlighter...');
    
    // ã‚·ãƒ•ãƒˆãƒã‚¤ãƒ©ã‚¤ã‚¿ãƒ¼ã¯å‰Šé™¤ï¼ˆCSSã®ã¿ã§ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³è¡¨ç¤ºï¼‰
    console.log('âœ… Grid lines are handled by CSS only');
  }
  
  // ã‚·ãƒ•ãƒˆãƒã‚¤ãƒ©ã‚¤ã‚¿ãƒ¼ã®åˆæœŸåŒ–ã¯å‰Šé™¤ï¼ˆCSSã®ã¿ã§ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³è¡¨ç¤ºï¼‰
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–ã®ç¢ºèªæ©Ÿèƒ½
  function checkCalendarInitialization() {
    console.log('ğŸ” Checking calendar initialization status...');
    console.log('ğŸ” window.pageCalendar:', window.pageCalendar);
    console.log('ğŸ” window.calendar:', window.calendar);
    console.log('ğŸ” Calendar element:', document.getElementById('calendar'));
    
    if (window.pageCalendar) {
      console.log('âœ… Calendar is properly initialized');
    } else {
      console.log('âŒ Calendar is not initialized yet');
    }
  }
  
  // 5ç§’å¾Œã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–çŠ¶æ³ã‚’ç¢ºèª
  setTimeout(checkCalendarInitialization, 5000);
  
  // é€šçŸ¥è¡¨ç¤ºé–¢æ•°
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = `
      top: 20px;
      right: 20px;
      z-index: 1050;
      min-width: 300px;
      animation: slideIn 0.3s ease-out;
    `;
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // 3ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
  
  // ç¾åœ¨ã®å–¶æ¥­çŠ¶æ…‹ã‚’å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
  setInterval(() => {
    fetch('/admin/settings/<%= ApplicationSetting.current.id %>/business_status')
      .then(response => response.json())
      .then(data => {
        updateBusinessStatusIndicator(data);
        updateBusinessHoursDisplay(data);
      })
      .catch(error => {
        console.error('âŒ Business status check failed:', error);
      });
  }, 60000); // 1åˆ†ã”ã¨
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
  window.updateBusinessHours = updateBusinessHours;
  

  
  // å–¶æ¥­æ™‚é–“è¡¨ç¤ºã®æ›´æ–°
  function updateBusinessHoursDisplay(statusData) {
    const hoursDisplay = document.querySelector('.business-hours-display');
    const statusIndicator = document.querySelector('.business-status-indicator');
    const statusDot = document.querySelector('.status-dot');
    const statusText = statusIndicator.querySelector('div:last-child');
    
    if (hoursDisplay) {
      hoursDisplay.textContent = statusData.business_hours.formatted;
    }
    
    if (statusDot) {
      statusDot.className = `status-dot ${statusData.is_open ? 'open' : 'closed'}`;
      statusDot.style.background = statusData.is_open ? '#28a745' : '#dc3545';
    }
    
    if (statusText) {
      statusText.textContent = statusData.is_open ? 'å–¶æ¥­ä¸­' : 'å–¶æ¥­æ™‚é–“å¤–';
    }
  }
  
  // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
  function toggleDebugMode() {
    const calendar = document.getElementById('calendar');
    const isDebugMode = calendar.classList.contains('debug-mode');
    
    if (isDebugMode) {
      calendar.classList.remove('debug-mode');
      console.log('ğŸ” Debug mode disabled');
    } else {
      calendar.classList.add('debug-mode');
      console.log('ğŸ” Debug mode enabled');
      
      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
      const timeSlots = document.querySelectorAll('.fc-timegrid-slot');
      timeSlots.forEach((slot, index) => {
        const hour = Math.floor(index / 6) + 10;
        slot.setAttribute('data-slot-index', index);
        slot.setAttribute('data-time-hour', hour);
      });
    }
  }
  
  function updateBusinessStatusIndicator(statusData) {
    let indicator = document.querySelector('.business-status-indicator');
    
    if (!indicator) {
      indicator = document.createElement('div');
      indicator.className = 'business-status-indicator';
      document.querySelector('.calendar-container').appendChild(indicator);
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
    const statusClass = statusData.is_open ? 'open' : 'closed';
    indicator.className = `business-status-indicator ${statusClass}`;
    indicator.textContent = statusData.status_message;
    
    // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æƒ…å ±ã‚’è¿½åŠ 
    indicator.title = `å–¶æ¥­æ™‚é–“: ${statusData.business_hours.formatted}\nç¾åœ¨æ™‚åˆ»: ${statusData.current_time}`;
  }
</script>



<!-- ãƒ‡ãƒãƒƒã‚°ç”¨ã®JavaScripté–¢æ•°ã‚’ç›´æ¥å®šç¾© -->
<script>
// ãƒ‡ãƒãƒƒã‚°ç”¨ã®é–¢æ•°ã‚’ç›´æ¥å®šç¾©
function testGridUpdate() {
  console.log('ğŸ§ª Testing grid update...');
  
  // é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…ã¤
  const checkFunction = () => {
    if (typeof updateGridBackgroundColors === 'function') {
      updateGridBackgroundColors(new Date()).then(() => {
        console.log('âœ… Grid update test completed');
      }).catch(error => {
        console.error('âŒ Grid update test failed:', error);
      });
    } else {
      console.log('â³ updateGridBackgroundColors not ready, retrying...');
      setTimeout(checkFunction, 100);
    }
  };
  
  checkFunction();
}

function testShiftFetch() {
  console.log('ğŸ§ª Testing shift fetch...');
  
  // é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…ã¤
  const checkFunction = () => {
    if (typeof getBusinessHoursForDate === 'function') {
      getBusinessHoursForDate(new Date()).then(businessHours => {
        console.log('âœ… Shift fetch test completed:', businessHours);
      }).catch(error => {
        console.error('âŒ Shift fetch test failed:', error);
      });
    } else {
      console.log('â³ getBusinessHoursForDate not ready, retrying...');
      setTimeout(checkFunction, 100);
    }
  };
  
  checkFunction();
}

function testShiftHighlight() {
  console.log('ğŸ§ª Testing shift highlight...');
  
  // é–¢æ•°ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…ã¤
  const checkFunction = () => {
    if (typeof changeBusinessHours === 'function') {
      // å–¶æ¥­æ™‚é–“ã‚’æ‹¡å¼µ
      changeBusinessHours(9, 22);
      setTimeout(() => {
        // å–¶æ¥­æ™‚é–“ã‚’çŸ­ç¸®
        changeBusinessHours(11, 20);
        setTimeout(() => {
          // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
          changeBusinessHours(10, 21);
        }, 2000);
      }, 2000);
      console.log('âœ… Shift highlight test completed');
    } else {
      console.log('â³ changeBusinessHours not ready, retrying...');
      setTimeout(checkFunction, 100);
    }
  };
  
  checkFunction();
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
window.testGridUpdate = testGridUpdate;
window.testShiftFetch = testShiftFetch;

console.log('ğŸ”§ Debug functions defined in HTML:', {
  testGridUpdate: typeof window.testGridUpdate,
  testShiftFetch: typeof window.testShiftFetch
});

// é–¢æ•°ã®æº–å‚™çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆä¸€åº¦ã ã‘ï¼‰
setTimeout(() => {
  console.log('ğŸ” Function availability check:', {
    updateGridBackgroundColors: typeof updateGridBackgroundColors,
    getBusinessHoursForDate: typeof getBusinessHoursForDate
  });
}, 2000);
</script>



<script>
// ã‚¿ã‚¤ãƒ ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³è¡¨ç¤ºãƒ†ã‚¹ãƒˆé–¢æ•°ï¼ˆå¼·åŒ–ç‰ˆï¼‰
function testTimeGridLines() {
  console.log('ğŸ§ª Testing time grid lines (enhanced)...');
  
  // å…¨ã‚¹ãƒ­ãƒƒãƒˆã‚’ç¢ºèª
  const allSlots = document.querySelectorAll('.fc-timegrid-slot');
  console.log(`ğŸ“Š å…¨ã‚¹ãƒ­ãƒƒãƒˆæ•°: ${allSlots.length}`);
  
  if (allSlots.length === 0) {
    console.error('âŒ No time slots found! Calendar may not be rendered yet.');
    return;
  }
  
  // å„æ™‚é–“å¸¯ã®ã‚¹ãƒ­ãƒƒãƒˆæ•°ã‚’ç¢ºèª
  for (let hour = 8; hour <= 22; hour++) {
    const hourSlots = document.querySelectorAll(`.fc-timegrid-slot[data-time^="${hour.toString().padStart(2, '0')}:"]`);
    console.log(`ğŸ“Š ${hour}æ™‚å°ã®ã‚¹ãƒ­ãƒƒãƒˆæ•°: ${hourSlots.length}`);
  }
  
  // é‡è¦ãªæ™‚é–“ã®ãƒœãƒ¼ãƒ€ãƒ¼ã‚’ç¢ºèª
  const importantTimes = ['08:00:00', '09:00:00', '10:00:00', '11:00:00', '12:00:00', 
                         '13:00:00', '14:00:00', '15:00:00', '16:00:00', '17:00:00', 
                         '18:00:00', '19:00:00', '20:00:00', '21:00:00', '22:00:00'];
  
  importantTimes.forEach(time => {
    const slot = document.querySelector(`.fc-timegrid-slot[data-time="${time}"]`);
    if (slot) {
      const computedStyle = getComputedStyle(slot);
      console.log(`âœ… ${time}: border=${computedStyle.borderTop}, width=${computedStyle.borderTopWidth}, color=${computedStyle.borderTopColor}`);
    } else {
      console.log(`âŒ ${time}: ã‚¹ãƒ­ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
    }
  });
  
  // 30åˆ†ã®ã‚¹ãƒ­ãƒƒãƒˆã‚‚ç¢ºèª
  const thirtyMinSlots = document.querySelectorAll('.fc-timegrid-slot[data-time$=":30:00"]');
  console.log(`ğŸ“Š 30åˆ†ã‚¹ãƒ­ãƒƒãƒˆæ•°: ${thirtyMinSlots.length}`);
  
  if (thirtyMinSlots.length > 0) {
    const firstThirtyMin = thirtyMinSlots[0];
    const computedStyle = getComputedStyle(firstThirtyMin);
    console.log(`ğŸ¯ æœ€åˆã®30åˆ†ã‚¹ãƒ­ãƒƒãƒˆ (${firstThirtyMin.getAttribute('data-time')}): border=${computedStyle.borderTop}`);
  }
  
  console.log('âœ… ã‚¿ã‚¤ãƒ ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³è¡¨ç¤ºãƒ†ã‚¹ãƒˆå®Œäº†');
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
window.testTimeGridLines = testTimeGridLines;

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼çŠ¶æ…‹ç¢ºèªé–¢æ•°
window.checkCalendarStatus = function() {
  console.log('ğŸ” Checking calendar status...');
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ã®ç¢ºèª
  const calendarEl = document.getElementById('calendar');
  console.log('ğŸ“… Calendar element:', calendarEl);
  
  // FullCalendarã®ç¢ºèª
  console.log('ğŸ“… FullCalendar available:', typeof FullCalendar !== 'undefined');
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ç¢ºèª
  console.log('ğŸ“… pageCalendar:', window.pageCalendar);
  
  // ã‚¹ãƒ­ãƒƒãƒˆã®ç¢ºèª
  const slots = document.querySelectorAll('.fc-timegrid-slot');
  console.log('ğŸ“… Time slots found:', slots.length);
  
  if (slots.length > 0) {
    const firstSlot = slots[0];
    console.log('ğŸ“… First slot:', firstSlot);
    console.log('ğŸ“… First slot data-time:', firstSlot.getAttribute('data-time'));
    console.log('ğŸ“… First slot computed style:', getComputedStyle(firstSlot).borderTop);
  }
  
  // ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³é–¢æ•°ã®ç¢ºèª
  console.log('ğŸ“… applyGridLines function:', typeof window.applyGridLines);
  
  return {
    calendarElement: !!calendarEl,
    fullCalendar: typeof FullCalendar !== 'undefined',
    pageCalendar: !!window.pageCalendar,
    slotsCount: slots.length,
    applyGridLines: typeof window.applyGridLines === 'function'
  };
};

// ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚’é©ç”¨ã™ã‚‹é–¢æ•°ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
window.applyGridLines = function() {
  console.log('ğŸ”§ Applying grid lines...');
  
  setTimeout(() => {
    const allSlots = document.querySelectorAll('.fc-timegrid-slot');
    console.log(`ğŸ”§ Found ${allSlots.length} time slots`);
    
    if (allSlots.length === 0) {
      console.error('âŒ No time slots found!');
      return;
    }
    
    let thirtyMinCount = 0;
    let hourCount = 0;
    
    allSlots.forEach((slot) => {
      const timeAttr = slot.getAttribute('data-time');
      if (timeAttr) {
        // 30åˆ†ã”ã¨ã®ç·šï¼ˆç·‘ï¼‰
        if (timeAttr.endsWith(':30:00')) {
          slot.style.setProperty('border-top', '2px solid #28a745', 'important');
          thirtyMinCount++;
        }
        
        // 1æ™‚é–“ã”ã¨ã®å¤ªã„ç·šï¼ˆèµ¤ï¼‰
        if (timeAttr.endsWith(':00:00')) {
          slot.style.setProperty('border-top', '3px solid #dc3545', 'important');
          hourCount++;
        }
      }
    });
    
    console.log(`âœ… Grid lines applied: ${thirtyMinCount} 30-min, ${hourCount} hourly`);
    
    // 22æ™‚å°ã®ã‚¹ãƒ­ãƒƒãƒˆãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const slots22 = document.querySelectorAll('.fc-timegrid-slot[data-time^="22:"]');
    console.log(`ğŸ” 22æ™‚å°ã®ã‚¹ãƒ­ãƒƒãƒˆæ•°: ${slots22.length}`);
    
    if (slots22.length === 0) {
      console.warn('âš ï¸ 22æ™‚å°ã®ã‚¹ãƒ­ãƒƒãƒˆãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
    } else {
      console.log('âœ… 22æ™‚å°ã®ã‚¹ãƒ­ãƒƒãƒˆãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸ');
    }
  }, 100);
};

// ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã®çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ãƒ‡ãƒãƒƒã‚°é–¢æ•°
window.debugGridLines = function() {
  console.log('ğŸ” Debugging grid lines...');
  
  const allSlots = document.querySelectorAll('.fc-timegrid-slot');
  console.log(`ğŸ” Found ${allSlots.length} time slots`);
  
  let slotsWithBorders = 0;
  let slotsWithBackground = 0;
  
  allSlots.forEach((slot, index) => {
    const timeAttr = slot.getAttribute('data-time');
    const borderTop = slot.style.borderTop;
    const backgroundColor = slot.style.backgroundColor;
    
    if (borderTop && borderTop !== 'none') {
      slotsWithBorders++;
    }
    
    if (backgroundColor && backgroundColor !== '') {
      slotsWithBackground++;
    }
    
    if (index < 10) { // æœ€åˆã®10å€‹ã®ã‚¹ãƒ­ãƒƒãƒˆã®è©³ç´°ã‚’è¡¨ç¤º
      console.log(`Slot ${index}: time=${timeAttr}, border=${borderTop}, bg=${backgroundColor}`);
    }
  });
  
  console.log(`ğŸ“Š Summary: ${slotsWithBorders}/${allSlots.length} slots have borders, ${slotsWithBackground}/${allSlots.length} slots have background colors`);
  
  return {
    totalSlots: allSlots.length,
    slotsWithBorders,
    slotsWithBackground
  };
};

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
window.toggleDebugMode = function() {
  const calendar = document.getElementById('calendar');
  const isDebugMode = calendar.classList.contains('debug-mode');
  
  if (isDebugMode) {
    calendar.classList.remove('debug-mode');
    console.log('ğŸ” Debug mode disabled');
  } else {
    calendar.classList.add('debug-mode');
    console.log('ğŸ” Debug mode enabled');
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
    const timeSlots = document.querySelectorAll('.fc-timegrid-slot');
    timeSlots.forEach((slot, index) => {
      const hour = Math.floor(index / 6) + 10;
      slot.setAttribute('data-slot-index', index);
      slot.setAttribute('data-time-hour', hour);
    });
  }
};

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®å†åˆæœŸåŒ–
window.reinitializeCalendar = function() {
  console.log('ğŸ”„ Reinitializing calendar...');
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¦ç´ ã‚’å–å¾—
  const calendarEl = document.getElementById('calendar');
  if (!calendarEl) {
    console.error('âŒ Calendar element not found');
    return;
  }
  
  // æ—¢å­˜ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„
  if (window.pageCalendar) {
    try {
      window.pageCalendar.destroy();
    } catch (error) {
      console.warn('âš ï¸ Error destroying existing calendar:', error);
    }
    window.pageCalendar = null;
  }
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†åˆæœŸåŒ–
  if (typeof initializeCalendar === 'function') {
    initializeCalendar();
  } else {
    // ç›´æ¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
    console.log('ğŸ”„ Direct calendar reinitialization...');
    
    if (typeof FullCalendar !== 'undefined') {
      try {
        const calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'timeGridWeek',
          headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
          },
          locale: 'ja',
          height: 'auto',
          editable: true,
          selectable: true,
          selectMirror: true,
          dayMaxEvents: true,
          weekends: true,
          businessHours: {
            daysOfWeek: [1, 2, 3, 4, 5, 6],
            startTime: '10:00',
            endTime: '21:00'
          },
          slotMinTime: '08:00:00',
          slotMaxTime: '22:00:00',
          slotDuration: '00:10:00',
          nowIndicator: true,
          events: {
            url: '/admin/reservations.json',
            failure: function(error) {
              console.error('âŒ Error loading events:', error);
            }
          }
        });
        
        calendar.render();
        window.pageCalendar = calendar;
        console.log('âœ… Direct calendar reinitialization successful');
        
        // ã‚°ãƒªãƒƒãƒ‰ãƒ©ã‚¤ãƒ³ã‚’é©ç”¨
        setTimeout(() => {
          if (window.applyGridLines) {
            window.applyGridLines();
          }
        }, 1000);
        
      } catch (error) {
        console.error('âŒ Direct calendar reinitialization failed:', error);
      }
    } else {
      console.error('âŒ FullCalendar not available');
    }
  }
};

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’å–å¾—
window.getCalendarInstance = function() {
  return window.pageCalendar;
};

// ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—
window.getCurrentReservationId = function() {
  const currentId = document.getElementById('currentReservationId');
  return currentId ? currentId.value : '';
};
</script>

<!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->