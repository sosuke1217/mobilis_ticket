<!-- app/views/admin/reservations/bulk_new.html.erb -->

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-calendar-plus me-2"></i>å®šæœŸäºˆç´„ ä¸€æ‹¬ä½œæˆ</h2>
    <%= link_to "â† ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«æˆ»ã‚‹", admin_reservations_calendar_path, class: "btn btn-outline-secondary" %>
  </div>

  <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
  <div id="flash"></div>

  <form id="bulkReservationForm">
    <!-- åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="card mb-4">
      <div class="card-header bg-primary text-white">
        <h5 class="mb-0"><i class="fas fa-user me-2"></i>åŸºæœ¬æƒ…å ±</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <label for="userId" class="form-label">äºˆç´„è€… <span class="text-danger">*</span></label>
            <select class="form-select" id="userId" required>
              <option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
            </select>
          </div>
          <div class="col-md-6">
            <label for="course" class="form-label">ã‚³ãƒ¼ã‚¹ <span class="text-danger">*</span></label>
            <select class="form-select" id="course" required>
              <option value="40åˆ†">40åˆ†ã‚³ãƒ¼ã‚¹</option>
              <option value="60åˆ†" selected>60åˆ†ã‚³ãƒ¼ã‚¹</option>
              <option value="80åˆ†">80åˆ†ã‚³ãƒ¼ã‚¹</option>
            </select>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <label for="startTime" class="form-label">é–‹å§‹æ™‚é–“ <span class="text-danger">*</span></label>
            <select class="form-select" id="startTime" required>
              <option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              <!-- æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JavaScriptã§å‹•çš„ã«è¿½åŠ  -->
            </select>
          </div>
          <div class="col-md-6">
            <label for="status" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
            <select class="form-select" id="status">
              <option value="confirmed">ç¢ºå®š</option>
              <option value="tentative">ä»®äºˆç´„</option>
            </select>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <label for="note" class="form-label">å‚™è€ƒ</label>
            <textarea class="form-control" id="note" rows="2" placeholder="ç‰¹åˆ¥ãªè¦æœ›ã‚„æ³¨æ„äº‹é …ãªã©"></textarea>
          </div>
        </div>
      </div>
    </div>

    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="card mb-4">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0"><i class="fas fa-calendar-week me-2"></i>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‘ã‚¿ãƒ¼ãƒ³</h5>
      </div>
      <div class="card-body">
        <!-- ãƒ‘ã‚¿ãƒ¼ãƒ³é¸æŠ -->
        <div class="mb-3">
          <label class="form-label">ç¹°ã‚Šè¿”ã—ãƒ‘ã‚¿ãƒ¼ãƒ³ <span class="text-danger">*</span></label>
          <div class="row">
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pattern" id="weeklyPattern" value="weekly" checked>
                <label class="form-check-label" for="weeklyPattern">
                  <i class="fas fa-calendar-week me-1"></i>æ¯é€±
                </label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pattern" id="monthlyPattern" value="monthly">
                <label class="form-check-label" for="monthlyPattern">
                  <i class="fas fa-calendar-alt me-1"></i>æ¯æœˆ
                </label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="radio" name="pattern" id="customPattern" value="custom">
                <label class="form-check-label" for="customPattern">
                  <i class="fas fa-calendar-day me-1"></i>ã‚«ã‚¹ã‚¿ãƒ 
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- æœŸé–“è¨­å®š -->
        <div class="row mb-3" id="dateRangeSection">
          <div class="col-md-6">
            <label for="startDate" class="form-label">é–‹å§‹æ—¥ <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="startDate" required>
          </div>
          <div class="col-md-6">
            <label for="endDate" class="form-label">çµ‚äº†æ—¥ <span class="text-danger">*</span></label>
            <input type="date" class="form-control" id="endDate" required>
          </div>
        </div>

        <!-- æ¯é€±ãƒ‘ã‚¿ãƒ¼ãƒ³è¨­å®š -->
        <div id="weeklySettings">
          <label class="form-label">æ›œæ—¥é¸æŠ <span class="text-danger">*</span></label>
          <div class="row">
            <div class="col-md-12">
              <div class="btn-group-toggle d-flex flex-wrap gap-2" data-toggle="buttons">
                <label class="btn btn-outline-primary" data-day="1">
                  <input type="checkbox" value="1"> æœˆ
                </label>
                <label class="btn btn-outline-primary" data-day="2">
                  <input type="checkbox" value="2"> ç«
                </label>
                <label class="btn btn-outline-primary" data-day="3">
                  <input type="checkbox" value="3"> æ°´
                </label>
                <label class="btn btn-outline-primary" data-day="4">
                  <input type="checkbox" value="4"> æœ¨
                </label>
                <label class="btn btn-outline-primary" data-day="5">
                  <input type="checkbox" value="5"> é‡‘
                </label>
                <label class="btn btn-outline-primary" data-day="6">
                  <input type="checkbox" value="6"> åœŸ
                </label>
                <label class="btn btn-outline-primary" data-day="0">
                  <input type="checkbox" value="0"> æ—¥
                </label>
              </div>
              <div class="form-text">è¤‡æ•°é¸æŠå¯èƒ½</div>
            </div>
          </div>
        </div>

        <!-- æ¯æœˆãƒ‘ã‚¿ãƒ¼ãƒ³è¨­å®š -->
        <div id="monthlySettings" style="display: none;">
          <div class="row">
            <div class="col-md-6">
              <label for="monthlyDay" class="form-label">æ¯æœˆã®æ—¥ä»˜ <span class="text-danger">*</span></label>
              <select class="form-select" id="monthlyDay">
                <% (1..31).each do |day| %>
                  <option value="<%= day %>"><%= day %>æ—¥</option>
                <% end %>
              </select>
              <div class="form-text">å­˜åœ¨ã—ãªã„æ—¥ä»˜ï¼ˆ2æœˆ30æ—¥ãªã©ï¼‰ã¯è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™</div>
            </div>
          </div>
        </div>

        <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ‘ã‚¿ãƒ¼ãƒ³è¨­å®š -->
        <div id="customSettings" style="display: none;">
          <label for="customDates" class="form-label">ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜ <span class="text-danger">*</span></label>
          <textarea class="form-control" id="customDates" rows="4" 
                    placeholder="æ—¥ä»˜ã‚’1è¡Œãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹ï¼š&#10;2025-01-15&#10;2025-01-22&#10;2025-01-29"></textarea>
          <div class="form-text">YYYY-MM-DDå½¢å¼ã§1è¡Œãšã¤å…¥åŠ›ã—ã¦ãã ã•ã„</div>
        </div>
      </div>
    </div>

    <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="card mb-4">
      <div class="card-header bg-info text-white">
        <h5 class="mb-0"><i class="fas fa-eye me-2"></i>ä½œæˆäºˆå®šã®äºˆç´„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h5>
      </div>
      <div class="card-body">
        <div id="previewSection">
          <p class="text-muted">ä¸Šè¨˜ã®è¨­å®šã‚’å®Œäº†ã™ã‚‹ã¨ã€ä½œæˆäºˆå®šã®äºˆç´„ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
        </div>
        <div class="mt-3">
          <button type="button" class="btn btn-outline-info" id="generatePreviewBtn">
            <i class="fas fa-refresh me-1"></i>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
          </button>
        </div>
      </div>
    </div>

    <!-- ä½œæˆãƒœã‚¿ãƒ³ -->
    <div class="text-center">
      <button type="submit" class="btn btn-success btn-lg" id="createBulkBtn">
        <i class="fas fa-calendar-plus me-2"></i>ä¸€æ‹¬ä½œæˆå®Ÿè¡Œ
      </button>
      <button type="button" class="btn btn-secondary btn-lg ms-3" onclick="window.history.back()">
        <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  initializeBulkReservation();
});

function initializeBulkReservation() {
  console.log('ğŸš€ Initializing bulk reservation form');
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
  loadUsers();
  generateTimeOptions();
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  setupEventListeners();
  
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜ã‚’è¨­å®š
  setDefaultDates();
}

function loadUsers() {
  fetch('/admin/users.json')
    .then(response => response.json())
    .then(users => {
      const userSelect = document.getElementById('userId');
      users.forEach(user => {
        const option = document.createElement('option');
        option.value = user.id;
        option.textContent = user.name || `ID: ${user.id}`;
        userSelect.appendChild(option);
      });
    })
    .catch(error => {
      console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
    });
}

function generateTimeOptions() {
  const timeSelect = document.getElementById('startTime');
  
  // 10:00ã‹ã‚‰19:50ã¾ã§10åˆ†åˆ»ã¿ã§ç”Ÿæˆ
  for (let hour = 10; hour < 20; hour++) {
    for (let minute = 0; minute < 60; minute += 10) {
      if (hour === 19 && minute > 50) break;
      
      const timeValue = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
      const option = document.createElement('option');
      option.value = timeValue;
      option.textContent = timeValue;
      timeSelect.appendChild(option);
    }
  }
}

function setDefaultDates() {
  const today = new Date();
  const nextWeek = new Date(today);
  nextWeek.setDate(today.getDate() + 7);
  
  const threeMonthsLater = new Date(today);
  threeMonthsLater.setMonth(today.getMonth() + 3);
  
  document.getElementById('startDate').value = nextWeek.toISOString().split('T')[0];
  document.getElementById('endDate').value = threeMonthsLater.toISOString().split('T')[0];
}

function setupEventListeners() {
  // ãƒ‘ã‚¿ãƒ¼ãƒ³å¤‰æ›´æ™‚ã®è¨­å®šè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('input[name="pattern"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const weeklySettings = document.getElementById('weeklySettings');
      const monthlySettings = document.getElementById('monthlySettings');
      const customSettings = document.getElementById('customSettings');
      const dateRangeSection = document.getElementById('dateRangeSection');
      
      // å…¨ã¦éè¡¨ç¤º
      weeklySettings.style.display = 'none';
      monthlySettings.style.display = 'none';
      customSettings.style.display = 'none';
      
      // é¸æŠã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ã¦è¡¨ç¤º
      switch(this.value) {
        case 'weekly':
          weeklySettings.style.display = 'block';
          dateRangeSection.style.display = 'block';
          break;
        case 'monthly':
          monthlySettings.style.display = 'block';
          dateRangeSection.style.display = 'block';
          break;
        case 'custom':
          customSettings.style.display = 'block';
          dateRangeSection.style.display = 'none';
          break;
      }
    });
  });
  
  // æ›œæ—¥ãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
  document.querySelectorAll('.btn-group-toggle label').forEach(label => {
    label.addEventListener('click', function() {
      const checkbox = this.querySelector('input[type="checkbox"]');
      
      setTimeout(() => {
        if (checkbox.checked) {
          this.classList.add('active');
          this.classList.remove('btn-outline-primary');
          this.classList.add('btn-primary');
        } else {
          this.classList.remove('active');
          this.classList.remove('btn-primary');
          this.classList.add('btn-outline-primary');
        }
      }, 10);
    });
  });
  
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°ãƒœã‚¿ãƒ³
  document.getElementById('generatePreviewBtn').addEventListener('click', generatePreview);
  
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
  document.getElementById('bulkReservationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    submitBulkReservation();
  });
}

function generatePreview() {
  console.log('ğŸ” Generating preview...');
  
  const pattern = document.querySelector('input[name="pattern"]:checked').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const startTime = document.getElementById('startTime').value;
  
  if (!startTime) {
    alert('é–‹å§‹æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
    return;
  }
  
  let dates = [];
  
  try {
    switch(pattern) {
      case 'weekly':
        dates = generateWeeklyDates(startDate, endDate);
        break;
      case 'monthly':
        dates = generateMonthlyDates(startDate, endDate);
        break;
      case 'custom':
        dates = generateCustomDates();
        break;
    }
    
    displayPreview(dates, startTime);
    
  } catch (error) {
    console.error('Preview generation error:', error);
    alert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
  }
}

function generateWeeklyDates(startDate, endDate) {
  const selectedWeekdays = Array.from(document.querySelectorAll('.btn-group-toggle input:checked'))
    .map(input => parseInt(input.value));
  
  if (selectedWeekdays.length === 0) {
    throw new Error('æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
  }
  
  const dates = [];
  const start = new Date(startDate);
  const end = new Date(endDate);
  let current = new Date(start);
  
  while (current <= end) {
    if (selectedWeekdays.includes(current.getDay())) {
      dates.push(new Date(current));
    }
    current.setDate(current.getDate() + 1);
  }
  
  return dates;
}

function generateMonthlyDates(startDate, endDate) {
  const monthlyDay = parseInt(document.getElementById('monthlyDay').value);
  const dates = [];
  const start = new Date(startDate);
  const end = new Date(endDate);
  
  let current = new Date(start.getFullYear(), start.getMonth(), 1);
  
  while (current <= end) {
    try {
      const targetDate = new Date(current.getFullYear(), current.getMonth(), monthlyDay);
      if (targetDate >= start && targetDate <= end) {
        dates.push(targetDate);
      }
    } catch (error) {
      // å­˜åœ¨ã—ãªã„æ—¥ä»˜ã¯ã‚¹ã‚­ãƒƒãƒ—
    }
    current.setMonth(current.getMonth() + 1);
  }
  
  return dates;
}

function generateCustomDates() {
  const customDatesText = document.getElementById('customDates').value.trim();
  if (!customDatesText) {
    throw new Error('ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
  }
  
  const dates = [];
  const lines = customDatesText.split('\n');
  
  lines.forEach(line => {
    const dateStr = line.trim();
    if (dateStr) {
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) {
          throw new Error(`ç„¡åŠ¹ãªæ—¥ä»˜å½¢å¼: ${dateStr}`);
        }
        dates.push(date);
      } catch (error) {
        throw new Error(`æ—¥ä»˜è§£æã‚¨ãƒ©ãƒ¼: ${dateStr}`);
      }
    }
  });
  
  return dates.sort((a, b) => a - b);
}

function displayPreview(dates, startTime) {
  const previewSection = document.getElementById('previewSection');
  const course = document.getElementById('course').value;
  const duration = getDurationFromCourse(course);
  
  if (dates.length === 0) {
    previewSection.innerHTML = '<p class="text-warning">ä½œæˆã•ã‚Œã‚‹äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
    return;
  }
  
  if (dates.length > 50) {
    previewSection.innerHTML = `<p class="text-danger">ä½œæˆäºˆå®šã®äºˆç´„ãŒ${dates.length}ä»¶ã¨å¤šã™ãã¾ã™ã€‚æœŸé–“ã‚’çŸ­ç¸®ã—ã¦ãã ã•ã„ã€‚</p>`;
    return;
  }
  
  let html = `
    <div class="alert alert-info">
      <strong>ä½œæˆäºˆå®š: ${dates.length}ä»¶ã®äºˆç´„</strong>
    </div>
    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
      <table class="table table-sm table-striped">
        <thead class="table-dark sticky-top">
          <tr>
            <th>æ—¥ä»˜</th>
            <th>æ›œæ—¥</th>
            <th>æ™‚é–“</th>
            <th>ã‚³ãƒ¼ã‚¹</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  dates.forEach(date => {
    const dateStr = date.toLocaleDateString('ja-JP');
    const dayOfWeek = date.toLocaleDateString('ja-JP', { weekday: 'short' });
    const endTime = calculateEndTime(startTime, duration);
    
    html += `
      <tr>
        <td>${dateStr}</td>
        <td>${dayOfWeek}</td>
        <td>${startTime} - ${endTime}</td>
        <td>${course}</td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
  `;
  
  previewSection.innerHTML = html;
}

function getDurationFromCourse(course) {
  switch(course) {
    case '40åˆ†': return 40;
    case '60åˆ†': return 60;
    case '80åˆ†': return 80;
    default: return 60;
  }
}

function calculateEndTime(startTime, duration) {
  const [hours, minutes] = startTime.split(':').map(Number);
  const start = new Date();
  start.setHours(hours, minutes, 0, 0);
  
  const end = new Date(start.getTime() + duration * 60000);
  return `${end.getHours().toString().padStart(2, '0')}:${end.getMinutes().toString().padStart(2, '0')}`;
}

function submitBulkReservation() {
  console.log('ğŸ“¤ Submitting bulk reservation...');
  
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!validateForm()) {
    return;
  }
  
  const formData = collectFormData();
  
  // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
  const submitBtn = document.getElementById('createBulkBtn');
  const originalText = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ä½œæˆä¸­...';
  
  fetch('/admin/reservations/bulk_create', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || '',
      'Accept': 'application/json'
    },
    body: JSON.stringify(formData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showMessage(data.message, 'success');
      setTimeout(() => {
        window.location.href = '/admin/reservations/calendar';
      }, 2000);
    } else {
      showMessage(data.error || 'ä¸€æ‹¬ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
    }
  })
  .catch(error => {
    console.error('Bulk creation error:', error);
    showMessage('ä¸€æ‹¬ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
  })
  .finally(() => {
    // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  });
}

function validateForm() {
  const errors = [];
  
  // åŸºæœ¬æƒ…å ±ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  if (!document.getElementById('userId').value) {
    errors.push('äºˆç´„è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
  }
  
  if (!document.getElementById('startTime').value) {
    errors.push('é–‹å§‹æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
  }
  
  const pattern = document.querySelector('input[name="pattern"]:checked').value;
  
  // ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  switch(pattern) {
    case 'weekly':
      if (!document.getElementById('startDate').value || !document.getElementById('endDate').value) {
        errors.push('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
      }
      
      const selectedWeekdays = document.querySelectorAll('.btn-group-toggle input:checked');
      if (selectedWeekdays.length === 0) {
        errors.push('æ›œæ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
      }
      break;
      
    case 'monthly':
      if (!document.getElementById('startDate').value || !document.getElementById('endDate').value) {
        errors.push('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
      }
      break;
      
    case 'custom':
      if (!document.getElementById('customDates').value.trim()) {
        errors.push('ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      }
      break;
  }
  
  // æ—¥ä»˜ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
  if (pattern !== 'custom') {
    const startDate = new Date(document.getElementById('startDate').value);
    const endDate = new Date(document.getElementById('endDate').value);
    
    if (startDate >= endDate) {
      errors.push('çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ã‚ˆã‚Šå¾Œã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
    }
    
    if (startDate < new Date()) {
      errors.push('é–‹å§‹æ—¥ã¯ä»Šæ—¥ä»¥é™ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
    }
  }
  
  if (errors.length > 0) {
    showMessage('å…¥åŠ›ã‚¨ãƒ©ãƒ¼:\n' + errors.join('\n'), 'danger');
    return false;
  }
  
  return true;
}

function collectFormData() {
  const pattern = document.querySelector('input[name="pattern"]:checked').value;
  
  const formData = {
    bulk_reservation: {
      base_reservation: {
        user_id: document.getElementById('userId').value,
        course: document.getElementById('course').value,
        note: document.getElementById('note').value,
        status: document.getElementById('status').value
      },
      schedule: {
        pattern: pattern,
        start_time: document.getElementById('startTime').value
      }
    }
  };
  
  // ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ¥ã®è¨­å®šã‚’è¿½åŠ 
  switch(pattern) {
    case 'weekly':
      formData.bulk_reservation.schedule.start_date = document.getElementById('startDate').value;
      formData.bulk_reservation.schedule.end_date = document.getElementById('endDate').value;
      formData.bulk_reservation.schedule.weekdays = Array.from(
        document.querySelectorAll('.btn-group-toggle input:checked')
      ).map(input => input.value);
      break;
      
    case 'monthly':
      formData.bulk_reservation.schedule.start_date = document.getElementById('startDate').value;
      formData.bulk_reservation.schedule.end_date = document.getElementById('endDate').value;
      formData.bulk_reservation.schedule.monthly_day = document.getElementById('monthlyDay').value;
      break;
      
    case 'custom':
      const customDates = document.getElementById('customDates').value
        .split('\n')
        .map(line => line.trim())
        .filter(line => line);
      formData.bulk_reservation.schedule.custom_dates = customDates;
      break;
  }
  
  return formData;
}

function showMessage(message, type) {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  const flashContainer = document.getElementById('flash');
  flashContainer.innerHTML = '';
  flashContainer.appendChild(alertDiv);
  
  // è‡ªå‹•çš„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¶ˆå»
  setTimeout(() => {
    if (alertDiv.parentNode) {
      alertDiv.parentNode.removeChild(alertDiv);
    }
  }, 5000);
}
</script>

<style>
.btn-group-toggle label {
  transition: all 0.2s ease;
}

.btn-group-toggle label:hover {
  transform: translateY(-1px);
}

.card-header {
  position: sticky;
  top: 0;
  z-index: 1020;
}

.table-responsive {
  border: 1px solid #dee2e6;
  border-radius: 0.375rem;
}

.sticky-top {
  position: sticky;
  top: 0;
  z-index: 1010;
}

#previewSection {
  min-height: 100px;
}

.alert {
  margin-bottom: 1rem;
}

.btn-lg {
  padding: 0.75rem 2rem;
  font-size: 1.1rem;
}
</style>