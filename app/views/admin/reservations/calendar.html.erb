<% content_for :title, "äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ - Mobilis" %>

<div class="calendar-container">
  <div class="calendar-header">
<div class="container-fluid">
      <div class="calendar-toolbar">
                <!-- å°ã•ãªæœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ã‚¿ã‚¤ãƒˆãƒ«ã®å·¦å´ã«é…ç½® -->
        <div class="calendar-mini-calendar">
          <div id="monthCalendar" style="width: 200px; height: 100px;"></div>
        </div>
        
        <div class="calendar-title">
          <i class="fas fa-calendar-alt me-2"></i>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
        </div>
        
        <div class="calendar-actions">
          <div class="d-flex flex-column gap-2">
            <a href="<%= admin_reservations_path %>" class="btn btn-primary btn-lg" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.15); font-weight: 600;">
              <i class="fas fa-list me-2"></i>ğŸ“‹ ä»Šæ—¥ã®äºˆç´„ä¸€è¦§
            </a>
            <button id="newReservationBtn" class="btn btn-success">
              <i class="fas fa-plus me-1"></i>æ–°è¦äºˆç´„
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="openCancelledHistoryModal()">
              <i class="fas fa-times-circle me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´
            </button>
          </div>
        </div>
    </div>
    </div>
  </div>
  
  <div class="container-fluid">
    <div id="calendar"></div>
  </div>
</div>

<!-- äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reservationModalLabel">
          <i class="fas fa-calendar-plus me-2"></i>äºˆç´„ä½œæˆãƒ»ç·¨é›†
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="reservationForm">
          <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
          <input type="hidden" id="currentReservationId" value="">
          <input type="hidden" id="selectedUserId" value="">
          
          <!-- é¡§å®¢é¸æŠãƒ»æ¤œç´¢ -->
          <div class="row mb-3">
            <div class="col-12">
              <label for="customerSearch" class="form-label">é¡§å®¢æ¤œç´¢ãƒ»é¸æŠ *</label>
              <div class="position-relative">
                                 <input type="text" class="form-control" id="customerSearch" 
                        placeholder="é¡§å®¢åã€ãƒ•ãƒªã‚¬ãƒŠã€é›»è©±ç•ªå·ã§æ¤œç´¢...">
                <div id="customerSearchResults" class="position-absolute w-100 bg-white border rounded shadow-sm" 
                     style="z-index: 1050; max-height: 200px; overflow-y: auto; display: none;">
                  <!-- æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤º -->
            </div>
              </div>
          </div>
        </div>
        
          <!-- é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã®è¡¨ç¤º -->
          <div id="selectedCustomerInfo" class="row mb-3" style="display: none;">
            <div class="col-12">
              <div class="alert alert-info">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="alert-heading mb-1">
                      <i class="fas fa-user me-1"></i>
                      <span id="selectedCustomerName"></span>
                    </h6>
                    <small class="text-muted">
                      <span id="selectedCustomerDetails"></span>
                    </small>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="clearCustomerBtn">
                    <i class="fas fa-times"></i> å¤‰æ›´
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- æ–°è¦é¡§å®¢ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ—¢å­˜é¡§å®¢ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰ -->
          <div id="newCustomerForm" class="row mb-3" style="display: none;">
            <div class="col-12">
              <div class="alert alert-warning">
                <h6 class="alert-heading">
                  <i class="fas fa-user-plus me-1"></i>æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²
                </h6>
                <p class="mb-2">è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚</p>
              </div>
            </div>
            
            <div class="col-md-6">
              <label for="newCustomerName" class="form-label">é¡§å®¢å *</label>
              <input type="text" class="form-control" id="newCustomerName" required>
            </div>
            <div class="col-md-6">
              <label for="newCustomerPhone" class="form-label">é›»è©±ç•ªå·</label>
              <input type="tel" class="form-control" id="newCustomerPhone">
            </div>
            
            <div class="col-md-6 mt-2">
              <label for="newCustomerKana" class="form-label">ãƒ•ãƒªã‚¬ãƒŠ</label>
              <input type="text" class="form-control" id="newCustomerKana">
            </div>
            <div class="col-md-6 mt-2">
              <label for="newCustomerEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
              <input type="email" class="form-control" id="newCustomerEmail">
            </div>
          </div>
          
          <!-- äºˆç´„æƒ…å ±ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰ -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationDate" class="form-label">æ—¥ä»˜ *</label>
              <input type="date" class="form-control" id="reservationDate" required>
            </div>
            <div class="col-md-6">
              <label for="reservationTime" class="form-label">æ™‚é–“ *</label>
              <input type="time" class="form-control" id="reservationTime" min="10:00" max="21:00" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationCourse" class="form-label">ã‚³ãƒ¼ã‚¹ *</label>
              <select class="form-select" id="reservationCourse" required>
                <option value="">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠ</option>
                <option value="40åˆ†ã‚³ãƒ¼ã‚¹">40åˆ†ã‚³ãƒ¼ã‚¹ (Â¥8,000)</option>
                <option value="60åˆ†ã‚³ãƒ¼ã‚¹">60åˆ†ã‚³ãƒ¼ã‚¹ (Â¥12,000)</option>
                <option value="80åˆ†ã‚³ãƒ¼ã‚¹">80åˆ†ã‚³ãƒ¼ã‚¹ (Â¥16,000)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="reservationStatus" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <select class="form-select" id="reservationStatus">
                <option value="tentative">ä»®äºˆç´„</option>
                <option value="confirmed" selected>ç¢ºå®š</option>
                <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                <option value="completed">å®Œäº†</option>
                <option value="no_show">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
              </select>
            </div>
          </div>
          
          <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®š -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationInterval" class="form-label">æ•´ç†æ™‚é–“ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼‰</label>
              <select class="form-select" id="reservationInterval">
                <option value="">ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä½¿ç”¨</option>
                <option value="0">0åˆ†ï¼ˆæ•´ç†æ™‚é–“ãªã—ï¼‰</option>
                <option value="5">5åˆ†</option>
                <option value="10">10åˆ†</option>
                <option value="15">15åˆ†</option>
                <option value="20">20åˆ†</option>
                <option value="30">30åˆ†</option>
                <option value="45">45åˆ†</option>
                <option value="60">60åˆ†</option>
              </select>
              <small class="text-muted">å€‹åˆ¥ã«æ•´ç†æ™‚é–“ã‚’è¨­å®šã§ãã¾ã™</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">ç¾åœ¨ã®è¨­å®š</label>
              <div id="currentIntervalInfo" class="form-control-plaintext">
                <span class="badge bg-primary">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: 15åˆ†</span>
              </div>
            </div>
          </div>
          
          <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
          <div class="row mb-3" id="cancellationReasonRow" style="display: none;">
            <div class="col-12">
              <label for="cancellationReason" class="form-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”± <span class="text-danger">*</span></label>
              <textarea class="form-control" id="cancellationReason" rows="2" placeholder="ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>
          </div>
          
          <!-- ãƒã‚±ãƒƒãƒˆæƒ…å ± -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">ãƒã‚±ãƒƒãƒˆæƒ…å ±</label>
              <div id="ticketInfo" class="border rounded p-3 bg-light">
                <div class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
              </div>
            </div>
          </div>
          
          <!-- ãƒ¡ãƒ¢ -->
          <div class="row mb-3">
            <div class="col-12">
              <label for="reservationMemo" class="form-label">ãƒ¡ãƒ¢ãƒ»æ³¨æ„äº‹é …</label>
              <textarea class="form-control" id="reservationMemo" rows="3" placeholder="äºˆç´„ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚„æ³¨æ„äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="button" class="btn btn-danger" id="deleteReservationBtn" style="display: none;">
            <i class="fas fa-trash me-1"></i>å‰Šé™¤
          </button>
        <button type="button" class="btn btn-primary" id="saveReservationBtn">
            <i class="fas fa-save me-1"></i>ä¿å­˜
          </button>
      </div>
    </div>
  </div>
</div>

<!-- é¡§å®¢å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="customerHistoryModal" tabindex="-1" aria-labelledby="customerHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerHistoryModalLabel">
          <i class="fas fa-history me-2"></i>é¡§å®¢å±¥æ­´
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="customerHistoryContent">
          <!-- é¡§å®¢å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="cancelledHistoryModal" tabindex="-1" aria-labelledby="cancelledHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelledHistoryModalLabel">
          <i class="fas fa-times-circle text-danger me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆãƒ»å±¥æ­´
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-danger">
              <div class="card-body text-center">
                <h3 class="text-danger mb-0" id="modalCancelledCount">0</h3>
                <small class="text-muted">ä»Šæœˆã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ•°</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-warning">
              <div class="card-body text-center">
                <h3 class="text-warning mb-0" id="modalCancelledRate">0%</h3>
                <small class="text-muted">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç‡</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-info">
              <div class="card-body text-center">
                <h3 class="text-info mb-0" id="modalTotalReservations">0</h3>
                <small class="text-muted">ä»Šæœˆã®ç·äºˆç´„æ•°</small>
              </div>
            </div>
          </div>
        </div>
        <div id="modalCancelledHistory">
          <div class="text-muted text-center py-3">
            <i class="fas fa-info-circle me-1"></i>
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* ==============================================
   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
   ============================================== */
body {
  background: #ffffff;
  min-height: 100vh;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.calendar-container {
  padding: 0;
  margin: 0;
  position: relative;
}

.calendar-header {
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border-bottom: 3px solid #e9ecef;
  padding: 20px 0;
  box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼å†…ã®ãƒŸãƒ‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.calendar-mini-calendar {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
}

.calendar-mini-calendar .fc {
  font-size: 0.8rem !important;
  border: 1px solid #e2e8f0 !important;
  border-radius: 8px !important;
  overflow: hidden !important;
}

.calendar-mini-calendar .fc-daygrid-day {
  cursor: pointer;
  transition: background-color 0.2s ease;
  padding: 0px !important;
  border: none !important;
  min-height: 5px !important;
}

.calendar-mini-calendar .fc-daygrid-day:hover {
  background-color: #f8f9fa !important;
}

.calendar-mini-calendar .fc-daygrid-day.fc-day-today {
  background-color: #e3f2fd !important;
  border-radius: 4px !important;
}

.calendar-mini-calendar .fc-daygrid-day.fc-day-selected {
  background-color: #007bff !important;
  color: white !important;
  border-radius: 4px !important;
}

.calendar-mini-calendar .fc-daygrid-day.fc-day-selected:hover {
  background-color: #0056b3 !important;
}

.calendar-mini-calendar .fc-daygrid-day-number {
  font-size: 0.6rem !important;
  padding: 0px !important;
  font-weight: 500 !important;
  line-height: 1 !important;
}

.calendar-mini-calendar .fc-col-header-cell {
  padding: 0px !important;
  font-size: 0.55rem !important;
  font-weight: 600 !important;
  background-color: #f8f9fa !important;
  border-bottom: 1px solid #e2e8f0 !important;
  min-height: 5px !important;
}

.calendar-mini-calendar .fc-daygrid-day.fc-day-other {
  color: #cbd5e0 !important;
}

.calendar-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 0;
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 30px;
}

.calendar-nav {
  display: flex;
  gap: 15px;
  align-items: center;
  flex: 1;
  margin-right: 0;
}

.calendar-nav button {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  position: relative;
  overflow: hidden;
}

.calendar-nav button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.calendar-nav button:hover::before {
  left: 100%;
}

.calendar-nav button:hover {
  background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.calendar-title {
  font-size: 2.2rem;
  font-weight: 800;
  color: #1e293b;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  flex: 2;
  text-align: center;
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin: 0;
  padding: 0;
}

.calendar-actions {
  display: flex;
  gap: 15px;
  align-items: center;
  flex: 1;
  justify-content: flex-end;
  margin-left: 0;
}

.btn-new-reservation {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
  border: none;
  padding: 14px 28px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  position: relative;
  overflow: hidden;
}

.btn-new-reservation::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.btn-new-reservation:hover::before {
  left: 100%;
}

.btn-new-reservation:hover {
  background: linear-gradient(135deg, #20c997 0%, #1ea085 100%);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.btn-today-reservations {
  background: linear-gradient(135deg, #fd7e14 0%, #e55a00 100%);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  position: relative;
  overflow: hidden;
}

.btn-today-reservations::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.btn-today-reservations:hover::before {
  left: 100%;
}

.btn-today-reservations:hover {
  background: linear-gradient(135deg, #e55a00 0%, #cc4a00 100%);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

.btn-cancellation-stats {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
  border: none;
  padding: 12px 20px;
  border-radius: 12px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  position: relative;
  overflow: hidden;
}

.btn-cancellation-stats::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.btn-cancellation-stats:hover::before {
  left: 100%;
}

.btn-cancellation-stats:hover {
  background: linear-gradient(135deg, #c82333 0%, #b02130 100%);
  transform: translateY(-3px);
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

/* ==============================================
   FullCalendarã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  border: 2px solid #e2e8f0;
  margin: 30px auto;
  max-width: 1400px;
  position: relative;
  overflow: hidden;
}

.fc::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
  pointer-events: none;
  z-index: 1;
}

.fc-view-harness {
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  border-radius: 18px;
  position: relative;
  z-index: 2;
}

.fc-toolbar {
  padding: 25px 30px;
  border-bottom: 2px solid #f1f5f9;
  background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
  position: relative;
  z-index: 2;
}

.fc-toolbar::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
}

.fc-toolbar-title {
  font-size: 2rem;
  font-weight: 800;
  color: #1e293b;
  text-shadow: 0 2px 4px rgba(0,0,0,0.1);
  background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.fc-button {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
  border: none !important;
  color: white !important;
  border-radius: 12px !important;
  font-weight: 600 !important;
  padding: 12px 20px !important;
  transition: all 0.3s ease !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
  position: relative !important;
  overflow: hidden !important;
}

.fc-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.fc-button:hover::before {
  left: 100%;
}

.fc-button:hover {
  background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
  transform: translateY(-3px) !important;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2) !important;
}

.fc-button:focus {
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

.fc-button-active {
  background: linear-gradient(135deg, #0056b3 0%, #004085 100%) !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
}

/* ==============================================
   10åˆ†é–“éš”ã‚¹ãƒ­ãƒƒãƒˆã®é«˜ã•å›ºå®š
   ============================================== */
        .fc-timegrid-slot {
    height: 30px !important;
    min-height: 30px !important;
    max-height: 30px !important;
    border-bottom: 1px solid #e2e8f0 !important;
  }

.fc-timegrid-slots table {
  height: 100% !important;
}

/* 30åˆ†ã”ã¨ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ãƒ©ã‚¤ãƒ³ */
.fc-timegrid-slot[data-time$=":00"] {
  border-bottom: 2px solid #cbd5e0 !important;
}

.fc-timegrid-slot[data-time$=":30"] {
  border-bottom: 1.5px solid #e2e8f0 !important;
}

/* æ™‚é–“è»¸ã®èª¿æ•´ */
.fc-timegrid-axis-frame {
  height: 30px !important;
  min-height: 30px !important;
}
      
        .fc-timegrid-slot-label {
    font-size: 0.75rem !important;
    padding: 2px 4px !important;
    color: #4a5568 !important;
  }
  


/* ==============================================
   äºˆç´„ã‚¤ãƒ™ãƒ³ãƒˆã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event {
  border-radius: 8px !important;
  font-size: 0.8rem !important;
  font-weight: 600 !important;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
  transition: all 0.3s ease !important;
  border: 2px solid transparent !important;
  margin: 1px !important;
  overflow: hidden !important;
  position: relative !important;
  height: auto !important;
}

.fc-timegrid-event::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
  pointer-events: none;
  z-index: 1;
}

.fc-timegrid-event:hover {
  box-shadow: 0 4px 16px rgba(0,0,0,0.25) !important;
  transform: translateX(2px) !important;
  z-index: 1000 !important;
}

/* ==============================================
   å…¨ã‚³ãƒ¼ã‚¹å¯¾å¿œã®é«˜ã•è¨­å®šï¼ˆ30px baseï¼‰
   ============================================== */

/* 40åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="40"] {
  min-height: 120px !important;
  height: 120px !important;
}

.fc-timegrid-event[data-duration="45"] {
  min-height: 135px !important;
  height: 135px !important;
}

.fc-timegrid-event[data-duration="50"] {
  min-height: 150px !important;
  height: 150px !important;
}

.fc-timegrid-event[data-duration="55"] {
  min-height: 165px !important;
  height: 165px !important;
}

/* 60åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="60"] {
  min-height: 180px !important;
  height: 180px !important;
}

.fc-timegrid-event[data-duration="65"] {
  min-height: 195px !important;
  height: 195px !important;
}

.fc-timegrid-event[data-duration="70"] {
  min-height: 210px !important;
  height: 210px !important;
}

.fc-timegrid-event[data-duration="75"] {
  min-height: 225px !important;
  height: 225px !important;
}

.fc-timegrid-event[data-duration="80"] {
  min-height: 240px !important;
  height: 240px !important;
}

/* 80åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="85"] {
  min-height: 340px !important;
  height: 340px !important;
}

.fc-timegrid-event[data-duration="90"] {
  min-height: 360px !important;
  height: 360px !important;
}

.fc-timegrid-event[data-duration="95"] {
  min-height: 380px !important;
  height: 380px !important;
}

.fc-timegrid-event[data-duration="100"] {
  min-height: 400px !important;
  height: 400px !important;
}

/* ãã®ä»–ã®ã‚«ã‚¹ã‚¿ãƒ æ™‚é–“ */
.fc-timegrid-event[data-duration="105"] {
  min-height: 420px !important;
  height: 420px !important;
}

.fc-timegrid-event[data-duration="110"] {
  min-height: 440px !important;
  height: 440px !important;
}

.fc-timegrid-event[data-duration="120"] {
  min-height: 480px !important;
  height: 480px !important;
}

/* ==============================================
   ã‚¿ãƒ–å½¢å¼ã®ã‚¤ãƒ™ãƒ³ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event .event-tab-container {
  height: 100% !important;
  display: flex !important;
  flex-direction: column !important;
  width: 100% !important;
}

.fc-timegrid-event .event-tab {
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: 600 !important;
  text-align: center !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  white-space: nowrap !important;
  transition: all 0.2s ease !important;
  border: none !important;
}

.fc-timegrid-event .event-tab.course {
  background: inherit !important;
  color: inherit !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
}

.fc-timegrid-event .event-tab.interval {
        color: white !important;
        font-weight: 500 !important;
}

.fc-timegrid-event .event-tab.interval.individual {
  background-color: #fd7e14 !important;
  font-weight: 600 !important;
}

.fc-timegrid-event .event-tab.interval.system {
  background-color: #6c757d !important;
}

/* ==============================================
   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®è‰²åˆ†ã‘
   ============================================== */
.fc-timegrid-event.confirmed {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
  border: 2px solid #28a745 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3) !important;
}

.fc-timegrid-event.tentative {
  background: linear-gradient(135deg, #ffc107 0%, #ffb84d 100%) !important;
        border: 2px solid #ffc107 !important;
        color: #212529 !important;
  box-shadow: 0 4px 16px rgba(255, 193, 7, 0.3) !important;
}

.fc-timegrid-event.cancelled {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
  border: 2px solid #dc3545 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(220, 53, 69, 0.3) !important;
}

.fc-timegrid-event.completed {
  background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%) !important;
  border: 2px solid #6f42c1 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(111, 66, 193, 0.3) !important;
}

.fc-timegrid-event.no_show {
  background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
  border: 2px solid #6c757d !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(108, 117, 125, 0.3) !important;
}

.fc-timegrid-event.break {
  background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
  border: 2px solid #17a2b8 !important;
  color: white !important;
  box-shadow: 0 4px 16px rgba(23, 162, 184, 0.3) !important;
}

/* ==============================================
   ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¿ã‚¤ãƒ—åˆ¥ã®è¦–è¦šçš„åŒºåˆ¥
   ============================================== */
.fc-timegrid-event.has-interval .event-tab.interval.individual::before {
  content: "âš™ï¸ ";
  font-size: 0.6em;
  margin-right: 2px;
}

.fc-timegrid-event.has-interval .event-tab.interval.system::before {
  content: "ğŸ”§ ";
  font-size: 0.6em;
  margin-right: 2px;
}

/* ãƒ›ãƒãƒ¼æ™‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±è¡¨ç¤º */
.fc-timegrid-event.has-interval:hover::after {
  content: attr(data-interval-info);
  position: absolute;
  top: -30px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.9);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  white-space: nowrap;
  z-index: 10000;
  pointer-events: none;
}

/* ==============================================
   ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
   ============================================== */
@media (max-width: 1024px) {
  .calendar-toolbar {
    gap: 20px;
    padding: 0 20px;
  }
  
  .calendar-title {
    font-size: 1.8rem;
  }
  
  .fc {
    margin: 20px auto;
    border-radius: 16px;
  }
  
  .fc-toolbar {
    padding: 20px 25px;
  }
  
  .fc-toolbar-title {
    font-size: 1.6rem;
  }
}

@media (max-width: 768px) {
  .calendar-toolbar {
    flex-direction: column;
    gap: 15px;
    padding: 0 15px;
  }
  
  .calendar-nav {
    order: 1;
  }
  
  .calendar-title {
    order: 2;
    font-size: 1.4rem;
  }
  
  .calendar-actions {
    order: 3;
  }

  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 10px 16px;
    font-size: 0.9rem;
  }

  /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚¹ãƒ­ãƒƒãƒˆé«˜ã• (35px base) */
  .fc-timegrid-slot {
    height: 35px !important;
    min-height: 35px !important;
    max-height: 35px !important;
  }
  
  .fc-timegrid-axis-frame {
    height: 35px !important;
    min-height: 35px !important;
  }
  
  /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®é«˜ã•èª¿æ•´ */
  .fc-timegrid-event[data-duration="40"] { height: 140px !important; min-height: 140px !important; }
  .fc-timegrid-event[data-duration="45"] { height: 157px !important; min-height: 157px !important; }
  .fc-timegrid-event[data-duration="50"] { height: 175px !important; min-height: 175px !important; }
  .fc-timegrid-event[data-duration="55"] { height: 192px !important; min-height: 192px !important; }
  .fc-timegrid-event[data-duration="60"] { height: 210px !important; min-height: 210px !important; }
  .fc-timegrid-event[data-duration="65"] { height: 227px !important; min-height: 227px !important; }
  .fc-timegrid-event[data-duration="70"] { height: 245px !important; min-height: 245px !important; }
  .fc-timegrid-event[data-duration="75"] { height: 262px !important; min-height: 262px !important; }
  .fc-timegrid-event[data-duration="80"] { height: 280px !important; min-height: 280px !important; }
  .fc-timegrid-event[data-duration="85"] { height: 297px !important; min-height: 297px !important; }
  .fc-timegrid-event[data-duration="90"] { height: 315px !important; min-height: 315px !important; }
  .fc-timegrid-event[data-duration="95"] { height: 332px !important; min-height: 332px !important; }
  .fc-timegrid-event[data-duration="100"] { height: 350px !important; min-height: 350px !important; }
  
  .fc-timegrid-event .event-tab {
    font-size: 0.7rem !important;
    padding: 1px 2px !important;
  }
  
  .fc {
    margin: 15px auto;
    border-radius: 12px;
  }
  
  .fc-toolbar {
    padding: 15px 20px;
  }
  
  .fc-toolbar-title {
    font-size: 1.4rem;
  }
}

@media (max-width: 480px) {
  .calendar-toolbar {
    gap: 10px;
    padding: 0 10px;
  }
  
  .calendar-title {
    font-size: 1.2rem;
  }
  
  .btn-new-reservation,
  .btn-today-reservations,
  .btn-cancellation-stats {
    padding: 8px 12px;
    font-size: 0.8rem;
  }
  
  /* å°ç”»é¢ç”¨ã®ã‚¹ãƒ­ãƒƒãƒˆé«˜ã• (30px base) */
  .fc-timegrid-slot {
    height: 30px !important;
    min-height: 30px !important;
    max-height: 30px !important;
  }
  
  .fc-timegrid-axis-frame {
    height: 30px !important;
    min-height: 30px !important;
  }
  
  /* å°ç”»é¢ç”¨ã®é«˜ã•èª¿æ•´ */
  .fc-timegrid-event[data-duration="40"] { height: 120px !important; min-height: 120px !important; }
  .fc-timegrid-event[data-duration="45"] { height: 135px !important; min-height: 135px !important; }
  .fc-timegrid-event[data-duration="50"] { height: 150px !important; min-height: 150px !important; }
  .fc-timegrid-event[data-duration="55"] { height: 165px !important; min-height: 165px !important; }
  .fc-timegrid-event[data-duration="60"] { height: 180px !important; min-height: 180px !important; }
  .fc-timegrid-event[data-duration="65"] { height: 195px !important; min-height: 195px !important; }
  .fc-timegrid-event[data-duration="70"] { height: 210px !important; min-height: 210px !important; }
  .fc-timegrid-event[data-duration="75"] { height: 225px !important; min-height: 225px !important; }
  .fc-timegrid-event[data-duration="80"] { height: 240px !important; min-height: 240px !important; }
  .fc-timegrid-event[data-duration="85"] { height: 255px !important; min-height: 255px !important; }
  .fc-timegrid-event[data-duration="90"] { height: 270px !important; min-height: 270px !important; }
  .fc-timegrid-event[data-duration="95"] { height: 285px !important; min-height: 285px !important; }
  .fc-timegrid-event[data-duration="100"] { height: 300px !important; min-height: 300px !important; }
  
  .fc-timegrid-event .event-tab {
    font-size: 0.65rem !important;
    padding: 1px !important;
  }

  .fc {
    margin: 10px auto;
    border-radius: 10px;
  }
  
  .fc-toolbar {
    padding: 12px 15px;
  }
  
  .fc-toolbar-title {
    font-size: 1.2rem;
  }
}

/* ==============================================
   å‹•çš„é«˜ã•è¨­å®šã¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
   ============================================== */
.height-calculated {
  transition: height 0.3s ease !important;
}

/* ==============================================
   ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¨ä½“ã®ã‚°ãƒªãƒƒãƒ‰å¼·åŒ–
   ============================================== */
.fc-timegrid-col-frame {
  border-right: 1px solid #e2e8f0 !important;
}

/* ==============================================
   å–¶æ¥­æ™‚é–“å¤–ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-slot[data-time^="09"]:before,
.fc-timegrid-slot[data-time^="21"]:before,
.fc-timegrid-slot[data-time^="22"]:before {
  content: '';
      position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, 
    transparent 30%, 
    rgba(220, 53, 69, 0.1) 35%, 
    rgba(220, 53, 69, 0.1) 40%, 
    transparent 45%
  );
  pointer-events: none;
}

/* ==============================================
   ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
   ============================================== */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.calendar-container {
  animation: fadeInUp 0.6s ease-out;
}

.fc {
  animation: slideInUp 0.8s ease-out;
}

/* ==============================================
   ãƒ‡ãƒãƒƒã‚°ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆå¿…è¦ã«å¿œã˜ã¦å‰Šé™¤ï¼‰
   ============================================== */
.debug-events .fc-timegrid-event {
  border: 2px dashed red !important;
}

.debug-events .fc-timegrid-event .event-tab.course {
  border: 1px solid blue !important;
  background-color: rgba(0, 0, 255, 0.1) !important;
}

.debug-events .fc-timegrid-event .event-tab.interval {
  border: 1px solid green !important;
}

/* ==============================================
   ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã¨ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£
   ============================================== */
@media (prefers-contrast: high) {
  .fc-timegrid-event {
    border-width: 3px !important;
  }
  
  .fc-button {
    border: 2px solid currentColor !important;
  }
}

@media (prefers-color-scheme: dark) {
  .fc {
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%) !important;
    border-color: #4a5568 !important;
  }
  
  .fc-toolbar {
    background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%) !important;
    border-bottom-color: #4a5568 !important;
  }
  
  .fc-toolbar-title {
    color: #e2e8f0 !important;
  }
}

/* ==============================================
   ç‰¹æ®Šãªã‚³ãƒ¼ã‚¹æ™‚é–“å¯¾å¿œï¼ˆè¿½åŠ ã®çµ„ã¿åˆã‚ã›ï¼‰
   ============================================== */

/* 25åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="25"] {
  min-height: 100px !important;
  height: 100px !important;
}

.fc-timegrid-event[data-duration="30"] {
  min-height: 120px !important;
  height: 120px !important;
}

.fc-timegrid-event[data-duration="35"] {
  min-height: 140px !important;
  height: 140px !important;
}

/* 115åˆ†ä»¥ä¸Šã®é•·æ™‚é–“ã‚³ãƒ¼ã‚¹ */
.fc-timegrid-event[data-duration="115"] {
  min-height: 460px !important;
  height: 460px !important;
}

.fc-timegrid-event[data-duration="125"] {
  min-height: 500px !important;
  height: 500px !important;
}

.fc-timegrid-event[data-duration="130"] {
  min-height: 520px !important;
  height: 520px !important;
}

.fc-timegrid-event[data-duration="135"] {
  min-height: 540px !important;
  height: 540px !important;
}

.fc-timegrid-event[data-duration="140"] {
  min-height: 560px !important;
  height: 560px !important;
}

.fc-timegrid-event[data-duration="150"] {
  min-height: 600px !important;
  height: 600px !important;
}

/* ==============================================
   ãƒ•ã‚©ãƒ¼ã‚«ã‚¹çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event:focus {
  outline: 3px solid #007bff;
  outline-offset: 2px;
  z-index: 1001;
}

.fc-timegrid-event:focus-visible {
  outline: 3px solid #007bff;
  outline-offset: 2px;
}

/* ==============================================
   å°åˆ·æ™‚ã®æœ€é©åŒ–
   ============================================== */
@media print {
  .fc {
    box-shadow: none !important;
    border: 1px solid #000 !important;
  }
  
  .fc-timegrid-event {
    box-shadow: none !important;
    border: 1px solid #000 !important;
  }
  
  .fc-button {
    display: none !important;
  }
  
  .calendar-nav,
  .calendar-actions {
    display: none !important;
  }
}

/* ==============================================
   ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
   ============================================== */
.fc-timegrid-event {
  will-change: transform, opacity;
}

.fc-timegrid-event:hover {
  will-change: transform, box-shadow;
}

/* GPUåŠ é€Ÿã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
.fc-timegrid-event,
.fc-button {
  transform: translateZ(0);
  backface-visibility: hidden;
}

/* ==============================================
   ã‚³ãƒ¼ã‚¹åˆ¥ã®è­˜åˆ¥ç”¨ã‚«ãƒ©ãƒ¼ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   ============================================== */

/* 40åˆ†ã‚³ãƒ¼ã‚¹ç³»ã®ã‚µãƒ–ãƒˆãƒ«èƒŒæ™¯èª¿æ•´ */
.fc-timegrid-event[data-duration="40"],
.fc-timegrid-event[data-duration="45"],
.fc-timegrid-event[data-duration="50"],
.fc-timegrid-event[data-duration="55"] {
  position: relative;
}

.fc-timegrid-event[data-duration="40"]::after,
.fc-timegrid-event[data-duration="45"]::after,
.fc-timegrid-event[data-duration="50"]::after,
.fc-timegrid-event[data-duration="55"]::after {
  content: '40';
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(0, 0, 0, 0.1);
  color: rgba(255, 255, 255, 0.7);
  border-radius: 50%;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  font-weight: bold;
  pointer-events: none;
}

/* 60åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="60"]::after,
.fc-timegrid-event[data-duration="65"]::after,
.fc-timegrid-event[data-duration="70"]::after,
.fc-timegrid-event[data-duration="75"]::after,
.fc-timegrid-event[data-duration="80"]::after {
  content: '60';
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(0, 0, 0, 0.1);
  color: rgba(255, 255, 255, 0.7);
  border-radius: 50%;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  font-weight: bold;
  pointer-events: none;
}

/* 80åˆ†ã‚³ãƒ¼ã‚¹ç³» */
.fc-timegrid-event[data-duration="85"]::after,
.fc-timegrid-event[data-duration="90"]::after,
.fc-timegrid-event[data-duration="95"]::after,
.fc-timegrid-event[data-duration="100"]::after {
  content: '80';
  position: absolute;
  top: 2px;
  right: 2px;
  background: rgba(0, 0, 0, 0.1);
  color: rgba(255, 255, 255, 0.7);
  border-radius: 50%;
  width: 16px;
  height: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 8px;
  font-weight: bold;
  pointer-events: none;
}

/* ==============================================
   ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
   ============================================== */
.fc-timegrid::-webkit-scrollbar {
  width: 8px;
}

.fc-timegrid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

.fc-timegrid::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  border-radius: 4px;
}

.fc-timegrid::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
}

/* ==============================================
   èª­ã¿è¾¼ã¿çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.calendar-loading {
  position: relative;
}

.calendar-loading::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(2px);
  z-index: 9999;
}

.calendar-loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 40px;
  height: 40px;
  margin: -20px 0 0 -20px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  z-index: 10000;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* ==============================================
   ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.calendar-error {
  padding: 20px;
  text-align: center;
  color: #dc3545;
  background: #fff5f5;
  border: 1px solid #fecaca;
  border-radius: 8px;
  margin: 20px;
}

.calendar-error::before {
  content: 'âš ï¸';
  display: block;
  font-size: 2rem;
  margin-bottom: 10px;
}

/* ==============================================
   ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ«å¼·åŒ–
   ============================================== */
.fc-timegrid-event[data-interval-info]:hover::after {
  animation: tooltipFadeIn 0.3s ease-out;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

@keyframes tooltipFadeIn {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(5px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

/* ==============================================
   ã‚»ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event.fc-event-selected {
  box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.3) !important;
  z-index: 1002 !important;
}

/* ==============================================
   ãƒ‰ãƒ©ãƒƒã‚°çŠ¶æ…‹ã®ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event.fc-event-dragging {
  opacity: 0.7 !important;
  transform: rotate(3deg) !important;
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
  z-index: 1003 !important;
}

.fc-timegrid-event.fc-event-resizing {
  opacity: 0.8 !important;
  box-shadow: 0 4px 20px rgba(0, 123, 255, 0.4) !important;
}

/* ==============================================
   æœ€çµ‚èª¿æ•´ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
   ============================================== */

/* é‡è¤‡ã™ã‚‹ã‚¹ã‚¿ã‚¤ãƒ«ã®çµ±åˆ */
.fc-timegrid-event.reservation-with-tabs,
.fc-timegrid-event.reservation-with-tabs .fc-event-main,
.fc-timegrid-event.reservation-with-tabs .event-tabs,
.fc-timegrid-event.reservation-with-tabs .event-tab {
  /* æ—¢å­˜ã®ã‚¿ãƒ–ã‚¹ã‚¿ã‚¤ãƒ«ã¨çµ±åˆæ¸ˆã¿ */
}

/* ä¸è¦ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã®å‰Šé™¤ */
.fc-timegrid-event {
  /* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ—¢ã«å®šç¾©æ¸ˆã¿ */
}

/* ==============================================
   1æ™‚é–“ã®ç·šã®ã¿ã‚’å¤ªãã™ã‚‹è¨­å®šï¼ˆ10åˆ†ãšã‚‰ã—ä¿®æ­£ç‰ˆï¼‰
   ============================================== */

/* ã¾ãšå…¨ã¦ã®ç·šã‚’ç´°ããƒªã‚»ãƒƒãƒˆ */
.fc-timegrid-slot {
  border-bottom: 3px solid #e2e8f0 !important; /* åŸºæœ¬ã¯ç´°ã„ç·š */
}

/* ã‚¤ãƒ™ãƒ³ãƒˆã®é«˜ã•ã‚’æ­£ç¢ºã«è¨­å®š */
.fc-timegrid-event {
  height: auto !important;
  min-height: auto !important;
}

.fc-timegrid-event[data-duration] {
  height: calc(var(--duration) * 3px) !important;
  min-height: calc(var(--duration) * 3px) !important;
  max-height: calc(var(--duration) * 3px) !important;
}

/* ç‰¹å®šã®æ™‚é–“ã®ã‚¤ãƒ™ãƒ³ãƒˆé«˜ã•ã‚’ç›´æ¥æŒ‡å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰ */
.fc-timegrid-event[data-duration="75"] {
  height: 225px !important;
  min-height: 225px !important;
  max-height: 225px !important;
}

.fc-timegrid-event[data-duration="80"] {
  height: 240px !important;
  min-height: 240px !important;
  max-height: 240px !important;
}

.fc-timegrid-event[data-duration="90"] {
  height: 270px !important;
  min-height: 270px !important;
  max-height: 270px !important;
}

/* ã‚¹ãƒ­ãƒƒãƒˆã®é«˜ã•ã‚’å¼·åˆ¶çš„ã«30pxã«è¨­å®šï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰ */
.fc-timegrid-slot {
  height: 30px !important;
  min-height: 30px !important;
  max-height: 30px !important;
}

/* æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã‚¹ã‚¿ã‚¤ãƒ« */
.fc-col-header-cell {
  cursor: pointer !important;
  transition: background-color 0.2s ease;
}

.fc-col-header-cell:hover {
  background-color: #f8f9fa !important;
}

.fc-col-header-cell:active {
  background-color: #e9ecef !important;
}

.fc-day-header {
  cursor: pointer !important;
  transition: background-color 0.2s ease;
  user-select: none !important;
}

.fc-day-header:hover {
  background-color: #f8f9fa !important;
}

.fc-day-header:active {
  background-color: #e9ecef !important;
}

/* æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#monthCalendar .fc {
  font-size: 0.9rem;
}

#monthCalendar .fc-daygrid-day {
  cursor: pointer;
  transition: background-color 0.2s ease;
}

#monthCalendar .fc-daygrid-day:hover {
  background-color: #f8f9fa !important;
}

#monthCalendar .fc-daygrid-day.fc-day-today {
  background-color: #e3f2fd !important;
}

#monthCalendar .fc-daygrid-day.fc-day-selected {
  background-color: #007bff !important;
  color: white !important;
}

#monthCalendar .fc-daygrid-day.fc-day-selected:hover {
  background-color: #0056b3 !important;
}

/* ã‚ˆã‚Šç¢ºå®Ÿãªæ–¹æ³•ï¼šæ™‚é–“ã«åŸºã¥ã„ãŸå…·ä½“çš„ãªæŒ‡å®šï¼ˆ10åˆ†ãšã‚‰ã—ä¿®æ­£ï¼‰ */
/* å–¶æ¥­æ™‚é–“10:00-21:00ã®å ´åˆ */

/* 1æ™‚é–“ã”ã¨ã®ç·šï¼ˆå¤ªã„ç·šï¼‰ */
/* 10:00 (0ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(0) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 11:00 (6ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(6) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 12:00 (12ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(12) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 13:00 (18ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(18) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 14:00 (24ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(24) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 15:00 (30ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(30) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 16:00 (36ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(36) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 17:00 (42ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(42) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 18:00 (48ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(48) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 19:00 (54ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(54) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 20:00 (60ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(60) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 21:00 (66ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(66) .fc-timegrid-slot {
  border-bottom: 3px solid #64748b !important;
}

/* 30åˆ†ã”ã¨ã®ç·šï¼ˆä¸­ç¨‹åº¦ã®å¤ªã•ï¼‰ */
/* 10:30 (3ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(3) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* 11:30 (9ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(9) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* 12:30 (15ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(15) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* 13:30 (21ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(21) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* 14:30 (27ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(27) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* 15:30 (33ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(33) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* 16:30 (39ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(39) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* 17:30 (45ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(45) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* 18:30 (51ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(51) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* 19:30 (57ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(57) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* 20:30 (63ç•ªç›®ã®ã‚¹ãƒ­ãƒƒãƒˆ) */
.fc-timegrid-slots tr:nth-child(63) .fc-timegrid-slot {
  border-bottom: 1.5px solid #64748b !important;
}

/* ==============================================
   ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ
   ============================================== */
@media (max-width: 768px) {
  .fc-timegrid-slot:nth-child(6n) {
    border-bottom: 3px solid #64748b !important; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯å°‘ã—ç´°ã */
  }
  
  .fc-timegrid-slots tr:nth-child(1) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(6) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(12) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(18) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(24) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(30) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(36) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(42) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(48) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(54) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(60) .fc-timegrid-slot,
  .fc-timegrid-slots tr:nth-child(66) .fc-timegrid-slot {
    border-bottom: 3px solid #64748b !important;
  }
}
</style>

<script>
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOM Content Loaded');
    
    // æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    const monthCalendarEl = document.getElementById('monthCalendar');
    console.log('ğŸ“… Month calendar element:', monthCalendarEl);
    
    // äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    const calendarEl = document.getElementById('calendar');
    console.log('ğŸ“… Calendar element:', calendarEl);
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã¨å±¥æ­´ã‚’å–å¾—ãƒ»è¡¨ç¤º
    function loadCancellationStats() {
      console.log('ğŸ“Š Loading cancellation stats...');
      
      fetch('/admin/reservations/cancellation_stats')
        .then(response => {
          console.log('ğŸ“Š Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
      return response.json();
    })
    .then(data => {
          console.log('ğŸ“Š Received data:', data);
          
          // è¦ç´ ã®å­˜åœ¨ç¢ºèªã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          const cancelledCount = document.getElementById('cancelledCount');
          const cancelledRate = document.getElementById('cancelledRate');
          const historyContainer = document.getElementById('cancelledHistory');
          
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ•°ã‚’æ›´æ–°ï¼ˆè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          if (cancelledCount) {
            cancelledCount.textContent = data.cancelled_count;
          }
          if (cancelledRate) {
            cancelledRate.textContent = data.cancelled_rate + '%';
          }
          
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ã‚’æ›´æ–°ï¼ˆè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          if (historyContainer) {
            if (data.cancelled_history && data.cancelled_history.length > 0) {
              console.log('ğŸ“Š Rendering history:', data.cancelled_history.length, 'items');
              const historyHtml = data.cancelled_history.map(item => `
                <div class="border-bottom pb-2 mb-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-bold text-dark">${item.customer_name}</div>
                      <div class="small text-muted">
                        <i class="fas fa-calendar me-1"></i>${item.cancelled_at}
                        <span class="mx-2">|</span>
                        <i class="fas fa-clock me-1"></i>${item.course}
                      </div>
                    </div>
                  </div>
                  <div class="mt-1">
                    <small class="text-danger">
                      <i class="fas fa-times-circle me-1"></i>
                      ${item.reason || 'ç†ç”±æœªå…¥åŠ›'}
                    </small>
                  </div>
                </div>
              `).join('');
              historyContainer.innerHTML = historyHtml;
      } else {
              console.log('ğŸ“Š No cancellation history found');
              historyContainer.innerHTML = `
                <div class="text-muted text-center py-3">
                  <i class="fas fa-info-circle me-1"></i>
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
        </div>
      `;
    }
          } else {
            console.log('ğŸ“Š Cancellation history container not found, skipping update');
      }
    })
    .catch(error => {
          console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã®å–å¾—ã«å¤±æ•—:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
          const cancelledCount = document.getElementById('cancelledCount');
          const cancelledRate = document.getElementById('cancelledRate');
          const cancelledHistory = document.getElementById('cancelledHistory');
          
          if (cancelledCount) cancelledCount.textContent = '0';
          if (cancelledRate) cancelledRate.textContent = '0%';
          if (cancelledHistory) {
            cancelledHistory.innerHTML = `
              <div class="text-muted text-center">
                <i class="fas fa-exclamation-triangle me-1"></i>
                çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
              </div>
            `;
          }
        });
    }

    if (!monthCalendarEl || !calendarEl) {
      console.error('âŒ Calendar elements not found');
      return;
    }
    
    // æœˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    const monthCalendar = new FullCalendar.Calendar(monthCalendarEl, {
      initialView: 'dayGridMonth',
      locale: 'ja',
      height: 'auto',
      headerToolbar: false, // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤º
      dayHeaderFormat: { weekday: 'short' },
      dayCellClassNames: 'clickable-day-cell',
      aspectRatio: 2, // ã‚ˆã‚Šæ¨ªé•·ã®æ¯”ç‡
      contentHeight: 100, // é«˜ã•ã‚’èª¿æ•´
      dayCellDidMount: function(info) {
        // æ—¥ä»˜ã‚»ãƒ«ã«ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
        info.el.style.cursor = 'pointer';
        info.el.addEventListener('click', function() {
          const clickedDate = info.date;
          console.log('ğŸ“… Month calendar day clicked:', clickedDate);
          
          // äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ãã®é€±ã«ç§»å‹•
          calendar.gotoDate(clickedDate);
          
          // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
          monthCalendar.select(clickedDate);
        });
      },
      select: function(info) {
        const selectedDate = info.start;
        console.log('ğŸ“… Month calendar date selected:', selectedDate);
        
        // äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ãã®é€±ã«ç§»å‹•
        calendar.gotoDate(selectedDate);
      }
    });
    
    // äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      locale: 'ja',
      height: 'auto',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      dayHeaderFormat: { weekday: 'short', day: 'numeric', month: 'short' },
      buttonText: {
        today: 'ä»Šæ—¥',
        month: 'æœˆ',
        week: 'é€±',  
        day: 'æ—¥'
      },
      slotMinTime: '10:00:00',
      slotMaxTime: '21:00:00',
      slotDuration: '00:10:00', // 10åˆ†é–“éš”
      slotLabelInterval: '00:30:00', // ãƒ©ãƒ™ãƒ«ã¯30åˆ†é–“éš”
      snapDuration: '00:10:00', // ã‚¹ãƒŠãƒƒãƒ—ã‚‚10åˆ†é–“éš”
      slotMinWidth: 60,
      allDaySlot: false,
      selectable: true,
      editable: true,
      nowIndicator: true,
      eventDisplay: 'block',
      eventMinHeight: 15,
      eventMinWidth: 0,
      slotEventOverlap: false,
      slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false },
      
      eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false,
        timeZone: 'Asia/Tokyo'
      },
      
      // ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰
      eventDrop: function(info) {
        console.log('ğŸ”„ Event dropped:', info.event);
        updateReservationTime(info.event);
      },
      
      eventResize: function(info) {
        console.log('ğŸ“ Event resized:', info.event);
        updateReservationTime(info.event);
      },
      
      eventClick: function(info) {
        openReservationModal(info.event);
      },
      

      
      select: function(info) {
        // æ—¢å­˜ã®selectå‡¦ç†ã‚’ãã®ã¾ã¾ä½¿ç”¨
        console.log('ğŸ” Raw select info:', info);
        
        const startTime = info.start;
        const endTime = info.end;
        
        const startHour = startTime.getHours ? startTime.getHours() : startTime.hour;
        const startMinute = startTime.getMinutes ? startTime.getMinutes() : startTime.min;
        const endHour = endTime.getHours ? endTime.getHours() : endTime.hour;
        const endMinute = endTime.getMinutes ? endTime.getMinutes() : endTime.min;
        
        if (startHour < 10 || startHour >= 21) {
          console.log('âŒ Selected time outside business hours:', startHour);
          showMessage('å–¶æ¥­æ™‚é–“å¤–ã§ã™ã€‚10:00ã‹ã‚‰21:00ã®é–“ã§é¸æŠã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    
        const selectionDuration = (endTime - startTime) / (1000 * 60);
        
        if (endHour > 21 || (endHour === 21 && endMinute > 0)) {
          console.log('âŒ Selection extends beyond business hours');
          showMessage(`ã“ã®æ™‚é–“å¸¯ã¯å–¶æ¥­æ™‚é–“å¤–ã«ãªã‚Šã¾ã™ã€‚çµ‚äº†æ™‚åˆ»: ${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`, 'warning');
      return;
    }
    
        openNewReservationModal(info.start, info.end);
      },
      
      // ğŸ”§ å®Œå…¨ä¿®æ­£ï¼ševentContentã§å…¨ã‚³ãƒ¼ã‚¹ã«å¯¾å¿œ
      eventContent: function(arg) {
        const event = arg.event;
        const extendedProps = event.extendedProps;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆã®å®Ÿéš›ã®æ™‚é–“å¹…ã‚’è¨ˆç®—
        const eventStart = new Date(event.start);
        const eventEnd = new Date(event.end);
        const actualDurationMinutes = Math.round((eventEnd - eventStart) / (1000 * 60));
        
        // è©³ç´°ãƒ­ã‚°
        const courseDuration = extendedProps.course_duration || 60;
        const intervalDuration = extendedProps.interval_duration || 0;
        const totalExpected = courseDuration + intervalDuration;
        
        console.log(`ğŸ¨ Rendering event ${event.id}:`);
        console.log(`  Title: ${event.title}`);
        console.log(`  Course: ${courseDuration}åˆ†, Interval: ${intervalDuration}åˆ†`);
        console.log(`  Total expected: ${totalExpected}åˆ†`);
        console.log(`  Actual duration: ${actualDurationMinutes}åˆ†`);
        console.log(`  Slots needed: ${actualDurationMinutes / 10}`);
        console.log(`  Has interval: ${extendedProps.has_interval}`);
        console.log(`  Interval type: ${extendedProps.is_individual_interval ? 'Individual' : 'System'}`);
        
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒã‚ã‚‹å ´åˆã¯ã‚¿ãƒ–å½¢å¼ã§è¡¨ç¤º
        if (extendedProps.has_interval && intervalDuration > 0) {
          const intervalType = extendedProps.is_individual_interval ? 'individual' : 'system';
          
          // flexãƒ™ãƒ¼ã‚¹ã§ã®æ¯”ç‡è¨ˆç®—
          const courseRatio = courseDuration;
          const intervalRatio = intervalDuration;
          
          console.log(`ğŸ“Š Tab ratios for event ${event.id}:`);
          console.log(`  Course flex: ${courseRatio} (${courseDuration}åˆ†)`);
          console.log(`  Interval flex: ${intervalRatio} (${intervalDuration}åˆ†)`);
          console.log(`  Ratio: ${courseRatio}:${intervalRatio}`);
          
          return {
            html: `
              <div class="event-tab-container" style="
                height: 100%; 
                display: flex; 
                flex-direction: column;
                width: 100%;
              ">
                <div class="event-tab course" style="
                  flex: ${courseRatio}; 
                  display: flex; 
                  align-items: center; 
                  justify-content: center;
                  padding: 2px 4px;
                  font-size: 0.8rem;
                  font-weight: 600;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                  border-bottom: 1px solid rgba(255, 255, 255, 0.3);
                  background: inherit;
                  color: inherit;
                ">
                  ${event.title}
                </div>
                <div class="event-tab interval ${intervalType}" style="
                  flex: ${intervalRatio}; 
                  display: flex; 
                  align-items: center; 
                  justify-content: center;
                  padding: 2px 4px;
                  font-size: 0.75rem;
                  font-weight: 500;
                  overflow: hidden;
                  text-overflow: ellipsis;
                  white-space: nowrap;
                  background-color: ${intervalType === 'individual' ? '#fd7e14' : '#6c757d'};
                  color: white;
                ">
                  æ•´ç†${intervalDuration}åˆ†
                </div>
              </div>
            `
          };
        } else {
          // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãªã—ã®å ´åˆã¯é€šå¸¸è¡¨ç¤º
          return {
            html: `
              <div style="
                height: 100%; 
                display: flex; 
                align-items: center; 
                justify-content: center;
                padding: 4px;
                font-size: 0.85rem;
                font-weight: 600;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
              ">
                ${event.title}
              </div>
            `
          };
        }
      },
      
      // ğŸ”§ é‡è¦ï¼ševentDidMountã§å…¨ã‚³ãƒ¼ã‚¹ã®é«˜ã•ã‚’æ­£ç¢ºã«è¨­å®š
      eventDidMount: function(info) {
        const event = info.event;
        const element = info.el;
        const extendedProps = event.extendedProps;
        
        // ã‚¤ãƒ™ãƒ³ãƒˆã®å®Ÿéš›ã®æ™‚é–“å¹…ã‚’è¨ˆç®—
        const eventStart = new Date(event.start);
        const eventEnd = new Date(event.end);
        const actualDurationMinutes = Math.round((eventEnd - eventStart) / (1000 * 60));
        
        // dataå±æ€§ã‚’è¨­å®šã—ã¦CSSã®é«˜ã•æŒ‡å®šã‚’æœ‰åŠ¹ã«ã™ã‚‹
        element.setAttribute('data-duration', actualDurationMinutes);
        
        // ã‚¤ãƒ™ãƒ³ãƒˆã®é«˜ã•ã‚’æ­£ç¢ºã«è¨­å®š
        const slotHeight = 30; // 10åˆ†é–“éš”ã®ã‚¹ãƒ­ãƒƒãƒˆé«˜ã•ï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰
        const expectedHeight = (actualDurationMinutes / 10) * slotHeight;
        element.style.height = `${expectedHeight}px`;
        element.style.minHeight = `${expectedHeight}px`;
        element.style.maxHeight = `${expectedHeight}px`;
        element.style.setProperty('--duration', actualDurationMinutes);
        
        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°
        console.log(`ğŸ“ Event ${event.id} height calculation:`);
        console.log(`  Duration: ${actualDurationMinutes}åˆ†`);
        console.log(`  Expected height: ${expectedHeight}px`);
        console.log(`  Actual element height: ${element.offsetHeight}px`);
        
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’dataå±æ€§ã¨ã—ã¦è¿½åŠ 
        const courseDuration = extendedProps.course_duration || 60;
        const intervalDuration = extendedProps.interval_duration || 0;
        const intervalType = extendedProps.is_individual_interval ? 'å€‹åˆ¥' : 'ã‚·ã‚¹ãƒ†ãƒ ';
        
        if (intervalDuration > 0) {
          element.setAttribute('data-interval-info', 
            `${courseDuration}åˆ† + ${intervalType}${intervalDuration}åˆ† = ${actualDurationMinutes}åˆ†`);
        }
        
        // 10åˆ†é–“éš”ã§ã®æ­£ç¢ºãªã‚¹ãƒ­ãƒƒãƒˆæ•°ã‚’è¨ˆç®—
        const slots = actualDurationMinutes / 10;
        
        console.log(`ğŸ“ Mounting event ${event.id}:`);
        console.log(`  Course: ${courseDuration}åˆ†`);
        console.log(`  Interval: ${intervalDuration}åˆ† (${intervalType})`);
        console.log(`  Total: ${actualDurationMinutes}åˆ†`);
        console.log(`  Slots: ${slots}`);
        console.log(`  Data attribute: data-duration="${actualDurationMinutes}"`);
        
        // ã‚¹ãƒ­ãƒƒãƒˆé«˜ã•ã‚’å–å¾—ã—ã¦é«˜ã•ã‚’èª¿æ•´
        setTimeout(() => {
          const timeGridSlots = document.querySelectorAll('.fc-timegrid-slot');
          if (timeGridSlots.length > 0) {
                         const slotHeight = timeGridSlots[0].offsetHeight;
             const expectedHeight = Math.round(slots * slotHeight);
             
             // 30pxãƒ™ãƒ¼ã‚¹ã§ã®é«˜ã•è¨ˆç®—ã‚‚è¿½åŠ 
             const baseSlotHeight = 30; // æ–°ã—ã„ãƒ™ãƒ¼ã‚¹é«˜ã•
             const expectedHeight30px = Math.round(slots * baseSlotHeight);
            
            console.log(`ğŸ“ Height calculation for event ${event.id}:`);
            console.log(`  Slot height: ${slotHeight}px`);
            console.log(`  Slots needed: ${slots}`);
            console.log(`  Expected height: ${expectedHeight}px`);
            console.log(`  CSS rule height: ${getComputedStyle(element).height}`);
            
            // JavaScript ã§ã‚‚é«˜ã•ã‚’è¨­å®šï¼ˆCSSã¨ä½µç”¨ï¼‰
            element.style.setProperty('height', `${expectedHeight}px`, 'important');
            element.style.setProperty('min-height', `${expectedHeight}px`, 'important');
            element.style.setProperty('max-height', `${expectedHeight}px`, 'important');
            
            // height-calculated ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœï¼‰
            element.classList.add('height-calculated');
            
            // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒŠã‚‚èª¿æ•´
            const tabContainer = element.querySelector('.event-tab-container');
            if (tabContainer) {
              tabContainer.style.setProperty('height', `${expectedHeight}px`, 'important');
              tabContainer.style.setProperty('min-height', `${expectedHeight}px`, 'important');
            }
            
            // å„ã‚³ãƒ¼ã‚¹+ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«çµ„ã¿åˆã‚ã›ã®è­˜åˆ¥ã¨è¡¨ç¤º
            const courseIntervalMap = {
              // 40åˆ†ã‚³ãƒ¼ã‚¹ç³»
              40: { course: '40åˆ†ã‚³ãƒ¼ã‚¹', interval: 'ãªã—', description: '40åˆ†ã‚³ãƒ¼ã‚¹ã®ã¿' },
              45: { course: '40åˆ†ã‚³ãƒ¼ã‚¹', interval: '5åˆ†', description: '40åˆ†ã‚³ãƒ¼ã‚¹ + 5åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
              50: { course: '40åˆ†ã‚³ãƒ¼ã‚¹', interval: '10åˆ†', description: '40åˆ†ã‚³ãƒ¼ã‚¹ + 10åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
              55: { course: '40åˆ†ã‚³ãƒ¼ã‚¹', interval: '15åˆ†', description: '40åˆ†ã‚³ãƒ¼ã‚¹ + 15åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
              
              // 60åˆ†ã‚³ãƒ¼ã‚¹ç³»
              60: { course: '60åˆ†ã‚³ãƒ¼ã‚¹', interval: 'ãªã—', description: '60åˆ†ã‚³ãƒ¼ã‚¹ã®ã¿' },
              65: { course: '60åˆ†ã‚³ãƒ¼ã‚¹', interval: '5åˆ†', description: '60åˆ†ã‚³ãƒ¼ã‚¹ + 5åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
              70: { course: '60åˆ†ã‚³ãƒ¼ã‚¹', interval: '10åˆ†', description: '60åˆ†ã‚³ãƒ¼ã‚¹ + 10åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
              75: { course: '60åˆ†ã‚³ãƒ¼ã‚¹', interval: '15åˆ†', description: '60åˆ†ã‚³ãƒ¼ã‚¹ + 15åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
              80: { course: '60åˆ†ã‚³ãƒ¼ã‚¹', interval: '20åˆ†', description: '60åˆ†ã‚³ãƒ¼ã‚¹ + 20åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
              
              // 80åˆ†ã‚³ãƒ¼ã‚¹ç³»
              80: { course: '80åˆ†ã‚³ãƒ¼ã‚¹', interval: 'ãªã—', description: '80åˆ†ã‚³ãƒ¼ã‚¹ã®ã¿' },
              85: { course: '80åˆ†ã‚³ãƒ¼ã‚¹', interval: '5åˆ†', description: '80åˆ†ã‚³ãƒ¼ã‚¹ + 5åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
              90: { course: '80åˆ†ã‚³ãƒ¼ã‚¹', interval: '10åˆ†', description: '80åˆ†ã‚³ãƒ¼ã‚¹ + 10åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
              95: { course: '80åˆ†ã‚³ãƒ¼ã‚¹', interval: '15åˆ†', description: '80åˆ†ã‚³ãƒ¼ã‚¹ + 15åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' },
              100: { course: '80åˆ†ã‚³ãƒ¼ã‚¹', interval: '20åˆ†', description: '80åˆ†ã‚³ãƒ¼ã‚¹ + 20åˆ†ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«' }
            };
            
            const combinationInfo = courseIntervalMap[actualDurationMinutes];
            if (combinationInfo) {
              console.log(`ğŸ¯ ${combinationInfo.description}:`);
              console.log(`  Height: ${expectedHeight}px (${slots}ã‚¹ãƒ­ãƒƒãƒˆ)`);
              console.log(`  CSS data-duration: [data-duration="${actualDurationMinutes}"]`);
            } else {
              console.log(`ğŸ¯ ã‚«ã‚¹ã‚¿ãƒ çµ„ã¿åˆã‚ã› (${actualDurationMinutes}åˆ†):`);
              console.log(`  Height: ${expectedHeight}px (${slots}ã‚¹ãƒ­ãƒƒãƒˆ)`);
            }
            
            // é«˜ã•è¨­å®šã®æœ€çµ‚ç¢ºèª
            setTimeout(() => {
              const finalHeight = element.offsetHeight;
              const heightDiff = Math.abs(finalHeight - expectedHeight);
              
              if (heightDiff > 5) {
                console.warn(`âš ï¸ Height adjustment failed for event ${event.id}:`);
                console.warn(`  Expected: ${expectedHeight}px, Actual: ${finalHeight}px`);
                console.warn(`  Difference: ${heightDiff}px`);
                console.warn(`  Duration: ${actualDurationMinutes}åˆ† (${slots}ã‚¹ãƒ­ãƒƒãƒˆ)`);
                
                // å¤±æ•—ã—ãŸå ´åˆã¯å†åº¦å¼·åˆ¶è¨­å®š
                element.style.setProperty('height', `${expectedHeight}px`, 'important');
              } else {
                const combination = courseIntervalMap[actualDurationMinutes]?.description || 
                                  `${actualDurationMinutes}åˆ†ã‚«ã‚¹ã‚¿ãƒ `;
                console.log(`âœ… ${combination} correctly displayed: ${finalHeight}px`);
              }
            }, 200);
          }
        }, 100);
      },
      
      // ğŸ”§ ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®è©³ç´°æ¤œè¨¼
      events: function(info, successCallback, failureCallback) {
        console.log('ğŸ” Fetching events for:', info.startStr, 'to', info.endStr);
        
        fetch('/admin/reservations.json', {
      headers: {
        'Accept': 'application/json',
            'Content-Type': 'application/json'
          }
    })
    .then(response => {
      if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
        .then(events => {
          console.log('âœ… Events loaded:', events.length);
          
          // ğŸ¯ å…¨ã‚³ãƒ¼ã‚¹çµ„ã¿åˆã‚ã›ã®æ¤œè¨¼
          console.log('ğŸ“Š Event duration analysis:');
          
          const durationStats = {};
          events.forEach((event, index) => {
            const startTime = new Date(event.start);
            const endTime = new Date(event.end);
            const actualDuration = Math.round((endTime - startTime) / (1000 * 60));
            
            const courseDuration = event.extendedProps?.course_duration || 0;
            const intervalDuration = event.extendedProps?.interval_duration || 0;
            const expectedDuration = courseDuration + intervalDuration;
            
            // çµ±è¨ˆã‚’é›†è¨ˆ
            if (!durationStats[actualDuration]) {
              durationStats[actualDuration] = {
                count: 0,
                examples: [],
                slots: actualDuration / 10
              };
            }
            durationStats[actualDuration].count++;
            durationStats[actualDuration].examples.push({
              id: event.id,
              course: courseDuration,
              interval: intervalDuration,
              title: event.title
            });
            
            console.log(`ğŸ¯ Event ${event.id}: ${courseDuration}åˆ†+${intervalDuration}åˆ†=${actualDuration}åˆ† (${actualDuration/10}ã‚¹ãƒ­ãƒƒãƒˆ)`);
          });
          
          // çµ±è¨ˆã‚µãƒãƒªãƒ¼
          console.log('ğŸ“ˆ Duration statistics:');
          Object.entries(durationStats).sort(([a], [b]) => Number(a) - Number(b)).forEach(([duration, stats]) => {
            console.log(`  ${duration}åˆ† (${stats.slots}ã‚¹ãƒ­ãƒƒãƒˆ): ${stats.count}ä»¶`);
            if (stats.examples.length <= 3) {
              stats.examples.forEach(ex => {
                console.log(`    - ${ex.title} (${ex.course}åˆ†+${ex.interval}åˆ†)`);
              });
            }
          });
          
          successCallback(events);
    })
    .catch(error => {
          console.error('âŒ Error loading events:', error);
          failureCallback(error);
        });
      }
    });
  
    console.log('ğŸ¨ Rendering calendars...');
    
    // ä¸¡æ–¹ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    monthCalendar.render();
    calendar.render();
    
    console.log('âœ… Calendars rendered successfully');
    


    // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†å¾Œã«ã‚¹ãƒ­ãƒƒãƒˆé«˜ã•ã‚’ç¢ºèª
    setTimeout(() => {
      console.log('ğŸ” Final height validation for all events:');
      
      const allEvents = document.querySelectorAll('.fc-timegrid-event[data-duration]');
      const heightStats = {};
      
      allEvents.forEach((element, index) => {
        const duration = parseInt(element.getAttribute('data-duration'));
        const actualHeight = element.offsetHeight;
        const expectedSlots = duration / 10;
        const slotHeight = 30; // ãƒ™ãƒ¼ã‚¹ã¯30pxï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ–ï¼‰
        const expectedHeight = expectedSlots * slotHeight;
        
        if (!heightStats[duration]) {
          heightStats[duration] = {
            count: 0,
            heights: [],
            expectedHeight,
            slots: expectedSlots
          };
        }
        
        heightStats[duration].count++;
        heightStats[duration].heights.push(actualHeight);
      });
      
      console.log('ğŸ“Š Height validation summary:');
      Object.entries(heightStats)
        .sort(([a], [b]) => Number(a) - Number(b))
        .forEach(([duration, stats]) => {
          const avgHeight = Math.round(stats.heights.reduce((a, b) => a + b, 0) / stats.heights.length);
          const isCorrect = Math.abs(avgHeight - stats.expectedHeight) <= 5;
          const status = isCorrect ? 'âœ…' : 'âŒ';
          
          console.log(`  ${status} ${duration}åˆ† (${stats.slots}ã‚¹ãƒ­ãƒƒãƒˆ): ${stats.count}ä»¶`);
          console.log(`    Expected: ${stats.expectedHeight}px, Average: ${avgHeight}px`);
          
          if (!isCorrect) {
            console.warn(`    Height mismatch detected for ${duration}åˆ† events!`);
          }
        });
    }, 2000);
  // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’æ›´æ–°
    function updateIntervalInfo(extendedProps) {
      const intervalInfo = document.getElementById('currentIntervalInfo');
      const individualInterval = extendedProps?.individual_interval_minutes;
      const effectiveInterval = extendedProps?.effective_interval_minutes || 15;
      
      if (individualInterval !== null && individualInterval !== undefined) {
        intervalInfo.innerHTML = `<span class="badge bg-success">å€‹åˆ¥è¨­å®š: ${individualInterval}åˆ†</span>`;
    } else {
        intervalInfo.innerHTML = `<span class="badge bg-primary">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: ${effectiveInterval}åˆ†</span>`;
      }
    }

  // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
  try {
    loadCancellationStats();
    } catch (error) {
      console.log('ğŸ“Š Initial cancellation stats loading skipped:', error.message);
    }
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
    const urlParams = new URLSearchParams(window.location.search);
    const editReservationId = urlParams.get('edit');
    
    if (editReservationId) {
      console.log('ğŸ”§ Edit mode detected for reservation:', editReservationId);
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      setTimeout(() => {
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰è©²å½“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
        const event = calendar.getEventById(editReservationId);
        if (event) {
          console.log('âœ… Found event for editing:', event);
          openReservationModal(event);
        } else {
          console.log('âŒ Event not found for editing:', editReservationId);
          showMessage('ç·¨é›†ã™ã‚‹äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
        }
      }, 1000); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
    }
    
    // æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯æ™‚ã®äºˆç´„è¡¨ç¤ºé–¢æ•°
    function showDayReservations(date, reservations) {
      const dateStr = date.toLocaleDateString('ja-JP', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        weekday: 'long'
      });
      
      let html = `
        <div class="modal fade" id="dayReservationsModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">
                  <i class="fas fa-calendar-day me-2"></i>${dateStr}ã®äºˆç´„ä¸€è¦§
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead class="table-light">
                      <tr>
                        <th>æ™‚é–“</th>
                        <th>é¡§å®¢å</th>
                        <th>ã‚³ãƒ¼ã‚¹</th>
                        <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>
      `;
      
      reservations.forEach(reservation => {
        const startTime = new Date(reservation.start).toLocaleTimeString('ja-JP', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        const endTime = new Date(reservation.end).toLocaleTimeString('ja-JP', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        
        const statusBadge = getStatusBadge(reservation.status);
        
        html += `
          <tr>
            <td><strong>${startTime} - ${endTime}</strong></td>
            <td>${reservation.customer_name || 'æœªè¨­å®š'}</td>
            <td>${reservation.course || 'æœªè¨­å®š'}</td>
            <td>${statusBadge}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary" onclick="editReservation(${reservation.id})">
                <i class="fas fa-edit"></i>
              </button>
            </td>
          </tr>
        `;
      });
      
      html += `
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                <button type="button" class="btn btn-primary" onclick="openNewReservationModal()">
                  <i class="fas fa-plus me-1"></i>æ–°è¦äºˆç´„
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
      const existingModal = document.getElementById('dayReservationsModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      document.body.insertAdjacentHTML('beforeend', html);
      
      const modal = new bootstrap.Modal(document.getElementById('dayReservationsModal'));
      modal.show();
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ç”Ÿæˆé–¢æ•°
    function getStatusBadge(status) {
      const badges = {
        'tentative': '<span class="badge bg-warning">ä»®äºˆç´„</span>',
        'confirmed': '<span class="badge bg-success">ç¢ºå®š</span>',
        'cancelled': '<span class="badge bg-danger">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>',
        'completed': '<span class="badge bg-info">å®Œäº†</span>',
        'no_show': '<span class="badge bg-secondary">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>'
      };
      return badges[status] || '<span class="badge bg-secondary">æœªè¨­å®š</span>';
    }
    
    // äºˆç´„ç·¨é›†é–¢æ•°
    function editReservation(reservationId) {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      const modal = bootstrap.Modal.getInstance(document.getElementById('dayReservationsModal'));
      if (modal) {
        modal.hide();
      }
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§è©²å½“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–‹ã
      setTimeout(() => {
        const event = calendar.getEventById(reservationId.toString());
        if (event) {
          openReservationModal(event);
        } else {
          showMessage('äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
        }
      }, 300);
    }
    
    // æ–°è¦äºˆç´„ãƒœã‚¿ãƒ³
    document.getElementById('newReservationBtn').addEventListener('click', () => {
      openNewReservationModal();
    });
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    const reservationModal = new bootstrap.Modal(document.getElementById('reservationModal'));
    const customerHistoryModal = new bootstrap.Modal(document.getElementById('customerHistoryModal'));
    
    // é¡§å®¢æ¤œç´¢ãƒ»é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ 
    // é¡§å®¢æ¤œç´¢æ©Ÿèƒ½
    let searchTimeout;
    const customerSearch = document.getElementById('customerSearch');
    const searchResults = document.getElementById('customerSearchResults');
    const selectedCustomerInfo = document.getElementById('selectedCustomerInfo');
    const newCustomerForm = document.getElementById('newCustomerForm');

    customerSearch.addEventListener('input', function() {
      const query = this.value.trim();
      
      clearTimeout(searchTimeout);
      
      if (query.length < 2) {
        hideSearchResults();
      return;
    }
    
      searchTimeout = setTimeout(() => {
        searchCustomers(query);
      }, 300);
    });

    // æ¤œç´¢çµæœä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰çµæœã‚’éš ã™
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#customerSearch') && !e.target.closest('#customerSearchResults')) {
        hideSearchResults();
      }
    });

    // æ¤œç´¢çµæœã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
    document.addEventListener('click', function(e) {
      const searchResultItem = e.target.closest('.search-result-item');
      if (searchResultItem) {
        const userId = searchResultItem.dataset.userId;
        const userName = searchResultItem.dataset.userName;
        const userPhone = searchResultItem.dataset.userPhone;
        const userEmail = searchResultItem.dataset.userEmail;
        
        console.log('Search result clicked:', { userId, userName, userPhone, userEmail });
        selectCustomer(userId, userName, userPhone, userEmail);
      }
    });

    function searchCustomers(query) {
      fetch(`/admin/users/search?query=${encodeURIComponent(query)}`, {
      headers: {
        'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
    })
    .then(response => {
      if (!response.ok) {
          if (response.status === 401) {
            // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            window.location.href = '/admin_users/sign_in';
            throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
      }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
      return response.json();
    })
    .then(data => {
        displaySearchResults(data.users, query);
      })
      .catch(error => {
        console.error('é¡§å®¢æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
        hideSearchResults();
      });
    }

    function displaySearchResults(users, query) {
      if (users.length === 0) {
        // æ¤œç´¢çµæœãŒãªã„å ´åˆã¯æ–°è¦é¡§å®¢ç™»éŒ²ã‚’ææ¡ˆ
        searchResults.innerHTML = `
          <div class="p-3 text-center">
            <div class="text-muted mb-2">
              <i class="fas fa-search me-1"></i>
              ã€Œ${query}ã€ã«è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
            </div>
            <button type="button" class="btn btn-sm btn-primary" onclick="showNewCustomerForm('${query}')">
              <i class="fas fa-user-plus me-1"></i>æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²
            </button>
          </div>
        `;
    } else {
        let html = '';
        users.forEach(user => {
          html += `
            <div class="search-result-item p-3 border-bottom" 
                 style="cursor: pointer; transition: background-color 0.2s;"
                 onmouseover="this.style.backgroundColor='#f8f9fa'"
                 onmouseout="this.style.backgroundColor='white'"
                 data-user-id="${user.id}"
                 data-user-name="${user.name || ''}"
                 data-user-phone="${user.phone_number || ''}"
                 data-user-email="${user.email || ''}">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">${user.name || 'åå‰æœªè¨­å®š'}</div>
                  <small class="text-muted">
                    ${user.phone_number || 'é›»è©±ç•ªå·æœªç™»éŒ²'}
                    ${user.email ? ` | ${user.email}` : ''}
                  </small>
                  ${user.last_visit ? `<br><small class="text-success">æœ€çµ‚æ¥åº—: ${user.last_visit}</small>` : ''}
                </div>
                <div class="text-end">
                  <small class="badge bg-info">${user.active_tickets}æš</small>
                </div>
              </div>
            </div>
          `;
        });
        searchResults.innerHTML = html;
      }
      
      searchResults.style.display = 'block';
    }

    function hideSearchResults() {
      searchResults.style.display = 'none';
    }

    function selectCustomer(userId, name, phone, email) {
      console.log('selectCustomer called with:', { userId, name, phone, email });
      
      // é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã‚’ä¿å­˜
      document.getElementById('selectedUserId').value = userId;
      document.getElementById('customerSearch').value = name;
      
      // é¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º
      document.getElementById('selectedCustomerName').textContent = name;
      document.getElementById('selectedCustomerDetails').innerHTML = `
        ${phone || 'é›»è©±ç•ªå·æœªç™»éŒ²'} | 
        ${email || 'ãƒ¡ãƒ¼ãƒ«æœªç™»éŒ²'}
      `;
      
      // UIæ›´æ–°
      selectedCustomerInfo.style.display = 'block';
      newCustomerForm.style.display = 'none';
      hideSearchResults();
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–ï¼ˆé¸æŠæ¸ˆã¿ã‚’ç¤ºã™ï¼‰
      document.getElementById('customerSearch').disabled = true;
      document.getElementById('customerSearch').style.backgroundColor = '#e9ecef';
      
      // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
      loadCustomerTickets(userId);
      
      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      showMessage('é¡§å®¢ãŒé¸æŠã•ã‚Œã¾ã—ãŸ', 'success');
      
      console.log('é¡§å®¢ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', { userId, name, phone, email });
    }

    function showNewCustomerForm(initialName = '') {
      // æ–°è¦é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
      newCustomerForm.style.display = 'block';
      selectedCustomerInfo.style.display = 'none';
      document.getElementById('selectedUserId').value = '';
      
      // æ¤œç´¢ã—ãŸåå‰ã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
      if (initialName) {
        document.getElementById('newCustomerName').value = initialName;
      }
      
      hideSearchResults();
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«
      document.getElementById('newCustomerName').focus();
    }

    // é¡§å®¢é¸æŠã‚’ã‚¯ãƒªã‚¢
    document.getElementById('clearCustomerBtn').addEventListener('click', function() {
      document.getElementById('selectedUserId').value = '';
      document.getElementById('customerSearch').value = '';
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
      document.getElementById('customerSearch').disabled = false;
      document.getElementById('customerSearch').style.backgroundColor = 'white';
      
      selectedCustomerInfo.style.display = 'none';
      newCustomerForm.style.display = 'none';
      document.getElementById('ticketInfo').innerHTML = `
        <div class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      `;
      customerSearch.focus();
      
      showMessage('é¡§å®¢é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
    });

    function resetReservationForm() {
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('reservationForm').reset();
      document.getElementById('currentReservationId').value = '';
      document.getElementById('selectedUserId').value = '';
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('cancellationReason').value = '';
      document.getElementById('cancellationReasonRow').style.display = 'none';
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
      document.getElementById('customerSearch').disabled = false;
      document.getElementById('customerSearch').style.backgroundColor = 'white';
      
      // UIè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
      selectedCustomerInfo.style.display = 'none';
      newCustomerForm.style.display = 'none';
      hideSearchResults();
      
      // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('ticketInfo').innerHTML = `
        <div class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      `;
    }
    
    // ã“ã®é–¢æ•°ã‚’ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å…ˆé ­ï¼ˆline 530ä»˜è¿‘ï¼‰ã«è¿½åŠ 
    function getCourseDuration(course) {
      switch(course) {
        case '40åˆ†ã‚³ãƒ¼ã‚¹': return 40;
        case '60åˆ†ã‚³ãƒ¼ã‚¹': return 60;
        case '80åˆ†ã‚³ãƒ¼ã‚¹': return 80;
        default: return 60;
      }
    }
    // openReservationModal é–¢æ•°ã‚’å®Œå…¨ã«ç½®ãæ›ãˆï¼ˆ522è¡Œç›®ä»˜è¿‘ï¼‰
    function openReservationModal(event) {
      // æ—¢å­˜ã®äºˆç´„ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
      document.getElementById('reservationModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>äºˆç´„ç·¨é›†';
      document.getElementById('deleteReservationBtn').style.display = 'block';
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetReservationForm();
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
      if (event) {
        // äºˆç´„IDã‚’è¨­å®š
        document.getElementById('currentReservationId').value = event.id;
        
        // ğŸ”§ å®Œå…¨ãªä¿®æ­£: UTCå¤‰æ›ã‚’é¿ã‘ã¦ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã‚’ç›´æ¥å–å¾—
        const eventStart = event.start;
        
        // æ—¥ä»˜ã®å–å¾—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã¨ã—ã¦ï¼‰
        const year = eventStart.getFullYear();
        const month = String(eventStart.getMonth() + 1).padStart(2, '0');
        const day = String(eventStart.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        // æ™‚é–“ã®å–å¾—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã¨ã—ã¦ï¼‰
        const hours = String(eventStart.getHours()).padStart(2, '0');
        const minutes = String(eventStart.getMinutes()).padStart(2, '0');
        const timeString = `${hours}:${minutes}`;
        
        console.log('ğŸ• Edit reservation time:', {
          original: eventStart,
          dateString: dateString,
          timeString: timeString
        });
        
        document.getElementById('reservationDate').value = dateString;
        document.getElementById('reservationTime').value = timeString;
        document.getElementById('reservationCourse').value = event.title.split(' - ')[1] || '';
        document.getElementById('reservationStatus').value = event.extendedProps?.status || 'confirmed';
        document.getElementById('reservationMemo').value = event.extendedProps?.note || '';
        
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šã‚’è¨­å®š
        const individualInterval = event.extendedProps?.individual_interval_minutes;
        document.getElementById('reservationInterval').value = individualInterval || '';
        
        // ç¾åœ¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’æ›´æ–°
        updateIntervalInfo(event.extendedProps);
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’è¨­å®š
        const cancellationReason = event.extendedProps?.cancellation_reason || '';
        document.getElementById('cancellationReason').value = cancellationReason;
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å ´åˆã¯ç†ç”±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
        if (event.extendedProps?.status === 'cancelled') {
          document.getElementById('cancellationReasonRow').style.display = 'block';
        }
        
        // é¡§å®¢æƒ…å ±ã‚’è¨­å®šï¼ˆæ–°ã—ã„é¡§å®¢æ¤œç´¢æ©Ÿèƒ½ã«å¯¾å¿œï¼‰
        if (event.extendedProps?.customer) {
          const customer = event.extendedProps.customer;
          
          // é¡§å®¢é¸æŠçŠ¶æ…‹ã‚’è¨­å®š
          document.getElementById('selectedUserId').value = customer.id;
          document.getElementById('customerSearch').value = customer.name || '';
          
          // é¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º
          document.getElementById('selectedCustomerName').textContent = customer.name || '';
          document.getElementById('selectedCustomerDetails').innerHTML = `
            ${customer.phone || 'é›»è©±ç•ªå·æœªç™»éŒ²'} | 
            ${customer.email || 'ãƒ¡ãƒ¼ãƒ«æœªç™»éŒ²'}
          `;
          
          // UIæ›´æ–°
          document.getElementById('selectedCustomerInfo').style.display = 'block';
          document.getElementById('newCustomerForm').style.display = 'none';
          
          // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
          document.getElementById('customerSearch').disabled = true;
          document.getElementById('customerSearch').style.backgroundColor = '#e9ecef';
          
          // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
          loadCustomerTickets(customer.id);
        }
      }
      
      reservationModal.show();
    }

    // openNewReservationModal é–¢æ•°ã‚‚åŒæ§˜ã«ä¿®æ­£ï¼ˆ561è¡Œç›®ä»˜è¿‘ï¼‰
    function openNewReservationModal(start, end) {
      // æ–°è¦äºˆç´„ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
      document.getElementById('reservationModalLabel').innerHTML = '<i class="fas fa-calendar-plus me-2"></i>æ–°è¦äºˆç´„';
      document.getElementById('deleteReservationBtn').style.display = 'none';
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetReservationForm();
      
      // äºˆç´„IDã‚’ã‚¯ãƒªã‚¢
      document.getElementById('currentReservationId').value = '';
      
      // æ—¥æ™‚ã‚’è¨­å®š
      if (start) {
        // ğŸ”§ å®Œå…¨ãªä¿®æ­£: UTCå¤‰æ›ã‚’é¿ã‘ã¦ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã‚’ç›´æ¥å–å¾—
        const eventStart = new Date(start);
        
        const year = eventStart.getFullYear();
        const month = String(eventStart.getMonth() + 1).padStart(2, '0');
        const day = String(eventStart.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        const hours = String(eventStart.getHours()).padStart(2, '0');
        const minutes = String(eventStart.getMinutes()).padStart(2, '0');
        const timeString = `${hours}:${minutes}`;
        
        console.log('ğŸ• New reservation time:', {
          original: start,
          eventStart: eventStart,
          dateString: dateString,
          timeString: timeString
        });
        
        document.getElementById('reservationDate').value = dateString;
        document.getElementById('reservationTime').value = timeString;
      }
      
      reservationModal.show();
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“æ›´æ–°æ©Ÿèƒ½
    function updateReservationTime(event) {
      const reservationId = event.id;
      const newStart = event.start;
      const newEnd = event.end;
      
      console.log('ğŸ”„ Updating reservation time:', {
        id: reservationId,
        start: newStart,
        end: newEnd,
        extendedProps: event.extendedProps
      });
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      
      // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã‚’æ—¥æœ¬æ™‚é–“ã¨ã—ã¦æ˜ç¤ºçš„ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆUTCå¤‰æ›ã‚’é¿ã‘ã‚‹ï¼‰
      function formatAsJSTDateTime(date) {
        if (!date) return null;
        
        // TimeWithZoneã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯é©åˆ‡ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
        const year = date.getFullYear ? date.getFullYear() : date.year;
        const month = date.getMonth ? String(date.getMonth() + 1).padStart(2, '0') : String(date.month).padStart(2, '0');
        const day = date.getDate ? String(date.getDate()).padStart(2, '0') : String(date.day).padStart(2, '0');
        const hours = date.getHours ? String(date.getHours()).padStart(2, '0') : String(date.hour).padStart(2, '0');
        const minutes = date.getMinutes ? String(date.getMinutes()).padStart(2, '0') : String(date.min).padStart(2, '0');
        const seconds = date.getSeconds ? String(date.getSeconds()).padStart(2, '0') : String(date.sec).padStart(2, '0');
        
        // JSTï¼ˆUTC+09:00ï¼‰ã¨ã—ã¦æ˜ç¤ºçš„ã«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æŒ‡å®š
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}+09:00`;
      }
      
      // ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã®æ™‚é–“ã‚’ãã®ã¾ã¾é€ä¿¡ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§é©åˆ‡ã«å‡¦ç†ï¼‰
      const startISO = formatAsJSTDateTime(newStart);
      const endISO = formatAsJSTDateTime(newEnd);
      
      console.log('ğŸ• Drag time conversion:', {
        start: newStart,
        end: newEnd,
        startISO: startISO,
        endISO: endISO,
        effectiveIntervalMinutes: event.extendedProps?.effective_interval_minutes || 0
      });
      
      console.log('ğŸ• Time conversion:', {
        start: newStart,
        end: newEnd,
        startISO: startISO,
        endISO: endISO,
        startLocalTime: newStart.toLocaleString('ja-JP'),
        endLocalTime: newEnd.toLocaleString('ja-JP'),
        effectiveIntervalMinutes: event.extendedProps?.effective_interval_minutes || 0
      });
      
      // æ™‚é–“æ›´æ–°APIã‚’å‘¼ã³å‡ºã—
      fetch(`/admin/reservations/${reservationId}`, {
        method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({
          reservation: {
            start_time: startISO,
            end_time: endISO
          },
          is_drag_update: true
        })
    })
    .then(response => {
        console.log('ğŸ“¡ Update response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
      return response.json();
    })
    .then(data => {
        console.log('âœ… Time update response:', data);
      
      if (data.success) {
          showMessage('äºˆç´„æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
          
          // æˆåŠŸæ™‚ã‚‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
          setTimeout(() => {
            calendar.refetchEvents();
          }, 500);
        } else {
          throw new Error(data.error || 'æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Time update error:', error);
        showMessage('æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'danger');
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿
        calendar.refetchEvents();
      });
    }
    
    function loadCustomerTickets(customerId) {
      if (!customerId) return;
      
      fetch(`/admin/users/${customerId}/tickets`)
        .then(response => response.json())
        .then(tickets => {
          const ticketInfo = document.getElementById('ticketInfo');
          if (tickets.length > 0) {
            let html = '<div class="row">';
            tickets.forEach(ticket => {
              const statusClass = ticket.status === 'expired' ? 'text-danger' : 
                                ticket.status === 'low' ? 'text-warning' : 'text-success';
              html += `
                <div class="col-md-6 mb-2">
                  <div class="card">
                    <div class="card-body p-2">
                      <h6 class="card-title mb-1">${ticket.name}</h6>
                                             <p class="card-text mb-1">
                         <small class="text-muted">
                           æ®‹ã‚Š: ${ticket.remaining}/${ticket.total}å›
                         </small>
                       </p>
                       <p class="card-text mb-1">
                         <small class="text-muted">
                           æœŸé™: ${ticket.expires_at || 'ãªã—'}
                         </small>
                       </p>
                       <p class="card-text mb-0">
                         <small class="${statusClass}">
                           ${ticket.status === 'expired' ? 'æœŸé™åˆ‡ã‚Œ' : 
                             ticket.status === 'low' ? 'æ®‹ã‚Šå°‘ãªã„' : 'åˆ©ç”¨å¯èƒ½'}
                         </small>
                       </p>
                    </div>
                  </div>
                </div>
              `;
            });
            html += '</div>';
            ticketInfo.innerHTML = html;
      } else {
            ticketInfo.innerHTML = '<div class="text-muted">ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }
    })
    .catch(error => {
          console.error('Error loading tickets:', error);
          document.getElementById('ticketInfo').innerHTML = '<div class="text-danger">ãƒã‚±ãƒƒãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã®å‡¦ç†
    document.getElementById('reservationStatus').addEventListener('change', function() {
      const status = this.value;
      console.log('ğŸ“Š Status changed to:', status);
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
      const cancellationReasonRow = document.getElementById('cancellationReasonRow');
      if (status === 'cancelled') {
        cancellationReasonRow.style.display = 'block';
      } else {
        cancellationReasonRow.style.display = 'none';
        document.getElementById('cancellationReason').value = '';
      }
    });

    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šå¤‰æ›´æ™‚ã®å‡¦ç†
    document.getElementById('reservationInterval').addEventListener('change', function() {
      const intervalValue = this.value;
      const intervalInfo = document.getElementById('currentIntervalInfo');
      
      if (intervalValue === '') {
        intervalInfo.innerHTML = '<span class="badge bg-primary">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: 15åˆ†</span>';
      } else {
        intervalInfo.innerHTML = `<span class="badge bg-success">å€‹åˆ¥è¨­å®š: ${intervalValue}åˆ†</span>`;
      }
    });

    // ä¿å­˜ãƒœã‚¿ãƒ³
    document.getElementById('saveReservationBtn').addEventListener('click', function() {
      console.log('ğŸ’¾ Save button clicked');
      
      // é¡§å®¢é¸æŠã®ãƒã‚§ãƒƒã‚¯
      const selectedUserId = document.getElementById('selectedUserId').value;
      if (!selectedUserId) {
        console.log('âŒ No customer selected');
        showMessage('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    
      // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
      const reservationDate = document.getElementById('reservationDate').value;
      const reservationTime = document.getElementById('reservationTime').value;
      const reservationCourse = document.getElementById('reservationCourse').value;
      
      if (!reservationDate || !reservationTime || !reservationCourse) {
        console.log('âŒ Required fields missing:', { reservationDate, reservationTime, reservationCourse });
        showMessage('æ—¥æ™‚ã¨ã‚³ãƒ¼ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      // æ™‚é–“ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼ˆ10:00-21:00ï¼‰
      const timeParts = reservationTime.split(':');
      const hours = parseInt(timeParts[0]);
      const minutes = parseInt(timeParts[1]);
      
      if (hours < 10 || hours >= 21) {
        console.log('âŒ Time out of range:', reservationTime);
        showMessage('äºˆç´„æ™‚é–“ã¯10:00ã‹ã‚‰21:00ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      // ã‚³ãƒ¼ã‚¹æ™‚é–“ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’è€ƒæ…®ã—ãŸå–¶æ¥­æ™‚é–“ãƒã‚§ãƒƒã‚¯
      const courseDuration = getCourseDuration(reservationCourse);
      const checkIntervalValue = document.getElementById('reservationInterval').value;
      const intervalDuration = checkIntervalValue ? parseInt(checkIntervalValue) : 15; // ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      const totalDuration = courseDuration + intervalDuration;
      
      // äºˆç´„çµ‚äº†æ™‚åˆ»ã‚’è¨ˆç®—
      const startTime = new Date(`${reservationDate}T${reservationTime}:00`);
      const endTime = new Date(startTime.getTime() + totalDuration * 60 * 1000);
      const endHour = endTime.getHours();
      const endMinute = endTime.getMinutes();
      
      console.log('ğŸ• Reservation time check:', {
        startTime: reservationTime,
        courseDuration,
        intervalDuration,
        totalDuration,
        endTime: `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`,
        businessEnd: '21:00'
      });
      
      if (endHour > 21 || (endHour === 21 && endMinute > 0)) {
        console.log('âŒ Reservation extends beyond business hours');
        showMessage(`ã“ã®äºˆç´„ã¯å–¶æ¥­æ™‚é–“å¤–ã«ãªã‚Šã¾ã™ã€‚çµ‚äº†æ™‚åˆ»: ${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`, 'warning');
        return;
      }
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const saveBtn = this;
      const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';
      
      // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—
      const reservationId = getCurrentReservationId();
      const isEditMode = reservationId && reservationId !== '';
      
      // é¸æŠã•ã‚ŒãŸé¡§å®¢IDã‚’å–å¾—ï¼ˆæ—¢ã«å®£è¨€æ¸ˆã¿ï¼‰
      console.log('ğŸ‘¤ Selected user ID:', selectedUserId);
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã®ãƒã‚§ãƒƒã‚¯
      const status = document.getElementById('reservationStatus').value;
      const cancellationReason = document.getElementById('cancellationReason').value;
      
      if (status === 'cancelled' && !cancellationReason.trim()) {
        console.log('âŒ Cancellation reason required');
        showMessage('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šã‚’å–å¾—
      const intervalValue = document.getElementById('reservationInterval').value;
      let individualIntervalMinutes = null;
      
      if (intervalValue !== '' && !isNaN(parseInt(intervalValue))) {
        individualIntervalMinutes = parseInt(intervalValue);
      }
      
      console.log('ğŸ• Interval setting:', { intervalValue, individualIntervalMinutes });
      
      // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      const reservationData = {
        reservation: {
          user_id: selectedUserId,
          name: document.getElementById('customerSearch').value,
          date: document.getElementById('reservationDate').value,
          time: document.getElementById('reservationTime').value,
          course: document.getElementById('reservationCourse').value,
          status: document.getElementById('reservationStatus').value,
          cancellation_reason: cancellationReason,
          individual_interval_minutes: individualIntervalMinutes,
          note: document.getElementById('reservationMemo').value
        }
      };
      
      console.log('ğŸ’¾ Saving reservation:', reservationData);
      console.log('ğŸ• Individual interval minutes in payload:', reservationData.reservation.individual_interval_minutes);
      console.log('ğŸ“ Edit mode:', isEditMode);
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      console.log('ğŸ” CSRF Token:', csrfToken);
      
      // API URLã¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ±ºå®š
      const url = isEditMode ? `/admin/reservations/${reservationId}` : '/admin/reservations';
      const method = isEditMode ? 'PATCH' : 'POST';
      console.log('ğŸŒ API URL:', url);
      console.log('ğŸ“¡ Method:', method);
      
      // APIã‚’å‘¼ã³å‡ºã—
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify(reservationData)
      })
      .then(response => {
        console.log('ğŸ“¡ Save response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ… Save response:', data);
        
        if (data.success) {
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const message = isEditMode ? 'äºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'äºˆç´„ã‚’ä½œæˆã—ã¾ã—ãŸ';
          showMessage(message, 'success');
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          reservationModal.hide();
          
          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
          calendar.refetchEvents();
          
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã®æ›´æ–°ã¯ç„¡åŠ¹åŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ãªã‚‹ãŸã‚ï¼‰
          console.log('âœ… Reservation saved successfully, calendar updated');
  } else {
          throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Save error:', error);
        alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .finally(() => {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      });
    });
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³
    document.getElementById('deleteReservationBtn').addEventListener('click', function() {
      if (!confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå‰Šé™¤ã—ãŸäºˆç´„ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚')) {
        return;
      }
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const deleteBtn = this;
      const originalText = deleteBtn.innerHTML;
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>å‰Šé™¤ä¸­...';
      
      // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ï¼‰
      const reservationId = getCurrentReservationId();
      
      if (!reservationId) {
        alert('å‰Šé™¤ã™ã‚‹äºˆç´„ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
        return;
      }
      
      console.log('ğŸ—‘ï¸ Deleting reservation:', reservationId);
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      
      // å‰Šé™¤APIã‚’å‘¼ã³å‡ºã—
      fetch(`/admin/reservations/${reservationId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        }
      })
      .then(response => {
        console.log('ğŸ“¡ Delete response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ… Delete response:', data);
        
        if (data.success) {
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          showMessage('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          reservationModal.hide();
          
          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
          calendar.refetchEvents();
        } else {
          throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Delete error:', error);
        alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .finally(() => {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
      });
    });
    
    // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getCurrentReservationId() {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰äºˆç´„IDã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’å®Ÿè£…
      // ä¾‹: ãƒ¢ãƒ¼ãƒ€ãƒ«ã«éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆ
      const hiddenField = document.getElementById('currentReservationId');
      return hiddenField ? hiddenField.value : null;
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
    function showMessage(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // ãƒšãƒ¼ã‚¸ã®ä¸Šéƒ¨ã«è¡¨ç¤º
      const container = document.querySelector('.calendar-container');
      container.insertBefore(alertDiv, container.firstChild);
      
      // 3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openCancelledHistoryModal = function() {
      console.log('ğŸ“Š Opening cancelled history modal');
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã‚’å–å¾—ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤º
      fetch('/admin/reservations/cancellation_stats')
        .then(response => {
          console.log('ğŸ“Š Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('ğŸ“Š Received data for modal:', data);
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çµ±è¨ˆã‚’æ›´æ–°
          document.getElementById('modalCancelledCount').textContent = data.cancelled_count;
          document.getElementById('modalCancelledRate').textContent = data.cancelled_rate + '%';
          document.getElementById('modalTotalReservations').textContent = data.total_reservations || 0;
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å±¥æ­´ã‚’æ›´æ–°
          const modalHistoryContainer = document.getElementById('modalCancelledHistory');
          if (data.cancelled_history && data.cancelled_history.length > 0) {
            console.log('ğŸ“Š Rendering modal history:', data.cancelled_history.length, 'items');
            const historyHtml = data.cancelled_history.map(item => `
              <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="fw-bold text-dark fs-6">${item.customer_name}</div>
                    <div class="small text-muted mt-1">
                      <i class="fas fa-calendar me-1"></i>${item.cancelled_at}
                      <span class="mx-2">|</span>
                      <i class="fas fa-clock me-1"></i>${item.course}
                    </div>
                  </div>
                </div>
                <div class="mt-2">
                  <span class="badge bg-danger">
                    <i class="fas fa-times-circle me-1"></i>
                    ${item.reason || 'ç†ç”±æœªå…¥åŠ›'}
                  </span>
                </div>
              </div>
            `).join('');
            modalHistoryContainer.innerHTML = historyHtml;
          } else {
            console.log('ğŸ“Š No cancellation history found for modal');
            modalHistoryContainer.innerHTML = `
              <div class="text-muted text-center py-4">
                <i class="fas fa-info-circle me-1"></i>
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
              </div>
            `;
          }
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          const modal = new bootstrap.Modal(document.getElementById('cancelledHistoryModal'));
          modal.show();
        })
        .catch(error => {
          console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã®å–å¾—ã«å¤±æ•—:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
          const modalCancelledCount = document.getElementById('modalCancelledCount');
          const modalCancelledRate = document.getElementById('modalCancelledRate');
          const modalTotalReservations = document.getElementById('modalTotalReservations');
          const modalCancelledHistory = document.getElementById('modalCancelledHistory');
          
          if (modalCancelledCount) modalCancelledCount.textContent = '0';
          if (modalCancelledRate) modalCancelledRate.textContent = '0%';
          if (modalTotalReservations) modalTotalReservations.textContent = '0';
          if (modalCancelledHistory) {
            modalCancelledHistory.innerHTML = `
              <div class="text-muted text-center py-4">
                <i class="fas fa-exclamation-triangle me-1"></i>
                çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
              </div>
            `;
          }
          
          const modal = new bootstrap.Modal(document.getElementById('cancelledHistoryModal'));
          modal.show();
        });
    };
  });
</script>

<style>
  /* ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .fc-event.interval {
    font-weight: 500;
    border-radius: 4px;
  }
  
  /* ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼ˆç°è‰²ï¼‰ */
  .fc-event.interval.system-interval {
    background-color: #6c757d !important;
    border-color: #545b62 !important;
    color: white !important;
  }
  
  /* å€‹åˆ¥è¨­å®šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼ˆç°è‰²ï¼‰ */
  .fc-event.interval.individual-interval {
    background-color: #6c757d !important;
    border-color: #545b62 !important;
    color: white !important;
    font-weight: 600;
  }
  
  /* å€‹åˆ¥è¨­å®šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã«ç‰¹åˆ¥ãªã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ  */
  .fc-event.interval.individual-interval::before {
    content: "âš™ï¸ ";
    margin-right: 2px;
  }
  
  /* ãƒ›ãƒãƒ¼æ™‚ã®åŠ¹æœ */
  .fc-event.interval:hover {
    opacity: 0.8;
    transform: scale(1.02);
    transition: all 0.2s ease;
  }
  
  /* å€‹åˆ¥è¨­å®šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—é¢¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .fc-event.interval.individual-interval {
    position: relative;
  }
  
  .fc-event.interval.individual-interval:hover::after {
    content: "å€‹åˆ¥è¨­å®š";
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    white-space: nowrap;
    z-index: 1000;
}
</style>