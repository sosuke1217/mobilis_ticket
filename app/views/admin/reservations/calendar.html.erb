<%# å®Œå…¨ä¿®æ­£ç‰ˆ app/views/admin/reservations/calendar.html.erb - ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œ %>

<!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ãƒ¡ã‚¿ã‚¿ã‚°ã§æ¸¡ã™ -->
<meta name="business-hours-start" content="<%= ApplicationSetting.current.business_hours_start %>">
<meta name="business-hours-end" content="<%= ApplicationSetting.current.business_hours_end %>">
<meta name="slot-interval" content="<%= ApplicationSetting.current.slot_interval_minutes %>">
<meta name="reservation-interval" content="<%= ApplicationSetting.current.reservation_interval_minutes %>">
<meta name="sunday-closed" content="<%= ApplicationSetting.current.sunday_closed? %>">

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-calendar-alt me-2"></i>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰</h2>
        <div>
          <button type="button" class="btn btn-primary" onclick="openReservationModal()">
            <i class="fas fa-plus me-1"></i>æ–°è¦äºˆç´„
          </button>
          <button type="button" class="btn btn-secondary" onclick="refreshFixedCalendar()">
            <i class="fas fa-sync-alt me-1"></i>æ›´æ–°
          </button>
          <button type="button" class="btn btn-info btn-sm" onclick="testPositionAlignment()">
            <i class="fas fa-align-center me-1"></i>ä½ç½®ãƒ†ã‚¹ãƒˆ
          </button>
        </div>
      </div>
      
      <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
      <div id="calendar"></div>
    </div>
  </div>
</div>

<!-- äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="reservationModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-calendar-plus me-2"></i>
          <span id="modalTitle">äºˆç´„ç®¡ç†</span>
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="cleanupModal()"></button>
      </div>
      
      <div class="modal-body">
        <!-- èª­ã¿è¾¼ã¿ä¸­è¡¨ç¤º -->
        <div id="loadingIndicator" style="display: none;">
          <div class="text-center p-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">èª­ã¿è¾¼ã¿ä¸­...</span>
            </div>
            <div class="mt-2">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
        </div>
        
        <!-- ãƒ•ã‚©ãƒ¼ãƒ  -->
        <form id="reservationForm">
          <input type="hidden" id="reservationId">
          
          <div class="row">
            <div class="col-md-6">
              <label class="form-label">ãŠå®¢æ§˜ <span class="text-danger">*</span></label>
              <select class="form-select" id="reservationUserId" required>
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">ã‚³ãƒ¼ã‚¹</label>
              <select class="form-select" id="reservationCourse">
                <option value="40åˆ†">40åˆ†ã‚³ãƒ¼ã‚¹</option>
                <option value="60åˆ†" selected>60åˆ†ã‚³ãƒ¼ã‚¹</option>
                <option value="80åˆ†">80åˆ†ã‚³ãƒ¼ã‚¹</option>
              </select>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-md-6">
              <label class="form-label">äºˆç´„æ—¥ <span class="text-danger">*</span></label>
              <input type="date" class="form-control" id="reservationDate" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">é–‹å§‹æ™‚é–“ <span class="text-danger">*</span></label>
              <select class="form-select" id="reservationTime" required>
                <!-- JavaScriptã§ç”Ÿæˆ -->
              </select>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-md-6">
              <label class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <select class="form-select" id="reservationStatus">
                <option value="confirmed">ç¢ºå®š</option>
                <option value="tentative">ä»®äºˆç´„</option>
                <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                <option value="completed">å®Œäº†</option>
                <option value="no_show">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">çµ‚äº†äºˆå®šæ™‚é–“</label>
              <input type="text" class="form-control" id="endTimeDisplay" readonly style="background-color: #f8f9fa;">
            </div>
          </div>
          
          <div class="mt-3">
            <label class="form-label">å‚™è€ƒ</label>
            <textarea class="form-control" id="reservationNote" rows="2" placeholder="ç‰¹åˆ¥ãªè¦æœ›ã‚„æ³¨æ„äº‹é …ãªã©"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <div>
          <button type="button" id="deleteReservationBtn" class="btn btn-danger d-none">
            <i class="fas fa-trash me-1"></i>å‰Šé™¤
          </button>
        </div>
        <div>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="cleanupModal()">é–‰ã˜ã‚‹</button>
          <button type="button" class="btn btn-primary" onclick="saveReservation()">
            <i class="fas fa-save me-1"></i>ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  console.log('ğŸš€ Complete Fixed Calendar with Rails integration loading...');
  
  let pageCalendar = null;
  let currentUsers = [];
  let currentReservationId = null;

  // ========================================
  // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šèª­ã¿å–ã‚Šï¼ˆãƒ¡ã‚¿ã‚¿ã‚°ã‹ã‚‰ï¼‰
  // ========================================
  function getSystemSettings() {
    const systemSettings = {
      businessHoursStart: parseInt(document.querySelector('meta[name="business-hours-start"]')?.content || '10'),
      businessHoursEnd: parseInt(document.querySelector('meta[name="business-hours-end"]')?.content || '20'),
      slotIntervalMinutes: parseInt(document.querySelector('meta[name="slot-interval"]')?.content || '10'),
      reservationIntervalMinutes: parseInt(document.querySelector('meta[name="reservation-interval"]')?.content || '15'),
      sundayClosed: document.querySelector('meta[name="sunday-closed"]')?.content === 'true'
    };
    
    console.log('ğŸ“Š System settings loaded from Rails:', systemSettings);
    return systemSettings;
  }

  // ========================================
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¨­å®šæ§‹ç¯‰ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ä¿®æ­£æ¸ˆã¿ï¼‰
  // ========================================
  function buildCalendarConfig(systemSettings) {
    const config = {
      // åŸºæœ¬è¨­å®š
      initialView: window.innerWidth < 768 ? 'timeGridDay' : 'timeGridWeek',
      locale: 'ja',
      height: 'auto',
      
      // ğŸ”§ é‡è¦: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ˜ç¤ºçš„ã«è¨­å®šï¼ˆã“ã‚ŒãŒä¿®æ­£ã®ãƒã‚¤ãƒ³ãƒˆï¼‰
      timeZone: 'Asia/Tokyo',
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      
      // æ™‚é–“è»¸ã®è¨­å®š
      slotMinTime: `${systemSettings.businessHoursStart.toString().padStart(2, '0')}:00:00`,
      slotMaxTime: `${systemSettings.businessHoursEnd.toString().padStart(2, '0')}:00:00`,
      slotDuration: `00:${systemSettings.slotIntervalMinutes.toString().padStart(2, '0')}:00`,
      snapDuration: `00:${systemSettings.slotIntervalMinutes.toString().padStart(2, '0')}:00`,
      
      // æ™‚é–“è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
      slotLabelFormat: {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      },
      
      eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      },
      
      // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®
      scrollTime: `${systemSettings.businessHoursStart.toString().padStart(2, '0')}:00:00`,
      
      // å–¶æ¥­æ™‚é–“
      businessHours: {
        daysOfWeek: systemSettings.sundayClosed ? [1, 2, 3, 4, 5, 6] : [0, 1, 2, 3, 4, 5, 6],
        startTime: `${systemSettings.businessHoursStart.toString().padStart(2, '0')}:00`,
        endTime: `${systemSettings.businessHoursEnd.toString().padStart(2, '0')}:00`,
      },
      
      // ç·¨é›†æ©Ÿèƒ½
      editable: true,
      selectable: true,
      selectMirror: true,
      eventResizableFromStart: true,
      eventDurationEditable: true,
      dayMaxEvents: true,
      weekends: !systemSettings.sundayClosed,
      dragScroll: true,
      
      // ã‚¤ãƒ™ãƒ³ãƒˆã®é‡è¤‡è¨­å®š
      eventOverlap: function(stillEvent, movingEvent) {
        if (stillEvent.extendedProps.type === 'interval' && 
            movingEvent.extendedProps.type === 'interval') {
          return true;
        }
        return false;
      },
      selectOverlap: false,
      
      // åˆ¶ç´„è¨­å®š
      eventConstraint: 'businessHours',
      selectConstraint: 'businessHours',
      
      // Rails APIã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
      events: '/admin/reservations.json',
      
      // ğŸ”§ eventDataTransformã§æ™‚é–“ã‚’æ­£ã—ãå‡¦ç†
      eventDataTransform: function(eventData) {
        console.log('ğŸ”„ Processing Rails event (with timezone):', eventData.title);
        console.log('ğŸ“… Original times:', eventData.start, eventData.end);
        
        // æ™‚é–“ã‚’æ˜ç¤ºçš„ã«Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
        if (eventData.start) {
          eventData.start = new Date(eventData.start);
        }
        if (eventData.end) {
          eventData.end = new Date(eventData.end);
        }
        
        console.log('ğŸ“… Converted times:', eventData.start, eventData.end);
        return eventData;
      }
    };
    
    console.log('ğŸ”§ Complete Rails calendar config built with timezone:', config);
    return config;
  }

  // ========================================
  // CSSä½ç½®èª¿æ•´ã‚¹ã‚¿ã‚¤ãƒ«
  // ========================================
  function addPositionAdjustmentStyles() {
    const style = document.createElement('style');
    style.id = 'calendar-position-fix-complete';
    style.textContent = `
      /* æ™‚é–“ã‚¹ãƒ­ãƒƒãƒˆã®é«˜ã•ã‚’çµ±ä¸€ */
      .fc-timegrid-slot {
        height: 30px !important;
        min-height: 30px !important;
        max-height: 30px !important;
        border-bottom: 1px solid #e0e0e0 !important;
      }
      
      /* ä¸»è¦ãªæ™‚é–“ãƒ©ã‚¤ãƒ³å¼·èª¿ */
      .fc-timegrid-slot[data-time$=":00:00"],
      .fc-timegrid-slot[data-time$=":30:00"] {
        border-bottom: 2px solid #ddd !important;
      }
      
      /* ã‚¤ãƒ™ãƒ³ãƒˆä½ç½®èª¿æ•´ */
      .fc-timegrid-event-harness {
        margin-top: 0 !important;
        padding-top: 0 !important;
      }
      
      .fc-timegrid-event {
        margin-top: 0 !important;
        margin-bottom: 1px !important;
        border-radius: 4px !important;
        font-size: 0.85em !important;
      }
      
      /* æ™‚é–“è»¸è¡¨ç¤ºèª¿æ•´ */
      .fc-timegrid-axis {
        width: 65px !important;
        text-align: center !important;
        background-color: #f8f9fa !important;
      }
      
      .fc-timegrid-slot-label {
        vertical-align: middle !important;
        font-size: 0.85em !important;
        padding: 2px 4px !important;
        color: #666 !important;
        font-weight: 500 !important;
      }
      
      /* äºˆç´„ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
      .fc-event.reservation-event {
        background-color: #28a745 !important;
        border: 2px solid #28a745 !important;
        color: white !important;
        font-weight: 500 !important;
        cursor: grab !important;
        transition: all 0.2s ease !important;
      }
      
      .fc-event.reservation-event:hover {
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 8px rgba(0,123,0,0.3) !important;
      }
      
      .fc-event.reservation-event.tentative {
        background-color: #ffc107 !important;
        border: 2px solid #ffc107 !important;
        color: #212529 !important;
      }
      
      /* ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
      .fc-event.interval-event {
        background-color: #e9ecef !important;
        border: 1px dashed #6c757d !important;
        color: #6c757d !important;
        font-size: 0.75em !important;
        font-style: italic !important;
        opacity: 0.8 !important;
        cursor: grab !important;
      }
      
      .fc-event.interval-event:hover {
        opacity: 1 !important;
        background-color: #dee2e6 !important;
      }
      
      /* ä¸€ä½“åŒ–è¡¨ç¤ºã‚¹ã‚¿ã‚¤ãƒ« */
      .fc-event.reservation-event.with-interval {
        background: linear-gradient(to bottom, 
          #28a745 0%, 
          #28a745 75%, 
          rgba(108, 117, 125, 0.4) 75%, 
          rgba(108, 117, 125, 0.4) 100%) !important;
        border-left: 4px solid #28a745 !important;
        border-right: 2px dashed #6c757d !important;
      }
      
      .fc-event.reservation-event.with-interval.tentative {
        background: linear-gradient(to bottom, 
          #ffc107 0%, 
          #ffc107 75%, 
          rgba(108, 117, 125, 0.4) 75%, 
          rgba(108, 117, 125, 0.4) 100%) !important;
        border-left: 4px solid #ffc107 !important;
      }
      
      /* ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .fc-event-dragging {
        opacity: 0.7 !important;
        transform: rotate(2deg) !important;
        box-shadow: 0 6px 12px rgba(0,0,0,0.3) !important;
        z-index: 9999 !important;
      }
      
      /* é¸æŠç¯„å›²ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .fc-highlight {
        background: rgba(0, 123, 255, 0.1) !important;
        border: 2px dashed #007bff !important;
      }
      
      /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
      @media (max-width: 768px) {
        .fc-timegrid-axis {
          width: 50px !important;
        }
        
        .fc-timegrid-slot {
          height: 25px !important;
          min-height: 25px !important;
          max-height: 25px !important;
        }
        
        .fc-event {
          font-size: 0.75em !important;
        }
      }
      
      /* é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      #messageContainer {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        pointer-events: none;
      }
      
      #messageContainer .alert {
        margin-bottom: 10px;
        pointer-events: auto;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border: none;
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      
      #messageContainer .alert-success {
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
        color: #155724;
        border-left: 4px solid #28a745;
      }
      
      #messageContainer .alert-info {
        background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }
      
      #messageContainer .alert-warning {
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        color: #856404;
        border-left: 4px solid #ffc107;
      }
      
      #messageContainer .alert-danger {
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
        color: #721c24;
        border-left: 4px solid #dc3545;
      }
    `;
    
    const existingStyle = document.getElementById('calendar-position-fix-complete');
    if (existingStyle) {
      existingStyle.remove();
    }
    
    document.head.appendChild(style);
    console.log('ğŸ¨ Complete Rails calendar position adjustment styles added');
  }

  // ========================================
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
  // ========================================
  function showMessage(message, type = 'info') {
    console.log(`ğŸ“¢ ${type.toUpperCase()}: ${message}`);
    
    let messageContainer = document.getElementById('messageContainer');
    if (!messageContainer) {
      messageContainer = document.createElement('div');
      messageContainer.id = 'messageContainer';
      document.body.appendChild(messageContainer);
    }
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.style.cssText = `
      opacity: 0;
      transform: translateX(100%);
      transition: all 0.3s ease;
    `;
    
    const getIcon = (type) => {
      switch(type) {
        case 'success': return 'âœ…';
        case 'danger': return 'âŒ';
        case 'warning': return 'âš ï¸';
        case 'info': return 'â„¹ï¸';
        default: return 'â„¹ï¸';
      }
    };
    
    alertDiv.innerHTML = `
      <div style="display: flex; align-items: center;">
        <span style="margin-right: 8px; font-size: 16px;">${getIcon(type)}</span>
        <span>${message}</span>
      </div>
      <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    messageContainer.appendChild(alertDiv);
    
    setTimeout(() => {
      alertDiv.style.opacity = '1';
      alertDiv.style.transform = 'translateX(0)';
    }, 10);
    
    const duration = type === 'info' ? 2000 : type === 'success' ? 3000 : 4000;
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.style.opacity = '0';
        alertDiv.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
          }
        }, 300);
      }
    }, duration);
  }

  // ========================================
  // äºˆç´„ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¡¨ç¤ºã‚’çµ±åˆã™ã‚‹é–¢æ•°ï¼ˆä¿®æ­£ç‰ˆ - çµ‚äº†æ™‚é–“ã‚’å¤‰æ›´ã—ãªã„ï¼‰
  // ========================================
  function enhanceReservationWithInterval(eventElement, event, intervalMinutes) {
    console.log(`ğŸ“Š Enhancing reservation ${event.id} with ${intervalMinutes}min interval`);
    
    eventElement.classList.add('with-interval');
    
    // ğŸ”§ é‡è¦: ã‚¤ãƒ™ãƒ³ãƒˆã®çµ‚äº†æ™‚é–“ã¯å¤‰æ›´ã—ãªã„ï¼ˆã“ã‚ŒãŒæ¶ˆãˆã‚‹åŸå› ã ã£ãŸï¼‰
    // const originalEnd = new Date(event.end);
    // const newEnd = new Date(originalEnd.getTime() + intervalMinutes * 60000);
    // event.setEnd(newEnd);  â† ã“ã®è¡Œã‚’å‰Šé™¤
    
    // ã‚¿ã‚¤ãƒˆãƒ«ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’è¿½åŠ 
    const titleElement = eventElement.querySelector('.fc-event-title');
    if (titleElement) {
      const originalTitle = titleElement.textContent;
      titleElement.innerHTML = `
        <div style="font-weight: bold; margin-bottom: 2px;">${originalTitle}</div>
        <div style="font-size: 0.7em; opacity: 0.8; font-style: italic;">
          + ${intervalMinutes}åˆ†é–“éš”
        </div>
      `;
    }
    
    eventElement.title = `${event.title}\nã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«: ${intervalMinutes}åˆ†å«ã‚€\nã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°è¡¨ç¤º`;
    
    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«åŒºåˆ‡ã‚Šãƒ©ã‚¤ãƒ³ã‚’è¿½åŠ 
    const intervalDivider = document.createElement('div');
    intervalDivider.style.cssText = `
      position: absolute;
      top: 75%;
      left: 2px;
      right: 2px;
      height: 1px;
      background: linear-gradient(to right, 
        transparent 0%, 
        #6c757d 20%, 
        #6c757d 80%, 
        transparent 100%);
      z-index: 1;
    `;
    eventElement.style.position = 'relative';
    eventElement.appendChild(intervalDivider);
    
    console.log(`âœ… Enhanced reservation ${event.id} without changing end time`);
  }

  // ========================================
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–ï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰
  // ========================================
  function initializeFixedCalendar() {
    console.log('ğŸ”§ Initializing complete fixed Rails calendar...');
    
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
      console.error('âŒ Calendar element not found');
      return;
    }
    
    if (typeof FullCalendar === 'undefined') {
      console.error('âŒ FullCalendar not available');
      setTimeout(initializeFixedCalendar, 500);
      return;
    }
    
    if (pageCalendar) {
      console.log('ğŸ—‘ï¸ Destroying existing calendar');
      pageCalendar.destroy();
      pageCalendar = null;
    }
    
    addPositionAdjustmentStyles();
    
    const systemSettings = getSystemSettings();
    const config = buildCalendarConfig(systemSettings);
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
    config.eventClick = function(info) {
      console.log('ğŸ“… Event clicked:', info.event.id, info.event.extendedProps.type);
      const eventType = info.event.extendedProps.type;
      
      if (eventType === 'interval') {
        const reservationId = info.event.extendedProps.reservation_id;
        const intervalMinutes = info.event.extendedProps.interval_minutes || 
                               Math.round((info.event.end - info.event.start) / (1000 * 60));
        
        showMessage(`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ (${intervalMinutes}åˆ†) - é–¢é€£äºˆç´„: ${reservationId}`, 'info');
        
        if (reservationId) {
          openReservationModal(reservationId);
        }
      } else {
        openReservationModal(info.event.id);
      }
    };
    
    config.dateClick = function(info) {
      console.log('ğŸ“… Date clicked:', info.dateStr);
      openReservationModal(null, info.dateStr);
    };
    
    config.select = function(info) {
      console.log('ğŸ“… Range selected:', info.startStr, 'to', info.endStr);
      openReservationModal(null, info.startStr);
    };
    
    // ğŸ”§ ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
    config.eventDrop = function(info) {
      console.log('ğŸ”„ Event dropped:', info.event.id);
      console.log('ğŸ“… Drop details:', {
        start: info.event.start,
        end: info.event.end,
        allDay: info.event.allDay,
        type: info.event.extendedProps.type
      });
      
      const eventType = info.event.extendedProps.type;
      
      // ãƒ‰ãƒ­ãƒƒãƒ—å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
      if (!info.event.start || !info.event.end) {
        console.error('âŒ Invalid event times after drop');
        info.revert();
        return;
      }
      
      // ğŸ”§ é‡è¦: ãƒ‰ãƒ­ãƒƒãƒ—ä¸­ã¯ä¸€æ™‚çš„ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–
      info.event.setProp('editable', false);
      info.event.setProp('startEditable', false);
      info.event.setProp('durationEditable', false);
      
      if (eventType === 'interval') {
        updateIntervalTime(info.event, info.revert);
      } else {
        updateReservationTime(info.event, info.revert);
      }
    };
    
    config.eventResize = function(info) {
      console.log('ğŸ”„ Event resized:', info.event.id);
      console.log('ğŸ“ Resize details:', {
        start: info.event.start,
        end: info.event.end,
        type: info.event.extendedProps.type
      });
      
      const eventType = info.event.extendedProps.type;
      
      // ãƒªã‚µã‚¤ã‚ºå¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
      if (!info.event.start || !info.event.end) {
        console.error('âŒ Invalid event times after resize');
        info.revert();
        return;
      }
      
      // ğŸ”§ é‡è¦: ãƒªã‚µã‚¤ã‚ºä¸­ã¯ä¸€æ™‚çš„ã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç„¡åŠ¹åŒ–
      info.event.setProp('editable', false);
      info.event.setProp('startEditable', false);
      info.event.setProp('durationEditable', false);
      
      if (eventType === 'interval') {
        updateIntervalTime(info.event, info.revert);
      } else {
        updateReservationTime(info.event, info.revert);
      }
    };
    
    config.eventDragStart = function(info) {
      console.log('ğŸ¯ Drag started:', info.event.id);
      const eventType = info.event.extendedProps.type;
      
      if (eventType !== 'interval') {
        // äºˆç´„ã®ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã€é–¢é€£ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’è¦‹ã¤ã‘ã¦è¨˜éŒ²
        const reservationId = info.event.id;
        const relatedInterval = pageCalendar.getEvents().find(event => 
          event.extendedProps.type === 'interval' && 
          event.extendedProps.reservation_id == reservationId
        );
        
        if (relatedInterval) {
          console.log('ğŸ”— Found related interval:', relatedInterval.id);
          // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã®å…ƒã®ä½ç½®ã‚’è¨˜éŒ²
          info.event._originalIntervalStart = relatedInterval.start;
          info.event._originalIntervalEnd = relatedInterval.end;
          info.event._relatedInterval = relatedInterval;
          
          // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚’åŠé€æ˜ã«ã—ã¦è¿½å¾“æº–å‚™
          relatedInterval.setProp('classNames', [...(relatedInterval.classNames || []), 'dragging-interval']);
        }
      }
    };
    
    config.eventDragStop = function(info) {
      console.log('ğŸ¯ Drag stopped:', info.event.id);
      const eventType = info.event.extendedProps.type;
      
      if (eventType !== 'interval' && info.event._relatedInterval) {
        // ãƒ‰ãƒ©ãƒƒã‚°å®Œäº†å¾Œã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
        const relatedInterval = info.event._relatedInterval;
        const currentClasses = relatedInterval.classNames || [];
        const newClasses = currentClasses.filter(cls => cls !== 'dragging-interval');
        relatedInterval.setProp('classNames', newClasses);
      }
    };
    
    config.eventDidMount = function(info) {
      const eventType = info.event.extendedProps.type;
      
      console.log(`ğŸ¨ Mounting event: ${info.event.title} (type: ${eventType})`);
      
      if (eventType === 'reservation' || !eventType) {
        info.el.classList.add('reservation-event');
        
        const status = info.event.extendedProps.status;
        if (status === 'tentative') {
          info.el.classList.add('tentative');
        }
        
        const intervalMinutes = info.event.extendedProps.effective_interval_minutes;
        const hasInterval = intervalMinutes && intervalMinutes > 0;
        
        if (hasInterval) {
          enhanceReservationWithInterval(info.el, info.event, intervalMinutes);
        }
        
      } else if (eventType === 'interval') {
        info.el.classList.add('interval-event');
        
        const isIndividual = info.event.extendedProps.individual_interval_minutes;
        if (isIndividual) {
          info.el.classList.add('individual-interval');
        }
        
        const relatedReservation = pageCalendar.getEvents().find(event => 
          event.id == info.event.extendedProps.reservation_id && 
          event.extendedProps.effective_interval_minutes > 0
        );
        
        if (relatedReservation) {
          info.el.style.display = 'none';
        }
      }
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚¤ãƒ™ãƒ³ãƒˆã®å®Ÿéš›ã®ä½ç½®ã‚’å‡ºåŠ›
      const startTime = info.event.start;
      const endTime = info.event.end;
      const duration = Math.round((endTime - startTime) / (1000 * 60));
      console.log(`ğŸ“ Event positioned: ${info.event.title}`, {
        start: startTime,
        end: endTime,
        duration: duration,
        startLocal: startTime?.toLocaleString('ja-JP'),
        endLocal: endTime?.toLocaleString('ja-JP')
      });
    };
    
    // ğŸ”§ ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚¢ãƒ³ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹æ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
    config.eventDidUnmount = function(info) {
      console.log(`ğŸ—‘ï¸ Unmounting event: ${info.event.title} (type: ${info.event.extendedProps.type})`);
    };
    
    try {
      pageCalendar = new FullCalendar.Calendar(calendarEl, config);
      pageCalendar.render();
      
      console.log('âœ… Complete fixed Rails calendar initialized successfully');
      console.log('ğŸ”§ Timezone setting:', pageCalendar.getOption('timeZone'));
      showMessage('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰', 'success');
      
      setTimeout(() => {
        const events = pageCalendar.getEvents();
        console.log(`ğŸ“Š Calendar rendered with ${events.length} events`);
        
        events.forEach(event => {
          const startTime = event.start;
          const endTime = event.end;
          const duration = Math.round((endTime - startTime) / (1000 * 60));
          console.log(`ğŸ“… Event: ${event.title} (${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} - ${endTime.getHours().toString().padStart(2, '0')}:${endTime.getMinutes().toString().padStart(2, '0')}, ${duration}åˆ†)`);
          
          // ğŸ”§ é‡è¦: åˆæœŸåŒ–æ™‚ã«ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†å¯èƒ½çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«è¨­å®š
          event.setProp('editable', true);
          event.setProp('startEditable', true);
          event.setProp('durationEditable', true);
          
          // ğŸ”§ è¿½åŠ : ã‚¤ãƒ™ãƒ³ãƒˆã®è‰²ã‚‚ç¢ºå®Ÿã«è¨­å®š
          if (event.extendedProps.type === 'interval') {
            event.setProp('backgroundColor', '#e9ecef');
            event.setProp('borderColor', '#6c757d');
          } else {
            event.setProp('backgroundColor', '#28a745');
            event.setProp('borderColor', '#28a745');
          }
        });
        
        console.log('âœ… All events initialized with proper settings');
      }, 1000);
      
    } catch (error) {
      console.error('âŒ Calendar initialization failed:', error);
      showMessage('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'danger');
    }
  }

  // ========================================
  // æ™‚é–“æ­£è¦åŒ–é–¢æ•°ï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ï¼‰
  // ========================================
  function normalizeTimeToSlot(dateTime, slotIntervalMinutes) {
    const date = new Date(dateTime);
    const minutes = date.getMinutes();
    const normalizedMinutes = Math.round(minutes / slotIntervalMinutes) * slotIntervalMinutes;
    date.setMinutes(normalizedMinutes, 0, 0);
    return date;
  }

  // äºˆç´„æ™‚é–“æ›´æ–°é–¢æ•°ï¼ˆãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ç”¨ï¼‰
  function updateReservationTime(event, revertFunc) {
    console.log('ğŸ”¥ updateReservationTime CALLED!');
    console.log('ğŸ’¾ Updating reservation time:', {
      id: event.id,
      title: event.title,
      start: event.start,
      end: event.end
    });
    
    // çµ¶å¯¾URLã‚’ä½¿ç”¨ï¼ˆæœ€åˆã«å®šç¾©ï¼‰
    const updateUrl = `${window.location.protocol}//${window.location.host}/admin/reservations/${event.id}`;
    console.log('ğŸ“¡ Absolute URL:', updateUrl);
    
    // æ™‚é–“ã‚’æ­£è¦åŒ–
    const systemSettings = getSystemSettings();
    const normalizedStart = normalizeTimeToSlot(event.start, systemSettings.slotIntervalMinutes);
    const normalizedEnd = normalizeTimeToSlot(event.end, systemSettings.slotIntervalMinutes);
    
    // æ­£è¦åŒ–ã•ã‚ŒãŸæ™‚é–“ã‚’ã‚¤ãƒ™ãƒ³ãƒˆã«è¨­å®š
    event.setStart(normalizedStart);
    event.setEnd(normalizedEnd);
    
    // APIãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    const updateData = {
      reservation: {
        start_time: normalizedStart.toISOString(),
        end_time: normalizedEnd.toISOString()
      }
    };
    
    console.log('ğŸ“¡ Sending normalized update data:', updateData);
    console.log('ğŸ“¡ Update URL:', updateUrl);
    console.log('ğŸ“¡ Request method:', 'PATCH');
    
    showMessage('äºˆç´„æ™‚é–“ã‚’æ›´æ–°ä¸­...', 'info');
    
    // ğŸ”§ é‡è¦: æ›´æ–°ä¸­ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    event.setProp('backgroundColor', '#f8f9fa');
    event.setProp('borderColor', '#6c757d');
    
    fetch(updateUrl, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify(updateData),
      credentials: 'same-origin'
    })
    .then(response => {
      console.log('ğŸ“¡ Response received:', response);
      console.log('ğŸ“¡ Response status:', response.status);
      console.log('ğŸ“¡ Response headers:', response.headers);
      
      if (!response.ok) {
        // ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è©³ç´°ã‚’å–å¾—
        return response.text().then(errorText => {
          console.error('âŒ Error response body:', errorText);
          throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorText}`);
        });
      }
      
      return response.json();
    })
    .then(data => {
      console.log('ğŸ’¾ Update response data:', data);
      
      if (data.success) {
        console.log('âœ… Server confirmed update success');
        showMessage('äºˆç´„æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        
        // ğŸ”§ æˆåŠŸæ™‚ã¯ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«ã¨ç·¨é›†å¯èƒ½çŠ¶æ…‹ã‚’å¾©å…ƒ
        event.setProp('backgroundColor', '#28a745');
        event.setProp('borderColor', '#28a745');
        event.setProp('editable', true);
        event.setProp('startEditable', true);
        event.setProp('durationEditable', true);
        
        // ğŸ”§ é‡è¦: ã‚ˆã‚Šå®‰å…¨ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°
        setTimeout(() => {
          console.log('ğŸ”„ Safely refreshing calendar...');
          try {
            // ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’è¨˜éŒ²
            const currentEvents = pageCalendar.getEvents();
            console.log(`ğŸ“Š Current events before refresh: ${currentEvents.length}`);
            
            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†å–å¾—
            pageCalendar.refetchEvents();
            
            // æ›´æ–°å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’ç¢ºèª
            setTimeout(() => {
              const newEvents = pageCalendar.getEvents();
              console.log(`ğŸ“Š Events after refresh: ${newEvents.length}`);
              
              if (newEvents.length === 0) {
                console.warn('âš ï¸ No events after refresh, reinitializing...');
                initializeFixedCalendar();
              } else {
                console.log('âœ… Calendar refresh successful');
              }
            }, 300);
          } catch (refreshError) {
            console.error('âŒ Calendar refresh error:', refreshError);
            initializeFixedCalendar();
          }
        }, 300); // å°‘ã—é•·ã‚ã®å¾…æ©Ÿæ™‚é–“
        
      } else {
        console.error('âŒ Server reported failure:', data.error);
        showMessage(data.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
        // ğŸ”§ ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†å¯èƒ½çŠ¶æ…‹ã‚’å¾©å…ƒ
        event.setProp('editable', true);
        event.setProp('startEditable', true);
        event.setProp('durationEditable', true);
        revertFunc();
      }
    })
    .catch(error => {
      console.error('âŒ Update request failed:', error);
      showMessage(`æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'danger');
      // ğŸ”§ ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†å¯èƒ½çŠ¶æ…‹ã‚’å¾©å…ƒ
      event.setProp('editable', true);
      event.setProp('startEditable', true);
      event.setProp('durationEditable', true);
      revertFunc();
    });
  }

  // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“æ›´æ–°é–¢æ•°
  function updateIntervalTime(event, revertFunc) {
    console.log('ğŸ”¥ updateIntervalTime CALLED!');
    console.log('ğŸ’¾ Updating interval time:', {
      id: event.id,
      title: event.title,
      start: event.start,
      end: event.end,
      reservationId: event.extendedProps.reservation_id,
      intervalType: event.extendedProps.interval_type
    });
    
    // æ™‚é–“ã‚’æ­£è¦åŒ–
    const systemSettings = getSystemSettings();
    const normalizedStart = normalizeTimeToSlot(event.start, systemSettings.slotIntervalMinutes);
    const normalizedEnd = normalizeTimeToSlot(event.end, systemSettings.slotIntervalMinutes);
    
    // æ­£è¦åŒ–ã•ã‚ŒãŸæ™‚é–“ã‚’ã‚¤ãƒ™ãƒ³ãƒˆã«è¨­å®š
    event.setStart(normalizedStart);
    event.setEnd(normalizedEnd);
    
    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’è¨ˆç®—ï¼ˆåˆ†å˜ä½ï¼‰
    const intervalMinutes = Math.round((normalizedEnd - normalizedStart) / (1000 * 60));
    console.log('ğŸ“ New interval duration:', intervalMinutes, 'minutes');
    
    // æœ€å°ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ãƒã‚§ãƒƒã‚¯ï¼ˆ5åˆ†ï¼‰
    if (intervalMinutes < 5) {
      console.warn('âš ï¸ Interval too short');
      showMessage('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã¯æœ€ä½5åˆ†å¿…è¦ã§ã™', 'warning');
      revertFunc();
      return;
    }
    
    // æœ€å¤§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ãƒã‚§ãƒƒã‚¯ï¼ˆ60åˆ†ï¼‰
    if (intervalMinutes > 60) {
      console.warn('âš ï¸ Interval too long');
      showMessage('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã¯æœ€å¤§60åˆ†ã¾ã§ã§ã™', 'warning');
      revertFunc();
      return;
    }
    
    const reservationId = event.extendedProps.reservation_id;
    if (!reservationId) {
      console.error('âŒ No reservation ID found for interval');
      showMessage('é–¢é€£ã™ã‚‹äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'danger');
      revertFunc();
      return;
    }
    
    console.log('ğŸ“¡ Updating interval for reservation:', reservationId);
    
    showMessage('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’æ›´æ–°ä¸­...', 'info');
    
    // ğŸ”§ é‡è¦: æ›´æ–°ä¸­ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
    event.setProp('backgroundColor', '#f8f9fa');
    event.setProp('borderColor', '#6c757d');
    
    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ›´æ–°APIã‚’å‘¼ã³å‡ºã—
    const updateUrl = `${window.location.protocol}//${window.location.host}/admin/reservations/${reservationId}/update_individual_interval`;
    console.log('ğŸ“¡ Interval update URL:', updateUrl);
    
    fetch(updateUrl, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({
        individual_interval_minutes: intervalMinutes,
        interval_description: `ãƒ‰ãƒ©ãƒƒã‚°èª¿æ•´: ${intervalMinutes}åˆ†`
      }),
      credentials: 'same-origin'
    })
    .then(response => {
      console.log('ğŸ“¡ Interval response received:', response);
      console.log('ğŸ“¡ Response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      return response.json();
    })
    .then(data => {
      console.log('ğŸ’¾ Interval update response:', data);
      
      if (data.success) {
        console.log('âœ… Interval update confirmed');
        showMessage(`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’${intervalMinutes}åˆ†ã«æ›´æ–°ã—ã¾ã—ãŸ`, 'success');
        
        // ğŸ”§ æˆåŠŸæ™‚ã¯ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«ã¨ç·¨é›†å¯èƒ½çŠ¶æ…‹ã‚’å¾©å…ƒ
        event.setProp('backgroundColor', '#e9ecef');
        event.setProp('borderColor', '#6c757d');
        event.setProp('editable', true);
        event.setProp('startEditable', true);
        event.setProp('durationEditable', true);
        
        // ğŸ”§ é‡è¦: ã‚ˆã‚Šå®‰å…¨ãªã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°
        setTimeout(() => {
          console.log('ğŸ”„ Safely refreshing calendar after interval update...');
          try {
            // ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’è¨˜éŒ²
            const currentEvents = pageCalendar.getEvents();
            console.log(`ğŸ“Š Current events before refresh: ${currentEvents.length}`);
            
            // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†å–å¾—
            pageCalendar.refetchEvents();
            
            // æ›´æ–°å¾Œã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’ç¢ºèª
            setTimeout(() => {
              const newEvents = pageCalendar.getEvents();
              console.log(`ğŸ“Š Events after refresh: ${newEvents.length}`);
              
              if (newEvents.length === 0) {
                console.warn('âš ï¸ No events after refresh, reinitializing...');
                initializeFixedCalendar();
              } else {
                console.log('âœ… Calendar refresh successful');
              }
            }, 300);
          } catch (refreshError) {
            console.error('âŒ Calendar refresh error:', refreshError);
            initializeFixedCalendar();
          }
        }, 300); // å°‘ã—é•·ã‚ã®å¾…æ©Ÿæ™‚é–“
        
      } else {
        console.error('âŒ Interval update failed:', data.error);
        showMessage(data.error || 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
        // ğŸ”§ ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†å¯èƒ½çŠ¶æ…‹ã‚’å¾©å…ƒ
        event.setProp('editable', true);
        event.setProp('startEditable', true);
        event.setProp('durationEditable', true);
        revertFunc();
      }
    })
    .catch(error => {
      console.error('âŒ Interval update request failed:', error);
      showMessage(`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'danger');
      // ğŸ”§ ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†å¯èƒ½çŠ¶æ…‹ã‚’å¾©å…ƒ
      event.setProp('editable', true);
      event.setProp('startEditable', true);
      event.setProp('durationEditable', true);
      revertFunc();
    });
  }

  // ========================================
  // ãã®ä»–ã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
  // ========================================
  function refreshFixedCalendar() {
    if (pageCalendar) {
      console.log('ğŸ”„ Refreshing complete fixed Rails calendar...');
      
      // ç¾åœ¨ã®ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’è¨˜éŒ²
      const currentEvents = pageCalendar.getEvents();
      console.log(`ğŸ“Š Current events before refresh: ${currentEvents.length}`);
      
      // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†å–å¾—
      pageCalendar.refetchEvents();
      
      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆæ•°ã‚’ç¢ºèª
      setTimeout(() => {
        const newEvents = pageCalendar.getEvents();
        console.log(`ğŸ“Š Events after refresh: ${newEvents.length}`);
        
        if (newEvents.length === 0) {
          console.warn('âš ï¸ No events after refresh, reinitializing...');
          initializeFixedCalendar();
        } else {
          showMessage('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        }
      }, 500);
      
    } else {
      console.log('ğŸ”„ Reinitializing calendar...');
      initializeFixedCalendar();
    }
  }

  function testPositionAlignment() {
    console.log('ğŸ§ª Testing position alignment...');
    
    if (!pageCalendar) {
      showMessage('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
      return;
    }
    
    const events = pageCalendar.getEvents();
    const systemSettings = getSystemSettings();
    let misalignedCount = 0;
    
    events.forEach(event => {
      const startTime = event.start;
      const minutes = startTime.getMinutes();
      const expectedMinutes = Math.round(minutes / systemSettings.slotIntervalMinutes) * systemSettings.slotIntervalMinutes;
      const offsetMinutes = minutes - expectedMinutes;
      
      if (Math.abs(offsetMinutes) > 0) {
        misalignedCount++;
        console.warn(`âš ï¸ Misaligned: ${event.title} (${offsetMinutes}min offset)`);
      }
    });
    
    if (misalignedCount === 0) {
      showMessage(`âœ… å…¨${events.length}å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒæ­£ã—ãé…ç½®ã•ã‚Œã¦ã„ã¾ã™`, 'success');
    } else {
      showMessage(`âš ï¸ ${misalignedCount}å€‹ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒä½ç½®ãšã‚Œã—ã¦ã„ã¾ã™`, 'warning');
    }
    
    console.log('ğŸŒ Timezone info:', {
      calendarTimezone: pageCalendar.getOption('timeZone'),
      browserTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
      currentTime: new Date().toLocaleString('ja-JP')
    });
  }

  function generateTimeOptions() {
    const timeSelect = document.getElementById('reservationTime');
    if (!timeSelect) return;
    
    const systemSettings = getSystemSettings();
    timeSelect.innerHTML = '';
    
    for (let hour = systemSettings.businessHoursStart; hour < systemSettings.businessHoursEnd; hour++) {
      for (let minute = 0; minute < 60; minute += systemSettings.slotIntervalMinutes) {
        const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        const option = document.createElement('option');
        option.value = timeStr;
        option.textContent = timeStr;
        timeSelect.appendChild(option);
      }
    }
    
    console.log('âœ… Time options generated based on Rails settings');
  }

  function loadUsers() {
    fetch('/admin/users.json')
      .then(response => response.json())
      .then(users => {
        currentUsers = users;
        const userSelect = document.getElementById('reservationUserId');
        if (!userSelect) return;
        
        userSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        
        users.forEach(user => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = `${user.name} (${user.phone_number || 'Telæœªç™»éŒ²'})`;
          userSelect.appendChild(option);
        });
        
        console.log('âœ… Users loaded:', users.length);
      })
      .catch(error => {
        console.error('âŒ Failed to load users:', error);
      });
  }

  // äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  function openReservationModal(reservationId = null, dateStr = null) {
    console.log('ğŸ“ Opening reservation modal:', { reservationId, dateStr });
    
    const modal = document.getElementById('reservationModal');
    if (!modal) {
      console.error('âŒ Reservation modal not found');
      return;
    }
    
    currentReservationId = reservationId;
    
    const modalTitle = document.getElementById('modalTitle');
    const deleteBtn = document.getElementById('deleteReservationBtn');
    
    if (reservationId) {
      modalTitle.textContent = 'äºˆç´„ç·¨é›†';
      deleteBtn.classList.remove('d-none');
    } else {
      modalTitle.textContent = 'æ–°è¦äºˆç´„';
      deleteBtn.classList.add('d-none');
    }
    
    resetForm();
    
    if (dateStr) {
      const date = dateStr.split('T')[0];
      const time = dateStr.split('T')[1]?.substring(0, 5) || '10:00';
      
      document.getElementById('reservationDate').value = date;
      document.getElementById('reservationTime').value = time;
      updateEndTime();
    }
    
    if (reservationId) {
      loadReservationData(reservationId);
    }
    
    const bootstrapModal = new bootstrap.Modal(modal);
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ã‚‰ã‚ŒãŸæ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å‡¦ç†ã‚’è¿½åŠ 
    modal.addEventListener('hidden.bs.modal', function() {
      console.log('ğŸ”’ Modal hidden, cleaning up...');
      cleanupModal();
    });
    
    bootstrapModal.show();
  }

  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  function cleanupModal() {
    console.log('ğŸ§¹ Cleaning up modal...');
    
    // backdropã‚’æ‰‹å‹•ã§å‰Šé™¤
    const backdrops = document.querySelectorAll('.modal-backdrop');
    backdrops.forEach(backdrop => {
      backdrop.remove();
    });
    
    // bodyã®modal-openã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.paddingRight = '';
    
    console.log('âœ… Modal cleanup completed');
  }

  function loadReservationData(reservationId) {
    console.log('ğŸ“– Loading reservation data:', reservationId);
    
    const loadingIndicator = document.getElementById('loadingIndicator');
    const form = document.getElementById('reservationForm');
    
    loadingIndicator.style.display = 'block';
    form.style.display = 'none';
    
    fetch(`/admin/reservations/${reservationId}.json`)
      .then(response => response.json())
      .then(data => {
        console.log('ğŸ“– Reservation data loaded:', data);
        
        if (data.success || data.id) {
          let extractedDate = '';
          let extractedTime = '';
          
          if (data.start_time) {
            console.log('ğŸ• start_time:', data.start_time);
            const startDateTime = new Date(data.start_time);
            
            console.log('ğŸ• Parsed DateTime object:', startDateTime);
            console.log('ğŸ• DateTime methods:', {
              getFullYear: startDateTime.getFullYear(),
              getMonth: startDateTime.getMonth(),
              getDate: startDateTime.getDate(),
              getHours: startDateTime.getHours(),
              getMinutes: startDateTime.getMinutes(),
              toString: startDateTime.toString(),
              toISOString: startDateTime.toISOString()
            });
            
            // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’è€ƒæ…®ã—ã¦æ—¥ä»˜ã¨æ™‚é–“ã‚’æŠ½å‡º
            const year = startDateTime.getFullYear();
            const month = String(startDateTime.getMonth() + 1).padStart(2, '0');
            const day = String(startDateTime.getDate()).padStart(2, '0');
            const hours = String(startDateTime.getHours()).padStart(2, '0');
            const minutes = String(startDateTime.getMinutes()).padStart(2, '0');
            
            extractedDate = `${year}-${month}-${day}`;
            extractedTime = `${hours}:${minutes}`;
            
            console.log('ğŸ“… Extracted date:', extractedDate);
            console.log('ğŸ• Extracted time:', extractedTime);
          } else {
            console.warn('âš ï¸ No start_time in data:', data);
          }
          
          console.log('ğŸ“ Setting form values:', {
            id: data.id || '',
            userId: data.user_id || '',
            course: data.course || '60åˆ†',
            date: extractedDate,
            time: extractedTime,
            status: data.status || 'confirmed',
            note: data.note || ''
          });
          
          document.getElementById('reservationId').value = data.id || '';
          document.getElementById('reservationUserId').value = data.user_id || '';
          document.getElementById('reservationCourse').value = data.course || '60åˆ†';
          document.getElementById('reservationDate').value = extractedDate;
          document.getElementById('reservationTime').value = extractedTime;
          document.getElementById('reservationStatus').value = data.status || 'confirmed';
          document.getElementById('reservationNote').value = data.note || '';
          
          // ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ãŒç¢ºå®Ÿã«è¨­å®šã•ã‚ŒãŸå¾Œã«updateEndTimeã‚’å‘¼ã³å‡ºã—
          setTimeout(() => {
            // ãƒ•ã‚©ãƒ¼ãƒ ã®å€¤ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹å†ç¢ºèª
            const timeValue = document.getElementById('reservationTime').value;
            console.log('ğŸ”„ Checking time value after delay:', timeValue);
            
            if (timeValue) {
              updateEndTime();
            } else {
              console.warn('âš ï¸ Time value still empty after delay, retrying...');
              // ã‚‚ã†ä¸€åº¦é…å»¶ã•ã›ã¦å†è©¦è¡Œ
              setTimeout(() => {
                const retryTimeValue = document.getElementById('reservationTime').value;
                console.log('ğŸ”„ Retry time value:', retryTimeValue);
                if (retryTimeValue) {
                  updateEndTime();
                } else {
                  console.error('âŒ Time value still empty after retry');
                }
              }, 200);
            }
          }, 200);
          
                  console.log('âœ… Form populated with reservation data');
        console.log('ğŸ“ Form values after population:', {
          id: document.getElementById('reservationId').value,
          userId: document.getElementById('reservationUserId').value,
          course: document.getElementById('reservationCourse').value,
          date: document.getElementById('reservationDate').value,
          time: document.getElementById('reservationTime').value,
          status: document.getElementById('reservationStatus').value,
          note: document.getElementById('reservationNote').value
        });
      } else {
        console.error('âŒ Failed to load reservation data:', data.error);
        showMessage('äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      }
      })
      .catch(error => {
        console.error('âŒ Error loading reservation data:', error);
        showMessage('äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
      })
      .finally(() => {
        loadingIndicator.style.display = 'none';
        form.style.display = 'block';
      });
  }

  function resetForm() {
    const form = document.getElementById('reservationForm');
    if (form) {
      form.reset();
    }
    
    document.getElementById('reservationId').value = '';
    document.getElementById('reservationStatus').value = 'confirmed';
    document.getElementById('endTimeDisplay').value = '';
  }

  function updateEndTime() {
    const time = document.getElementById('reservationTime').value;
    const course = document.getElementById('reservationCourse').value;
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    
    console.log('ğŸ• updateEndTime called with:', { time, course });
    
    // æ™‚é–“ãŒç©ºã®å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
    if (!time) {
      console.warn('âš ï¸ updateEndTime: Time is empty, skipping calculation');
      return;
    }
    
    if (time && course) {
      const [hours, minutes] = time.split(':').map(Number);
      const courseDuration = parseInt(course.replace('åˆ†', ''));
      
      const startDate = new Date();
      startDate.setHours(hours, minutes, 0, 0);
      
      const endDate = new Date(startDate.getTime() + courseDuration * 60000);
      const endTimeStr = `${endDate.getHours().toString().padStart(2, '0')}:${endDate.getMinutes().toString().padStart(2, '0')}`;
      
      endTimeDisplay.value = endTimeStr;
      console.log('âœ… End time calculated:', endTimeStr);
    } else {
      console.warn('âš ï¸ updateEndTime: Missing time or course:', { time, course });
    }
  }

  function saveReservation() {
    const formData = {
      user_id: document.getElementById('reservationUserId').value,
      course: document.getElementById('reservationCourse').value,
      date: document.getElementById('reservationDate').value,
      time: document.getElementById('reservationTime').value,
      status: document.getElementById('reservationStatus').value,
      note: document.getElementById('reservationNote').value
    };
    
    console.log('ğŸ’¾ Saving reservation:', formData);
    
    if (!formData.user_id || !formData.date || !formData.time) {
      showMessage('å¿…é ˆé …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    
    const startDateTime = new Date(`${formData.date}T${formData.time}:00`);
    const courseDuration = parseInt(formData.course.replace('åˆ†', ''));
    const endDateTime = new Date(startDateTime.getTime() + courseDuration * 60000);
    
    const apiData = {
      user_id: parseInt(formData.user_id),
      course: formData.course,
      start_time: startDateTime.toISOString(),
      end_time: endDateTime.toISOString(),
      status: formData.status,
      note: formData.note
    };
    
    console.log('ğŸ’¾ API data:', apiData);
    
    const saveBtn = document.querySelector('#reservationModal .btn-primary');
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';
    
    const isEdit = currentReservationId !== null;
    const url = isEdit 
      ? `${window.location.protocol}//${window.location.host}/admin/reservations/${currentReservationId}`
      : `${window.location.protocol}//${window.location.host}/admin/reservations`;
    const method = isEdit ? 'PATCH' : 'POST';
    
    console.log(`ğŸ“¡ ${method} request to:`, url);
    
    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: JSON.stringify({ reservation: apiData }),
      credentials: 'same-origin'
    })
    .then(response => {
      console.log('ğŸ“¡ Response status:', response.status);
      return response.json();
    })
    .then(data => {
      console.log('ğŸ’¾ Save response:', data);
      
      if (data.success) {
        const message = isEdit ? 'äºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'äºˆç´„ã‚’ä½œæˆã—ã¾ã—ãŸ';
        showMessage(message, 'success');
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ­£ã—ãé–‰ã˜ã‚‹
        const modal = bootstrap.Modal.getInstance(document.getElementById('reservationModal'));
        if (modal) {
          modal.hide();
        }
        
        refreshFixedCalendar();
        
      } else {
        console.error('âŒ Save failed:', data.error || data.errors);
        const errorMsg = data.error || (data.errors ? data.errors.join(', ') : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        showMessage(errorMsg, 'danger');
      }
    })
    .catch(error => {
      console.error('âŒ Save request failed:', error);
      showMessage('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
    })
    .finally(() => {
      saveBtn.disabled = false;
      saveBtn.innerHTML = originalText;
    });
  }

  function deleteReservation() {
    if (!currentReservationId) {
      console.warn('âš ï¸ No reservation ID for deletion');
      showMessage('å‰Šé™¤ã™ã‚‹äºˆç´„ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
      return;
    }
    
    console.log('ğŸ” Current reservation ID:', currentReservationId);
    
    const confirmMessage = 'æœ¬å½“ã«ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå‰Šé™¤ã—ãŸäºˆç´„ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚';
    if (!confirm(confirmMessage)) {
      console.log('ğŸš« Deletion cancelled by user');
      return;
    }
    
    console.log('ğŸ—‘ï¸ Deleting reservation:', currentReservationId);
    
    const deleteBtn = document.getElementById('deleteReservationBtn');
    const originalText = deleteBtn.innerHTML;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>å‰Šé™¤ä¸­...';
    
    const saveBtn = document.querySelector('#reservationModal .btn-primary');
    saveBtn.disabled = true;
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/admin/reservations/${currentReservationId}`;
    form.style.display = 'none';
    
    const methodInput = document.createElement('input');
    methodInput.type = 'hidden';
    methodInput.name = '_method';
    methodInput.value = 'DELETE';
    form.appendChild(methodInput);
    
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'authenticity_token';
    csrfInput.value = document.querySelector('[name="csrf-token"]').content;
    form.appendChild(csrfInput);
    
    const formatInput = document.createElement('input');
    formatInput.type = 'hidden';
    formatInput.name = 'format';
    formatInput.value = 'json';
    form.appendChild(formatInput);
    
    console.log('ğŸŒ Form action:', form.action);
    console.log('ğŸŒ Form method:', form.method);
    
    document.body.appendChild(form);
    
    const iframe = document.createElement('iframe');
    iframe.name = 'deleteFrame';
    iframe.style.display = 'none';
    document.body.appendChild(iframe);
    
    form.target = 'deleteFrame';
    
    iframe.onload = function() {
      try {
        console.log('ğŸ“¡ Delete response received');
        
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const responseText = iframeDoc.body.textContent || iframeDoc.body.innerText;
        
        console.log('ğŸ“¡ Delete response text:', responseText);
        
        if (responseText) {
          const data = JSON.parse(responseText);
          console.log('ğŸ—‘ï¸ Delete response:', data);
          
          if (data.success) {
            showMessage('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
            
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ­£ã—ãé–‰ã˜ã‚‹
            const modal = bootstrap.Modal.getInstance(document.getElementById('reservationModal'));
            if (modal) {
              modal.hide();
            }
            
            refreshFixedCalendar();
            
            currentReservationId = null;
          } else {
            console.error('âŒ Delete failed:', data.error);
            showMessage(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
          }
        } else {
          console.log('âš ï¸ Cannot read response, assuming success');
          showMessage('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ­£ã—ãé–‰ã˜ã‚‹
          const modal = bootstrap.Modal.getInstance(document.getElementById('reservationModal'));
          if (modal) {
            modal.hide();
          }
          
          refreshFixedCalendar();
          
          currentReservationId = null;
        }
        
      } catch (error) {
        console.error('âŒ Response processing error:', error);
        showMessage('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’æ­£ã—ãé–‰ã˜ã‚‹
        const modal = bootstrap.Modal.getInstance(document.getElementById('reservationModal'));
        if (modal) {
          modal.hide();
        }
        refreshFixedCalendar();
        currentReservationId = null;
      }
      
      setTimeout(() => {
        try {
          if (form.parentNode) document.body.removeChild(form);
          if (iframe.parentNode) document.body.removeChild(iframe);
        } catch (cleanupError) {
          console.warn('âš ï¸ Cleanup error:', cleanupError);
        }
      }, 1000);
      
      deleteBtn.disabled = false;
      deleteBtn.innerHTML = originalText;
      saveBtn.disabled = false;
    };
    
    iframe.onerror = function() {
      console.error('âŒ Delete iframe error');
      showMessage('å‰Šé™¤å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
      
      try {
        if (form.parentNode) document.body.removeChild(form);
        if (iframe.parentNode) document.body.removeChild(iframe);
      } catch (cleanupError) {
        console.warn('âš ï¸ Cleanup error:', cleanupError);
      }
      
      deleteBtn.disabled = false;
      deleteBtn.innerHTML = originalText;
      saveBtn.disabled = false;
    };
    
    form.submit();
  }

  // ========================================
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  // ========================================
  function setupEventListeners() {
    const timeSelect = document.getElementById('reservationTime');
    const courseSelect = document.getElementById('reservationCourse');
    
    timeSelect?.addEventListener('change', updateEndTime);
    courseSelect?.addEventListener('change', updateEndTime);
    
    const deleteBtn = document.getElementById('deleteReservationBtn');
    deleteBtn?.addEventListener('click', deleteReservation);
    
    console.log('âœ… Event listeners setup');
  }

  // ========================================
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
  // ========================================
  window.initializeFixedCalendar = initializeFixedCalendar;
  window.refreshFixedCalendar = refreshFixedCalendar;
  window.openReservationModal = openReservationModal;
  window.saveReservation = saveReservation;
  window.testPositionAlignment = testPositionAlignment;
  window.cleanupModal = cleanupModal;

  // æ—¢å­˜ã®é–¢æ•°åã‚‚ç¶­æŒï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
  window.refreshCalendar = refreshFixedCalendar;

  // ========================================
  // åˆæœŸåŒ–
  // ========================================
  function initialize() {
    console.log('ğŸš€ Initializing complete fixed Rails calendar system...');
    generateTimeOptions();
    loadUsers();
    setupEventListeners();
    initializeFixedCalendar();
  }

  // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã®å‡¦ç†
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }

  // Turboå¯¾å¿œ
  document.addEventListener('turbo:load', initialize);

  console.log('âœ… Complete Fixed Rails Calendar script loaded');

})();
</script>

<!-- ã‚¹ã‚¿ã‚¤ãƒ« -->
<style>
/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¨ä½“ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
.fc-event {
  cursor: grab;
  transition: all 0.2s ease;
}

.fc-event:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.fc-event:active {
  cursor: grabbing;
}

.fc-event-dragging {
  opacity: 0.7;
  transform: rotate(2deg);
  box-shadow: 0 6px 12px rgba(0,0,0,0.3);
}

.fc-event-resizing {
  opacity: 0.8;
}

.fc-highlight {
  background: rgba(0, 123, 255, 0.1) !important;
  border: 2px dashed #007bff !important;
}

/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¨ä½“ã®ã‚³ãƒ³ãƒ†ãƒŠèª¿æ•´ */
#calendar {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  overflow: hidden;
}

/* FullCalendarã®åŸºæœ¬èª¿æ•´ */
.fc {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.fc-toolbar-title {
  font-size: 1.5em !important;
  font-weight: 600 !important;
  color: #333 !important;
}

.fc-button {
  border-radius: 6px !important;
  font-weight: 500 !important;
}

.fc-button-primary {
  background-color: #007bff !important;
  border-color: #007bff !important;
}

.fc-button-primary:hover {
  background-color: #0056b3 !important;
  border-color: #0056b3 !important;
}

/* æ™‚é–“è»¸ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
.fc-timegrid-axis-frame {
  background-color: #f8f9fa !important;
}

.fc-scrollgrid-section-header .fc-col-header-cell {
  background-color: #f8f9fa !important;
  border-bottom: 2px solid #dee2e6 !important;
  font-weight: 600 !important;
}

/* ä»Šæ—¥ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ */
.fc-day-today {
  background-color: rgba(0, 123, 255, 0.05) !important;
}

.fc-day-today .fc-col-header-cell-cushion {
  color: #007bff !important;
  font-weight: bold !important;
}

/* é€±æœ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.fc-day-sat, .fc-day-sun {
  background-color: rgba(255, 0, 0, 0.02) !important;
}

/* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œã®è¿½åŠ èª¿æ•´ */
@media (max-width: 576px) {
  .fc-toolbar {
    flex-direction: column !important;
    gap: 10px !important;
  }
  
  .fc-toolbar-chunk {
    display: flex !important;
    justify-content: center !important;
  }
  
  .fc-button-group {
    display: flex !important;
  }
  
  .fc-timegrid-event {
    font-size: 0.7em !important;
  }
}
</style>