<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.10/index.global.min.js"></script>
<!-- app/views/admin/reservations/calendar.html.erb の完全版 -->
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>予約カレンダー</h2>
    <div class="btn-group">
      <!-- 新規追加: 一括作成ボタン -->
      <%= link_to "/admin/reservations/bulk_new", class: "btn btn-success" do %>
        <i class="fas fa-calendar-plus me-2"></i>定期予約 一括作成
      <% end %>

      <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
        表示オプション
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#" id="showAllReservations">全ての予約</a></li>
        <li><a class="dropdown-item" href="#" id="showConfirmedOnly">確定予約のみ</a></li>
        <li><a class="dropdown-item" href="#" id="showTentativeOnly">仮予約のみ</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="#" id="showRecurringOnly">繰り返し予約のみ</a></li>
      </ul>
    </div>
  </div>

  <!-- インターバル情報パネル（予約後のみ版） -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card border-info">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-clock me-2"></i>インターバル設定情報
          </h6>
          <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#intervalInfoCollapse">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div class="collapse show" id="intervalInfoCollapse">
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="text-center">
                  <h5 class="text-info mb-1"><%= ApplicationSetting.current.reservation_interval_minutes %>分</h5>
                  <small class="text-muted">整理時間（予約後）</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <h5 class="text-success mb-1"><%= ApplicationSetting.current.slot_interval_minutes %>分</h5>
                  <small class="text-muted">予約枠間隔</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <h5 class="text-primary mb-1"><%= ApplicationSetting.current.business_hours_range %></h5>
                  <small class="text-muted">営業時間</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <%= link_to admin_settings_path, class: "btn btn-sm btn-outline-secondary" do %>
                    <i class="fas fa-cog me-1"></i>設定変更
                  <% end %>
                </div>
              </div>
            </div>
            
            <hr class="my-3">
            
            <div class="row">
              <div class="col-12">
                <h6 class="text-dark mb-2">表示説明</h6>
                <div class="d-flex flex-wrap gap-3">
                  <div class="d-flex align-items-center">
                    <div class="me-2" style="width: 20px; height: 15px; background-color: #28a745; border: 2px solid #28a745; border-radius: 3px;"></div>
                    <small>確定予約</small>
                  </div>
                  <div class="d-flex align-items-center">
                    <div class="me-2" style="width: 20px; height: 15px; background-color: #ffc107; border: 2px solid #ffc107; border-radius: 3px;"></div>
                    <small>仮予約</small>
                  </div>
                  <div class="d-flex align-items-center">
                    <div class="me-2" style="width: 20px; height: 15px; background-color: #e9ecef; border: 1px dashed #ced4da; border-radius: 3px;"></div>
                    <small>整理時間（予約終了後 <%= ApplicationSetting.current.reservation_interval_minutes %>分）</small>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row mt-3">
              <div class="col-12">
                <div class="alert alert-info mb-0" role="alert">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong>インターバル機能：</strong>
                  各予約の<strong>終了後</strong>に<strong><%= ApplicationSetting.current.reservation_interval_minutes %>分</strong>の整理時間が自動で表示されます。
                  この時間帯は新しい予約を入れることができません。
                  整理時間部分をクリックすると、関連する予約の詳細を確認できます。
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header bg-warning text-dark">
      <h6 class="mb-0">
        <i class="fas fa-clock me-2"></i>インターバル設定
        <span id="interval-status-badge" class="badge bg-primary ms-2">システム設定</span>
      </h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <label class="form-label">
            <strong>この予約専用のインターバル時間</strong>
            <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" 
              title="個別に設定しない場合はシステム設定を使用します"></i>
          </label>
          
          <!-- 個別設定スイッチ -->
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="individualIntervalToggle">
            <label class="form-check-label" for="individualIntervalToggle">
              この予約のみ個別に設定する
            </label>
          </div>
          
          <!-- 個別設定エリア -->
          <div id="individualIntervalArea" style="display: none;">
            <!-- スライダー -->
            <div class="mb-3">
              <input type="range" 
                    class="form-range" 
                    id="individual-interval-slider" 
                    min="0" 
                    max="120" 
                    step="5" 
                    value="15">
              <div class="d-flex justify-content-between text-muted small">
                <span>0分</span>
                <span>30分</span>
                <span>60分</span>
                <span>90分</span>
                <span>120分</span>
              </div>
            </div>
            
            <!-- 数値入力 -->
            <div class="input-group mb-3">
              <input type="number" 
                    class="form-control text-center fw-bold" 
                    id="individual-interval-input"
                    min="0" 
                    max="120" 
                    step="5"
                    value="15">
              <span class="input-group-text">分</span>
            </div>
            
            <!-- クイック設定ボタン -->
            <div class="mb-3">
              <label class="form-label small text-muted">クイック設定:</label>
              <div class="d-grid gap-1 d-md-flex">
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="0">
                  0分
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="10">
                  10分
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="15">
                  15分
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="20">
                  20分
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="30">
                  30分
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="45">
                  45分
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="60">
                  60分
                </button>
              </div>
            </div>
          </div>
          
          <!-- システム設定表示エリア -->
          <div id="systemIntervalArea">
            <div class="alert alert-info py-2">
              <small>
                <strong>システム設定を使用:</strong> 
                <span id="system-interval-display"><%= ApplicationSetting.current.reservation_interval_minutes %>分</span>
              </small>
            </div>
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="bg-light p-3 rounded">
            <h6 class="text-dark mb-3">プレビュー</h6>
            <div id="individual-interval-preview">
              <!-- JavaScriptで動的に更新 -->
            </div>
            
            <hr>
            
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-sm btn-outline-danger" id="resetIndividualInterval">
                <i class="fas fa-undo me-1"></i>リセット
              </button>
              <button type="button" class="btn btn-sm btn-success" id="applyIndividualInterval">
                <i class="fas fa-check me-1"></i>適用
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- フラッシュメッセージエリア -->
  <div id="flash"></div>

  <!-- ステータス凡例 -->
  <div class="card mb-3">
    <div class="card-body py-2">
      <div class="row align-items-center">
        <div class="col-auto">
          <strong>ステータス凡例：</strong>
        </div>
        <div class="col">
          <span class="badge bg-success me-2">確定</span>
          <span class="badge bg-warning text-dark me-2">仮予約</span>
          <span class="badge bg-danger me-2">キャンセル</span>
          <span class="badge bg-secondary me-2">完了</span>
          <span class="badge bg-warning me-2">無断キャンセル</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="table-responsive">
    <div id="calendar" style="width: 100%; max-width: 100%; margin: auto;"></div>
  </div>
</div>

<!-- 予約詳細・編集モーダル -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reservationModalLabel">予約管理</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
      </div>
      <div class="modal-body">
        <form id="reservationForm">
          <!-- 隠しフィールド -->
          <input type="hidden" id="reservationId">
          
          <!-- 基本情報セクション -->
          <div class="card mb-3">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">予約者選択</h6>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="newUserToggle">
                  <label class="form-check-label" for="newUserToggle">
                    新規ユーザーを作成
                  </label>
                </div>
              </div>
            </div>
            <div class="card-body">
              <!-- 既存ユーザー選択 -->
              <div id="existingUserSection">
                <label for="reservationUserId" class="form-label">既存ユーザーを選択</label>
                <select class="form-control" id="reservationUserId">
                  <option value="">ユーザーを選択してください</option>
                </select>
              </div>

              <!-- 新規ユーザー作成フォーム -->
              <div id="newUserSection" style="display: none;">
                <div class="row">
                  <div class="col-md-6">
                    <label for="newUserName" class="form-label">氏名 <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="newUserName" placeholder="例: 山田太郎">
                  </div>
                  <div class="col-md-6">
                    <label for="newUserPhone" class="form-label">電話番号</label>
                    <input type="tel" class="form-control" id="newUserPhone" placeholder="例: 090-1234-5678">
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-md-6">
                    <label for="newUserEmail" class="form-label">メールアドレス</label>
                    <input type="email" class="form-control" id="newUserEmail" placeholder="例: example@email.com">
                  </div>
                  <div class="col-md-6">
                    <label for="newUserBirthDate" class="form-label">生年月日</label>
                    <input type="date" class="form-control" id="newUserBirthDate">
                  </div>
                </div>
                <div class="mt-2">
                  <label for="newUserAddress" class="form-label">住所</label>
                  <input type="text" class="form-control" id="newUserAddress" placeholder="例: 東京都渋谷区...">
                </div>
                <div class="mt-2">
                  <label for="newUserMemo" class="form-label">管理者メモ</label>
                  <textarea class="form-control" id="newUserMemo" rows="2" placeholder="初回来店、アレルギー情報など"></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- 予約詳細セクション -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">予約詳細</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <label for="reservationDate" class="form-label">予約日</label>
                  <input type="date" class="form-control" id="reservationDate" required>
                </div>
                <div class="col-md-6">
                  <label for="reservationTime" class="form-label">開始時間</label>
                  <select class="form-control" id="reservationTime" required>
                    <option value="">時間を選択してください</option>
                  </select>
                </div>
              </div>

              <div class="row mt-2">
                <div class="col-md-6">
                  <label for="reservationCourse" class="form-label">コース</label>
                  <select class="form-control" id="reservationCourse">
                    <option value="40分">40分コース</option>
                    <option value="60分" selected>60分コース</option>
                    <option value="80分">80分コース</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">終了予定時間</label>
                  <div id="endTimeDisplay" class="form-control-plaintext text-muted">時間とコースを選択してください</div>
                </div>
              </div>

              <div class="row mt-2">
                <div class="col-md-6">
                  <label for="reservationStatus" class="form-label">ステータス</label>
                  <select class="form-control" id="reservationStatus">
                    <option value="confirmed">確定</option>
                    <option value="tentative">仮予約</option>
                    <option value="cancelled">キャンセル</option>
                    <option value="completed">完了</option>
                    <option value="no_show">無断キャンセル</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <!-- 空きスペース -->
                </div>
              </div>

              <div class="mt-2">
                <label for="reservationNote" class="form-label">備考</label>
                <textarea class="form-control" id="reservationNote" rows="2" placeholder="特別な要望や注意事項など"></textarea>
              </div>

              <!-- キャンセル理由入力エリア -->
              <div id="cancellationReasonArea" style="display: none;" class="mt-3">
                <label for="cancellationReason" class="form-label">キャンセル理由 <span class="text-danger">*</span></label>
                <textarea class="form-control" id="cancellationReason" rows="3" placeholder="キャンセルの理由を入力してください"></textarea>
              </div>
            </div>
          </div>
        </form>

        <!-- アクションボタンエリア -->
        <div class="d-flex justify-content-between mt-4">
          <div>
            <button type="button" id="deleteReservationBtn" class="btn btn-danger d-none">
              <i class="fas fa-trash me-1"></i>削除
            </button>
            <button type="button" id="cancelReservationBtn" class="btn btn-warning d-none">
              <i class="fas fa-times me-1"></i>キャンセル
            </button>
          </div>
          <div>
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">閉じる</button>
            <button type="button" id="saveReservationBtn" class="btn btn-primary">
              <i class="fas fa-save me-1"></i>保存
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<%= javascript_include_tag 'calendar', type: 'module' %>

<style>
.individual-interval .fc-event-title {
  font-weight: bold !important;
  font-style: italic !important;
}

.individual-interval {
  border-style: dashed !important;
  border-width: 2px !important;
  animation: pulse-individual 2s infinite;
}

@keyframes pulse-individual {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 0.6; }
}

.system-interval {
  border-style: dashed !important;
  border-width: 1px !important;
}

#individual-interval-preview .alert {
  font-size: 0.85rem;
}

.individual-preset-btn {
  font-size: 0.8rem;
  padding: 0.25rem 0.5rem;
  min-height: 32px;
}

#interval-status-badge {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  transition: all 0.3s ease;
}

.form-range {
  background: linear-gradient(to right, #28a745 0%, #ffc107 50%, #dc3545 100%);
  height: 8px;
  border-radius: 4px;
}

.form-range::-webkit-slider-thumb {
  height: 20px;
  width: 20px;
  background-color: #fff;
  border: 2px solid #007bff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.form-range::-moz-range-thumb {
  height: 20px;
  width: 20px;
  background-color: #fff;
  border: 2px solid #007bff;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style> 