<% content_for :title, "äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ - Mobilis" %>

<div class="calendar-container">
  <div class="calendar-header">
<div class="container-fluid">
      <div class="calendar-toolbar">
        <div class="calendar-nav">
          <button id="prevBtn" class="btn btn-outline-primary">
            <i class="fas fa-chevron-left"></i> å‰é€±
          </button>
          <button id="todayBtn" class="btn btn-primary">
            <i class="fas fa-calendar-day"></i> ä»Šæ—¥
          </button>
          <button id="nextBtn" class="btn btn-outline-primary">
            æ¬¡é€± <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        
        <div class="calendar-title">
          <i class="fas fa-calendar-alt me-2"></i>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
      </div>
      
        <div class="calendar-actions">
          <div class="d-flex flex-column gap-2">
            <a href="<%= admin_reservations_path %>" class="btn btn-primary btn-lg" style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); border: none; box-shadow: 0 4px 8px rgba(0,0,0,0.15); font-weight: 600;">
              <i class="fas fa-list me-2"></i>ğŸ“‹ ä»Šæ—¥ã®äºˆç´„ä¸€è¦§
            </a>
            <button id="newReservationBtn" class="btn btn-success">
              <i class="fas fa-plus me-1"></i>æ–°è¦äºˆç´„
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="openCancelledHistoryModal()">
              <i class="fas fa-times-circle me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´
            </button>
          </div>
        </div>
    </div>
    </div>
  </div>
  
  <div class="container-fluid">
    <div id="calendar"></div>
  </div>
</div>

<!-- äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reservationModalLabel">
          <i class="fas fa-calendar-plus me-2"></i>äºˆç´„ä½œæˆãƒ»ç·¨é›†
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="reservationForm">
          <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
          <input type="hidden" id="currentReservationId" value="">
          <input type="hidden" id="selectedUserId" value="">
          
          <!-- é¡§å®¢é¸æŠãƒ»æ¤œç´¢ -->
          <div class="row mb-3">
            <div class="col-12">
              <label for="customerSearch" class="form-label">é¡§å®¢æ¤œç´¢ãƒ»é¸æŠ *</label>
              <div class="position-relative">
                                 <input type="text" class="form-control" id="customerSearch" 
                        placeholder="é¡§å®¢åã€ãƒ•ãƒªã‚¬ãƒŠã€é›»è©±ç•ªå·ã§æ¤œç´¢...">
                <div id="customerSearchResults" class="position-absolute w-100 bg-white border rounded shadow-sm" 
                     style="z-index: 1050; max-height: 200px; overflow-y: auto; display: none;">
                  <!-- æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤º -->
            </div>
              </div>
          </div>
        </div>
        
          <!-- é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã®è¡¨ç¤º -->
          <div id="selectedCustomerInfo" class="row mb-3" style="display: none;">
            <div class="col-12">
              <div class="alert alert-info">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="alert-heading mb-1">
                      <i class="fas fa-user me-1"></i>
                      <span id="selectedCustomerName"></span>
                    </h6>
                    <small class="text-muted">
                      <span id="selectedCustomerDetails"></span>
                    </small>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="clearCustomerBtn">
                    <i class="fas fa-times"></i> å¤‰æ›´
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- æ–°è¦é¡§å®¢ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆæ—¢å­˜é¡§å®¢ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰ -->
          <div id="newCustomerForm" class="row mb-3" style="display: none;">
            <div class="col-12">
              <div class="alert alert-warning">
                <h6 class="alert-heading">
                  <i class="fas fa-user-plus me-1"></i>æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²
                </h6>
                <p class="mb-2">è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²ã—ã¾ã™ã€‚</p>
              </div>
            </div>
            
            <div class="col-md-6">
              <label for="newCustomerName" class="form-label">é¡§å®¢å *</label>
              <input type="text" class="form-control" id="newCustomerName" required>
            </div>
            <div class="col-md-6">
              <label for="newCustomerPhone" class="form-label">é›»è©±ç•ªå·</label>
              <input type="tel" class="form-control" id="newCustomerPhone">
            </div>
            
            <div class="col-md-6 mt-2">
              <label for="newCustomerKana" class="form-label">ãƒ•ãƒªã‚¬ãƒŠ</label>
              <input type="text" class="form-control" id="newCustomerKana">
            </div>
            <div class="col-md-6 mt-2">
              <label for="newCustomerEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
              <input type="email" class="form-control" id="newCustomerEmail">
            </div>
          </div>
          
          <!-- äºˆç´„æƒ…å ±ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰ -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationDate" class="form-label">æ—¥ä»˜ *</label>
              <input type="date" class="form-control" id="reservationDate" required>
            </div>
            <div class="col-md-6">
              <label for="reservationTime" class="form-label">æ™‚é–“ *</label>
              <input type="time" class="form-control" id="reservationTime" min="10:00" max="21:00" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationCourse" class="form-label">ã‚³ãƒ¼ã‚¹ *</label>
              <select class="form-select" id="reservationCourse" required>
                <option value="">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠ</option>
                <option value="40åˆ†">40åˆ†ã‚³ãƒ¼ã‚¹ (Â¥8,000)</option>
                <option value="60åˆ†">60åˆ†ã‚³ãƒ¼ã‚¹ (Â¥12,000)</option>
                <option value="80åˆ†">80åˆ†ã‚³ãƒ¼ã‚¹ (Â¥16,000)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="reservationStatus" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
              <select class="form-select" id="reservationStatus">
                <option value="tentative">ä»®äºˆç´„</option>
                <option value="confirmed" selected>ç¢ºå®š</option>
                <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                <option value="completed">å®Œäº†</option>
                <option value="no_show">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
              </select>
            </div>
          </div>
          
          <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®š -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationInterval" class="form-label">æ•´ç†æ™‚é–“ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼‰</label>
              <select class="form-select" id="reservationInterval">
                <option value="">ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä½¿ç”¨</option>
                <option value="0">0åˆ†ï¼ˆæ•´ç†æ™‚é–“ãªã—ï¼‰</option>
                <option value="5">5åˆ†</option>
                <option value="10">10åˆ†</option>
                <option value="15">15åˆ†</option>
                <option value="20">20åˆ†</option>
                <option value="30">30åˆ†</option>
                <option value="45">45åˆ†</option>
                <option value="60">60åˆ†</option>
              </select>
              <small class="text-muted">å€‹åˆ¥ã«æ•´ç†æ™‚é–“ã‚’è¨­å®šã§ãã¾ã™</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">ç¾åœ¨ã®è¨­å®š</label>
              <div id="currentIntervalInfo" class="form-control-plaintext">
                <span class="badge bg-primary">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: 15åˆ†</span>
              </div>
            </div>
          </div>
          
          <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ™‚ã®ã¿è¡¨ç¤ºï¼‰ -->
          <div class="row mb-3" id="cancellationReasonRow" style="display: none;">
            <div class="col-12">
              <label for="cancellationReason" class="form-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”± <span class="text-danger">*</span></label>
              <textarea class="form-control" id="cancellationReason" rows="2" placeholder="ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>
          </div>
          
          <!-- ãƒã‚±ãƒƒãƒˆæƒ…å ± -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">ãƒã‚±ãƒƒãƒˆæƒ…å ±</label>
              <div id="ticketInfo" class="border rounded p-3 bg-light">
                <div class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
              </div>
            </div>
          </div>
          
          <!-- ãƒ¡ãƒ¢ -->
          <div class="row mb-3">
            <div class="col-12">
              <label for="reservationMemo" class="form-label">ãƒ¡ãƒ¢ãƒ»æ³¨æ„äº‹é …</label>
              <textarea class="form-control" id="reservationMemo" rows="3" placeholder="äºˆç´„ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚„æ³¨æ„äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="button" class="btn btn-danger" id="deleteReservationBtn" style="display: none;">
            <i class="fas fa-trash me-1"></i>å‰Šé™¤
          </button>
        <button type="button" class="btn btn-primary" id="saveReservationBtn">
            <i class="fas fa-save me-1"></i>ä¿å­˜
          </button>
      </div>
    </div>
  </div>
</div>

<!-- é¡§å®¢å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="customerHistoryModal" tabindex="-1" aria-labelledby="customerHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerHistoryModalLabel">
          <i class="fas fa-history me-2"></i>é¡§å®¢å±¥æ­´
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="customerHistoryContent">
          <!-- é¡§å®¢å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="cancelledHistoryModal" tabindex="-1" aria-labelledby="cancelledHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cancelledHistoryModalLabel">
          <i class="fas fa-times-circle text-danger me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆãƒ»å±¥æ­´
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-4">
            <div class="card border-danger">
              <div class="card-body text-center">
                <h3 class="text-danger mb-0" id="modalCancelledCount">0</h3>
                <small class="text-muted">ä»Šæœˆã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ•°</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-warning">
              <div class="card-body text-center">
                <h3 class="text-warning mb-0" id="modalCancelledRate">0%</h3>
                <small class="text-muted">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç‡</small>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card border-info">
              <div class="card-body text-center">
                <h3 class="text-info mb-0" id="modalTotalReservations">0</h3>
                <small class="text-muted">ä»Šæœˆã®ç·äºˆç´„æ•°</small>
              </div>
            </div>
          </div>
        </div>
        <div id="modalCancelledHistory">
          <div class="text-muted text-center py-3">
            <i class="fas fa-info-circle me-1"></i>
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>é–‰ã˜ã‚‹
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* ==============================================
   äºˆç´„ã‚¤ãƒ™ãƒ³ãƒˆã®åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ«
   ============================================== */
.fc-timegrid-event {
  border-radius: 8px !important;
  font-size: 0.9rem !important;
  font-weight: 600 !important;
  box-shadow: 0 3px 8px rgba(0,0,0,0.15) !important;
  transition: all 0.3s ease !important;
  border: none !important;
  margin: 2px 0 !important;
  min-height: 25px !important;
}

.fc-timegrid-event:hover {
  box-shadow: 0 6px 16px rgba(0,0,0,0.2) !important;
  transform: translateY(-2px) !important;
  z-index: 1000 !important;
}

/* ==============================================
   ã‚¿ãƒ–å½¢å¼ã®äºˆç´„ã‚¤ãƒ™ãƒ³ãƒˆ
   ============================================== */
.fc-timegrid-event.reservation-with-tabs {
  min-height: 50px !important;
  padding: 0 !important;
  border-radius: 8px !important;
  overflow: hidden !important;
  border: none !important;
}

.fc-timegrid-event.reservation-with-tabs .fc-event-main {
  padding: 0 !important;
  height: 100% !important;
}

.fc-timegrid-event.reservation-with-tabs .event-tabs {
  display: flex !important;
  flex-direction: column !important;
  height: 100% !important;
  width: 100% !important;
}

.fc-timegrid-event.reservation-with-tabs .event-tab {
  flex: 1 !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  padding: 2px 4px !important;
  font-size: 0.8rem !important;
  font-weight: 500 !important;
  text-align: center !important;
  border-bottom: 1px solid rgba(255, 255, 255, 0.3) !important;
  overflow: hidden !important;
}

.fc-timegrid-event.reservation-with-tabs .event-tab:last-child {
  border-bottom: none !important;
}

.fc-timegrid-event.reservation-with-tabs .event-tab.course {
  background: inherit !important;
  color: inherit !important;
}

.fc-timegrid-event.reservation-with-tabs .event-tab.interval {
  background-color: #6c757d !important;
  color: white !important;
}

.fc-timegrid-event.reservation-with-tabs .event-tab.interval.individual {
  background-color: #fd7e14 !important;
  color: white !important;
  font-weight: 600 !important;
}

.fc-timegrid-event.reservation-with-tabs .event-tab.interval.system {
  background-color: #6c757d !important;
  color: white !important;
}

/* ==============================================
   ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã®è‰²åˆ†ã‘
   ============================================== */
.fc-timegrid-event.confirmed {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
  border-color: #28a745 !important;
  color: white !important;
}

.fc-timegrid-event.tentative {
  background: linear-gradient(135deg, #ffc107 0%, #ffb84d 100%) !important;
  border-color: #ffc107 !important;
  color: #212529 !important;
}

.fc-timegrid-event.cancelled {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
  border-color: #dc3545 !important;
  color: white !important;
}

.fc-timegrid-event.completed {
  background: linear-gradient(135deg, #6f42c1 0%, #5a32a3 100%) !important;
  border-color: #6f42c1 !important;
  color: white !important;
}

.fc-timegrid-event.no_show {
  background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%) !important;
  border-color: #6c757d !important;
  color: white !important;
}

.fc-timegrid-event.break {
  background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
  border-color: #17a2b8 !important;
  color: white !important;
}
</style>

<script>
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ DOM Content Loaded');
    
    // FullCalendarã®åˆæœŸåŒ–
    const calendarEl = document.getElementById('calendar');
    console.log('ğŸ“… Calendar element:', calendarEl);
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã¨å±¥æ­´ã‚’å–å¾—ãƒ»è¡¨ç¤º
    function loadCancellationStats() {
      console.log('ğŸ“Š Loading cancellation stats...');
      
      fetch('/admin/reservations/cancellation_stats')
        .then(response => {
          console.log('ğŸ“Š Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('ğŸ“Š Received data:', data);
          
          // è¦ç´ ã®å­˜åœ¨ç¢ºèªã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          const cancelledCount = document.getElementById('cancelledCount');
          const cancelledRate = document.getElementById('cancelledRate');
          const historyContainer = document.getElementById('cancelledHistory');
          
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ•°ã‚’æ›´æ–°ï¼ˆè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          if (cancelledCount) {
            cancelledCount.textContent = data.cancelled_count;
          }
          if (cancelledRate) {
            cancelledRate.textContent = data.cancelled_rate + '%';
          }
          
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ã‚’æ›´æ–°ï¼ˆè¦ç´ ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿ï¼‰
          if (historyContainer) {
            if (data.cancelled_history && data.cancelled_history.length > 0) {
              console.log('ğŸ“Š Rendering history:', data.cancelled_history.length, 'items');
              const historyHtml = data.cancelled_history.map(item => `
                <div class="border-bottom pb-2 mb-2">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="fw-bold text-dark">${item.customer_name}</div>
                      <div class="small text-muted">
                        <i class="fas fa-calendar me-1"></i>${item.cancelled_at}
                        <span class="mx-2">|</span>
                        <i class="fas fa-clock me-1"></i>${item.course}
                      </div>
                    </div>
                  </div>
                  <div class="mt-1">
                    <small class="text-danger">
                      <i class="fas fa-times-circle me-1"></i>
                      ${item.reason || 'ç†ç”±æœªå…¥åŠ›'}
                    </small>
                  </div>
                </div>
              `).join('');
              historyContainer.innerHTML = historyHtml;
            } else {
              console.log('ğŸ“Š No cancellation history found');
              historyContainer.innerHTML = `
                <div class="text-muted text-center py-3">
                  <i class="fas fa-info-circle me-1"></i>
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
        </div>
      `;
    }
          } else {
            console.log('ğŸ“Š Cancellation history container not found, skipping update');
          }
        })
        .catch(error => {
          console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã®å–å¾—ã«å¤±æ•—:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º
          const cancelledCount = document.getElementById('cancelledCount');
          const cancelledRate = document.getElementById('cancelledRate');
          const cancelledHistory = document.getElementById('cancelledHistory');
          
          if (cancelledCount) cancelledCount.textContent = '0';
          if (cancelledRate) cancelledRate.textContent = '0%';
          if (cancelledHistory) {
            cancelledHistory.innerHTML = `
              <div class="text-muted text-center">
                <i class="fas fa-exclamation-triangle me-1"></i>
                çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
              </div>
            `;
          }
        });
    }

    if (!calendarEl) {
      console.error('âŒ Calendar element not found');
      return;
    }
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      locale: 'ja',
      // timeZoneè¨­å®šã‚’å‰Šé™¤ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’ä½¿ç”¨ï¼‰
      height: 'auto',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      buttonText: {
        today: 'ä»Šæ—¥',
        month: 'æœˆ',
        week: 'é€±',  
        day: 'æ—¥'
      },
      slotMinTime: '10:00:00',
      slotMaxTime: '21:00:00',
      slotDuration: '00:10:00', // 10åˆ†é–“éš”ã«å¤‰æ›´
      allDaySlot: false,
      selectable: true,
      editable: true,
      nowIndicator: true,
      eventDisplay: 'block', // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯è¡¨ç¤ºã«ã—ã¦é«˜ã•ã‚’åˆ¶å¾¡
      eventMinHeight: 25, // æœ€å°é«˜ã•ã‚’å¢—åŠ 
      dayHeaderFormat: { weekday: 'short', day: 'numeric', month: 'short' }, // ãƒ˜ãƒƒãƒ€ãƒ¼å½¢å¼ã‚’æ”¹å–„
      slotLabelFormat: { hour: '2-digit', minute: '2-digit', hour12: false }, // æ™‚é–“è¡¨ç¤ºã‚’æ”¹å–„
    
    // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†ã®è¨­å®š
    eventTimeFormat: {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false,
      timeZone: 'Asia/Tokyo'  // è¡¨ç¤ºæ™‚ã‚‚æ±äº¬æ™‚é–“ã‚’æ˜ç¤º
    },
    
    // ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
    eventDrop: function(info) {
      console.log('ğŸ”„ Event dropped:', info.event);
      updateReservationTime(info.event);
    },
    
    eventResize: function(info) {
      console.log('ğŸ“ Event resized:', info.event);
      updateReservationTime(info.event);
    },
    
    eventClick: function(info) {
      openReservationModal(info.event);
    },
    
    select: function(info) {
      console.log('ğŸ” Raw select info:', info);
      
      // TimeWithZoneã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯é©åˆ‡ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
      const startTime = info.start;
      const endTime = info.end;
      
      // æ™‚é–“ã¨åˆ†ã‚’å–å¾—ï¼ˆTimeWithZoneå¯¾å¿œï¼‰
      const startHour = startTime.getHours ? startTime.getHours() : startTime.hour;
      const startMinute = startTime.getMinutes ? startTime.getMinutes() : startTime.min;
      const endHour = endTime.getHours ? endTime.getHours() : endTime.hour;
      const endMinute = endTime.getMinutes ? endTime.getMinutes() : endTime.min;
      
      console.log('ğŸ” Start time details:', {
        start: startTime,
        hours: startHour,
        minutes: startMinute,
        toString: startTime.toString()
      });
      
      // å–¶æ¥­æ™‚é–“å¤–ã®é¸æŠã‚’ãƒã‚§ãƒƒã‚¯
      if (startHour < 10 || startHour >= 21) {
        console.log('âŒ Selected time outside business hours:', startHour);
        showMessage('å–¶æ¥­æ™‚é–“å¤–ã§ã™ã€‚10:00ã‹ã‚‰21:00ã®é–“ã§é¸æŠã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      // é¸æŠã•ã‚ŒãŸæ™‚é–“å¹…ã‚’è€ƒæ…®ã—ãŸå–¶æ¥­æ™‚é–“ãƒã‚§ãƒƒã‚¯
      const selectionDuration = (endTime - startTime) / (1000 * 60); // åˆ†å˜ä½
      
      console.log('ğŸ• Selection time check:', {
        startHour,
        endHour,
        endMinute,
        selectionDuration,
        businessEnd: '21:00'
      });
      
      if (endHour > 21 || (endHour === 21 && endMinute > 0)) {
        console.log('âŒ Selection extends beyond business hours');
        showMessage(`ã“ã®æ™‚é–“å¸¯ã¯å–¶æ¥­æ™‚é–“å¤–ã«ãªã‚Šã¾ã™ã€‚çµ‚äº†æ™‚åˆ»: ${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`, 'warning');
        return;
      }
      
      // ğŸ”§ ä¿®æ­£: openNewReservationModal ã‚’å‘¼ã³å‡ºã—
      openNewReservationModal(info.start, info.end);
    },
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
    eventContent: function(arg) {
      const event = arg.event;
      const extendedProps = event.extendedProps;
      
      console.log(`ğŸ¨ Rendering event ${event.id}:`, {
        title: event.title,
        start: event.start,
        end: event.end,
        extendedProps: extendedProps
      });
      
      // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒã‚ã‚‹å ´åˆã¯ã‚¿ãƒ–å½¢å¼ã§è¡¨ç¤º
      if (extendedProps.has_interval && extendedProps.interval_duration > 0) {
        const courseDuration = extendedProps.course_duration; // åˆ†å˜ä½
        const intervalDuration = extendedProps.interval_duration; // åˆ†å˜ä½
        const totalDuration = extendedProps.total_duration; // åˆ†å˜ä½
        
        // ã‚¿ãƒ–ã®é«˜ã•ã‚’è¨ˆç®—ï¼ˆæ™‚é–“ã®æ¯”ç‡ã«åŸºã¥ãï¼‰
        const courseHeight = Math.round((courseDuration / totalDuration) * 100);
        const intervalHeight = Math.round((intervalDuration / totalDuration) * 100);
        
        console.log(`ğŸ“Š Tab calculation for event ${event.id}:`, {
          courseDuration,
          intervalDuration,
          totalDuration,
          courseHeight: `${courseHeight}%`,
          intervalHeight: `${intervalHeight}%`
        });
        
        const intervalType = extendedProps.is_individual_interval ? 'individual' : 'system';
        
        return {
          html: `
            <div class="event-tabs" style="height: 100%; display: flex; flex-direction: column;">
              <div class="event-tab course" style="
                height: ${courseHeight}%; 
                flex: none; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                padding: 2px 4px; 
                font-size: 0.8rem; 
                font-weight: 500; 
                text-align: center; 
                border-bottom: 1px solid rgba(255, 255, 255, 0.3);
                overflow: hidden;
              ">
                ${event.title}
              </div>
              <div class="event-tab interval ${intervalType}" style="
                height: ${intervalHeight}%; 
                flex: none; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                padding: 2px 4px; 
                font-size: 0.8rem; 
                font-weight: 500; 
                text-align: center;
                background-color: ${intervalType === 'individual' ? '#fd7e14' : '#6c757d'};
                color: white;
                overflow: hidden;
              ">
                æ•´ç†${intervalDuration}åˆ†
              </div>
            </div>
          `
        };
      } else {
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãŒãªã„å ´åˆã¯é€šå¸¸è¡¨ç¤º
        return {
          html: `<div class="fc-event-main-frame">
            <div class="fc-event-title-container">
              <div class="fc-event-title fc-sticky">${event.title}</div>
            </div>
          </div>`
        };
      }
    },
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—
    events: function(info, successCallback, failureCallback) {
      console.log('ğŸ” Fetching events for:', info.startStr, 'to', info.endStr);
      
      fetch('/admin/reservations.json', {
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(events => {
        console.log('âœ… Events loaded:', events.length);
        successCallback(events);
      })
      .catch(error => {
        console.error('âŒ Error loading events:', error);
        failureCallback(error);
      });
    }
      });
    
    console.log('ğŸ¨ Rendering calendar...');
    calendar.render();
    console.log('âœ… Calendar rendered successfully');
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openCancelledHistoryModal = function() {
      console.log('ğŸ“Š Opening cancelled history modal');
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã‚’å–å¾—ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã«è¡¨ç¤º
      fetch('/admin/reservations/cancellation_stats')
        .then(response => {
          console.log('ğŸ“Š Response status:', response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('ğŸ“Š Received data for modal:', data);
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®çµ±è¨ˆã‚’æ›´æ–°
          document.getElementById('modalCancelledCount').textContent = data.cancelled_count;
          document.getElementById('modalCancelledRate').textContent = data.cancelled_rate + '%';
          document.getElementById('modalTotalReservations').textContent = data.total_reservations || 0;
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å±¥æ­´ã‚’æ›´æ–°
          const modalHistoryContainer = document.getElementById('modalCancelledHistory');
          if (data.cancelled_history && data.cancelled_history.length > 0) {
            console.log('ğŸ“Š Rendering modal history:', data.cancelled_history.length, 'items');
            const historyHtml = data.cancelled_history.map(item => `
              <div class="border-bottom pb-3 mb-3">
                <div class="d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1">
                    <div class="fw-bold text-dark fs-6">${item.customer_name}</div>
                    <div class="small text-muted mt-1">
                      <i class="fas fa-calendar me-1"></i>${item.cancelled_at}
                      <span class="mx-2">|</span>
                      <i class="fas fa-clock me-1"></i>${item.course}
                    </div>
                  </div>
                </div>
                <div class="mt-2">
                  <span class="badge bg-danger">
                    <i class="fas fa-times-circle me-1"></i>
                    ${item.reason || 'ç†ç”±æœªå…¥åŠ›'}
                  </span>
                </div>
              </div>
            `).join('');
            modalHistoryContainer.innerHTML = historyHtml;
          } else {
            console.log('ğŸ“Š No cancellation history found for modal');
            modalHistoryContainer.innerHTML = `
              <div class="text-muted text-center py-4">
                <i class="fas fa-info-circle me-1"></i>
                ã‚­ãƒ£ãƒ³ã‚»ãƒ«å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
              </div>
            `;
          }
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          const modal = new bootstrap.Modal(document.getElementById('cancelledHistoryModal'));
          modal.show();
        })
        .catch(error => {
          console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã®å–å¾—ã«å¤±æ•—:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
          const modalCancelledCount = document.getElementById('modalCancelledCount');
          const modalCancelledRate = document.getElementById('modalCancelledRate');
          const modalTotalReservations = document.getElementById('modalTotalReservations');
          const modalCancelledHistory = document.getElementById('modalCancelledHistory');
          
          if (modalCancelledCount) modalCancelledCount.textContent = '0';
          if (modalCancelledRate) modalCancelledRate.textContent = '0%';
          if (modalTotalReservations) modalTotalReservations.textContent = '0';
          if (modalCancelledHistory) {
            modalCancelledHistory.innerHTML = `
              <div class="text-muted text-center py-4">
                <i class="fas fa-exclamation-triangle me-1"></i>
                çµ±è¨ˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ
              </div>
            `;
          }
          
          const modal = new bootstrap.Modal(document.getElementById('cancelledHistoryModal'));
          modal.show();
      });
    };
    
    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’æ›´æ–°
    function updateIntervalInfo(extendedProps) {
      const intervalInfo = document.getElementById('currentIntervalInfo');
      const individualInterval = extendedProps?.individual_interval_minutes;
      const effectiveInterval = extendedProps?.effective_interval_minutes || 15;
      
      if (individualInterval !== null && individualInterval !== undefined) {
        intervalInfo.innerHTML = `<span class="badge bg-success">å€‹åˆ¥è¨­å®š: ${individualInterval}åˆ†</span>`;
      } else {
        intervalInfo.innerHTML = `<span class="badge bg-primary">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: ${effectiveInterval}åˆ†</span>`;
      }
    }

    // åˆæœŸãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
    try {
      loadCancellationStats();
    } catch (error) {
      console.log('ğŸ“Š Initial cancellation stats loading skipped:', error.message);
    }
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
    const urlParams = new URLSearchParams(window.location.search);
    const editReservationId = urlParams.get('edit');
    
    if (editReservationId) {
      console.log('ğŸ”§ Edit mode detected for reservation:', editReservationId);
      
      // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      setTimeout(() => {
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰è©²å½“ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
        const event = calendar.getEventById(editReservationId);
        if (event) {
          console.log('âœ… Found event for editing:', event);
          openReservationModal(event);
        } else {
          console.log('âŒ Event not found for editing:', editReservationId);
          showMessage('ç·¨é›†ã™ã‚‹äºˆç´„ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
        }
      }, 1000); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
    }
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
    document.getElementById('prevBtn').addEventListener('click', () => {
      calendar.prev();
    });
    
    document.getElementById('nextBtn').addEventListener('click', () => {
      calendar.next();
    });
    
    document.getElementById('todayBtn').addEventListener('click', () => {
      calendar.today();
    });
    
    // æ–°è¦äºˆç´„ãƒœã‚¿ãƒ³
    document.getElementById('newReservationBtn').addEventListener('click', () => {
      openNewReservationModal();
    });
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    const reservationModal = new bootstrap.Modal(document.getElementById('reservationModal'));
    const customerHistoryModal = new bootstrap.Modal(document.getElementById('customerHistoryModal'));
    
    // é¡§å®¢æ¤œç´¢ãƒ»é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ 
    // é¡§å®¢æ¤œç´¢æ©Ÿèƒ½
    let searchTimeout;
    const customerSearch = document.getElementById('customerSearch');
    const searchResults = document.getElementById('customerSearchResults');
    const selectedCustomerInfo = document.getElementById('selectedCustomerInfo');
    const newCustomerForm = document.getElementById('newCustomerForm');

    customerSearch.addEventListener('input', function() {
      const query = this.value.trim();
      
      clearTimeout(searchTimeout);
      
      if (query.length < 2) {
        hideSearchResults();
      return;
    }
    
      searchTimeout = setTimeout(() => {
        searchCustomers(query);
      }, 300);
    });

    // æ¤œç´¢çµæœä»¥å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰çµæœã‚’éš ã™
    document.addEventListener('click', function(e) {
      if (!e.target.closest('#customerSearch') && !e.target.closest('#customerSearchResults')) {
        hideSearchResults();
      }
    });

    // æ¤œç´¢çµæœã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‡¦ç†
    document.addEventListener('click', function(e) {
      const searchResultItem = e.target.closest('.search-result-item');
      if (searchResultItem) {
        const userId = searchResultItem.dataset.userId;
        const userName = searchResultItem.dataset.userName;
        const userPhone = searchResultItem.dataset.userPhone;
        const userEmail = searchResultItem.dataset.userEmail;
        
        console.log('Search result clicked:', { userId, userName, userPhone, userEmail });
        selectCustomer(userId, userName, userPhone, userEmail);
      }
    });

    function searchCustomers(query) {
      fetch(`/admin/users/search?query=${encodeURIComponent(query)}`, {
      headers: {
        'Accept': 'application/json',
          'Content-Type': 'application/json'
        }
    })
    .then(response => {
      if (!response.ok) {
          if (response.status === 401) {
            // èªè¨¼ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            window.location.href = '/admin_users/sign_in';
            throw new Error('èªè¨¼ãŒå¿…è¦ã§ã™');
      }
          throw new Error(`HTTP error! status: ${response.status}`);
        }
      return response.json();
    })
    .then(data => {
        displaySearchResults(data.users, query);
    })
    .catch(error => {
        console.error('é¡§å®¢æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
        hideSearchResults();
      });
    }

    function displaySearchResults(users, query) {
      if (users.length === 0) {
        // æ¤œç´¢çµæœãŒãªã„å ´åˆã¯æ–°è¦é¡§å®¢ç™»éŒ²ã‚’ææ¡ˆ
        searchResults.innerHTML = `
          <div class="p-3 text-center">
            <div class="text-muted mb-2">
              <i class="fas fa-search me-1"></i>
              ã€Œ${query}ã€ã«è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ
            </div>
            <button type="button" class="btn btn-sm btn-primary" onclick="showNewCustomerForm('${query}')">
              <i class="fas fa-user-plus me-1"></i>æ–°è¦é¡§å®¢ã¨ã—ã¦ç™»éŒ²
            </button>
          </div>
        `;
    } else {
        let html = '';
        users.forEach(user => {
          html += `
            <div class="search-result-item p-3 border-bottom" 
                 style="cursor: pointer; transition: background-color 0.2s;"
                 onmouseover="this.style.backgroundColor='#f8f9fa'"
                 onmouseout="this.style.backgroundColor='white'"
                 data-user-id="${user.id}"
                 data-user-name="${user.name || ''}"
                 data-user-phone="${user.phone_number || ''}"
                 data-user-email="${user.email || ''}">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">${user.name || 'åå‰æœªè¨­å®š'}</div>
                  <small class="text-muted">
                    ${user.phone_number || 'é›»è©±ç•ªå·æœªç™»éŒ²'}
                    ${user.email ? ` | ${user.email}` : ''}
                  </small>
                  ${user.last_visit ? `<br><small class="text-success">æœ€çµ‚æ¥åº—: ${user.last_visit}</small>` : ''}
                </div>
                <div class="text-end">
                  <small class="badge bg-info">${user.active_tickets}æš</small>
                </div>
              </div>
            </div>
          `;
        });
        searchResults.innerHTML = html;
      }
      
      searchResults.style.display = 'block';
    }

    function hideSearchResults() {
      searchResults.style.display = 'none';
    }

    function selectCustomer(userId, name, phone, email) {
      console.log('selectCustomer called with:', { userId, name, phone, email });
      
      // é¸æŠã•ã‚ŒãŸé¡§å®¢æƒ…å ±ã‚’ä¿å­˜
      document.getElementById('selectedUserId').value = userId;
      document.getElementById('customerSearch').value = name;
      
      // é¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º
      document.getElementById('selectedCustomerName').textContent = name;
      document.getElementById('selectedCustomerDetails').innerHTML = `
        ${phone || 'é›»è©±ç•ªå·æœªç™»éŒ²'} | 
        ${email || 'ãƒ¡ãƒ¼ãƒ«æœªç™»éŒ²'}
      `;
      
      // UIæ›´æ–°
      selectedCustomerInfo.style.display = 'block';
      newCustomerForm.style.display = 'none';
      hideSearchResults();
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–ï¼ˆé¸æŠæ¸ˆã¿ã‚’ç¤ºã™ï¼‰
      document.getElementById('customerSearch').disabled = true;
      document.getElementById('customerSearch').style.backgroundColor = '#e9ecef';
      
      // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
      loadCustomerTickets(userId);
      
      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      showMessage('é¡§å®¢ãŒé¸æŠã•ã‚Œã¾ã—ãŸ', 'success');
      
      console.log('é¡§å®¢ãŒé¸æŠã•ã‚Œã¾ã—ãŸ:', { userId, name, phone, email });
    }

    function showNewCustomerForm(initialName = '') {
      // æ–°è¦é¡§å®¢ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
      newCustomerForm.style.display = 'block';
      selectedCustomerInfo.style.display = 'none';
      document.getElementById('selectedUserId').value = '';
      
      // æ¤œç´¢ã—ãŸåå‰ã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
      if (initialName) {
        document.getElementById('newCustomerName').value = initialName;
      }
      
      hideSearchResults();
      
      // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’åå‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«
      document.getElementById('newCustomerName').focus();
    }

    // é¡§å®¢é¸æŠã‚’ã‚¯ãƒªã‚¢
    document.getElementById('clearCustomerBtn').addEventListener('click', function() {
      document.getElementById('selectedUserId').value = '';
      document.getElementById('customerSearch').value = '';
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
      document.getElementById('customerSearch').disabled = false;
      document.getElementById('customerSearch').style.backgroundColor = 'white';
      
      selectedCustomerInfo.style.display = 'none';
      newCustomerForm.style.display = 'none';
      document.getElementById('ticketInfo').innerHTML = `
        <div class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      `;
      customerSearch.focus();
      
      showMessage('é¡§å®¢é¸æŠã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
    });

    function resetReservationForm() {
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('reservationForm').reset();
      document.getElementById('currentReservationId').value = '';
      document.getElementById('selectedUserId').value = '';
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('cancellationReason').value = '';
      document.getElementById('cancellationReasonRow').style.display = 'none';
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æœ‰åŠ¹åŒ–
      document.getElementById('customerSearch').disabled = false;
      document.getElementById('customerSearch').style.backgroundColor = 'white';
      
      // UIè¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
      selectedCustomerInfo.style.display = 'none';
      newCustomerForm.style.display = 'none';
      hideSearchResults();
      
      // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('ticketInfo').innerHTML = `
        <div class="text-muted">
          <i class="fas fa-info-circle me-1"></i>
          é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
      `;
    }
    
    // openReservationModal é–¢æ•°ã‚’å®Œå…¨ã«ç½®ãæ›ãˆï¼ˆ522è¡Œç›®ä»˜è¿‘ï¼‰
    function openReservationModal(event) {
      // æ—¢å­˜ã®äºˆç´„ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
      document.getElementById('reservationModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>äºˆç´„ç·¨é›†';
      document.getElementById('deleteReservationBtn').style.display = 'block';
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetReservationForm();
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
      if (event) {
        // äºˆç´„IDã‚’è¨­å®š
        document.getElementById('currentReservationId').value = event.id;
        
        // ğŸ”§ å®Œå…¨ãªä¿®æ­£: UTCå¤‰æ›ã‚’é¿ã‘ã¦ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã‚’ç›´æ¥å–å¾—
        const eventStart = event.start;
        
        // æ—¥ä»˜ã®å–å¾—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã¨ã—ã¦ï¼‰
        const year = eventStart.getFullYear();
        const month = String(eventStart.getMonth() + 1).padStart(2, '0');
        const day = String(eventStart.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        // æ™‚é–“ã®å–å¾—ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã¨ã—ã¦ï¼‰
        const hours = String(eventStart.getHours()).padStart(2, '0');
        const minutes = String(eventStart.getMinutes()).padStart(2, '0');
        const timeString = `${hours}:${minutes}`;
        
        console.log('ğŸ• Edit reservation time:', {
          original: eventStart,
          dateString: dateString,
          timeString: timeString
        });
        
        document.getElementById('reservationDate').value = dateString;
        document.getElementById('reservationTime').value = timeString;
        document.getElementById('reservationCourse').value = event.title.split(' - ')[1] || '';
        document.getElementById('reservationStatus').value = event.extendedProps?.status || 'confirmed';
        document.getElementById('reservationMemo').value = event.extendedProps?.note || '';
        
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šã‚’è¨­å®š
        const individualInterval = event.extendedProps?.individual_interval_minutes;
        document.getElementById('reservationInterval').value = individualInterval || '';
        
        // ç¾åœ¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’æ›´æ–°
        updateIntervalInfo(event.extendedProps);
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’è¨­å®š
        const cancellationReason = event.extendedProps?.cancellation_reason || '';
        document.getElementById('cancellationReason').value = cancellationReason;
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å ´åˆã¯ç†ç”±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
        if (event.extendedProps?.status === 'cancelled') {
          document.getElementById('cancellationReasonRow').style.display = 'block';
        }
        
        // é¡§å®¢æƒ…å ±ã‚’è¨­å®šï¼ˆæ–°ã—ã„é¡§å®¢æ¤œç´¢æ©Ÿèƒ½ã«å¯¾å¿œï¼‰
        if (event.extendedProps?.customer) {
          const customer = event.extendedProps.customer;
          
          // é¡§å®¢é¸æŠçŠ¶æ…‹ã‚’è¨­å®š
          document.getElementById('selectedUserId').value = customer.id;
          document.getElementById('customerSearch').value = customer.name || '';
          
          // é¡§å®¢æƒ…å ±ã‚’è¡¨ç¤º
          document.getElementById('selectedCustomerName').textContent = customer.name || '';
          document.getElementById('selectedCustomerDetails').innerHTML = `
            ${customer.phone || 'é›»è©±ç•ªå·æœªç™»éŒ²'} | 
            ${customer.email || 'ãƒ¡ãƒ¼ãƒ«æœªç™»éŒ²'}
          `;
          
          // UIæ›´æ–°
          document.getElementById('selectedCustomerInfo').style.display = 'block';
          document.getElementById('newCustomerForm').style.display = 'none';
          
          // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
          document.getElementById('customerSearch').disabled = true;
          document.getElementById('customerSearch').style.backgroundColor = '#e9ecef';
          
          // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
          loadCustomerTickets(customer.id);
        }
      }
      
      reservationModal.show();
    }

    // openNewReservationModal é–¢æ•°ã‚‚åŒæ§˜ã«ä¿®æ­£ï¼ˆ561è¡Œç›®ä»˜è¿‘ï¼‰
    function openNewReservationModal(start, end) {
      // æ–°è¦äºˆç´„ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
      document.getElementById('reservationModalLabel').innerHTML = '<i class="fas fa-calendar-plus me-2"></i>æ–°è¦äºˆç´„';
      document.getElementById('deleteReservationBtn').style.display = 'none';
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      resetReservationForm();
      
      // äºˆç´„IDã‚’ã‚¯ãƒªã‚¢
      document.getElementById('currentReservationId').value = '';
      
      // æ—¥æ™‚ã‚’è¨­å®š
      if (start) {
        // ğŸ”§ å®Œå…¨ãªä¿®æ­£: UTCå¤‰æ›ã‚’é¿ã‘ã¦ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã‚’ç›´æ¥å–å¾—
        const eventStart = new Date(start);
        
        const year = eventStart.getFullYear();
        const month = String(eventStart.getMonth() + 1).padStart(2, '0');
        const day = String(eventStart.getDate()).padStart(2, '0');
        const dateString = `${year}-${month}-${day}`;
        
        const hours = String(eventStart.getHours()).padStart(2, '0');
        const minutes = String(eventStart.getMinutes()).padStart(2, '0');
        const timeString = `${hours}:${minutes}`;
        
        console.log('ğŸ• New reservation time:', {
          original: start,
          eventStart: eventStart,
          dateString: dateString,
          timeString: timeString
        });
        
        document.getElementById('reservationDate').value = dateString;
        document.getElementById('reservationTime').value = timeString;
      }
      
      reservationModal.show();
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“æ›´æ–°æ©Ÿèƒ½
    function updateReservationTime(event) {
      const reservationId = event.id;
      const newStart = event.start;
      const newEnd = event.end;
      
      console.log('ğŸ”„ Updating reservation time:', {
        id: reservationId,
        start: newStart,
        end: newEnd,
        extendedProps: event.extendedProps
      });
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      
      // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã‚’æ—¥æœ¬æ™‚é–“ã¨ã—ã¦æ˜ç¤ºçš„ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆUTCå¤‰æ›ã‚’é¿ã‘ã‚‹ï¼‰
      function formatAsJSTDateTime(date) {
        if (!date) return null;
        
        // TimeWithZoneã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯é©åˆ‡ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
        const year = date.getFullYear ? date.getFullYear() : date.year;
        const month = date.getMonth ? String(date.getMonth() + 1).padStart(2, '0') : String(date.month).padStart(2, '0');
        const day = date.getDate ? String(date.getDate()).padStart(2, '0') : String(date.day).padStart(2, '0');
        const hours = date.getHours ? String(date.getHours()).padStart(2, '0') : String(date.hour).padStart(2, '0');
        const minutes = date.getMinutes ? String(date.getMinutes()).padStart(2, '0') : String(date.min).padStart(2, '0');
        const seconds = date.getSeconds ? String(date.getSeconds()).padStart(2, '0') : String(date.sec).padStart(2, '0');
        
        // JSTï¼ˆUTC+09:00ï¼‰ã¨ã—ã¦æ˜ç¤ºçš„ã«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æŒ‡å®š
        return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}+09:00`;
      }
      
      // ãƒ‰ãƒ©ãƒƒã‚°æ™‚ã®æ™‚é–“ã‚’ãã®ã¾ã¾é€ä¿¡ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã§é©åˆ‡ã«å‡¦ç†ï¼‰
      const startISO = formatAsJSTDateTime(newStart);
      const endISO = formatAsJSTDateTime(newEnd);
      
      console.log('ğŸ• Drag time conversion:', {
        start: newStart,
        end: newEnd,
        startISO: startISO,
        endISO: endISO,
        effectiveIntervalMinutes: event.extendedProps?.effective_interval_minutes || 0
      });
      
      console.log('ğŸ• Time conversion:', {
        start: newStart,
        end: newEnd,
        startISO: startISO,
        endISO: endISO,
        startLocalTime: newStart.toLocaleString('ja-JP'),
        endLocalTime: newEnd.toLocaleString('ja-JP'),
        effectiveIntervalMinutes: event.extendedProps?.effective_interval_minutes || 0
      });
      
      // æ™‚é–“æ›´æ–°APIã‚’å‘¼ã³å‡ºã—
      fetch(`/admin/reservations/${reservationId}`, {
        method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({
          reservation: {
            start_time: startISO,
            end_time: endISO
          },
          is_drag_update: true
        })
    })
    .then(response => {
        console.log('ğŸ“¡ Update response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
      return response.json();
    })
    .then(data => {
        console.log('âœ… Time update response:', data);
      
      if (data.success) {
          showMessage('äºˆç´„æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
          
          // æˆåŠŸæ™‚ã‚‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
          setTimeout(() => {
            calendar.refetchEvents();
          }, 500);
        } else {
          throw new Error(data.error || 'æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Time update error:', error);
        showMessage('æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'danger');
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿
        calendar.refetchEvents();
      });
    }
    
    function loadCustomerTickets(customerId) {
      if (!customerId) return;
      
      fetch(`/admin/users/${customerId}/tickets`)
        .then(response => response.json())
        .then(tickets => {
          const ticketInfo = document.getElementById('ticketInfo');
          if (tickets.length > 0) {
            let html = '<div class="row">';
            tickets.forEach(ticket => {
              const statusClass = ticket.status === 'expired' ? 'text-danger' : 
                                ticket.status === 'low' ? 'text-warning' : 'text-success';
              html += `
                <div class="col-md-6 mb-2">
                  <div class="card">
                    <div class="card-body p-2">
                      <h6 class="card-title mb-1">${ticket.name}</h6>
                                             <p class="card-text mb-1">
                         <small class="text-muted">
                           æ®‹ã‚Š: ${ticket.remaining}/${ticket.total}å›
                         </small>
                       </p>
                       <p class="card-text mb-1">
                         <small class="text-muted">
                           æœŸé™: ${ticket.expires_at || 'ãªã—'}
                         </small>
                       </p>
                       <p class="card-text mb-0">
                         <small class="${statusClass}">
                           ${ticket.status === 'expired' ? 'æœŸé™åˆ‡ã‚Œ' : 
                             ticket.status === 'low' ? 'æ®‹ã‚Šå°‘ãªã„' : 'åˆ©ç”¨å¯èƒ½'}
                         </small>
                       </p>
                    </div>
                  </div>
                </div>
              `;
            });
            html += '</div>';
            ticketInfo.innerHTML = html;
      } else {
            ticketInfo.innerHTML = '<div class="text-muted">ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }
    })
    .catch(error => {
          console.error('Error loading tickets:', error);
          document.getElementById('ticketInfo').innerHTML = '<div class="text-danger">ãƒã‚±ãƒƒãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã®å‡¦ç†
    document.getElementById('reservationStatus').addEventListener('change', function() {
      const status = this.value;
      console.log('ğŸ“Š Status changed to:', status);
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
      const cancellationReasonRow = document.getElementById('cancellationReasonRow');
      if (status === 'cancelled') {
        cancellationReasonRow.style.display = 'block';
      } else {
        cancellationReasonRow.style.display = 'none';
        document.getElementById('cancellationReason').value = '';
      }
    });

    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šå¤‰æ›´æ™‚ã®å‡¦ç†
    document.getElementById('reservationInterval').addEventListener('change', function() {
      const intervalValue = this.value;
      const intervalInfo = document.getElementById('currentIntervalInfo');
      
      if (intervalValue === '') {
        intervalInfo.innerHTML = '<span class="badge bg-primary">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: 15åˆ†</span>';
      } else {
        intervalInfo.innerHTML = `<span class="badge bg-success">å€‹åˆ¥è¨­å®š: ${intervalValue}åˆ†</span>`;
      }
    });

    // ä¿å­˜ãƒœã‚¿ãƒ³
    document.getElementById('saveReservationBtn').addEventListener('click', function() {
      console.log('ğŸ’¾ Save button clicked');
      
      // é¡§å®¢é¸æŠã®ãƒã‚§ãƒƒã‚¯
      const selectedUserId = document.getElementById('selectedUserId').value;
      if (!selectedUserId) {
        console.log('âŒ No customer selected');
        showMessage('é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„', 'warning');
      return;
    }
    
      // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
      const reservationDate = document.getElementById('reservationDate').value;
      const reservationTime = document.getElementById('reservationTime').value;
      const reservationCourse = document.getElementById('reservationCourse').value;
      
      if (!reservationDate || !reservationTime || !reservationCourse) {
        console.log('âŒ Required fields missing:', { reservationDate, reservationTime, reservationCourse });
        showMessage('æ—¥æ™‚ã¨ã‚³ãƒ¼ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      // æ™‚é–“ã®ç¯„å›²ãƒã‚§ãƒƒã‚¯ï¼ˆ10:00-21:00ï¼‰
      const timeParts = reservationTime.split(':');
      const hours = parseInt(timeParts[0]);
      const minutes = parseInt(timeParts[1]);
      
      if (hours < 10 || hours >= 21) {
        console.log('âŒ Time out of range:', reservationTime);
        showMessage('äºˆç´„æ™‚é–“ã¯10:00ã‹ã‚‰21:00ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      // ã‚³ãƒ¼ã‚¹æ™‚é–“ã¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚’è€ƒæ…®ã—ãŸå–¶æ¥­æ™‚é–“ãƒã‚§ãƒƒã‚¯
      const courseDuration = parseInt(reservationCourse.match(/(\d+)åˆ†/)?.[1] || 60);
      const checkIntervalValue = document.getElementById('reservationInterval').value;
      const intervalDuration = checkIntervalValue ? parseInt(checkIntervalValue) : 15; // ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      const totalDuration = courseDuration + intervalDuration;
      
      // äºˆç´„çµ‚äº†æ™‚åˆ»ã‚’è¨ˆç®—
      const startTime = new Date(`${reservationDate}T${reservationTime}:00`);
      const endTime = new Date(startTime.getTime() + totalDuration * 60 * 1000);
      const endHour = endTime.getHours();
      const endMinute = endTime.getMinutes();
      
      console.log('ğŸ• Reservation time check:', {
        startTime: reservationTime,
        courseDuration,
        intervalDuration,
        totalDuration,
        endTime: `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`,
        businessEnd: '21:00'
      });
      
      if (endHour > 21 || (endHour === 21 && endMinute > 0)) {
        console.log('âŒ Reservation extends beyond business hours');
        showMessage(`ã“ã®äºˆç´„ã¯å–¶æ¥­æ™‚é–“å¤–ã«ãªã‚Šã¾ã™ã€‚çµ‚äº†æ™‚åˆ»: ${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`, 'warning');
        return;
      }
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const saveBtn = this;
      const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';
      
      // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—
      const reservationId = getCurrentReservationId();
      const isEditMode = reservationId && reservationId !== '';
      
      // é¸æŠã•ã‚ŒãŸé¡§å®¢IDã‚’å–å¾—ï¼ˆæ—¢ã«å®£è¨€æ¸ˆã¿ï¼‰
      console.log('ğŸ‘¤ Selected user ID:', selectedUserId);
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã®ãƒã‚§ãƒƒã‚¯
      const status = document.getElementById('reservationStatus').value;
      const cancellationReason = document.getElementById('cancellationReason').value;
      
      if (status === 'cancelled' && !cancellationReason.trim()) {
        console.log('âŒ Cancellation reason required');
        showMessage('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
        return;
      }
      
      // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šã‚’å–å¾—
      const intervalValue = document.getElementById('reservationInterval').value;
      let individualIntervalMinutes = null;
      
      if (intervalValue !== '' && !isNaN(parseInt(intervalValue))) {
        individualIntervalMinutes = parseInt(intervalValue);
      }
      
      console.log('ğŸ• Interval setting:', { intervalValue, individualIntervalMinutes });
      
      // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      const reservationData = {
        reservation: {
          user_id: selectedUserId,
          name: document.getElementById('customerSearch').value,
          date: document.getElementById('reservationDate').value,
          time: document.getElementById('reservationTime').value,
          course: document.getElementById('reservationCourse').value,
          status: document.getElementById('reservationStatus').value,
          cancellation_reason: cancellationReason,
          individual_interval_minutes: individualIntervalMinutes,
          note: document.getElementById('reservationMemo').value
        }
      };
      
      console.log('ğŸ’¾ Saving reservation:', reservationData);
      console.log('ğŸ• Individual interval minutes in payload:', reservationData.reservation.individual_interval_minutes);
      console.log('ğŸ“ Edit mode:', isEditMode);
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      console.log('ğŸ” CSRF Token:', csrfToken);
      
      // API URLã¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ±ºå®š
      const url = isEditMode ? `/admin/reservations/${reservationId}` : '/admin/reservations';
      const method = isEditMode ? 'PATCH' : 'POST';
      console.log('ğŸŒ API URL:', url);
      console.log('ğŸ“¡ Method:', method);
      
      // APIã‚’å‘¼ã³å‡ºã—
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify(reservationData)
      })
      .then(response => {
        console.log('ğŸ“¡ Save response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ… Save response:', data);
        
        if (data.success) {
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const message = isEditMode ? 'äºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'äºˆç´„ã‚’ä½œæˆã—ã¾ã—ãŸ';
          showMessage(message, 'success');
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          reservationModal.hide();
          
          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
          calendar.refetchEvents();
          
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«çµ±è¨ˆã®æ›´æ–°ã¯ç„¡åŠ¹åŒ–ï¼ˆã‚¨ãƒ©ãƒ¼ã®åŸå› ã¨ãªã‚‹ãŸã‚ï¼‰
          console.log('âœ… Reservation saved successfully, calendar updated');
  } else {
          throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Save error:', error);
        alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .finally(() => {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      });
    });
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³
    document.getElementById('deleteReservationBtn').addEventListener('click', function() {
      if (!confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå‰Šé™¤ã—ãŸäºˆç´„ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚')) {
        return;
      }
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const deleteBtn = this;
      const originalText = deleteBtn.innerHTML;
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>å‰Šé™¤ä¸­...';
      
      // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ï¼‰
      const reservationId = getCurrentReservationId();
      
      if (!reservationId) {
        alert('å‰Šé™¤ã™ã‚‹äºˆç´„ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
        return;
      }
      
      console.log('ğŸ—‘ï¸ Deleting reservation:', reservationId);
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      
      // å‰Šé™¤APIã‚’å‘¼ã³å‡ºã—
      fetch(`/admin/reservations/${reservationId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        }
      })
      .then(response => {
        console.log('ğŸ“¡ Delete response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ… Delete response:', data);
        
        if (data.success) {
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          showMessage('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          reservationModal.hide();
          
          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
          calendar.refetchEvents();
        } else {
          throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Delete error:', error);
        alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .finally(() => {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
      });
    });
    
    // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getCurrentReservationId() {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰äºˆç´„IDã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’å®Ÿè£…
      // ä¾‹: ãƒ¢ãƒ¼ãƒ€ãƒ«ã«éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆ
      const hiddenField = document.getElementById('currentReservationId');
      return hiddenField ? hiddenField.value : null;
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
    function showMessage(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // ãƒšãƒ¼ã‚¸ã®ä¸Šéƒ¨ã«è¡¨ç¤º
      const container = document.querySelector('.calendar-container');
      container.insertBefore(alertDiv, container.firstChild);
      
      // 3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }
  });
</script>

<style>
  /* ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .fc-event.interval {
    font-weight: 500;
    border-radius: 4px;
  }
  
  /* ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼ˆç°è‰²ï¼‰ */
  .fc-event.interval.system-interval {
    background-color: #6c757d !important;
    border-color: #545b62 !important;
    color: white !important;
  }
  
  /* å€‹åˆ¥è¨­å®šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ï¼ˆç°è‰²ï¼‰ */
  .fc-event.interval.individual-interval {
    background-color: #6c757d !important;
    border-color: #545b62 !important;
    color: white !important;
    font-weight: 600;
  }
  
  /* å€‹åˆ¥è¨­å®šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã«ç‰¹åˆ¥ãªã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ  */
  .fc-event.interval.individual-interval::before {
    content: "âš™ï¸ ";
    margin-right: 2px;
  }
  
  /* ãƒ›ãƒãƒ¼æ™‚ã®åŠ¹æœ */
  .fc-event.interval:hover {
    opacity: 0.8;
    transform: scale(1.02);
    transition: all 0.2s ease;
  }
  
  /* å€‹åˆ¥è¨­å®šã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—é¢¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .fc-event.interval.individual-interval {
    position: relative;
  }
  
  .fc-event.interval.individual-interval:hover::after {
    content: "å€‹åˆ¥è¨­å®š";
    position: absolute;
    top: -25px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0, 0, 0, 0.8);
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 10px;
    white-space: nowrap;
    z-index: 1000;
  }
</style>