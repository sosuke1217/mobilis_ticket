<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
  </div>
  
  <div class="table-responsive">
    <div id="calendar" style="width: 100%; max-width: 100%; margin: auto;"></div>
  </div>
</div>

<!-- äºˆç´„ä½œæˆãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reservationModalLabel">äºˆç´„</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
      </div>
      <div class="modal-body">
        <form id="reservationForm">
          <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="card mb-3">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">äºˆç´„è€…é¸æŠ</h6>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="newUserToggle">
                  <label class="form-check-label" for="newUserToggle">
                    æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
                  </label>
                </div>
              </div>
            </div>
            <div class="card-body">
              <!-- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ -->
              <div id="existingUserSection">
                <label for="reservationUserId" class="form-label">æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</label>
                <select class="form-control" id="reservationUserId">
                  <option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>

              <!-- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
              <div id="newUserSection" style="display: none;">
                <div class="row">
                  <div class="col-md-6">
                    <label for="newUserName" class="form-label">æ°å <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="newUserName" placeholder="ä¾‹: å±±ç”°å¤ªéƒ">
                  </div>
                  <div class="col-md-6">
                    <label for="newUserPhone" class="form-label">é›»è©±ç•ªå·</label>
                    <input type="tel" class="form-control" id="newUserPhone" placeholder="ä¾‹: 090-1234-5678">
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-md-6">
                    <label for="newUserEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" class="form-control" id="newUserEmail" placeholder="ä¾‹: example@email.com">
                  </div>
                  <div class="col-md-6">
                    <label for="newUserBirthDate" class="form-label">ç”Ÿå¹´æœˆæ—¥</label>
                    <input type="date" class="form-control" id="newUserBirthDate">
                  </div>
                </div>
                <div class="mt-2">
                  <label for="newUserAddress" class="form-label">ä½æ‰€</label>
                  <input type="text" class="form-control" id="newUserAddress" placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒº...">
                </div>
                <div class="mt-2">
                  <label for="newUserMemo" class="form-label">ç®¡ç†è€…ãƒ¡ãƒ¢</label>
                  <textarea class="form-control" id="newUserMemo" rows="2" placeholder="åˆå›æ¥åº—ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±ãªã©"></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- äºˆç´„è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">äºˆç´„è©³ç´°</h6>
            </div>
            <div class="card-body">
              <!-- æ—¥ä»˜é¸æŠ -->
              <div class="row">
                <div class="col-md-6">
                  <label for="reservationDate" class="form-label">äºˆç´„æ—¥</label>
                  <input type="date" class="form-control" id="reservationDate" required>
                </div>
                <div class="col-md-6">
                  <label for="reservationTime" class="form-label">é–‹å§‹æ™‚é–“</label>
                  <select class="form-control" id="reservationTime" required>
                    <option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                  </select>
                </div>
              </div>

              <div class="row mt-2">
                <div class="col-md-6">
                  <label for="reservationCourse" class="form-label">ã‚³ãƒ¼ã‚¹</label>
                  <select class="form-control" id="reservationCourse">
                    <option value="40åˆ†">40åˆ†ã‚³ãƒ¼ã‚¹</option>
                    <option value="60åˆ†" selected>60åˆ†ã‚³ãƒ¼ã‚¹</option>
                    <option value="80åˆ†">80åˆ†ã‚³ãƒ¼ã‚¹</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">çµ‚äº†äºˆå®šæ™‚é–“</label>
                  <div id="endTimeDisplay" class="form-control-plaintext text-muted">æ™‚é–“ã¨ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                </div>
              </div>

              <div class="mt-2">
                <label for="reservationNote" class="form-label">å‚™è€ƒ</label>
                <textarea class="form-control" id="reservationNote" rows="2" placeholder="ç‰¹åˆ¥ãªè¦æœ›ã‚„æ³¨æ„äº‹é …ãªã©"></textarea>
              </div>
            </div>
          </div>

          <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
          <input type="hidden" id="reservationStartTime">
          <input type="hidden" id="reservationId">
          <input type="hidden" id="reservationName">

          <!-- ãƒœã‚¿ãƒ³ -->
          <div class="d-flex justify-content-between">
            <button type="button" id="deleteReservationBtn" class="btn btn-danger d-none">å‰Šé™¤</button>
            <div>
              <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
              <button type="submit" class="btn btn-primary">ä¿å­˜</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- JavaScriptã¯æ—¢å­˜ã®ã‚‚ã®ã‚’ãã®ã¾ã¾ä½¿ç”¨ -->
<script>
(function() {
  'use strict';
  
  console.log("ğŸš€ Calendar page script loaded");
  
  let pageCalendar = null;
  
  function createCalendar() {
    console.log("ğŸ“… Creating calendar function called");
    
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
      console.log("âŒ Calendar element not found");
      return;
    }
    
    if (typeof FullCalendar === 'undefined') {
      console.log("âŒ FullCalendar not available, retrying in 1000ms");
      setTimeout(createCalendar, 1000);
      return;
    }
    
    // æ—¢å­˜ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç ´æ£„
    if (pageCalendar) {
      try {
        pageCalendar.destroy();
      } catch (error) {
        console.warn("Error destroying calendar:", error);
      }
      pageCalendar = null;
    }
    
    console.log("âœ… Creating FullCalendar instance");
    
    try {
      calendarEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–ä¸­...</div>';
      
      pageCalendar = new FullCalendar.Calendar(calendarEl, {
        initialView: window.innerWidth < 768 ? "timeGridDay" : "timeGridWeek",
        locale: 'ja',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'timeGridWeek,timeGridDay'
        },
        slotMinTime: "10:00:00",
        slotMaxTime: "20:30:00",
        slotDuration: "00:10:00",
        scrollTime: "10:00:00",
        height: "auto",
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–
        editable: true,
        droppable: true,
        eventStartEditable: true,
        eventDurationEditable: true,
        
        // ã‚¹ãƒŠãƒƒãƒ—è¨­å®šï¼ˆ10åˆ†åˆ»ã¿ï¼‰
        snapDuration: '00:10:00',
        
        events: {
          url: "/admin/reservations.json",
          failure: function() {
            console.error("Failed to fetch events from /admin/reservations.json");
          }
        },
        
        dateClick: function(info) {
          console.log('ğŸ“… Date clicked:', info.dateStr);
          openReservationModal(null, info.dateStr);
        },
        
        eventClick: function(info) {
          console.log('ğŸ“… Event clicked:', info.event.title);
          openReservationModal(info.event);
        },
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚
        eventDragStart: function(info) {
          console.log('ğŸ–±ï¸ Drag started:', info.event.title);
          // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
          info.el.style.opacity = '0.7';
        },
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ï¼ˆä½ç½®å¤‰æ›´ï¼‰
        eventDrop: function(info) {
          console.log('ğŸ“¦ Event dropped:', info.event.title);
          console.log('ğŸ• New start:', info.event.start);
          console.log('ğŸ• New end:', info.event.end);
          
          // é€æ˜åº¦ã‚’å…ƒã«æˆ»ã™
          info.el.style.opacity = '1';
          
          // ã‚µãƒ¼ãƒãƒ¼ã«å¤‰æ›´ã‚’é€ä¿¡
          updateReservationTime(info.event, info.revert);
        },
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚µã‚¤ã‚ºçµ‚äº†æ™‚ï¼ˆæ™‚é–“å¤‰æ›´ï¼‰
        eventResize: function(info) {
          console.log('ğŸ“ Event resized:', info.event.title);
          console.log('ğŸ• New start:', info.event.start);
          console.log('ğŸ• New end:', info.event.end);
          
          // ã‚µãƒ¼ãƒãƒ¼ã«å¤‰æ›´ã‚’é€ä¿¡
          updateReservationTime(info.event, info.revert);
        },
        
        loading: function(isLoading) {
          if (isLoading) {
            console.log("ğŸ“¡ Loading events...");
          } else {
            console.log("âœ… Events loaded");
          }
        }
      });
      
      pageCalendar.render();
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
      window.pageCalendar = pageCalendar;
      
      console.log("âœ… Calendar rendered successfully");
      
      // æˆåŠŸç¢ºèª
      setTimeout(() => {
        if (calendarEl.querySelector('.fc-toolbar')) {
          console.log("ğŸ‰ Calendar confirmed working!");
        } else {
          console.error("âŒ Calendar render failed");
        }
      }, 500);
      
    } catch (error) {
      console.error("âŒ Calendar creation error:", error);
      calendarEl.innerHTML = '<div style="padding: 20px; color: red; background: #ffe6e6;">ã‚¨ãƒ©ãƒ¼: ' + error.message + '</div>';
    }
  }

    // äºˆç´„æ™‚é–“ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateReservationTime(event, revertFunc) {
    const reservationId = event.id;
    const newStartTime = event.start.toISOString();
    const newEndTime = event.end ? event.end.toISOString() : null;
    
    console.log('ğŸ”„ Updating reservation:', {
      id: reservationId,
      start: newStartTime,
      end: newEndTime
    });
    
    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    if (!confirm(`äºˆç´„ã€Œ${event.title}ã€ã®æ™‚é–“ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ\næ–°ã—ã„æ™‚é–“: ${event.start.toLocaleString('ja-JP')}`)) {
      revertFunc();
      return;
    }
    
    // ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    fetch(`/admin/reservations/${reservationId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || '',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        reservation: {
          start_time: newStartTime,
          end_time: newEndTime
        }
      })
    })
    .then(response => {
      console.log('ğŸŒ Server response:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      return response.json();
    })
    .then(data => {
      console.log('âœ… Update successful:', data);
      
      if (data.success !== false) {
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        showSuccessMessage(`äºˆç´„ã€Œ${event.title}ã€ã®æ™‚é–“ã‚’å¤‰æ›´ã—ã¾ã—ãŸ`);
      } else {
        console.error('âŒ Server reported failure:', data);
        revertFunc();
        showErrorMessage(data.errors ? data.errors.join(', ') : 'æ™‚é–“ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    })
    .catch(error => {
      console.error('âŒ Update failed:', error);
      revertFunc();
      showErrorMessage(`æ™‚é–“ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
    });
  }

  // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
  function showSuccessMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // 5ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 5000);
  }

  // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
  function showErrorMessage(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // 8ç§’å¾Œã«è‡ªå‹•å‰Šé™¤
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 8000);
  }
  
  function openReservationModal(event = null, dateStr = null) {
    const modal = document.getElementById('reservationModal');
    const form = document.getElementById('reservationForm');
    
    if (!modal || !form) {
      console.error('Modal or form not found');
      alert('ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    form.reset();
    
    // æ™‚é–“é¸æŠè‚¢ã‚’ç”Ÿæˆ
    generateTimeOptions();
    
    if (event) {
      // æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†
      const startDate = new Date(event.start);
      const dateStr = startDate.toISOString().split('T')[0]; // YYYY-MM-DDå½¢å¼
      const timeStr = startDate.toTimeString().substr(0, 5); // HH:MMå½¢å¼
      
      document.getElementById('reservationId').value = event.id || '';
      document.getElementById('reservationUserId').value = event.extendedProps?.user_id || '';
      document.getElementById('reservationName').value = event.title || '';
      document.getElementById('reservationCourse').value = event.extendedProps?.description || '60åˆ†';
      document.getElementById('reservationDate').value = dateStr;
      document.getElementById('reservationTime').value = timeStr;
      document.getElementById('reservationStartTime').value = event.start?.toISOString() || '';
      document.getElementById('deleteReservationBtn').classList.remove('d-none');
      
      console.log('Editing event:', { dateStr, timeStr, course: event.extendedProps?.description });
    } else {
      // æ–°è¦äºˆç´„
      const clickedDate = dateStr ? new Date(dateStr) : new Date();
      const formattedDate = clickedDate.toISOString().split('T')[0];
      const defaultTime = dateStr ? new Date(dateStr).toTimeString().substr(0, 5) : '10:00';
      
      document.getElementById('reservationId').value = '';
      document.getElementById('reservationUserId').value = '';
      document.getElementById('reservationName').value = '';
      document.getElementById('reservationCourse').value = '60åˆ†';
      document.getElementById('reservationDate').value = formattedDate;
      document.getElementById('reservationTime').value = defaultTime;
      document.getElementById('reservationStartTime').value = dateStr || '';
      document.getElementById('deleteReservationBtn').classList.add('d-none');
      
      console.log('New reservation:', { formattedDate, defaultTime });
    }
    
    // çµ‚äº†æ™‚é–“ã‚’æ›´æ–°
    updateEndTimeDisplay();
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    try {
      if (typeof bootstrap !== 'undefined') {
        new bootstrap.Modal(modal).show();
      } else {
        alert('Bootstrap not available. Form data: ' + JSON.stringify({
          dateStr: dateStr,
          eventTitle: event?.title
        }));
      }
    } catch (error) {
      console.error('Error showing modal:', error);
      alert('Modal error: ' + error.message);
    }
  }
  
  // æ™‚é–“é¸æŠè‚¢ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
  function generateTimeOptions() {
    const timeSelect = document.getElementById('reservationTime');
    if (!timeSelect) return;
    
    // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»¥å¤–ï¼‰
    while (timeSelect.children.length > 1) {
      timeSelect.removeChild(timeSelect.lastChild);
    }
    
    // 10:00ã‹ã‚‰20:00ã¾ã§10åˆ†åˆ»ã¿ã§ç”Ÿæˆ
    for (let hour = 10; hour <= 19; hour++) {
      for (let minute = 0; minute < 60; minute += 10) {
        const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        const option = document.createElement('option');
        option.value = timeStr;
        option.textContent = timeStr;
        timeSelect.appendChild(option);
      }
    }
    
    // 20:00ã‚‚è¿½åŠ 
    const option = document.createElement('option');
    option.value = '20:00';
    option.textContent = '20:00';
    timeSelect.appendChild(option);
  }
  
  // çµ‚äº†æ™‚é–“è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateEndTimeDisplay() {
    const timeSelect = document.getElementById('reservationTime');
    const courseSelect = document.getElementById('reservationCourse');
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    
    if (!timeSelect || !courseSelect || !endTimeDisplay) return;
    
    const selectedTime = timeSelect.value;
    const selectedCourse = courseSelect.value;
    
    if (!selectedTime || !selectedCourse) {
      endTimeDisplay.textContent = 'æ™‚é–“ã¨ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„';
      return;
    }
    
    // é–‹å§‹æ™‚é–“ã‚’ãƒ‘ãƒ¼ã‚¹
    const [hours, minutes] = selectedTime.split(':').map(Number);
    const startDate = new Date();
    startDate.setHours(hours, minutes, 0, 0);
    
    // ã‚³ãƒ¼ã‚¹ã«å¿œã˜ãŸçµ‚äº†æ™‚é–“ã‚’è¨ˆç®—
    let duration = 60;
    if (selectedCourse === '40åˆ†') duration = 40;
    else if (selectedCourse === '80åˆ†') duration = 80;
    
    const endDate = new Date(startDate.getTime() + duration * 60000);
    const endTimeStr = endDate.toTimeString().substr(0, 5);
    
    endTimeDisplay.textContent = `${endTimeStr} (${selectedCourse}ã‚³ãƒ¼ã‚¹)`;
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆåˆæœŸåŒ–é–¢æ•°
  function initializeUserList() {
    console.log("ğŸ”§ Initializing user list");
    
    const select = document.getElementById('reservationUserId');
    if (!select) {
      console.error('User select element not found');
      return;
    }
    
    console.log("ğŸ“¡ Fetching users from API");
    
    fetch('/admin/users.json')
      .then(response => {
        console.log("Users API response:", response.status);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        console.log("âœ… Users data received:", data.length, "users");
        
        // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»¥å¤–ï¼‰
        while (select.children.length > 1) {
          select.removeChild(select.lastChild);
        }
        
        if (data.length === 0) {
          console.warn("No users found in API response");
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
          select.appendChild(option);
          return;
        }
        
        data.forEach((user, index) => {
          const option = document.createElement('option');
          option.value = user.id;
          option.textContent = user.name || `ãƒ¦ãƒ¼ã‚¶ãƒ¼${user.id}`;
          option.setAttribute('data-name', user.name || `ãƒ¦ãƒ¼ã‚¶ãƒ¼${user.id}`);
          select.appendChild(option);
          
          if (index < 3) {
            console.log(`Added user: ${user.id} - ${user.name || 'No name'}`);
          }
        });
        
        console.log("âœ… User options added successfully");
        console.log("Total options:", select.options.length);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠæ™‚ã«åå‰ã‚’è‡ªå‹•è¨­å®š
        select.addEventListener('change', function() {
          const selectedOption = this.options[this.selectedIndex];
          const nameField = document.getElementById('reservationName');
          if (nameField && selectedOption.value) {
            nameField.value = selectedOption.getAttribute('data-name');
            console.log("Name field updated:", selectedOption.getAttribute('data-name'));
          } else if (nameField) {
            nameField.value = '';
          }
        });
        
        // èª­ã¿è¾¼ã¿æ¸ˆã¿ãƒãƒ¼ã‚¯ã‚’è¨­å®š
        select.setAttribute('data-loaded', 'true');
        
      })
      .catch(error => {
        console.error('âŒ Error loading users:', error);
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const option = document.createElement('option');
        option.value = '';
        option.textContent = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼';
        select.appendChild(option);
      });
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆåˆæœŸåŒ–
  function initializeModalEvents() {
    console.log("ğŸ”§ Initializing modal events");
    
    const modalEl = document.getElementById('reservationModal');
    if (!modalEl) {
      console.error('Reservation modal not found');
      return;
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºãƒ»éè¡¨ç¤ºã‚¤ãƒ™ãƒ³ãƒˆ
    modalEl.addEventListener('hidden.bs.modal', function () {
      const calendarEl = document.getElementById('calendar');
      if (calendarEl) {
        calendarEl.focus();
      }
    });

    modalEl.addEventListener('show.bs.modal', function () {
      setTimeout(() => {
        const firstInput = modalEl.querySelector('select, input[type="text"]:not([type="hidden"])');
        if (firstInput) {
          firstInput.focus();
        }
      }, 150);
    });
    
    // æ™‚é–“ãƒ»ã‚³ãƒ¼ã‚¹å¤‰æ›´æ™‚ã®çµ‚äº†æ™‚é–“è¡¨ç¤ºæ›´æ–°
    const timeSelect = document.getElementById('reservationTime');
    const courseSelect = document.getElementById('reservationCourse');
    const dateInput = document.getElementById('reservationDate');
    
    if (timeSelect) {
      timeSelect.addEventListener('change', function() {
        updateEndTimeDisplay();
        updateHiddenStartTime();
      });
    }
    
    if (courseSelect) {
      courseSelect.addEventListener('change', function() {
        updateEndTimeDisplay();
      });
    }
    
    if (dateInput) {
      dateInput.addEventListener('change', function() {
        updateHiddenStartTime();
      });
    }
    
    console.log("âœ… Modal events initialized");
  }
  
  // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®é–‹å§‹æ™‚é–“ã‚’æ›´æ–°
  function updateHiddenStartTime() {
    const dateInput = document.getElementById('reservationDate');
    const timeSelect = document.getElementById('reservationTime');
    const hiddenStartTime = document.getElementById('reservationStartTime');
    
    if (!dateInput || !timeSelect || !hiddenStartTime) return;
    
    const selectedDate = dateInput.value;
    const selectedTime = timeSelect.value;
    
    if (selectedDate && selectedTime) {
      const dateTimeStr = `${selectedDate}T${selectedTime}:00`;
      const dateTime = new Date(dateTimeStr);
      hiddenStartTime.value = dateTime.toISOString();
      
      console.log('Hidden start time updated:', hiddenStartTime.value);
    }
  }
  
  // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–æ™‚ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’åˆæœŸåŒ–
  function initializePageFeatures() {
    console.log("ğŸš€ Initializing page features");
    
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
      console.log("Not a calendar page, skipping user list initialization");
      return;
    }
    
    const userSelect = document.getElementById('reservationUserId');
    if (userSelect && !userSelect.hasAttribute('data-loaded')) {
      initializeUserList();
      initializeModalEvents();
      initializeUserToggle(); // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆã‚°ãƒ«æ©Ÿèƒ½ã‚’è¿½åŠ 
      initializeFormSubmission(); // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ©Ÿèƒ½ã‚’è¿½åŠ 
      initializeDeleteButton(); // å‰Šé™¤ãƒœã‚¿ãƒ³æ©Ÿèƒ½ã‚’è¿½åŠ 
    } else if (userSelect) {
      console.log("User list already loaded");
    } else {
      console.error("User select element not found");
    }
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ©Ÿèƒ½
  function initializeFormSubmission() {
    console.log("ğŸ”§ Initializing form submission");
    
    const form = document.getElementById('reservationForm');
    if (!form) {
      console.error('Reservation form not found');
      return;
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      console.log('ğŸ“ Form submitted');

      const id = document.getElementById('reservationId')?.value || '';
      const userId = document.getElementById('reservationUserId')?.value || '';
      const name = document.getElementById('reservationName')?.value || '';
      const course = document.getElementById('reservationCourse')?.value || '60åˆ†';
      const date = document.getElementById('reservationDate')?.value || '';
      const time = document.getElementById('reservationTime')?.value || '';

      console.log('Form data:', { id, userId, name, course, date, time });

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!userId) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (!name.trim()) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      if (!date) {
        alert('äºˆç´„æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      if (!time) {
        alert('é–‹å§‹æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      // é–‹å§‹æ™‚é–“ã¨çµ‚äº†æ™‚é–“ã‚’è¨ˆç®—
      const startTime = new Date(`${date}T${time}:00`).toISOString();
      
      let duration = 60;
      if (course === '40åˆ†') duration = 40;
      else if (course === '80åˆ†') duration = 80;

      const endTime = new Date(new Date(startTime).getTime() + duration * 60000).toISOString();

      const url = id ? `/admin/reservations/${id}` : '/admin/reservations';
      const method = id ? 'PATCH' : 'POST';

      if (method === 'PATCH' && !id.match(/^\d+$/)) {
        alert("äºˆç´„IDãŒä¸æ­£ã§ã™ã€‚");
        return;
      }

      console.log(`${method} request to ${url}`);
      console.log('Request data:', {
        name: name,
        start_time: startTime,
        end_time: endTime,
        course: course,
        user_id: userId
      });

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å…ˆã«é–‰ã˜ã‚‹
      const modalEl = document.getElementById('reservationModal');
      if (modalEl) {
        document.body.focus();
        const modalInstance = bootstrap.Modal.getInstance(modalEl);
        if (modalInstance) {
          modalInstance.hide();
        }
      }

      // éåŒæœŸã§ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
        },
        body: JSON.stringify({
          reservation: {
            name: name,
            start_time: startTime,
            end_time: endTime,
            course: course,
            user_id: userId
          }
        })
      })
      .then(response => {
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        return response.json().then(data => ({
          ok: response.ok,
          status: response.status,
          data: data
        }));
      })
      .then(result => {
        if (result.ok && result.data.success !== false) {
          console.log('âœ… Success:', result.data);
          alert('äºˆç´„ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
          
          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°
          if (window.pageCalendar) {
            window.pageCalendar.refetchEvents();
          }
        } else {
          console.error('âŒ Save failed:', result.data);
          const errorMessage = result.data.errors ? result.data.errors.join(', ') : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
          alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + errorMessage);
        }
      })
      .catch(error => {
        console.error('âŒ Network error:', error);
        alert("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
      });
    });
    
    console.log("âœ… Form submission initialized");
  }

  // å‰Šé™¤ãƒœã‚¿ãƒ³æ©Ÿèƒ½
  function initializeDeleteButton() {
    console.log("ğŸ”§ Initializing delete button");
    
    const deleteBtn = document.getElementById('deleteReservationBtn');
    if (!deleteBtn) {
      console.error('Delete button not found');
      return;
    }
    
    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
    deleteBtn.replaceWith(deleteBtn.cloneNode(true));
    
    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    const newDeleteBtn = document.getElementById('deleteReservationBtn');
    if (newDeleteBtn) {
      newDeleteBtn.addEventListener('click', function (e) {
        if (this.disabled) return;
        this.disabled = true;
        
        const idField = document.getElementById('reservationId');
        const id = idField ? idField.value : '';
        console.log('Delete button clicked, ID:', id);
        
        if (!id || !id.toString().match(/^\d+$/)) {
          console.error("Invalid reservation ID:", id);
          alert("ä¸æ­£ãªäºˆç´„IDã§ã™ã€‚");
          this.disabled = false;
          return;
        }

        if (confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å…ˆã«é–‰ã˜ã‚‹
          const deleteModalEl = document.getElementById('reservationModal');
          if (deleteModalEl) {
            document.body.focus();
            const deleteModalInstance = bootstrap.Modal.getInstance(deleteModalEl);
            if (deleteModalInstance) {
              deleteModalInstance.hide();
            }
          }
          
          const deleteUrl = `${window.location.origin}/admin/reservations/${id}`;
          console.log('Delete URL:', deleteUrl);
          
          fetch(deleteUrl, {
            method: 'DELETE',
            headers: {
              'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || '',
              'Accept': 'application/json',
              'Content-Type': 'application/json'
            }
          })
          .then(response => {
            console.log('Delete response:', response.status, response.url);
            
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            
            console.log('âœ… Delete confirmed by server');
            alert('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸï¼');
            
            // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°
            if (window.pageCalendar) {
              window.pageCalendar.refetchEvents();
            }
          })
          .catch(error => {
            console.error("âŒ å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼:", error);
            alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
          })
          .finally(() => {
            this.disabled = false;
          });
        } else {
          this.disabled = false;
        }
      });
    }
    
    console.log("âœ… Delete button initialized");
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
  window.openReservationModal = openReservationModal;
  window.createCalendar = createCalendar;
  window.initializeUserList = initializeUserList;
  window.initializePageFeatures = initializePageFeatures;
  
  // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ/æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã®åˆ‡ã‚Šæ›¿ãˆ
  function initializeUserToggle() {
    const toggle = document.getElementById('newUserToggle');
    const existingSection = document.getElementById('existingUserSection');
    const newSection = document.getElementById('newUserSection');
    const userIdSelect = document.getElementById('reservationUserId');
    
    if (!toggle || !existingSection || !newSection) return;
    
    toggle.addEventListener('change', function() {
      if (this.checked) {
        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ¢ãƒ¼ãƒ‰
        existingSection.style.display = 'none';
        newSection.style.display = 'block';
        userIdSelect.removeAttribute('required');
        document.getElementById('newUserName').setAttribute('required', 'required');
      } else {
        // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒ¢ãƒ¼ãƒ‰
        existingSection.style.display = 'block';
        newSection.style.display = 'none';
        userIdSelect.setAttribute('required', 'required');
        document.getElementById('newUserName').removeAttribute('required');
        
        // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
        clearNewUserForm();
      }
    });
  }
  
  // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
  function clearNewUserForm() {
    const fields = ['newUserName', 'newUserPhone', 'newUserEmail', 'newUserBirthDate', 'newUserAddress', 'newUserMemo'];
    fields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) field.value = '';
    });
  }
  
  // ä¿®æ­£ç‰ˆ openReservationModal é–¢æ•°
  function openReservationModal(event = null, dateStr = null) {
    const modal = document.getElementById('reservationModal');
    const form = document.getElementById('reservationForm');
    
    if (!modal || !form) {
      console.error('Modal or form not found');
      alert('ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    form.reset();
    
    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆã‚°ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
    const toggle = document.getElementById('newUserToggle');
    if (toggle) {
      toggle.checked = false;
      toggle.dispatchEvent(new Event('change'));
    }
    
    // æ™‚é–“é¸æŠè‚¢ã‚’ç”Ÿæˆ
    generateTimeOptions();
    
    if (event) {
      // æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆã®ç·¨é›†
      const startDate = new Date(event.start);
      const dateStr = startDate.toISOString().split('T')[0];
      const timeStr = startDate.toTimeString().substr(0, 5);
      
      document.getElementById('reservationId').value = event.id || '';
      document.getElementById('reservationUserId').value = event.extendedProps?.user_id || '';
      document.getElementById('reservationName').value = event.title || '';
      document.getElementById('reservationCourse').value = event.extendedProps?.description || '60åˆ†';
      document.getElementById('reservationDate').value = dateStr;
      document.getElementById('reservationTime').value = timeStr;
      document.getElementById('reservationStartTime').value = event.start?.toISOString() || '';
      document.getElementById('deleteReservationBtn').classList.remove('d-none');
      
      console.log('Editing event:', { dateStr, timeStr, course: event.extendedProps?.description });
    } else {
      // æ–°è¦äºˆç´„
      const clickedDate = dateStr ? new Date(dateStr) : new Date();
      const formattedDate = clickedDate.toISOString().split('T')[0];
      const defaultTime = dateStr ? new Date(dateStr).toTimeString().substr(0, 5) : '10:00';
      
      document.getElementById('reservationId').value = '';
      document.getElementById('reservationUserId').value = '';
      document.getElementById('reservationName').value = '';
      document.getElementById('reservationCourse').value = '60åˆ†';
      document.getElementById('reservationDate').value = formattedDate;
      document.getElementById('reservationTime').value = defaultTime;
      document.getElementById('reservationStartTime').value = dateStr || '';
      document.getElementById('deleteReservationBtn').classList.add('d-none');
      
      console.log('New reservation:', { formattedDate, defaultTime });
    }
    
    // çµ‚äº†æ™‚é–“ã‚’æ›´æ–°
    updateEndTimeDisplay();
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    try {
      if (typeof bootstrap !== 'undefined') {
        new bootstrap.Modal(modal).show();
      } else {
        alert('Bootstrap not available');
      }
    } catch (error) {
      console.error('Error showing modal:', error);
      alert('Modal error: ' + error.message);
    }
  }
  
  // ä¿®æ­£ç‰ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ©Ÿèƒ½
  function initializeFormSubmission() {
    console.log("ğŸ”§ Initializing form submission");
    
    const form = document.getElementById('reservationForm');
    if (!form) {
      console.error('Reservation form not found');
      return;
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      console.log('ğŸ“ Form submitted');

      const toggle = document.getElementById('newUserToggle');
      const isNewUser = toggle && toggle.checked;
      
      if (isNewUser) {
        handleNewUserReservation();
      } else {
        handleExistingUserReservation();
      }
    });
    
    console.log("âœ… Form submission initialized");
  }
  
  // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®äºˆç´„å‡¦ç†
  function handleExistingUserReservation() {
    const id = document.getElementById('reservationId')?.value || '';
    const userId = document.getElementById('reservationUserId')?.value || '';
    const name = document.getElementById('reservationName')?.value || '';
    const course = document.getElementById('reservationCourse')?.value || '60åˆ†';
    const date = document.getElementById('reservationDate')?.value || '';
    const time = document.getElementById('reservationTime')?.value || '';
    const note = document.getElementById('reservationNote')?.value || '';

    console.log('Existing user form data:', { id, userId, name, course, date, time });

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!userId) {
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    if (!name.trim()) {
      alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒå–å¾—ã§ãã¾ã›ã‚“');
      return;
    }

    if (!date) {
      alert('äºˆç´„æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    if (!time) {
      alert('é–‹å§‹æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    // äºˆç´„ã‚’ä¿å­˜
    saveReservation(id, userId, name, course, date, time, note);
  }
  
  // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®äºˆç´„å‡¦ç†
  function handleNewUserReservation() {
    const newUserName = document.getElementById('newUserName')?.value || '';
    const newUserPhone = document.getElementById('newUserPhone')?.value || '';
    const newUserEmail = document.getElementById('newUserEmail')?.value || '';
    const newUserBirthDate = document.getElementById('newUserBirthDate')?.value || '';
    const newUserAddress = document.getElementById('newUserAddress')?.value || '';
    const newUserMemo = document.getElementById('newUserMemo')?.value || '';
    const course = document.getElementById('reservationCourse')?.value || '60åˆ†';
    const date = document.getElementById('reservationDate')?.value || '';
    const time = document.getElementById('reservationTime')?.value || '';
    const note = document.getElementById('reservationNote')?.value || '';

    console.log('New user form data:', { newUserName, course, date, time });

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!newUserName.trim()) {
      alert('æ°åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }

    if (!date) {
      alert('äºˆç´„æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    if (!time) {
      alert('é–‹å§‹æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
      return;
    }

    // ã¾ãšæ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
    createNewUserAndReservation({
      name: newUserName,
      phone_number: newUserPhone,
      email: newUserEmail,
      birth_date: newUserBirthDate,
      address: newUserAddress,
      admin_memo: newUserMemo
    }, course, date, time, note);
  }
  
  // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã¨äºˆç´„ã‚’åŒæ™‚ã«å‡¦ç†
  function createNewUserAndReservation(userData, course, date, time, note) {
    console.log('Creating new user and reservation...');

    // é–‹å§‹æ™‚é–“ã¨çµ‚äº†æ™‚é–“ã‚’è¨ˆç®—
    const startTime = new Date(`${date}T${time}:00`).toISOString();
    
    let duration = 60;
    if (course === '40åˆ†') duration = 40;
    else if (course === '80åˆ†') duration = 80;

    const endTime = new Date(new Date(startTime).getTime() + duration * 60000).toISOString();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å…ˆã«é–‰ã˜ã‚‹
    const modalEl = document.getElementById('reservationModal');
    if (modalEl) {
      const modalInstance = bootstrap.Modal.getInstance(modalEl);
      if (modalInstance) {
        modalInstance.hide();
      }
    }

    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆã¨äºˆç´„ã‚’åŒæ™‚ã«é€ä¿¡
    fetch('/admin/reservations', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
      },
      body: JSON.stringify({
        reservation: {
          name: userData.name,
          start_time: startTime,
          end_time: endTime,
          course: course,
          note: note
        },
        new_user: userData
      })
    })
    .then(response => {
      console.log('Response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      return response.json();
    })
    .then(data => {
      if (data.success !== false) {
        console.log('âœ… Success:', data);
        showSuccessMessage(`æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${userData.name}ã€ã‚’ä½œæˆã—ã€äºˆç´„ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼`);
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°
        if (window.pageCalendar) {
          window.pageCalendar.refetchEvents();
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚‚æ›´æ–°
        if (window.initializeUserList) {
          setTimeout(() => {
            const userSelect = document.getElementById('reservationUserId');
            if (userSelect) {
              userSelect.removeAttribute('data-loaded');
              window.initializeUserList();
            }
          }, 1000);
        }
      } else {
        console.error('âŒ Save failed:', data);
        const errorMessage = data.errors ? data.errors.join(', ') : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
        showErrorMessage('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + errorMessage);
      }
    })
    .catch(error => {
      console.error('âŒ Network error:', error);
      showErrorMessage("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
    });
  }
  
  // æ—¢å­˜ã®äºˆç´„ä¿å­˜å‡¦ç†
  function saveReservation(id, userId, name, course, date, time, note) {
    // é–‹å§‹æ™‚é–“ã¨çµ‚äº†æ™‚é–“ã‚’è¨ˆç®—
    const startTime = new Date(`${date}T${time}:00`).toISOString();
    
    let duration = 60;
    if (course === '40åˆ†') duration = 40;
    else if (course === '80åˆ†') duration = 80;

    const endTime = new Date(new Date(startTime).getTime() + duration * 60000).toISOString();

    const url = id ? `/admin/reservations/${id}` : '/admin/reservations';
    const method = id ? 'PATCH' : 'POST';

    if (method === 'PATCH' && !id.match(/^\d+$/)) {
      alert("äºˆç´„IDãŒä¸æ­£ã§ã™ã€‚");
      return;
    }

    console.log(`${method} request to ${url}`);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å…ˆã«é–‰ã˜ã‚‹
    const modalEl = document.getElementById('reservationModal');
    if (modalEl) {
      const modalInstance = bootstrap.Modal.getInstance(modalEl);
      if (modalInstance) {
        modalInstance.hide();
      }
    }

    // éåŒæœŸã§ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
      },
      body: JSON.stringify({
        reservation: {
          name: name,
          start_time: startTime,
          end_time: endTime,
          course: course,
          note: note,
          user_id: userId
        }
      })
    })
    .then(response => {
      console.log('Response status:', response.status);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      return response.json();
    })
    .then(data => {
      if (data.success !== false) {
        console.log('âœ… Success:', data);
        showSuccessMessage('äºˆç´„ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ›´æ–°
        if (window.pageCalendar) {
          window.pageCalendar.refetchEvents();
        }
      } else {
        console.error('âŒ Save failed:', data);
        const errorMessage = data.errors ? data.errors.join(', ') : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
        showErrorMessage('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + errorMessage);
      }
    })
    .catch(error => {
      console.error('âŒ Network error:', error);
      showErrorMessage("ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message);
    });
  }

  // è¤‡æ•°ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§åˆæœŸåŒ–ã‚’è©¦è¡Œ
  function initializeCalendar() {
    console.log("ğŸ¯ Initialize calendar called");
    setTimeout(createCalendar, 100);
    setTimeout(initializePageFeatures, 200); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆåˆæœŸåŒ–ã‚’è¿½åŠ 
  }
  
  // DOMContentLoaded
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCalendar);
  } else {
    initializeCalendar();
  }
  
  // Turbo events
  document.addEventListener('turbo:load', initializeCalendar);
  
  // Cleanup
  document.addEventListener('turbo:before-cache', function() {
    if (pageCalendar) {
      try {
        pageCalendar.destroy();
        pageCalendar = null;
        window.pageCalendar = null;
      } catch (error) {
        console.warn("Cleanup error:", error);
      }
    }
  });
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  setTimeout(function() {
    if (!pageCalendar && document.getElementById('calendar')) {
      console.log("â° Fallback initialization");
      createCalendar();
    }
  }, 3000);
  
  console.log("ğŸ“ Calendar script setup complete");
})();
</script>