<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="<%= form_authenticity_token %>">
    <title>‰∫àÁ¥ÑÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</title>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic Pro', '„Éí„É©„ÇÆ„ÉéËßí„Ç¥ Pro W3', Meiryo, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
        }

        .container {
  max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .header-controls {
  display: flex;
            gap: 12px;
  align-items: center;
}

        .week-nav {
  display: flex;
  align-items: center;
            gap: 16px;
        }

        .nav-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .nav-btn:hover {
            background: #0056b3;
        }

        .current-week {
  font-weight: 600;
            color: #333;
            min-width: 200px;
            text-align: center;
        }

        .settings-btn {
            background: #28a745;
  color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-btn:hover {
            background: #1e7e34;
            transform: translateY(-1px);
        }

        /* Mini Calendar */
        .mini-calendar-container {
            position: relative;
        }

        .mini-calendar-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
  cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .mini-calendar-btn:hover {
            background: #545b62;
        }

        .mini-calendar {
  position: absolute;
            top: 100%;
  right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 16px;
            z-index: 1000;
            min-width: 280px;
            display: none;
            animation: slideDown 0.2s ease;
        }

        .mini-calendar.show {
            display: block;
        }

        .mini-calendar-header {
  display: flex;
  align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .mini-calendar-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
  flex: 1;
            text-align: center;
        }

        .mini-calendar-nav {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .mini-calendar-nav-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 6px;
            color: #495057;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-calendar-nav-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .mini-calendar-year-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 6px;
            color: #495057;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
            min-width: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mini-calendar-year-btn:hover {
            background: #e9ecef;
            border-color: #adb5bd;
        }

        .mini-calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 8px;
        }

        .mini-calendar-weekday {
            text-align: center;
            font-size: 11px;
  font-weight: 600;
            color: #6c757d;
            padding: 4px 0;
        }

        .mini-calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }

        .mini-calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .mini-calendar-day:hover {
            background: #f8f9fa;
        }

        .mini-calendar-day.other-month {
            color: #adb5bd;
        }

        .mini-calendar-day.today {
            background: #007bff;
  color: white;
            font-weight: 600;
        }

        .mini-calendar-day.selected {
            background: #28a745;
  color: white;
            font-weight: 600;
        }

        .mini-calendar-day.clicked-day {
            background: #28a745;
            color: white;
            font-weight: 600;
            border: 2px solid #1e7e34;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .schedule-container {
            background: white;
    border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .schedule-header {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }

        .time-column-header {
            padding: 16px 8px;
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            border-right: 1px solid #dee2e6;
        }

        .day-header {
            padding: 16px 12px;
            text-align: center;
  font-weight: 600;
            color: #333;
            border-right: 1px solid #dee2e6;
        }

        .day-header.sunday {
            color: #dc3545;
            background: #ffeaea;
        }

        .day-header.saturday {
            color: #007bff;
            background: #e6f3ff;
        }

        .schedule-body {
            max-height: 600px;
            overflow-y: auto;
        }

        .schedule-row {
            display: grid;
            grid-template-columns: 80px repeat(7, 1fr);
        }

        .time-slot {
            padding: 4px;
            text-align: center;
            font-size: 12px;
            color: #6c757d;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #f0f0f0;
            background: #fafafa;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 20px;
            min-height: 20px;
        }

        .time-slot.hour-marker {
            font-weight: 700;
            color: #495057;
            background: #e9ecef;
            border-bottom: 2px solid #dee2e6;
        }

        .time-slot.half-hour-marker {
            font-weight: 600;
            color: #6c757d;
            background: #f8f9fa;
        }

        /* Ë°åÂÖ®‰Ωì„ÅÆ„Çπ„Çø„Ç§„É´ */
        .schedule-row.hour-row {
            background: #e9ecef;
        }

        .schedule-row.half-hour-row {
            background: #f8f9fa;
        }

        .schedule-row.hour-row .schedule-cell {
            border-top: 2px solid #adb5bd;
        }

        .schedule-row.half-hour-row .schedule-cell {
            border-top: 1px solid #adb5bd;
        }

        .schedule-cell {
            padding: 2px;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #f0f0f0;
            height: 20px;
            min-height: 20px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .schedule-cell:hover {
            background: #f8f9fa;
        }

        .schedule-cell.available {
            background: #ffffff;
            border-color: #e9ecef;
        }

        .schedule-cell.unavailable {
            background: #e9ecef;
            border-color: #ced4da;
        }

        .schedule-cell.outside-business-hours {
            background: #6c757d;
            border-color: #495057;
            opacity: 0.8;
            cursor: not-allowed;
        }

        .schedule-cell.drag-over-invalid {
            background: rgba(220, 53, 69, 0.2) !important;
            border: 2px dashed #dc3545 !important;
            position: relative;
            margin: 0 !important;
        }



                .reservation-block {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            margin: 2px 0;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.2);
        }

        .reservation-block.spanning {
            position: absolute;
            left: 2px;
            right: 2px;
            z-index: 20;
            border-radius: 8px;
            margin: 0;
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }



        .reservation-block:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .reservation-block.spanning:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .reservation-block.tentative {
            background: linear-gradient(135deg, #ff9500 0%, #ff6b35 100%);
        }

        .reservation-block.confirmed {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .reservation-block.completed {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
        }

        .available-slot {
            background: #e8f5e8;
            color: #155724;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            text-align: center;
            margin: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .available-slot:hover {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
  left: 0;
            top: 0;
    width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: white;
            margin: 2% auto;
            border-radius: 20px;
            width: 95%;
            max-width: 1000px;
            max-height: 96vh;
            overflow-y: auto;
            overflow-x: hidden;
            animation: slideIn 0.3s ease;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }



        .close {
            color: #666;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 10;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 32px;
            position: relative;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }

        .settings-tabs {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 24px;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .day-setting {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .day-setting-header {
            background: #f8f9fa;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
        }

        .day-setting-header.sunday {
            color: #dc3545;
            background: #ffeaea;
        }

        .day-setting-header.saturday {
            color: #007bff;
            background: #e6f3ff;
        }

        .day-toggle {
            position: relative;
            width: 50px;
            height: 24px;
            background: #ccc;
    border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .day-toggle.active {
            background: #28a745;
        }

        .day-toggle::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .day-toggle.active::before {
            transform: translateX(26px);
        }

        .time-slots-container {
            padding: 16px;
            background: white;
        }

        .time-slot-input {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .time-input {
            padding: 6px 10px;
            border: 1px solid #dee2e6;
  border-radius: 4px;
            font-size: 14px;
}

        .btn {
            padding: 8px 16px;
            border: none;
  border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-primary {
            background: #007bff;
  color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
  color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-danger {
            background: #dc3545;
  color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
  color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .add-time-btn {
            width: 100%;
            margin-top: 8px;
            border: 2px dashed #dee2e6;
            background: white;
            color: #6c757d;
            padding: 12px;
  border-radius: 6px;
  cursor: pointer;
            transition: all 0.2s;
        }

        .add-time-btn:hover {
            border-color: #28a745;
            color: #28a745;
            background: #f8fff8;
        }

        .modal-footer {
              padding: 24px 32px;
              background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
              border-top: 1px solid #e9ecef;
            display: flex;
              gap: 8px;
            justify-content: flex-end;
              padding-right: 48px;
              margin: 0 -32px -32px -32px;
              border-radius: 0 0 20px 20px;
        }

        /* „Éú„Çø„É≥„Çπ„Çø„Ç§„É´ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* ÈáçË§áË≠¶Âëä„Å®Âà©Áî®ÂèØËÉΩ„Çπ„É≠„ÉÉ„Éà„ÅÆ„Çπ„Çø„Ç§„É´ */
        .overlap-warning {
            background-color: #ffebee !important;
            border-color: #f44336 !important;
            color: #d32f2f !important;
            opacity: 0.7;
        }

        .overlap-warning:hover {
            background-color: #ffcdd2 !important;
            cursor: not-allowed;
        }

        .available-slot {
            background-color: #e8f5e8 !important;
            border-color: #4caf50 !important;
            color: #2e7d32 !important;
        }

        .available-slot:hover {
            background-color: #c8e6c9 !important;
            cursor: pointer;
        }

        /* „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„Éó„ÅÆ„Çπ„Çø„Ç§„É´ */
        .reservation-block.dragging {
            opacity: 0.7;
            transform: rotate(2deg);
            z-index: 1000;
            cursor: grabbing;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .schedule-cell.drag-over {
            background: rgba(76, 175, 80, 0.3) !important;
            border-left: 3px dashed #4caf50 !important;
            border-right: 3px dashed #4caf50 !important;
            position: relative;
            margin: 0 !important;
        }

        /* First cell - add top border */
        .schedule-cell.drag-over:first-child {
            border-top: 3px dashed #4caf50 !important;
        }

        /* Last cell - add bottom border */
        .schedule-cell.drag-over:last-child {
            border-bottom: 3px dashed #4caf50 !important;
        }

        /* Remove internal borders between consecutive cells */
        .schedule-cell.drag-over + .schedule-cell.drag-over {
            border-top: none !important;
        }

        .reservation-block {
            cursor: grab;
            transition: all 0.2s ease;
            user-select: none; /* Prevent text selection during drag */
        }

        .reservation-block:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .reservation-block:active {
            cursor: grabbing;
        }

        /* „Éâ„É©„ÉÉ„Ç∞„Éí„É≥„Éà */
        .drag-hint {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .drag-hint.show {
            opacity: 1;
        }

        /* „Ç§„É≥„Çø„Éº„Éê„É´Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„Çø„Ç§„É´ */
        .interval-settings {
            padding: 20px 0;
        }

        .interval-info {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .interval-info p {
            margin: 5px 0;
        }

        .interval-info small {
            color: #6c757d;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        /* „Éï„Ç©„Éº„É†„Çπ„Çø„Ç§„É´ */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            font-size: 1rem;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            font-size: 1rem;
            background-color: #fff;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        .form-select:focus {
            border-color: #86b7fe;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        /* „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫ */
        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideInRight 0.3s ease;
        }

        .message.success {
            background: #28a745;
        }

        .message.error {
            background: #dc3545;
        }

        .message.info {
            background: #17a2b8;
        }

        @keyframes slideInRight {
  from {
                transform: translateX(100%);
    opacity: 0;
  }
  to {
                transform: translateX(0);
    opacity: 1;
            }
        }

        /* ‰∫àÁ¥Ñ„Éñ„É≠„ÉÉ„ÇØ„ÅÆ„ÇØ„É™„ÉÉ„ÇØÂèØËÉΩ„Çπ„Çø„Ç§„É´ */
        .schedule-cell.bookable {
            cursor: pointer;
            transition: all 0.2s;
        }

        .schedule-cell.bookable:hover {
            background-color: #e3f2fd !important;
            transform: scale(1.02);
        }

        .schedule-cell.bookable:active {
            transform: scale(0.98);
        }

        /* ÂâäÈô§„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        .reservation-block.deleting {
            animation: fadeOutScale 0.3s ease-out forwards;
        }

                @keyframes fadeOutScale {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        /* „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢ÁµêÊûú„ÅÆ„Çπ„Çø„Ç§„É´ */
        .user-search-results {
  position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .user-search-item {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .user-search-item:hover {
            background-color: #f8f9fa;
        }

        .user-search-item:last-child {
            border-bottom: none;
        }

        .user-search-item .user-name {
  font-weight: bold;
            color: #333;
        }

        .user-search-item .user-details {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }

        .user-search-item .user-tickets {
            color: #28a745;
            font-weight: bold;
        }

        /* „Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„Ç®„É™„Ç¢„ÅÆ„Çπ„Çø„Ç§„É´ */
        .cancellation-display {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            margin: 20px 0;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cancellation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ffeaa7;
        }

        .cancellation-header h3 {
            margin: 0;
            color: #856404;
            font-size: 18px;
        }

        .clear-btn {
            background: #dc3545;
  color: white;
            border: none;
            padding: 6px 12px;
  border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .clear-btn:hover {
            background: #c82333;
        }

        .cancellation-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .cancellation-item {
            background: white;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .cancellation-item:last-child {
            margin-bottom: 0;
        }

        .cancellation-info {
            flex: 1;
        }

        .cancellation-customer {
            font-weight: bold;
            color: #856404;
            margin-bottom: 4px;
        }

        .cancellation-details {
            font-size: 14px;
            color: #666;
        }

        .cancellation-time {
            color: #dc3545;
  font-weight: bold;
}

        /* ‰∫àÁ¥ÑË©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„Çø„Ç§„É´ */
        .reservation-detail-container {
            max-width: 100%;
            font-family: 'Hiragino Kaku Gothic Pro', '„Éí„É©„ÇÆ„ÉéËßí„Ç¥ Pro W3', Meiryo, sans-serif;
            background: #ffffff;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .reservation-header {
            padding: 32px 32px 24px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px 20px 0 0;
            color: white;
            margin: -32px -32px 32px -32px;
            position: relative;
            overflow: hidden;
        }

        .reservation-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/><circle cx="10" cy="60" r="0.5" fill="white" opacity="0.1"/><circle cx="90" cy="40" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .header-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .customer-name-header {
            display: flex;
            align-items: center;
            pointer-events: auto;
        }

        .customer-name-large {
            font-size: 24px;
            font-weight: 700;
  color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .customer-name-large .customer-link {
            color: #fff !important;
            text-decoration: none !important;
            transition: all 0.2s;
            border-bottom: 1px solid transparent;
            cursor: pointer !important;
            font-weight: 700;
            pointer-events: auto !important;
            position: relative;
            z-index: 10;
        }

        .customer-name-large .customer-link:hover {
            color: #fff !important;
            text-decoration: none !important;
            border-bottom: 1px solid #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header-detail-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
        }

        .header-label {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.8);
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        .header-value {
            font-size: 15px;
            font-weight: 600;
        }

        /* Á∑®ÈõÜ„Éï„Ç©„Éº„É†„ÅÆ„Çπ„Çø„Ç§„É´ */
        .customer-name-input {
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            width: 100%;
            pointer-events: auto;
            z-index: 10;
            position: relative;
        }

        .customer-name-input:focus {
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
            outline: none;
        }

        .customer-name-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .status-select {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.1);
            font-weight: bold;
            color: white;
            width: 100%;
            pointer-events: auto;
            z-index: 10;
            position: relative;
        }

        .status-select:focus {
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
            outline: none;
        }

        .status-select option {
            background-color: #333;
            color: white;
        }

        .course-select {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            width: 100%;
            pointer-events: auto;
            z-index: 10;
            position: relative;
        }

        .course-select:focus {
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
            outline: none;
        }

        .course-select option {
            background-color: #333;
            color: white;
        }

        .interval-select {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 8px 12px;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            width: 100%;
            pointer-events: auto;
            z-index: 10;
            position: relative;
        }

        .interval-select:focus {
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
            outline: none;
        }

        .interval-select option {
            background-color: #333;
            color: white;
        }

        /* Remove dropdown arrows from select elements */
        .course-select,
        .status-select,
        .interval-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: none !important;
        }

        .course-select::-ms-expand,
        .status-select::-ms-expand,
        .interval-select::-ms-expand {
            display: none;
        }

        /* „É°„É¢„ÉÜ„Ç≠„Çπ„Éà„Ç®„É™„Ç¢„ÅÆ„Çπ„Çø„Ç§„É´ */
        #edit-note {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
            background-color: #ffffff;
            color: #333;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        #edit-note:focus {
            border-color: #6c757d;
            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
            outline: none;
        }

        #edit-note::placeholder {
            color: #6c757d;
        }

        /* „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„ÅÆ„Çπ„Çø„Ç§„É´ */
        .user-selection {
            margin-bottom: 15px;
        }

        .user-selection .form-label {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            display: block;
        }

        .user-select {
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 8px 12px;
            background-color: #ffffff;
            color: #333;
            width: 100%;
        }

        .user-select:focus {
            border-color: #0056b3;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }

        /* „É¶„Éº„Ç∂„ÉºÂ§âÊõ¥„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .change-user-btn {
            margin-left: 10px;
            font-size: 0.8rem;
            padding: 4px 8px;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .change-user-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.7);
        }

        .customer-name-header {
            display: flex;
            align-items: center;
        }

        /* „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢„ÅÆ„Çπ„Çø„Ç§„É´ */
        .user-search-results {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f8f9fa;
            position: relative;
            z-index: 1000;
            width: 100%;
            box-sizing: border-box;
            display: none; /* Hidden by default */
        }

        .user-search-item {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: background-color 0.2s ease;
            background-color: white;
            color: #333;
            display: block;
            width: 100%;
            box-sizing: border-box;
            min-height: 60px;
            line-height: 1.4;
        }

        .user-search-item:hover {
            background-color: #e9ecef;
        }

        .user-search-item:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-name {
            font-weight: bold;
            color: #333;
            font-size: 1rem;
            display: block;
            line-height: 1.2;
            margin-bottom: 4px;
        }

        .user-details {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
            color: #666;
            line-height: 1.2;
        }

        .user-phone, .user-email {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .selected-user {
            padding: 12px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            margin-top: 10px;
        }

        .selected-user .user-name {
            color: #155724;
        }

        .no-results {
            padding: 20px;
            text-align: center;
            color: #666;
            font-style: italic;
        }

        #userSearchInput {
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 1rem;
        }

        #userSearchInput:focus {
            border-color: #0056b3;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }
  color: white;
        }

        .reservation-status {
            display: flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-success {
            background: rgba(40, 167, 69, 0.2);
            border-color: rgba(40, 167, 69, 0.3);
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.3);
        }

        .status-danger {
            background: rgba(220, 53, 69, 0.2);
            border-color: rgba(220, 53, 69, 0.3);
        }

        .status-info {
            background: rgba(23, 162, 184, 0.2);
            border-color: rgba(23, 162, 184, 0.3);
        }

        .status-secondary {
            background: rgba(108, 117, 125, 0.2);
            border-color: rgba(108, 117, 125, 0.3);
        }

        .customer-basic-info {
            padding: 24px 32px;
            border-bottom: 1px solid #f1f3f4;
            background: #fafbfc;
            margin: -32px 0 0 0;
        }

        .customer-phone {
            font-size: 15px;
            color: #495057;
            font-weight: 500;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .customer-phone::before {
            content: "üìû";
            font-size: 14px;
        }

        .customer-email {
            font-size: 15px;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .customer-email::before {
            content: "‚úâÔ∏è";
            font-size: 14px;
        }

        .tickets-section {
            padding: 24px;
            border-bottom: 1px solid #f1f3f4;
        }

        .tickets-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            overflow-y: visible;
        }

        .ticket-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 12px 18px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 10px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
            margin-bottom: 8px;
        }

        .ticket-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-color: #dee2e6;
        }

        .ticket-checkbox {
            font-size: 18px;
            color: #6c757d;
            margin-top: 2px;
            min-width: 24px;
        }

        .ticket-info {
            flex: 1;
        }

        .ticket-name {
            font-size: 14px;
            font-weight: 600;
            color: #212529;
            margin-bottom: 3px;
        }

        .ticket-details {
            font-size: 13px;
            color: #6c757d;
        }

        .ticket-item.expired {
            background: #f8f9fa;
            opacity: 0.6;
        }

        .ticket-item.expired .ticket-name,
        .ticket-item.expired .ticket-details {
            color: #adb5bd;
        }

        .tickets-history-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 0;
            width: 100%;
            box-sizing: border-box;
            align-items: start;
        }

        .tickets-section {
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f3f4;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .reservation-history-section {
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid #f1f3f4;
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .history-content {
            margin-bottom: 0;
            flex: 1;
            overflow-y: visible;
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 4px 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 4px;
            border: 1px solid #e9ecef;
            margin-bottom: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
            gap: 8px;
        }

        .history-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-color: #dee2e6;
        }

        .history-icon {
            font-size: 11px;
            color: #28a745;
            background: #e8f5e8;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .history-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0px;
        }

        .history-ticket-name {
            font-size: 12px;
            font-weight: 600;
            color: #212529;
            line-height: 1.0;
        }

        .history-date-time {
            font-size: 10px;
            color: #6c757d;
            font-weight: 500;
        }

        .history-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .history-btn {
            background: #667eea;
            border: none;
            color: white;
            padding: 8px 16px;
  border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-btn:hover {
            background: #5a6fd8;
  transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: #6c757d;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px dashed #dee2e6;
        }



        .notes-section {
            padding: 24px;
            border-bottom: 1px solid #f1f3f4;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-title::before {
            content: "üìù";
            font-size: 18px;
        }

        .notes-content {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            font-size: 15px;
            color: #495057;
            line-height: 1.6;
            max-height: 8em; /* 5 lines (1.6 * 5) */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 5;
            -webkit-box-orient: vertical;
            white-space: pre-line;
        }

        .system-info-section {
            padding: 20px 24px;
            background: #f8f9fa;
            border-radius: 0 0 12px 12px;
        }

        .system-info-section .detail-item {
            padding: 6px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .system-info-section .detail-label {
            font-size: 14px;
            color: #6c757d;
  font-weight: 500;
        }

        .system-info-section .detail-value {
            font-size: 14px;
            color: #6c757d;
}

/* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
@media (max-width: 768px) {
            .customer-name-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .detail-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .detail-value {
                text-align: left;
            }

            .reservation-header {
                padding: 12px 16px;
            }

            .customer-basic-info,
            .reservation-details,
            .notes-section {
                padding: 16px;
            }

            .system-info-section {
                padding: 12px 16px;
            }

            .tickets-history-container {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .tickets-section,
            .reservation-history-section {
                padding: 16px;
            }
        }

        /* „Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
        .cancellation-btn {
            background: #ffc107;
            color: #212529;
            border: 2px solid #ffc107;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
  font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-left: 10px;
        }

        .cancellation-btn:hover {
            background: #e0a800;
            border-color: #e0a800;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .cancellation-btn.active {
            background: #dc3545;
          color: white;
            border-color: #dc3545;
        }

        .cancellation-btn:disabled {
            background: #6c757d;
            color: #fff;
            border-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

@media (max-width: 768px) {
            .container {
  padding: 10px;
  }
  
            .header {
    flex-direction: column;
                gap: 16px;
                padding: 16px;
            }

            .header-controls {
                width: 100%;
                justify-content: space-between;
            }

            .schedule-header {
                grid-template-columns: 60px repeat(7, 1fr);
            }

            .schedule-body {
                grid-template-columns: 60px repeat(7, 1fr);
            }

            .time-column-header,
            .time-slot {
                padding: 8px 4px;
                font-size: 10px;
            }

            .day-header {
                padding: 12px 4px;
                font-size: 12px;
            }

            .schedule-cell {
                height: 20px;
                min-height: 20px;
            }

            .reservation-block {
          font-size: 10px;
                padding: 2px 4px;
            }

            .modal-content {
                margin: 5% auto;
                width: 95%;
            }

            .settings-tabs {
                overflow-x: auto;
            }

            .tab-button {
  white-space: nowrap;
                min-width: 100px;
            }

            .time-slot-input {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìÖ ‰∫àÁ¥ÑÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
            <div class="header-controls">
                <div class="week-nav">
                    <button class="nav-btn" onclick="previousWeek()">‚Üê ÂâçÈÄ±</button>
                    <div class="current-week" id="currentWeek">2025Âπ¥ 8Êúà10Êó• - 8Êúà16Êó•</div>
                    <button class="nav-btn" onclick="nextWeek()">Ê¨°ÈÄ± ‚Üí</button>
                </div>
                <div class="mini-calendar-container">
                    <button class="mini-calendar-btn" onclick="toggleMiniCalendar()">
                        üìÖ ÈÄ±„ÇíÈÅ∏Êäû
                    </button>
                    <div class="mini-calendar" id="miniCalendar">
                        <div class="mini-calendar-header">
                            <button class="mini-calendar-year-btn" onclick="previousMiniCalendarYear()" title="ÂâçÂπ¥">‚Äπ‚Äπ</button>
                            <button class="mini-calendar-nav-btn" onclick="previousMiniCalendarMonth()" title="ÂâçÊúà">‚Äπ</button>
                            <div class="mini-calendar-title" id="miniCalendarTitle">2025Âπ¥ 8Êúà</div>
                            <button class="mini-calendar-nav-btn" onclick="nextMiniCalendarMonth()" title="ÁøåÊúà">‚Ä∫</button>
                            <button class="mini-calendar-year-btn" onclick="nextMiniCalendarYear()" title="ÁøåÂπ¥">‚Ä∫‚Ä∫</button>
                        </div>
                        <div class="mini-calendar-weekdays">
                            <div class="mini-calendar-weekday">Êó•</div>
                            <div class="mini-calendar-weekday">Êúà</div>
                            <div class="mini-calendar-weekday">ÁÅ´</div>
                            <div class="mini-calendar-weekday">Ê∞¥</div>
                            <div class="mini-calendar-weekday">Êú®</div>
                            <div class="mini-calendar-weekday">Èáë</div>
                            <div class="mini-calendar-weekday">Âúü</div>
                        </div>
                        <div class="mini-calendar-days" id="miniCalendarDays">
                            <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
                        </div>
                    </div>
                </div>
                <button id="showCancellationsBtn" onclick="toggleCancellationDisplay()" class="cancellation-btn">
                    ‚ùå „Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥ (<span id="cancellation-count">0</span>)
                </button>
                <button class="settings-btn" onclick="openSettingsModal()">
                    ‚öôÔ∏è ‰∫àÁ¥ÑÂèØËÉΩÊó•ÊôÇ„ÇíÁ∑®ÈõÜ
                </button>
            </div>
        </div>
        
        <div id="cancellation-display" class="cancellation-display" style="display: none;">
            <div class="cancellation-header">
                <h3>‚ùå „Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åü‰∫àÁ¥Ñ</h3>
                <button onclick="clearCancellationDisplay()" class="clear-btn">„ÇØ„É™„Ç¢</button>
            </div>
            <div id="cancellation-list" class="cancellation-list">
                <!-- „Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åü‰∫àÁ¥Ñ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
            </div>
        </div>

        <div class="schedule-container">
            <div class="schedule-header">
                <div class="time-column-header">ÊôÇÂàª</div>
                <div class="day-header sunday">Êó•<br><span style="font-size: 12px;">8/10</span></div>
                <div class="day-header">Êúà<br><span style="font-size: 12px;">8/11</span></div>
                <div class="day-header">ÁÅ´<br><span style="font-size: 12px;">8/12</span></div>
                <div class="day-header">Ê∞¥<br><span style="font-size: 12px;">8/13</span></div>
                <div class="day-header">Êú®<br><span style="font-size: 12px;">8/14</span></div>
                <div class="day-header">Èáë<br><span style="font-size: 12px;">8/15</span></div>
                <div class="day-header saturday">Âúü<br><span style="font-size: 12px;">8/16</span></div>
            </div>
            
            <div class="schedule-body" id="scheduleBody">
                <!-- ÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÅØÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
            </div>
        </div>
    </div>

    <!-- Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è ‰∫àÁ¥ÑÂèØËÉΩÊó•ÊôÇ„ÇíÁ∑®ÈõÜ</h2>
                <span class="close" onclick="closeSettingsModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="tab-button active" onclick="switchTab('general')">‰∏ÄÂõûÈôê„Çä„ÅÆÂ§âÊõ¥</button>
                    <button class="tab-button" onclick="switchTab('recurring')">ÂÆöÊúüÁöÑ„Å™„Çπ„Ç±„Ç∏„É•„Éº„É´</button>
                </div>

                <!-- ‰∏ÄÂõûÈôê„Çä„ÅÆÂ§âÊõ¥„Çø„Éñ -->
                <div id="general-tab" class="tab-content active">
                    <div id="week-info" style="margin-bottom: 20px; padding: 12px; background: #f8f9fa; border-radius: 6px; border-left: 4px solid #007bff;">
                        <strong>ÁèæÂú®„ÅÆÈÄ±:</strong> <span id="current-week-display"></span>
                        <br><small id="schedule-type-info" style="color: #666;"></small>
                    </div>
                    
                    <div id="daySettings">
                        <!-- ÊõúÊó•Âà•Ë®≠ÂÆö„ÅåÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
      </div>
    </div>

                <!-- ÂÆöÊúüÁöÑ„Å™„Çπ„Ç±„Ç∏„É•„Éº„É´„Çø„Éñ -->
                <div id="recurring-tab" class="tab-content">
                    <p style="margin-bottom: 20px; color: #666;">‰ªäÂæå„ÅÆÈÄ±„Å´ÈÅ©Áî®„Åô„Çã„Éá„Éï„Ç©„É´„Éà„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíË®≠ÂÆö</p>
                    
                    <div id="recurringDaySettings">
                        <!-- ÂÆöÊúüÁöÑ„Å™Ë®≠ÂÆö„ÅåÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
        </div>
        </div>
        </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettingsModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-success" onclick="saveSettings()">ÂÆå‰∫Ü</button>
          </div>
        </div>
        </div>

    <!-- ‰∫àÁ¥Ñ‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìÖ Êñ∞Ë¶è‰∫àÁ¥Ñ‰ΩúÊàê</h2>
                <span class="close" onclick="closeBookingModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="bookingForm">
                    <div class="form-group mb-3">
                        <label for="bookingDate" class="form-label">‰∫àÁ¥ÑÊó•ÊôÇ</label>
                        <input type="text" id="bookingDate" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="bookingTime" class="form-label">ÈñãÂßãÊôÇÈñì</label>
                        <input type="text" id="bookingTime" class="form-control" readonly>
      </div>
                    
                    <div class="form-group mb-3">
                        <label for="bookingDuration" class="form-label">„Ç≥„Éº„ÇπÈÅ∏Êäû</label>
                        <select id="bookingDuration" class="form-select" required>
                            <option value="">„Ç≥„Éº„Çπ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            <option value="40">40ÂàÜ„Ç≥„Éº„Çπ</option>
                            <option value="60">60ÂàÜ„Ç≥„Éº„Çπ</option>
                            <option value="80">80ÂàÜ„Ç≥„Éº„Çπ</option>
                        </select>
    </div>
                    
                    <div class="form-group mb-3">
                        <label for="customerName" class="form-label">„ÅäÂÆ¢ÊßòÂêç</label>
                        <div class="position-relative">
                            <input type="text" id="customerName" class="form-control" required placeholder="Â±±Áî∞Â§™ÈÉé" autocomplete="off">
                            <div id="userSearchResults" class="user-search-results" style="display: none;"></div>
                        </div>
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="customerPhone" class="form-label">ÈõªË©±Áï™Âè∑</label>
                        <input type="tel" id="customerPhone" class="form-control" required placeholder="090-1234-5678">
                    </div>
                    
                    <div class="form-group mb-3">
                        <label for="customerEmail" class="form-label">„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ</label>
                        <input type="email" id="customerEmail" class="form-control" placeholder="example@email.com">
        </div>
                    
                    <div class="form-group mb-3">
                        <label for="bookingNote" class="form-label">ÂÇôËÄÉ</label>
                        <textarea id="bookingNote" class="form-control" rows="3" placeholder="„ÅîË¶ÅÊúõ„ÇÑ„ÅîË≥™Âïè„Åå„ÅÇ„Çå„Å∞„ÅîË®òÂÖ•„Åè„Å†„Åï„ÅÑ"></textarea>
        </div>
                    
                    <div class="form-group mb-3">
                        <label for="bookingStatus" class="form-label">‰∫àÁ¥Ñ„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <select id="bookingStatus" class="form-select">
                            <option value="tentative">‰ªÆ‰∫àÁ¥Ñ</option>
                            <option value="confirmed">Á¢∫ÂÆö</option>
                        </select>
        </div>
                </form>
          </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeBookingModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="btn btn-success" onclick="createBooking()">‰∫àÁ¥Ñ‰ΩúÊàê</button>
        </div>
        </div>
      </div>

    <!-- ‰∫àÁ¥ÑË©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
    <div id="reservationDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-body" id="reservationDetailContent">
                <span class="close" onclick="closeReservationDetailModal()">&times;</span>
                <!-- ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
            </div>
            <div class="modal-footer">
                                 <button type="submit" class="btn btn-primary" form="reservationEditForm" onclick="console.log('üíæ Save button clicked')">‰øùÂ≠ò</button>
                 <button type="button" class="btn btn-warning" onclick="cancelReservation()">„Ç≠„É£„É≥„Çª„É´</button>
                 <button type="button" class="btn btn-danger" onclick="deleteReservation()">ÂâäÈô§</button>
                 <button type="button" class="btn btn-secondary" onclick="closeReservationDetailModal()">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>



    <!-- „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="userSelectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-body">
                <span class="close" onclick="closeUserSelectionModal()">&times;</span>
                <h3>„ÅäÂÆ¢Êßò„ÅÆÂ§âÊõ¥</h3>
                <div class="user-selection-settings">
                    <div class="form-group">
                        <label for="userSearchInput" class="form-label">„ÅäÂÆ¢Êßò„ÇíÊ§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</label>
                        <input type="text" id="userSearchInput" class="form-control" placeholder="„ÅäÂÆ¢ÊßòÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..." autocomplete="off">
                    </div>
                    <div class="user-search-results" id="userSelectionSearchResults">
                        <!-- Ê§úÁ¥¢ÁµêÊûú„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeUserSelectionModal()">„Ç≠„É£„É≥„Çª„É´</button>
                        <button class="btn btn-primary" onclick="saveUserSelection()" id="saveUserBtn" disabled>Â§âÊõ¥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentWeekStart = new Date(2025, 7, 10); // 2025Âπ¥8Êúà10Êó•ÔºàÊó•ÊõúÊó•Ôºâ
        let weeklySchedules = {}; // ÈÄ±Âà•„Çπ„Ç±„Ç∏„É•„Éº„É´ÔºàÈÄ±„ÅÆ„Ç≠„Éº„Åß‰øùÂ≠òÔºâ
        let defaultSchedule = {}; // „Éá„Éï„Ç©„É´„Éà„Çπ„Ç±„Ç∏„É•„Éº„É´
        let reservations = {}; // ‰∫àÁ¥Ñ„Éá„Éº„Çø
        let miniCalendarMonth = new Date(2025, 7, 1); // „Éü„Éã„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆË°®Á§∫ÊúàÔºà8ÊúàÔºâ
        let clickedDate = null; // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÊó•‰ªò
        let currentReservation = null; // ÁèæÂú®Ë°®Á§∫‰∏≠„ÅÆ‰∫àÁ¥Ñ
        let searchTimeout = null; // Ê§úÁ¥¢„ÅÆ„Éá„Éê„Ç¶„É≥„ÇπÁî®
        let isEditingReservation = false; // ‰∫àÁ¥ÑÁ∑®ÈõÜ„É¢„Éº„Éâ„Éï„É©„Ç∞
        let reservationToEdit = null; // Á∑®ÈõÜÂØæË±°„ÅÆ‰∫àÁ¥Ñ„Éá„Éº„Çø
        let cancelledReservations = []; // „Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åü‰∫àÁ¥Ñ„ÅÆ„É™„Çπ„Éà
        let cancellationDisplayReady = false; // „Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„ÅÆÊ∫ñÂÇôÂÆå‰∫Ü„Éï„É©„Ç∞
        let domReady = false; // DOM„ÅÆÊ∫ñÂÇôÂÆå‰∫Ü„Éï„É©„Ç∞









        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
        function loadCancelledReservations() {
            try {
                const stored = localStorage.getItem('cancelledReservations');
                if (stored) {
                    cancelledReservations = JSON.parse(stored);
        
                }
            } catch (error) {
                console.error('‚ùå Error loading cancelled reservations:', error);
                cancelledReservations = [];
            }
        }

        // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´„Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥„Çí‰øùÂ≠ò
        function saveCancelledReservations() {
            try {
                localStorage.setItem('cancelledReservations', JSON.stringify(cancelledReservations));
    
            } catch (error) {
                console.error('‚ùå Error saving cancelled reservations:', error);
            }
        }
        
        // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„Çâ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        <% if @reservations.present? %>
            console.log('üîÑ Loading server-side reservations:', <%= @reservations.count %>);
            <% @reservations.each do |reservation| %>
                (function() {
                    const reservationDateKey = '<%= reservation.start_time.strftime('%Y-%m-%d') %>';
                    if (!reservations[reservationDateKey]) {
                        reservations[reservationDateKey] = [];
                    }
                    const reservationData = {
                        id: <%= reservation.id %>,
                        time: '<%= reservation.start_time.strftime('%H:%M') %>',
                        duration: <%= extract_course_duration(reservation.course) %>,
                        customer: '<%= j(reservation.name || reservation.user&.name || 'Êú™Ë®≠ÂÆö') %>',
                        phone: '<%= j(reservation.user&.phone_number || '') %>',
                        email: '<%= j(reservation.user&.email || '') %>',
                        note: '<%= j(reservation.note || '') %>',
                        status: '<%= reservation.status %>',
                        createdAt: '<%= reservation.created_at.iso8601 %>',
                        updatedAt: '<%= reservation.updated_at.iso8601 %>',
                        userId: <%= reservation.user_id || 'null' %>,
                        effective_interval_minutes: <%= reservation.effective_interval_minutes || 0 %>
                    };
                    reservations[reservationDateKey].push(reservationData);
                    console.log('üìÖ Server-side reservation loaded:', {
                        date: reservationDateKey,
                        id: reservationData.id,
                        userId: reservationData.userId,
                        customer: reservationData.customer
                    });
                })();
            <% end %>
        <% else %>
            console.log('‚ÑπÔ∏è No server-side reservations found');
        <% end %>
        
        // ÊõúÊó•„ÅÆÂêçÂâç
        const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
        const dayNamesLong = ['Êó•ÊõúÊó•', 'ÊúàÊõúÊó•', 'ÁÅ´ÊõúÊó•', 'Ê∞¥ÊõúÊó•', 'Êú®ÊõúÊó•', 'ÈáëÊõúÊó•', 'ÂúüÊõúÊó•'];
        
        // Êúà„ÅÆÂêçÂâç
        const monthNames = ['1Êúà', '2Êúà', '3Êúà', '4Êúà', '5Êúà', '6Êúà', '7Êúà', '8Êúà', '9Êúà', '10Êúà', '11Êúà', '12Êúà'];
        
        // ÂàùÊúüÂåñ
        function init() {
            // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„ÇãÊ©üËÉΩ„ÇíË®≠ÂÆö
            setupModalClickOutside();
            
            Promise.all([
                loadShiftSettingsFromBackend(),
                loadReservationsFromBackend()
            ]).then(() => {
                renderWeekView();
                renderDaySettings();
                renderMiniCalendar();
                showDragHint();
            });
        }

        // „Éâ„É©„ÉÉ„Ç∞„Éí„É≥„Éà„ÇíË°®Á§∫
        function showDragHint() {
            // „Éí„É≥„ÉàË¶ÅÁ¥†„Çí‰ΩúÊàê
            const hint = document.createElement('div');
            hint.className = 'drag-hint';
            hint.textContent = 'üí° ‰∫àÁ¥Ñ„Çí„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶ÊôÇÈñì„ÇíÂ§âÊõ¥„Åß„Åç„Åæ„Åô';
            document.body.appendChild(hint);
            
            // 3ÁßíÂæå„Å´Ë°®Á§∫
            setTimeout(() => {
                hint.classList.add('show');
            }, 1000);
            
            // 5ÁßíÂæå„Å´ÈùûË°®Á§∫
            setTimeout(() => {
                hint.classList.remove('show');
                setTimeout(() => {
                    if (hint.parentNode) {
                        hint.parentNode.removeChild(hint);
                    }
                }, 300);
            }, 5000);
        }



        // ‰∫àÁ¥ÑÂ§âÊõ¥„Çí‰øùÂ≠ò
        function saveReservationChanges(event) {
            event.preventDefault();
            
            console.log('üîÑ saveReservationChanges called');
            
            if (!currentReservation) {
                showMessage('‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
                return;
            }

            // „Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÇíÂèñÂæó
            const courseSelect = document.getElementById('edit-course');
            const statusSelect = document.getElementById('edit-status');
            const noteTextarea = document.getElementById('edit-note');
            
            console.log('üìù Form elements found:', {
                courseSelect: courseSelect ? 'found' : 'not found',
                statusSelect: statusSelect ? 'found' : 'not found',
                noteTextarea: noteTextarea ? 'found' : 'not found'
            });
            
            const newCourse = courseSelect ? courseSelect.value : `${currentReservation.duration}ÂàÜ`;
            const newDuration = extractDurationFromCourse(newCourse);
            const currentInterval = currentReservation.effective_interval_minutes ?? 10;
            
            // Âñ∂Ê•≠ÊôÇÈñìÂÜÖ„Å´Âèé„Åæ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const businessHoursValidation = validateReservationTimeWithinBusinessHours(currentReservation, newDuration, currentInterval);
            if (!businessHoursValidation.valid) {
                showMessage(businessHoursValidation.message, 'error');
                return;
            }
            
            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
            const overlapValidation = validateReservationOverlap(currentReservation, newDuration, currentInterval);
            if (!overlapValidation.valid) {
                showMessage(overlapValidation.message, 'error');
                return;
            }
            
            const formData = {
                reservation: {
                    course: newCourse,
                    status: statusSelect ? statusSelect.value : currentReservation.status,
                    note: noteTextarea ? noteTextarea.value : currentReservation.note || ''
                }
            };
            
            // „É¶„Éº„Ç∂„Éº„ÅåÂ§âÊõ¥„Åï„Çå„ÅüÂ†¥Âêà„ÅÆ„Åøuser_id„ÇíËøΩÂä†
            if (window.currentUserId && window.currentUserId !== currentReservation.userId) {
                formData.reservation.user_id = window.currentUserId;
            }
            
            console.log('üì§ Sending form data:', formData);

            // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´Êõ¥Êñ∞„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            
            fetch(`/admin/reservations/${currentReservation.id}/update_booking`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Unknown error'}`);
                    }).catch(() => {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                    const reservationData = data.reservation;
                    const updatedReservation = {
                        ...currentReservation,
                        customer: reservationData.name || reservationData.user?.name || 'Êú™Ë®≠ÂÆö',
                        phone: reservationData.user?.phone_number || '',
                        email: reservationData.user?.email || '',
                        duration: extractDurationFromCourse(reservationData.course),
                        status: reservationData.status,
                        note: reservationData.note || '',
                        updatedAt: reservationData.updated_at
                    };
                    
                    // „Ç∞„É≠„Éº„Éê„É´reservations„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊõ¥Êñ∞
                    const reservationDateKey = formatDateKey(new Date(currentReservation.start_time || currentReservation.time));
                    if (reservations[reservationDateKey]) {
                        const reservationIndex = reservations[reservationDateKey].findIndex(r => r.id === currentReservation.id);
                        if (reservationIndex !== -1) {
                            reservations[reservationDateKey][reservationIndex] = updatedReservation;
                        }
                    }
                    
                    // currentReservation„ÇíÊõ¥Êñ∞
                    currentReservation = updatedReservation;
                    
                    // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂÜçÊèèÁîª
                    generateTimeSlots();
                    
                    // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÂ§âÊõ¥Êó•ÊôÇ„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                    if (data.reservation && data.reservation.updated_at) {
                        updateModalUpdatedAt(data.reservation.updated_at);
                    }
                    
                    showMessage('‰∫àÁ¥Ñ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'success');
                    
                    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    closeReservationDetailModal();
                } else {
                    showMessage(`‰∫àÁ¥Ñ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error updating reservation:', error);
                showMessage('‰∫àÁ¥Ñ„ÅÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            });
        }

        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÂ§âÊõ¥Êó•ÊôÇ„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
        function updateModalUpdatedAt(updatedAt) {
            const modal = document.getElementById('reservationDetailModal');
            if (!modal) return;
            
            const systemInfoSection = modal.querySelector('.system-info-section');
            if (!systemInfoSection) return;
            
            // Êó¢Â≠ò„ÅÆÂ§âÊõ¥Êó•ÊôÇË¶ÅÁ¥†„ÇíÂâäÈô§
            const detailItems = systemInfoSection.querySelectorAll('.detail-item');
            detailItems.forEach(item => {
                const label = item.querySelector('.detail-label');
                if (label && label.textContent === 'Â§âÊõ¥Êó•ÊôÇ') {
                    item.remove();
                }
            });
            
            // ‰ΩúÊàêÊó•ÊôÇË¶ÅÁ¥†„ÇíÂèñÂæó
            let createdAtItem = null;
            detailItems.forEach(item => {
                const label = item.querySelector('.detail-label');
                if (label && label.textContent === '‰ΩúÊàêÊó•ÊôÇ') {
                    createdAtItem = item;
                }
            });
            
            if (!createdAtItem) return;
            
            // Êñ∞„Åó„ÅÑÂ§âÊõ¥Êó•ÊôÇË¶ÅÁ¥†„Çí‰ΩúÊàê
            const updatedAtItem = document.createElement('div');
            updatedAtItem.className = 'detail-item';
            updatedAtItem.innerHTML = `
                <span class="detail-label">Â§âÊõ¥Êó•ÊôÇ</span>
                <span class="detail-value">${new Date(updatedAt).toLocaleString('ja-JP')}</span>
            `;
            
            // ‰ΩúÊàêÊó•ÊôÇ„ÅÆÂæå„Å´ÊåøÂÖ•
            createdAtItem.insertAdjacentElement('afterend', updatedAtItem);
        }

        // „Ç§„É≥„Çø„Éº„Éê„É´Â§âÊõ¥ÊôÇ„Å´Âç≥Â∫ß„Å´Êõ¥Êñ∞
        function updateIntervalOnChange() {
            if (!currentReservation) {
                showMessage('‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ', 'error');
                return;
            }

            const newInterval = parseInt(document.getElementById('edit-interval').value);
            const currentDuration = currentReservation.duration || 60;
            
            console.log('üîç updateIntervalOnChange called with:', {
                newInterval,
                currentDuration,
                currentReservation: currentReservation
            });
            
            console.log('üîç Interval change attempt:', {
                newInterval,
                currentDuration,
                currentReservation: currentReservation,
                startTime: currentReservation.time || currentReservation.start_time,
                date: currentReservation.date,
                dayOfWeek: new Date(currentReservation.start_time || currentReservation.time).getDay()
            });
            
            // Âñ∂Ê•≠ÊôÇÈñìÂÜÖ„Å´Âèé„Åæ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            console.log('üîç About to call business hours validation with:', {
                reservation: currentReservation,
                duration: currentDuration,
                interval: newInterval
            });
            const businessHoursValidation = validateReservationTimeWithinBusinessHours(currentReservation, currentDuration, newInterval);
            console.log('üîç Interval change business hours validation result:', businessHoursValidation);
            if (!businessHoursValidation.valid) {
                console.log('‚ùå Business hours validation failed, showing error and returning');
                showMessage(businessHoursValidation.message, 'error');
                // ÂÖÉ„ÅÆÂÄ§„Å´Êàª„Åô
                const intervalSelect = document.getElementById('edit-interval');
                intervalSelect.value = currentReservation.effective_interval_minutes ?? 10;
                return;
            }
            
            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
            console.log('üîç About to call overlap validation with:', {
                reservation: currentReservation,
                duration: currentDuration,
                interval: newInterval
            });
            const overlapValidation = validateReservationOverlap(currentReservation, currentDuration, newInterval);
            console.log('üîç Interval change overlap validation result:', overlapValidation);
            if (!overlapValidation.valid) {
                showMessage(overlapValidation.message, 'error');
                // ÂÖÉ„ÅÆÂÄ§„Å´Êàª„Åô
                const intervalSelect = document.getElementById('edit-interval');
                intervalSelect.value = currentReservation.effective_interval_minutes ?? 10;
                return;
            }

            const reservationId = currentReservation.id;

            // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´Êõ¥Êñ∞„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            
            const requestBody = {
                individual_interval_minutes: newInterval
            };
            console.log('üîç Sending interval update request:', {
                reservationId,
                newInterval,
                requestBody
            });
            
            fetch(`/admin/reservations/${reservationId}/update_interval`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('üîç Backend response for interval update:', data);
                if (data.success) {
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                    currentReservation.effective_interval_minutes = newInterval;
                    currentReservation.individual_interval_minutes = newInterval;
                    console.log('üîç Updated currentReservation:', currentReservation);
                    
                    // updatedAt„Éï„Ç£„Éº„É´„Éâ„ÇíÊõ¥Êñ∞
                    if (data.updated_at) {
                        currentReservation.updatedAt = data.updated_at;
                        
                                            // „Ç∞„É≠„Éº„Éê„É´reservations„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇÇÊõ¥Êñ∞
                    const reservationDateKey = currentReservation.date || formatDateKey(new Date(currentReservation.start_time || currentReservation.time));
                    if (reservations[reservationDateKey]) {
                        const reservationIndex = reservations[reservationDateKey].findIndex(r => r.id === currentReservation.id);
                        if (reservationIndex !== -1) {
                            reservations[reservationDateKey][reservationIndex].updatedAt = data.updated_at;
                            reservations[reservationDateKey][reservationIndex].effective_interval_minutes = newInterval;
                            reservations[reservationDateKey][reservationIndex].individual_interval_minutes = newInterval;
                            console.log('üîç Updated local reservation data:', reservations[reservationDateKey][reservationIndex]);
                        }
                    }
                        
                        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÂ§âÊõ¥Êó•ÊôÇ„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                        updateModalUpdatedAt(data.updated_at);
                    }
                    
                    // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂÜçÊèèÁîª
                    generateTimeSlots();
                    
                    showMessage('Ê∫ñÂÇôÊôÇÈñì„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'success');
                } else {
                    showMessage(`Ê∫ñÂÇôÊôÇÈñì„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error updating interval:', error);
                showMessage('Ê∫ñÂÇôÊôÇÈñì„ÅÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            });
        }

        // „Çπ„ÉÜ„Éº„Çø„ÇπÂ§âÊõ¥ÊôÇ„Å´„Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
        function updateCalendarOnStatusChange() {
            if (!currentReservation) {
                return;
            }

            const newStatus = document.getElementById('edit-status').value;
            
            // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            currentReservation.status = newStatus;
            
            // „Ç∞„É≠„Éº„Éê„É´reservations„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇÇÊõ¥Êñ∞
            const reservationDateKey = formatDateKey(new Date(currentReservation.start_time || currentReservation.time));
            if (reservations[reservationDateKey]) {
                const reservationIndex = reservations[reservationDateKey].findIndex(r => r.id === currentReservation.id);
                if (reservationIndex !== -1) {
                    reservations[reservationDateKey][reservationIndex].status = newStatus;
                }
            }
            
            // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂÜçÊèèÁîª
            generateTimeSlots();
        }

        // ‰∫àÁ¥ÑÊôÇÈñì„ÅåÂñ∂Ê•≠ÊôÇÈñìÂÜÖ„Å´Âèé„Åæ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function validateReservationTimeWithinBusinessHours(reservation, newDuration, newInterval) {
            console.log('üîç validateReservationTimeWithinBusinessHours called with:', {
                reservation: reservation,
                newDuration: newDuration,
                newInterval: newInterval
            });
            if (!reservation) return { valid: false, message: '‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ' };
            
            // ‰∫àÁ¥Ñ„ÅÆÈñãÂßãÊôÇÈñì„ÇíÂèñÂæóÔºàË§áÊï∞„ÅÆÂèØËÉΩÊÄß„ÇíËÄÉÊÖÆÔºâ
            let startTime;
            if (reservation.start_time) {
                // start_time„ÅåÊó•ÊôÇÂΩ¢Âºè„ÅÆÂ†¥ÂêàÔºà‰æã: "2025-08-15T17:00:00"Ôºâ
                const dateTime = new Date(reservation.start_time);
                startTime = `${dateTime.getHours().toString().padStart(2, '0')}:${dateTime.getMinutes().toString().padStart(2, '0')}`;
            } else if (reservation.time) {
                // time„ÅåÊôÇÈñìÂΩ¢Âºè„ÅÆÂ†¥ÂêàÔºà‰æã: "17:00"Ôºâ
                startTime = reservation.time;
            } else {
                return { valid: false, message: '‰∫àÁ¥Ñ„ÅÆÈñãÂßãÊôÇÈñì„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ' };
            }
            
            const [startHour, startMin] = startTime.split(':').map(Number);
            const startTimeInMinutes = startHour * 60 + startMin;
            
            const totalDuration = newDuration + newInterval;
            const endTimeInMinutes = startTimeInMinutes + totalDuration;
            
            // ‰∫àÁ¥Ñ„ÅÆÊó•‰ªò„ÇíÂèñÂæó
            let reservationDate;
            if (reservation.start_time) {
                reservationDate = new Date(reservation.start_time);
            } else if (reservation.date) {
                // ‰∫àÁ¥Ñ„ÅÆÊó•‰ªò„Éï„Ç£„Éº„É´„Éâ„Çí‰ΩøÁî®
                reservationDate = new Date(reservation.date);
            } else if (reservation.dateKey) {
                reservationDate = new Date(reservation.dateKey);
            } else {
                // ÁèæÂú®„ÅÆÈÄ±„ÅÆÈñãÂßãÊó•„Çí‰ΩøÁî®
                reservationDate = new Date(currentWeekStart);
            }
            const dayOfWeek = reservationDate.getDay();
            
            console.log('üîç Date calculation debug:', {
                start_time: reservation.start_time,
                date: reservation.date,
                dateKey: reservation.dateKey,
                reservationDate: reservationDate.toISOString(),
                dayOfWeek: dayOfWeek,
                dayName: ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][dayOfWeek]
            });
            
            console.log('üîç Validation debug:', {
                startTime,
                startTimeInMinutes,
                totalDuration,
                endTimeInMinutes,
                dayOfWeek,
                reservation: reservation,
                businessHours: isBusinessHour(dayOfWeek, startTime),
                courseDuration: newDuration,
                interval: newInterval
            });
            
            // „Ç§„É≥„Çø„Éº„Éê„É´„Åå0„ÅÆÂ†¥Âêà„ÄÅ„Ç≥„Éº„ÇπÊôÇÈñì„ÅÆ„Åø„Åß„ÉÅ„Çß„ÉÉ„ÇØ
            const durationToCheck = newInterval === 0 ? newDuration : totalDuration;
            const endTimeToCheck = startTimeInMinutes + durationToCheck;
            
            // 10ÂàÜÈñìÈöî„Åß„ÉÅ„Çß„ÉÉ„ÇØ
            for (let timeInMinutes = startTimeInMinutes; timeInMinutes < endTimeToCheck; timeInMinutes += 10) {
                const checkHour = Math.floor(timeInMinutes / 60);
                const checkMin = timeInMinutes % 60;
                const timeStr = `${checkHour.toString().padStart(2, '0')}:${checkMin.toString().padStart(2, '0')}`;
                
                const isBusinessHourResult = isBusinessHour(dayOfWeek, timeStr);
                if (!isBusinessHourResult) {
                    console.log('‚ùå Validation failed at:', timeStr, 'dayOfWeek:', dayOfWeek, 'isBusinessHour:', isBusinessHourResult);
                    return { 
                        valid: false, 
                        message: `‰∫àÁ¥ÑÊôÇÈñì„ÅåÂñ∂Ê•≠ÊôÇÈñìÂ§ñÔºà${timeStr}Ôºâ„Å´Âèä„Å∂„Åü„ÇÅ„ÄÅ„Åì„ÅÆË®≠ÂÆö„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ` 
                    };
                }
            }
            
            console.log('‚úÖ Validation passed');
            return { valid: true, message: '' };
        }

        // ‰∫àÁ¥Ñ„ÅÆÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
        function validateReservationOverlap(reservation, newDuration, newInterval) {
            if (!reservation) return { valid: false, message: '‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ' };
            
            // ‰∫àÁ¥Ñ„ÅÆÈñãÂßãÊôÇÈñì„ÇíÂèñÂæó
            let startTime;
            let dateKey;
            
            // ÂÑ™ÂÖàÈ†Ü‰Ωç: start_time > dateKey > date > time
            if (reservation.start_time) {
                const dateTime = new Date(reservation.start_time);
                startTime = `${dateTime.getHours().toString().padStart(2, '0')}:${dateTime.getMinutes().toString().padStart(2, '0')}`;
                dateKey = formatDateKey(dateTime);
            } else if (reservation.dateKey) {
                startTime = reservation.time;
                dateKey = reservation.dateKey;
            } else if (reservation.date && reservation.time) {
                startTime = reservation.time;
                dateKey = reservation.date;
            } else if (reservation.time) {
                startTime = reservation.time;
                // ÁèæÂú®„ÅÆÈÄ±„ÅÆÈñãÂßãÊó•„Çí‰ΩøÁî®
                const reservationDate = new Date(currentWeekStart);
                dateKey = formatDateKey(reservationDate);
            } else {
                return { valid: false, message: '‰∫àÁ¥Ñ„ÅÆÈñãÂßãÊôÇÈñì„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ' };
            }
            
            const [startHour, startMin] = startTime.split(':').map(Number);
            const startTimeInMinutes = startHour * 60 + startMin;
            const totalDuration = newDuration + newInterval;
            const endTimeInMinutes = startTimeInMinutes + totalDuration;
            
            // ÊåáÂÆöÊó•„ÅÆ‰∫àÁ¥Ñ„ÇíÂèñÂæóÔºàËá™ÂàÜ‰ª•Â§ñÔºâ
            const dayReservations = reservations[dateKey] || [];
            
            console.log('üîç Overlap validation debug:', {
                dateKey,
                startTime,
                startTimeInMinutes,
                totalDuration,
                endTimeInMinutes,
                reservationId: reservation.id,
                dayReservations: dayReservations.length,
                reservationData: {
                    start_time: reservation.start_time,
                    dateKey: reservation.dateKey,
                    date: reservation.date,
                    time: reservation.time
                }
            });
            
            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇÇÂê´„ÇÄÔºâ
            for (const existingReservation of dayReservations) {
                if (existingReservation.id === reservation.id) {
                    console.log('‚è≠Ô∏è Skipping self:', existingReservation.id);
                    continue; // Ëá™ÂàÜ„ÅØÈô§Â§ñ
                }
                
                const existingStart = new Date(`${dateKey}T${existingReservation.time}`);
                const existingEnd = new Date(existingStart.getTime() + existingReservation.duration * 60 * 1000);
                
                // Êó¢Â≠ò‰∫àÁ¥Ñ„ÅÆ„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇíÂèñÂæó
                const existingIntervalMinutes = existingReservation.effective_interval_minutes ?? 10;
                const existingEndWithInterval = new Date(existingEnd.getTime() + existingIntervalMinutes * 60 * 1000);
                
                // Êñ∞„Åó„ÅÑ‰∫àÁ¥Ñ„ÅÆÁµÇ‰∫ÜÊôÇÈñì
                const newEnd = new Date(`${dateKey}T${startTime}`);
                newEnd.setMinutes(newEnd.getMinutes() + totalDuration);
                
                console.log('üîç Comparing with existing reservation:', {
                    existingId: existingReservation.id,
                    existingTime: `${existingReservation.time} - ${new Date(existingEndWithInterval).toTimeString().slice(0, 5)}`,
                    newTime: `${startTime} - ${newEnd.toTimeString().slice(0, 5)}`,
                    existingInterval: existingIntervalMinutes,
                    newInterval: newInterval
                });
                
                // ÈáçË§áÂà§ÂÆöÔºà„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇÇÂê´„ÇÄÔºâ
                if (startTimeInMinutes < (existingEndWithInterval.getHours() * 60 + existingEndWithInterval.getMinutes()) && 
                    endTimeInMinutes > (existingStart.getHours() * 60 + existingStart.getMinutes())) {
                    console.log('üö´ Overlap detected with reservation:', existingReservation.id);
                    return { 
                        valid: false, 
                        message: `‰∫àÁ¥ÑÊôÇÈñì„ÅåÊó¢Â≠ò„ÅÆ‰∫àÁ¥ÑÔºà${existingReservation.customer}ÊßòÔºâ„Å®ÈáçË§á„Åô„Çã„Åü„ÇÅ„ÄÅ„Åì„ÅÆË®≠ÂÆö„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ` 
                    };
                }
            }
            
            console.log('‚úÖ No overlaps detected');
            return { valid: true, message: '' };
        }

        // „Ç≥„Éº„ÇπÂ§âÊõ¥ÊôÇ„Å´„Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
        function updateCalendarOnCourseChange() {
            if (!currentReservation) return;
            
            const courseSelect = document.getElementById('edit-course');
            if (!courseSelect) return;
            
            const newCourse = courseSelect.value;
            const newDuration = parseInt(newCourse);
            const currentInterval = currentReservation.effective_interval_minutes ?? 10;
            
            console.log('üîÑ Course changed to:', newCourse, 'Duration:', newDuration);
            
            // Âñ∂Ê•≠ÊôÇÈñìÂÜÖ„Å´Âèé„Åæ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            console.log('üîç Validating course change for reservation:', currentReservation);
            const businessHoursValidation = validateReservationTimeWithinBusinessHours(currentReservation, newDuration, currentInterval);
            console.log('üîç Course change business hours validation result:', businessHoursValidation);
            if (!businessHoursValidation.valid) {
                showMessage(businessHoursValidation.message, 'error');
                // ÂÖÉ„ÅÆÂÄ§„Å´Êàª„Åô
                courseSelect.value = currentReservation.course || currentReservation.duration.toString();
                return;
            }
            
            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
            const overlapValidation = validateReservationOverlap(currentReservation, newDuration, currentInterval);
            console.log('üîç Course change overlap validation result:', overlapValidation);
            if (!overlapValidation.valid) {
                showMessage(overlapValidation.message, 'error');
                // ÂÖÉ„ÅÆÂÄ§„Å´Êàª„Åô
                courseSelect.value = currentReservation.course || currentReservation.duration.toString();
                return;
            }
            
            // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞ÔºàË≠¶Âëä„Åå„ÅÇ„Å£„Å¶„ÇÇÊõ¥Êñ∞„Åô„ÇãÔºâ
            currentReservation.duration = newDuration;
            currentReservation.course = newCourse;
            
            // „Ç∞„É≠„Éº„Éê„É´reservations„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇÇÊõ¥Êñ∞
            const reservationDateKey = formatDateKey(new Date(currentReservation.start_time || currentReservation.time));
            if (reservations[reservationDateKey]) {
                const reservationIndex = reservations[reservationDateKey].findIndex(r => r.id === currentReservation.id);
                if (reservationIndex !== -1) {
                    reservations[reservationDateKey][reservationIndex].duration = newDuration;
                    reservations[reservationDateKey][reservationIndex].course = newCourse;
                }
            }
            
            // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂç≥Â∫ß„Å´ÂÜçÊèèÁîª
            generateTimeSlots();
            
            console.log('‚úÖ Calendar updated immediately for course change');
        }



        // „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openUserSelectionModal() {
            console.log('üîç openUserSelectionModal called');
            
            // Ê§úÁ¥¢ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí„ÇØ„É™„Ç¢
            const searchInput = document.getElementById('userSearchInput');
            if (searchInput) {
                searchInput.value = '';
                console.log('üîç Search input found and cleared');
            } else {
                console.error('‚ùå Search input not found');
            }
            
            // Ê§úÁ¥¢ÁµêÊûú„Çí„ÇØ„É™„Ç¢
            const searchResults = document.getElementById('userSelectionSearchResults');
            if (searchResults) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                console.log('üîç Search results cleared and hidden');
            } else {
                console.error('‚ùå Search results container not found');
            }
            
            // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            const saveBtn = document.getElementById('saveUserBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
            }
            
            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
            if (searchInput) {
                // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
                searchInput.removeEventListener('input', handleUserSearch);
                
                // ÂÖ•Âäõ„Ç§„Éô„É≥„Éà
                searchInput.addEventListener('input', handleUserSearch);
                console.log('üîç Input event listener added');
                
                // „Éï„Ç©„Éº„Ç´„Çπ„Ç¢„Ç¶„ÉàÊôÇ„Å´ÁµêÊûú„ÇíÈö†„Åô
                searchInput.addEventListener('blur', function() {
                    setTimeout(() => {
                        hideUserSearchResults();
                    }, 200);
                });
                
                // „Éï„Ç©„Éº„Ç´„ÇπÊôÇ„Å´ÁµêÊûú„ÇíË°®Á§∫ÔºàÂÖ•Âäõ„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
                searchInput.addEventListener('focus', function() {
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        searchUsersForModal(query);
                    }
                });
                
                searchInput.focus();
            }
            
            document.getElementById('userSelectionModal').style.display = 'block';
            console.log('üîç Modal displayed');
            
            // Debug modal dimensions
            const modal = document.getElementById('userSelectionModal');
            const modalContent = modal.querySelector('.modal-content');
            console.log('üîç Modal dimensions:', modal.offsetWidth, 'x', modal.offsetHeight);
            console.log('üîç Modal content dimensions:', modalContent.offsetWidth, 'x', modalContent.offsetHeight);
        }

        // „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢„ÇíÂá¶ÁêÜ
        function handleUserSearch(event) {
            const query = event.target.value.trim();
            console.log('üîç handleUserSearch called with query:', query);
            
            // „Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜ
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }
            
            if (query.length < 2) {
                console.log('üîç Query too short, hiding results');
                hideUserSearchResults();
                return;
            }
            
            console.log('üîç Setting timeout for search');
            searchTimeout = setTimeout(() => {
                console.log('üîç Calling searchUsersForModal with:', query);
                searchUsersForModal(query);
            }, 300);
        }

        // „É¢„Éº„ÉÄ„É´Áî®„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢
        function searchUsersForModal(query) {
            console.log('üîç searchUsersForModal called with query:', query);
            fetch(`/admin/reservations/search_users?query=${encodeURIComponent(query)}`)
                .then(response => {
                    console.log('üîç Search response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('üîç Search response data:', data);
                    if (data.success) {
                        displayUserSearchResultsForModal(data.users);
                    } else {
                        console.error('‚ùå User search failed:', data.message);
                        hideUserSearchResults();
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error searching users:', error);
                    hideUserSearchResults();
                });
        }

        // „É¢„Éº„ÉÄ„É´Áî®Ê§úÁ¥¢ÁµêÊûúË°®Á§∫
        function displayUserSearchResultsForModal(users) {
            console.log('üîç displayUserSearchResultsForModal called with users:', users);
            const searchResults = document.getElementById('userSelectionSearchResults');
            if (!searchResults) {
                console.error('‚ùå Search results container not found');
                return;
            }
            
            if (users.length === 0) {
                searchResults.innerHTML = '<div class="user-search-item">Ë©≤ÂΩì„Åô„Çã„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>';
                searchResults.style.display = 'block';
                console.log('üîç No users found, showing message');
                return;
            }
            
            const resultsHtml = users.map(user => `
                <div class="user-search-item" onclick="selectUserForModal(${user.id}, '${user.name}', '${user.phone_number}', '${user.email}')">
                    <div class="user-name">${user.name}</div>
                    <div class="user-details">
                        üìû ${user.phone_number || 'Êú™Ë®≠ÂÆö'} | üìß ${user.email || 'Êú™Ë®≠ÂÆö'}
                        ${user.active_tickets > 0 ? `<span class="user-tickets"> | üé´ ÊÆã${user.active_tickets}Êûö</span>` : ''}
                        ${user.last_visit !== '„Å™„Åó' ? ` | üìÖ ÊúÄÁµÇÊù•Â∫ó: ${user.last_visit}` : ''}
                    </div>
                </div>
            `).join('');
            
            searchResults.innerHTML = resultsHtml;
            searchResults.style.display = 'block';
            
            // Let the container size naturally based on content
            searchResults.style.height = 'auto';
            
            // Force a reflow to ensure the browser recalculates dimensions
            searchResults.offsetHeight;
            
            console.log('üîç Search results displayed:', users.length, 'users');
            

        }

        // „É¢„Éº„ÉÄ„É´Áî®„É¶„Éº„Ç∂„ÉºÈÅ∏Êäû
        function selectUserForModal(userId, name, phone, email) {
            console.log('üîç selectUserForModal called with:', { userId, name, phone, email });
            console.log('üîç Current reservation user ID:', currentReservation?.userId);
            
            // ÈÅ∏Êäû„Åï„Çå„Åü„É¶„Éº„Ç∂„Éº„Çí‰øùÂ≠ò
            window.selectedUser = {
                id: userId,
                name: name,
                phone_number: phone,
                email: email
            };
            
            // Ê§úÁ¥¢ÁµêÊûú„Çí„ÇØ„É™„Ç¢„Åó„Å¶ÈÅ∏Êäû„Åï„Çå„Åü„É¶„Éº„Ç∂„Éº„ÇíË°®Á§∫
            const searchResults = document.getElementById('userSelectionSearchResults');
            if (searchResults) {
                searchResults.innerHTML = `
                    <div class="selected-user">
                        <div class="user-info">
                            <div class="user-name">‚úÖ ${name}</div>
                            <div class="user-details">
                                üìû ${phone || 'Êú™Ë®≠ÂÆö'} | üìß ${email || 'Êú™Ë®≠ÂÆö'}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
            const saveBtn = document.getElementById('saveUserBtn');
            if (saveBtn) {
                saveBtn.disabled = false;
            }
            

            
            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
            showMessage(`Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„Äå${name}„Äç„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`, 'success');
        }

        // „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeUserSelectionModal() {
            document.getElementById('userSelectionModal').style.display = 'none';
        }

        // „É¶„Éº„Ç∂„ÉºÈÅ∏Êäû„Çí‰øùÂ≠ò
        function saveUserSelection() {
            if (!window.selectedUser) {
                showMessage('„ÅäÂÆ¢Êßò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                return;
            }
            
            const newUserId = window.selectedUser.id;
            const newUserName = window.selectedUser.name;
            const newUserPhone = window.selectedUser.phone_number || '';
            const newUserEmail = window.selectedUser.email || '';
            
            console.log('üîç saveUserSelection - Selected user:', { newUserId, newUserName, newUserPhone, newUserEmail });
            console.log('üîç saveUserSelection - Current reservation user ID:', currentReservation?.userId);
            
            // È°ßÂÆ¢ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            const customerNameElement = document.querySelector('.customer-name-large');
            if (customerNameElement) {
                customerNameElement.textContent = newUserName;
            }
            
            const phoneElement = document.querySelector('.customer-phone');
            if (phoneElement) {
                phoneElement.textContent = newUserPhone || 'ÈõªË©±Áï™Âè∑Êú™Ë®òÂÖ•';
            }
            
            const emailElement = document.querySelector('.customer-email');
            if (emailElement) {
                emailElement.textContent = newUserEmail || '„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÊú™Ë®òÂÖ•';
            }
            
            // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
            if (currentReservation) {
                currentReservation.customer = newUserName;
                currentReservation.phone = newUserPhone;
                currentReservation.email = newUserEmail;
                currentReservation.userId = newUserId;
            }
            
            // „Ç∞„É≠„Éº„Éê„É´reservations„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇÇÊõ¥Êñ∞
            const reservationDateKey = formatDateKey(new Date(currentReservation.start_time || currentReservation.time));
            if (reservations[reservationDateKey]) {
                const reservationIndex = reservations[reservationDateKey].findIndex(r => r.id === currentReservation.id);
                if (reservationIndex !== -1) {
                    reservations[reservationDateKey][reservationIndex].customer = newUserName;
                    reservations[reservationDateKey][reservationIndex].phone = newUserPhone;
                    reservations[reservationDateKey][reservationIndex].email = newUserEmail;
                    reservations[reservationDateKey][reservationIndex].userId = newUserId;
                }
            }
            
            // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´„É¶„Éº„Ç∂„ÉºÂ§âÊõ¥„Çí‰øùÂ≠ò
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            
            fetch(`/admin/reservations/${currentReservation.id}/update_booking`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({
                    reservation: {
                        user_id: newUserId
                    }
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // „É¨„Çπ„Éù„É≥„Çπ„Åã„ÇâÊõ¥Êñ∞„Åï„Çå„Åü„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíÂèñÂæó
                    const updatedUser = data.reservation.user;
                    
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                    if (currentReservation) {
                        currentReservation.customer = updatedUser.name;
                        currentReservation.phone = updatedUser.phone_number;
                        currentReservation.email = updatedUser.email;
                        currentReservation.userId = updatedUser.id;
                    }
                    
                    // „Ç∞„É≠„Éº„Éê„É´reservations„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇÇÊõ¥Êñ∞
                    const reservationDateKey = formatDateKey(new Date(currentReservation.start_time || currentReservation.time));
                    if (reservations[reservationDateKey]) {
                        const reservationIndex = reservations[reservationDateKey].findIndex(r => r.id === currentReservation.id);
                        if (reservationIndex !== -1) {
                            reservations[reservationDateKey][reservationIndex].customer = updatedUser.name;
                            reservations[reservationDateKey][reservationIndex].phone = updatedUser.phone_number;
                            reservations[reservationDateKey][reservationIndex].email = updatedUser.email;
                            reservations[reservationDateKey][reservationIndex].userId = updatedUser.id;
                        }
                    }
                    
                    // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇÇÊõ¥Êñ∞
                    window.currentUserId = updatedUser.id;
                    
                    // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂç≥Â∫ß„Å´ÂÜçÊèèÁîª„Åó„Å¶Â§âÊõ¥„ÇíÂèçÊò†
                    generateTimeSlots();
                    
                    // „ÉÅ„Ç±„ÉÉ„Éà„Å®Â±•Ê≠¥„ÇíÊñ∞„Åó„ÅÑ„É¶„Éº„Ç∂„Éº„ÅßÊõ¥Êñ∞
                    loadTicketsAndHistoryForUser(updatedUser.id);
                    
                    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    closeUserSelectionModal();
                    
                    showMessage('„ÅäÂÆ¢Êßò„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'success');
                    
                    console.log('üîÑ Customer changed to:', updatedUser.name);
                    
                    // „Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø„Åó„Å¶Á¢∫ÂÆü„Å´„Éá„Éº„Çø„ÇíÂêåÊúü
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    showMessage(`„ÅäÂÆ¢Êßò„ÅÆÂ§âÊõ¥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('‚ùå Error updating user:', error);
                showMessage('„ÅäÂÆ¢Êßò„ÅÆÂ§âÊõ¥‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            });
        }



        // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„Çâ„Ç∑„Éï„ÉàË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        function loadShiftSettingsFromBackend() {
            const weekStartStr = formatDateKey(currentWeekStart);
            
            return fetch(`/admin/reservations/load_shift_settings?week_start_date=${weekStartStr}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        defaultSchedule = data.default_schedule;
                        weeklySchedules[weekStartStr] = data.current_week_schedule;
                        

                        
                        // ÈÄ±Âõ∫Êúâ„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„É≠„Ç∞
                        if (!data.has_custom_schedule) {
    
                        }
  } else {
                        console.error('‚ùå Failed to load shift settings:', data.message);
                        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éá„Éï„Ç©„É´„Éà„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÂàùÊúüÂåñ
                        initializeDefaultSchedule();
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error loading shift settings:', error);
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Éá„Éï„Ç©„É´„Éà„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÂàùÊúüÂåñ
                    initializeDefaultSchedule();
                });
        }

        // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„Çâ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø
        function loadReservationsFromBackend() {
            const weekStartStr = formatDateKey(currentWeekStart);

            
            return fetch(`/admin/reservations/load_reservations?week_start_date=${weekStartStr}`)
                .then(response => response.json())
                .then(data => {

                    if (data.success) {
                        // Êñ∞„Åó„ÅÑÈÄ±„ÅÆ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅßÊó¢Â≠ò„ÅÆ„Éá„Éº„Çø„ÇíÊõ¥Êñ∞ÔºàÊó¢Â≠ò„Éá„Éº„Çø„Çí‰øùÊåÅÔºâ
                        console.log('üîÑ Loading reservations from backend');
                        console.log('üìÖ Existing reservations:', reservations);
                        console.log('üìÖ Backend reservations:', data.reservations);
                        
                        // Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÅßÂÆåÂÖ®„Å´ÁΩÆ„ÅçÊèõ„ÅàÔºà„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅÆÊúÄÊñ∞„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºâ
                        reservations = data.reservations;
                        
                        console.log('üìÖ Final merged reservations:', reservations);
                        console.log('üìÖ Checking specific reservation 97:', reservations['2025-08-13']?.find(r => r.id === 97));
                        
                        // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂç≥Â∫ß„Å´ÂÜçÊèèÁîª„Åó„Å¶Â§âÊõ¥„ÇíÂèçÊò†
                        console.log('üîÑ Calling generateTimeSlots after data load');
                        generateTimeSlots();
    } else {
                        console.error('‚ùå Failed to load reservations:', data.message);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error loading reservations:', error);
                });
        }

        // „Éá„Éï„Ç©„É´„Éà„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÂàùÊúüÂåñ
        function initializeDefaultSchedule() {
            defaultSchedule = {
                0: { enabled: false, times: [] }, // Êó•ÊõúÊó•„ÅØ‰ºëÊ•≠
                1: { enabled: true, times: [{ start: '09:00', end: '20:00' }] }, // ÊúàÊõúÊó•
                2: { enabled: true, times: [{ start: '10:00', end: '20:00' }] }, // ÁÅ´ÊõúÊó•
                3: { enabled: true, times: [{ start: '10:00', end: '20:00' }] }, // Ê∞¥ÊõúÊó•
                4: { enabled: true, times: [{ start: '10:00', end: '20:00' }] }, // Êú®ÊõúÊó•
                5: { enabled: true, times: [{ start: '10:00', end: '20:00' }] }, // ÈáëÊõúÊó•
                6: { enabled: true, times: [{ start: '09:00', end: '18:00' }] }, // ÂúüÊõúÊó•
            };
        }

        // „Çµ„É≥„Éó„É´‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÁîüÊàê
        function generateSampleReservations() {
            reservations = {
                '2025-08-11': [
                    { time: '10:00', duration: 60, customer: 'Áî∞‰∏≠Êßò', status: 'confirmed' },
                    { time: '14:00', duration: 90, customer: '‰ΩêËó§Êßò', status: 'confirmed' },
                ],
                '2025-08-13': [
                    { time: '11:00', duration: 60, customer: 'Â±±Áî∞Êßò', status: 'completed' },
                    { time: '16:00', duration: 75, customer: 'Èà¥Êú®Êßò', status: 'confirmed' },
                ],
                '2025-08-14': [
                    { time: '09:30', duration: 60, customer: 'È´òÊ©ãÊßò', status: 'cancelled' },
                ],
            };
        }

        // ÈÄ±Ë°®Á§∫„ÇíÊèèÁîª
        function renderWeekView() {
            updateWeekHeader();
            generateTimeSlots();
        }

        // ÈÄ±„ÅÆ„Éò„ÉÉ„ÉÄ„Éº„ÇíÊõ¥Êñ∞
        function updateWeekHeader() {
            const endDate = new Date(currentWeekStart);
            endDate.setDate(endDate.getDate() + 6);
            
            const startStr = formatDateShort(currentWeekStart);
            const endStr = formatDateShort(endDate);
            
            document.getElementById('currentWeek').textContent = 
                `${currentWeekStart.getFullYear()}Âπ¥ ${startStr} - ${endStr}`;
            
            // Êó•‰ªò„Éò„ÉÉ„ÉÄ„Éº„ÇíÊõ¥Êñ∞
            const headers = document.querySelectorAll('.day-header');
            for (let i = 0; i < headers.length; i++) {
                const date = new Date(currentWeekStart);
                date.setDate(date.getDate() + i);
                
                const dayName = dayNames[date.getDay()];
                const dateStr = `${date.getMonth() + 1}/${date.getDate()}`;
                
                // CSS„ÇØ„É©„Çπ„Çí„É™„Çª„ÉÉ„Éà
                headers[i].classList.remove('sunday', 'saturday');
                
                // Ê≠£„Åó„ÅÑCSS„ÇØ„É©„Çπ„ÇíËøΩÂä†
                if (date.getDay() === 0) {
                    headers[i].classList.add('sunday');
                } else if (date.getDay() === 6) {
                    headers[i].classList.add('saturday');
                }
                
                headers[i].innerHTML = `${dayName}<br><span style="font-size: 12px;">${dateStr}</span>`;
            }
        }

        // „Çø„Ç§„É†„Çπ„É≠„ÉÉ„Éà„ÇíÁîüÊàê
        function generateTimeSlots() {
            console.log('üîç generateTimeSlots called - defaultSchedule:', defaultSchedule);
            console.log('üîç generateTimeSlots - current reservations data:', reservations);
            console.log('üîç generateTimeSlots - reservation 97 data:', reservations['2025-08-13']?.find(r => r.id === 97));
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleBody.innerHTML = '';
            
            // 8:00„Åã„Çâ21:00„Åæ„Åß10ÂàÜÂàª„Åø„ÅßÁîüÊàê
            for (let hour = 8; hour <= 21; hour++) {
                for (let minute = 0; minute < 60; minute += 10) {
                    if (hour === 21 && minute > 0) break; // 21:00„ÅßÁµÇ‰∫Ü
                    
                    const timeStr = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                    
                    // Ë°å„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩúÊàê
                    const row = document.createElement('div');
                    row.className = 'schedule-row';
                    
                    // Ë°åÂÖ®‰Ωì„ÅÆ„Çπ„Çø„Ç§„É´„ÇíËøΩÂä†
                    if (minute === 0) {
                        row.classList.add('hour-row');
                    } else if (minute === 30) {
                        row.classList.add('half-hour-row');
                    }
                    
                    // ÊôÇÂàª„É©„Éô„É´
                    const timeSlot = document.createElement('div');
                    timeSlot.className = 'time-slot';
                    
                    // ÊôÇÈñì„Éû„Éº„Ç´„Éº„ÅÆ„Çπ„Çø„Ç§„É´„ÇíËøΩÂä†Ôºà10ÂàÜÂàª„Åø„Å´ÂØæÂøúÔºâ
                    if (minute === 0) {
                        timeSlot.classList.add('hour-marker');
                    } else if (minute === 30) {
                        timeSlot.classList.add('half-hour-marker');
                    }
                    
                    timeSlot.textContent = timeStr;
                    row.appendChild(timeSlot);
                    
                    // ÂêÑÊõúÊó•„ÅÆ„Çª„É´
                    for (let day = 0; day < 7; day++) {
                        const cell = document.createElement('div');
                        cell.className = 'schedule-cell';
                        cell.dataset.day = day;
                        cell.dataset.time = timeStr;
                        
                        // „Éâ„É≠„ÉÉ„Éó„Çæ„Éº„É≥„Å®„Åó„Å¶Ë®≠ÂÆö
                        cell.addEventListener('dragover', handleDragOver);
                        cell.addEventListener('drop', handleDrop);
                        cell.addEventListener('dragenter', handleDragEnter);
                        cell.addEventListener('dragleave', handleDragLeave);
                        
                        const currentDate = new Date(currentWeekStart);
                        currentDate.setDate(currentDate.getDate() + day);
                        const dateKey = formatDateKey(currentDate);
                        
                                                // Âñ∂Ê•≠ÊôÇÈñì„ÉÅ„Çß„ÉÉ„ÇØ
                        if (isBusinessHour(day, timeStr)) {
                            // ‰∫àÁ¥Ñ„ÉÅ„Çß„ÉÉ„ÇØ
                            const reservation = findReservation(dateKey, timeStr);
                            
                            // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞ÔºàÁâπÂÆö„ÅÆÊôÇÈñì„ÅÆ„ÅøÔºâ
                            if (timeStr === '10:00' && day === 1) {
                                console.log(`üîç Checking for reservation at ${dateKey} ${timeStr}:`, {
                                    dayReservations: reservations[dateKey] || [],
                                    foundReservation: reservation,
                                    isReservationStart: reservation ? isReservationStart(dateKey, timeStr) : false
                                });
                            }
                            
                            if (reservation) {
                                // ‰∫àÁ¥Ñ„ÅÆÈñãÂßã„Çπ„É≠„ÉÉ„Éà„ÅÆÂ†¥Âêà„ÅÆ„Åø„Éñ„É≠„ÉÉ„ÇØ„ÇíË°®Á§∫
                                if (isReservationStart(dateKey, timeStr)) {
                                    console.log('üéØ Creating reservation block for:', {
                                        id: reservation.id,
                                        customer: reservation.customer,
                                        userId: reservation.userId,
                                        date: dateKey,
                                        time: timeStr,
                                        effective_interval_minutes: reservation.effective_interval_minutes,
                                        individual_interval_minutes: reservation.individual_interval_minutes,
                                        duration: reservation.duration
                                    });
                                    const block = createSpanningReservationBlock(reservation, dateKey, timeStr);
                                    cell.appendChild(block);
                                    // ‰∫àÁ¥ÑË©≥Á¥∞„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                                    cell.addEventListener('click', (e) => {
                                        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„Åß„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíÂÆüË°å
                                        if (!isDragging) {
                                        openReservationDetailModal(reservation);
                                        }
                                    });
                                    
                                    // „Éâ„É©„ÉÉ„Ç∞„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†Ôºà„É°„Ç§„É≥„Éñ„É≠„ÉÉ„ÇØ„Å´ËøΩÂä†Ôºâ
                                    console.log('üéØ Setting up drag events for reservation:', reservation.id);
                                    block.addEventListener('dragstart', handleDragStart);
                                    block.addEventListener('dragend', handleDragEnd);
                                    
                                    // Also add drag over to the cell for visual feedback
                                    cell.addEventListener('dragover', handleDragOver);
                                    
                                    // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞ÔºàÁâπÂÆö„ÅÆ‰∫àÁ¥Ñ„ÅÆ„ÅøÔºâ
                                    if (reservation.customer === 'Áî∞‰∏≠Êßò') {
                                        console.log(`üîç Created reservation block for ${dateKey} ${timeStr}:`, reservation);
                                    }
                                }
    } else {
                                cell.classList.add('available', 'bookable');
                                // Êñ∞Ë¶è‰∫àÁ¥Ñ‰ΩúÊàê„ÅÆ„Åü„ÇÅ„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
                                cell.addEventListener('click', () => {
                                    const slotDate = new Date(currentWeekStart);
                                    slotDate.setDate(slotDate.getDate() + day);
                                    openBookingModal(slotDate, timeStr);
                                });
                            }
                        } else {
                            cell.classList.add('unavailable', 'outside-business-hours');
                        }
                        
                        row.appendChild(cell);
                    }
                    
                    scheduleBody.appendChild(row);
                }
            }
            
            // „Çπ„Ç±„Ç∏„É•„Éº„É´ÁîüÊàêÂæå„Å´„Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„ÇíÊõ¥Êñ∞
            setTimeout(() => {
                updateCancellationDisplayImmediately();
            }, 10);
        }

        // ÁèæÂú®„ÅÆÈÄ±„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÂèñÂæó
        function getCurrentWeekSchedule() {
            // ÂÆâÂÖ®„ÉÅ„Çß„ÉÉ„ÇØ: „Éá„Éï„Ç©„É´„Éà„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
            if (!defaultSchedule) {
                console.warn('‚ö†Ô∏è Default schedule not loaded, initializing fallback');
                initializeDefaultSchedule();
            }
            
            const weekKey = formatDateKey(currentWeekStart);
            if (!weeklySchedules[weekKey]) {
                // ÈÄ±Âõ∫Êúâ„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Éá„Éï„Ç©„É´„Éà„Çí‰ΩøÁî®Ôºà„Ç≥„Éî„Éº„ÅØ‰ΩúÊàê„Åó„Å™„ÅÑÔºâ
                console.log(`üîç No custom schedule for ${weekKey}, using default schedule`);
                return defaultSchedule;
            }
            
            console.log(`üîç Using custom schedule for ${weekKey}`);
            return weeklySchedules[weekKey];
        }

        // Âñ∂Ê•≠ÊôÇÈñì„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isBusinessHour(dayOfWeek, timeStr) {
            // ÁèæÂú®„ÅÆÈÄ±„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            const currentWeekSchedule = getCurrentWeekSchedule();
            const currentSchedule = currentWeekSchedule[dayOfWeek];
            
            // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞Ôºà18:20„ÅÆÊôÇÈñì„ÅÆ„ÅøÔºâ
            if (timeStr === '18:20') {
                console.log('üîç isBusinessHour debug for 18:20:', {
                    dayOfWeek,
                    currentSchedule,
                    currentWeekSchedule: Object.keys(currentWeekSchedule)
                });
            }
            
            // „Çπ„Ç±„Ç∏„É•„Éº„É´„ÅåÊúâÂäπ„ÅßÊôÇÈñìË®≠ÂÆö„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„ÉÅ„Çß„ÉÉ„ÇØ
            if (currentSchedule && currentSchedule.enabled && currentSchedule.times.length > 0) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                const timeInMinutes = hours * 60 + minutes;
                
                const isAvailable = currentSchedule.times.some(slot => {
                    const [startHour, startMin] = slot.start.split(':').map(Number);
                    const [endHour, endMin] = slot.end.split(':').map(Number);
                    const startInMinutes = startHour * 60 + startMin;
                    const endInMinutes = endHour * 60 + endMin;
                    
                    return timeInMinutes >= startInMinutes && timeInMinutes < endInMinutes;
                });
                
                // „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞ÔºàÁâπÂÆö„ÅÆÊôÇÈñì„ÅÆ„ÅøÔºâ
                if (timeStr === '10:00' && dayOfWeek === 1) {
                    console.log(`üîç Business hour check for Monday 10:00:`, {
                        schedule: currentSchedule,
                        timeInMinutes,
                        isAvailable,
                        scheduleType: currentWeekSchedule === defaultSchedule ? 'default' : 'custom'
                    });
                }
                
                return isAvailable;
            }
            
    return false;
  }
  
        // ‰∫àÁ¥Ñ„ÇíÊ§úÁ¥¢
        function findReservation(dateKey, timeStr) {
            const dayReservations = reservations[dateKey] || [];
            
            // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÁâπÂÆö„ÅÆ‰∫àÁ¥Ñ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if (dateKey === '2025-08-13' && timeStr === '10:00') {
                console.log('üîç findReservation called for 2025-08-13 10:00');
                console.log('üîç dayReservations:', dayReservations);
                console.log('üîç Looking for reservation 97:', dayReservations.find(r => r.id === 97));
            }
            return dayReservations.find(reservation => {
                const reservationTime = reservation.time;
                const [resHour, resMin] = reservationTime.split(':').map(Number);
                const [checkHour, checkMin] = timeStr.split(':').map(Number);
                
                const resTimeInMin = resHour * 60 + resMin;
                const checkTimeInMin = checkHour * 60 + checkMin;
                const preparationTime = reservation.effective_interval_minutes ?? 10; // ÂÆüÈöõ„ÅÆÊ∫ñÂÇôÊôÇÈñì„Çí‰ΩøÁî®
                const endTimeInMin = resTimeInMin + reservation.duration + preparationTime;
                
                // ÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÅÆÂ¢ÉÁïå„ÇíËÄÉÊÖÆ„Åó„Å¶„ÄÅÊ¨°„ÅÆÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„Å®„ÅÆÈáçË§á„ÇíÈÅø„Åë„Çã
                const nextHourInMin = Math.ceil(endTimeInMin / 60) * 60; // Ê¨°„ÅÆÊôÇÈñì„ÅÆÈñãÂßã
                const adjustedEndTimeInMin = Math.min(endTimeInMin, nextHourInMin);
                
                // „Éá„Éê„ÉÉ„Ç∞Áî®ÔºöÊôÇÈñìË®àÁÆó„ÇíÁ¢∫Ë™ç
                if (timeStr === '15:00' && reservation.customer === 'ÂêâÁî∞') {
                    console.log('üîç Time calculation debug:', {
                        reservationTime,
                        timeStr,
                        resTimeInMin,
                        checkTimeInMin,
                        duration: reservation.duration,
                        preparationTime,
                        endTimeInMin,
                        isOverlapping: checkTimeInMin >= resTimeInMin && checkTimeInMin < endTimeInMin
                    });
                }
                
                return checkTimeInMin >= resTimeInMin && checkTimeInMin < adjustedEndTimeInMin;
            });
        }

        // ‰∫àÁ¥Ñ„ÅÆÈñãÂßã„Çπ„É≠„ÉÉ„Éà„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isReservationStart(dateKey, timeStr) {
            const dayReservations = reservations[dateKey] || [];
            return dayReservations.some(reservation => {
                return reservation.time === timeStr;
            });
        }

        // ‰∫àÁ¥Ñ„ÅÆÁ∂ôÁ∂ö„Çπ„É≠„ÉÉ„Éà„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        function isReservationContinuation(dateKey, timeStr) {
            const dayReservations = reservations[dateKey] || [];
            return dayReservations.some(reservation => {
                const reservationTime = reservation.time;
                const [resHour, resMin] = reservationTime.split(':').map(Number);
                const [checkHour, checkMin] = timeStr.split(':').map(Number);
                
                const resTimeInMin = resHour * 60 + resMin;
                const checkTimeInMin = checkHour * 60 + checkMin;
                const endTimeInMin = resTimeInMin + reservation.duration;
                
                return checkTimeInMin > resTimeInMin && checkTimeInMin < endTimeInMin;
            });
        }

        // ‰∫àÁ¥Ñ„Éñ„É≠„ÉÉ„ÇØ„Çí‰ΩúÊàê
        function createReservationBlock(reservation) {
            const block = document.createElement('div');
            block.className = `reservation-block ${reservation.status}`;
            block.draggable = true;
            block.dataset.reservationId = reservation.id;
            block.dataset.reservationData = JSON.stringify(reservation);
            
            const statusIcon = {
                'tentative': '‚è≥',
                'confirmed': '‚úì',
                'completed': '‚úÖ'
            };
            
            block.innerHTML = `
                ${statusIcon[reservation.status] || ''} ${reservation.customer}
                <div style="font-size: 9px; opacity: 0.9;">${reservation.duration}ÂàÜ</div>
            `;
            
            return block;
        }

        // „Çπ„Éë„Éã„É≥„Ç∞‰∫àÁ¥Ñ„Éñ„É≠„ÉÉ„ÇØ„Çí‰ΩúÊàê
        function createSpanningReservationBlock(reservation, dateKey, timeStr) {
            console.log('üéØ Creating spanning block for reservation:', reservation.id, {
                effective_interval_minutes: reservation.effective_interval_minutes,
                individual_interval_minutes: reservation.individual_interval_minutes,
                duration: reservation.duration
            });
            const block = document.createElement('div');
            block.className = `reservation-block spanning ${reservation.status}`;
            block.draggable = true; // „É°„Ç§„É≥„Éñ„É≠„ÉÉ„ÇØ„Çí„Éâ„É©„ÉÉ„Ç∞ÂèØËÉΩ„Å´Â§âÊõ¥
            block.dataset.reservationId = reservation.id;
            block.dataset.reservationData = JSON.stringify(reservation);
            block.dataset.originalDateKey = dateKey;
            block.dataset.originalTimeStr = timeStr;
            
            const statusIcon = {
                'tentative': '‚è≥',
                'confirmed': '‚úì',
                'completed': '‚úÖ'
            };
            
            // ‰∫àÁ¥Ñ„ÅÆÁ∂ôÁ∂öÊôÇÈñì„Å´Âü∫„Å•„ÅÑ„Å¶È´ò„Åï„ÇíË®àÁÆóÔºàÊ≠£Á¢∫„Å™ÊôÇÈñì + Ê∫ñÂÇôÊôÇÈñìÔºâ
            const durationInMinutes = reservation.duration;
            const preparationTime = reservation.effective_interval_minutes ?? 10; // Ê∫ñÂÇôÊôÇÈñìÔºàÂàÜÔºâ
            const totalTime = durationInMinutes + preparationTime;
                         const rowHeight = 20; // ÂêÑÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÅÆÈ´ò„ÅïÔºà10ÂàÜÈñìÔºâ
            const exactHeight = (totalTime / 10) * rowHeight; // Ê≠£Á¢∫„Å™È´ò„Åï„ÇíË®àÁÆó
            
            block.style.height = `${exactHeight}px`;
            block.style.top = '0';
            
            // Ê∫ñÂÇôÊôÇÈñìÈÉ®ÂàÜ„ÇíË¶ñË¶öÁöÑ„Å´Âå∫Âà•
            const bookingHeight = (durationInMinutes / 10) * rowHeight;
            const preparationHeight = (preparationTime / 10) * rowHeight;
            
            // ÈñãÂßãÊôÇÈñì„Å®ÁµÇ‰∫ÜÊôÇÈñì„ÇíË®àÁÆó
            const [startHour, startMin] = timeStr.split(':').map(Number);
            const startTimeInMinutes = startHour * 60 + startMin;
            const endTimeInMinutes = startTimeInMinutes + reservation.duration;
            
            const startTime = `${String(Math.floor(startTimeInMinutes / 60)).padStart(2, '0')}:${String(startTimeInMinutes % 60).padStart(2, '0')}`;
            const endTime = `${String(Math.floor(endTimeInMinutes / 60)).padStart(2, '0')}:${String(endTimeInMinutes % 60).padStart(2, '0')}`;
            
            // Ê∫ñÂÇôÊôÇÈñì„Åå0„ÅÆÂ†¥Âêà„ÅØÊ∫ñÂÇôÊôÇÈñì„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫„Åó„Å™„ÅÑ
            const preparationSection = preparationTime > 0 ? `
                <div style="height: ${preparationHeight}px; background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1)); display: flex; align-items: center; justify-content: center; font-size: 9px; border-top: 1px solid rgba(255,255,255,0.3); backdrop-filter: blur(1px); position: absolute; left: 0; right: 0; bottom: 0; width: 100%;">
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);"></div>
                    <span style="background: rgba(255,255,255,0.25); padding: 3px 10px; border-radius: 15px; font-weight: 600; font-size: 8px; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">${preparationTime}ÂàÜ</span>
                </div>
            ` : '';
            
            block.innerHTML = `
                <div style="height: ${preparationTime > 0 ? bookingHeight : exactHeight}px; display: flex; flex-direction: column; justify-content: center; padding: 8px; position: relative;">

                    <div style="font-size: 12px; font-weight: 600; margin-bottom: 4px; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                        ${statusIcon[reservation.status] || ''} ${reservation.customer}
      </div>
                    <div style="font-size: 10px; opacity: 0.9; background: rgba(255,255,255,0.2); padding: 2px 6px; border-radius: 10px; display: inline-block; backdrop-filter: blur(2px); margin-bottom: 4px;">
                        ${reservation.duration}ÂàÜ
    </div>
                    <div style="font-size: 9px; opacity: 0.8; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 8px; display: inline-block; backdrop-filter: blur(1px);">
                        ${startTime} - ${endTime}
        </div>
        </div>
                ${preparationSection}
    `;
            
            return block;
        }

        // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openSettingsModal() {
            document.getElementById('settingsModal').style.display = 'block';
            renderDaySettings();
        }

        // Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        // „Çø„ÉñÂàá„ÇäÊõø„Åà
        function switchTab(tabName) {
            // „Çø„Éñ„Éú„Çø„É≥„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            // „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆË°®Á§∫Âàá„ÇäÊõø„Åà
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            if (tabName === 'recurring') {
                renderRecurringDaySettings();
            }
        }

        // ÊõúÊó•Âà•Ë®≠ÂÆö„ÇíÊèèÁîª
        function renderDaySettings() {
            // ÈÄ±ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
            updateWeekInfo();
            
            const container = document.getElementById('daySettings');
            container.innerHTML = '';
            
            for (let day = 0; day < 7; day++) {
                const dayDiv = createDaySettingDiv(day, false);
                container.appendChild(dayDiv);
            }
        }

        // ÂÆöÊúüÁöÑ„Å™Ë®≠ÂÆö„ÇíÊèèÁîª
        function renderRecurringDaySettings() {
            const container = document.getElementById('recurringDaySettings');
            container.innerHTML = '';
            
            for (let day = 0; day < 7; day++) {
                const dayDiv = createDaySettingDiv(day, true);
                container.appendChild(dayDiv);
            }
        }

        // ÈÄ±ÊÉÖÂ†±„ÇíÊõ¥Êñ∞
        function updateWeekInfo() {
            const weekStartStr = formatDateKey(currentWeekStart);
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const weekEndStr = formatDateKey(weekEnd);
            
            const currentWeekDisplay = document.getElementById('current-week-display');
            const scheduleTypeInfo = document.getElementById('schedule-type-info');
            
            if (currentWeekDisplay) {
                currentWeekDisplay.textContent = `${weekStartStr} „Äú ${weekEndStr}`;
            }
            
            if (scheduleTypeInfo) {
                const hasCustomSchedule = weeklySchedules[weekStartStr] && 
                    JSON.stringify(weeklySchedules[weekStartStr]) !== JSON.stringify(defaultSchedule);
                
                if (hasCustomSchedule) {
                    scheduleTypeInfo.textContent = '‚úÖ „Åì„ÅÆÈÄ±„Å´„ÅØ„Ç´„Çπ„Çø„É†„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô';
                    scheduleTypeInfo.style.color = '#28a745';
                } else {
                    scheduleTypeInfo.textContent = '‚ÑπÔ∏è „Åì„ÅÆÈÄ±„Å´„ÅØ„Éá„Éï„Ç©„É´„Éà„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅåÈÅ©Áî®„Åï„Çå„Å¶„ÅÑ„Åæ„Åô';
                    scheduleTypeInfo.style.color = '#6c757d';
                }
            }
        }

        // ÊõúÊó•Ë®≠ÂÆöDIV„Çí‰ΩúÊàê
        function createDaySettingDiv(day, isRecurring) {
            // ÂÆâÂÖ®„ÉÅ„Çß„ÉÉ„ÇØ: „Çπ„Ç±„Ç∏„É•„Éº„É´„Éá„Éº„Çø„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç
            if (!defaultSchedule || !defaultSchedule[day]) {
                console.warn(`‚ö†Ô∏è Schedule data not loaded for day ${day}, using fallback`);
                return createFallbackDaySettingDiv(day, isRecurring);
            }
            
            const schedule = isRecurring ? defaultSchedule[day] : getCurrentWeekSchedule()[day];
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day-setting';
            
            const headerClass = day === 0 ? 'sunday' : day === 6 ? 'saturday' : '';
            
            dayDiv.innerHTML = `
                <div class="day-setting-header ${headerClass}">
                    <span>${dayNamesLong[day]}</span>
                    <div class="day-toggle ${schedule.enabled ? 'active' : ''}" onclick="toggleDay(${day}, ${isRecurring})"></div>
        </div>
                <div class="time-slots-container" style="display: ${schedule.enabled ? 'block' : 'none'};">
                    <div id="timeSlots-${day}-${isRecurring}" class="time-slots">
                        ${renderTimeSlots(day, schedule.times, isRecurring)}
        </div>
                    <button class="add-time-btn" onclick="addTimeSlot(${day}, ${isRecurring})">
                        + ÊôÇÈñìÂ∏Ø„ÇíËøΩÂä†
          </button>
        </div>
  `;
            
            return dayDiv;
        }

        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®„ÅÆÊõúÊó•Ë®≠ÂÆöDIV„Çí‰ΩúÊàê
        function createFallbackDaySettingDiv(day, isRecurring) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'day-setting';
            
            const headerClass = day === 0 ? 'sunday' : day === 6 ? 'saturday' : '';
            
            dayDiv.innerHTML = `
                <div class="day-setting-header ${headerClass}">
                    <span>${dayNamesLong[day]}</span>
                    <div class="day-toggle" onclick="toggleDay(${day}, ${isRecurring})"></div>
      </div>
                <div class="time-slots-container" style="display: none;">
                    <div id="timeSlots-${day}-${isRecurring}" class="time-slots">
                        <!-- „Éá„Éº„ÇøË™≠„ÅøËæº„Åø‰∏≠ -->
                    </div>
                    <button class="add-time-btn" onclick="addTimeSlot(${day}, ${isRecurring})">
                        + ÊôÇÈñìÂ∏Ø„ÇíËøΩÂä†
                    </button>
    </div>
  `;
            
            return dayDiv;
        }

        // ÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÇíÊèèÁîª
        function renderTimeSlots(day, times, isRecurring = false) {
            return times.map((time, index) => `
                <div class="time-slot-input">
                    <input type="time" class="time-input" value="${time.start}" 
                           onchange="(async () => { await updateTimeSlot(${day}, ${index}, 'start', this.value, ${isRecurring}); })()">
                    <span>„Äú</span>
                    <input type="time" class="time-input" value="${time.end}"
                           onchange="(async () => { await updateTimeSlot(${day}, ${index}, 'end', this.value, ${isRecurring}); })()">
                    <button class="btn btn-danger btn-sm" onclick="removeTimeSlot(${day}, ${index}, ${isRecurring})">ÂâäÈô§</button>
                </div>
            `).join('');
        }

        // ÊõúÊó•„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÂàá„ÇäÊõø„Åà
        function toggleDay(day, isRecurring) {
            console.log(`Toggling day ${day} (${dayNamesLong[day]}) for recurring: ${isRecurring}`);
            
            if (isRecurring) {
                // ÂÆöÊúüÁöÑ„Å™„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅÆÂ†¥Âêà
                defaultSchedule[day].enabled = !defaultSchedule[day].enabled;
            } else {
                // ÁèæÂú®„ÅÆÈÄ±„ÅÆÂ†¥Âêà„ÄÅ„Ç´„Çπ„Çø„É†„Çπ„Ç±„Ç∏„É•„Éº„É´„Çí‰ΩúÊàê
                const weekKey = formatDateKey(currentWeekStart);
                if (!weeklySchedules[weekKey]) {
                    weeklySchedules[weekKey] = JSON.parse(JSON.stringify(defaultSchedule));
                    console.log(`üîç Created custom schedule for week ${weekKey}`);
                }
                weeklySchedules[weekKey][day].enabled = !weeklySchedules[weekKey][day].enabled;
            }
            
            const toggle = document.querySelector(`[onclick="toggleDay(${day}, ${isRecurring})"]`);
            const timeSlotsContainer = toggle.parentElement.nextElementSibling;
            
            const schedule = isRecurring ? defaultSchedule[day] : getCurrentWeekSchedule()[day];
            
            if (schedule.enabled) {
                toggle.classList.add('active');
                timeSlotsContainer.style.display = 'block';
                
                // ÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„Åå„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†
                if (schedule.times.length === 0) {
                    schedule.times.push({ start: '09:00', end: '18:00' });
                }
                
                // ÁèæÂú®„ÅÆ„Çø„Éñ„ÅÆ„Ç≥„É≥„ÉÜ„Éä„ÅÆ„ÅøÊõ¥Êñ∞
                const slotsContainer = document.getElementById(`timeSlots-${day}-${isRecurring}`);
                if (slotsContainer) {
                    slotsContainer.innerHTML = renderTimeSlots(day, schedule.times, isRecurring);
                }
            } else {
                toggle.classList.remove('active');
                timeSlotsContainer.style.display = 'none';
            }
            
            console.log(`Day ${day} (${dayNamesLong[day]}) is now ${schedule.enabled ? 'enabled' : 'disabled'} for ${isRecurring ? 'recurring' : 'current week'}`);
        }

        // ÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÇíËøΩÂä†
        function addTimeSlot(day, isRecurring) {
            if (isRecurring) {
                defaultSchedule[day].times.push({ start: '09:00', end: '18:00' });
            } else {
                // ÁèæÂú®„ÅÆÈÄ±„ÅÆÂ†¥Âêà„ÄÅ„Ç´„Çπ„Çø„É†„Çπ„Ç±„Ç∏„É•„Éº„É´„Çí‰ΩúÊàê
                const weekKey = formatDateKey(currentWeekStart);
                if (!weeklySchedules[weekKey]) {
                    weeklySchedules[weekKey] = JSON.parse(JSON.stringify(defaultSchedule));
                    console.log(`üîç Created custom schedule for week ${weekKey}`);
                }
                weeklySchedules[weekKey][day].times.push({ start: '09:00', end: '18:00' });
            }
            
            // ÁèæÂú®„ÅÆ„Çø„Éñ„ÅÆ„Ç≥„É≥„ÉÜ„Éä„ÅÆ„ÅøÊõ¥Êñ∞
            const slotsContainer = document.getElementById(`timeSlots-${day}-${isRecurring}`);
            if (slotsContainer) {
                const schedule = isRecurring ? defaultSchedule[day] : getCurrentWeekSchedule()[day];
                slotsContainer.innerHTML = renderTimeSlots(day, schedule.times, isRecurring);
            }
        }

        // ÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÇíÂâäÈô§
        function removeTimeSlot(day, index, isRecurring = false) {
            if (isRecurring) {
                defaultSchedule[day].times.splice(index, 1);
            } else {
                // ÁèæÂú®„ÅÆÈÄ±„ÅÆÂ†¥Âêà„ÄÅ„Ç´„Çπ„Çø„É†„Çπ„Ç±„Ç∏„É•„Éº„É´„Çí‰ΩúÊàê
                const weekKey = formatDateKey(currentWeekStart);
                if (!weeklySchedules[weekKey]) {
                    weeklySchedules[weekKey] = JSON.parse(JSON.stringify(defaultSchedule));
                    console.log(`üîç Created custom schedule for week ${weekKey}`);
                }
                weeklySchedules[weekKey][day].times.splice(index, 1);
            }
            
            // ÁèæÂú®„ÅÆ„Çø„Éñ„ÅÆ„Ç≥„É≥„ÉÜ„Éä„ÅÆ„ÅøÊõ¥Êñ∞
            const slotsContainer = document.getElementById(`timeSlots-${day}-${isRecurring}`);
            if (slotsContainer) {
                const schedule = isRecurring ? defaultSchedule[day] : getCurrentWeekSchedule()[day];
                slotsContainer.innerHTML = renderTimeSlots(day, schedule.times, isRecurring);
            }
        }

        // ÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„ÇíÊõ¥Êñ∞
        async function updateTimeSlot(day, index, field, value, isRecurring = false) {
            // Â§âÊõ¥Ââç„ÅÆÂÄ§„Çí‰øùÂ≠ò
            let oldValue;
            if (isRecurring) {
                oldValue = defaultSchedule[day].times[index][field];
            } else {
                const weekKey = formatDateKey(currentWeekStart);
                if (!weeklySchedules[weekKey]) {
                    weeklySchedules[weekKey] = JSON.parse(JSON.stringify(defaultSchedule));
                }
                oldValue = weeklySchedules[weekKey][day].times[index][field];
            }
            
            // Êñ∞„Åó„ÅÑÂÄ§„ÇíË®≠ÂÆö
            if (isRecurring) {
                defaultSchedule[day].times[index][field] = value;
            } else {
                const weekKey = formatDateKey(currentWeekStart);
                if (!weeklySchedules[weekKey]) {
                    weeklySchedules[weekKey] = JSON.parse(JSON.stringify(defaultSchedule));
                    console.log(`üîç Created custom schedule for week ${weekKey}`);
                }
                weeklySchedules[weekKey][day].times[index][field] = value;
            }
            
            // Âñ∂Ê•≠ÊôÇÈñì„ÅÆÂ§âÊõ¥ÔºàÁü≠Á∏Æ„ÉªÊã°ÂºµÔºâ„ÅÆÂ†¥Âêà„ÄÅÂΩ±Èüø„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            if ((field === 'end' && parseInt(value) < parseInt(oldValue)) || 
                (field === 'start' && parseInt(value) > parseInt(oldValue)) ||
                (field === 'end' && parseInt(value) > parseInt(oldValue)) || 
                (field === 'start' && parseInt(value) < parseInt(oldValue))) {
                console.log(`üîç Checking impact of changing business hours for day ${day} from ${oldValue} to ${value} (${field})`);
                
                // ÂΩ±Èüø„ÇíÂèó„Åë„Çã‰∫àÁ¥Ñ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                const affectedReservations = checkShiftChangeImpact(day, oldValue, value, field);
                
                if (affectedReservations.length > 0) {
                    // ÂΩ±Èüø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
                    const confirmed = await showShiftChangeConfirmation(affectedReservations, day, oldValue, value, field);
                    if (!confirmed) {
                        // „Ç≠„É£„É≥„Çª„É´„Åï„Çå„ÅüÂ†¥Âêà„ÅØÂÖÉ„ÅÆÂÄ§„Å´Êàª„Åô
                        if (isRecurring) {
                            defaultSchedule[day].times[index][field] = oldValue;
                        } else {
                            const weekKey = formatDateKey(currentWeekStart);
                            weeklySchedules[weekKey][day].times[index][field] = oldValue;
                        }
                        return;
                    }
                }
            }
        }

        // Ë®≠ÂÆö„Çí‰øùÂ≠ò
        function saveSettings() {
            // ÁèæÂú®„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çø„Éñ„ÇíÁ¢∫Ë™ç
            const activeTab = document.querySelector('.tab-button.active');
            const isRecurring = activeTab && activeTab.textContent.includes('ÂÆöÊúüÁöÑ„Å™„Çπ„Ç±„Ç∏„É•„Éº„É´');
            
            console.log('üîç Active tab:', activeTab ? activeTab.textContent : 'none');
            console.log('üîç isRecurring:', isRecurring);
            
            const scheduleData = isRecurring ? defaultSchedule : getCurrentWeekSchedule();
            const weekStartStr = formatDateKey(currentWeekStart);
            
            console.log('üîÑ Saving shift settings:', {
                isRecurring,
                weekStartStr,
                scheduleData
            });
            
            // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´‰øùÂ≠ò
            fetch('/admin/reservations/save_shift_settings', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
                },
                body: JSON.stringify({
                    schedule_data: scheduleData,
                    is_recurring: isRecurring,
                    week_start_date: weekStartStr
                })
            })
            .then(response => response.json())
  .then(data => {
    if (data.success) {
                    console.log('‚úÖ Shift settings saved successfully');
                    
                    // Ë°®Á§∫„ÇíÊõ¥Êñ∞
                    renderWeekView();
                    closeSettingsModal();
                    
                    // ‰øùÂ≠òÂÆå‰∫Ü„É°„ÉÉ„Çª„Éº„Ç∏
                    const message = isRecurring 
                        ? 'ÂÆöÊúüÁöÑ„Å™„Çπ„Ç±„Ç∏„É•„Éº„É´„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Åì„ÅÆË®≠ÂÆö„ÅØÂÖ®„Å¶„ÅÆÈÄ±„Å´ÈÅ©Áî®„Åï„Çå„Åæ„Åô„ÄÇ'
                        : 'Ë®≠ÂÆö„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„Åü„ÄÇ„Åì„ÅÆË®≠ÂÆö„ÅØÁèæÂú®„ÅÆÈÄ±„ÅÆ„Åø„Å´ÈÅ©Áî®„Åï„Çå„Åæ„Åô„ÄÇ';
                    showMessage(message, 'success');
    } else {
                    console.error('‚ùå Failed to save shift settings:', data.message);
                    showMessage(`„Ç∑„Éï„ÉàË®≠ÂÆö„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${data.message}`, 'error');
    }
  })
  .catch(error => {
                console.error('‚ùå Error saving shift settings:', error);
                showMessage('„Ç∑„Éï„ÉàË®≠ÂÆö„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
            });
        }

        // ÂâçÈÄ±„Å∏
        function previousWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            Promise.all([
                loadShiftSettingsFromBackend(),
                loadReservationsFromBackend()
            ]).then(() => {
                renderWeekView();
                updateCancellationDisplay(); // „Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥„ÇíÊõ¥Êñ∞
            });
        }

        // Ê¨°ÈÄ±„Å∏
        function nextWeek() {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            Promise.all([
                loadShiftSettingsFromBackend(),
                loadReservationsFromBackend()
            ]).then(() => {
                renderWeekView();
                updateCancellationDisplay(); // „Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥„ÇíÊõ¥Êñ∞
            });
        }

        // Êó•‰ªò„Çí„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàÁü≠Á∏ÆÁâàÔºâ
        function formatDateShort(date) {
            return `${date.getMonth() + 1}Êúà${date.getDate()}Êó•`;
        }
        
        // „Ç∑„Éï„ÉàÂ§âÊõ¥„ÅÆÂΩ±Èüø„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        function checkShiftChangeImpact(day, oldTime, newTime, field) {
            const affectedReservations = [];
            const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
            
            console.log(`üîç checkShiftChangeImpact called with: day=${day} (${dayNames[day]}), oldTime=${oldTime}, newTime=${newTime}, field=${field}`);
            console.log(`üîç All reservations:`, reservations);
            
            // ÂÖ®„Å¶„ÅÆ‰∫àÁ¥Ñ„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÈÄ±„Å´Èñ¢‰øÇ„Å™„ÅèÔºâ
            Object.keys(reservations).forEach(weekKey => {
                const weekReservations = reservations[weekKey] || [];
                
                weekReservations.forEach(reservation => {
                    // ÈÄ±„ÅÆ„Ç≠„Éº„Åã„ÇâÊó•‰ªò„ÇíÂèñÂæó
                    const reservationDate = new Date(weekKey);
                    const reservationDayOfWeek = reservationDate.getDay();
                    
                    console.log(`üîç Checking reservation: ${reservation.id} on ${weekKey} (day ${reservationDayOfWeek}) vs target day ${day}`);
                    
                    // Âêå„ÅòÊõúÊó•„ÅÆ‰∫àÁ¥Ñ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    if (reservationDayOfWeek === day) {
                        const [startHour, startMin] = reservation.time.split(':').map(Number);
                        const reservationStartInMin = startHour * 60 + startMin;
                        const reservationEndInMin = reservationStartInMin + reservation.duration;
                        console.log(`üîç Reservation time: ${reservation.time} (start: ${reservationStartInMin} min, duration: ${reservation.duration} min, end: ${reservationEndInMin} min)`);
                        
                        let isAffected = false;
                        
                        if (field === 'end') {
                            if (parseInt(newTime) < parseInt(oldTime)) {
                                // Êñ∞„Åó„ÅÑÁµÇ‰∫ÜÊôÇÈñìÔºàÂàÜÂçò‰ΩçÔºâ
                                let newEndInMin;
                                if (String(newTime).includes(':')) {
                                    const [h, m] = String(newTime).split(':').map(Number);
                                    newEndInMin = h * 60 + (isNaN(m) ? 0 : m);
                                } else {
                                    newEndInMin = parseInt(newTime) * 60;
                                }
                                // ÁµÇ‰∫ÜÊôÇÈñì„ÅåÁü≠Á∏Æ„Åï„Çå„ÇãÂ†¥Âêà - ‰∫àÁ¥Ñ„ÅåÊñ∞„Åó„ÅÑÁµÇ‰∫ÜÊôÇÈñì„ÇíË∂Ö„Åà„ÇãÂ†¥Âêà
                                isAffected = reservationEndInMin > newEndInMin;
                                console.log(`üîç End time shrinking check: reservation ends at ${reservationEndInMin} min, new end time is ${newEndInMin} min = ${isAffected}`);
                            } else {
                                // ÁµÇ‰∫ÜÊôÇÈñì„ÅåÊã°Âºµ„Åï„Çå„ÇãÂ†¥Âêà
                                isAffected = reservationHour >= parseInt(oldTime) && reservationHour < parseInt(newTime);
                                console.log(`üîç End time expanding check: ${reservationHour} >= ${parseInt(oldTime)} AND ${reservationHour} < ${parseInt(newTime)} = ${isAffected}`);
                            }
                        } else if (field === 'start') {
                            if (parseInt(newTime) > parseInt(oldTime)) {
                                // ÈñãÂßãÊôÇÈñì„ÅåÈÅÖ„Åè„Å™„ÇãÂ†¥Âêà
                                isAffected = reservationHour < parseInt(newTime);
                                console.log(`üîç Start time delaying check: ${reservationHour} < ${parseInt(newTime)} = ${isAffected}`);
                            } else {
                                // ÈñãÂßãÊôÇÈñì„ÅåÊó©„Åè„Å™„ÇãÂ†¥Âêà
                                isAffected = reservationHour >= parseInt(newTime) && reservationHour < parseInt(oldTime);
                                console.log(`üîç Start time advancing check: ${reservationHour} >= ${parseInt(newTime)} AND ${reservationHour} < ${parseInt(oldTime)} = ${isAffected}`);
                            }
                        }
                        
                        if (isAffected) {
                            affectedReservations.push({
                                id: reservation.id,
                                customer: reservation.customer,
                                start_time: reservation.time,
                                end_time: `${reservationEndHour}:00`,
                                date: weekKey,
                                dayName: dayNames[day]
                            });
                            console.log(`üîç Added affected reservation: ${reservation.id}`);
                        }
                    }
                });
            });
            
            console.log(`üîç Found ${affectedReservations.length} affected reservations for day ${day} (${dayNames[day]}) - ${field} time change`);
            return affectedReservations;
        }
        
        // „Ç∑„Éï„ÉàÂ§âÊõ¥„ÅÆÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
        function showShiftChangeConfirmation(affectedReservations, day, oldTime, newTime, field) {
            return new Promise((resolve) => {
                const dayNames = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
                const fieldName = field === 'start' ? 'ÈñãÂßãÊôÇÈñì' : 'ÁµÇ‰∫ÜÊôÇÈñì';
                
                // Êó¢Â≠ò„ÅÆ„É¢„Éº„ÉÄ„É´„Åå„ÅÇ„Çå„Å∞ÂâäÈô§
                const existingModal = document.getElementById('shiftChangeModal');
                if (existingModal) {
                    existingModal.remove();
                }
                
                const modal = document.createElement('div');
                modal.id = 'shiftChangeModal';
                modal.className = 'modal fade';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-labelledby', 'shiftChangeModalLabel');
                modal.setAttribute('aria-hidden', 'true');
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-warning text-dark">
                                <h5 class="modal-title" id="shiftChangeModalLabel">‚ö†Ô∏è Âñ∂Ê•≠ÊôÇÈñìÂ§âÊõ¥„ÅÆÁ¢∫Ë™ç</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-warning mb-1">
                                    <strong>Âñ∂Ê•≠ÊôÇÈñì„ÅÆÂ§âÊõ¥„Å´„Çà„ÇäÂΩ±Èüø„ÇíÂèó„Åë„Çã‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åô:</strong><br>
                                    ${dayNames[day]}ÊõúÊó• ${fieldName}: ${oldTime}:00 ‚Üí ${newTime}:00
                                </div>
                                
                                <div class="table-responsive mb-1" style="max-height: 300px; overflow-y: hidden;">
                                    <table class="table table-sm mb-0">
                                        <thead>
                                            <tr>
                                                <th style="font-size: 1rem; padding: 0.3rem;">Êó•ÊôÇ</th>
                                                <th style="font-size: 1rem; padding: 0.3rem;">„ÅäÂÆ¢Êßò</th>
                                                <th style="font-size: 1rem; padding: 0.3rem;">ÊôÇÈñì</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${affectedReservations.map(reservation => `
                                                <tr>
                                                    <td style="font-size: 1rem; padding: 0.3rem;">${reservation.date}</td>
                                                    <td style="font-size: 1rem; padding: 0.3rem;">${reservation.customer}</td>
                                                    <td style="font-size: 1rem; padding: 0.3rem;">${reservation.start_time}-${reservation.end_time}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <div class="alert alert-danger mb-0">
                                    <strong>„Ç®„É©„Éº:</strong> Âñ∂Ê•≠ÊôÇÈñì„ÇíÂ§âÊõ¥„Åô„Çã„Å®„ÄÅ„Åì„Çå„Çâ„ÅÆ‰∫àÁ¥Ñ„ÅåÂñ∂Ê•≠ÊôÇÈñìÂ§ñ„Å´„Å™„Å£„Å¶„Åó„Åæ„ÅÑ„Åæ„Åô„ÄÇÂ§âÊõ¥„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" id="cancelShiftChange">OK</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
                const cancelBtn = modal.querySelector('#cancelShiftChange');
                const closeBtn = modal.querySelector('.btn-close');
                
                cancelBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });
                
                closeBtn.addEventListener('click', () => {
                    modal.remove();
                    resolve(false);
                });
                
                // „É¢„Éº„ÉÄ„É´„ÅÆÂ§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
                modal.addEventListener('click', (event) => {
                    if (event.target === modal) {
                        modal.remove();
                        resolve(false);
                    }
                });
                
                // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
                modal.style.display = 'block';
                modal.classList.add('show');
                modal.setAttribute('aria-modal', 'true');
                modal.setAttribute('role', 'dialog');
                
                // ËÉåÊôØ„ÇíÊöó„Åè„Åô„Çã
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop fade show';
                backdrop.id = 'shiftChangeBackdrop';
                document.body.appendChild(backdrop);
                
                        // ESC„Ç≠„Éº„ÅßÈñâ„Åò„Çã
        const handleEscKey = (event) => {
            if (event.key === 'Escape') {
                modal.remove();
                backdrop.remove();
                document.removeEventListener('keydown', handleEscKey);
                resolve(false);
            }
        };
        document.addEventListener('keydown', handleEscKey);
        
        // „É¢„Éº„ÉÄ„É´„Å®„Éê„ÉÉ„ÇØ„Éâ„É≠„ÉÉ„Éó„ÇíÂâäÈô§„Åô„ÇãÈñ¢Êï∞
        const cleanup = () => {
            if (modal) modal.remove();
            if (backdrop) backdrop.remove();
            document.removeEventListener('keydown', handleEscKey);
        };
        
        // „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„ÇíË®≠ÂÆö
        cancelBtn.addEventListener('click', cleanup);
        closeBtn.addEventListener('click', cleanup);
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                cleanup();
                resolve(false);
            }
        });
    });
        }

        // Êó•‰ªò„Ç≠„Éº„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
        function formatDateKey(date) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
function showMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 2000;
                padding: 12px 20px;
                border-radius: 6px;
                color: white;
                font-weight: 500;
                animation: slideInRight 0.3s ease;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#007bff'};
                color: ${type === 'warning' ? '#212529' : 'white'};
            `;
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
  setTimeout(() => {
                messageDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => document.body.removeChild(messageDiv), 300);
  }, 3000);
}

        // „É¢„Éº„ÉÄ„É´„ÅÆÂ§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettingsModal();
            }
            
            // „Éü„Éã„Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÂ§ñÂÅ¥„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
            const miniCalendar = document.getElementById('miniCalendar');
            const miniCalendarContainer = document.querySelector('.mini-calendar-container');
            if (miniCalendar && !miniCalendarContainer.contains(event.target)) {
                miniCalendar.classList.remove('show');
            }
        }

        // „Éü„Éã„Ç´„É¨„É≥„ÉÄ„ÉºÈñ¢ÈÄ£„ÅÆÈñ¢Êï∞
        function toggleMiniCalendar() {
            const miniCalendar = document.getElementById('miniCalendar');
            miniCalendar.classList.toggle('show');
        }

        function renderMiniCalendar() {
            const year = miniCalendarMonth.getFullYear();
            const month = miniCalendarMonth.getMonth();
            
            console.log('üìÖ Rendering mini calendar for:', year, 'Âπ¥', monthNames[month]);
            
            // „Çø„Ç§„Éà„É´„ÇíÊõ¥Êñ∞
            document.getElementById('miniCalendarTitle').textContent = 
                `${year}Âπ¥ ${monthNames[month]}`;
            
            // Êúà„ÅÆÊúÄÂàù„ÅÆÊó•„Å®ÊúÄÂæå„ÅÆÊó•„ÇíÂèñÂæó
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // ÊúÄÂàù„ÅÆÈÄ±„ÅÆÈñãÂßãÊó•„ÇíÂèñÂæóÔºàÊó•ÊõúÊó•„Åã„ÇâÔºâ
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            // ÊúÄÂæå„ÅÆÈÄ±„ÅÆÁµÇ‰∫ÜÊó•„ÇíÂèñÂæóÔºàÂúüÊõúÊó•„Åæ„ÅßÔºâ
            const endDate = new Date(lastDay);
            endDate.setDate(endDate.getDate() + (6 - lastDay.getDay()));
            
            const daysContainer = document.getElementById('miniCalendarDays');
            daysContainer.innerHTML = '';
            
            // „Ç´„É¨„É≥„ÉÄ„Éº„ÅÆÊó•‰ªò„Çª„É´„ÇíÁîüÊàê
            const current = new Date(startDate);
            while (current <= endDate) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'mini-calendar-day';
                dayDiv.textContent = current.getDate();
                
                // ‰ªäÊúà‰ª•Â§ñ„ÅÆÊó•‰ªò
                if (current.getMonth() !== month) {
                    dayDiv.classList.add('other-month');
                }
                
                // ‰ªäÊó•„ÅÆÊó•‰ªò
                const today = new Date();
                if (current.toDateString() === today.toDateString()) {
                    dayDiv.classList.add('today');
                }
                
                // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÊó•‰ªò„Çí„Éè„Ç§„É©„Ç§„Éà
                if (clickedDate && 
                    current.getFullYear() === clickedDate.getFullYear() && 
                    current.getMonth() === clickedDate.getMonth() && 
                    current.getDate() === clickedDate.getDate()) {
                    dayDiv.classList.add('clicked-day');
                }
                
                // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà - ÂÆâÂÖ®„Å™Êó•‰ªò„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Çí‰ΩúÊàê
                const clickDate = new Date(current.getFullYear(), current.getMonth(), current.getDate(), 12, 0, 0, 0);
                dayDiv.addEventListener('click', () => {
                    selectWeekFromDate(clickDate);
                });
                
                daysContainer.appendChild(dayDiv);
                current.setDate(current.getDate() + 1);
            }
        }

        function selectWeekFromDate(date) {
            console.log('üîç Original clicked date:', date);
            console.log('üîç Date details:', {
                year: date.getFullYear(),
                month: date.getMonth() + 1,
                date: date.getDate(),
                dayOfWeek: date.getDay(),
                toString: date.toString()
            });
            
            // Êó•‰ªò„ÇíÂÆâÂÖ®„Å´Âá¶ÁêÜ - „Çø„Ç§„É†„Çæ„Éº„É≥„ÅÆÂΩ±Èüø„ÇíÈÅø„Åë„Çã
            const safeDate = new Date(
                date.getFullYear(),
                date.getMonth(),
                date.getDate(),
                12, 0, 0, 0  // Ê≠£Âçà„Å´Ë®≠ÂÆö„Åó„Å¶„Çø„Ç§„É†„Çæ„Éº„É≥„ÅÆÂïèÈ°å„ÇíÂõûÈÅø
            );
            
            console.log('üìÖ Safe date for calculation:', safeDate);
            
            // ÊåáÂÆö„Åï„Çå„ÅüÊó•‰ªò„ÅåÂê´„Åæ„Çå„ÇãÈÄ±„ÅÆÈñãÂßãÊó•ÔºàÊó•ÊõúÊó•Ôºâ„ÇíË®àÁÆó
            const dayOfWeek = safeDate.getDay();
            const targetDate = safeDate.getDate() - dayOfWeek;
            
            console.log('Target date calculation:', safeDate.getDate(), '-', dayOfWeek, '=', targetDate);
            
            // ÈÄ±„ÅÆÈñãÂßãÊó•„ÇíÂÆâÂÖ®„Å´‰ΩúÊàê
            const weekStart = new Date(
                safeDate.getFullYear(),
                safeDate.getMonth(),
                targetDate,
                12, 0, 0, 0
            );
            
            console.log('üìÖ Calculated week start:', weekStart);
            console.log('üîç Week start details:', {
                year: weekStart.getFullYear(),
                month: weekStart.getMonth() + 1,
                date: weekStart.getDate()
            });
            
            // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„ÅüÊó•‰ªò„Çí‰øùÂ≠ò
            clickedDate = safeDate;
            
            // ÈÄ±„ÇíÊõ¥Êñ∞
            currentWeekStart = weekStart;
            
            // „Ç∑„Éï„ÉàË®≠ÂÆö„Å®‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„ÄÅË°®Á§∫„ÇíÊõ¥Êñ∞
            Promise.all([
                loadShiftSettingsFromBackend(),
                loadReservationsFromBackend()
            ]).then(() => {
                renderWeekView();
            });
            
            // „Éü„Éã„Ç´„É¨„É≥„ÉÄ„Éº„ÇíÈñâ„Åò„Çã
            document.getElementById('miniCalendar').classList.remove('show');
            
            // „Éü„Éã„Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂÜçÊèèÁîªÔºàÈÅ∏ÊäûÁä∂ÊÖã„ÇíÊõ¥Êñ∞Ôºâ
            renderMiniCalendar();
        }

        function previousMiniCalendarMonth() {
            const currentDate = miniCalendarMonth;
            const prevMonth = new Date(
                currentDate.getFullYear(),
                currentDate.getMonth() - 1,
                15, // Êúà„ÅÆ‰∏≠Êó¨„Å´Ë®≠ÂÆö
                12, 0, 0, 0
            );
            
            console.log('‚¨ÖÔ∏è Moving to previous month:', prevMonth);
            miniCalendarMonth = prevMonth;
            renderMiniCalendar();
        }

        function nextMiniCalendarMonth() {
            const currentDate = miniCalendarMonth;
            const nextMonth = new Date(
                currentDate.getFullYear(),
                currentDate.getMonth() + 1,
                15, // Êúà„ÅÆ‰∏≠Êó¨„Å´Ë®≠ÂÆö
                12, 0, 0, 0
            );
            
            console.log('‚û°Ô∏è Moving to next month:', nextMonth);
            miniCalendarMonth = nextMonth;
            renderMiniCalendar();
        }

        function previousMiniCalendarYear() {
            const currentDate = miniCalendarMonth;
            const prevYear = new Date(
                currentDate.getFullYear() - 1,
                currentDate.getMonth(),
                15, // Êúà„ÅÆ‰∏≠Êó¨„Å´Ë®≠ÂÆö
                12, 0, 0, 0
            );
            
            console.log('‚¨ÖÔ∏è‚¨ÖÔ∏è Moving to previous year:', prevYear);
            miniCalendarMonth = prevYear;
            renderMiniCalendar();
        }

        function nextMiniCalendarYear() {
            const currentDate = miniCalendarMonth;
            const nextYear = new Date(
                currentDate.getFullYear() + 1,
                currentDate.getMonth(),
                15, // Êúà„ÅÆ‰∏≠Êó¨„Å´Ë®≠ÂÆö
                12, 0, 0, 0
            );
            
            console.log('‚û°Ô∏è‚û°Ô∏è Moving to next year:', nextYear);
            miniCalendarMonth = nextYear;
            renderMiniCalendar();
        }

        // ‰∫àÁ¥Ñ‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openBookingModal(date, time) {
            document.getElementById('bookingDate').value = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${time}`;
            document.getElementById('bookingTime').value = time;
            document.getElementById('bookingDuration').value = ''; // „Ç≥„Éº„ÇπÈÅ∏Êäû„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('customerName').value = '';
            document.getElementById('customerPhone').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('bookingNote').value = '';
            document.getElementById('bookingStatus').value = 'tentative';
            document.getElementById('bookingModal').style.display = 'block';
        }

        // ‰∫àÁ¥Ñ‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeBookingModal() {
            document.getElementById('bookingModal').style.display = 'none';
            // Á∑®ÈõÜ„É¢„Éº„Éâ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
            isEditingReservation = false;
            currentReservation = null;
            reservationToEdit = null;
        }

        // ‰∫àÁ¥Ñ„Çí‰ΩúÊàê„ÉªÊõ¥Êñ∞
        function createBooking() {
            const dateTime = document.getElementById('bookingDate').value;
            const duration = document.getElementById('bookingDuration').value;
            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const customerEmail = document.getElementById('customerEmail').value;
            const bookingNote = document.getElementById('bookingNote').value;
            const bookingStatus = document.getElementById('bookingStatus').value;

            console.log('üîÑ Creating/Updating booking, isEditing:', isEditingReservation);

            if (!dateTime || !duration || !customerName || !customerPhone) {
                showMessage('‰∫àÁ¥ÑÊó•ÊôÇ„ÄÅ„Ç≥„Éº„Çπ„ÄÅ„ÅäÂÆ¢ÊßòÂêç„ÄÅÈõªË©±Áï™Âè∑„ÅØÂøÖÈ†à„Åß„Åô„ÄÇ', 'error');
                return;
            }

            // Âñ∂Ê•≠ÊôÇÈñìÂÜÖ„Å´Âèé„Åæ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const [dateStr, timeStr] = dateTime.split(' ');
            const reservationDate = new Date(dateStr);
            const dayOfWeek = reservationDate.getDay();
            const newDuration = parseInt(duration);
            const defaultInterval = 10; // Êñ∞Ë¶è‰∫àÁ¥Ñ„ÅÆ„Éá„Éï„Ç©„É´„ÉàÈñìÈöî
            
            const validation = validateReservationTimeWithinBusinessHours({
                time: timeStr,
                start_time: dateTime,
                duration: newDuration
            }, newDuration, defaultInterval);
            
            if (!validation.valid) {
                showMessage(validation.message, 'error');
                return;
            }
            
            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
            const overlapValidation = validateReservationOverlap({
                time: timeStr,
                start_time: dateTime,
                duration: newDuration
            }, newDuration, defaultInterval);
            
            if (!overlapValidation.valid) {
                showMessage(overlapValidation.message, 'error');
                return;
            }

            // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´ÈÄÅ‰ø°„Åô„Çã„Éá„Éº„Çø„ÇíÊ∫ñÂÇô
            const bookingData = {
                reservation: {
                    start_time: dateTime,
                    course: `${duration}ÂàÜ`,
                    name: customerName,
                    note: bookingNote,
                    status: bookingStatus,
                    user_attributes: {
                        name: customerName,
                        phone_number: customerPhone,
                        email: customerEmail
                    }
                }
            };

            // CSRF„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó
  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            console.log('CSRF Token:', csrfToken);
            console.log('Sending booking data:', bookingData);

            // „ÇØ„É©„Ç§„Ç¢„É≥„Éà„Çµ„Ç§„Éâ„ÅßÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
            if (!isEditingReservation && checkForOverlap(dateTime, duration)) {
                showMessage('„Åì„ÅÆÊôÇÈñìÂ∏Ø„Å´„ÅØÊó¢„Å´‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂà•„ÅÆÊôÇÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                return;
            }

            // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´ÈÄÅ‰ø°ÔºàÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØÊõ¥Êñ∞„ÄÅÊñ∞Ë¶è„ÅÆÂ†¥Âêà„ÅØ‰ΩúÊàêÔºâ
            const url = isEditingReservation ? 
                `/admin/reservations/${reservationToEdit.id}/update_booking` : 
                '/admin/reservations/create_booking';
            const method = isEditingReservation ? 'PATCH' : 'POST';
            
            fetch(url, {
                method: method,
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': csrfToken
    },
                body: JSON.stringify(bookingData)
  })
  .then(response => {
                console.log('Response status:', response.status);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
                    // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åã„ÇâËøî„Åï„Çå„Åü‰∫àÁ¥Ñ„Éá„Éº„Çø„Çí‰ΩøÁî®
                    const reservationData = data.reservation;
                    
                    if (isEditingReservation) {
                        // Á∑®ÈõÜ„É¢„Éº„ÉâÔºöÊó¢Â≠ò„ÅÆ‰∫àÁ¥Ñ„ÇíÊõ¥Êñ∞
                        const updatedReservation = {
                            id: reservationData.id,
                            userId: reservationData.user_id || reservationData.user?.id,
                            time: reservationData.start_time.split('T')[1].substring(0, 5), // HH:MMÂΩ¢Âºè„Å´Â§âÊèõ
                            duration: extractDurationFromCourse(reservationData.course),
                            customer: reservationData.name || reservationData.user?.name || 'Êú™Ë®≠ÂÆö',
                            phone: reservationData.user?.phone_number || '',
                            email: reservationData.user?.email || '',
                            note: reservationData.note || '',
                            status: reservationData.status,
                            createdAt: reservationData.created_at,
                            updatedAt: reservationData.updated_at,
                            effective_interval_minutes: reservationData.effective_interval_minutes ?? 10
                        };
                        
                        // Êó¢Â≠ò„ÅÆ‰∫àÁ¥Ñ„ÇíÊõ¥Êñ∞
                        // Âè§„ÅÑÊó•‰ªò„Ç≠„Éº„ÇíÁâπÂÆöÔºàreservations„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„ÇâË©≤ÂΩì„Åô„ÇãÊó•‰ªò„Ç≠„Éº„ÇíÊé¢„ÅôÔºâ
                        let oldDateKey = null;
                        for (const dateKey of Object.keys(reservations)) {
                            const dayReservations = reservations[dateKey];
                            const foundReservation = dayReservations.find(r => r.id === reservationToEdit.id);
                            if (foundReservation) {
                                oldDateKey = dateKey;
                                break;
                            }
                        }
                        
                        const newDateKey = formatDateKey(new Date(reservationData.start_time));
                        
                        // Âè§„ÅÑÊó•‰ªò„Åã„ÇâÂâäÈô§
                        if (oldDateKey && reservations[oldDateKey]) {
                            reservations[oldDateKey] = reservations[oldDateKey].filter(r => r.id !== reservationToEdit.id);
                            if (reservations[oldDateKey].length === 0) {
                                delete reservations[oldDateKey];
                            }
                        }
                        
                        // Êñ∞„Åó„ÅÑÊó•‰ªò„Å´ËøΩÂä†
                        if (!reservations[newDateKey]) {
                            reservations[newDateKey] = [];
                        }
                        reservations[newDateKey].push(updatedReservation);
                        
                        
                        
                        // Á∑®ÈõÜ„É¢„Éº„Éâ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„Éà
                        isEditingReservation = false;
                        currentReservation = null;
                        reservationToEdit = null;
                        
                        showMessage('‰∫àÁ¥Ñ„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'success');
                    } else {
                        // Êñ∞Ë¶è‰ΩúÊàê„É¢„Éº„ÉâÔºöÊñ∞„Åó„ÅÑ‰∫àÁ¥Ñ„ÇíËøΩÂä†
                        const reservation = {
                            id: reservationData.id,
                            userId: reservationData.user_id || reservationData.user?.id,
                            time: reservationData.start_time.split('T')[1].substring(0, 5), // HH:MMÂΩ¢Âºè„Å´Â§âÊèõ
                            duration: extractDurationFromCourse(reservationData.course),
                            customer: reservationData.name || reservationData.user?.name || 'Êú™Ë®≠ÂÆö',
                            phone: reservationData.user?.phone_number || '',
                            email: reservationData.user?.email || '',
                            note: reservationData.note || '',
                            status: reservationData.status,
                            createdAt: reservationData.created_at,
                            updatedAt: reservationData.updated_at,
                            effective_interval_minutes: reservationData.effective_interval_minutes ?? 10
                        };

                        const dateKey = formatDateKey(new Date(reservationData.start_time));
                        if (!reservations[dateKey]) {
                            reservations[dateKey] = [];
                        }
                        reservations[dateKey].push(reservation);

                        
                        
                        showMessage('‰∫àÁ¥Ñ„Åå‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'success');
                    }

                    // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂÜçÊèèÁîª
                    generateTimeSlots();

                    closeBookingModal();
    } else {
                    showMessage(`‰∫àÁ¥Ñ„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${data.message}`, 'error');
    }
  })
  .catch(error => {
                console.error('Error creating booking:', error);
                showMessage('‰∫àÁ¥Ñ„ÅÆ‰ΩúÊàê‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            });
        }

        // ‰∫àÁ¥ÑË©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
        function openReservationDetailModal(reservation) {

            // ÊúÄÊñ∞„ÅÆ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÂèñÂæó
            let latestReservation = null;
            for (const dateKey of Object.keys(reservations)) {
                const dayReservations = reservations[dateKey];
                const foundReservation = dayReservations.find(r => r.id === reservation.id);
                if (foundReservation) {
                    latestReservation = foundReservation;
                    break;
                }
            }
            
            // ÊúÄÊñ∞„ÅÆ„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÂÖÉ„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®
            if (!latestReservation) {
                latestReservation = reservation;
            }
            
            console.log('üîç Opening modal with reservation data:', {
                original: {
                    time: reservation.time,
                    date: reservation.date,
                    dateKey: reservation.dateKey,
                    start_time: reservation.start_time
                },
                latest: {
                    time: latestReservation.time,
                    date: latestReservation.date,
                    dateKey: latestReservation.dateKey,
                    start_time: latestReservation.start_time
                }
            });
            
            // ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
            if (!validateReservationData(latestReservation)) {
                showMessage('‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅåÁÑ°Âäπ„Åß„Åô', 'error');
                return;
            }
            
            // ÁèæÂú®„ÅÆ‰∫àÁ¥Ñ„Çí‰øùÂ≠òÔºàÊúÄÊñ∞„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºâ
            currentReservation = latestReservation;
            
            // ‰∫àÁ¥Ñ„ÅÆÂÆüÈöõ„ÅÆÊó•‰ªò„ÇíÁâπÂÆö
            let actualDate = '';
            for (const dateKey of Object.keys(reservations)) {
                const dayReservations = reservations[dateKey];
                const foundReservation = dayReservations.find(r => r.id === latestReservation.id);
                if (foundReservation) {
                    const [year, month, day] = dateKey.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    actualDate = date.toLocaleDateString('ja-JP', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        weekday: 'long'
                    });
                    break;
                }
            }
            
            // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„ÅüËâ≤„Å®„Ç¢„Ç§„Ç≥„É≥„ÇíË®≠ÂÆö
            const statusConfig = {
                'tentative': { color: 'warning', icon: '‚è≥', text: '‰ªÆ‰∫àÁ¥Ñ' },
                'confirmed': { color: 'success', icon: '‚úì', text: 'Á¢∫Ë™çÊ∏à„Åø' },
                'completed': { color: 'info', icon: '‚úÖ', text: 'ÂÆå‰∫Ü' }
            };
            
            const status = statusConfig[latestReservation.status] || { color: 'secondary', icon: '‚ùì', text: latestReservation.status };
            
            // Create customer name HTML
            const customerNameHTML = latestReservation.userId ? 
                `<a href="/admin/users/${latestReservation.userId}" target="_blank" class="customer-link">${latestReservation.customer}</a>` : 
                latestReservation.customer;
            
            const modalContent = document.getElementById('reservationDetailContent');
            modalContent.innerHTML = `
                <div class="reservation-detail-container">
                    <!-- Á∑®ÈõÜ„Éï„Ç©„Éº„É† -->
                    <form id="reservationEditForm" onsubmit="saveReservationChanges(event)">
                    <!-- „Éò„ÉÉ„ÉÄ„ÉºÊÉÖÂ†± -->
                    <div class="reservation-header">
                        <div class="header-top">
                            <div class="customer-name-header">
                                <span class="customer-name-large">${latestReservation.customer}</span>
                                    <button type="button" class="btn btn-sm btn-outline-light change-user-btn" onclick="openUserSelectionModal()">
                                        <i class="fas fa-user-edit"></i> Â§âÊõ¥
                                    </button>
                            </div>
                            <div class="reservation-status status-${status.color}">
                                    <select id="edit-status" class="form-select status-select" onchange="updateCalendarOnStatusChange()">
                                        <option value="tentative" ${latestReservation.status === 'tentative' ? 'selected' : ''}>‰ªÆ‰∫àÁ¥Ñ</option>
                                        <option value="confirmed" ${latestReservation.status === 'confirmed' ? 'selected' : ''}>Á¢∫Ë™çÊ∏à„Åø</option>
                                        <option value="completed" ${latestReservation.status === 'completed' ? 'selected' : ''}>ÂÆå‰∫Ü</option>
                                    </select>
                            </div>
                        </div>
                        <div class="header-bottom">
                            <div class="header-detail-item">
                                <span class="header-label">‰∫àÁ¥ÑÊó•ÊôÇ</span>
                                <span class="header-value">${actualDate || 'Êó•‰ªò‰∏çÊòé'} ${latestReservation.time}</span>
                            </div>
                            <div class="header-detail-item">
                                <span class="header-label">„Ç≥„Éº„Çπ</span>
                                    <select id="edit-course" class="form-select course-select" onchange="updateCalendarOnCourseChange()">
                                        <option value="40ÂàÜ" ${latestReservation.duration === 40 ? 'selected' : ''}>40ÂàÜ</option>
                                        <option value="60ÂàÜ" ${latestReservation.duration === 60 ? 'selected' : ''}>60ÂàÜ</option>
                                        <option value="80ÂàÜ" ${latestReservation.duration === 80 ? 'selected' : ''}>80ÂàÜ</option>
                                    </select>
                                </div>
                                <div class="header-detail-item">
                                    <span class="header-label">Ê∫ñÂÇôÊôÇÈñì</span>
                                    <span class="header-value">
                                        <select id="edit-interval" class="interval-select" onchange="updateIntervalOnChange()">
                                            <option value="0" ${(latestReservation.effective_interval_minutes ?? 10) === 0 ? 'selected' : ''}>0ÂàÜ</option>
                                            <option value="5" ${(latestReservation.effective_interval_minutes ?? 10) === 5 ? 'selected' : ''}>5ÂàÜ</option>
                                            <option value="10" ${(latestReservation.effective_interval_minutes ?? 10) === 10 ? 'selected' : ''}>10ÂàÜ</option>
                                            <option value="15" ${(latestReservation.effective_interval_minutes ?? 10) === 15 ? 'selected' : ''}>15ÂàÜ</option>
                                            <option value="20" ${(latestReservation.effective_interval_minutes ?? 10) === 20 ? 'selected' : ''}>20ÂàÜ</option>
                                            <option value="30" ${(latestReservation.effective_interval_minutes ?? 10) === 30 ? 'selected' : ''}>30ÂàÜ</option>
                                        </select>
                                    </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- „ÅäÂÆ¢ÊßòÂü∫Êú¨ÊÉÖÂ†± -->
                    <div class="customer-basic-info">
                        <div class="customer-phone">
                            ${latestReservation.phone || 'ÈõªË©±Áï™Âè∑Êú™Ë®òÂÖ•'}
                        </div>
                        <div class="customer-email">
                            ${latestReservation.email || '„É°„Éº„É´„Ç¢„Éâ„É¨„ÇπÊú™Ë®òÂÖ•'}
                        </div>
                    </div>
                    
                        <!-- „É°„É¢ -->
                        <div class="notes-section">
                            <div class="section-title">„É°„É¢</div>
                            <textarea id="edit-note" class="form-control" rows="3" placeholder="„É°„É¢„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ">${latestReservation.note || ''}</textarea>
                        </div>
                    </form>
                    
                    <!-- ÂõûÊï∞Âà∏„Å®Âà©Áî®Â±•Ê≠¥„ÇíÊ®™‰∏¶„Å≥„ÅßË°®Á§∫ -->
                    <div class="tickets-history-container">
                    <!-- ÂõûÊï∞Âà∏ -->
                    <div class="tickets-section">
                        <div class="section-title">ÂõûÊï∞Âà∏</div>
                        <div class="tickets-content" id="tickets-content">
                            <div class="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                        </div>
                    </div>
                    
                        <!-- Âà©Áî®Â±•Ê≠¥ -->
                    <div class="reservation-history-section">
                            <div class="section-title">Âà©Áî®Â±•Ê≠¥</div>
                        <div class="history-content" id="history-content">
                            <div class="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
                        </div>
                        </div>
                    </div>
                    
                    <!-- „Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†± -->
                    <div class="system-info-section">
                        <div class="detail-item">
                            <span class="detail-label">‰ΩúÊàêÊó•ÊôÇ</span>
                            <span class="detail-value">${new Date(latestReservation.createdAt).toLocaleString('ja-JP')}</span>
                        </div>
                        ${latestReservation.updatedAt && new Date(latestReservation.updatedAt).getTime() !== new Date(latestReservation.createdAt).getTime() ? `
                        <div class="detail-item">
                            <span class="detail-label">Â§âÊõ¥Êó•ÊôÇ</span>
                            <span class="detail-value">${new Date(latestReservation.updatedAt).toLocaleString('ja-JP')}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            document.getElementById('reservationDetailModal').style.display = 'block';
            
            // Add click event listener to customer link
            setTimeout(() => {
                const customerLink = document.querySelector('.customer-link');
                if (customerLink) {
        
                    customerLink.addEventListener('click', function(e) {
            
                        e.preventDefault();
                        window.open(this.href, '_blank');
                    });
                } else {
                    console.log('‚ùå Customer link not found');
                }
            }, 100);
            
            // „ÉÅ„Ç±„ÉÉ„Éà„Å®‰∫àÁ¥ÑÂ±•Ê≠¥„ÇíË™≠„ÅøËæº„ÅøÔºà„É¶„Éº„Ç∂„ÉºID„Éô„Éº„ÇπÔºâ
            if (latestReservation.userId) {
                loadTicketsAndHistoryForUser(latestReservation.userId);
            } else {
            loadTicketsAndHistory(latestReservation);
            }
            
            // „É¶„Éº„Ç∂„Éº„É™„Çπ„Éà„ÅØÊ§úÁ¥¢ÊôÇ„Å´ÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø
        }

        // ‰∫àÁ¥ÑË©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        function closeReservationDetailModal() {
            document.getElementById('reservationDetailModal').style.display = 'none';
            currentReservation = null; // ÁèæÂú®„ÅÆ‰∫àÁ¥Ñ„Çí„É™„Çª„ÉÉ„Éà
        }

        // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„ÇãÊ©üËÉΩ
        function setupModalClickOutside() {
            const modal = document.getElementById('reservationDetailModal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    // „É¢„Éº„ÉÄ„É´ËÉåÊôØÔºà.modalÔºâ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„ÅÆ„ÅøÈñâ„Åò„Çã
                    if (event.target === modal) {
                        closeReservationDetailModal();
                    }
                });
            }
        }

        // „ÉÅ„Ç±„ÉÉ„Éà„Å®Âà©Áî®Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
        function loadTicketsAndHistory(reservation) {
            // „ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
            loadTickets(reservation);
            // Âà©Áî®Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
            loadReservationHistory(reservation);
        }

        // „É¶„Éº„Ç∂„ÉºID„Åß„ÉÅ„Ç±„ÉÉ„Éà„Å®Âà©Áî®Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
        function loadTicketsAndHistoryForUser(userId) {
            // „ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
            loadTicketsForUser(userId);
            // Âà©Áî®Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
            loadReservationHistoryForUser(userId);
        }

        // „ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
        function loadTickets(reservation) {

            
            const ticketsContent = document.getElementById('tickets-content');
            if (!ticketsContent) {
                console.error('‚ùå Tickets content element not found');
                return;
            }

            // ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
            if (!validateReservationData(reservation)) {
                ticketsContent.innerHTML = '<div class="no-data">‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅåÁÑ°Âäπ„Åß„Åô</div>';
                return;
            }

            // „É¶„Éº„Ç∂„ÉºID„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
            if (reservation.userId) {
    
    
                
                // „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞„ÇíËøΩÂä†
                fetch(`/admin/reservations/${reservation.id}/tickets`, {
                    headers: {
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
                    }
                })
    .then(response => {
                        console.log('üì° Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
      return response.json();
    })
                    .then(data => {
            
                        if (data.success) {
                            displayTickets(data.tickets);
                        } else {
                            console.warn('‚ö†Ô∏è No tickets data:', data.message);
                            ticketsContent.innerHTML = '<div class="no-data">„ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                        }
    })
    .catch(error => {
                        console.error('‚ùå Error loading tickets:', error);
                        console.error('‚ùå Error details:', {
                            message: error.message,
                            stack: error.stack,
                            reservationId: reservation.id,
                            userId: reservation.userId
                        });
                        ticketsContent.innerHTML = '<div class="no-data">„ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                    });
            } else {
                console.warn('‚ö†Ô∏è No user ID found for reservation');
                ticketsContent.innerHTML = '<div class="no-data">„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            }
        }

        // „É¶„Éº„Ç∂„ÉºID„Åß„ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø
        function loadTicketsForUser(userId) {
            const ticketsContent = document.getElementById('tickets-content');
            if (!ticketsContent) {
                console.error('‚ùå Tickets content element not found');
                return;
            }

            // „É¶„Éº„Ç∂„ÉºID„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
            if (userId) {
                fetch(`/admin/users/${userId}/tickets.json`)
                    .then(response => {
                        console.log('üì° User tickets response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(tickets => {
                        console.log('üì° User tickets data:', tickets);
                        displayUserTickets(tickets);
                    })
                    .catch(error => {
                        console.error('‚ùå Error loading user tickets:', error);
                        ticketsContent.innerHTML = '<div class="no-data">„ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                    });
            } else {
                console.warn('‚ö†Ô∏è No user ID provided');
                ticketsContent.innerHTML = '<div class="no-data">„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            }
        }

        // „É¶„Éº„Ç∂„Éº„ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„ÇíË°®Á§∫
        function displayUserTickets(tickets) {
            const ticketsContent = document.getElementById('tickets-content');
            if (!ticketsContent) {
                console.error('‚ùå Tickets content element not found in displayUserTickets');
                return;
            }

            if (!tickets || tickets.length === 0) {
                console.log('‚ÑπÔ∏è No user tickets to display');
                ticketsContent.innerHTML = '<div class="no-data">„ÉÅ„Ç±„ÉÉ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            // Limit to 5 tickets like the original
            const limitedTickets = tickets.slice(0, 5);

            const ticketsHtml = limitedTickets.map(ticket => {
                const isExpired = ticket.remaining === 0 || new Date(ticket.expires_at) < new Date();
                const expiryDate = ticket.expires_at ? new Date(ticket.expires_at).toLocaleDateString('ja-JP') : 'ÁÑ°ÊúüÈôê';
                
                return `
                    <div class="ticket-item ${isExpired ? 'expired' : ''}">
                        <div class="ticket-checkbox">‚ñ°</div>
                        <div class="ticket-info">
                            <div class="ticket-name">${ticket.name}</div>
                            <div class="ticket-details">ÊÆã${ticket.remaining}Êûö / ÊúâÂäπÊúüÈôê:${expiryDate}</div>
                        </div>
                    </div>
                `;
            }).join('');

            ticketsContent.innerHTML = ticketsHtml;
        }

        // „ÉÅ„Ç±„ÉÉ„ÉàÊÉÖÂ†±„ÇíË°®Á§∫
        function displayTickets(tickets) {

            
            const ticketsContent = document.getElementById('tickets-content');
            if (!ticketsContent) {
                console.error('‚ùå Tickets content element not found in displayTickets');
                return;
            }

            if (!tickets || tickets.length === 0) {
                console.log('‚ÑπÔ∏è No tickets to display');
                ticketsContent.innerHTML = '<div class="no-data">„ÉÅ„Ç±„ÉÉ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }


            
            const ticketsHtml = tickets.map(ticket => {
                const isExpired = ticket.remaining_count === 0 || new Date(ticket.expiry_date) < new Date();
                const expiryDate = new Date(ticket.expiry_date).toLocaleDateString('ja-JP');
                

                
                return `
                    <div class="ticket-item ${isExpired ? 'expired' : ''}">
                        <div class="ticket-checkbox">‚ñ°</div>
                        <div class="ticket-info">
                            <div class="ticket-name">${ticket.ticket_template_name}</div>
                            <div class="ticket-details">ÊÆã${ticket.remaining_count}${ticket.unit_type} / ÊúâÂäπÊúüÈôê:${expiryDate}</div>
          </div>
        </div>
      `;
            }).join('');


            ticketsContent.innerHTML = ticketsHtml;
        }

        // „É¶„Éº„Ç∂„ÉºID„ÅßÂà©Áî®Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
        function loadReservationHistoryForUser(userId) {
            const historyContent = document.getElementById('history-content');
            if (!historyContent) return;

            // „É¶„Éº„Ç∂„ÉºID„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂà©Áî®Â±•Ê≠¥„ÇíÂèñÂæó
            if (userId) {
                fetch(`/admin/users/${userId}/history.json`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('üì° User history data:', data);
                        if (data.success) {
                            displayReservationHistory(data.usages);
                        } else {
                            historyContent.innerHTML = '<div class="no-data">Âà©Áî®Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error loading user history:', error);
                        historyContent.innerHTML = '<div class="no-data">Âà©Áî®Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                    });
            } else {
                historyContent.innerHTML = '<div class="no-data">„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            }
        }

        // Âà©Áî®Â±•Ê≠¥„ÇíË™≠„ÅøËæº„Åø
        function loadReservationHistory(reservation) {

            
            const historyContent = document.getElementById('history-content');
            if (!historyContent) return;

            // ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅÆÂ¶•ÂΩìÊÄß„ÉÅ„Çß„ÉÉ„ÇØ
            if (!validateReservationData(reservation)) {
                historyContent.innerHTML = '<div class="no-data">‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅåÁÑ°Âäπ„Åß„Åô</div>';
                return;
            }

            // „É¶„Éº„Ç∂„ÉºID„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÂà©Áî®Â±•Ê≠¥„ÇíÂèñÂæó
            if (reservation.userId) {
                fetch(`/admin/reservations/${reservation.id}/history`, {
                    headers: {
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.success) {
                            displayReservationHistory(data.usages);
                        } else {
                            historyContent.innerHTML = '<div class="no-data">Âà©Áî®Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå Error loading usage history:', error);
                        console.error('‚ùå Error details:', {
                            message: error.message,
                            stack: error.stack,
                            reservationId: reservation.id,
                            userId: reservation.userId
                        });
                        historyContent.innerHTML = '<div class="no-data">Âà©Áî®Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</div>';
                    });
            } else {
                historyContent.innerHTML = '<div class="no-data">„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
            }
        }

        // Âà©Áî®Â±•Ê≠¥„ÇíË°®Á§∫
        function displayReservationHistory(usages) {
            const historyContent = document.getElementById('history-content');
            if (!historyContent) return;

            if (!usages || usages.length === 0) {
                historyContent.innerHTML = '<div class="no-data">Âà©Áî®Â±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                return;
            }

            const historyHtml = usages.map(usage => {
                const usageDate = new Date(usage.usage_date).toLocaleDateString('ja-JP');
                const usageTime = new Date(usage.usage_date).toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
                
                return `
                    <div class="history-item">
                        <div class="history-icon">üé´</div>
                        <div class="history-content">
                            <div class="history-ticket-name">${usage.ticket_name}</div>
                            <div class="history-date-time">${usageDate} ${usageTime}</div>
                        </div>
                    </div>
                `;
            }).join('');

            historyContent.innerHTML = historyHtml;
        }



        // „Çπ„ÉÜ„Éº„Çø„Çπ„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
        function getStatusIcon(status) {
            const statusIcons = {
                'confirmed': '‚úÖ',
                'tentative': '‚è≥',
                'cancelled': '‚ùå',
                'completed': '‚úÖ',
                'no_show': '‚ö†Ô∏è'
            };
            return statusIcons[status] || '‚ùì';
        }



        // ‰∫àÁ¥Ñ„ÇíÁ∑®ÈõÜ
        function editReservation() {
            if (!currentReservation) {
                showMessage('Á∑®ÈõÜ„Åô„Çã‰∫àÁ¥Ñ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'error');
                return;
            }
            
            console.log('‚úèÔ∏è Editing reservation:', currentReservation);
            
            // Á∑®ÈõÜ„É¢„Éº„Éâ„Éï„É©„Ç∞„ÇíË®≠ÂÆö
            isEditingReservation = true;
            
            // ‰∫àÁ¥Ñ„Éá„Éº„Çø„Çí‰øùÂ≠òÔºà„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„ÇãÂâç„Å´Ôºâ
            reservationToEdit = { ...currentReservation };
            
            // ‰∫àÁ¥Ñ„ÅÆÂÆüÈöõ„ÅÆÊó•‰ªò„ÇíÁâπÂÆöÔºàreservations„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„ÇâË©≤ÂΩì„Åô„ÇãÊó•‰ªò„Ç≠„Éº„ÇíÊé¢„ÅôÔºâ
            let actualReservationDate = null;
            let foundDateKey = null;
            
            // „Åô„Åπ„Å¶„ÅÆÊó•‰ªò„Ç≠„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶Ë©≤ÂΩì„Åô„Çã‰∫àÁ¥Ñ„ÇíÊé¢„Åô
            for (const dateKey of Object.keys(reservations)) {
                const dayReservations = reservations[dateKey];
                const foundReservation = dayReservations.find(r => r.id === currentReservation.id);
                
                if (foundReservation) {
                    foundDateKey = dateKey;
                    // Êó•‰ªò„Ç≠„Éº„Åã„ÇâÂÆüÈöõ„ÅÆÊó•‰ªò„ÇíË®àÁÆó
                    const [year, month, day] = dateKey.split('-').map(Number);
                    const [hours, minutes] = currentReservation.time.split(':').map(Number);
                    actualReservationDate = new Date(year, month - 1, day, hours, minutes, 0, 0);
                    break;
                }
            }
            
            // Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØcreatedAt„Åã„ÇâË®àÁÆóÔºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºâ
            if (!actualReservationDate) {
                console.warn('‚ö†Ô∏è Could not find reservation in date keys, using createdAt as fallback');
                actualReservationDate = new Date(reservationToEdit.createdAt);
                const [hours, minutes] = reservationToEdit.time.split(':').map(Number);
                actualReservationDate.setHours(hours, minutes, 0, 0);
            }
            
            console.log('üìÖ Actual reservation date:', actualReservationDate, 'from date key:', foundDateKey);
            
            // ‰∫àÁ¥ÑË©≥Á¥∞„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            closeReservationDetailModal();
            
            // ‰∫àÁ¥ÑÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
            openBookingModal(actualReservationDate, reservationToEdit.time);
            
            // „Éï„Ç©„Éº„É†„Éï„Ç£„Éº„É´„Éâ„ÇíÊó¢Â≠ò„ÅÆ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅßÂüã„ÇÅ„ÇãÔºà„É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„ÅüÂæå„Å´ÂÆüË°åÔºâ
            setTimeout(() => {
                const customerNameField = document.getElementById('customerName');
                const customerPhoneField = document.getElementById('customerPhone');
                const customerEmailField = document.getElementById('customerEmail');
                const bookingDurationField = document.getElementById('bookingDuration');
                const bookingNoteField = document.getElementById('bookingNote');
                const bookingStatusField = document.getElementById('bookingStatus');
                
                if (customerNameField) customerNameField.value = reservationToEdit.customer;
                if (customerPhoneField) customerPhoneField.value = reservationToEdit.phone;
                if (customerEmailField) customerEmailField.value = reservationToEdit.email;
                if (bookingDurationField) bookingDurationField.value = reservationToEdit.duration;
                if (bookingNoteField) bookingNoteField.value = reservationToEdit.note;
                if (bookingStatusField) bookingStatusField.value = reservationToEdit.status;
            }, 200);
            
            showMessage('‰∫àÁ¥Ñ„ÇíÁ∑®ÈõÜ„Åß„Åç„Åæ„Åô„ÄÇ', 'info');
        }

        // ‰∫àÁ¥Ñ„ÇíÂâäÈô§
        function deleteReservation() {
            if (!currentReservation) {
                showMessage('ÂâäÈô§„Åô„Çã‰∫àÁ¥Ñ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'error');
    return;
  }
  
            const confirmed = confirm(`„Åì„ÅÆ‰∫àÁ¥Ñ„ÇíÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n„ÅäÂÆ¢Êßò: ${currentReservation.customer}\nÊó•ÊôÇ: ${currentReservation.time}\n„Ç≥„Éº„Çπ: ${currentReservation.duration}ÂàÜ\n\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`);
            
            if (!confirmed) {
                return;
            }
            
            console.log('üóëÔ∏è Deleting reservation:', currentReservation);
            
            // Ë¶ñË¶öÁöÑ„Å™„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ: ÂâäÈô§„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈñãÂßã
            const reservationBlocks = document.querySelectorAll('.reservation-block');
            reservationBlocks.forEach(block => {
                if (block.textContent.includes(currentReservation.customer) && 
                    block.textContent.includes(currentReservation.time)) {
                    block.classList.add('deleting');
                }
            });
            
            // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´ÂâäÈô§„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
            fetch('/admin/reservations/delete_reservation', {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
    },
                body: JSON.stringify({
                    reservation_id: currentReservation.id
  })
  })
            .then(response => response.json())
  .then(data => {
    if (data.success) {
                    console.log('‚úÖ Reservation deleted successfully');
                    
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Åã„Çâ‰∫àÁ¥Ñ„ÇíÂâäÈô§
                    // ‰∫àÁ¥Ñ„ÅÆÂÆüÈöõ„ÅÆÊó•‰ªò„ÇíÁâπÂÆö„Åô„Çã„Åü„ÇÅ„Å´„ÄÅ„Åô„Åπ„Å¶„ÅÆÊó•‰ªò„Ç≠„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    console.log('üóëÔ∏è Searching for reservation ID:', currentReservation.id, 'in all date keys');
                    console.log('üóëÔ∏è Available date keys:', Object.keys(reservations));
                    
                    let foundDateKey = null;
                    let foundReservation = null;
                    
                    // „Åô„Åπ„Å¶„ÅÆÊó•‰ªò„Ç≠„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶Ë©≤ÂΩì„Åô„Çã‰∫àÁ¥Ñ„ÇíÊé¢„Åô
                    for (const dateKey of Object.keys(reservations)) {
                        const dayReservations = reservations[dateKey];
                        const matchingReservation = dayReservations.find(r => r.id === currentReservation.id);
                        
                        if (matchingReservation) {
                            foundDateKey = dateKey;
                            foundReservation = matchingReservation;
                            console.log(`üóëÔ∏è Found reservation in date key: ${dateKey}`);
                            break;
                        }
                    }
                    
                    if (foundDateKey && foundReservation) {
                        const beforeCount = reservations[foundDateKey].length;
                        reservations[foundDateKey] = reservations[foundDateKey].filter(r => r.id !== currentReservation.id);
                        const afterCount = reservations[foundDateKey].length;
                        
                        console.log(`üóëÔ∏è Removed reservation: ${beforeCount} ‚Üí ${afterCount} reservations for ${foundDateKey}`);
                        
                        if (reservations[foundDateKey].length === 0) {
                            delete reservations[foundDateKey];
                            console.log(`üóëÔ∏è Deleted empty date key: ${foundDateKey}`);
                        }
  } else {
                        console.warn(`‚ö†Ô∏è Reservation ID ${currentReservation.id} not found in any date key`);
                        console.warn(`‚ö†Ô∏è Available reservations:`, reservations);
                    }
                    
                    // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂÜçÊèèÁîª
                    generateTimeSlots();
      
      // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    closeReservationDetailModal();
                    
                    // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                    showMessage('‰∫àÁ¥Ñ„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'success');
                    
                    // „Éá„Éê„ÉÉ„Ç∞: ÂâäÈô§Âæå„ÅÆ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç
                    console.log('‚úÖ After deletion - reservations data:', reservations);
    } else {
                    console.error('‚ùå Failed to delete reservation:', data.message);
                    showMessage(`‰∫àÁ¥Ñ„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${data.message}`, 'error');
    }
  })
  .catch(error => {
                console.error('‚ùå Error deleting reservation:', error);
                showMessage('‰∫àÁ¥Ñ„ÅÆÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            });
        }

        // ‰∫àÁ¥Ñ„Çí„Ç≠„É£„É≥„Çª„É´ÔºàÂâäÈô§Ôºâ
        function cancelReservation() {
            if (!currentReservation) {
                showMessage('„Ç≠„É£„É≥„Çª„É´„Åô„Çã‰∫àÁ¥Ñ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'error');
                return;
            }
            
            const confirmed = confirm(`„Åì„ÅÆ‰∫àÁ¥Ñ„ÇíÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\n\n„ÅäÂÆ¢Êßò: ${currentReservation.customer}\nÊó•ÊôÇ: ${currentReservation.time}\n„Ç≥„Éº„Çπ: ${currentReservation.duration}ÂàÜ\n\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`);
            
            if (!confirmed) {
    return;
  }
  

            
            // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´ÂâäÈô§„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
            fetch('/admin/reservations/delete_reservation', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')
                },
                body: JSON.stringify({ reservation_id: currentReservation.id })
            })
            .then(response => response.json())
  .then(data => {
    if (data.success) {

                    

                    
                    // „Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„Ç®„É™„Ç¢„Å´ËøΩÂä†ÔºàÂâäÈô§Ââç„Å´‰∫àÁ¥Ñ„Éá„Éº„Çø„Å®Êó•‰ªò„Çí‰øùÂ≠òÔºâ
                    const reservationToCancel = { ...currentReservation };
                    
                    // ‰∫àÁ¥Ñ„ÅÆÂÆüÈöõ„ÅÆÊó•‰ªò„ÇíÁâπÂÆöÔºàdateKey„Åã„ÇâÊäΩÂá∫Ôºâ- ÂâäÈô§Ââç„Å´ÂÆüË°å
                    let actualReservationDate = null;
                    let foundDateKey = null;
                    
                    // „Åô„Åπ„Å¶„ÅÆÊó•‰ªò„Ç≠„Éº„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶Ë©≤ÂΩì„Åô„Çã‰∫àÁ¥Ñ„ÇíÊé¢„Åô
                    for (const dateKey of Object.keys(reservations)) {
                        const dayReservations = reservations[dateKey];
                        const foundReservation = dayReservations.find(r => r.id === reservationToCancel.id);
                        
                        if (foundReservation) {
                            foundDateKey = dateKey;
                            const [year, month, day] = dateKey.split('-').map(Number);
                            actualReservationDate = new Date(year, month - 1, day);
                            break;
                        }
                    }
                    
                    // Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØcreatedAt„Åã„ÇâË®àÁÆó
                    if (!actualReservationDate) {
                        actualReservationDate = new Date(reservationToCancel.createdAt);
                    }
                    
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„Åã„Çâ‰∫àÁ¥Ñ„ÇíÂâäÈô§
                    if (foundDateKey) {
                        const beforeCount = reservations[foundDateKey].length;
                        reservations[foundDateKey] = reservations[foundDateKey].filter(r => r.id !== reservationToCancel.id);
                        const afterCount = reservations[foundDateKey].length;
                        
                        if (reservations[foundDateKey].length === 0) {
                            delete reservations[foundDateKey];
                        }
                    }
                    
                    addToCancellationDisplay({
                        ...reservationToCancel,
                        start_time: actualReservationDate.toISOString()
                    });
                    
                    // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂÜçÊèèÁîª
                    generateTimeSlots();
                    
                    // „Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„ÇíÊõ¥Êñ∞ÔºàDOMÊìç‰ΩúÂæå„Å´Á¢∫ÂÆü„Å´Êõ¥Êñ∞Ôºâ
                    setTimeout(() => {
                        updateCancellationDisplay();
                    }, 50);
                    
                    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
                    closeReservationDetailModal();
                    
                    showMessage('‰∫àÁ¥Ñ„Åå„Ç≠„É£„É≥„Çª„É´ÔºàÂâäÈô§Ôºâ„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'success');
                } else {
                    console.error('‚ùå Failed to cancel reservation:', data.message);
                    showMessage(`‰∫àÁ¥Ñ„ÅÆ„Ç≠„É£„É≥„Çª„É´„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${data.message}`, 'error');
    }
  })
  .catch(error => {
                console.error('‚ùå Error cancelling reservation:', error);
                showMessage('‰∫àÁ¥Ñ„ÅÆ„Ç≠„É£„É≥„Çª„É´‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
            });
        }

        // „Ç≥„Éº„Çπ„Åã„ÇâÊôÇÈñì„ÇíÊäΩÂá∫„Åô„ÇãÈñ¢Êï∞
        function extractDurationFromCourse(courseString) {
            if (!courseString) return 60;
            
            const match = courseString.match(/(\d+)ÂàÜ/);
            return match ? parseInt(match[1]) : 60;
        }

        // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞
        function checkForOverlap(dateTime, duration) {
            const startTime = new Date(dateTime);
            const endTime = new Date(startTime.getTime() + parseInt(duration) * 60 * 1000);
            const dateKey = formatDateKey(startTime);
            
            // ÊåáÂÆöÊó•„ÅÆ‰∫àÁ¥Ñ„ÇíÂèñÂæó
            const dayReservations = reservations[dateKey] || [];
            
            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇÇÂê´„ÇÄÔºâ
            for (const reservation of dayReservations) {
                const reservationStart = new Date(`${dateKey}T${reservation.time}`);
                const reservationEnd = new Date(reservationStart.getTime() + reservation.duration * 60 * 1000);
                
                // „Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇíÂèñÂæóÔºàeffective_interval_minutes„Çí‰ΩøÁî®Ôºâ
                const intervalMinutes = reservation.effective_interval_minutes ?? 10;
                const reservationEndWithInterval = new Date(reservationEnd.getTime() + intervalMinutes * 60 * 1000);
                
                // ÁèæÂú®„ÅÆ‰∫àÁ¥Ñ„ÅÆ„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñìÔºà„Éá„Éï„Ç©„É´„Éà10ÂàÜÔºâ
                const currentIntervalMinutes = 10; // „Éá„Éï„Ç©„É´„Éà10ÂàÜ
                const currentEndWithInterval = new Date(endTime.getTime() + currentIntervalMinutes * 60 * 1000);
                
                // ÈáçË§áÂà§ÂÆöÔºà„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇÇÂê´„ÇÄÔºâ
                if (startTime < reservationEndWithInterval && currentEndWithInterval > reservationStart) {
                    return true; // ÈáçË§á„ÅÇ„Çä
                }
            }
            
            return false; // ÈáçË§á„Å™„Åó
        }

        // ‰∫àÁ¥ÑÂèØËÉΩÊôÇÈñì„Çí„Éè„Ç§„É©„Ç§„Éà„Åô„ÇãÈñ¢Êï∞
        function highlightAvailableSlots() {
            const dateTime = document.getElementById('bookingDate')?.value;
            const duration = document.getElementById('bookingDuration')?.value;
            
            if (!dateTime || !duration) return;
            
            const startTime = new Date(dateTime);
            const endTime = new Date(startTime.getTime() + parseInt(duration) * 60 * 1000);
            const dateKey = formatDateKey(startTime);
            
            // Êó¢Â≠ò„ÅÆ„Éè„Ç§„É©„Ç§„Éà„Çí„ÇØ„É™„Ç¢
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('overlap-warning', 'available-slot');
            });
            
            // ÊåáÂÆöÊó•„ÅÆ‰∫àÁ¥Ñ„ÇíÂèñÂæó
            const dayReservations = reservations[dateKey] || [];
            
            // ÂêÑÊôÇÈñì„Çπ„É≠„ÉÉ„Éà„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            document.querySelectorAll('.time-slot').forEach(slot => {
                const slotTime = slot.getAttribute('data-time');
                if (!slotTime) return;
                
                const slotStart = new Date(`${dateKey}T${slotTime}`);
                const slotEnd = new Date(slotStart.getTime() + parseInt(duration) * 60 * 1000);
                
                // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇÇÂê´„ÇÄÔºâ
                let hasOverlap = false;
                for (const reservation of dayReservations) {
                    const reservationStart = new Date(`${dateKey}T${reservation.time}`);
                    const reservationEnd = new Date(reservationStart.getTime() + reservation.duration * 60 * 1000);
                    
                    // „Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇíÂèñÂæóÔºàeffective_interval_minutes„Çí‰ΩøÁî®Ôºâ
                    const intervalMinutes = reservation.effective_interval_minutes ?? 10;
                    const reservationEndWithInterval = new Date(reservationEnd.getTime() + intervalMinutes * 60 * 1000);
                    
                    // ÁèæÂú®„ÅÆ„Çπ„É≠„ÉÉ„Éà„ÅÆ„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñìÔºà„Éá„Éï„Ç©„É´„Éà10ÂàÜÔºâ
                    const currentIntervalMinutes = 10; // „Éá„Éï„Ç©„É´„Éà10ÂàÜ
                    const slotEndWithInterval = new Date(slotEnd.getTime() + currentIntervalMinutes * 60 * 1000);
                    
                    if (slotStart < reservationEndWithInterval && slotEndWithInterval > reservationStart) {
                        hasOverlap = true;
                        break;
                    }
                }
                
                if (hasOverlap) {
                    slot.classList.add('overlap-warning');
                } else {
                    slot.classList.add('available-slot');
                }
            });
        }

        // „Éâ„É©„ÉÉ„Ç∞&„Éâ„É≠„ÉÉ„ÉóÊ©üËÉΩ
        let isDragging = false;
        let draggedReservationData = null;

        function handleDragStart(e) {
            console.log('üéØ handleDragStart called for target:', e.target);
            isDragging = true;
            
            // The target should be the reservation block itself
            const reservationBlock = e.target;
            
            if (!reservationBlock || !reservationBlock.classList.contains('reservation-block')) {
                console.error('‚ùå Target is not a reservation block');
                return;
            }
            
            const reservationId = reservationBlock.dataset.reservationId;
            
            if (!reservationId) {
                console.error('‚ùå Reservation ID not found');
                return;
            }
            
            console.log('üéØ Drag started for reservation:', reservationId, 'from block:', reservationBlock);
            
            // Store the original reservation data for better debugging
            const reservationData = JSON.parse(reservationBlock.dataset.reservationData);
            draggedReservationData = reservationData; // Store globally
            
            console.log('üéØ Original reservation data:', {
                id: reservationData.id,
                customer: reservationData.customer,
                time: reservationData.time,
                date: reservationBlock.dataset.originalDateKey
            });
            
            e.dataTransfer.setData('text/plain', reservationId);
            reservationBlock.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            
            // Use the original block as the drag image so it follows the cursor
            e.dataTransfer.setDragImage(reservationBlock, 50, 25);
            
            // Prevent other drag events from firing
            e.stopPropagation();
        }

        function handleDragEnd(e) {
            // The target should be the reservation block itself
            const reservationBlock = e.target;
            
            if (reservationBlock && reservationBlock.classList.contains('reservation-block')) {
                reservationBlock.classList.remove('dragging');
            }
            
            document.querySelectorAll('.schedule-cell').forEach(cell => {
                cell.classList.remove('drag-over');
                cell.classList.remove('drag-over-invalid');
            });
            
                            // Â∞ë„ÅóÈÅÖÂª∂„Åó„Å¶„Åã„Çâ„Éï„É©„Ç∞„Çí„É™„Çª„ÉÉ„ÉàÔºàË™§„ÇØ„É™„ÉÉ„ÇØ„ÇíÈò≤„ÅêÔºâ
                setTimeout(() => {
                    isDragging = false;
                    draggedReservationData = null; // Clear global data
                }, 100);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const cell = e.target.closest('.schedule-cell');
            if (cell) {
                // Clear all previous drag-over states
                document.querySelectorAll('.schedule-cell').forEach(c => {
                    c.classList.remove('drag-over');
                    c.classList.remove('drag-over-invalid');
                });
                
                // Get the reservation data from global variable
                if (draggedReservationData) {
                    const reservationData = draggedReservationData;
                    const duration = reservationData.duration || 60;
                    const interval = reservationData.effective_interval_minutes ?? 10;
                    const totalDuration = duration + interval;
                    
                    // Calculate how many cells this reservation would occupy (10-minute slots)
                    const cellsToOccupy = Math.ceil(totalDuration / 10);
                    
                    // Check if all required cells are within business hours
                    let currentCell = cell;
                    let allCellsValid = true;
                    let cellsToCheck = [];
                    
                    // First, collect all cells that would be occupied
                    for (let i = 0; i < cellsToOccupy && currentCell; i++) {
                        cellsToCheck.push(currentCell);
                        
                        // Move to the next row (next time slot) in the same day column
                        const currentRow = currentCell.parentElement;
                        const nextRow = currentRow.nextElementSibling;
                        if (nextRow) {
                            const nextCell = nextRow.querySelector(`[data-day="${currentCell.dataset.day}"]`);
                            if (nextCell && nextCell.classList.contains('schedule-cell')) {
                                currentCell = nextCell;
                            } else {
                                break; // No more cells in this day column
                            }
                        } else {
                            break; // No more rows
                        }
                    }
                    
                    // Check if all cells are within business hours
                    for (let checkCell of cellsToCheck) {
                        const dayOfWeek = parseInt(checkCell.dataset.day);
                        const timeStr = checkCell.dataset.time;
                        
                        if (!isBusinessHour(dayOfWeek, timeStr)) {
                            allCellsValid = false;
                            break;
                        }
                    }
                    
                    // Only highlight if all cells are valid
                    if (allCellsValid) {
                        for (let checkCell of cellsToCheck) {
                            checkCell.classList.add('drag-over');
                        }
                    } else {
                        // Show invalid drop effect and visual feedback
                        e.dataTransfer.dropEffect = 'none';
                        for (let checkCell of cellsToCheck) {
                            checkCell.classList.add('drag-over-invalid');
                        }
                    }
                } else {
                    // If no dragged data, check if current cell is within business hours
                    const dayOfWeek = parseInt(cell.dataset.day);
                    const timeStr = cell.dataset.time;
                    
                    if (isBusinessHour(dayOfWeek, timeStr)) {
                        cell.classList.add('drag-over');
                    } else {
                        e.dataTransfer.dropEffect = 'none';
                    }
                }
            }
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (e.target.classList.contains('schedule-cell')) {
                e.target.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('schedule-cell')) {
                e.target.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // „Éâ„É©„ÉÉ„Ç∞„Ç™„Éº„Éê„ÉºÁä∂ÊÖã„Çí„ÇØ„É™„Ç¢
            document.querySelectorAll('.schedule-cell').forEach(cell => {
                cell.classList.remove('drag-over');
                cell.classList.remove('drag-over-invalid');
            });
            
            const cell = e.target.closest('.schedule-cell');
            if (!cell) return;
            
            const reservationId = e.dataTransfer.getData('text/plain');
            console.log('üéØ Drop detected for reservation:', reservationId, 'at cell:', cell.dataset.day, cell.dataset.time);
            
            if (!reservationId || reservationId.trim() === '') {
                console.log('‚ùå Empty reservation ID, ignoring drop');
                return;
            }
            
            const reservationBlock = document.querySelector(`[data-reservation-id="${reservationId}"]`);
            
            if (!reservationBlock) {
                console.log('‚ùå Reservation block not found for ID:', reservationId);
                return;
            }
            
            const reservationData = JSON.parse(reservationBlock.dataset.reservationData);
            const newDay = parseInt(cell.dataset.day);
            const newTime = cell.dataset.time;
            
            // Check if the target time slot is within business hours
            if (!isBusinessHour(newDay, newTime)) {
                showMessage('Âñ∂Ê•≠ÊôÇÈñìÂ§ñ„ÅÆ„Åü„ÇÅ„ÄÅ„Åì„ÅÆÊôÇÈñì„Å´‰∫àÁ¥Ñ„ÇíÁßªÂãï„Åß„Åç„Åæ„Åõ„Çì„ÄÇ', 'error');
                return;
            }
            
            // Check if all required time slots for the reservation are within business hours
            const duration = reservationData.duration || 60;
            const interval = reservationData.effective_interval_minutes ?? 10;
            const totalDuration = duration + interval;
            const cellsToOccupy = Math.ceil(totalDuration / 10);
            
            let currentCell = cell;
            let allSlotsValid = true;
            
            for (let i = 0; i < cellsToOccupy && currentCell; i++) {
                const dayOfWeek = parseInt(currentCell.dataset.day);
                const timeStr = currentCell.dataset.time;
                
                if (!isBusinessHour(dayOfWeek, timeStr)) {
                    allSlotsValid = false;
                    break;
                }
                
                // Move to the next row (next time slot) in the same day column
                const currentRow = currentCell.parentElement;
                const nextRow = currentRow.nextElementSibling;
                if (nextRow) {
                    const nextCell = nextRow.querySelector(`[data-day="${currentCell.dataset.day}"]`);
                    if (nextCell && nextCell.classList.contains('schedule-cell')) {
                        currentCell = nextCell;
                    } else {
                        break; // No more cells in this day column
                    }
                } else {
                    break; // No more rows
                }
            }
            
            if (!allSlotsValid) {
                showMessage('‰∫àÁ¥ÑÊôÇÈñì„ÅåÂñ∂Ê•≠ÊôÇÈñìÂ§ñ„Å´Âèä„Å∂„Åü„ÇÅ„ÄÅ„Åì„ÅÆ‰ΩçÁΩÆ„Å´ÁßªÂãï„Åß„Åç„Åæ„Åõ„Çì„ÄÇ', 'error');
                return;
            }
            
            // Êñ∞„Åó„ÅÑÊó•‰ªò„ÇíË®àÁÆó
            const newDate = new Date(currentWeekStart);
            newDate.setDate(newDate.getDate() + newDay);
            const newDateKey = formatDateKey(newDate);
            
            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
            console.log('üîç Checking for overlap:', {
                reservationId: reservationData.id,
                from: `${reservationBlock.dataset.originalDateKey} ${reservationBlock.dataset.originalTimeStr}`,
                to: `${newDateKey} ${newTime}`,
                duration: reservationData.duration,
                interval: reservationData.effective_interval_minutes ?? 10
            });
            
            // Âêå„ÅòÂ†¥ÊâÄ„Å´„Éâ„É≠„ÉÉ„Éó„Åó„ÅüÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
            if (reservationBlock.dataset.originalDateKey === newDateKey && 
                reservationBlock.dataset.originalTimeStr === newTime) {
                console.log('‚è≠Ô∏è Dropped in same location, ignoring');
                return;
            }
            
            if (checkForOverlapOnDrop(newDateKey, newTime, reservationData)) {
                showMessage('„Åì„ÅÆÊôÇÈñìÂ∏Ø„Å´„ÅØÊó¢„Å´‰∫àÁ¥Ñ„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂà•„ÅÆÊôÇÈñì„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 'error');
                return;
            }
            
            console.log('‚úÖ Proceeding with reservation update');
            
            // Prevent multiple updates for the same reservation
            if (reservationBlock.dataset.updating === 'true') {
                console.log('‚è≠Ô∏è Reservation already being updated, skipping');
                return;
            }
            
            reservationBlock.dataset.updating = 'true';
            updateReservationTime(reservationData.id, newDateKey, newTime);
        }

        // „Éâ„É≠„ÉÉ„ÉóÊôÇ„ÅÆÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØ
        function checkForOverlapOnDrop(dateKey, timeStr, reservationData) {
            const startTime = new Date(`${dateKey}T${timeStr}`);
            const endTime = new Date(startTime.getTime() + reservationData.duration * 60 * 1000);
            
            // ÊåáÂÆöÊó•„ÅÆ‰∫àÁ¥Ñ„ÇíÂèñÂæóÔºàËá™ÂàÜ‰ª•Â§ñÔºâ
            const dayReservations = reservations[dateKey] || [];
            
            console.log('üîç Checking overlaps for:', {
                dateKey: dateKey,
                timeStr: timeStr,
                reservationId: reservationData.id,
                duration: reservationData.duration,
                dayReservations: dayReservations.length
            });
            
            // ÈáçË§á„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇÇÂê´„ÇÄÔºâ
            for (const reservation of dayReservations) {
                if (reservation.id === reservationData.id) {
                    console.log('‚è≠Ô∏è Skipping self:', reservation.id);
                    continue; // Ëá™ÂàÜ„ÅØÈô§Â§ñ
                }
                
                const reservationStart = new Date(`${dateKey}T${reservation.time}`);
                const reservationEnd = new Date(reservationStart.getTime() + reservation.duration * 60 * 1000);
                
                // „Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇíÂèñÂæóÔºàeffective_interval_minutes„Çí‰ΩøÁî®Ôºâ
                const intervalMinutes = reservation.effective_interval_minutes ?? 10;
                const reservationEndWithInterval = new Date(reservationEnd.getTime() + intervalMinutes * 60 * 1000);
                
                // ÁèæÂú®„ÅÆ‰∫àÁ¥Ñ„ÅÆ„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì
                const currentIntervalMinutes = reservationData.effective_interval_minutes ?? 10;
                const currentEndWithInterval = new Date(endTime.getTime() + currentIntervalMinutes * 60 * 1000);
                
                console.log('üîç Comparing with reservation:', {
                    existingId: reservation.id,
                    existingTime: `${reservation.time} - ${new Date(reservationEndWithInterval).toTimeString().slice(0, 5)}`,
                    newTime: `${timeStr} - ${new Date(currentEndWithInterval).toTimeString().slice(0, 5)}`,
                    existingInterval: intervalMinutes,
                    newInterval: currentIntervalMinutes
                });
                
                // ÈáçË§áÂà§ÂÆöÔºà„Ç§„É≥„Çø„Éº„Éê„É´ÊôÇÈñì„ÇÇÂê´„ÇÄÔºâ
                if (startTime < reservationEndWithInterval && currentEndWithInterval > reservationStart) {
                    console.log('üö´ Overlap detected:', {
                        newReservation: `${timeStr} - ${new Date(currentEndWithInterval).toTimeString().slice(0, 5)}`,
                        existingReservation: `${reservation.time} - ${new Date(reservationEndWithInterval).toTimeString().slice(0, 5)}`,
                        date: dateKey
                    });
                    return true; // ÈáçË§á„ÅÇ„Çä
                }
            }
            
            console.log('‚úÖ No overlaps detected');
            return false; // ÈáçË§á„Å™„Åó
        }

        // ‰∫àÁ¥ÑÊôÇÈñì„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
        function updateReservationTime(reservationId, newDateKey, newTime) {
            // ÂÖÉ„ÅÆ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÂèñÂæó
            const originalDateKey = document.querySelector(`[data-reservation-id="${reservationId}"]`)?.dataset.originalDateKey;
            const originalTimeStr = document.querySelector(`[data-reservation-id="${reservationId}"]`)?.dataset.originalTimeStr;
            
            if (!originalDateKey || !originalTimeStr) {
                showMessage('‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
                return;
            }
            
            // Êñ∞„Åó„ÅÑÈñãÂßãÊôÇÈñì„ÇíISOÂΩ¢Âºè„Åß‰ΩúÊàê
            const newStartTime = `${newDateKey}T${newTime}`;
            
            // „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Å´Êõ¥Êñ∞„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            
            // ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶„Ç≥„Éº„ÇπÊÉÖÂ†±„ÇÇÂê´„ÇÅ„Çã
            const reservationBlock = document.querySelector(`[data-reservation-id="${reservationId}"]`);
            const reservationData = reservationBlock ? JSON.parse(reservationBlock.dataset.reservationData) : null;
            
            fetch(`/admin/reservations/${reservationId}/update_booking`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': csrfToken
                },
                body: JSON.stringify({
                    reservation: {
                        start_time: newStartTime,
                        course: reservationData ? `${reservationData.duration}ÂàÜ` : undefined
                    }
                })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorData.message || 'Unknown error'}`);
                    }).catch(() => {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // „É≠„Éº„Ç´„É´„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
                    updateLocalReservationData(reservationId, newDateKey, newTime);
                    
                    // updatedAt„Éï„Ç£„Éº„É´„Éâ„ÇíÊõ¥Êñ∞
                    if (data.reservation && data.reservation.updated_at) {
                        // „Ç∞„É≠„Éº„Éê„É´reservations„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆupdatedAt„ÇíÊõ¥Êñ∞
                        const reservationIndex = reservations[newDateKey].findIndex(r => r.id === parseInt(reservationId));
                        if (reservationIndex !== -1) {
                            reservations[newDateKey][reservationIndex].updatedAt = data.reservation.updated_at;
                        }
                        
                        // ÁèæÂú®Èñã„ÅÑ„Å¶„ÅÑ„Çã„É¢„Éº„ÉÄ„É´„ÅÆÂ§âÊõ¥Êó•ÊôÇ„ÇíÂç≥Â∫ß„Å´Êõ¥Êñ∞
                        if (currentReservation && currentReservation.id === parseInt(reservationId)) {
                            console.log('üîÑ Updating currentReservation after drag-and-drop:', {
                                before: {
                                    time: currentReservation.time,
                                    date: currentReservation.date,
                                    dateKey: currentReservation.dateKey,
                                    start_time: currentReservation.start_time
                                }
                            });
                            
                            currentReservation.updatedAt = data.reservation.updated_at;
                            // Êó•‰ªò„Å®ÊôÇÈñì„ÇÇÊõ¥Êñ∞
                            currentReservation.time = newTime;
                            currentReservation.date = newDateKey;
                            currentReservation.dateKey = newDateKey;
                            // start_time„ÇÇÊõ¥Êñ∞
                            const [hours, minutes] = newTime.split(':');
                            const newStartTime = new Date(`${newDateKey}T${hours}:${minutes}:00+09:00`);
                            currentReservation.start_time = newStartTime.toISOString();
                            
                            console.log('üîÑ Updated currentReservation after drag-and-drop:', {
                                after: {
                                    time: currentReservation.time,
                                    date: currentReservation.date,
                                    dateKey: currentReservation.dateKey,
                                    start_time: currentReservation.start_time
                                }
                            });
                            
                            updateModalUpdatedAt(data.reservation.updated_at);
                        } else {
                            console.log('‚ùå currentReservation not found or ID mismatch:', {
                                currentReservation: currentReservation ? currentReservation.id : 'null',
                                reservationId: reservationId
                            });
                            
                            // „É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅÊúÄÊñ∞„ÅÆ„Éá„Éº„Çø„ÅßcurrentReservation„ÇíÊõ¥Êñ∞
                            const modal = document.getElementById('reservationDetailModal');
                            console.log('üîç Modal display status:', modal ? modal.style.display : 'modal not found');
                            
                            if (modal && modal.style.display === 'block') {
                                console.log('üîç Modal is open, updating currentReservation...');
                                // ÊúÄÊñ∞„ÅÆ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶currentReservation„ÇíÊõ¥Êñ∞
                                for (const dateKey of Object.keys(reservations)) {
                                    const dayReservations = reservations[dateKey];
                                    const foundReservation = dayReservations.find(r => r.id === parseInt(reservationId));
                                    if (foundReservation) {
                                        currentReservation = foundReservation;
                                        console.log('üîÑ Updated currentReservation from reservations data:', {
                                            time: currentReservation.time,
                                            date: currentReservation.date,
                                            dateKey: currentReservation.dateKey,
                                            start_time: currentReservation.start_time
                                        });
                                        break;
                                    }
                                }
                            } else {
                                console.log('üîç Modal is not open, skipping currentReservation update');
                            }
                        }
                    }
                    
                    // „Ç´„É¨„É≥„ÉÄ„Éº„ÇíÂÜçÊèèÁîª
                    console.log('üîÑ Regenerating calendar after reservation move');
                    generateTimeSlots();
                    
                    showMessage('‰∫àÁ¥ÑÊôÇÈñì„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü„ÄÇ', 'success');
                } else {
                    showMessage(`‰∫àÁ¥Ñ„ÅÆÊõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ${data.message}`, 'error');
                }
                
                // Reset updating flag
                const reservationBlock = document.querySelector(`[data-reservation-id="${reservationId}"]`);
                if (reservationBlock) {
                    reservationBlock.dataset.updating = 'false';
                }
            })
            .catch(error => {
                console.error('Error updating reservation:', error);
                showMessage('‰∫àÁ¥Ñ„ÅÆÊõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇ', 'error');
                
                // Reset updating flag on error
                const reservationBlock = document.querySelector(`[data-reservation-id="${reservationId}"]`);
                if (reservationBlock) {
                    reservationBlock.dataset.updating = 'false';
                }
            });
        }

        // „É≠„Éº„Ç´„É´‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
        function updateLocalReservationData(reservationId, newDateKey, newTime) {
            console.log('üîÑ Updating local reservation data:', {
                reservationId: reservationId,
                newDateKey: newDateKey,
                newTime: newTime
            });
            
            // ÂÖÉ„ÅÆ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÂèñÂæó
            let originalReservationData = null;
            let originalDateKey = null;
            
            // ÂÖÉ„ÅÆ‰∫àÁ¥Ñ„ÇíË¶ã„Å§„Åë„Å¶ÂâäÈô§
            for (const dateKey of Object.keys(reservations)) {
                const reservationIndex = reservations[dateKey].findIndex(r => r.id === parseInt(reservationId));
                if (reservationIndex !== -1) {
                    originalReservationData = { ...reservations[dateKey][reservationIndex] };
                    originalDateKey = dateKey;
                    reservations[dateKey].splice(reservationIndex, 1);
                    
                    // Á©∫„ÅÆÈÖçÂàó„ÅÆÂ†¥Âêà„ÅØÊó•‰ªò„Ç≠„Éº„ÇíÂâäÈô§
                    if (reservations[dateKey].length === 0) {
                        delete reservations[dateKey];
                    }
                    break;
                }
            }
            
            if (!originalReservationData) {
                console.error('‚ùå Original reservation data not found for ID:', reservationId);
                return;
            }
            
            // Êñ∞„Åó„ÅÑÂ†¥ÊâÄ„Å´‰∫àÁ¥Ñ„ÇíËøΩÂä†
            if (!reservations[newDateKey]) {
                reservations[newDateKey] = [];
            }
            
            // ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
            const updatedReservationData = {
                ...originalReservationData,
                time: newTime,
                date: newDateKey,
                dateKey: newDateKey,
                // start_time„ÇÇÊõ¥Êñ∞
                start_time: new Date(`${newDateKey}T${newTime}:00+09:00`).toISOString()
            };
            
            reservations[newDateKey].push(updatedReservationData);
            
            // DOMË¶ÅÁ¥†„ÅÆ„Éá„Éº„ÇøÂ±ûÊÄß„ÇÇÊõ¥Êñ∞
            const reservationBlock = document.querySelector(`[data-reservation-id="${reservationId}"]`);
            if (reservationBlock) {
                reservationBlock.dataset.originalDateKey = newDateKey;
                reservationBlock.dataset.originalTimeStr = newTime;
                reservationBlock.dataset.reservationData = JSON.stringify(updatedReservationData);
            }
            
            console.log('‚úÖ Local reservation data updated:', {
                from: originalDateKey,
                to: newDateKey,
                reservationId: reservationId
            });
        }

        // ‰∫àÁ¥Ñ„Éá„Éº„Çø„ÅÆÂ¶•ÂΩìÊÄß„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åô„ÇãÈñ¢Êï∞
        function validateReservationData(reservation) {
            if (!reservation) {
                console.error('‚ùå Reservation is null or undefined');
                return false;
            }
            
            if (!reservation.id || reservation.id === 'null' || reservation.id === null) {
                console.error('‚ùå Invalid reservation ID:', reservation.id);
                return false;
            }
            
            if (!reservation.userId || reservation.userId === 'null' || reservation.userId === null) {
                console.warn('‚ö†Ô∏è No user ID for reservation:', reservation.id);
                // Don't return false - allow modal to open without userId
            }
            

            
            return true;
        }

                // „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢Ê©üËÉΩ
        function setupUserSearch() {
            const customerNameInput = document.getElementById('customerName');
            const searchResults = document.getElementById('userSearchResults');
            
            if (!customerNameInput || !searchResults) return;
            
            // ÂÖ•Âäõ„Ç§„Éô„É≥„Éà
            customerNameInput.addEventListener('input', function() {
                const query = this.value.trim();
                
                // „Éá„Éê„Ç¶„É≥„ÇπÂá¶ÁêÜ
                if (searchTimeout) {
                    clearTimeout(searchTimeout);
                }
                
                if (query.length < 2) {
                    hideUserSearchResults();
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchUsers(query);
                }, 300);
            });
            
            // „Éï„Ç©„Éº„Ç´„Çπ„Ç¢„Ç¶„ÉàÊôÇ„Å´ÁµêÊûú„ÇíÈö†„Åô
            customerNameInput.addEventListener('blur', function() {
                setTimeout(() => {
                    hideUserSearchResults();
                }, 200);
            });
            
            // „Éï„Ç©„Éº„Ç´„ÇπÊôÇ„Å´ÁµêÊûú„ÇíË°®Á§∫ÔºàÂÖ•Âäõ„Åå„ÅÇ„ÇãÂ†¥ÂêàÔºâ
            customerNameInput.addEventListener('focus', function() {
                const query = this.value.trim();
                if (query.length >= 2) {
                    searchUsers(query);
                }
            });
        }
        
        function searchUsers(query) {

            
            fetch(`/admin/reservations/search_users?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayUserSearchResults(data.users);
    } else {
                        console.error('‚ùå User search failed:', data.message);
                        hideUserSearchResults();
    }
  })
  .catch(error => {
                    console.error('‚ùå Error searching users:', error);
                    hideUserSearchResults();
                });
        }
        
        function displayUserSearchResults(users) {
            const searchResults = document.getElementById('userSearchResults');
            if (!searchResults) return;
            
            if (users.length === 0) {
                searchResults.innerHTML = '<div class="user-search-item">Ë©≤ÂΩì„Åô„Çã„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</div>';
                searchResults.style.display = 'block';
                return;
            }
            
            const resultsHtml = users.map(user => `
                <div class="user-search-item" onclick="selectUser(${user.id}, '${user.name}', '${user.phone_number}', '${user.email}')">
                    <div class="user-name">${user.name}</div>
                    <div class="user-details">
                        üìû ${user.phone_number || 'Êú™Ë®≠ÂÆö'} | üìß ${user.email || 'Êú™Ë®≠ÂÆö'}
                        ${user.active_tickets > 0 ? `<span class="user-tickets"> | üé´ ÊÆã${user.active_tickets}Êûö</span>` : ''}
                        ${user.last_visit !== '„Å™„Åó' ? ` | üìÖ ÊúÄÁµÇÊù•Â∫ó: ${user.last_visit}` : ''}
                    </div>
                </div>
            `).join('');
            
            searchResults.innerHTML = resultsHtml;
            searchResults.style.display = 'block';
        }
        
        function selectUser(userId, name, phone, email) {

            
            // „Éï„Ç©„Éº„É†„Éï„Ç£„Éº„É´„Éâ„ÇíÊõ¥Êñ∞
            document.getElementById('customerName').value = name;
            document.getElementById('customerPhone').value = phone;
            document.getElementById('customerEmail').value = email;
            
            // Ê§úÁ¥¢ÁµêÊûú„ÇíÈö†„Åô
            hideUserSearchResults();
            
            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
            showMessage(`Êó¢Â≠ò„É¶„Éº„Ç∂„Éº„Äå${name}„Äç„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`, 'success');
        }
        
        function hideUserSearchResults() {
            console.log('üîç hideUserSearchResults called');
            const searchResults = document.getElementById('userSelectionSearchResults');
            if (searchResults) {
                searchResults.style.display = 'none';
                searchResults.innerHTML = ''; // Also clear the content
                console.log('üîç Search results hidden and cleared');
            } else {
                console.log('üîç Search results element not found for hiding');
            }
        }

        // „Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„Ç®„É™„Ç¢„Å´‰∫àÁ¥Ñ„ÇíËøΩÂä†
        function addToCancellationDisplay(reservation) {
            if (!reservation) {
                console.error('‚ùå Reservation is null or undefined');
                return;
            }
            
            // ‰∫àÁ¥Ñ„ÅÆÂÆüÈöõ„ÅÆÊó•‰ªò„ÇíÁâπÂÆö
            let actualReservationDate = null;
            
            // start_time„ÅåÂà©Áî®ÂèØËÉΩ„Å™Â†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®ÔºàÊúÄÂÑ™ÂÖàÔºâ
            if (reservation.start_time) {
                actualReservationDate = new Date(reservation.start_time);
            } else {
                // reservations„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„Åã„ÇâÊ§úÁ¥¢
                for (const dateKey of Object.keys(reservations)) {
                    const dayReservations = reservations[dateKey];
                    const foundReservation = dayReservations.find(r => r.id === reservation.id);
                    if (foundReservation) {
                        const [year, month, day] = dateKey.split('-').map(Number);
                        actualReservationDate = new Date(year, month - 1, day);
                        break;
                    }
                }
                
                // Ë¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØcreatedAt„Åã„ÇâË®àÁÆó
                if (!actualReservationDate) {
                    actualReservationDate = new Date(reservation.createdAt);
                }
            }
            
            const cancellationData = {
                id: reservation.id,
                customer: reservation.customer,
                time: reservation.time,
                duration: reservation.duration,
                date: actualReservationDate.toLocaleDateString('ja-JP'),
                cancelledAt: new Date().toLocaleString('ja-JP')
            };
            
            cancelledReservations.unshift(cancellationData); // ÊúÄÊñ∞„ÇíÂÖàÈ†≠„Å´ËøΩÂä†
  
  // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
            saveCancelledReservations();
            

            
            // Âç≥Â∫ß„Å´Êõ¥Êñ∞„ÇíË©¶Ë°åÔºàÊ¨°„ÅÆ„Éï„É¨„Éº„É†„ÅßÂÆüË°åÔºâ
            requestAnimationFrame(() => {
                updateCancellationDisplayImmediately();
            });
        }

        // „Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„Ç®„É™„Ç¢„ÇíÊõ¥Êñ∞ÔºàÂç≥Â∫ß„Å´ÂÆüË°åÔºâ
        // ÁèæÂú®„ÅÆÈÄ±„ÅÆ„Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function getCurrentWeekCancellations() {
            const weekStart = new Date(currentWeekStart);
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            
            return cancelledReservations.filter(reservation => {
                const reservationDate = new Date(reservation.date);
                return reservationDate >= weekStart && reservationDate <= weekEnd;
            });
        }

        function updateCancellationDisplayImmediately() {
            const btn = document.getElementById('showCancellationsBtn');
            const countSpan = document.getElementById('cancellation-count');
            const display = document.getElementById('cancellation-display');
            const list = document.getElementById('cancellation-list');
            
            // ÁèæÂú®„ÅÆÈÄ±„ÅÆ„Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥„ÇíÂèñÂæó
            const currentWeekCancellations = getCurrentWeekCancellations();
            
            console.log('üîÑ Attempting to update cancellation display, total count:', cancelledReservations.length, 'current week:', currentWeekCancellations.length);
            console.log('üîç Elements found:', { btn: !!btn, countSpan: !!countSpan, display: !!display, list: !!list });
            
            // „Éú„Çø„É≥„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØÂç≥Â∫ß„Å´Êõ¥Êñ∞Ôºàspan„Åå„Å™„Åè„Å¶„ÇÇ„Éú„Çø„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÁõ¥Êé•Êõ¥Êñ∞Ôºâ
            if (btn) {
                console.log('üîÑ Updating cancellation display immediately, current week count:', currentWeekCancellations.length);
                
                // „Éú„Çø„É≥„ÅÆÁä∂ÊÖã„ÇíÊõ¥Êñ∞Ôºàspan„Åå„Å™„Åè„Å¶„ÇÇÁõ¥Êé•„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞Ôºâ
                if (currentWeekCancellations.length === 0) {
                    btn.disabled = false;
                    btn.textContent = `‚ùå „Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥ (0)`;
                    if (display) {
                        display.style.display = 'none';
                    }
                    console.log('‚úÖ Updated cancellation display for 0 cancellations in current week');
    } else {
                    btn.disabled = false;
                    btn.textContent = `‚ùå „Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥ (${currentWeekCancellations.length})`;
                    console.log('‚úÖ Updated cancellation display for', currentWeekCancellations.length, 'cancellations in current week');
                }
                
                // span„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„ÇÇÊõ¥Êñ∞
                if (countSpan) {
                    countSpan.textContent = currentWeekCancellations.length;
                }
                
                // „É™„Çπ„Éà„ÇíÊõ¥Êñ∞ÔºàË°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
                if (display && display.style.display === 'block' && list) {
                    const listHtml = currentWeekCancellations.map(reservation => `
                        <div class="cancellation-item">
                            <div class="cancellation-info">
                                <div class="cancellation-customer">${reservation.customer}</div>
                                <div class="cancellation-details">
                                    üìÖ ${reservation.date} <span class="cancellation-time">${reservation.time}</span> | 
                                    ‚è±Ô∏è ${reservation.duration}ÂàÜ | 
                                    üóëÔ∏è ${reservation.cancelledAt}
                                </div>
                            </div>
                        </div>
                    `).join('');
                    
                    list.innerHTML = listHtml;
                }
            } else {
                if (!domReady) {
                    console.log('‚ö†Ô∏è DOM not ready yet, will update when ready');
                    // DOM„ÅåÊ∫ñÂÇô„Åß„Åç„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂæå„ÅßÊõ¥Êñ∞
                    setTimeout(() => {
                        updateCancellationDisplayImmediately();
                    }, 200);
                } else {
                    console.log('‚ö†Ô∏è Cancellation button not found, will update later');
                    // Ë¶ÅÁ¥†„ÅåÊ∫ñÂÇô„Åß„Åç„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂæå„ÅßÊõ¥Êñ∞Ôºà„Çà„ÇäÈï∑„ÅÑÈñìÈöî„ÅßÔºâ
                    setTimeout(() => {
                        updateCancellationDisplayImmediately();
                    }, 100);
                }
            }
        }

        // „Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„Ç®„É™„Ç¢„ÇíÊõ¥Êñ∞ÔºàÂæÖÊ©üÁâàÔºâ
        function updateCancellationDisplay() {
            // Âç≥Â∫ß„Å´Êõ¥Êñ∞„ÇíË©¶Ë°å
            updateCancellationDisplayImmediately();
        }

        // „Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„Ç®„É™„Ç¢„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
        function toggleCancellationDisplay() {
            const display = document.getElementById('cancellation-display');
            const btn = document.getElementById('showCancellationsBtn');
            const list = document.getElementById('cancellation-list');
            
            // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÊó©Êúü„É™„Çø„Éº„É≥
            if (!display || !btn || !list) {
                console.error('‚ùå Cancellation display elements not found');
                showMessage('„Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„Ç®„É™„Ç¢„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ', 'error');
                return;
            }
            
            if (display.style.display === 'none') {
                // Ë°®Á§∫„Åô„Çã
                display.style.display = 'block';
                btn.classList.add('active');
                
                // ÁèæÂú®„ÅÆÈÄ±„ÅÆ„Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥„ÇíÂèñÂæó„Åó„Å¶„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
                const currentWeekCancellations = getCurrentWeekCancellations();
                const listHtml = currentWeekCancellations.map(reservation => `
                    <div class="cancellation-item">
                        <div class="cancellation-info">
                            <div class="cancellation-customer">${reservation.customer}</div>
                            <div class="cancellation-details">
                                üìÖ ${reservation.date} <span class="cancellation-time">${reservation.time}</span> | 
                                ‚è±Ô∏è ${reservation.duration}ÂàÜ | 
                                üóëÔ∏è ${reservation.cancelledAt}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                list.innerHTML = listHtml;
                
                showMessage('„Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥„ÇíË°®Á§∫„Åó„Åæ„Åó„Åü„ÄÇ', 'info');
            } else {
                // ÈùûË°®Á§∫„Å´„Åô„Çã
                display.style.display = 'none';
                btn.classList.remove('active');
                showMessage('„Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥„ÇíÈùûË°®Á§∫„Å´„Åó„Åæ„Åó„Åü„ÄÇ', 'info');
            }
        }

        // „Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
        function clearCancellationDisplay() {
            console.log('üóëÔ∏è Clearing cancellation display...');
            
            // „Éá„Éº„Çø„Çí„ÇØ„É™„Ç¢
            cancelledReservations = [];
            
            // „É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Åã„Çâ„ÇÇÂâäÈô§
            localStorage.removeItem('cancelledReservations');
            
            // Ë¶ÅÁ¥†„ÇíÂèñÂæó
            const display = document.getElementById('cancellation-display');
            const btn = document.getElementById('showCancellationsBtn');
            const countSpan = document.getElementById('cancellation-count');
            const list = document.getElementById('cancellation-list');
            
            // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÊìç‰Ωú
            if (btn && countSpan) {
                // „Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
                countSpan.textContent = '0';
                btn.textContent = '‚ùå „Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥ (0)';
                btn.disabled = false;
            }
            
            if (display) {
                display.style.display = 'none';
            }
            
            if (btn) {
                btn.classList.remove('active');
            }
            
            if (list) {
                list.innerHTML = '';
            }
            
            console.log('‚úÖ Cancellation display cleared successfully');
            
            // Âç≥Â∫ß„Å´Êõ¥Êñ∞
            updateCancellationDisplayImmediately();
            
            showMessage('„Ç≠„É£„É≥„Çª„É´Â±•Ê≠¥„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü„ÄÇ', 'info');
        }
        
        // „Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„ÅÆÂàùÊúüÂåñÔºàÂç≥Â∫ß„Å´ÂÆüË°åÔºâ
        function initializeCancellationDisplay() {
            console.log('üöÄ Starting cancellation display initialization...');
            loadCancelledReservations();
            
            // Âç≥Â∫ß„Å´Êõ¥Êñ∞„ÇíË©¶Ë°å
            setTimeout(() => {
                updateCancellationDisplayImmediately();
                cancellationDisplayReady = true;
                console.log('‚úÖ Cancellation display initialized successfully');
            }, 100);
        }
        
        // ÂàùÊúüÂåñÂÆüË°å
        init();
        
        // DOM„ÅåÂÆåÂÖ®„Å´Ë™≠„ÅøËæº„Åæ„Çå„Å¶„Åã„Çâ„Ç≠„É£„É≥„Çª„É´Ë°®Á§∫„ÇíÂàùÊúüÂåñ
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                domReady = true;
                setTimeout(() => {
                    initializeCancellationDisplay();
                }, 100);
            });
        } else {
            // DOM„ÅåÊó¢„Å´Ë™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
            domReady = true;
            setTimeout(() => {
                initializeCancellationDisplay();
            }, 100);
        }
        
        // „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢Ê©üËÉΩ„ÇíÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            setupUserSearch();
        });
</script> 

    <!-- „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Áî®CSS -->
    <style>
        @keyframes slideInRight {
            from { transform: translateX(300px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(300px); opacity: 0; }
        }
        
        /* „Ç∑„Éï„ÉàÂ§âÊõ¥Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÅÆ„Çπ„Çø„Ç§„É´ */
        #shiftChangeModal {
            z-index: 1050;
            overflow: hidden;
        }
        
        #shiftChangeModal .modal-dialog {
            max-width: 1400px;
            width: 98%;
            margin: 0.5rem auto;
            overflow: hidden;
        }
        
        #shiftChangeModal .modal-content {
            max-height: 55vh;
            height: 50vh;
            overflow: hidden;
        }
        
        #shiftChangeModal .modal-body {
            padding: 1rem;
            max-height: 35vh;
            height: 25vh;
            overflow: hidden;
            font-size: 1.1rem;
        }
        
        #shiftChangeModal .table {
            font-size: 1rem;
            margin-bottom: 0;
        }
        
        #shiftChangeModal .table-responsive {
            overflow: hidden !important;
        }
        
        #shiftChangeModal .alert {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            font-size: 0.9em;
        }
        
        #shiftChangeModal .modal-footer {
            padding: 0.75rem 1.5rem 1rem 1.5rem;
            border-top: 1px solid #dee2e6;
            text-align: center;
        }
        
        #shiftChangeModal .modal-footer .btn {
            min-width: 80px;
            margin: 0 auto;
            padding: 0.375rem 1rem;
            font-size: 0.9rem;
        }
        
        #shiftChangeModal .modal-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        #shiftChangeModal .modal-title {
            font-size: 1.1rem;
        }
        
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1040;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</body>
</html> 
</html> 
</html> 