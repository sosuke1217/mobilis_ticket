<!-- app/views/admin/reservations/calendar.html.erb ã®ä¿®æ­£ç‰ˆ -->
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div class="btn-group">
      <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
        è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#" id="showAllReservations">å…¨ã¦ã®äºˆç´„</a></li>
        <li><a class="dropdown-item" href="#" id="showConfirmedOnly">ç¢ºå®šäºˆç´„ã®ã¿</a></li>
        <li><a class="dropdown-item" href="#" id="showTentativeOnly">ä»®äºˆç´„ã®ã¿</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="#" id="showRecurringOnly">ç¹°ã‚Šè¿”ã—äºˆç´„ã®ã¿</a></li>
      </ul>
    </div>
  </div>

  <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
  <div id="flash"></div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡¡ä¾‹ -->
  <div class="card mb-3">
    <div class="card-body py-2">
      <div class="row align-items-center">
        <div class="col-auto">
          <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡¡ä¾‹ï¼š</strong>
        </div>
        <div class="col">
          <span class="badge bg-success me-2">ç¢ºå®š</span>
          <span class="badge bg-warning text-dark me-2">ä»®äºˆç´„</span>
          <span class="badge bg-danger me-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
          <span class="badge bg-secondary me-2">å®Œäº†</span>
          <span class="badge bg-warning me-2">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="table-responsive">
    <div id="calendar" style="width: 100%; max-width: 100%; margin: auto;"></div>
  </div>
</div>

<!-- äºˆç´„è©³ç´°ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆä¿®æ­£ç‰ˆï¼‰ -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reservationModalLabel">äºˆç´„ç®¡ç†</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
      </div>
      <div class="modal-body">
        <form id="reservationForm">
          <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
          <input type="hidden" id="reservationId">
          
          <!-- åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="card mb-3">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">äºˆç´„è€…é¸æŠ</h6>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="newUserToggle">
                  <label class="form-check-label" for="newUserToggle">
                    æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
                  </label>
                </div>
              </div>
            </div>
            <div class="card-body">
              <!-- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ -->
              <div id="existingUserSection">
                <label for="reservationUserId" class="form-label">æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</label>
                <select class="form-control" id="reservationUserId">
                  <option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>

              <!-- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
              <div id="newUserSection" style="display: none;">
                <div class="row">
                  <div class="col-md-6">
                    <label for="newUserName" class="form-label">æ°å <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="newUserName" placeholder="ä¾‹: å±±ç”°å¤ªéƒ">
                  </div>
                  <div class="col-md-6">
                    <label for="newUserPhone" class="form-label">é›»è©±ç•ªå·</label>
                    <input type="tel" class="form-control" id="newUserPhone" placeholder="ä¾‹: 090-1234-5678">
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-md-6">
                    <label for="newUserEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" class="form-control" id="newUserEmail" placeholder="ä¾‹: example@email.com">
                  </div>
                  <div class="col-md-6">
                    <label for="newUserBirthDate" class="form-label">ç”Ÿå¹´æœˆæ—¥</label>
                    <input type="date" class="form-control" id="newUserBirthDate">
                  </div>
                </div>
                <div class="mt-2">
                  <label for="newUserAddress" class="form-label">ä½æ‰€</label>
                  <input type="text" class="form-control" id="newUserAddress" placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒº...">
                </div>
                <div class="mt-2">
                  <label for="newUserMemo" class="form-label">ç®¡ç†è€…ãƒ¡ãƒ¢</label>
                  <textarea class="form-control" id="newUserMemo" rows="2" placeholder="åˆå›æ¥åº—ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±ãªã©"></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- äºˆç´„è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">äºˆç´„è©³ç´°</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <label for="reservationDate" class="form-label">äºˆç´„æ—¥</label>
                  <input type="date" class="form-control" id="reservationDate" required>
                </div>
                <div class="col-md-6">
                  <label for="reservationTime" class="form-label">é–‹å§‹æ™‚é–“</label>
                  <select class="form-control" id="reservationTime" required>
                    <option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                  </select>
                </div>
              </div>

              <div class="row mt-2">
                <div class="col-md-6">
                  <label for="reservationCourse" class="form-label">ã‚³ãƒ¼ã‚¹</label>
                  <select class="form-control" id="reservationCourse">
                    <option value="40åˆ†">40åˆ†ã‚³ãƒ¼ã‚¹</option>
                    <option value="60åˆ†" selected>60åˆ†ã‚³ãƒ¼ã‚¹</option>
                    <option value="80åˆ†">80åˆ†ã‚³ãƒ¼ã‚¹</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">çµ‚äº†äºˆå®šæ™‚é–“</label>
                  <div id="endTimeDisplay" class="form-control-plaintext text-muted">æ™‚é–“ã¨ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                </div>
              </div>

              <div class="row mt-2">
                <div class="col-md-6">
                  <label for="reservationStatus" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                  <select class="form-control" id="reservationStatus">
                    <option value="confirmed">ç¢ºå®š</option>
                    <option value="tentative">ä»®äºˆç´„</option>
                    <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                    <option value="completed">å®Œäº†</option>
                    <option value="no_show">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <!-- ç©ºãã‚¹ãƒšãƒ¼ã‚¹ -->
                </div>
              </div>

              <div class="mt-2">
                <label for="reservationNote" class="form-label">å‚™è€ƒ</label>
                <textarea class="form-control" id="reservationNote" rows="2" placeholder="ç‰¹åˆ¥ãªè¦æœ›ã‚„æ³¨æ„äº‹é …ãªã©"></textarea>
              </div>

              <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±å…¥åŠ›ã‚¨ãƒªã‚¢ -->
              <div id="cancellationReasonArea" style="display: none;" class="mt-3">
                <label for="cancellationReason" class="form-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”± <span class="text-danger">*</span></label>
                <textarea class="form-control" id="cancellationReason" rows="3" placeholder="ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
              </div>
            </div>
          </div>
        </form>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="d-flex justify-content-between mt-4">
          <div>
            <button type="button" id="deleteReservationBtn" class="btn btn-danger d-none">
              <i class="fas fa-trash me-1"></i>å‰Šé™¤
            </button>
            <button type="button" id="cancelReservationBtn" class="btn btn-warning d-none">
              <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
          <div>
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            <button type="button" id="saveReservationBtn" class="btn btn-primary">
              <i class="fas fa-save me-1"></i>ä¿å­˜
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- app/views/admin/reservations/calendar.html.erb ã®ä¿®æ­£ç‰ˆï¼ˆscriptã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã¿ï¼‰ -->

<script>
// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ã®JavaScriptï¼ˆå®Œå…¨ä¿®æ­£ç‰ˆï¼‰
(function() {
  'use strict';
  
  let pageCalendar = null;
  let currentUsers = [];
  
  // ===== ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤ =====
  
  /**
   * æ™‚é–“ã‚’10åˆ†åˆ»ã¿ã«èª¿æ•´ã™ã‚‹é–¢æ•°
   */
  function adjustTimeToTenMinutes(timeString) {
    if (!timeString) return "10:00";
    
    try {
      const [hours, minutes] = timeString.split(':').map(Number);
      
      // å–¶æ¥­æ™‚é–“ãƒã‚§ãƒƒã‚¯ï¼ˆ10:00-19:50ï¼‰
      if (hours < 10) {
        return "10:00";
      } else if (hours > 19 || (hours === 19 && minutes > 50)) {
        return "19:50";
      }
      
      // 10åˆ†åˆ»ã¿ã«èª¿æ•´
      const adjustedMinutes = Math.round(minutes / 10) * 10;
      
      // 60åˆ†ã‚’è¶…ãˆãŸå ´åˆã®å‡¦ç†
      if (adjustedMinutes >= 60) {
        const newHours = hours + 1;
        if (newHours > 19) {
          return "19:50";
        }
        return `${newHours.toString().padStart(2, '0')}:00`;
      }
      
      return `${hours.toString().padStart(2, '0')}:${adjustedMinutes.toString().padStart(2, '0')}`;
    } catch (error) {
      console.error('Time adjustment error:', error);
      return "10:00";
    }
  }
  
  /**
   * ã‚³ãƒ¼ã‚¹ã‹ã‚‰åˆ†æ•°ã‚’å–å¾—ã™ã‚‹é–¢æ•°
   */
  function getDurationFromCourse(course) {
    switch(course) {
      case '40åˆ†': return 40;
      case '60åˆ†': return 60;
      case '80åˆ†': return 80;
      default: return 60;
    }
  }
  
  // ===== ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ =====
  
  // åˆæœŸåŒ–é–¢æ•°
  function initializeCalendar() {
    console.log('ğŸ“… Calendar initialization started');
    
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl || typeof FullCalendar === 'undefined') {
      console.log('Calendar element or FullCalendar not found, retrying...');
      setTimeout(initializeCalendar, 500);
      return;
    }
    
    if (pageCalendar) {
      pageCalendar.destroy();
      pageCalendar = null;
    }
    
    pageCalendar = new FullCalendar.Calendar(calendarEl, {
      initialView: window.innerWidth < 768 ? "timeGridDay" : "timeGridWeek",
      locale: 'ja',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'timeGridWeek,timeGridDay'
      },
      slotMinTime: "10:00:00",
      slotMaxTime: "20:30:00",
      slotDuration: "00:10:00",
      scrollTime: "10:00:00",
      height: "auto",
      
      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–
      editable: true,
      droppable: true,
      eventStartEditable: true,
      eventDurationEditable: true,
      snapDuration: '00:10:00',
      
      events: {
        url: "/admin/reservations.json",
        failure: function() {
          console.error("Failed to fetch events");
        }
      },
      
      // ã‚¤ãƒ™ãƒ³ãƒˆã®è‰²ã‚’ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦å¤‰æ›´
      eventDidMount: function(info) {
        const status = info.event.extendedProps.status;
        let backgroundColor, borderColor;
        
        switch(status) {
          case 'confirmed':
            backgroundColor = '#28a745';
            borderColor = '#1e7e34';
            break;
          case 'tentative':
            backgroundColor = '#ffc107';
            borderColor = '#e0a800';
            info.el.style.color = '#000';
            break;
          case 'cancelled':
            backgroundColor = '#dc3545';
            borderColor = '#c82333';
            info.el.style.textDecoration = 'line-through';
            break;
          case 'completed':
            backgroundColor = '#6c757d';
            borderColor = '#5a6268';
            break;
          case 'no_show':
            backgroundColor = '#fd7e14';
            borderColor = '#e55a00';
            break;
          default:
            backgroundColor = '#007bff';
            borderColor = '#0056b3';
        }
        
        info.el.style.backgroundColor = backgroundColor;
        info.el.style.borderColor = borderColor;
      },
      
      dateClick: function(info) {
        console.log('ğŸ“… Date clicked:', info.dateStr);
        openReservationModal(null, info.dateStr);
      },
      
      eventClick: function(info) {
        console.log('ğŸ“… Event clicked:', info.event.title);
        openReservationModal(info.event);
      },
      
      eventDrop: function(info) {
        updateReservationTime(info.event, info.revert);
      },
      
      eventResize: function(info) {
        updateReservationTime(info.event, info.revert);
      }
    });
    
    pageCalendar.render();
    window.pageCalendar = pageCalendar;
    console.log('âœ… Calendar initialized successfully');
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
  function loadUsers() {
    fetch('/admin/users.json')
      .then(response => response.json())
      .then(users => {
        currentUsers = users;
        updateUserSelect();
      })
      .catch(error => {
        console.error('ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      });
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
  function updateUserSelect() {
    const userSelect = document.getElementById('reservationUserId');
    if (!userSelect) return;
    
    // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æ®‹ã™ï¼‰
    const defaultOption = userSelect.querySelector('option[value=""]');
    userSelect.innerHTML = '';
    if (defaultOption) {
      userSelect.appendChild(defaultOption);
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    currentUsers.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = user.name || `ID: ${user.id}`;
      userSelect.appendChild(option);
    });
  }
  
  // äºˆç´„æ™‚é–“ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateReservationTime(event, revertFunc) {
    const reservationId = event.id;
    const newStartTime = event.start.toISOString();
    const newEndTime = event.end ? event.end.toISOString() : null;
    
    if (!confirm(`äºˆç´„ã€Œ${event.title}ã€ã®æ™‚é–“ã‚’å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
      revertFunc();
      return;
    }
    
    fetch(`/admin/reservations/${reservationId}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || '',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        reservation: {
          start_time: newStartTime,
          end_time: newEndTime
        }
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success !== false) {
        showMessage(`äºˆç´„ã€Œ${event.title}ã€ã®æ™‚é–“ã‚’å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
      } else {
        revertFunc();
        showMessage(data.errors ? data.errors.join(', ') : 'æ™‚é–“ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      }
    })
    .catch(error => {
      console.error('Update failed:', error);
      revertFunc();
      showMessage(`æ™‚é–“ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'danger');
    });
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãé–¢æ•°
  function openReservationModal(event = null, dateStr = null) {
    console.log('ğŸ”§ Opening modal:', { event, dateStr });
    
    const modal = document.getElementById('reservationModal');
    if (!modal) {
      console.error('Modal not found');
      return;
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    resetForm();
    
    if (event) {
      // æ—¢å­˜äºˆç´„ã®ç·¨é›†
      console.log('âœï¸ Editing existing reservation');
      populateFormWithEvent(event);
    } else if (dateStr) {
      // æ–°è¦äºˆç´„
      console.log('â• Creating new reservation');
      populateFormWithDate(dateStr);
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    try {
      new bootstrap.Modal(modal).show();
    } catch (error) {
      console.error('Error showing modal:', error);
    }
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
  function resetForm() {
    console.log('ğŸ”„ Resetting form');
    
    const form = document.getElementById('reservationForm');
    if (form) form.reset();
    
    document.getElementById('reservationId').value = '';
    
    const deleteBtn = document.getElementById('deleteReservationBtn');
    const cancelBtn = document.getElementById('cancelReservationBtn');
    
    if (deleteBtn) {
      deleteBtn.classList.add('d-none');
      deleteBtn.removeAttribute('data-reservation-id');
      deleteBtn.disabled = false;
      deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>å‰Šé™¤';
    }
    
    if (cancelBtn) {
      cancelBtn.classList.add('d-none');
      cancelBtn.removeAttribute('data-reservation-id');
      cancelBtn.disabled = false;
      cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    }
    
    document.getElementById('cancellationReasonArea').style.display = 'none';
    document.getElementById('newUserSection').style.display = 'none';
    document.getElementById('existingUserSection').style.display = 'block';
    document.getElementById('newUserToggle').checked = false;
  }
  
  // æ—¢å­˜ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ•ã‚©ãƒ¼ãƒ ã‚’åŸ‹ã‚ã‚‹
  function populateFormWithEvent(event) {
    console.log('ğŸ“ Populating form with event:', event);
    
    document.getElementById('reservationId').value = event.id || '';
    document.getElementById('reservationUserId').value = event.extendedProps?.user_id || '';
    
    // æ—¥ä»˜ã¨æ™‚é–“ã‚’è¨­å®š
    if (event.start) {
      const startDate = new Date(event.start);
      document.getElementById('reservationDate').value = startDate.toISOString().split('T')[0];
      
      // æ™‚é–“ã‚’10åˆ†åˆ»ã¿ã«ä¸¸ã‚ã¦ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¨­å®š
      const hours = startDate.getHours();
      const minutes = Math.round(startDate.getMinutes() / 10) * 10;
      
      // å–¶æ¥­æ™‚é–“å†…ã®æ™‚é–“ã«èª¿æ•´
      let timeValue;
      if (hours >= 10 && hours < 19) {
        timeValue = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
      } else if (hours === 19 && minutes <= 50) {
        timeValue = `19:${minutes.toString().padStart(2, '0')}`;
      } else {
        // å–¶æ¥­æ™‚é–“å¤–ã®å ´åˆã¯æœ€ã‚‚è¿‘ã„å–¶æ¥­æ™‚é–“å†…ã®æ™‚é–“ã«è¨­å®š
        if (hours < 10) {
          timeValue = '10:00';
        } else {
          timeValue = '19:50';
        }
      }
      
      document.getElementById('reservationTime').value = timeValue;
    }
    
    document.getElementById('reservationCourse').value = event.extendedProps?.description || event.extendedProps?.course || '60åˆ†';
    document.getElementById('reservationStatus').value = event.extendedProps?.status || 'confirmed';
    document.getElementById('reservationNote').value = event.extendedProps?.note || '';
    
    // çµ‚äº†æ™‚é–“è¡¨ç¤ºã‚’æ›´æ–°
    updateEndTimeDisplay();
    
    // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
    const deleteBtn = document.getElementById('deleteReservationBtn');
    const cancelBtn = document.getElementById('cancelReservationBtn');
    
    if (deleteBtn) {
      deleteBtn.classList.remove('d-none');
      deleteBtn.setAttribute('data-reservation-id', event.id);
    }
    
    if (cancelBtn && event.extendedProps?.status !== 'cancelled') {
      cancelBtn.classList.remove('d-none');
      cancelBtn.setAttribute('data-reservation-id', event.id);
    }
    
    console.log('âœ… Form populated successfully, reservation ID:', event.id);
  }
  
  // çµ‚äº†æ™‚é–“è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
  function updateEndTimeDisplay() {
    const courseSelect = document.getElementById('reservationCourse');
    const dateInput = document.getElementById('reservationDate');
    const timeInput = document.getElementById('reservationTime');
    
    const course = courseSelect?.value;
    const date = dateInput?.value;
    const time = timeInput?.value;
    
    if (course && date && time) {
      const duration = getDurationFromCourse(course);
      const adjustedTime = adjustTimeToTenMinutes(time);
      
      // æ—¥æœ¬æ™‚é–“ã§è¨ˆç®—
      const startDateTime = new Date(`${date}T${adjustedTime}:00+09:00`);
      const endDateTime = new Date(startDateTime.getTime() + (duration * 60000));
      
      const endTimeDisplay = document.getElementById('endTimeDisplay');
      if (endTimeDisplay) {
        // æ—¥æœ¬æ™‚é–“ã§ã®è¡¨ç¤º
        const endHours = endDateTime.getHours();
        const endMinutes = endDateTime.getMinutes();
        endTimeDisplay.textContent = `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')} çµ‚äº†äºˆå®š`;
      }
      
      console.log('ğŸ• End time display update:', {
        course,
        duration,
        adjustedTime,
        startDateTime: startDateTime.toString(),
        endDateTime: endDateTime.toString()
      });
    }
  }
  
  // æ–°è¦äºˆç´„ã§æ—¥ä»˜ã‚’è¨­å®š
  function populateFormWithDate(dateStr) {
    try {
      const date = new Date(dateStr);
      document.getElementById('reservationDate').value = date.toISOString().split('T')[0];
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ™‚é–“ã¨ã—ã¦ã€ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚é–“ã‚’10åˆ†åˆ»ã¿ã«ä¸¸ã‚ã‚‹
      const hours = date.getHours();
      const minutes = Math.round(date.getMinutes() / 10) * 10;
      
      // å–¶æ¥­æ™‚é–“å†…ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ10:00-19:50ï¼‰
      let timeValue;
      if (hours >= 10 && hours < 19) {
        timeValue = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
      } else if (hours === 19 && minutes <= 50) {
        timeValue = `19:${minutes.toString().padStart(2, '0')}`;
      } else {
        // å–¶æ¥­æ™‚é–“å¤–ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§10:00ã‚’è¨­å®š
        timeValue = '10:00';
      }
      
      document.getElementById('reservationTime').value = timeValue;
      
      // çµ‚äº†æ™‚é–“è¡¨ç¤ºã‚’æ›´æ–°
      updateEndTimeDisplay();
    } catch (error) {
      console.error('æ—¥ä»˜è§£æã‚¨ãƒ©ãƒ¼:', error);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚é–“ã‚’è¨­å®š
      document.getElementById('reservationTime').value = '10:00';
      updateEndTimeDisplay();
    }
  }
  
  // äºˆç´„ã‚’ä¿å­˜
  function saveReservation() {
    console.log('ğŸ’¾ Saving reservation...');
    
    const reservationId = document.getElementById('reservationId').value;
    const isNewUser = document.getElementById('newUserToggle').checked;
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!validateReservationForm()) {
      return;
    }
    
    let data;
    
    if (isNewUser) {
      // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨äºˆç´„ã‚’ä½œæˆ
      const newUserData = getNewUserData();
      const reservationData = getReservationData();
      
      console.log('ğŸ“ New user data:', newUserData);
      console.log('ğŸ“ Reservation data:', reservationData);
      
      data = {
        new_user: newUserData,
        reservation: reservationData
      };
    } else {
      // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§äºˆç´„ã‚’ä½œæˆ/æ›´æ–°
      data = {
        reservation: getReservationData()
      };
      
      console.log('ğŸ“ Reservation data:', data.reservation);
    }
    
    const url = reservationId ? `/admin/reservations/${reservationId}` : '/admin/reservations';
    const method = reservationId ? 'PATCH' : 'POST';
    
    console.log(`ğŸ”„ ${method} request to ${url}`);
    console.log('ğŸ“¤ Request data:', data);
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const saveBtn = document.getElementById('saveReservationBtn');
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';
    }
    
    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || '',
        'Accept': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      console.log('ğŸ”„ Response status:', response.status);
      return response.json().then(data => ({ status: response.status, data }));
    })
    .then(({ status, data }) => {
      console.log('ğŸ“¥ Response data:', data);
      
      if (status === 200 || status === 201 || data.success !== false) {
        showMessage(reservationId ? 'äºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'äºˆç´„ã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
        closeModal();
        refreshCalendar();
      } else {
        console.error('âŒ Validation errors:', data.errors);
        let errorMessage = 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
        if (data.errors && Array.isArray(data.errors)) {
          errorMessage += ':\n' + data.errors.join('\n');
        } else if (data.error) {
          errorMessage += ': ' + data.error;
        }
        showMessage(errorMessage, 'danger');
      }
    })
    .catch(error => {
      console.error('âŒ Save failed:', error);
      showMessage('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'danger');
    })
    .finally(() => {
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>ä¿å­˜';
      }
    });
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  function validateReservationForm() {
    const isNewUser = document.getElementById('newUserToggle').checked;
    const errors = [];
    
    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
    if (isNewUser) {
      const newUserName = document.getElementById('newUserName').value.trim();
      if (!newUserName) {
        errors.push('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      }
    } else {
      // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ´åˆ
      const userId = document.getElementById('reservationUserId').value;
      if (!userId) {
        errors.push('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
      }
    }
    
    // äºˆç´„è©³ç´°
    const date = document.getElementById('reservationDate').value;
    const time = document.getElementById('reservationTime').value;
    const course = document.getElementById('reservationCourse').value;
    
    if (!date) {
      errors.push('äºˆç´„æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
    }
    
    if (!time) {
      errors.push('é–‹å§‹æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
    }
    
    if (!course) {
      errors.push('ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
    }
    
    // æ™‚é–“ãŒå–¶æ¥­æ™‚é–“å†…ã‹ãƒã‚§ãƒƒã‚¯
    if (time) {
      const [hours, minutes] = time.split(':').map(Number);
      if (hours < 10 || (hours === 20 && minutes > 0) || hours > 20) {
        errors.push('å–¶æ¥­æ™‚é–“å†…ï¼ˆ10:00-20:00ï¼‰ã®æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
      }
    }
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±
    const status = document.getElementById('reservationStatus').value;
    if (status === 'cancelled') {
      const reason = document.getElementById('cancellationReason').value.trim();
      if (!reason) {
        errors.push('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      }
    }
    
    if (errors.length > 0) {
      showMessage('å…¥åŠ›ã‚¨ãƒ©ãƒ¼:\n' + errors.join('\n'), 'danger');
      return false;
    }
    
    return true;
  }
  
  // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  function getNewUserData() {
    return {
      name: document.getElementById('newUserName').value,
      phone_number: document.getElementById('newUserPhone').value,
      email: document.getElementById('newUserEmail').value,
      birth_date: document.getElementById('newUserBirthDate').value || null,
      address: document.getElementById('newUserAddress').value,
      admin_memo: document.getElementById('newUserMemo').value
    };
  }
  
  // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  function getReservationData() {
    const date = document.getElementById('reservationDate').value;
    const time = document.getElementById('reservationTime').value;
    const course = document.getElementById('reservationCourse').value;
    
    // æ—¢ã«10åˆ†åˆ»ã¿ã®æ™‚é–“ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã®ã§èª¿æ•´ä¸è¦
    const startDateTime = new Date(`${date}T${time}:00+09:00`);
    
    // çµ‚äº†æ™‚é–“ã‚’è¨ˆç®—
    const duration = getDurationFromCourse(course);
    const endDateTime = new Date(startDateTime.getTime() + (duration * 60000));
    
    // ISOæ–‡å­—åˆ—ã¨ã—ã¦é€ä¿¡ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†ï¼‰
    const startTime = startDateTime.toISOString();
    const endTime = endDateTime.toISOString();
    
    console.log('ğŸ• Start time calculation:', {
      date,
      time,
      course,
      duration,
      startDateTime: startDateTime.toString(),
      endDateTime: endDateTime.toString(),
      startTime,
      endTime
    });
    
    const data = {
      user_id: document.getElementById('reservationUserId').value || null,
      start_time: startTime,
      end_time: endTime,
      course: course,
      status: document.getElementById('reservationStatus').value,
      note: document.getElementById('reservationNote').value
    };
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ãŒå¿…è¦ãªå ´åˆ
    if (data.status === 'cancelled') {
      data.cancellation_reason = document.getElementById('cancellationReason').value;
    }
    
    console.log('ğŸ“ Final reservation data:', data);
    
    return data;
  }
  
  // 10åˆ†åˆ»ã¿ã®æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
  function generateTimeOptions() {
    const timeSelect = document.getElementById('reservationTime');
    if (!timeSelect) return;
    
    // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»¥å¤–ï¼‰
    const defaultOption = timeSelect.querySelector('option[value=""]');
    timeSelect.innerHTML = '';
    if (defaultOption) {
      timeSelect.appendChild(defaultOption);
    }
    
    // 10:00ã‹ã‚‰19:50ã¾ã§10åˆ†åˆ»ã¿ã§ç”Ÿæˆï¼ˆ20:00é–‹å§‹ã¯60åˆ†ã‚³ãƒ¼ã‚¹ã ã¨21:00çµ‚äº†ã«ãªã‚‹ãŸã‚é™¤å¤–ï¼‰
    for (let hour = 10; hour < 20; hour++) {
      for (let minute = 0; minute < 60; minute += 10) {
        // 19:50ä»¥é™ã¯é™¤å¤–ï¼ˆæœ€é•·80åˆ†ã‚³ãƒ¼ã‚¹ã‚’è€ƒæ…®ï¼‰
        if (hour === 19 && minute > 50) break;
        
        const timeValue = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        const option = document.createElement('option');
        option.value = timeValue;
        option.textContent = timeValue;
        timeSelect.appendChild(option);
      }
    }
    
    console.log('â° Generated time options for 10-minute intervals (10:00-19:50)');
  }
  
  // äºˆç´„ã‚’å‰Šé™¤
  function deleteReservation() {
    console.log('ğŸ—‘ï¸ Delete reservation called');
    
    // è¤‡æ•°ã®æ–¹æ³•ã§IDã‚’å–å¾—
    let reservationId = document.getElementById('reservationId').value;
    
    if (!reservationId) {
      const deleteBtn = document.getElementById('deleteReservationBtn');
      reservationId = deleteBtn?.getAttribute('data-reservation-id');
    }
    
    console.log('ğŸ” Reservation ID:', reservationId);
    
    if (!reservationId) {
      console.error('âŒ No reservation ID found');
      showMessage('äºˆç´„IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'danger');
      return;
    }
    
    if (!confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    
    console.log(`ğŸ—‘ï¸ Deleting reservation ${reservationId}`);
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const deleteBtn = document.getElementById('deleteReservationBtn');
    if (deleteBtn) {
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>å‰Šé™¤ä¸­...';
    }
    
    fetch(`/admin/reservations/${reservationId}`, {
      method: 'DELETE',
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || '',
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    })
    .then(response => {
      console.log('ğŸ”„ Delete response status:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('âœ… Delete response:', data);
      if (data.success !== false) {
        showMessage('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        closeModal();
        refreshCalendar();
      } else {
        showMessage(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      }
    })
    .catch(error => {
      console.error('âŒ Delete failed:', error);
      showMessage(`å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'danger');
    })
    .finally(() => {
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      if (deleteBtn) {
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>å‰Šé™¤';
      }
    });
  }
  
  // äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  function cancelReservation() {
    console.log('âŒ Cancel reservation called');
    
    // è¤‡æ•°ã®æ–¹æ³•ã§IDã‚’å–å¾—
    let reservationId = document.getElementById('reservationId').value;
    
    if (!reservationId) {
      const cancelBtn = document.getElementById('cancelReservationBtn');
      reservationId = cancelBtn?.getAttribute('data-reservation-id');
    }
    
    console.log('ğŸ” Reservation ID for cancel:', reservationId);
    
    if (!reservationId) {
      console.error('âŒ No reservation ID found for cancel');
      showMessage('äºˆç´„IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'danger');
      return;
    }
    
    const reason = prompt('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
    if (!reason || reason.trim() === '') {
      return;
    }
    
    console.log(`âŒ Cancelling reservation ${reservationId} with reason: ${reason}`);
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const cancelBtn = document.getElementById('cancelReservationBtn');
    if (cancelBtn) {
      cancelBtn.disabled = true;
      cancelBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­...';
    }
    
    fetch(`/admin/reservations/${reservationId}/cancel`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || '',
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        cancellation_reason: reason.trim()
      })
    })
    .then(response => {
      console.log('ğŸ”„ Cancel response status:', response.status);
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return response.json();
    })
    .then(data => {
      console.log('âœ… Cancel response:', data);
      if (data.success) {
        showMessage(data.message || 'äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'success');
        closeModal();
        refreshCalendar();
      } else {
        showMessage(data.error || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      }
    })
    .catch(error => {
      console.error('âŒ Cancel failed:', error);
      showMessage(`ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'danger');
    })
    .finally(() => {
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      if (cancelBtn) {
        cancelBtn.disabled = false;
        cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
      }
    });
  }
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
  function refreshCalendar() {
    if (pageCalendar) {
      pageCalendar.refetchEvents();
    }
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeModal() {
    const modal = bootstrap.Modal.getInstance(document.getElementById('reservationModal'));
    if (modal) modal.hide();
  }
  
  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
  function showMessage(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const flashContainer = document.getElementById('flash');
    flashContainer.innerHTML = '';
    flashContainer.appendChild(alertDiv);
    
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.parentNode.removeChild(alertDiv);
      }
    }, 5000);
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
  function setupEventListeners() {
    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆã‚°ãƒ«
    const newUserToggle = document.getElementById('newUserToggle');
    if (newUserToggle) {
      newUserToggle.addEventListener('change', function() {
        const newUserSection = document.getElementById('newUserSection');
        const existingUserSection = document.getElementById('existingUserSection');
        
        if (this.checked) {
          newUserSection.style.display = 'block';
          existingUserSection.style.display = 'none';
        } else {
          newUserSection.style.display = 'none';
          existingUserSection.style.display = 'block';
        }
      });
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±è¡¨ç¤º
    const statusSelect = document.getElementById('reservationStatus');
    if (statusSelect) {
      statusSelect.addEventListener('change', function() {
        const cancellationArea = document.getElementById('cancellationReasonArea');
        if (this.value === 'cancelled') {
          cancellationArea.style.display = 'block';
        } else {
          cancellationArea.style.display = 'none';
        }
      });
    }
    
    // ã‚³ãƒ¼ã‚¹ã€æ—¥ä»˜ã€æ™‚é–“å¤‰æ›´æ™‚ã®çµ‚äº†æ™‚é–“è‡ªå‹•æ›´æ–°
    const courseSelect = document.getElementById('reservationCourse');
    const dateInput = document.getElementById('reservationDate');
    const timeInput = document.getElementById('reservationTime');
    
    if (courseSelect) {
      courseSelect.addEventListener('change', updateEndTimeDisplay);
    }
    
    if (dateInput) {
      dateInput.addEventListener('change', updateEndTimeDisplay);
    }
    
    if (timeInput) {
      timeInput.addEventListener('change', updateEndTimeDisplay);
    }
    
    // ä¿å­˜ãƒœã‚¿ãƒ³
    const saveBtn = document.getElementById('saveReservationBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', saveReservation);
    }
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³
    const deleteBtn = document.getElementById('deleteReservationBtn');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', deleteReservation);
    }
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
    const cancelBtn = document.getElementById('cancelReservationBtn');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', cancelReservation);
    }
  }
  
  // åˆæœŸåŒ–
  function initialize() {
    console.log('ğŸš€ Initializing calendar application');
    
    // é–¢æ•°ã®å­˜åœ¨ç¢ºèª
    console.log('ğŸ“‹ Function checks:', {
      generateTimeOptions: typeof generateTimeOptions,
      updateEndTimeDisplay: typeof updateEndTimeDisplay,
      getDurationFromCourse: typeof getDurationFromCourse,
      adjustTimeToTenMinutes: typeof adjustTimeToTenMinutes,
      openReservationModal: typeof openReservationModal
    });
    
    initializeCalendar();
    loadUsers();
    generateTimeOptions(); // æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
    setupEventListeners();
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
  window.openReservationModal = openReservationModal;
  window.refreshCalendar = refreshCalendar;
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initialize);
  } else {
    initialize();
  }
  
  document.addEventListener('turbo:load', initialize);
  
  document.addEventListener('turbo:before-cache', function() {
    if (pageCalendar) {
      pageCalendar.destroy();
      pageCalendar = null;
    }
  });
  
})();
</script>