<% content_for :title, "äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ - Mobilis" %>

<div class="calendar-container">
  <div class="calendar-header">
    <div class="container-fluid">
      <div class="calendar-toolbar">
        <div class="calendar-nav">
          <button id="prevBtn" class="btn btn-outline-primary">
            <i class="fas fa-chevron-left"></i> å‰é€±
          </button>
          <button id="todayBtn" class="btn btn-primary">
            <i class="fas fa-calendar-day"></i> ä»Šæ—¥
          </button>
          <button id="nextBtn" class="btn btn-outline-primary">
            æ¬¡é€± <i class="fas fa-chevron-right"></i>
          </button>
        </div>
        
        <div class="calendar-title">
          <i class="fas fa-calendar-alt me-2"></i>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
        </div>
        
        <div class="calendar-actions">
          <button id="newReservationBtn" class="btn btn-success">
            <i class="fas fa-plus me-1"></i>æ–°è¦äºˆç´„
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="container-fluid">
    <div id="calendar"></div>
  </div>
</div>

<!-- äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reservationModalLabel">
          <i class="fas fa-calendar-plus me-2"></i>äºˆç´„ä½œæˆãƒ»ç·¨é›†
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="reservationForm">
          <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
          <input type="hidden" id="currentReservationId" value="">
          
          <!-- é¡§å®¢æƒ…å ± -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="customerName" class="form-label">é¡§å®¢å *</label>
              <input type="text" class="form-control" id="customerName" required>
            </div>
            <div class="col-md-6">
              <label for="customerPhone" class="form-label">é›»è©±ç•ªå·</label>
              <input type="tel" class="form-control" id="customerPhone">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="customerKana" class="form-label">ãƒ•ãƒªã‚¬ãƒŠ</label>
              <input type="text" class="form-control" id="customerKana">
            </div>
            <div class="col-md-6">
              <label for="customerBirthDate" class="form-label">ç”Ÿå¹´æœˆæ—¥</label>
              <input type="date" class="form-control" id="customerBirthDate">
            </div>
          </div>
          
          <!-- äºˆç´„æƒ…å ± -->
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationDate" class="form-label">æ—¥ä»˜ *</label>
              <input type="date" class="form-control" id="reservationDate" required>
            </div>
            <div class="col-md-6">
              <label for="reservationTime" class="form-label">æ™‚é–“ *</label>
              <input type="time" class="form-control" id="reservationTime" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="reservationCourse" class="form-label">ã‚³ãƒ¼ã‚¹ *</label>
              <select class="form-select" id="reservationCourse" required>
                <option value="">ã‚³ãƒ¼ã‚¹ã‚’é¸æŠ</option>
                <option value="40åˆ†ã‚³ãƒ¼ã‚¹" data-price="8000">40åˆ†ã‚³ãƒ¼ã‚¹ (Â¥8,000)</option>
                <option value="60åˆ†ã‚³ãƒ¼ã‚¹" data-price="12000">60åˆ†ã‚³ãƒ¼ã‚¹ (Â¥12,000)</option>
                <option value="80åˆ†ã‚³ãƒ¼ã‚¹" data-price="16000">80åˆ†ã‚³ãƒ¼ã‚¹ (Â¥16,000)</option>
              </select>
            </div>
            <div class="col-md-6">
              <label for="reservationDuration" class="form-label">æ‰€è¦æ™‚é–“</label>
              <select class="form-select" id="reservationDuration">
                <option value="40">40åˆ†</option>
                <option value="60" selected>60åˆ†</option>
                <option value="80">80åˆ†</option>
              </select>
            </div>
          </div>
          
          <!-- ãƒã‚±ãƒƒãƒˆæƒ…å ± -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">ãƒã‚±ãƒƒãƒˆæƒ…å ±</label>
              <div id="ticketInfo" class="border rounded p-3 bg-light">
                <div class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  é¡§å®¢ã‚’é¸æŠã™ã‚‹ã¨ãƒã‚±ãƒƒãƒˆæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
              </div>
            </div>
          </div>
          
          <!-- ãƒ¡ãƒ¢ -->
          <div class="row mb-3">
            <div class="col-12">
              <label for="reservationMemo" class="form-label">ãƒ¡ãƒ¢ãƒ»æ³¨æ„äº‹é …</label>
              <textarea class="form-control" id="reservationMemo" rows="3" placeholder="äºˆç´„ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚„æ³¨æ„äº‹é …ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="button" class="btn btn-danger" id="deleteReservationBtn" style="display: none;">
          <i class="fas fa-trash me-1"></i>å‰Šé™¤
        </button>
        <button type="button" class="btn btn-primary" id="saveReservationBtn">
          <i class="fas fa-save me-1"></i>ä¿å­˜
        </button>
      </div>
    </div>
  </div>
</div>

<!-- é¡§å®¢å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="customerHistoryModal" tabindex="-1" aria-labelledby="customerHistoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerHistoryModalLabel">
          <i class="fas fa-history me-2"></i>é¡§å®¢å±¥æ­´
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="customerHistoryContent">
          <!-- é¡§å®¢å±¥æ­´ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
  .calendar-container {
    height: calc(100vh - 100px);
    background: #f8f9fa;
  }
  
  .calendar-header {
    background: white;
    border-bottom: 1px solid #dee2e6;
    padding: 15px 0;
  }
  
  .calendar-toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .calendar-nav {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .calendar-nav button {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
  }
  
  .calendar-nav button:hover {
    background: #0056b3;
  }
  
  .calendar-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
  }
  
  .calendar-actions {
    display: flex;
    gap: 10px;
  }
  
  .btn-new-reservation {
    background: #28a745;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
  }
  
  .btn-new-reservation:hover {
    background: #218838;
  }
  
  /* FullCalendar ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
  .fc {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  }
  
  .fc-toolbar {
    padding: 15px;
    border-bottom: 1px solid #dee2e6;
  }
  
  .fc-toolbar-title {
    font-size: 1.3rem;
    font-weight: bold;
    color: #333;
  }
  
  .fc-button {
    background: #007bff !important;
    border-color: #007bff !important;
    color: white !important;
  }
  
  .fc-button:hover {
    background: #0056b3 !important;
    border-color: #0056b3 !important;
  }
  
  .fc-button:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
  }
  
  .fc-timegrid-event {
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 500;
  }
  
  .fc-timegrid-event.confirmed {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
  }
  
  .fc-timegrid-event.pending {
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
    color: #212529 !important;
  }
  
  .fc-timegrid-event.cancelled {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
  }
  
  .fc-timegrid-event.break {
    background-color: #6c757d !important;
    border-color: #6c757d !important;
  }
  
  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
  @media (max-width: 768px) {
    .calendar-toolbar {
      flex-direction: column;
      gap: 15px;
    }
    
    .calendar-nav {
      order: 1;
    }
    
    .calendar-title {
      order: 2;
      font-size: 1.2rem;
    }
    
    .calendar-actions {
      order: 3;
    }
  }
</style>

<script>
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–
  document.addEventListener('DOMContentLoaded', function() {
    // FullCalendarã®åˆæœŸåŒ–
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      locale: 'ja',
      timeZone: 'Asia/Tokyo',
      height: 'auto',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      buttonText: {
        today: 'ä»Šæ—¥',
        month: 'æœˆ',
        week: 'é€±',
        day: 'æ—¥'
      },
      slotMinTime: '10:00:00',
      slotMaxTime: '20:00:00',
      slotDuration: '00:30:00',
      allDaySlot: false,
      selectable: true,
      editable: true,
      // ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†ã®è¨­å®š
      eventTimeFormat: {
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      },
      // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§ã®å‡¦ç†ã‚’æ˜ç¤ºçš„ã«è¨­å®š
      now: new Date(),
      // é¸æŠæ™‚ã®æ™‚é–“ã‚’ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§å–å¾—
      selectMirror: true,
      eventDrop: function(info) {
        // ã‚¤ãƒ™ãƒ³ãƒˆãŒãƒ‰ãƒ©ãƒƒã‚°ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        console.log('ğŸ”„ Event dropped:', info.event);
        updateReservationTime(info.event);
      },
      eventResize: function(info) {
        // ã‚¤ãƒ™ãƒ³ãƒˆãŒãƒªã‚µã‚¤ã‚ºã•ã‚ŒãŸæ™‚ã®å‡¦ç†
        console.log('ğŸ“ Event resized:', info.event);
        updateReservationTime(info.event);
      },
      eventClick: function(info) {
        openReservationModal(info.event);
      },
      select: function(info) {
        openNewReservationModal(info.start, info.end);
      },
             events: function(info, successCallback, failureCallback) {
         console.log('ğŸ” Fetching events for:', info.startStr, 'to', info.endStr);
         
         fetch(`/admin/reservations?start=${info.startStr}&end=${info.endStr}`, {
           headers: {
             'Accept': 'application/json',
             'Content-Type': 'application/json'
           }
         })
           .then(response => {
             console.log('ğŸ“¡ Response status:', response.status);
             console.log('ğŸ“¡ Response headers:', response.headers);
             console.log('ğŸ“¡ Response URL:', response.url);
             
             if (!response.ok) {
               return response.text().then(text => {
                 console.error('âŒ HTTP Error Response:', text);
                 throw new Error(`HTTP error! status: ${response.status}, body: ${text.substring(0, 200)}`);
               });
             }
             
             return response.text().then(text => {
               console.log('ğŸ“„ Raw response:', text);
               try {
                 return JSON.parse(text);
               } catch (e) {
                 console.error('âŒ JSON parse error:', e);
                 console.error('âŒ Raw text that failed to parse:', text);
                 throw new Error('Invalid JSON response');
               }
             });
           })
           .then(data => {
             console.log('âœ… Parsed events:', data);
             successCallback(data);
           })
           .catch(error => {
             console.error('âŒ Error fetching events:', error);
             
             // ã‚¨ãƒ©ãƒ¼æ™‚ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
             console.log('ğŸ”„ Showing fallback data due to error');
             const fallbackEvents = [
               {
                 id: 'fallback-1',
                 title: 'ãƒ†ã‚¹ãƒˆäºˆç´„ - 60åˆ†ã‚³ãƒ¼ã‚¹',
                 start: new Date().toISOString(),
                 end: new Date(Date.now() + 60 * 60 * 1000).toISOString(),
                 backgroundColor: '#28a745',
                 borderColor: '#28a745',
                 textColor: 'white',
                 extendedProps: {
                   status: 'confirmed',
                   course: '60åˆ†ã‚³ãƒ¼ã‚¹',
                   memo: 'ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿',
                   customer: {
                     id: null,
                     name: 'ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼',
                     kana: null,
                     phone: '090-1234-5678',
                     email: 'test@example.com',
                     birth_date: null
                   }
                 }
               }
             ];
             successCallback(fallbackEvents);
           });
       }
    });
    
    calendar.render();
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
    document.getElementById('prevBtn').addEventListener('click', () => {
      calendar.prev();
    });
    
    document.getElementById('nextBtn').addEventListener('click', () => {
      calendar.next();
    });
    
    document.getElementById('todayBtn').addEventListener('click', () => {
      calendar.today();
    });
    
    // æ–°è¦äºˆç´„ãƒœã‚¿ãƒ³
    document.getElementById('newReservationBtn').addEventListener('click', () => {
      openNewReservationModal();
    });
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£
    const reservationModal = new bootstrap.Modal(document.getElementById('reservationModal'));
    const customerHistoryModal = new bootstrap.Modal(document.getElementById('customerHistoryModal'));
    
    function openReservationModal(event) {
      // æ—¢å­˜ã®äºˆç´„ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
      document.getElementById('reservationModalLabel').innerHTML = '<i class="fas fa-edit me-2"></i>äºˆç´„ç·¨é›†';
      document.getElementById('deleteReservationBtn').style.display = 'block';
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
      if (event) {
        // äºˆç´„IDã‚’è¨­å®š
        document.getElementById('currentReservationId').value = event.id;
        
        document.getElementById('customerName').value = event.title.split(' - ')[0] || '';
        
        // FullCalendarã®ã‚¤ãƒ™ãƒ³ãƒˆæ™‚é–“ã¯æ—¢ã«ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“
        const localStart = new Date(event.start);
        
        console.log('ğŸ• Edit reservation time:', {
          original: event.start,
          localStart: localStart,
          isoString: localStart.toISOString(),
          localTimeString: localStart.toLocaleTimeString('ja-JP', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
          })
        });
        
        document.getElementById('reservationDate').value = localStart.toISOString().split('T')[0];
        document.getElementById('reservationTime').value = localStart.toLocaleTimeString('ja-JP', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false 
        });
        document.getElementById('reservationCourse').value = event.title.split(' - ')[1] || '';
        document.getElementById('reservationMemo').value = event.extendedProps?.note || '';
        
        // é¡§å®¢æƒ…å ±ã‚’è¨­å®š
        if (event.extendedProps?.customer) {
          const customer = event.extendedProps.customer;
          document.getElementById('customerPhone').value = customer.phone || '';
          document.getElementById('customerKana').value = customer.kana || '';
          document.getElementById('customerBirthDate').value = customer.birth_date || '';
          
          // ãƒã‚±ãƒƒãƒˆæƒ…å ±ã‚’å–å¾—
          loadCustomerTickets(customer.id);
        }
      }
      
      reservationModal.show();
    }
    
    function openNewReservationModal(start, end) {
      // æ–°è¦äºˆç´„ãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
      document.getElementById('reservationModalLabel').innerHTML = '<i class="fas fa-calendar-plus me-2"></i>æ–°è¦äºˆç´„';
      document.getElementById('deleteReservationBtn').style.display = 'none';
      
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('reservationForm').reset();
      
      // äºˆç´„IDã‚’ã‚¯ãƒªã‚¢
      document.getElementById('currentReservationId').value = '';
      
      // æ—¥æ™‚ã‚’è¨­å®š
      if (start) {
        // FullCalendarã®æ™‚é–“ã¯æ—¢ã«ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ãªã®ã§ã€ãã®ã¾ã¾ä½¿ç”¨
        const localDate = new Date(start);
        
        console.log('ğŸ• New reservation time:', {
          original: start,
          localDate: localDate,
          isoString: localDate.toISOString(),
          localTimeString: localDate.toLocaleTimeString('ja-JP', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: false 
          })
        });
        
        document.getElementById('reservationDate').value = localDate.toISOString().split('T')[0];
        document.getElementById('reservationTime').value = localDate.toLocaleTimeString('ja-JP', { 
          hour: '2-digit', 
          minute: '2-digit',
          hour12: false 
        });
      }
      
      reservationModal.show();
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã®æ™‚é–“æ›´æ–°æ©Ÿèƒ½
    function updateReservationTime(event) {
      const reservationId = event.id;
      const newStart = event.start;
      const newEnd = event.end;
      
      console.log('ğŸ”„ Updating reservation time:', {
        id: reservationId,
        start: newStart,
        end: newEnd
      });
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      
      // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã‚’ISOæ–‡å­—åˆ—ã«å¤‰æ›ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³æƒ…å ±ä»˜ãï¼‰
      const startISO = newStart.toISOString();
      const endISO = newEnd.toISOString();
      
      console.log('ğŸ• Time conversion:', {
        originalStart: newStart,
        originalEnd: newEnd,
        startISO: startISO,
        endISO: endISO
      });
      
      // æ™‚é–“æ›´æ–°APIã‚’å‘¼ã³å‡ºã—
      fetch(`/admin/reservations/${reservationId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify({
          reservation: {
            start_time: startISO,
            end_time: endISO
          }
        })
      })
      .then(response => {
        console.log('ğŸ“¡ Update response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ… Time update response:', data);
        
        if (data.success) {
          showMessage('äºˆç´„æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
          
          // æˆåŠŸæ™‚ã‚‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
          setTimeout(() => {
            calendar.refetchEvents();
          }, 500);
        } else {
          throw new Error(data.error || 'æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Time update error:', error);
        showMessage('æ™‚é–“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'danger');
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿
        calendar.refetchEvents();
      });
    }
    
    function loadCustomerTickets(customerId) {
      if (!customerId) return;
      
      fetch(`/admin/users/${customerId}/tickets`)
        .then(response => response.json())
        .then(tickets => {
          const ticketInfo = document.getElementById('ticketInfo');
          if (tickets.length > 0) {
            let html = '<div class="row">';
            tickets.forEach(ticket => {
              const statusClass = ticket.status === 'expired' ? 'text-danger' : 
                                ticket.status === 'low' ? 'text-warning' : 'text-success';
              html += `
                <div class="col-md-6 mb-2">
                  <div class="card">
                    <div class="card-body p-2">
                      <h6 class="card-title mb-1">${ticket.name}</h6>
                                             <p class="card-text mb-1">
                         <small class="text-muted">
                           æ®‹ã‚Š: ${ticket.remaining}/${ticket.total}å›
                         </small>
                       </p>
                       <p class="card-text mb-1">
                         <small class="text-muted">
                           æœŸé™: ${ticket.expires_at || 'ãªã—'}
                         </small>
                       </p>
                       <p class="card-text mb-0">
                         <small class="${statusClass}">
                           ${ticket.status === 'expired' ? 'æœŸé™åˆ‡ã‚Œ' : 
                             ticket.status === 'low' ? 'æ®‹ã‚Šå°‘ãªã„' : 'åˆ©ç”¨å¯èƒ½'}
                         </small>
                       </p>
                    </div>
                  </div>
                </div>
              `;
            });
            html += '</div>';
            ticketInfo.innerHTML = html;
          } else {
            ticketInfo.innerHTML = '<div class="text-muted">ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</div>';
          }
        })
        .catch(error => {
          console.error('Error loading tickets:', error);
          document.getElementById('ticketInfo').innerHTML = '<div class="text-danger">ãƒã‚±ãƒƒãƒˆæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        });
    }
    
    // ä¿å­˜ãƒœã‚¿ãƒ³
    document.getElementById('saveReservationBtn').addEventListener('click', function() {
      // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const form = document.getElementById('reservationForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const saveBtn = this;
      const originalText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';
      
      // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—
      const reservationId = getCurrentReservationId();
      const isEditMode = reservationId && reservationId !== '';
      
      // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
      const reservationData = {
        reservation: {
          name: document.getElementById('customerName').value,
          date: document.getElementById('reservationDate').value,
          time: document.getElementById('reservationTime').value,
          course: document.getElementById('reservationCourse').value,
          note: document.getElementById('reservationMemo').value
        }
      };
      
      console.log('ğŸ’¾ Saving reservation:', reservationData);
      console.log('ğŸ“ Edit mode:', isEditMode);
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      
      // API URLã¨ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æ±ºå®š
      const url = isEditMode ? `/admin/reservations/${reservationId}` : '/admin/reservations';
      const method = isEditMode ? 'PATCH' : 'POST';
      
      // APIã‚’å‘¼ã³å‡ºã—
      fetch(url, {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        },
        body: JSON.stringify(reservationData)
      })
      .then(response => {
        console.log('ğŸ“¡ Save response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ… Save response:', data);
        
        if (data.success) {
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const message = isEditMode ? 'äºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'äºˆç´„ã‚’ä½œæˆã—ã¾ã—ãŸ';
          showMessage(message, 'success');
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          reservationModal.hide();
          
          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
          calendar.refetchEvents();
        } else {
          throw new Error(data.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Save error:', error);
        alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .finally(() => {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      });
    });
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³
    document.getElementById('deleteReservationBtn').addEventListener('click', function() {
      if (!confirm('ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nå‰Šé™¤ã—ãŸäºˆç´„ã¯å¾©å…ƒã§ãã¾ã›ã‚“ã€‚')) {
        return;
      }
      
      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const deleteBtn = this;
      const originalText = deleteBtn.innerHTML;
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>å‰Šé™¤ä¸­...';
      
      // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ï¼‰
      const reservationId = getCurrentReservationId();
      
      if (!reservationId) {
        alert('å‰Šé™¤ã™ã‚‹äºˆç´„ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
        return;
      }
      
      console.log('ğŸ—‘ï¸ Deleting reservation:', reservationId);
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      
      // å‰Šé™¤APIã‚’å‘¼ã³å‡ºã—
      fetch(`/admin/reservations/${reservationId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        }
      })
      .then(response => {
        console.log('ğŸ“¡ Delete response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ… Delete response:', data);
        
        if (data.success) {
          // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          showMessage('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
          reservationModal.hide();
          
          // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
          calendar.refetchEvents();
        } else {
          throw new Error(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      })
      .catch(error => {
        console.error('âŒ Delete error:', error);
        alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
      })
      .finally(() => {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
      });
    });
    
    // ç¾åœ¨ã®äºˆç´„IDã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function getCurrentReservationId() {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰äºˆç´„IDã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã‚’å®Ÿè£…
      // ä¾‹: ãƒ¢ãƒ¼ãƒ€ãƒ«ã«éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆ
      const hiddenField = document.getElementById('currentReservationId');
      return hiddenField ? hiddenField.value : null;
    }
    
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
    function showMessage(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // ãƒšãƒ¼ã‚¸ã®ä¸Šéƒ¨ã«è¡¨ç¤º
      const container = document.querySelector('.calendar-container');
      container.insertBefore(alertDiv, container.firstChild);
      
      // 3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
      setTimeout(() => {
        alertDiv.remove();
      }, 3000);
    }
  });
</script>