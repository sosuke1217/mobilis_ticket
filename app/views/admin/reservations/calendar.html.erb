<!-- app/views/admin/reservations/calendar.html.erb ã®å®Œå…¨ç‰ˆ -->
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>äºˆç´„ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
    <div class="btn-group">
      <!-- æ–°è¦è¿½åŠ : ä¸€æ‹¬ä½œæˆãƒœã‚¿ãƒ³ -->
      <%= link_to "/admin/reservations/bulk_new", class: "btn btn-success" do %>
        <i class="fas fa-calendar-plus me-2"></i>å®šæœŸäºˆç´„ ä¸€æ‹¬ä½œæˆ
      <% end %>

      <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
        è¡¨ç¤ºã‚ªãƒ—ã‚·ãƒ§ãƒ³
      </button>
      <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="#" id="showAllReservations">å…¨ã¦ã®äºˆç´„</a></li>
        <li><a class="dropdown-item" href="#" id="showConfirmedOnly">ç¢ºå®šäºˆç´„ã®ã¿</a></li>
        <li><a class="dropdown-item" href="#" id="showTentativeOnly">ä»®äºˆç´„ã®ã¿</a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="#" id="showRecurringOnly">ç¹°ã‚Šè¿”ã—äºˆç´„ã®ã¿</a></li>
      </ul>
    </div>
  </div>

  <!-- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ãƒ‘ãƒãƒ«ï¼ˆäºˆç´„å¾Œã®ã¿ç‰ˆï¼‰ -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card border-info">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">
            <i class="fas fa-clock me-2"></i>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šæƒ…å ±
          </h6>
          <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="collapse" data-bs-target="#intervalInfoCollapse">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        <div class="collapse show" id="intervalInfoCollapse">
          <div class="card-body">
            <div class="row">
              <div class="col-md-3">
                <div class="text-center">
                  <h5 class="text-info mb-1"><%= ApplicationSetting.current.reservation_interval_minutes %>åˆ†</h5>
                  <small class="text-muted">æ•´ç†æ™‚é–“ï¼ˆäºˆç´„å¾Œï¼‰</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <h5 class="text-success mb-1"><%= ApplicationSetting.current.slot_interval_minutes %>åˆ†</h5>
                  <small class="text-muted">äºˆç´„æ é–“éš”</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <h5 class="text-primary mb-1"><%= ApplicationSetting.current.business_hours_range %></h5>
                  <small class="text-muted">å–¶æ¥­æ™‚é–“</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <%= link_to admin_settings_path, class: "btn btn-sm btn-outline-secondary" do %>
                    <i class="fas fa-cog me-1"></i>è¨­å®šå¤‰æ›´
                  <% end %>
                </div>
              </div>
            </div>
            
            <hr class="my-3">
            
            <div class="row">
              <div class="col-12">
                <h6 class="text-dark mb-2">è¡¨ç¤ºèª¬æ˜</h6>
                <div class="d-flex flex-wrap gap-3">
                  <div class="d-flex align-items-center">
                    <div class="me-2" style="width: 20px; height: 15px; background-color: #28a745; border: 2px solid #28a745; border-radius: 3px;"></div>
                    <small>ç¢ºå®šäºˆç´„</small>
                  </div>
                  <div class="d-flex align-items-center">
                    <div class="me-2" style="width: 20px; height: 15px; background-color: #ffc107; border: 2px solid #ffc107; border-radius: 3px;"></div>
                    <small>ä»®äºˆç´„</small>
                  </div>
                  <div class="d-flex align-items-center">
                    <div class="me-2" style="width: 20px; height: 15px; background-color: #e9ecef; border: 1px dashed #ced4da; border-radius: 3px;"></div>
                    <small>æ•´ç†æ™‚é–“ï¼ˆäºˆç´„çµ‚äº†å¾Œ <%= ApplicationSetting.current.reservation_interval_minutes %>åˆ†ï¼‰</small>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="row mt-3">
              <div class="col-12">
                <div class="alert alert-info mb-0" role="alert">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ©Ÿèƒ½ï¼š</strong>
                  å„äºˆç´„ã®<strong>çµ‚äº†å¾Œ</strong>ã«<strong><%= ApplicationSetting.current.reservation_interval_minutes %>åˆ†</strong>ã®æ•´ç†æ™‚é–“ãŒè‡ªå‹•ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                  ã“ã®æ™‚é–“å¸¯ã¯æ–°ã—ã„äºˆç´„ã‚’å…¥ã‚Œã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚
                  æ•´ç†æ™‚é–“éƒ¨åˆ†ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€é–¢é€£ã™ã‚‹äºˆç´„ã®è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-3">
    <div class="card-header bg-warning text-dark">
      <h6 class="mb-0">
        <i class="fas fa-clock me-2"></i>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®š
        <span id="interval-status-badge" class="badge bg-primary ms-2">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š</span>
      </h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <label class="form-label">
            <strong>ã“ã®äºˆç´„å°‚ç”¨ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“</strong>
            <i class="fas fa-info-circle text-info ms-1" data-bs-toggle="tooltip" 
              title="å€‹åˆ¥ã«è¨­å®šã—ãªã„å ´åˆã¯ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™"></i>
          </label>
          
          <!-- å€‹åˆ¥è¨­å®šã‚¹ã‚¤ãƒƒãƒ -->
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="individualIntervalToggle">
            <label class="form-check-label" for="individualIntervalToggle">
              ã“ã®äºˆç´„ã®ã¿å€‹åˆ¥ã«è¨­å®šã™ã‚‹
            </label>
          </div>
          
          <!-- å€‹åˆ¥è¨­å®šã‚¨ãƒªã‚¢ -->
          <div id="individualIntervalArea" style="display: none;">
            <!-- ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ -->
            <div class="mb-3">
              <input type="range" 
                    class="form-range" 
                    id="individual-interval-slider" 
                    min="0" 
                    max="120" 
                    step="5" 
                    value="15">
              <div class="d-flex justify-content-between text-muted small">
                <span>0åˆ†</span>
                <span>30åˆ†</span>
                <span>60åˆ†</span>
                <span>90åˆ†</span>
                <span>120åˆ†</span>
              </div>
            </div>
            
            <!-- æ•°å€¤å…¥åŠ› -->
            <div class="input-group mb-3">
              <input type="number" 
                    class="form-control text-center fw-bold" 
                    id="individual-interval-input"
                    min="0" 
                    max="120" 
                    step="5"
                    value="15">
              <span class="input-group-text">åˆ†</span>
            </div>
            
            <!-- ã‚¯ã‚¤ãƒƒã‚¯è¨­å®šãƒœã‚¿ãƒ³ -->
            <div class="mb-3">
              <label class="form-label small text-muted">ã‚¯ã‚¤ãƒƒã‚¯è¨­å®š:</label>
              <div class="d-grid gap-1 d-md-flex">
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="0">
                  0åˆ†
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="10">
                  10åˆ†
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="15">
                  15åˆ†
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="20">
                  20åˆ†
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="30">
                  30åˆ†
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="45">
                  45åˆ†
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary individual-preset-btn flex-fill" data-value="60">
                  60åˆ†
                </button>
              </div>
            </div>
          </div>
          
          <!-- ã‚·ã‚¹ãƒ†ãƒ è¨­å®šè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
          <div id="systemIntervalArea">
            <div class="alert alert-info py-2">
              <small>
                <strong>ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä½¿ç”¨:</strong> 
                <span id="system-interval-display"><%= ApplicationSetting.current.reservation_interval_minutes %>åˆ†</span>
              </small>
            </div>
          </div>
        </div>
        
        <div class="col-md-4">
          <div class="bg-light p-3 rounded">
            <h6 class="text-dark mb-3">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h6>
            <div id="individual-interval-preview">
              <!-- JavaScriptã§å‹•çš„ã«æ›´æ–° -->
            </div>
            
            <hr>
            
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-sm btn-outline-danger" id="resetIndividualInterval">
                <i class="fas fa-undo me-1"></i>ãƒªã‚»ãƒƒãƒˆ
              </button>
              <button type="button" class="btn btn-sm btn-success" id="applyIndividualInterval">
                <i class="fas fa-check me-1"></i>é©ç”¨
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¨ãƒªã‚¢ -->
  <div id="flash"></div>

  <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡¡ä¾‹ -->
  <div class="card mb-3">
    <div class="card-body py-2">
      <div class="row align-items-center">
        <div class="col-auto">
          <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å‡¡ä¾‹ï¼š</strong>
        </div>
        <div class="col">
          <span class="badge bg-success me-2">ç¢ºå®š</span>
          <span class="badge bg-warning text-dark me-2">ä»®äºˆç´„</span>
          <span class="badge bg-danger me-2">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
          <span class="badge bg-secondary me-2">å®Œäº†</span>
          <span class="badge bg-warning me-2">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="table-responsive">
    <div id="calendar" style="width: 100%; max-width: 100%; margin: auto;"></div>
  </div>
</div>

<!-- äºˆç´„è©³ç´°ãƒ»ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reservationModalLabel">äºˆç´„ç®¡ç†</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="é–‰ã˜ã‚‹"></button>
      </div>
      <div class="modal-body">
        <form id="reservationForm">
          <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
          <input type="hidden" id="reservationId">
          
          <!-- åŸºæœ¬æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="card mb-3">
            <div class="card-header">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">äºˆç´„è€…é¸æŠ</h6>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="newUserToggle">
                  <label class="form-check-label" for="newUserToggle">
                    æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆ
                  </label>
                </div>
              </div>
            </div>
            <div class="card-body">
              <!-- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠ -->
              <div id="existingUserSection">
                <label for="reservationUserId" class="form-label">æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</label>
                <select class="form-control" id="reservationUserId">
                  <option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                </select>
              </div>

              <!-- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
              <div id="newUserSection" style="display: none;">
                <div class="row">
                  <div class="col-md-6">
                    <label for="newUserName" class="form-label">æ°å <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="newUserName" placeholder="ä¾‹: å±±ç”°å¤ªéƒ">
                  </div>
                  <div class="col-md-6">
                    <label for="newUserPhone" class="form-label">é›»è©±ç•ªå·</label>
                    <input type="tel" class="form-control" id="newUserPhone" placeholder="ä¾‹: 090-1234-5678">
                  </div>
                </div>
                <div class="row mt-2">
                  <div class="col-md-6">
                    <label for="newUserEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                    <input type="email" class="form-control" id="newUserEmail" placeholder="ä¾‹: example@email.com">
                  </div>
                  <div class="col-md-6">
                    <label for="newUserBirthDate" class="form-label">ç”Ÿå¹´æœˆæ—¥</label>
                    <input type="date" class="form-control" id="newUserBirthDate">
                  </div>
                </div>
                <div class="mt-2">
                  <label for="newUserAddress" class="form-label">ä½æ‰€</label>
                  <input type="text" class="form-control" id="newUserAddress" placeholder="ä¾‹: æ±äº¬éƒ½æ¸‹è°·åŒº...">
                </div>
                <div class="mt-2">
                  <label for="newUserMemo" class="form-label">ç®¡ç†è€…ãƒ¡ãƒ¢</label>
                  <textarea class="form-control" id="newUserMemo" rows="2" placeholder="åˆå›æ¥åº—ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼æƒ…å ±ãªã©"></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- äºˆç´„è©³ç´°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
          <div class="card mb-3">
            <div class="card-header">
              <h6 class="mb-0">äºˆç´„è©³ç´°</h6>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <label for="reservationDate" class="form-label">äºˆç´„æ—¥</label>
                  <input type="date" class="form-control" id="reservationDate" required>
                </div>
                <div class="col-md-6">
                  <label for="reservationTime" class="form-label">é–‹å§‹æ™‚é–“</label>
                  <select class="form-control" id="reservationTime" required>
                    <option value="">æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                  </select>
                </div>
              </div>

              <div class="row mt-2">
                <div class="col-md-6">
                  <label for="reservationCourse" class="form-label">ã‚³ãƒ¼ã‚¹</label>
                  <select class="form-control" id="reservationCourse">
                    <option value="40åˆ†">40åˆ†ã‚³ãƒ¼ã‚¹</option>
                    <option value="60åˆ†" selected>60åˆ†ã‚³ãƒ¼ã‚¹</option>
                    <option value="80åˆ†">80åˆ†ã‚³ãƒ¼ã‚¹</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">çµ‚äº†äºˆå®šæ™‚é–“</label>
                  <div id="endTimeDisplay" class="form-control-plaintext text-muted">æ™‚é–“ã¨ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                </div>
              </div>

              <div class="row mt-2">
                <div class="col-md-6">
                  <label for="reservationStatus" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                  <select class="form-control" id="reservationStatus">
                    <option value="confirmed">ç¢ºå®š</option>
                    <option value="tentative">ä»®äºˆç´„</option>
                    <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                    <option value="completed">å®Œäº†</option>
                    <option value="no_show">ç„¡æ–­ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <!-- ç©ºãã‚¹ãƒšãƒ¼ã‚¹ -->
                </div>
              </div>

              <div class="mt-2">
                <label for="reservationNote" class="form-label">å‚™è€ƒ</label>
                <textarea class="form-control" id="reservationNote" rows="2" placeholder="ç‰¹åˆ¥ãªè¦æœ›ã‚„æ³¨æ„äº‹é …ãªã©"></textarea>
              </div>

              <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±å…¥åŠ›ã‚¨ãƒªã‚¢ -->
              <div id="cancellationReasonArea" style="display: none;" class="mt-3">
                <label for="cancellationReason" class="form-label">ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”± <span class="text-danger">*</span></label>
                <textarea class="form-control" id="cancellationReason" rows="3" placeholder="ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"></textarea>
              </div>
            </div>
          </div>
        </form>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
        <div class="d-flex justify-content-between mt-4">
          <div>
            <button type="button" id="deleteReservationBtn" class="btn btn-danger d-none">
              <i class="fas fa-trash me-1"></i>å‰Šé™¤
            </button>
            <button type="button" id="cancelReservationBtn" class="btn btn-warning d-none">
              <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
          </div>
          <div>
            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            <button type="button" id="saveReservationBtn" class="btn btn-primary">
              <i class="fas fa-save me-1"></i>ä¿å­˜
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ©Ÿèƒ½ã®JavaScriptï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¡¨ç¤ºå¯¾å¿œå®Œå…¨ç‰ˆï¼‰
(function() {
  'use strict';
  
  let pageCalendar = null;
  let currentUsers = [];
  let currentReservationId = null;
  let currentIndividualInterval = null;
  let systemDefaultInterval = <%= ApplicationSetting.current.reservation_interval_minutes %>;

  const systemSettings = {
    businessHoursStart: <%= ApplicationSetting.current.business_hours_start %>,
    businessHoursEnd: <%= ApplicationSetting.current.business_hours_end %>,
    slotIntervalMinutes: <%= ApplicationSetting.current.slot_interval_minutes %>,
    reservationIntervalMinutes: <%= ApplicationSetting.current.reservation_interval_minutes %>,
    sundayClosed: <%= ApplicationSetting.current.sunday_closed? %>
  };

  console.log('ğŸ—“ï¸ Calendar system settings:', systemSettings);

  function showMessage(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
      if (alertDiv.parentNode) {
        alertDiv.remove();
      }
    }, 3000);
  }

  // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤
  function getStatusText(status) {
    const statusMap = {
      'confirmed': 'ç¢ºå®š',
      'tentative': 'ä»®äºˆç´„',
      'cancelled': 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
      'completed': 'å®Œäº†',
      'no_show': 'ç„¡æ–­æ¬ å¸­'
    };
    return statusMap[status] || status;
  }
  
  function refreshCalendar() {
    if (pageCalendar) {
      console.log('ğŸ”„ Refreshing calendar events (including intervals)');
      pageCalendar.refetchEvents();
    }
  }
  
  // å€‹åˆ¥ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã®é©ç”¨
  function applyIndividualInterval() {
    if (!currentReservationId) return;
    
    const toggle = document.getElementById('individualIntervalToggle');
    const input = document.getElementById('individual-interval-input');
    const applyBtn = document.getElementById('applyIndividualInterval');
    
    const intervalMinutes = toggle.checked ? parseInt(input.value) : null;
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
    applyBtn.disabled = true;
    applyBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>é©ç”¨ä¸­...';
    
    fetch(`/admin/reservations/${currentReservationId}/update_individual_interval`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
        'Accept': 'application/json'
      },
      body: JSON.stringify({
        individual_interval_minutes: intervalMinutes
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        currentIndividualInterval = data.reservation.individual_interval_minutes;
        showMessage(data.message, 'success');
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
        if (pageCalendar) {
          pageCalendar.refetchEvents();
        }
      } else {
        showMessage(data.error || 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šã®é©ç”¨ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      }
    })
    .catch(error => {
      console.error('âŒ Individual interval update failed:', error);
      showMessage('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
    })
    .finally(() => {
      applyBtn.disabled = false;
      applyBtn.innerHTML = '<i class="fas fa-check me-1"></i>é©ç”¨';
    });
  }

  // å€‹åˆ¥ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã®ãƒªã‚»ãƒƒãƒˆ
  function resetIndividualInterval() {
    if (!currentReservationId) return;
    
    if (!confirm('ã“ã®äºˆç´„ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¨­å®šã‚’ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã«æˆ»ã—ã¾ã™ã‹ï¼Ÿ')) return;
    
    const resetBtn = document.getElementById('resetIndividualInterval');
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
    resetBtn.disabled = true;
    resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ãƒªã‚»ãƒƒãƒˆä¸­...';
    
    fetch(`/admin/reservations/${currentReservationId}/reset_individual_interval`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
        'Accept': 'application/json'
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        currentIndividualInterval = null;
        
        // UI ã‚’ãƒªã‚»ãƒƒãƒˆ
        const toggle = document.getElementById('individualIntervalToggle');
        toggle.checked = false;
        toggle.dispatchEvent(new Event('change')); // ãƒˆã‚°ãƒ«å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«
        
        showMessage(data.message, 'success');
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
        if (pageCalendar) {
          pageCalendar.refetchEvents();
        }
      } else {
        showMessage(data.error || 'ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      }
    })
    .catch(error => {
      console.error('âŒ Individual interval reset failed:', error);
      showMessage('ãƒªã‚»ãƒƒãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
    })
    .finally(() => {
      resetBtn.disabled = false;
      resetBtn.innerHTML = '<i class="fas fa-undo me-1"></i>ãƒªã‚»ãƒƒãƒˆ';
    });
  }
  
  // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å€¤ã«å¿œã˜ãŸãƒãƒƒã‚¸ã‚¯ãƒ©ã‚¹
  function getIntervalBadgeClass(interval) {
    if (interval === 0) return 'bg-secondary';
    if (interval <= 10) return 'bg-info';
    if (interval <= 20) return 'bg-success';
    if (interval <= 30) return 'bg-warning';
    return 'bg-danger';
  }
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ã‚’æ‹¡å¼µ
  function enhanceEventClickHandler() {
    // æ—¢å­˜ã® openReservationModal é–¢æ•°ã‚’æ‹¡å¼µ
    const originalOpenReservationModal = window.openReservationModal;
    
    if (originalOpenReservationModal) {
      window.openReservationModal = function(reservationId, dateStr) {
        // å…ƒã®å‡¦ç†ã‚’å®Ÿè¡Œ
        originalOpenReservationModal(reservationId, dateStr);
        
        // å€‹åˆ¥ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
        setTimeout(() => {
          initializeIndividualIntervalControls();
          
          // æ—¢å­˜äºˆç´„ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
          if (reservationId) {
            loadReservationDataWithInterval(reservationId);
          }
        }, 100);
      };
    }
  }

  // å€‹åˆ¥ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ©Ÿèƒ½ã®åˆæœŸåŒ–
  function initializeIndividualIntervalControls() {
    const toggle = document.getElementById('individualIntervalToggle');
    const individualArea = document.getElementById('individualIntervalArea');
    const systemArea = document.getElementById('systemIntervalArea');
    const slider = document.getElementById('individual-interval-slider');
    const input = document.getElementById('individual-interval-input');
    const presetButtons = document.querySelectorAll('.individual-preset-btn');
    const statusBadge = document.getElementById('interval-status-badge');
    const previewDiv = document.getElementById('individual-interval-preview');
    const resetBtn = document.getElementById('resetIndividualInterval');
    const applyBtn = document.getElementById('applyIndividualInterval');
    
    if (!toggle) return;
    
    // ãƒˆã‚°ãƒ«ã‚¹ã‚¤ãƒƒãƒã®å‡¦ç†
    toggle.addEventListener('change', function() {
      if (this.checked) {
        individualArea.style.display = 'block';
        systemArea.style.display = 'none';
        statusBadge.textContent = 'å€‹åˆ¥è¨­å®š';
        statusBadge.className = 'badge bg-warning text-dark ms-2';
        updateIndividualPreview(input.value);
      } else {
        individualArea.style.display = 'none';
        systemArea.style.display = 'block';
        statusBadge.textContent = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š';
        statusBadge.className = 'badge bg-primary ms-2';
        updateSystemPreview();
      }
    });
    
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨å…¥åŠ›ã®åŒæœŸ
    slider.addEventListener('input', function() {
      input.value = this.value;
      updateIndividualPreview(this.value);
      updateIndividualPresetButtons(this.value);
    });

    input.addEventListener('input', function() {
      slider.value = this.value;
      updateIndividualPreview(this.value);
      updateIndividualPresetButtons(this.value);
    });
    
    // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®å‡¦ç†
    presetButtons.forEach(button => {
      button.addEventListener('click', function() {
        const value = this.dataset.value;
        slider.value = value;
        input.value = value;
        updateIndividualPreview(value);
        updateIndividualPresetButtons(value);
      });
    });
    
    // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
    resetBtn.addEventListener('click', function() {
      resetIndividualInterval();
    });
    
    // é©ç”¨ãƒœã‚¿ãƒ³
    applyBtn.addEventListener('click', function() {
      applyIndividualInterval();
    });
  }
  
  // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿æ™‚ã«å€‹åˆ¥ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’è¨­å®š
  function loadIndividualIntervalData(reservationData) {
    currentReservationId = reservationData.id;
    currentIndividualInterval = reservationData.individual_interval_minutes;
    
    const toggle = document.getElementById('individualIntervalToggle');
    const slider = document.getElementById('individual-interval-slider');
    const input = document.getElementById('individual-interval-input');
    const statusBadge = document.getElementById('interval-status-badge');
    
    if (reservationData.has_individual_interval) {
      // å€‹åˆ¥è¨­å®šãŒã‚ã‚‹å ´åˆ
      toggle.checked = true;
      slider.value = reservationData.individual_interval_minutes;
      input.value = reservationData.individual_interval_minutes;
      statusBadge.textContent = 'å€‹åˆ¥è¨­å®š';
      statusBadge.className = 'badge bg-warning text-dark ms-2';
      
      document.getElementById('individualIntervalArea').style.display = 'block';
      document.getElementById('systemIntervalArea').style.display = 'none';
      
      updateIndividualPreview(reservationData.individual_interval_minutes);
      updateIndividualPresetButtons(reservationData.individual_interval_minutes);
    } else {
      // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã‚’ä½¿ç”¨
      toggle.checked = false;
      statusBadge.textContent = 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š';
      statusBadge.className = 'badge bg-primary ms-2';
      
      document.getElementById('individualIntervalArea').style.display = 'none';
      document.getElementById('systemIntervalArea').style.display = 'block';
      
      updateSystemPreview();
    }
  }
  
  // å€‹åˆ¥è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
  function updateIndividualPreview(minutes) {
    const min = parseInt(minutes);
    const previewDiv = document.getElementById('individual-interval-preview');
    if (!previewDiv) return;
    
    let html = '';
    const badgeClass = getIntervalBadgeClass(min);
    
    if (min === 0) {
      html = `
        <div class="alert alert-secondary mb-2 py-2">
          <small><strong>ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ãªã—</strong><br>
          ã“ã®äºˆç´„å°‚ç”¨è¨­å®š</small>
        </div>
      `;
    } else {
      html = `
        <div class="alert alert-warning mb-2 py-2">
          <small><strong>${min}åˆ†ã®æ•´ç†æ™‚é–“</strong><br>
          ã“ã®äºˆç´„å°‚ç”¨è¨­å®š</small>
        </div>
      `;
    }
    
    html += `<div class="text-muted small">ã‚·ã‚¹ãƒ†ãƒ è¨­å®š: ${systemDefaultInterval}åˆ†</div>`;
    previewDiv.innerHTML = html;
  }
  
  // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
  function updateSystemPreview() {
    const previewDiv = document.getElementById('individual-interval-preview');
    if (!previewDiv) return;
    
    const badgeClass = getIntervalBadgeClass(systemDefaultInterval);
    
    let html = `
      <div class="alert alert-info mb-2 py-2">
        <small><strong>ã‚·ã‚¹ãƒ†ãƒ è¨­å®šä½¿ç”¨</strong><br>
        ${systemDefaultInterval}åˆ†ã®æ•´ç†æ™‚é–“</small>
      </div>
      <div class="text-muted small">
        å¤‰æ›´ã¯ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã§è¡Œãˆã¾ã™
      </div>
    `;
    
    previewDiv.innerHTML = html;
  }
  
  // ãƒ—ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
  function updateIndividualPresetButtons(value) {
    const presetButtons = document.querySelectorAll('.individual-preset-btn');
    presetButtons.forEach(button => {
      if (button.dataset.value === value) {
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-secondary');
      } else {
        button.classList.remove('btn-secondary');
        button.classList.add('btn-outline-secondary');
      }
    });
  }
  
  //
  
  // äºˆç´„ãƒ‡ãƒ¼ã‚¿ã¨å€‹åˆ¥ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
  function loadReservationDataWithInterval(reservationId) {
    fetch(`/admin/reservations/${reservationId}.json`)
      .then(response => response.json())
      .then(data => {
        if (data.success !== false) {
          loadIndividualIntervalData(data);
        }
      })
      .catch(error => {
        console.error('âŒ Failed to load reservation interval data:', error);
      });
  }
  
  // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã‚’æ‹¡å¼µ
  function enhanceIntervalEventClick() {
    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®eventClickå‡¦ç†ã«è¿½åŠ 
    const originalEventClick = pageCalendar?.getOption('eventClick');
    
    if (pageCalendar) {
      pageCalendar.setOption('eventClick', function(info) {
        const eventType = info.event.extendedProps.type;
        
        if (eventType === 'interval') {
          // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆ
          const reservationId = info.event.extendedProps.reservation_id;
          const isIndividual = info.event.extendedProps.is_individual;
          const intervalMinutes = info.event.extendedProps.interval_minutes;
          
          if (reservationId) {
            console.log(`ğŸ”— Opening reservation ${reservationId} from ${isIndividual ? 'individual' : 'system'} interval (${intervalMinutes}åˆ†)`);
            
            showMessage(
              `${isIndividual ? 'å€‹åˆ¥è¨­å®š' : 'ã‚·ã‚¹ãƒ†ãƒ è¨­å®š'}ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ« (${intervalMinutes}åˆ†) - äºˆç´„è©³ç´°ã‚’é–‹ãã¾ã™`,
              isIndividual ? 'warning' : 'info'
            );
            
            openReservationModal(reservationId);
          }
          return;
        }
        
        // ãã®ä»–ã®ã‚¤ãƒ™ãƒ³ãƒˆã¯æ—¢å­˜ã®å‡¦ç†
        if (originalEventClick) {
          originalEventClick(info);
        }
      });
    }
  }
  
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¡¨ç¤ºå¯¾å¿œï¼‰
  function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) {
      console.error('âŒ Calendar element not found');
      return;
    }

    console.log('ğŸ—“ï¸ Initializing calendar with interval display...');
    
    // æ—¢å­˜ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚Œã°ç ´æ£„
    if (pageCalendar) {
      pageCalendar.destroy();
      pageCalendar = null;
    }
    
    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‹•çš„ã«è¿½åŠ 
    addIntervalStyles();
    
    pageCalendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'timeGridWeek',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay'
      },
      locale: 'ja',
      height: 'auto',
      editable: true,
      selectable: true,
      selectMirror: true,
      dayMaxEvents: true,
      weekends: !systemSettings.sundayClosed,
      
      // å–¶æ¥­æ™‚é–“ã®è¨­å®š
      businessHours: {
        daysOfWeek: systemSettings.sundayClosed ? [1, 2, 3, 4, 5, 6] : [0, 1, 2, 3, 4, 5, 6],
        startTime: `${systemSettings.businessHoursStart.toString().padStart(2, '0')}:00`,
        endTime: `${systemSettings.businessHoursEnd.toString().padStart(2, '0')}:00`,
      },
      
      // ã‚¹ãƒ­ãƒƒãƒˆé–“éš”ã®è¨­å®š
      slotDuration: `00:${systemSettings.slotIntervalMinutes.toString().padStart(2, '0')}:00`,
      slotMinTime: `${systemSettings.businessHoursStart.toString().padStart(2, '0')}:00:00`,
      slotMaxTime: `${systemSettings.businessHoursEnd.toString().padStart(2, '0')}:00:00`,
      
      // ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹
      events: '/admin/reservations.json',
      
      // ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å¯¾å¿œï¼‰
      eventClick: function(info) {
        const eventType = info.event.extendedProps.type;
        
        if (eventType === 'interval') {
          // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã€é–¢é€£ã™ã‚‹äºˆç´„ã‚’é–‹ã
          const reservationId = info.event.extendedProps.reservation_id;
          if (reservationId) {
            console.log(`ğŸ”— Opening related reservation ${reservationId} from interval`);
            showMessage(`äºˆç´„ID: ${reservationId} ã®è©³ç´°ã‚’è¡¨ç¤ºã—ã¾ã™`, 'info');
            openReservationModal(reservationId);
          }
          return;
        }
        
        if (eventType === 'reservation' || !eventType) {
          console.log('ğŸ“… Opening reservation modal for ID:', info.event.id);
          openReservationModal(info.event.id);
        }
      },
      
      // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«é™¤å¤–ï¼‰
      eventDrop: function(info) {
        const eventType = info.event.extendedProps.type;
        
        if (eventType === 'interval') {
          info.revert();
          showMessage('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã¯ç§»å‹•ã§ãã¾ã›ã‚“', 'warning');
          return;
        }
        
        if (eventType === 'reservation' || !eventType) {
          console.log('ğŸ”„ Moving reservation:', info.event.id);
          updateReservationTime(info.event, info.revert);
        }
      },
      
      // ãƒªã‚µã‚¤ã‚ºå‡¦ç†ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«é™¤å¤–ï¼‰
      eventResize: function(info) {
        const eventType = info.event.extendedProps.type;
        
        if (eventType === 'interval') {
          info.revert();
          showMessage('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã¯å¤‰æ›´ã§ãã¾ã›ã‚“', 'warning');
          return;
        }
        
        if (eventType === 'reservation' || !eventType) {
          console.log('ğŸ”„ Resizing reservation:', info.event.id);
          updateReservationTime(info.event, info.revert);
        }
      },
      
      // æ–°è¦äºˆç´„ä½œæˆ
      select: function(info) {
        console.log('ğŸ“… Creating new reservation at:', info.startStr);
        openReservationModal(null, info.startStr);
      },
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º
      eventDidMount: function(info) {
        const eventType = info.event.extendedProps.type;
        
        if (eventType === 'interval') {
          // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
          info.el.classList.add('interval-event');
          info.el.style.opacity = '0.6';
          info.el.style.fontSize = '0.8em';
          info.el.style.fontStyle = 'italic';
          info.el.style.borderStyle = 'dashed';
          info.el.title = `${info.event.title} (äºˆç´„ID: ${info.event.extendedProps.reservation_id})`;
          info.el.style.cursor = 'pointer';
          
          // ãƒ‰ãƒ©ãƒƒã‚°ã‚’ç„¡åŠ¹åŒ–
          info.el.addEventListener('mousedown', function(e) {
            e.stopPropagation();
          });
          
        } else if (eventType === 'reservation' || !eventType) {
          // äºˆç´„ã‚¤ãƒ™ãƒ³ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
          info.el.classList.add('reservation-event');
          info.el.style.fontWeight = 'bold';
          info.el.style.borderStyle = 'solid';
          info.el.style.borderWidth = '2px';
          
          const status = info.event.extendedProps.status;
          if (status) {
            info.el.classList.add(`status-${status}`);
            info.el.title = `${info.event.title}\nã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${getStatusText(status)}\nãƒ¡ãƒ¢: ${info.event.extendedProps.note || 'ãªã—'}`;
          }
        }
      },
      
      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      eventSourceFailure: function(error) {
        console.error('âŒ Calendar data loading failed:', error);
        showMessage('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      },
      
      // èª­ã¿è¾¼ã¿ä¸­ã®è¡¨ç¤º
      loading: function(isLoading) {
        if (isLoading) {
          console.log('ğŸ”„ Calendar loading events...');
        } else {
          console.log('âœ… Calendar events loaded');
        }
      }
    });

    pageCalendar.render();
    console.log('âœ… Calendar initialized with interval display');
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.pageCalendar = pageCalendar;
  }
  
  // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å‹•çš„ã«è¿½åŠ 
  function addIntervalStyles() {
    const existingStyle = document.getElementById('interval-styles');
    if (existingStyle) {
      existingStyle.remove();
    }
    
    const style = document.createElement('style');
    style.id = 'interval-styles';
    style.textContent = `
      .interval-event {
        border-style: dashed !important;
        border-width: 1px !important;
        opacity: 0.6 !important;
        font-style: italic !important;
      }
      
      .interval-event .fc-event-title {
        font-size: 0.75em !important;
        color: #6c757d !important;
      }
      
      .reservation-event {
        border-style: solid !important;
        border-width: 2px !important;
        font-weight: bold !important;
      }
      
      .reservation-event:hover {
        transform: scale(1.02) !important;
        transition: transform 0.1s ease !important;
        z-index: 1000 !important;
      }
      
      .interval-event:hover {
        opacity: 0.8 !important;
        cursor: pointer !important;
      }
      
      .status-confirmed {
        box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3) !important;
      }
      
      .status-tentative {
        box-shadow: 0 2px 4px rgba(255, 193, 7, 0.3) !important;
      }
      
      .status-cancelled {
        box-shadow: 0 2px 4px rgba(220, 53, 69, 0.3) !important;
      }
    `;
    document.head.appendChild(style);
  }
  
  // äºˆç´„æ™‚é–“æ›´æ–°
  function updateReservationTime(event, revertFunc) {
    const startTime = event.start.toISOString();
    const endTime = event.end.toISOString();
    
    console.log(`ğŸ”„ Updating reservation ${event.id} with buffer time: ${systemSettings.reservationIntervalMinutes} minutes`);
    
    fetch(`/admin/reservations/${event.id}`, {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
      },
      body: JSON.stringify({
        reservation: {
          start_time: startTime,
          end_time: endTime
        }
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        console.log('âœ… Reservation updated successfully');
        showMessage('äºˆç´„æ™‚é–“ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
        pageCalendar.refetchEvents();
      } else {
        console.error('âŒ Reservation update failed:', data.error);
        showMessage(data.error || 'äºˆç´„ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
        revertFunc();
      }
    })
    .catch(error => {
      console.error('âŒ Update request failed:', error);
      showMessage('æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
      revertFunc();
    });
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®å‡¦ç†ã¯é•·ã„ãŸã‚ã€ã“ã“ã§çœç•¥ã—ã€å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
  // ... (ãã®ä»–ã®é–¢æ•°ã¯å‰å›ã®ã‚³ãƒ¼ãƒ‰ã¨åŒæ§˜)
  
  // åˆæœŸåŒ–
  function initialize() {
    console.log('ğŸš€ Initializing calendar with interval display');
    console.log('ğŸ“Š System settings:', systemSettings);
    
    initializeCalendar();
    // ãã®ä»–ã®åˆæœŸåŒ–å‡¦ç†...
  }
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
  window.refreshCalendar = refreshCalendar;
  window.showMessage = showMessage;
  window.pageCalendar = pageCalendar;
  
  function initializeAll() {
  enhanceEventClickHandler();
  setTimeout(() => {
    if (pageCalendar) {
      enhanceIntervalEventClick();
    }
  }, 1000);
}

  // çµ±ä¸€ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      initializeComplete();
      initializeAll();
    });
  } else {
    initializeComplete();
    initializeAll();
  }

  document.addEventListener('turbo:load', function() {
    initializeComplete();
    initializeAll();
  });

  // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®å‡¦ç†ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆå®Œå…¨ç‰ˆï¼‰
// ä¸Šè¨˜ã®JavaScriptã‚³ãƒ¼ãƒ‰ã®ç¶šãã¨ã—ã¦è¿½åŠ ã—ã¦ãã ã•ã„

  // äºˆç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
  function openReservationModal(reservationId, dateStr) {
    console.log('ğŸ“ Opening reservation modal:', { reservationId, dateStr });
    
    const modal = document.getElementById('reservationModal');
    if (!modal) {
      console.error('âŒ Reservation modal not found');
      return;
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’ãƒªã‚»ãƒƒãƒˆ/è¨­å®š
    resetModalFields(reservationId, dateStr);
    
    // æ—¢å­˜äºˆç´„ã®å ´åˆã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    if (reservationId) {
      loadReservationData(reservationId);
    }
    
    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒªã‚»ãƒƒãƒˆ
  function resetModalFields(reservationId, dateStr) {
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸåŒ–
    const fields = {
      reservationId: reservationId || '',
      reservationUserId: '',
      reservationCourse: '60åˆ†',
      reservationDate: dateStr ? dateStr.split('T')[0] : '',
      reservationTime: dateStr ? dateStr.split('T')[1].substring(0, 5) : '',
      reservationStatus: 'tentative',
      reservationNote: '',
      cancellationReason: ''
    };
    
    Object.entries(fields).forEach(([fieldId, value]) => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.value = value;
      }
    });
    
    // ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
    const deleteBtn = document.getElementById('deleteReservationBtn');
    const cancelBtn = document.getElementById('cancelReservationBtn');
    
    if (deleteBtn) {
      deleteBtn.classList.toggle('d-none', !reservationId);
    }
    if (cancelBtn) {
      cancelBtn.classList.toggle('d-none', !reservationId);
    }
    
    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆã‚°ãƒ«ã®åˆæœŸåŒ–
    const newUserToggle = document.getElementById('newUserToggle');
    const existingUserSection = document.getElementById('existingUserSection');
    const newUserSection = document.getElementById('newUserSection');
    
    if (newUserToggle) {
      newUserToggle.checked = false;
      if (existingUserSection) existingUserSection.style.display = 'block';
      if (newUserSection) newUserSection.style.display = 'none';
    }
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚¨ãƒªã‚¢ã®åˆæœŸåŒ–
    updateCancellationReasonVisibility();
    updateEndTimeDisplay();
  }
  
  // æ—¢å­˜äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
  function loadReservationData(reservationId) {
    fetch(`/admin/reservations/${reservationId}.json`)
      .then(response => response.json())
      .then(data => {
        if (data.success !== false) {
          // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
          const mapping = {
            reservationUserId: 'user_id',
            reservationCourse: 'course',
            reservationStatus: 'status',
            reservationNote: 'note',
            cancellationReason: 'cancellation_reason'
          };
          
          Object.entries(mapping).forEach(([fieldId, dataKey]) => {
            const field = document.getElementById(fieldId);
            if (field && data[dataKey] !== undefined) {
              field.value = data[dataKey] || '';
            }
          });
          
          // æ—¥æ™‚ã®è¨­å®š
          if (data.start_time) {
            const startTime = new Date(data.start_time);
            const dateField = document.getElementById('reservationDate');
            const timeField = document.getElementById('reservationTime');
            
            if (dateField) {
              dateField.value = startTime.toISOString().split('T')[0];
            }
            if (timeField) {
              timeField.value = startTime.toTimeString().substring(0, 5);
            }
          }
          
          // è¡¨ç¤ºã®æ›´æ–°
          updateCancellationReasonVisibility();
          updateEndTimeDisplay();
        }
      })
      .catch(error => {
        console.error('âŒ Failed to load reservation data:', error);
        showMessage('äºˆç´„ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      });
  }
  
  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±è¡¨ç¤ºã®æ›´æ–°
  function updateCancellationReasonVisibility() {
    const statusSelect = document.getElementById('reservationStatus');
    const cancellationArea = document.getElementById('cancellationReasonArea');
    
    if (statusSelect && cancellationArea) {
      const shouldShow = statusSelect.value === 'cancelled';
      cancellationArea.style.display = shouldShow ? 'block' : 'none';
      
      const reasonField = document.getElementById('cancellationReason');
      if (reasonField) {
        reasonField.required = shouldShow;
      }
    }
  }
  
  // çµ‚äº†æ™‚é–“è¡¨ç¤ºã®æ›´æ–°
  function updateEndTimeDisplay() {
    const dateField = document.getElementById('reservationDate');
    const timeField = document.getElementById('reservationTime');
    const courseField = document.getElementById('reservationCourse');
    const endTimeDisplay = document.getElementById('endTimeDisplay');
    
    if (!dateField || !timeField || !courseField || !endTimeDisplay) return;
    
    const date = dateField.value;
    const time = timeField.value;
    const course = courseField.value;
    
    if (date && time && course) {
      try {
        const startDateTime = new Date(`${date}T${time}`);
        
        // ã‚³ãƒ¼ã‚¹ã«å¿œã˜ãŸæ‰€è¦æ™‚é–“ã‚’å–å¾—
        const durationMap = {
          '40åˆ†': 40,
          '60åˆ†': 60,
          '80åˆ†': 80
        };
        
        const duration = durationMap[course] || 60;
        const endDateTime = new Date(startDateTime.getTime() + duration * 60000);
        
        const endTimeStr = endDateTime.toTimeString().substring(0, 5);
        
        // äºˆç´„å¾Œã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æƒ…å ±ã®ã¿è¡¨ç¤º
        const intervalInfo = systemSettings.reservationIntervalMinutes > 0 
          ? ` + æ•´ç†æ™‚é–“${systemSettings.reservationIntervalMinutes}åˆ†`
          : '';
        
        endTimeDisplay.textContent = `${endTimeStr} (${duration}åˆ†é–“)${intervalInfo}`;
        endTimeDisplay.className = 'form-control-plaintext text-success';
        
        // å®Ÿéš›ã®çµ‚äº†æ™‚é–“ï¼ˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«å«ã‚€ï¼‰ã‚‚è¡¨ç¤º
        if (systemSettings.reservationIntervalMinutes > 0) {
          const actualEndTime = new Date(endDateTime.getTime() + systemSettings.reservationIntervalMinutes * 60000);
          const actualEndTimeStr = actualEndTime.toTimeString().substring(0, 5);
          endTimeDisplay.innerHTML = `
            ${endTimeStr} (${duration}åˆ†é–“)<br>
            <small class="text-muted">æ•´ç†å®Œäº†: ${actualEndTimeStr}</small>
          `;
        }
        
      } catch (error) {
        endTimeDisplay.textContent = 'æ™‚é–“ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ';
        endTimeDisplay.className = 'form-control-plaintext text-danger';
      }
    } else {
      endTimeDisplay.textContent = 'æ™‚é–“ã¨ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„';
      endTimeDisplay.className = 'form-control-plaintext text-muted';
    }
  }
  
  // äºˆç´„ä¿å­˜
  function saveReservation() {
    console.log('ğŸ’¾ Saving reservation...');
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!validateReservationForm()) {
      return;
    }
    
    const reservationId = document.getElementById('reservationId').value;
    const isNewUser = document.getElementById('newUserToggle').checked;
    
    // ãƒ‡ãƒ¼ã‚¿æº–å‚™
    const data = {
      reservation: {
        course: document.getElementById('reservationCourse').value,
        note: document.getElementById('reservationNote').value,
        status: document.getElementById('reservationStatus').value,
        start_time: `${document.getElementById('reservationDate').value}T${document.getElementById('reservationTime').value}:00`,
        cancellation_reason: document.getElementById('cancellationReason').value
      }
    };
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®è¿½åŠ 
    if (isNewUser) {
      data.new_user = {
        name: document.getElementById('newUserName').value,
        phone_number: document.getElementById('newUserPhone').value,
        email: document.getElementById('newUserEmail').value,
        birth_date: document.getElementById('newUserBirthDate').value,
        address: document.getElementById('newUserAddress').value,
        admin_memo: document.getElementById('newUserMemo').value
      };
    } else {
      data.reservation.user_id = document.getElementById('reservationUserId').value;
    }
    
    // APIå‘¼ã³å‡ºã—
    const url = reservationId ? `/admin/reservations/${reservationId}` : '/admin/reservations';
    const method = reservationId ? 'PATCH' : 'POST';
    
    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const saveBtn = document.getElementById('saveReservationBtn');
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';
    }
    
    fetch(url, {
      method: method,
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content,
        'Accept': 'application/json'
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success !== false) {
        const message = reservationId ? 'äºˆç´„ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'äºˆç´„ã‚’ä½œæˆã—ã¾ã—ãŸ';
        showMessage(message, 'success');
        closeModal();
        refreshCalendar();
      } else {
        const errorMessage = data.error || data.errors?.join(', ') || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
        showMessage(errorMessage, 'danger');
      }
    })
    .catch(error => {
      console.error('âŒ Save failed:', error);
      showMessage('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
    })
    .finally(() => {
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save me-1"></i>ä¿å­˜';
      }
    });
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  function validateReservationForm() {
    const isNewUser = document.getElementById('newUserToggle').checked;
    const errors = [];
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã®æ¤œè¨¼
    if (isNewUser) {
      const newUserName = document.getElementById('newUserName').value.trim();
      if (!newUserName) {
        errors.push('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      }
    } else {
      const userId = document.getElementById('reservationUserId').value;
      if (!userId) {
        errors.push('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
      }
    }
    
    // äºˆç´„è©³ç´°ã®æ¤œè¨¼
    const date = document.getElementById('reservationDate').value;
    const time = document.getElementById('reservationTime').value;
    const course = document.getElementById('reservationCourse').value;
    
    if (!date) errors.push('äºˆç´„æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
    if (!time) errors.push('é–‹å§‹æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
    if (!course) errors.push('ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã®æ¤œè¨¼
    const status = document.getElementById('reservationStatus').value;
    if (status === 'cancelled') {
      const reason = document.getElementById('cancellationReason').value.trim();
      if (!reason) {
        errors.push('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      }
    }
    
    if (errors.length > 0) {
      showMessage('å…¥åŠ›ã‚¨ãƒ©ãƒ¼:\n' + errors.join('\n'), 'danger');
      return false;
    }
    
    return true;
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
  function closeModal() {
    const modal = document.getElementById('reservationModal');
    if (modal) {
      const bootstrapModal = bootstrap.Modal.getInstance(modal);
      if (bootstrapModal) {
        bootstrapModal.hide();
      }
    }
  }
  
  // äºˆç´„å‰Šé™¤
  function deleteReservation() {
    const reservationId = document.getElementById('reservationId').value;
    if (!reservationId) return;
    
    if (!confirm('æœ¬å½“ã«ã“ã®äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒ«æ™‚é–“ã‚‚å«ã‚ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) return;
    
    fetch(`/admin/reservations/${reservationId}`, {
      method: 'DELETE',
      headers: {
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showMessage('äºˆç´„ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        closeModal();
        refreshCalendar();
      } else {
        showMessage(data.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
      }
    })
    .catch(error => {
      console.error('âŒ Delete failed:', error);
      showMessage('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
    });
  }
  
  // æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ç”Ÿæˆï¼ˆã‚·ã‚¹ãƒ†ãƒ è¨­å®šã«åŸºã¥ãï¼‰
  function generateTimeOptions() {
    const timeSelect = document.getElementById('reservationTime');
    if (!timeSelect) return;
    
    // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ä¿æŒï¼‰
    const defaultOption = timeSelect.querySelector('option[value=""]');
    timeSelect.innerHTML = '';
    if (defaultOption) {
      timeSelect.appendChild(defaultOption);
    }
    
    // ã‚·ã‚¹ãƒ†ãƒ è¨­å®šã«åŸºã¥ã„ã¦æ™‚é–“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
    for (let hour = systemSettings.businessHoursStart; hour < systemSettings.businessHoursEnd; hour++) {
      for (let minute = 0; minute < 60; minute += systemSettings.slotIntervalMinutes) {
        const timeStr = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        const option = document.createElement('option');
        option.value = timeStr;
        option.textContent = timeStr;
        timeSelect.appendChild(option);
      }
    }
    
    console.log(`âœ… Generated time options with ${systemSettings.slotIntervalMinutes}-minute intervals`);
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’å–å¾—
  function loadUsers() {
    fetch('/admin/users.json')
      .then(response => response.json())
      .then(users => {
        currentUsers = users;
        updateUserSelect();
      })
      .catch(error => {
        console.error('âŒ Failed to load users:', error);
        showMessage('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'warning');
      });
  }
  
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’æ›´æ–°
  function updateUserSelect() {
    const userSelect = document.getElementById('reservationUserId');
    if (!userSelect) return;
    
    // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æ®‹ã™ï¼‰
    const defaultOption = userSelect.querySelector('option[value=""]');
    userSelect.innerHTML = '';
    if (defaultOption) {
      userSelect.appendChild(defaultOption);
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    currentUsers.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = user.name || `ID: ${user.id}`;
      userSelect.appendChild(option);
    });
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  function setupEventListeners() {
    // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒˆã‚°ãƒ«
    const newUserToggle = document.getElementById('newUserToggle');
    if (newUserToggle) {
      newUserToggle.addEventListener('change', function() {
        const existingUserSection = document.getElementById('existingUserSection');
        const newUserSection = document.getElementById('newUserSection');
        
        if (this.checked) {
          existingUserSection.style.display = 'none';
          newUserSection.style.display = 'block';
        } else {
          existingUserSection.style.display = 'block';
          newUserSection.style.display = 'none';
        }
      });
    }
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¤‰æ›´æ™‚ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±è¡¨ç¤º
    const statusSelect = document.getElementById('reservationStatus');
    if (statusSelect) {
      statusSelect.addEventListener('change', updateCancellationReasonVisibility);
    }
    
    // çµ‚äº†æ™‚é–“è¡¨ç¤ºã®æ›´æ–°
    ['reservationDate', 'reservationTime', 'reservationCourse'].forEach(id => {
      const element = document.getElementById(id);
      if (element) {
        element.addEventListener('change', updateEndTimeDisplay);
      }
    });
    
    // ä¿å­˜ãƒœã‚¿ãƒ³
    const saveBtn = document.getElementById('saveReservationBtn');
    if (saveBtn) {
      saveBtn.addEventListener('click', saveReservation);
    }
    
    // å‰Šé™¤ãƒœã‚¿ãƒ³
    const deleteBtn = document.getElementById('deleteReservationBtn');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', deleteReservation);
    }
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
    const cancelBtn = document.getElementById('cancelReservationBtn');
    if (cancelBtn) {
      cancelBtn.addEventListener('click', function() {
        const reservationId = document.getElementById('reservationId').value;
        if (!reservationId) return;
        
        const reason = prompt('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (!reason) return;
        
        fetch(`/admin/reservations/${reservationId}/cancel`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
          },
          body: JSON.stringify({ cancellation_reason: reason })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showMessage('äºˆç´„ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'success');
            closeModal();
            refreshCalendar();
          } else {
            showMessage(data.error || 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ', 'danger');
          }
        })
        .catch(error => {
          console.error('âŒ Cancel failed:', error);
          showMessage('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'danger');
        });
      });
    }
    
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    setupFilterEventListeners();
  }
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
  function setupFilterEventListeners() {
    const filterButtons = [
      { id: 'showAllReservations', filter: 'all' },
      { id: 'showConfirmedOnly', filter: 'confirmed' },
      { id: 'showTentativeOnly', filter: 'tentative' },
      { id: 'showRecurringOnly', filter: 'recurring' }
    ];
    
    filterButtons.forEach(({ id, filter }) => {
      const btn = document.getElementById(id);
      if (btn) {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          applyEventFilter(filter);
        });
      }
    });
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®é©ç”¨
  function applyEventFilter(filterType) {
    if (!pageCalendar) return;
    
    console.log(`ğŸ” Applying filter: ${filterType}`);
    
    let eventSourceUrl = '/admin/reservations.json';
    
    switch (filterType) {
      case 'confirmed':
        eventSourceUrl += '?status=confirmed';
        break;
      case 'tentative':
        eventSourceUrl += '?status=tentative';
        break;
      case 'recurring':
        eventSourceUrl += '?recurring=true';
        break;
      case 'all':
      default:
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®URL
        break;
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚¹ã‚’æ›´æ–°
    pageCalendar.removeAllEventSources();
    pageCalendar.addEventSource(eventSourceUrl);
    
    const filterName = getFilterName(filterType);
    showMessage(`ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã€Œ${filterName}ã€ã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'info');
  }
  
  // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åã‚’å–å¾—
  function getFilterName(filterType) {
    const filterNames = {
      'all': 'å…¨ã¦ã®äºˆç´„',
      'confirmed': 'ç¢ºå®šäºˆç´„ã®ã¿',
      'tentative': 'ä»®äºˆç´„ã®ã¿',
      'recurring': 'ç¹°ã‚Šè¿”ã—äºˆç´„ã®ã¿'
    };
    return filterNames[filterType] || filterType;
  }
  
  // å®Œå…¨åˆæœŸåŒ–é–¢æ•°ï¼ˆæ›´æ–°ç‰ˆï¼‰
  function initializeComplete() {
    console.log('ğŸš€ Complete initialization with interval display');
    console.log('ğŸ“Š System settings:', systemSettings);
    
    generateTimeOptions();
    loadUsers();
    initializeCalendar();
    setupEventListeners();
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
    window.openReservationModal = openReservationModal;
    window.refreshCalendar = refreshCalendar;
    window.showMessage = showMessage;
    window.pageCalendar = pageCalendar;
  }

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
  window.loadIndividualIntervalData = loadIndividualIntervalData;
  window.applyIndividualInterval = applyIndividualInterval;
  window.resetIndividualInterval = resetIndividualInterval;
  
  // åˆæœŸåŒ–ã®å®Ÿè¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeComplete);
  } else {
    initializeComplete();
  }
  
  // Turboå¯¾å¿œ
  document.addEventListener('turbo:load', initializeComplete);
  
  document.addEventListener('turbo:before-cache', function() {
    if (pageCalendar) {
      console.log('ğŸ§¹ Cleaning up calendar before cache');
      pageCalendar.destroy();
      pageCalendar = null;
    }
  });
  
})();
</script>

<style>
.individual-interval .fc-event-title {
  font-weight: bold !important;
  font-style: italic !important;
}

.individual-interval {
  border-style: dashed !important;
  border-width: 2px !important;
  animation: pulse-individual 2s infinite;
}

@keyframes pulse-individual {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 0.6; }
}

.system-interval {
  border-style: dashed !important;
  border-width: 1px !important;
}

#individual-interval-preview .alert {
  font-size: 0.85rem;
}

.individual-preset-btn {
  font-size: 0.8rem;
  padding: 0.25rem 0.5rem;
  min-height: 32px;
}

#interval-status-badge {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  transition: all 0.3s ease;
}

.form-range {
  background: linear-gradient(to right, #28a745 0%, #ffc107 50%, #dc3545 100%);
  height: 8px;
  border-radius: 4px;
}

.form-range::-webkit-slider-thumb {
  height: 20px;
  width: 20px;
  background-color: #fff;
  border: 2px solid #007bff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.form-range::-moz-range-thumb {
  height: 20px;
  width: 20px;
  background-color: #fff;
  border: 2px solid #007bff;
  border-radius: 50%;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
</style> 