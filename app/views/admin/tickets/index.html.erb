<div class="container my-4">
  <h1 class="mb-4">チケット一覧</h1>
  <%= search_form_for @q, url: admin_tickets_path, method: :get, html: { class: "row g-3 align-items-end mb-4" } do |f| %>
    <div class="col-md-4">
      <%= f.label :user_name_cont, "ユーザー名", class: "form-label" %>
      <%= f.text_field :user_name_cont, class: "form-control", placeholder: "例: 山田太郎" %>
    </div>

    <div class="col-md-3">
      <label for="q_remaining_status" class="form-label">ステータス</label>
      <%= select_tag "q[remaining_status]",
            options_for_select([
              ["すべて", ""],
              ["未使用あり", "unused"],
              ["すべて使用済み", "used"]
            ], params.dig(:q, :remaining_status)),
            class: "form-select" %>
    </div>

    <div class="col-md-auto d-flex align-items-end">
      <%= f.submit "検索", class: "btn btn-primary me-2" %>
      <%= link_to "リセット", admin_tickets_path, class: "btn btn-outline-secondary" %>
    </div>
  <% end %>
  <div class="mb-3">
    <%= link_to "CSVダウンロード", admin_tickets_path(format: :csv), class: "btn btn-sm btn-outline-success" %>
  </div>
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th><%= sort_link(@q, :id, "ID") %></th>
        <th><%= sort_link(@q, 'user.name', "ユーザー") %></th>
        <th><%= sort_link(@q, :title, "タイトル") %></th>
        <th><%= sort_link(@q, :remaining_count, "残回数") %></th>
        <th><%= sort_link(@q, :expiry_date, "期限") %></th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @tickets.each do |ticket| %>
        <tr>
          <td><%= ticket.id %></td>
          <td><%= ticket.user&.name.presence || ticket.user&.line_user_id %></td>
          <td><%= ticket.title %></td>
          <td>残り: <%= ticket.remaining_count %> 回</td>
          <td><%= ticket.expiry_date.strftime("%Y-%m-%d") %></td>
          <td>
            <%= button_to "削除", admin_ticket_path(ticket),
                method: :delete,
                data: { confirm: "本当に削除しますか？" },
                class: "btn btn-sm btn-outline-danger" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <div class="mt-3">
    <%= paginate @tickets %>
  </div>
</div>
