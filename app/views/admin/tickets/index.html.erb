<div class="container my-4">
  <h1 class="mb-4">ãƒã‚±ãƒƒãƒˆä¸€è¦§</h1>
  <%= search_form_for @q, url: admin_tickets_path, method: :get, html: { class: "row g-3 align-items-end mb-4" } do |f| %>
    <div class="col-md-4">
      <%= f.label :user_name_cont, "ãƒ¦ãƒ¼ã‚¶ãƒ¼å", class: "form-label" %>
      <%= f.text_field :user_name_cont, class: "form-control", placeholder: "ä¾‹: å±±ç”°å¤ªéƒ" %>
    </div>

    <div class="col-md-3">
      <label for="q_remaining_status" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
      <%= select_tag "q[remaining_status]",
            options_for_select([
              ["ã™ã¹ã¦", ""],
              ["æœªä½¿ç”¨ã‚ã‚Š", "unused"],
              ["ã™ã¹ã¦ä½¿ç”¨æ¸ˆã¿", "used"]
            ], params.dig(:q, :remaining_status)),
            class: "form-select" %>
    </div>

    <div class="col-md-auto d-flex align-items-end">
      <%= f.submit "æ¤œç´¢", class: "btn btn-primary me-2" %>
      <%= link_to "ãƒªã‚»ãƒƒãƒˆ", admin_tickets_path, class: "btn btn-outline-secondary" %>
    </div>
  <% end %>
  <div class="mb-3">
    <%= link_to "CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", admin_tickets_path(format: :csv), class: "btn btn-sm btn-outline-success" %>
  </div>
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th><%= sort_link(@q, :id, "ID") %></th>
        <th><%= sort_link(@q, 'user.name', "ãƒ¦ãƒ¼ã‚¶ãƒ¼") %></th>
        <th><%= sort_link(@q, :title, "ã‚¿ã‚¤ãƒˆãƒ«") %></th>
        <th><%= sort_link(@q, :remaining_count, "æ®‹å›æ•°") %></th>
        <th><%= sort_link(@q, :expiry_date, "æœŸé™") %></th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      <% @tickets.each do |ticket| %>
        <tr>
          <td><%= ticket.id %></td>
          <td><%= ticket.user&.name.presence || ticket.user&.line_user_id %></td>
          <td><%= ticket.title %></td>
          <td>æ®‹ã‚Š: <%= ticket.remaining_count %> å›</td>
          <td><%= ticket.expiry_date.strftime("%Y-%m-%d") %></td>
          <td>
            <button type="button" 
                    class="btn btn-sm btn-outline-danger delete-ticket-btn"
                    data-ticket-id="<%= ticket.id %>"
                    data-ticket-name="<%= ticket.title %>"
                    data-user-name="<%= ticket.user&.name.presence || ticket.user&.line_user_id %>">
              <i class="fas fa-trash"></i> å‰Šé™¤
            </button>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <div class="mt-3">
    <%= paginate @tickets %>
  </div>
</div>

<!-- ãƒã‚±ãƒƒãƒˆå‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="deleteTicketModal" tabindex="-1" aria-labelledby="deleteTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteTicketModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>ãƒã‚±ãƒƒãƒˆå‰Šé™¤ã®ç¢ºèª
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>ä»¥ä¸‹ã®ãƒã‚±ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
        <div class="alert alert-warning">
          <strong>ãƒã‚±ãƒƒãƒˆå:</strong> <span id="deleteTicketName"></span><br>
          <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> <span id="deleteTicketUser"></span><br>
          <strong>æ³¨æ„:</strong> ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteTicketBtn">
          <i class="fas fa-trash me-1"></i>å‰Šé™¤ã‚’å®Ÿè¡Œ
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ« ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹');
  
  // ãƒã‚±ãƒƒãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('delete-ticket-btn') || e.target.closest('.delete-ticket-btn')) {
      const deleteBtn = e.target.classList.contains('delete-ticket-btn') ? e.target : e.target.closest('.delete-ticket-btn');
      
      // æ—¢ã«å‡¦ç†ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
      if (deleteBtn.disabled) {
        console.log('âš ï¸ æ—¢ã«å‡¦ç†ä¸­ã®ãŸã‚ã€é‡è¤‡å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—');
        return;
      }
      
      const ticketId = deleteBtn.getAttribute('data-ticket-id');
      const ticketName = deleteBtn.getAttribute('data-ticket-name');
      const userName = deleteBtn.getAttribute('data-user-name');
      
      console.log('ğŸ—‘ï¸ ãƒã‚±ãƒƒãƒˆå‰Šé™¤å‡¦ç†é–‹å§‹:', { ticketId, ticketName, userName });
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
      const deleteTicketName = document.getElementById('deleteTicketName');
      const deleteTicketUser = document.getElementById('deleteTicketUser');
      
      if (!deleteTicketName || !deleteTicketUser) {
        console.error('âŒ å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        alert('å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®æº–å‚™ã«å¤±æ•—ã—ã¾ã—ãŸ');
        return;
      }
      
      deleteTicketName.textContent = ticketName;
      deleteTicketUser.textContent = userName;
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteTicketModal'));
      deleteModal.show();
      
      // å‰Šé™¤å®Ÿè¡Œãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      document.getElementById('confirmDeleteTicketBtn').onclick = function() {
        deleteTicket(ticketId, deleteBtn);
        deleteModal.hide();
        
        // å³åº§ã«èƒŒæ™¯ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        cleanupModalBackground();
      };
    }
  });
  
  // ãƒã‚±ãƒƒãƒˆå‰Šé™¤å®Ÿè¡Œ
  function deleteTicket(ticketId, deleteBtn) {
    try {
      console.log('ğŸ”„ ãƒã‚±ãƒƒãƒˆå‰Šé™¤APIå‘¼ã³å‡ºã—ä¸­...');
      
      // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const originalText = deleteBtn.innerHTML;
      deleteBtn.disabled = true;
      deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> å‰Šé™¤ä¸­...';
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      
      if (!csrfToken) {
        throw new Error('CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
      
      // ãƒã‚±ãƒƒãƒˆå‰Šé™¤APIã‚’å‘¼ã³å‡ºã—
      fetch(`/admin/tickets/${ticketId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        }
      })
      .then(response => {
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || `HTTP ${response.status}`);
          });
        }
        return response.json();
      })
      .then(data => {
        console.log('âœ… Ticket deleted:', data);
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
          <i class="fas fa-check-circle me-2"></i>
          ãƒã‚±ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('h1'));
        
        // ãƒã‚±ãƒƒãƒˆè¡Œã‚’å³åº§ã«å‰Šé™¤
        const ticketRow = deleteBtn.closest('tr');
        if (ticketRow) {
          ticketRow.remove();
          console.log('âœ… ãƒã‚±ãƒƒãƒˆè¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
        
        // ãƒã‚±ãƒƒãƒˆãŒ0ä»¶ã«ãªã£ãŸå ´åˆã®å‡¦ç†
        const remainingRows = document.querySelectorAll('tbody tr');
        if (remainingRows.length === 0) {
          const tbody = document.querySelector('tbody');
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-4">
                <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
              </td>
            </tr>
          `;
          console.log('âœ… ã€Œãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã®è¡¨ç¤ºã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
        setTimeout(() => {
          if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, 3000);
        
        console.log('ğŸ”„ ãƒã‚±ãƒƒãƒˆå‰Šé™¤å®Œäº†');
      })
      .catch(error => {
        console.error('âŒ Error deleting ticket:', error);
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
          <i class="fas fa-exclamation-triangle me-2"></i>
          ãƒã‚±ãƒƒãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.querySelector('.container').insertBefore(alertDiv, document.querySelector('h1'));
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’5ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
        setTimeout(() => {
          if (alertDiv && alertDiv.parentNode) {
            alertDiv.remove();
          }
        }, 5000);
      })
      .finally(() => {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        deleteBtn.disabled = false;
        deleteBtn.innerHTML = originalText;
        console.log('ğŸ”„ ãƒã‚±ãƒƒãƒˆå‰Šé™¤å‡¦ç†å®Œäº†');
      });
      
    } catch (error) {
      console.error('âŒ ãƒã‚±ãƒƒãƒˆå‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-danger alert-dismissible fade show';
      alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ãƒã‚±ãƒƒãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.querySelector('.container').insertBefore(alertDiv, document.querySelector('h1'));
      
      // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’5ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
      setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
      
      // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
      deleteBtn.disabled = false;
      deleteBtn.innerHTML = originalText;
    }
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  function cleanupModalBackground() {
    try {
      console.log('ğŸ”„ ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹');
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯è¦ç´ ã‚’å‰Šé™¤
      const modalBackdrops = document.querySelectorAll('.modal-backdrop');
      modalBackdrops.forEach(backdrop => {
        backdrop.remove();
        console.log('ğŸ—‘ï¸ ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯è¦ç´ ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      });
      
      // bodyã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
      
      console.log('âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
    } catch (error) {
      console.error('âŒ ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    }
  }
  
  console.log('ğŸ« ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
});
</script>
