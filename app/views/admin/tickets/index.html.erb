<div class="container my-4">
  <h1 class="mb-4">チケット一覧</h1>
  <%= search_form_for @q, url: admin_tickets_path, method: :get, html: { class: "row g-3 align-items-end mb-4" } do |f| %>
    <div class="col-md-4">
      <%= f.label :user_name_cont, "ユーザー名", class: "form-label" %>
      <%= f.text_field :user_name_cont, class: "form-control", placeholder: "例: 山田太郎" %>
    </div>

    <div class="col-md-3">
      <label for="q_remaining_status" class="form-label">ステータス</label>
      <%= select_tag "q[remaining_status]",
            options_for_select([
              ["すべて", ""],
              ["未使用あり", "unused"],
              ["すべて使用済み", "used"]
            ], params.dig(:q, :remaining_status)),
            class: "form-select" %>
    </div>

    <div class="col-md-auto d-flex align-items-end">
      <%= f.submit "検索", class: "btn btn-primary me-2" %>
      <%= link_to "リセット", admin_tickets_path, class: "btn btn-outline-secondary" %>
    </div>
  <% end %>
  <div class="mb-3">
    <%= link_to "CSVダウンロード", admin_tickets_path(format: :csv), class: "btn btn-sm btn-outline-success" %>
  </div>
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th><%= sort_link(@q, :id, "ID") %></th>
        <th><%= sort_link(@q, 'user.name', "ユーザー") %></th>
        <th><%= sort_link(@q, :title, "タイトル") %></th>
        <th><%= sort_link(@q, :remaining_count, "残回数") %></th>
        <th><%= sort_link(@q, :expiry_date, "期限") %></th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
      <% @tickets.each do |ticket| %>
        <tr>
          <td><%= ticket.id %></td>
          <td><%= ticket.user&.name.presence || ticket.user&.line_user_id %></td>
          <td><%= ticket.title %></td>
          <td>残り: <%= ticket.remaining_count %> 回</td>
          <td><%= ticket.expiry_date.strftime("%Y-%m-%d") %></td>
          <td>
            <button type="button" 
                    class="btn btn-sm btn-outline-danger delete-ticket-btn"
                    data-ticket-id="<%= ticket.id %>"
                    data-ticket-name="<%= ticket.title %>"
                    data-user-name="<%= ticket.user&.name.presence || ticket.user&.line_user_id %>">
              <i class="fas fa-trash"></i> 削除
            </button>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <div class="mt-3">
    <%= paginate @tickets %>
  </div>
</div>

<!-- チケット削除確認モーダル -->
<div class="modal fade" id="deleteTicketModal" tabindex="-1" aria-labelledby="deleteTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteTicketModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>チケット削除の確認
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>以下のチケットを削除しますか？</p>
        <div class="alert alert-warning">
          <strong>チケット名:</strong> <span id="deleteTicketName"></span><br>
          <strong>ユーザー:</strong> <span id="deleteTicketUser"></span><br>
          <strong>注意:</strong> この操作は取り消せません。
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteTicketBtn">
          <i class="fas fa-trash me-1"></i>削除を実行
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // チケット削除ボタンクリック時
  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('delete-ticket-btn') || e.target.closest('.delete-ticket-btn')) {
      const deleteBtn = e.target.classList.contains('delete-ticket-btn') ? e.target : e.target.closest('.delete-ticket-btn');
      const ticketId = deleteBtn.getAttribute('data-ticket-id');
      const ticketName = deleteBtn.getAttribute('data-ticket-name');
      const userName = deleteBtn.getAttribute('data-user-name');
      
      // モーダルにデータを設定
      document.getElementById('deleteTicketName').textContent = ticketName;
      document.getElementById('deleteTicketUser').textContent = userName;
      
      // モーダルを表示
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteTicketModal'));
      deleteModal.show();
      
      // 削除実行ボタンのイベントリスナー
      document.getElementById('confirmDeleteTicketBtn').onclick = function() {
        deleteTicket(ticketId, deleteBtn);
        deleteModal.hide();
      };
    }
  });
  
  // チケット削除実行
  function deleteTicket(ticketId, deleteBtn) {
    // 削除ボタンを無効化
    const originalText = deleteBtn.innerHTML;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 削除中...';
    
    // CSRF トークンを取得
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
    
    // チケット削除APIを呼び出し
    fetch(`/admin/tickets/${ticketId}`, {
      method: 'DELETE',
      headers: {
        'X-CSRF-Token': csrfToken
      }
    })
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      return response;
    })
    .then(() => {
      console.log('✅ Ticket deleted:', ticketId);
      
      // 成功メッセージを表示
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show';
      alertDiv.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        チケットを削除しました
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.querySelector('.container').insertBefore(alertDiv, document.querySelector('h1'));
      
      // チケット行を即座に削除
      const ticketRow = deleteBtn.closest('tr');
      ticketRow.remove();
      
      // チケットが0件になった場合の処理
      if (document.querySelectorAll('tbody tr').length === 0) {
        const tbody = document.querySelector('tbody');
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-4">
              <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
              <p class="text-muted">チケットがありません</p>
            </td>
          </tr>
        `;
      }
    })
    .catch(error => {
      console.error('❌ Error deleting ticket:', error);
      alert('チケット削除エラー: ' + error.message);
      
      // ボタンを元に戻す
      deleteBtn.disabled = false;
      deleteBtn.innerHTML = originalText;
    });
  }
});
</script>
