<div class="container my-4">
  <h1 class="mb-4">ãƒã‚±ãƒƒãƒˆä¸€è¦§</h1>
  <%= search_form_for @q, url: admin_tickets_path, method: :get, html: { class: "row g-3 align-items-end mb-4" } do |f| %>
    <div class="col-md-4">
      <%= f.label :user_name_cont, "ãƒ¦ãƒ¼ã‚¶ãƒ¼å", class: "form-label" %>
      <%= f.text_field :user_name_cont, class: "form-control", placeholder: "ä¾‹: å±±ç”°å¤ªéƒ" %>
    </div>

    <div class="col-md-3">
      <label for="q_remaining_status" class="form-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
      <%= select_tag "q[remaining_status]",
            options_for_select([
              ["ã™ã¹ã¦", ""],
              ["æœªä½¿ç”¨ã‚ã‚Š", "unused"],
              ["ã™ã¹ã¦ä½¿ç”¨æ¸ˆã¿", "used"]
            ], params.dig(:q, :remaining_status)),
            class: "form-select" %>
    </div>

    <div class="col-md-auto d-flex align-items-end">
      <%= f.submit "æ¤œç´¢", class: "btn btn-primary me-2" %>
      <%= link_to "ãƒªã‚»ãƒƒãƒˆ", admin_tickets_path, class: "btn btn-outline-secondary" %>
    </div>
  <% end %>
  <div class="mb-3">
    <%= link_to "CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", admin_tickets_path(format: :csv), class: "btn btn-sm btn-outline-success" %>
  </div>
  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        <th><%= sort_link(@q, :id, "ID") %></th>
        <th><%= sort_link(@q, 'user.name', "ãƒ¦ãƒ¼ã‚¶ãƒ¼") %></th>
        <th><%= sort_link(@q, :title, "ã‚¿ã‚¤ãƒˆãƒ«") %></th>
        <th><%= sort_link(@q, :remaining_count, "æ®‹å›æ•°") %></th>
        <th><%= sort_link(@q, :expiry_date, "æœŸé™") %></th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody>
      <% @tickets.each do |ticket| %>
        <tr>
          <td><%= ticket.id %></td>
          <td><%= ticket.user&.name.presence || ticket.user&.line_user_id %></td>
          <td><%= ticket.title.presence || ticket.ticket_template&.name || "ãƒã‚±ãƒƒãƒˆ#{ticket.id}" %></td>
          <td>æ®‹ã‚Š: <%= ticket.remaining_count %> å›</td>
          <td><%= ticket.expiry_date.strftime("%Y-%m-%d") %></td>
          <td>
            <button type="button" 
                    class="btn btn-sm btn-outline-danger delete-ticket-btn"
                    data-ticket-id="<%= ticket.id %>"
                    data-ticket-name="<%= ticket.title.presence || ticket.ticket_template&.name || "ãƒã‚±ãƒƒãƒˆ#{ticket.id}" %>"
                    data-user-name="<%= ticket.user&.name.presence || ticket.user&.line_user_id %>">
              <i class="fas fa-trash"></i> å‰Šé™¤
            </button>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <div class="mt-3">
    <%= paginate @tickets %>
  </div>
</div>

<!-- ãƒã‚±ãƒƒãƒˆå‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="deleteTicketModal" tabindex="-1" aria-labelledby="deleteTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteTicketModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>
          ãƒã‚±ãƒƒãƒˆå‰Šé™¤ã®ç¢ºèª
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body p-4">
        <div class="text-center">
          <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
          <p class="mb-3">ä»¥ä¸‹ã®ãƒã‚±ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
          <div class="alert alert-warning mb-3">
            <strong>ãƒã‚±ãƒƒãƒˆå:</strong> <span id="deleteTicketName"></span><br>
            <strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼:</strong> <span id="deleteTicketUser"></span><br>
            <strong>æ®‹ã‚Šå›æ•°:</strong> <span id="deleteTicketRemaining"></span> å›<br>
            <strong>æ³¨æ„:</strong> ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“
          </div>
          <p class="text-muted small mb-0">
            <i class="fas fa-info-circle me-1"></i>
            ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã™ã“ã¨ãŒã§ãã¾ã›ã‚“
          </p>
        </div>
      </div>
      <div class="modal-footer justify-content-center p-3">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="cleanupModalBackground()">
          <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button type="button" class="btn btn-danger" id="confirmDeleteTicketBtn">
          <i class="fas fa-trash me-1"></i>å‰Šé™¤ã™ã‚‹
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« -->
<style>
  /* å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
  #deleteTicketModal .modal-content {
    /* é«˜ã•åˆ¶é™ã‚’å®Œå…¨ã«å‰Šé™¤ */
    max-height: none;
    min-height: 400px;
    overflow: visible;
  }
  
  #deleteTicketModal .modal-body {
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶é™ã‚’å®Œå…¨ã«å‰Šé™¤ */
    overflow: visible;
    padding: 2rem;
    min-height: 200px;
  }
  
  #deleteTicketModal .modal-footer {
    border-top: 1px solid #dee2e6;
    padding: 1.5rem;
    background-color: #f8f9fa;
    margin-top: 0;
    min-height: 80px;
    /* ãƒ•ãƒƒã‚¿ãƒ¼ã®å¹…ã‚’ãƒœãƒ‡ã‚£ã¨åˆã‚ã›ã‚‹ */
    width: 100%;
    margin-left: 0;
    margin-right: 0;
  }
  
  #deleteTicketModal .alert {
    margin-bottom: 0;
    border: none;
    background-color: #fff3cd;
    color: #856404;
  }
  
  #deleteTicketModal .btn {
    padding: 0.5rem 1.5rem;
    font-weight: 500;
  }
  
  #deleteTicketModal .text-danger {
    color: #dc3545 !important;
  }
  
  #deleteTicketModal .text-muted {
    color: #6c757d !important;
  }
  
  /* ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã®æš—ã•ã‚’èª¿æ•´ */
  #deleteTicketModal.modal-backdrop {
    opacity: 0.1 !important;
  }
  
  /* ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‰ã˜ãŸå¾Œã®èƒŒæ™¯ã‚’æ˜ã‚‹ãã™ã‚‹ */
  body.modal-open {
    background-color: rgba(0, 0, 0, 0.02) !important;
  }
  
  /* ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã®é€æ˜åº¦ã‚’èª¿æ•´ */
  .modal-backdrop.show {
    opacity: 0.1 !important;
  }
</style>

<!-- ç‹¬ç«‹ã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<script type="text/javascript">
// ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸å°‚ç”¨ã®JavaScript
// é‡è¤‡å®Ÿè¡Œã‚’å®Œå…¨ã«é˜²ããŸã‚ã®å¼·åŠ›ãªãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ã®é‡è¤‡å®Ÿè¡Œãƒã‚§ãƒƒã‚¯ï¼ˆã‚ˆã‚Šå¼·åŠ›ãªæ–¹æ³•ï¼‰
if (typeof window.ticketListScriptLoaded === 'undefined') {
  window.ticketListScriptLoaded = true;
  
  // ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ™‚åˆ»ã‚’è¨˜éŒ²
  window.ticketListScriptTimestamp = Date.now();
  
  console.log('ğŸ« ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸ã‚¹ã‚¯ãƒªãƒ—ãƒˆåˆæœŸåŒ–é–‹å§‹', {
    timestamp: window.ticketListScriptTimestamp,
    url: window.location.href
  });
  
  // ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’å³åº§ã«å®Ÿè¡Œ
  (function() {
    'use strict';
    
    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§ã®å¤‰æ•°å®£è¨€
    let isProcessing = false;
    let isInitialized = false;
    let initializationAttempts = 0;
    const maxInitializationAttempts = 3;
    
    // åˆæœŸåŒ–å®Œäº†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
    function markAsInitialized() {
      isInitialized = true;
      window.ticketListInitializationComplete = true;
      console.log('âœ… ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†ãƒ•ãƒ©ã‚°ã‚’è¨­å®š');
    }
    
    // ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–
    function initializeTicketList() {
      try {
        if (isInitialized) {
          console.log('âš ï¸ æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã§ã™');
          return true;
        }
        
        console.log('ğŸ« ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹ï¼ˆè©¦è¡Œå›æ•°:', initializationAttempts + 1, 'ï¼‰');
        
        // ãƒšãƒ¼ã‚¸å…¨ä½“ã®HTMLç¢ºèª
        console.log('ğŸ” ãƒšãƒ¼ã‚¸å…¨ä½“ã®HTMLç¢ºèª:', document.body.innerHTML.length);
        
        // åˆæœŸåŒ–æ™‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ç¢ºèª
        const deleteTicketModal = document.querySelector('#deleteTicketModal');
        const deleteTicketName = document.querySelector('#deleteTicketName');
        const deleteTicketUser = document.querySelector('#deleteTicketUser');
        const deleteTicketRemaining = document.querySelector('#deleteTicketRemaining');
        const confirmDeleteTicketBtn = document.querySelector('#confirmDeleteTicketBtn');
        
        console.log('ğŸ” åˆæœŸåŒ–æ™‚ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ç¢ºèª:', {
          modal: !!deleteTicketModal,
          name: !!deleteTicketName,
          user: !!deleteTicketUser,
          remaining: !!deleteTicketRemaining,
          confirmBtn: !!confirmDeleteTicketBtn
        });
        
        // å¿…è¦ãªè¦ç´ ãŒã™ã¹ã¦å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (!deleteTicketModal || !deleteTicketName || !deleteTicketUser || !deleteTicketRemaining || !confirmDeleteTicketBtn) {
          console.error('âŒ å¿…è¦ãªãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚è©³ç´°èª¿æŸ»ã‚’å®Ÿè¡Œã—ã¾ã™...');
          
          // å‰Šé™¤é–¢é€£ã®IDã‚’æŒã¤è¦ç´ ã‚’æ¤œç´¢
          const deleteElements = document.querySelectorAll('[id*="delete"]');
          console.log('ğŸ” å‰Šé™¤é–¢é€£ã®IDã‚’æŒã¤è¦ç´ :', deleteElements);
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’æ¤œç´¢
          const modalElements = document.querySelectorAll('.modal');
          console.log('ğŸ” ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ :', modalElements);
          
          // å„ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è©³ç´°æƒ…å ±ã‚’å‡ºåŠ›
          modalElements.forEach((modal, index) => {
            console.log(`ğŸ” ãƒ¢ãƒ¼ãƒ€ãƒ«${index + 1}:`, {
              id: modal.id,
              visible: modal.style.display !== 'none',
              children: modal.children.length
            });
          });
          
          return false;
        }
        
        console.log('âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã®ç¢ºèªå®Œäº†');
        
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        const deleteButtons = document.querySelectorAll('.delete-ticket-btn');
        console.log(`ğŸ”˜ å‰Šé™¤ãƒœã‚¿ãƒ³${deleteButtons.length}å€‹ã‚’ç™ºè¦‹`);
        
        deleteButtons.forEach(button => {
          // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
          button.removeEventListener('click', handleTicketDelete);
          
          // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
          button.addEventListener('click', handleTicketDelete);
        });
        
        markAsInitialized();
        console.log('âœ… ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
        return true;
        
      } catch (error) {
        console.error('âŒ ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
        return false;
      }
    }
  
  // ãƒã‚±ãƒƒãƒˆå‰Šé™¤å‡¦ç†
  function handleTicketDelete(event) {
    try {
      const ticketId = event.target.getAttribute('data-ticket-id');
      const ticketName = event.target.getAttribute('data-ticket-name');
      const userName = event.target.getAttribute('data-user-name');
      
      console.log('ğŸ—‘ï¸ ãƒã‚±ãƒƒãƒˆå‰Šé™¤å‡¦ç†é–‹å§‹:', { ticketId, ticketName, userName });
      
      // å¿…è¦ãªå±æ€§ã®ç¢ºèª
      if (!ticketId || !ticketName) {
        console.error('âŒ å‰Šé™¤ãƒœã‚¿ãƒ³ã«å¿…è¦ãªå±æ€§ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“:', { ticketId, ticketName });
        return;
      }
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°ã‚’å‘¼ã³å‡ºã—
      showDeleteModal(ticketId, ticketName, userName);
      
    } catch (error) {
      console.error('âŒ ãƒã‚±ãƒƒãƒˆå‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      alert('å‰Šé™¤å‡¦ç†ã®æº–å‚™ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
  }
  
  // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
  function showDeleteModal(ticketId, ticketName, userName) {
    try {
      console.log('ğŸ­ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–‹å§‹:', { ticketId, ticketName, userName });
      
      // ã‚ˆã‚Šç¢ºå®Ÿãªè¦ç´ æ¤œç´¢
      const deleteTicketModal = document.querySelector('#deleteTicketModal');
      const deleteTicketName = document.querySelector('#deleteTicketName');
      const deleteTicketUser = document.querySelector('#deleteTicketUser');
      const deleteTicketRemaining = document.querySelector('#deleteTicketRemaining');
      
      // è¦ç´ ã®å­˜åœ¨ç¢ºèªã¨ãƒ‡ãƒãƒƒã‚°æƒ…å ±
      console.log('ğŸ” ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ æ¤œç´¢çµæœ:', {
        modal: !!deleteTicketModal,
        name: !!deleteTicketName,
        user: !!deleteTicketUser,
        remaining: !!deleteTicketRemaining
      });
      
      if (!deleteTicketModal) {
        console.error('âŒ ãƒ¢ãƒ¼ãƒ€ãƒ«æœ¬ä½“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.log('ğŸ” ãƒšãƒ¼ã‚¸å†…ã®ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ :', document.querySelectorAll('.modal'));
        return;
      }
      
      if (!deleteTicketName) {
        console.error('âŒ ãƒã‚±ãƒƒãƒˆåè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        console.log('ğŸ” ãƒšãƒ¼ã‚¸å†…ã®è¦ç´ :', document.querySelectorAll('[id*="delete"]'));
        return;
      }
      
      if (!deleteTicketUser) {
        console.error('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼åè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      if (!deleteTicketRemaining) {
        console.error('âŒ æ®‹ã‚Šå›æ•°è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ãƒã‚±ãƒƒãƒˆè¡Œã‹ã‚‰æ®‹ã‚Šå›æ•°ã‚’å–å¾—
      const ticketRow = document.querySelector(`tr:has(button[data-ticket-id="${ticketId}"])`);
      if (!ticketRow) {
        console.error('âŒ ãƒã‚±ãƒƒãƒˆè¡ŒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // æ®‹ã‚Šå›æ•°ã‚’å–å¾—ï¼ˆ4åˆ—ç›®ï¼‰
      const remainingCountCell = ticketRow.children[3]; // 0-indexedãªã®ã§4åˆ—ç›®ã¯3
      if (!remainingCountCell) {
        console.error('âŒ æ®‹ã‚Šå›æ•°ã‚»ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // æ®‹ã‚Šå›æ•°ã‚’æŠ½å‡ºï¼ˆä¾‹: "æ®‹ã‚Š: 3 å›" ã‹ã‚‰ "3" ã‚’å–å¾—ï¼‰
      const remainingCountMatch = remainingCountCell.textContent.match(/æ®‹ã‚Š:\s*(\d+)\s*å›/);
      if (!remainingCountMatch) {
        console.error('âŒ æ®‹ã‚Šå›æ•°ã®å½¢å¼ãŒæœŸå¾…ã¨ç•°ãªã‚Šã¾ã™:', remainingCountCell.textContent);
        return;
      }
      
      const remainingCount = remainingCountMatch[1];
      console.log('ğŸ“Š æ®‹ã‚Šå›æ•°:', remainingCount);
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
      deleteTicketName.textContent = ticketName || 'ä¸æ˜';
      deleteTicketUser.textContent = userName || 'ä¸æ˜';
      deleteTicketRemaining.textContent = remainingCount || 'ä¸æ˜';
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const deleteModal = new bootstrap.Modal(deleteTicketModal);
      deleteModal.show();
      
      // å‰Šé™¤å®Ÿè¡Œãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      const confirmBtn = document.querySelector('#confirmDeleteTicketBtn');
      if (confirmBtn) {
        confirmBtn.onclick = function() {
          deleteTicket(ticketId);
          deleteModal.hide();
          cleanupModalBackground();
        };
      }
      
      console.log('âœ… å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå®Œäº†');
      
    } catch (error) {
      console.error('âŒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      alert('ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
    }
  }
  
  // ãƒã‚±ãƒƒãƒˆå‰Šé™¤å®Ÿè¡Œ
  function deleteTicket(ticketId) {
    if (isProcessing) {
      console.log('âš ï¸ æ—¢ã«å‡¦ç†ä¸­ã®ãŸã‚ã€é‡è¤‡å®Ÿè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—');
      return;
    }
    
    isProcessing = true;
    
    try {
      console.log('ğŸ”„ ãƒã‚±ãƒƒãƒˆå‰Šé™¤APIå‘¼ã³å‡ºã—ä¸­...');
      
      // CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      
      if (!csrfToken) {
        throw new Error('CSRFãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
      
      // ãƒã‚±ãƒƒãƒˆå‰Šé™¤APIã‚’å‘¼ã³å‡ºã—
      fetch(`/admin/tickets/${ticketId}`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': csrfToken
        }
      })
      .then(response => {
        console.log('Response status:', response.status);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json().catch(() => ({ success: true }));
      })
      .then(data => {
        console.log('âœ… Ticket deleted:', data);
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        showAlert('success', 'ãƒã‚±ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        
        // ãƒã‚±ãƒƒãƒˆè¡Œã‚’å³åº§ã«å‰Šé™¤
        const ticketRow = document.querySelector(`tr:has(button[data-ticket-id="${ticketId}"])`);
        if (ticketRow) {
          ticketRow.remove();
          console.log('âœ… ãƒã‚±ãƒƒãƒˆè¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
        
        // ãƒã‚±ãƒƒãƒˆãŒ0ä»¶ã«ãªã£ãŸå ´åˆã®å‡¦ç†
        const remainingRows = document.querySelectorAll('tbody tr');
        if (remainingRows.length === 0) {
          const tbody = document.querySelector('tbody');
          tbody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-4">
                <i class="fas fa-ticket-alt fa-3x text-muted mb-3"></i>
                <p class="text-muted">ãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
              </td>
            </tr>
          `;
          console.log('âœ… ã€Œãƒã‚±ãƒƒãƒˆãŒã‚ã‚Šã¾ã›ã‚“ã€ã®è¡¨ç¤ºã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’3ç§’å¾Œã«è‡ªå‹•ã§æ¶ˆã™
        setTimeout(() => {
          const alertElement = document.querySelector('.alert-success');
          if (alertElement && alertElement.parentNode) {
            alertElement.remove();
          }
        }, 3000);
        
        console.log('ğŸ”„ ãƒã‚±ãƒƒãƒˆå‰Šé™¤å®Œäº†');
      })
      .catch(error => {
        console.error('âŒ Error deleting ticket:', error);
        showAlert('danger', `ãƒã‚±ãƒƒãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      })
      .finally(() => {
        isProcessing = false;
      });
      
    } catch (error) {
      console.error('âŒ ãƒã‚±ãƒƒãƒˆå‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      showAlert('danger', `å‰Šé™¤å‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`);
      isProcessing = false;
    }
  }
  
  // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºé–¢æ•°
  function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
      <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container');
    if (container) {
      container.insertBefore(alertDiv, container.firstChild);
      
      // ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è‡ªå‹•ã§æ¶ˆã™
      setTimeout(() => {
        if (alertDiv && alertDiv.parentNode) {
          alertDiv.remove();
        }
      }, 5000);
    }
  }
  
  // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  function cleanupModalBackground() {
    try {
      console.log('ğŸ”„ ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–‹å§‹');
      
      const modalBackdrops = document.querySelectorAll('.modal-backdrop');
      modalBackdrops.forEach(backdrop => backdrop.remove());
      
      document.body.classList.remove('modal-open');
      document.body.style.overflow = '';
      document.body.style.paddingRight = '';
      
      console.log('âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†');
    } catch (error) {
      console.error('âŒ ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
    }
  }
  
  // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
  function setupEventListeners() {
    // ãƒã‚±ãƒƒãƒˆå‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚
    document.addEventListener('click', function(e) {
      const deleteBtn = e.target.classList.contains('delete-ticket-btn') ? e.target : e.target.closest('.delete-ticket-btn');
      
      if (deleteBtn && !deleteBtn.disabled && !isProcessing) {
        e.preventDefault();
        e.stopPropagation();
        
        // å±æ€§ã®è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›
        console.log('ğŸ” å‰Šé™¤ãƒœã‚¿ãƒ³ã®è©³ç´°æƒ…å ±:', {
          element: deleteBtn,
          classList: Array.from(deleteBtn.classList),
          attributes: Array.from(deleteBtn.attributes).map(attr => ({ name: attr.name, value: attr.value })),
          dataset: deleteBtn.dataset,
          outerHTML: deleteBtn.outerHTML.substring(0, 200) + '...'
        });
        
        const ticketId = deleteBtn.getAttribute('data-ticket-id');
        const ticketName = deleteBtn.getAttribute('data-ticket-name');
        const userName = deleteBtn.getAttribute('data-user-name');
        
        console.log('ğŸ“‹ å–å¾—ã•ã‚ŒãŸå±æ€§å€¤:', {
          ticketId: ticketId,
          ticketName: ticketName,
          userName: userName,
          ticketIdType: typeof ticketId,
          ticketNameType: typeof ticketName,
          userNameType: typeof userName
        });
        
        if (ticketId && ticketName) {
          handleTicketDelete(e); // ã‚¤ãƒ™ãƒ³ãƒˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¸¡ã™
        } else {
          console.error('âŒ å‰Šé™¤ãƒœã‚¿ãƒ³ã«å¿…è¦ãªå±æ€§ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“:', {
            ticketId: !!ticketId,
            ticketName: !!ticketName,
            button: deleteBtn
          });
          
          // ç©ºæ–‡å­—åˆ—ã®å ´åˆã®è©³ç´°ãƒ­ã‚°
          if (ticketName === '') {
            console.error('âš ï¸ ticketNameãŒç©ºæ–‡å­—åˆ—ã§ã™ã€‚HTMLã®ç¢ºèªãŒå¿…è¦ã§ã™ã€‚');
            console.log('ğŸ” ãƒœã‚¿ãƒ³ã®å®Œå…¨ãªHTML:', deleteBtn.outerHTML);
            console.log('ğŸ” ãƒœã‚¿ãƒ³ã®å…¨å±æ€§:', Array.from(deleteBtn.attributes).map(attr => ({ name: attr.name, value: attr.value })));
          }
          
          alert('å‰Šé™¤ãƒœã‚¿ãƒ³ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚');
        }
      }
    });
  }
  
  // åˆæœŸåŒ–ã®å®Ÿè¡Œ
  function startInitialization() {
    // æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (isInitialized || window.ticketListInitializationComplete) {
      console.log('âš ï¸ æ—¢ã«åˆæœŸåŒ–æ¸ˆã¿ã§ã™');
      return;
    }
    
    // æœ€å¤§è©¦è¡Œå›æ•°ã‚’ãƒã‚§ãƒƒã‚¯
    if (initializationAttempts >= maxInitializationAttempts) {
      console.error('âŒ æœ€å¤§åˆæœŸåŒ–è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸã€‚åˆæœŸåŒ–ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚');
      return;
    }
    
    initializationAttempts++;
    
    if (initializeTicketList()) {
      setupEventListeners();
      console.log('âœ… ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
    } else {
      console.error('âŒ ãƒã‚±ãƒƒãƒˆä¸€è¦§ãƒšãƒ¼ã‚¸åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆè©¦è¡Œå›æ•°:', initializationAttempts, '/', maxInitializationAttempts, 'ï¼‰');
      
      // åˆæœŸåŒ–å¤±æ•—æ™‚ã®å†è©¦è¡Œ
      if (initializationAttempts < maxInitializationAttempts) {
        const delay = Math.min(300 * initializationAttempts, 1000); // æœ€å¤§1ç§’ã¾ã§
        console.log(`ğŸ”„ ${delay}ms å¾Œã«å†è©¦è¡Œã—ã¾ã™...`);
        setTimeout(startInitialization, delay);
      } else {
        console.error('âŒ æœ€å¤§è©¦è¡Œå›æ•°ã«é”ã—ã¾ã—ãŸã€‚åˆæœŸåŒ–ã‚’ä¸­æ­¢ã—ã¾ã™ã€‚');
        // ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã‚’è¨˜éŒ²
        window.ticketListInitializationFailed = true;
      }
    }
  }
  
  // åˆæœŸåŒ–ã®é–‹å§‹ï¼ˆå˜ä¸€ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œï¼‰
  function beginInitialization() {
    // æ—¢ã«åˆæœŸåŒ–ãŒé–‹å§‹ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (window.ticketListInitializationStarted) {
      console.log('âš ï¸ åˆæœŸåŒ–ã¯æ—¢ã«é–‹å§‹ã•ã‚Œã¦ã„ã¾ã™');
      return;
    }
    
    window.ticketListInitializationStarted = true;
    console.log('ğŸš€ åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ã‚’é–‹å§‹ã—ã¾ã™');
    
    // DOMã®æº–å‚™çŠ¶æ…‹ã«å¿œã˜ã¦åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ« DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ');
        setTimeout(startInitialization, 100);
      });
    } else {
      console.log('ğŸ« readyState æ—¢ã«å®Œäº† - å³åº§ã«åˆæœŸåŒ–');
      startInitialization();
    }
  }
  
  // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—åˆæœŸåŒ–ï¼ˆ1å›ã®ã¿ï¼‰
  window.addEventListener('load', function() {
    console.log('ğŸ« load ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿ');
    if (!isInitialized && !window.ticketListInitializationComplete) {
      console.log('ğŸ”„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¾ã™');
      setTimeout(startInitialization, 200);
    }
  });
  
  // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
  window.cleanupModalBackground = cleanupModalBackground;
  
})();
</script>

