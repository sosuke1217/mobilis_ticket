<% content_for :head do %>
  <meta name="turbo-visit-control" content="disable">
<% end %>

<div class="container-lg my-5">
  <h1 class="mb-4">
    <%= @user.name || @user.line_user_id %> さんの詳細
  </h1>

  <p>
    <strong>LINE連携状況:</strong>
    <% if @user.line_user_id.present? %>
      <span class="badge bg-success"><i class="fas fa-link me-1"></i>連携済み</span>
    <% else %>
      <span class="badge bg-danger"><i class="fas fa-unlink me-1"></i>未連携</span>
    <% end %>
  </p>

  <!-- 🧑‍💼 顧客情報セクション -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-secondary text-white fw-bold d-flex justify-content-between align-items-center">
      顧客情報
      <%= link_to "編集", edit_admin_user_path(@user), class: "btn btn-sm btn-light" %>
    </div>
    <div class="card-body p-0">
      <table class="table table-bordered table-striped mb-0">
        <tbody>
          <tr>
            <th class="w-25 bg-light">会員番号</th>
            <td><%= @user.id %></td>
          </tr>
          <tr>
            <th class="bg-light">氏名</th>
            <td><%= @user.name.presence || content_tag(:span, "未登録", class: "text-muted") %></td>
          </tr>
          <tr>
            <th class="bg-light">生年月日</th>
            <td><%= @user.birth_date.present? ? l(@user.birth_date) : content_tag(:span, "未登録", class: "text-muted") %></td>
          </tr>
          <tr>
            <th class="bg-light">郵便番号</th>
            <td><%= @user.postal_code.presence || content_tag(:span, "未登録", class: "text-muted") %></td>
          </tr>
          <tr>
            <th class="bg-light">住所</th>
            <td><%= @user.address.presence || content_tag(:span, "未登録", class: "text-muted") %></td>
          </tr>
          <tr>
            <th class="bg-light">電話番号</th>
            <td><%= @user.phone_number.presence || content_tag(:span, "未登録", class: "text-muted") %></td>
          </tr>
          <tr>
            <th class="bg-light">メールアドレス</th>
            <td><%= @user.email.presence || content_tag(:span, "未登録", class: "text-muted") %></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-warning text-dark fw-bold">管理者メモ</div>
    <div class="card-body">
      <% if @user.admin_memo.present? %>
        <pre class="mb-0"><%= @user.admin_memo %></pre>
      <% else %>
        <p class="text-muted mb-0">メモは登録されていません。</p>
      <% end %>
    </div>
  </div>

  <!-- 📊 利用状況サマリー -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white fw-bold">
      利用状況サマリー
    </div>
    <div class="card-body">
      <ul class="list-group list-group-flush">
        <li class="list-group-item">累計使用回数：<strong><%= @total_usages %></strong></li>
        <li class="list-group-item">最終使用日：
          <strong>
            <%= @last_used_at.present? ? @last_used_at.strftime('%Y-%m-%d') : "未使用" %>
          </strong>
        </li>
        <li class="list-group-item">アクティブチケット数：<strong><%= @active_tickets.count %></strong></li>
        <li class="list-group-item">
          アクティブチケット種類：
          <% if @active_ticket_types.present? %>
            <ul class="mb-0 ps-3">
              <% @active_ticket_types.each do |title, count| %>
                <li><%= title %>（<%= count %> 枚）</li>
              <% end %>
            </ul>
          <% else %>
            <span class="text-muted">なし</span>
          <% end %>
        </li>
      </ul>
    </div>
  </div>

  <!-- 🔧 チケット発行 -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-dark text-white fw-bold">
      チケットをテンプレートから発行
    </div>
    <div class="card-body">
      <form action="<%= admin_user_create_ticket_from_template_path(@user) %>" method="get">
        
        <div class="mb-3">
          <label for="template_id" class="form-label">テンプレート選択</label>
          <select name="template_id" id="template_id" class="form-select" required>
            <option value="">テンプレートを選んでください</option>
            <% @ticket_templates.each do |template| %>
              <option value="<%= template.id %>"><%= template.name %> (<%= template.total_count %>回券 / ¥<%= template.price %>)</option>
            <% end %>
          </select>
        </div>
        
        <button type="submit" class="btn btn-primary">
          発行する
        </button>
      </form>
    </div>
  </div>

  <!-- 🎫 所持チケット一覧 -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-success text-white fw-bold">
      所持チケット一覧
    </div>
    <div class="card-body p-0" id="active_ticket_section">
      <% if @active_tickets.any? %>
        <!-- チケットがある場合のテーブル -->
        <div class="table-responsive">
          <table class="table table-hover table-striped align-middle mb-0">
            <thead class="table-light text-center">
              <tr>
                <th>タイトル</th>
                <th>残回数</th>
                <th>購入日</th>
                <th>有効期限</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="active_ticket_table_body">
              <% @active_tickets.each do |ticket| %>
                <tr id="ticket_<%= ticket.id %>">
                  <td><%= ticket.title %></td>
                  <td><%= ticket.remaining_count %> / <%= ticket.total_count %></td>
                  <td><%= ticket.purchase_date.strftime("%Y-%m-%d") %></td>
                  <td>
                    <% if ticket.expiry_date < Time.zone.today %>
                      <span class="badge bg-danger me-1">
                        <i class="fas fa-exclamation-circle me-1"></i>期限切れ
                      </span>
                      <span class="text-muted"><%= ticket.expiry_date.strftime("%Y-%m-%d") %></span>
                    <% elsif ticket.expiry_date < 1.month.from_now %>
                      <span class="badge bg-warning text-dark me-1">
                        <i class="fas fa-hourglass-half me-1"></i>期限間近
                      </span>
                      <%= ticket.expiry_date.strftime("%Y-%m-%d") %>
                    <% else %>
                      <%= ticket.expiry_date.strftime("%Y-%m-%d") %>
                    <% end %>
                  </td>
                  <td>
                      <div class="btn-group btn-group-sm" role="group">
                      <%= button_to "使う", use_admin_ticket_path(ticket),
                      method: :post,
                      remote: true,
                      form: { data: { turbo_stream: true } },
                      class: "btn btn-success use-ticket-btn",
                      data: { confirm_remote: "このチケットを1回分使用しますか？" } %>

                      <%= button_to "削除", admin_ticket_path(ticket),
                          method: :delete,
                          data: { confirm: "このチケットを削除しますか？" },
                          class: "btn btn-outline-danger" %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <!-- チケットがない場合の表示 -->
        <div class="p-3" id="no_tickets_message">
          <p class="text-muted">使用可能なチケットはありません。</p>
        </div>
        <!-- 隠しテーブル構造（Turbo Stream用） -->
        <div class="table-responsive" style="display: none;" id="hidden_ticket_table">
          <table class="table table-hover table-striped align-middle mb-0">
            <thead class="table-light text-center">
              <tr>
                <th>タイトル</th>
                <th>残回数</th>
                <th>購入日</th>
                <th>有効期限</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="active_ticket_table_body">
              <!-- チケット行がここに追加される -->
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </div>
  
  <!-- 🕒 最近の使用履歴 -->
  <div class="card mb-5 shadow-sm">
    <div class="card-header bg-primary text-white fw-bold">
      最近のチケット使用履歴（最新10件）
    </div>
    <div class="card-body p-0">
      <% if @recent_ticket_usages.any? %>
        <table class="table table-striped table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>チケット名</th>
              <th>使用日時</th>
              <th>残回数</th>
              <th>メモ</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <% @recent_ticket_usages.each do |usage| %>
              <tr>
                <td><%= usage.ticket.title %></td>
                <td><%= usage.used_at.strftime('%Y-%m-%d %H:%M') %></td>
                <td><%= usage.ticket.remaining_count %> 回</td>
                <td><%= usage.note.present? ? truncate(usage.note, length: 30) : "—" %></td>
                <td>
                  <%= link_to "詳細・編集", edit_admin_ticket_usage_path(usage), class: "btn btn-sm btn-outline-primary" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <div class="p-3">
          <p class="text-muted">まだ使用履歴がありません。</p>
        </div>
      <% end %>
      <p class="mt-3 px-3">
        <%= link_to "全ての使用履歴を見る", admin_user_ticket_usages_path(@user), class: "btn btn-outline-secondary btn-sm" %>
      </p>
    </div>
  </div>
  <!-- 🗂 使用済みチケット一覧 -->
  <div class="card shadow-sm">
    <div class="card-header bg-secondary text-white fw-bold">
      使用済みチケット
    </div>
    <div class="card-body p-0">
      <% if @used_up_tickets.any? %>
        <table class="table table-hover table-striped align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>タイトル</th>
              <th>残回数</th>
              <th>購入日</th>
              <th>有効期限</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="used_ticket_table_body">
            <% @used_up_tickets.each do |ticket| %>
              <tr>
                <td><%= ticket.title %></td>
                <td>0 / <%= ticket.total_count %></td>
                <td><%= ticket.purchase_date.strftime("%Y-%m-%d") %></td>
                <td><%= ticket.expiry_date.strftime("%Y-%m-%d") %></td>
                <td>
                  <%= button_to "削除", admin_ticket_path(ticket),
                      method: :delete,
                      data: { confirm: "このチケットを削除しますか？" },
                      class: "btn btn-sm btn-outline-danger" %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <div class="p-3">
          <p class="text-muted">使用済みチケットはまだありません。</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- ページの最下部に追加 -->
<script>
console.log('🔧 Simple JavaScript test loaded');
alert('JavaScript is working!');

document.addEventListener('DOMContentLoaded', function() {
  console.log('🔧 DOM loaded');
  
  // チケット発行フォームを見つける
  const form = document.querySelector('form[action*="create_from_template"]');
  if (form) {
    console.log('🔧 Form found:', form);
    alert('Form found! ID: ' + form.id);
  } else {
    console.log('🔧 Form NOT found');
    alert('Form NOT found');
  }
});
</script>