<% content_for :title, "ã‚·ãƒ•ãƒˆè¨­å®š - Mobilis" %>

<div class="container-lg my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">ğŸ“… ã‚·ãƒ•ãƒˆè¨­å®š</h1>
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><%= link_to "ç®¡ç†ç”»é¢", admin_root_path %></li>
        <li class="breadcrumb-item active">ã‚·ãƒ•ãƒˆè¨­å®š</li>
      </ol>
    </nav>
  </div>

  <!-- æ–°è¦ã‚·ãƒ•ãƒˆä½œæˆãƒ•ã‚©ãƒ¼ãƒ  -->
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0">â• æ–°è¦ã‚·ãƒ•ãƒˆä½œæˆ</h5>
    </div>
    <div class="card-body">
      <%= form_with model: @shift, url: admin_shifts_path, local: true, class: "needs-validation", novalidate: true, id: "shiftForm" do |f| %>
        <div class="row">
          <div class="col-md-4">
            <div class="mb-3">
              <label for="shift_date" class="form-label">ğŸ“… æ—¥ä»˜</label>
              <%= f.date_field :date, class: "form-control", required: true %>
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label for="shift_start_time" class="form-label">ğŸŒ… é–‹å§‹æ™‚é–“</label>
              <%= f.time_field :start_time, class: "form-control", required: true %>
            </div>
          </div>
          <div class="col-md-4">
            <div class="mb-3">
              <label for="shift_end_time" class="form-label">ğŸŒ† çµ‚äº†æ™‚é–“</label>
              <%= f.time_field :end_time, class: "form-control", required: true %>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label for="shift_notes" class="form-label">ğŸ“ ãƒ¡ãƒ¢</label>
          <%= f.text_area :notes, class: "form-control", rows: 3, placeholder: "ã‚·ãƒ•ãƒˆã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" %>
        </div>
        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-1"></i>ã‚·ãƒ•ãƒˆã‚’ä½œæˆ
          </button>
          <button type="button" class="btn btn-outline-secondary" onclick="clearShiftForm()">
            <i class="fas fa-eraser me-1"></i>ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
          </button>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ã‚·ãƒ•ãƒˆä¸€è¦§ -->
  <div class="card shadow-sm">
    <div class="card-header bg-info text-white">
      <h5 class="mb-0">ğŸ“‹ ã‚·ãƒ•ãƒˆä¸€è¦§</h5>
    </div>
    <div class="card-body">
      <% if @shifts.any? %>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead class="table-light">
              <tr>
                <th>ğŸ“… æ—¥ä»˜</th>
                <th>â° æ™‚é–“</th>
                <th>ğŸ“ ãƒ¡ãƒ¢</th>
                <th>ğŸ”„ æ“ä½œ</th>
              </tr>
            </thead>
            <tbody>
              <% @shifts.each do |shift| %>
                <tr data-shift-id="<%= shift.id %>">
                  <td>
                    <strong><%= shift.date.strftime("%m/%d") %></strong>
                    <small class="text-muted d-block"><%= shift.date.strftime("%Yå¹´%mæœˆ%dæ—¥") %></small>
                  </td>
                  <td>
                    <span class="badge bg-primary">
                      <%= shift.start_time.strftime("%H:%M") %> - <%= shift.end_time.strftime("%H:%M") %>
                    </span>
                    <small class="text-muted d-block">
                      <%= ((shift.end_time - shift.start_time) / 3600).round(1) %>æ™‚é–“
                    </small>
                  </td>
                  <td>
                    <% if shift.notes.present? %>
                      <span class="text-truncate d-inline-block" style="max-width: 200px;" title="<%= shift.notes %>">
                        <%= shift.notes %>
                      </span>
                    <% else %>
                      <span class="text-muted">-</span>
                    <% end %>
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary" onclick="editShift(<%= shift.id %>)">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button type="button" class="btn btn-outline-danger" onclick="deleteShift(<%= shift.id %>)">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="text-center py-4">
          <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
          <h5 class="text-muted">ã‚·ãƒ•ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</h5>
          <p class="text-muted">ä¸Šè¨˜ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚·ãƒ•ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="editShiftModal" tabindex="-1" aria-labelledby="editShiftModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editShiftModalLabel">âœï¸ ã‚·ãƒ•ãƒˆç·¨é›†</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editShiftForm">
          <input type="hidden" id="edit_shift_id">
          <div class="mb-3">
            <label for="edit_shift_date" class="form-label">ğŸ“… æ—¥ä»˜</label>
            <input type="date" id="edit_shift_date" class="form-control" required>
          </div>
          <div class="row">
            <div class="col-6">
              <div class="mb-3">
                <label for="edit_shift_start_time" class="form-label">ğŸŒ… é–‹å§‹æ™‚é–“</label>
                <input type="time" id="edit_shift_start_time" class="form-control" required>
              </div>
            </div>
            <div class="col-6">
              <div class="mb-3">
                <label for="edit_shift_end_time" class="form-label">ğŸŒ† çµ‚äº†æ™‚é–“</label>
                <input type="time" id="edit_shift_end_time" class="form-control" required>
              </div>
            </div>
          </div>
          <div class="mb-3">
            <label for="edit_shift_notes" class="form-label">ğŸ“ ãƒ¡ãƒ¢</label>
            <textarea id="edit_shift_notes" class="form-control" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="button" class="btn btn-primary" onclick="updateShift()">æ›´æ–°</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ãƒ•ã‚©ãƒ¼ãƒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
  const forms = document.querySelectorAll('.needs-validation');
  Array.from(forms).forEach(form => {
    form.addEventListener('submit', event => {
      if (!form.checkValidity()) {
        event.preventDefault();
        event.stopPropagation();
      }
      form.classList.add('was-validated');
    }, false);
  });

  // ã‚·ãƒ•ãƒˆä½œæˆãƒ•ã‚©ãƒ¼ãƒ ã®JavaScriptå‡¦ç†
  const shiftForm = document.getElementById('shiftForm');
  if (shiftForm) {
    shiftForm.addEventListener('submit', function(event) {
      event.preventDefault();
      
      const formData = new FormData(shiftForm);
      const shiftData = {
        shift: {
          date: formData.get('shift[date]'),
          shift_type: formData.get('shift[shift_type]') || 'regular',
          start_time: formData.get('shift[start_time]'),
          end_time: formData.get('shift[end_time]'),
          notes: formData.get('shift[notes]')
        }
      };

      fetch('/admin/shifts', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
        },
        body: JSON.stringify(shiftData)
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showNotification('ã‚·ãƒ•ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ', 'success');
          shiftForm.reset();
          location.reload();
        } else {
          showNotification('ã‚·ãƒ•ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.errors ? data.errors.join(', ') : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
        }
      })
      .catch(error => {
        console.error('âŒ ã‚·ãƒ•ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        console.error('âŒ Error details:', error.message);
        showNotification('ã‚·ãƒ•ãƒˆã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      });
    });
  }
});

// ã‚·ãƒ•ãƒˆç·¨é›†
function editShift(shiftId) {
  console.log(`âœï¸ ã‚·ãƒ•ãƒˆç·¨é›†: ${shiftId}`);
  
  // ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
  fetch(`/admin/shifts/${shiftId}.json`)
    .then(response => {
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      document.getElementById('edit_shift_id').value = data.id;
      document.getElementById('edit_shift_date').value = data.date;
      document.getElementById('edit_shift_start_time').value = data.start_time;
      document.getElementById('edit_shift_end_time').value = data.end_time;
      document.getElementById('edit_shift_notes').value = data.notes || '';
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const modal = new bootstrap.Modal(document.getElementById('editShiftModal'));
      modal.show();
    })
    .catch(error => {
      console.error('âŒ ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', error);
      console.error('âŒ Error details:', error.message);
      showNotification('ã‚·ãƒ•ãƒˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
    });
}

// ã‚·ãƒ•ãƒˆæ›´æ–°
function updateShift() {
  const shiftId = document.getElementById('edit_shift_id').value;
  const formData = {
    shift: {
      date: document.getElementById('edit_shift_date').value,
      start_time: document.getElementById('edit_shift_start_time').value,
      end_time: document.getElementById('edit_shift_end_time').value,
      notes: document.getElementById('edit_shift_notes').value
    }
  };
  
  fetch(`/admin/shifts/${shiftId}`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    },
    body: JSON.stringify(formData)
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      showNotification('ã‚·ãƒ•ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success');
      location.reload();
    } else {
      showNotification('ã‚·ãƒ•ãƒˆã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.errors ? data.errors.join(', ') : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
    }
  })
  .catch(error => {
    console.error('âŒ ã‚·ãƒ•ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
    console.error('âŒ Error details:', error.message);
    showNotification('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
  });
}

// ã‚·ãƒ•ãƒˆå‰Šé™¤
function deleteShift(shiftId) {
  if (!confirm('ã“ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
    return;
  }
  
  console.log(`ğŸ—‘ï¸ ã‚·ãƒ•ãƒˆå‰Šé™¤: ${shiftId}`);
  
  fetch(`/admin/shifts/${shiftId}`, {
    method: 'DELETE',
    headers: {
      'Accept': 'application/json',
      'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    if (data.success) {
      showNotification('ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
      location.reload();
    } else {
      showNotification('ã‚·ãƒ•ãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.errors ? data.errors.join(', ') : 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'), 'error');
    }
  })
  .catch(error => {
    console.error('âŒ ã‚·ãƒ•ãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
    console.error('âŒ Error details:', error.message);
    showNotification('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'error');
  });
}

// ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
function clearShiftForm() {
  document.getElementById('shiftForm').reset();
  console.log('ğŸ§¹ ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
}

// é€šçŸ¥è¡¨ç¤º
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
  notification.style.cssText = `
    top: 20px;
    right: 20px;
    z-index: 1050;
    min-width: 300px;
    animation: slideIn 0.3s ease-out;
  `;
  notification.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}
</script>

<style>
.table th {
  border-top: none;
  font-weight: 600;
}

.btn-group-sm .btn {
  padding: 0.25rem 0.5rem;
  font-size: 0.875rem;
}

.badge {
  font-size: 0.875rem;
}

.text-truncate {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}
</style> 