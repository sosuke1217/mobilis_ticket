<div class="container my-4">
  <h1 class="mb-4">‰ΩøÁî®Â±•Ê≠¥‰∏ÄË¶ß</h1>

  <!-- üîç Ê§úÁ¥¢„Éï„Ç©„Éº„É† -->
  <%= search_form_for @q, url: admin_ticket_usages_path, method: :get, html: { class: "row g-3 align-items-end mb-4" } do |f| %>
    <div class="col-md-4">
      <%= f.label :user_name_cont, "„É¶„Éº„Ç∂„ÉºÂêç", class: "form-label" %>
      <%= f.text_field :user_name_cont, class: "form-control", placeholder: "‰æã: Â±±Áî∞Â§™ÈÉé" %>
    </div>
    <div class="col-md-4">
      <%= f.label :ticket_ticket_template_name_cont, "„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç", class: "form-label" %>
      <%= f.text_field :ticket_ticket_template_name_cont, class: "form-control", placeholder: "‰æã: Êúà4ÂõûÂà∏" %>
    </div>
    <div class="col-md-3">
      <%= label_tag :year_month, "Êúà„ÅßÁµû„ÇäËæº„Åø", class: "form-label" %>
      <%= select_tag :year_month,
            options_for_select(month_options, params[:year_month]),
            include_blank: "ÂÖ®„Å¶", class: "form-select" %>
    </div>
    <div class="col-md-auto">
      <%= f.submit "Ê§úÁ¥¢", class: "btn btn-primary" %>
      <%= link_to "„É™„Çª„ÉÉ„Éà", admin_ticket_usages_path, class: "btn btn-outline-secondary ms-2" %>
    </div>
  <% end %>

 <div class="mb-3">
  <%= link_to "CSV„Åß„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
      admin_ticket_usages_path(format: :csv, q: params[:q]&.to_unsafe_h, year_month: params[:year_month]),
      class: "btn btn-sm btn-outline-success" %>
  </div>

  <!-- üìã ‰ΩøÁî®Â±•Ê≠¥„ÉÜ„Éº„Éñ„É´ -->
  <% if @ticket_usages.any? %>
    <table class="table table-bordered table-hover">
      <thead class="table-dark">
        <tr>
          <th><%= sort_link(@q, :used_at, "Êó•ÊôÇ") %></th>
          <th><%= sort_link(@q, 'user.name', "„É¶„Éº„Ç∂„Éº") %></th>
          <th><%= sort_link(@q, 'ticket.ticket_template.name', "„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç") %></th>
          <th><%= sort_link(@q, 'ticket.title', "„ÉÅ„Ç±„ÉÉ„ÉàÂêç") %></th>
          <th>Ê∂àÂåñÈáëÈ°ç</th>
        </tr>
      </thead>
      <tbody>
        <% @ticket_usages.each do |usage| %>
          <tr>
            <td><%= l(usage.used_at, format: :short) %></td>
            <td>
              <%= link_to(usage.user&.name.presence || usage.user&.line_user_id || "‰∏çÊòé", admin_user_path(usage.user), class: "text-decoration-none") if usage.user.present? %>
            </td>
            <td><%= usage.ticket&.ticket_template&.name || "‰∏çÊòé" %></td>
            <td><%= usage.ticket&.title || "‰∏çÊòé" %></td>
            <td>
              <% price = usage.ticket&.unit_price %>
              <%= price ? number_to_currency(price, unit: "¬•", precision: 0) : "‰∏çÊòé" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-muted">‰ΩøÁî®Â±•Ê≠¥„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ</p>
  <% end %>
  <div class="mt-3">
    <%= paginate @ticket_usages %>
  </div>
</div>
